!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three")):"function"==typeof define&&define.amd?define(["three"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).KanKan=t(e.THREE)}(this,(function(e){"use strict";function t(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var o=t(e);function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function u(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(t&&("object"===m(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}function w(e){return(w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function k(e,t,n,o,i,r,a){try{var s=e[r](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(o,i)}function S(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var r=e.apply(t,n);function a(e){k(r,o,i,a,s,"next",e)}function s(e){k(r,o,i,a,s,"throw",e)}a(void 0)}))}}var C=function(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e){var t=function(e){var t,n=Object.prototype,o=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},r=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function c(e,t,n,o){var i=t&&t.prototype instanceof v?t:v,r=Object.create(i.prototype),a=new I(o||[]);return r._invoke=function(e,t,n){var o=h;return function(i,r){if(o===p)throw new Error("Generator is already running");if(o===f){if("throw"===i)throw r;return C()}for(n.method=i,n.arg=r;;){var a=n.delegate;if(a){var s=k(a,n);if(s){if(s===m)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var l=u(e,t,n);if("normal"===l.type){if(o=n.done?f:d,l.arg===m)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=f,n.method="throw",n.arg=l.arg)}}}(e,n,a),r}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var h="suspendedStart",d="suspendedYield",p="executing",f="completed",m={};function v(){}function g(){}function y(){}var w={};l(w,r,(function(){return this}));var b=Object.getPrototypeOf,E=b&&b(b(S([])));E&&E!==n&&o.call(E,r)&&(w=E);var x=y.prototype=v.prototype=Object.create(w);function T(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function P(e,t){function n(i,r,a,s){var l=u(e[i],e,r);if("throw"!==l.type){var c=l.arg,h=c.value;return h&&"object"==typeof h&&o.call(h,"__await")?t.resolve(h.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(h).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var i;this._invoke=function(e,o){function r(){return new t((function(t,i){n(e,o,t,i)}))}return i=i?i.then(r,r):r()}}function k(e,n){var o=e.iterator[n.method];if(o===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,k(e,n),"throw"===n.method))return m;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var i=u(o,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,m;var r=i.arg;return r?r.done?(n[e.resultName]=r.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):r:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function M(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(M,this),this.reset(!0)}function S(e){if(e){var n=e[r];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function n(){for(;++i<e.length;)if(o.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return a.next=a}}return{next:C}}function C(){return{value:t,done:!0}}return g.prototype=y,l(x,"constructor",y),l(y,"constructor",g),g.displayName=l(y,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,l(e,s,"GeneratorFunction")),e.prototype=Object.create(x),e},e.awrap=function(e){return{__await:e}},T(P.prototype),l(P.prototype,a,(function(){return this})),e.AsyncIterator=P,e.async=function(t,n,o,i,r){void 0===r&&(r=Promise);var a=new P(c(t,n,o,i),r);return e.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},T(x),l(x,s,"Generator"),l(x,r,(function(){return this})),l(x,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var o=t.pop();if(o in e)return n.value=o,n.done=!1,n}return n.done=!0,n}},e.values=S,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(o,i){return s.type="throw",s.arg=e,n.next=o,i&&(n.method="next",n.arg=t),!!i}for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var l=o.call(a,"catchLoc"),c=o.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&o.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var r=i;break}}r&&("break"===e||"continue"===e)&&r.tryLoc<=t&&t<=r.finallyLoc&&(r=null);var a=r?r.completion:{};return a.type=e,a.arg=t,r?(this.method="next",this.next=r.finallyLoc,m):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var i=o.arg;R(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,o){return this.delegate={iterator:S(e),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=t),m}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}}));function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function L(e){return function(e){if(Array.isArray(e))return D(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?D(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function z(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function V(e,t,n){return(V=z()?Reflect.construct:function(e,t,n){var o=[null];o.push.apply(o,t);var i=new(Function.bind.apply(e,o));return n&&p(i,n.prototype),i}).apply(null,arguments)}var H=[],j=[];function U(e,t){if(e&&"undefined"!=typeof document){var n,o=!0===t.prepend?"prepend":"append",i=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(i){var a=H.indexOf(r);-1===a&&(a=H.push(r)-1,j[a]={}),n=j[a]&&j[a][o]?j[a][o]:j[a][o]=s()}else n=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),i=0;i<n.length;i++)e.setAttribute(n[i],t.attributes[n[i]]);var a="prepend"===o?"afterbegin":"beforeend";return r.insertAdjacentElement(a,e),e}}U(":root {\r\n    --main-color: #00c8af;\r\n    --font-color: #999;\r\n}\r\n\r\n[x-cloak] {\r\n    display: none !important;\r\n}\r\n\r\n*,\r\n::before,\r\n::after {\r\n    -webkit-appearance: none;\r\n    -moz-appearance: none;\r\n    appearance: none;\r\n    -webkit-tap-highlight-color: rgba(255, 255, 255, 0);\r\n    text-rendering: optimizeLegibility !important;\r\n    -webkit-font-smoothing: antialiased !important;\r\n}\r\n\r\n.kankan-app {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    overflow: hidden;\r\n    background-color: #292929;\r\n}\r\n\r\n.kankan-app .player {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    z-index: 1;\r\n    overflow: hidden;\r\n}\r\n\r\n.kankan-app .player[name='copy'] {\r\n    display: none;\r\n}\r\n\r\n.kankan-app .player-mark {\r\n    display: none;\r\n    cursor: grab;\r\n    position: absolute;\r\n    left: calc(50% - 56px);\r\n    top: calc(50% - 56px);\r\n    z-index: 999;\r\n    width: 102px;\r\n    height: 102px;\r\n}\r\n\r\n.kankan-app__split .player {\r\n    cursor: crosshair;\r\n}\r\n\r\n.kankan-app__split .player[name='main'] {\r\n    width: calc(50% - 1px);\r\n}\r\n\r\n.kankan-app__split .player[name='copy'] {\r\n    width: calc(50% - 1px);\r\n    display: block;\r\n    left: auto;\r\n    right: 0;\r\n}\r\n\r\n.kankan-app__split .player-mark {\r\n    display: block;\r\n}\r\n\r\n.kankan-app__split [xui_tags] div {\r\n    display: none !important;\r\n}\r\n\r\n.kankan-app__slide-right {\r\n    will-change: transform;\r\n    transition: all 0.2s ease-in-out;\r\n}\r\n\r\n.kankan-app__slide-right-enter {\r\n    opacity: 1;\r\n    transform: translate3d(0, 0, 0);\r\n}\r\n\r\n.kankan-app__slide-right-leave {\r\n    opacity: 0;\r\n    transform: translate3d(100%, 0, 0);\r\n}\r\n\r\n/* plugins */\r\n.kankan-plugins input {\r\n    padding: 0 5px;\r\n    width: 100%;\r\n    height: 34px;\r\n    background: rgba(255, 255, 255, 0.1);\r\n    border-radius: 4px;\r\n    border: 1px solid rgba(255, 255, 255, 0.2);\r\n    outline: none;\r\n    color: #fff;\r\n}\r\n\r\n.kankan-plugins input:focus {\r\n    border: 1px solid var(--main-color);\r\n}\r\n\r\n.kankan-plugins button {\r\n    cursor: pointer;\r\n    width: 100%;\r\n    height: 34px;\r\n    outline: none;\r\n    border-radius: 4px;\r\n    font-size: 14px;\r\n    background: none !important;\r\n    transition: all 0.3s ease;\r\n    color: var(--main-color);\r\n    border: 1px solid var(--main-color);\r\n}\r\n\r\n/* xui */\r\n.kankan-app_combox {\r\n    cursor: pointer;\r\n    position: relative;\r\n    background: #323233;\r\n    border-radius: 4px;\r\n    border: 1px solid rgba(255, 255, 255, 0.2);\r\n    outline: none;\r\n    color: #fff;\r\n    height: 34px;\r\n    width: 100%;\r\n}\r\n\r\n.kankan-app_combox .inner-icon {\r\n    cursor: pointer;\r\n    font-size: 12px;\r\n    position: absolute;\r\n    right: 5px;\r\n    top: 50%;\r\n    transform: translateY(-50%);\r\n    color: var(--font-color);\r\n}\r\n\r\n.kankan-app_combox .inner-text {\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 0 5px;\r\n    height: 100%;\r\n}\r\n\r\n.kankan-app_combox .inner-list {\r\n    position: absolute;\r\n    left: 0px;\r\n    right: 0px;\r\n    top: 100%;\r\n    border: 1px solid rgba(255, 255, 255, 0.2);\r\n    background: #323233;\r\n    z-index: 1000;\r\n}\r\n\r\n.kankan-app_combox .inner-list>div {\r\n    height: 34px;\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 0 5px;\r\n}\r\n\r\n.kankan-app_combox .inner-list>div:hover {\r\n    color: var(--main-color);\r\n}",{});var _={"cad.input":"请输入名称","model.enter":"入户门"},W={num:null,dom:null,env:"production",version:"4.0.0",lang:"zh",langs:{},view:!0,mobile:!1,region:"",server:"https://www.4dkankan.com/",resource:"https://4dkk.4dage.com/",showSDKInfo:!0,useShortcutKeys:!1,antialias:!0,getServerURL(e){return this.server+e},getResourceURL(e){return this.resource+e},getResourceImageURL(e){return this.getResourceURL("scene_view_data/".concat(this.num,"/images/").concat(e))},getResourceDataURL(e){return this.getResourceURL("scene_view_data/".concat(this.num,"/data/").concat(e))},i18n(e){return this.langs[this.lang]&&this.langs[this.lang][e]?this.langs[this.lang][e]:(this.langs.zh||(this.langs.zh=_),this.langs.zh[e]||"")},isLoadTags:!0};if(W.showSDKInfo)if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var Z=["\n %c %c 4DKanKan SDK "+W.version+" - https://www.4dkankan.com/  \n","background: #1fe4dc; padding:5px 0;","color: #000; background: #1fe4dc; padding:5px 0;"];console.log.apply(console,Z)}else console&&console.log("4DKanKan SDK "+W.version+" - https://www.4dkankan.com/");function Q(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var q=0;function Y(e){return"__private_"+q+++"_"+e}var X=Y("plugins"),J=function(){function e(t){i(this,e),Object.defineProperty(this,X,{writable:!0,value:{}}),this.app=t}var t;return u(e,[{key:"add",value:(t=S(C.mark((function e(t,n){var o,i=this;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t(this.app,n),e.abrupt("return",new Promise((function(e,t){o.then&&o.then((function(n){return n.$name?i[n.$name]?e(i[n.$name]):(n.$html&&(n.$scope?n.$scope.insertAdjacentHTML("beforeend",n.$html):i.app.$plugins.insertAdjacentHTML("beforeend",n.$html),delete n.$html),i[n.$name]=n,n.$load&&(n.$load(),delete n.$load),void e(n)):t("require a plugin name")}))})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"get",value:function(e){return Q(this,X)[X][e]}}]),e}(),K=Y("components"),ee=function(){function e(t){i(this,e),Object.defineProperty(this,K,{writable:!0,value:void 0}),this.app=t,Q(this,K)[K]={}}return u(e,[{key:"add",value:function(e,t){-1==["store","resource"].indexOf(e)?Q(this,K)[K][e]=t:this.app[e]=t}},{key:"get",value:function(e){return Q(this,K)[K][e]}}]),e}(),te=location.origin,ne=(document.currentScript||{}).src,oe=function(){if(!ne){try{({}).b()}catch(n){var e=n.stack||n.sourceURL||n.stacktrace,t=/(?:http|https|file):\/\/.*?\/.+?.js/.exec(e);t&&(ne=t[0])}}var n=ne.split("/");return n.pop(),ne=n.join("/")+"/",function(){return ne}}();function ie(e,t,n){return new Promise((function(o,i){var r=function(e){var t=document.createElement("script");return t.async=!0,e.indexOf(te+"/")&&(t.crossOrigin="anonymous"),t.src=e,t}(e+(n?"?v=".concat(n):""));r.addEventListener("error",(function(){console.error("load:"+e+" error"),i()})),r.addEventListener("load",(function(){document.head.removeChild(r),o(t)})),document.head.appendChild(r)}))}window.addEventListener("error",(function(e){}));var re,ae=function(){function e(t){i(this,e),this.app=t}return u(e,[{key:"toast",value:function(e){this.app.emit("gui.toast",e)}},{key:"alert",value:function(e){this.app.emit("gui.alert",e)}},{key:"confirm",value:function(e){this.app.emit("gui.confirm",e)}}]),e}(),se={delayOneFrame(e){window.setTimeout(e,1)},normalizeUrl:e=>e.replace("https://","http://"),domainFromUrl(e){var t=/^([^:]*:\/\/)?(www\.)?([^\/]+)/.exec(e);return t?t[3]:e},average(e,t){if(0===e.length)return null;for(var n=0,o=0,i=0;i<e.length;i++){n+=t?e[i][t]:e[i],o++}return n/o},countUnique(e){for(var t={},n=0;n<e.length;n++)t[e[n]]=1+(t[e[n]]||0);return Object.keys(t).length},averageVectors(e,t){var n=new THREE.Vector3;if(0===e.length)return n;for(var o=0,i=0;i<e.length;i++){var r=t?e[i][t]:e[i];n.add(r),o++}return n.divideScalar(o)},equalLists(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0},lowerMedian:(e,t)=>0===e.length?null:(t=t||2,e.sort((function(e,t){return e-t})),e[Math.floor(e.length/t)]),stableSort:(e,t)=>e.map((function(e,t){return{value:e,index:t}})).sort((function(e,n){var o=t(e.value,n.value);return 0!==o?o:e.index-n.index})).map((function(e){return e.value})),filterAll:(e,t)=>e.filter((function(e){return t.every((function(t){return t(e)}))})),formatDate:e=>[e.getFullYear(),e.getMonth()+1,e.getDate()].join("-"),formatDatetime:e=>[e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes()].join("-"),randomString(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*n.length));return t},uint8ToBase64(e,t){t&&"number"==typeof t||(t=8192);for(var n=[],o=0;o<e.length;o+=t)n.push(String.fromCharCode.apply(null,e.subarray(o,o+t)));return btoa(n.join(""))},uuid4:function e(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)},nth:e=>1===(e%=10)?e+"st":2===e?e+"nd":3===e?e+"rd":e+"th",extendObject:(e,t)=>(Object.keys(t).forEach((function(n){e[n]=t[n]})),e),deepExtend:function e(t){t=t||{};for(var n=1;n<arguments.length;n++){var o=arguments[n];if(o)for(var i in o)o.hasOwnProperty(i)&&("object"==typeof o[i]?t[i]=e(t[i],o[i]):t[i]=o[i])}return t},inherit(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},extend(e,t){for(var n in t.prototype)e.prototype[n]=t.prototype[n]},extendObject(e,t){if(t instanceof Object)return Object.keys(t).forEach((function(n){e[n]=t[n]})),e},_textureCache:{},loadTextureFromCache(e){return this._textureCache[e]||(this._textureCache[e]=le(e)),this._textureCache[e]},extend(e,t){for(var n in t.prototype)e.prototype[n]=t.prototype[n]},valueFromHash(e,t){var n=new RegExp("[#&?]"+e+"=([^#&?]*)").exec(window.location.href);if(!n)return t;var o=n[1];return"boolean"==typeof t?"true"===o||"1"===o:"number"==typeof t?parseFloat(o):window.decodeURIComponent(o)},deepFreeze(e){var t=this;return Object.freeze(e),Object.getOwnPropertyNames(e).forEach((function(n){!e.hasOwnProperty(n)||null===e[n]||"object"!=typeof e[n]&&"function"!=typeof e[n]||Object.isFrozen(e[n])||t.deepFreeze(e[n])})),e},defaultValue(e){if(null!=e&&"object"==typeof e)return Array.isArray(e)?[]:{}},randomUnique:()=>crypto.getRandomValues(new Uint32Array(1))[0],getMAXCUBETEXTURESIZE:function(){try{var e=document.createElement("canvas"),t=e.getContext("webgl");return t||(t=e.getContext("experimental-webgl")),t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE)}catch(e){return 0}}},le=((re=new THREE.TextureLoader).setCrossOrigin("Anonymous"),re.crossOrigin=!0,function(e,t,n,o){return re.load(e,t,n,o)});se.dataURLtoBlob=function(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]),i=o.length,r=new Uint8Array(i);i--;)r[i]=o.charCodeAt(i);return new Blob([r],{type:n})},se.dataURLtoFile=function(e,t){for(var n=e.split(","),o=n[0].match(/:(.*?);/)[1],i=atob(n[1]),r=i.length,a=new Uint8Array(r);r--;)a[r]=i.charCodeAt(r);return new File([a],t,{type:o})},se.saveFile=function(e,t,n){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=e,o.download=t;var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(i),n&&n()},se.PrefixPng="data:image/png;base64,",se.getBlobSrc=function(e,t){var n=se.dataURLtoBlob((t?se.PrefixPng:"")+e);return window.URL.createObjectURL(n)},se.replaceAll=function(e,t,n){var o=new RegExp(t,"g");return e.replace(o,n)},se.randomWord=function(e,t,n){var o="",i=t,r=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];e&&(i=Math.round(Math.random()*(n-t))+t);for(var a=0;a<i;a++){o+=r[Math.round(Math.random()*(r.length-1))]}return o},se.getRandomSid=function(){var e=se.randomWord(!0,5,7),t=(new Date).getTime()+"",n=t.length;return e+(t=t.substring(n-8,n-5)+t.substring(n-3,n))},se.getTime=function(e){var t="",n=parseInt(e/60);return n<10&&(t+="0"),t+=n,1==(e=parseInt(e%60)+"").length&&(e="0"+e),t=t+":"+e},se.cloneObject=function(e,t){if(t=t||{},e instanceof Array){if(!(e[0]instanceof Object))return e.slice(0);t=[]}for(var n in e)e[n]instanceof Object?t[n]=CloneObject(e[n]):t[n]=e[n];return t};var ce,ue,he,de=function(e){se.extend(e,EventEmitter)},pe=oe(),fe={};function me(e,t){if(void 0!==fe[e]&&console.warn("Identifier component.".concat(e," has already been declared")),"function"!=typeof t)throw TypeError("argument component not a function");fe[e]=t}var ve,ge,ye,we=de((he=ue=function(){function e(t){i(this,e),this.uid=e.uid++,this.env=e.env,this.version=e.version,this.dom=null,this.$plugins=null,this.core=new ee(this),this.config=e.config(t,{}),this.Plugins=new J(this),this.gui=new ae(this)}return u(e,[{key:"withDom",value:function(){var e="string"==typeof this.config.dom?document.querySelector(this.config.dom):this.config.dom;if(!e)throw new Error("options.dom must be require");var t=document.createElement("div");t.className="kankan-app";var n=document.createElement("div");n.id="kankan-plugins__".concat(this.uid),n.className="kankan-plugins",n.style.position="absolute",n.style.top=0,n.style.left=0,n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.zIndex=10;var o=document.createElement("div");o.className="player",o.setAttribute("name","main");var i=document.createElement("div");i.className="player",i.setAttribute("name","copy");var r=document.createElement("div");r.className="player-mark",r.style.backgroundImage="url(".concat(this.resource.base("images/tag_pointer.png"),")"),o.appendChild(r),i.appendChild(r.cloneNode()),t.appendChild(n),t.appendChild(o),t.appendChild(i),e.appendChild(t),this.dom=t,this.$plugins=n}},{key:"withComponent",value:function(e){var t=fe[e];if(void 0!==t){var n=t();n.prototype.$app=this;for(var o=arguments.length,i=new Array(o>1?o-1:0),r=1;r<o;r++)i[r-1]=arguments[r];this.core.add(e,V(n,i))}else console.warn("component[".concat(e,"] not a function"))}},{key:"withNewComponent",value:function(e){var t=fe[e];if(void 0!==t){var n=t();n.prototype.$app=this;for(var o=arguments.length,i=new Array(o>1?o-1:0),r=1;r<o;r++)i[r-1]=arguments[r];return V(n,i)}console.warn("component[".concat(e,"] not a function"))}}],[{key:"root",value:function(e){return pe+e}},{key:"config",value:function(e,t){if("object"!=typeof e)return W;for(var n in t&&(t=Object.assign(t,W)),e)-1==["env","version"].indexOf(n)&&void 0!==W[n]&&(t&&(t[n]=e[n]),W[n]=e[n]);return t||W}}]),e}(),ue.uid=1,ue.env=W.env,ue.version=W.version,ue.Config=W,ce=he))||ce,be={convertVisionVector:function(e){return new THREE.Vector3(e.x,e.z,-e.y)},invertVisionVector:function(e){return new THREE.Vector3(e.x,-e.z,e.y)},convertVisionQuaternion:function(e){return new THREE.Quaternion(e.x,e.z,-e.y,e.w).multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(90)))},invertVisionQuaternion:function(e){var t=e.clone().multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(-90)));return new THREE.Quaternion(t.x,-t.z,t.y,t.w)},convertWorkshopVector:function(e){return new THREE.Vector3(-e.x,e.y,e.z)},convertWorkshopQuaternion:function(e){return new THREE.Quaternion(-e.x,e.y,e.z,-e.w).multiply(new THREE.Quaternion(Math.sqrt(2)/2,Math.sqrt(2)/2,0,0))},convertWorkshopPanoramaQuaternion:function(e){return new THREE.Quaternion(e.x,-e.y,-e.z,e.w).normalize().multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(270)))},convertWorkshopOrthoZoom:function(e,t){return-1===e?-1:e*(t.clientHeight/t.clientHeight)},getVec2Angle:function(e,t){return Math.acos(THREE.Math.clamp(this.getVec2Cos(e,t),-1,1))},getVec2Cos:function(e,t){return e.dot(t)/e.length()/t.length()},closeTo:function(e,t,n){return null!=n?Math.abs(e-t)<n:Math.abs(e-t)<1e-6},toPrecision:function(e,t){var n=function(e,t){var n=Math.pow(10,t);return Math.round(e*n)/n};if(e instanceof Array){for(var o=0;o<e.length;o++)e[o]=n(e[o],t);return e}if(e instanceof Object){for(var o in e)e[o]=n(e[o],t);return e}return n(e,t)},isEmptyQuaternion:function(e){return 0===Math.abs(e.x)&&0===Math.abs(e.y)&&0===Math.abs(e.z)&&0===Math.abs(e.w)},projectPositionToCanvas:function(e,t,n,o){(n=n||new THREE.Vector3).copy(e);var i=.5*o.clientWidth,r=.5*o.clientHeight;return n.project(t),n.x=n.x*i+i,n.y=-n.y*r+r,n},convertScreenPositionToNDC:function(e,t,o,i){return(o=o||new n.Vector2).x=e/i.clientWidth*2-1,o.y=-t/i.clientHeight*2+1,o},handelPadResize:!1,handelPadding:(ve=[],ge=[],ye=function(){ve=[],ge=[],be.handelPadResize=!1},window.addEventListener("resize",ye),function(e,t,n){var o;this.handelPadResize&&ye();var i=ge.indexOf(n);return-1==i?(ge.push(n),o={x:this.getOffset("left",n),y:this.getOffset("top",n)},ve.push(o)):o=ve[i],{x:e-o.x,y:t-o.y}}),getOffset:function(e,t,n){var o="left"==e?t.offsetLeft:t.offsetTop;for(n||(n=document.body);(t=t.offsetParent)&&t!=n;)o+="left"==e?t.offsetLeft:t.offsetTop;return o},constrainedTurn:function(e){var t=e%(2*Math.PI);return t>Math.PI?t-=2*Math.PI:t<-Math.PI?t+=2*Math.PI:t},getFOVDotThreshold:function(e){return Math.cos(THREE.Math.degToRad(e/2))},transform2DForwardVectorByCubeFace:function(e,t,n,o){switch(e){case GLCubeFaces.GL_TEXTURE_CUBE_MAP_POSITIVE_X:n.set(1,t.y,t.x);break;case GLCubeFaces.GL_TEXTURE_CUBE_MAP_NEGATIVE_X:n.set(-1,t.y,-t.x);break;case GLCubeFaces.GL_TEXTURE_CUBE_MAP_POSITIVE_Y:n.set(-t.x,1,-t.y);break;case GLCubeFaces.GL_TEXTURE_CUBE_MAP_NEGATIVE_Y:n.set(-t.x,-1,t.y);break;case GLCubeFaces.GL_TEXTURE_CUBE_MAP_POSITIVE_Z:n.set(-t.x,t.y,1);break;case GLCubeFaces.GL_TEXTURE_CUBE_MAP_NEGATIVE_Z:n.set(t.x,t.y,-1)}o&&n.normalize()},getFootPoint:function(e,t,n,o){var i=e.clone().sub(t),r=t.clone().sub(n),a=r.length(),s=i.dot(r)/a,l=t.clone().add(r.multiplyScalar(s/a));return o&&l.clone().sub(t).dot(l.clone().sub(n))>0&&(l=l.distanceTo(t)<l.distanceTo(n)?t.clone():n.clone()),l},getCenterOfGravityPoint:function(e){for(var t=0,n=0,o=0,i=1;i<=e.length;i++){var r=e[i%e.length].x,a=e[i%e.length].y,s=e[i-1].x,l=e[i-1].y,c=(r*l-a*s)/2;t+=c,n+=c*(r+s)/3,o+=c*(a+l)/3}return{x:n/=t,y:o/=t}},getBound:function(e){for(var t=new THREE.Box2,n=0,o=e.length;n<o;n++)t.expandByPoint(e[n]);return t},isPointInArea:function(e,t,n){var o=this.getBound(e);if(t.x<o.min.x||t.x>o.max.x||t.y<o.min.y||t.y>o.max.y)return!1;for(var i=!1,r=t.x,a=t.y,s=0,l=e.length-1;s<e.length;l=s++){var c=e[s].x,u=e[s].y,h=e[l].x,d=e[l].y;if((c-r)*(d-a)==(c-r)*(u-a)&&r>=Math.min(c,h)&&r<=Math.max(c,h)&&a>=Math.min(u,d)&&a<=Math.max(u,d))return!!n;u>a!=d>a&&r<(h-c)*(a-u)/(d-u)+c&&(i=!i)}return i},getArea:function(e){for(var t=e.length,n=0,o=t-1,i=0;i<t;o=i++)n+=e[o].x*e[i].y-e[i].x*e[o].y;return-.5*n},isInBetween:function(e,t,n,o){return e<=t&&t<=n||n<=t&&t<=e||this.closeTo(e,t,o)||this.closeTo(t,n,o)},ifPointAtLineBound:function(e,t,n){return be.isInBetween(t[0].x,e.x,t[1].x,n)&&be.isInBetween(t[0].y,e.y,t[1].y,n)},isLineIntersect:function(e,t,n){var o=e[1].y-e[0].y,i=e[0].x-e[1].x,r=o*e[0].x+i*e[0].y,a=t[1].y-t[0].y,s=t[0].x-t[1].x,l=a*t[0].x+s*t[0].y,c=o*s-a*i;if(0==c)return!1;var u=(s*r-i*l)/c,h=(o*l-a*r)/c;return n||be.ifPointAtLineBound({x:u,y:h},e)&&be.ifPointAtLineBound({x:u,y:h},t)?{x:u,y:h}:void 0},getNormal:function(e){var t,n,o=e.points[1].x-e.points[0].x,i=e.points[1].y-e.points[0].y;if(0!=i)n=-o*(t=1)/i;else{if(0==o)return console.log("两个点一样"),null;t=-i*(n=1)/o}var r=new THREE.Vector3(t,0,n),a=new THREE.Vector3(o,0,i);return r.cross(a).y>0&&(t*=-1,n*=-1),new THREE.Vector2(t,n).normalize()},getQuaBetween2Vector:function(e,t,n){var o=e.angleTo(t),i=e.clone().cross(t).normalize();return 0==i.length()?(new THREE.Quaternion).setFromAxisAngle(n,o):(new THREE.Quaternion).setFromAxisAngle(i,o)},getScaleForConstantSize:function(){var e,t=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3;return function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(a.width2d)e=a.width2d;else{var s=a.position.distanceTo(a.camera.position);e=a.maxSize-(a.maxSize-a.minSize)*THREE.Math.smoothstep(s,a.nearBound,a.farBound)}t.copy(a.position).project(a.camera),n.set(a.dom.clientWidth/2,a.dom.clientHeight/2,1).multiply(t),o.set(e/2,0,0).add(n),i.set(2/a.dom.clientWidth,2/a.dom.clientHeight,1).multiply(o),r.copy(i).unproject(a.camera);var l=r.distanceTo(a.position);return l}}(),getCrossPointAtRect:function(e,t,n,o,i,r){var a,s,l=(t.x-e.x)/(t.y-e.y);return((s=function(t){return 1/l*(t-e.x)+e.y}(a=t.x>=e.x?n+i:i))<r||s>r+o)&&(a=function(t){return l*(t-e.y)+e.x}(s=s<r?r:r+o)),new THREE.Vector2(a,s)},getDirFromUV:function(e){var t,n=Math.cos(e.y*Math.PI),o=2*Math.PI*e.x-Math.PI;t=-Math.PI/2<=o&&o<Math.PI/2?1:-1;var i=Math.tan(o),r=Math.sqrt((1-n*n)/(1+i*i)),a=i*r;return r*t<0&&(r*=-1,a*=-1),a*=-1,new THREE.Vector3(a,n,r)},getUVfromDir:function(e){return(e=e.clone()).x*=-1,{x:Math.atan2(e.x,e.z)/(2*Math.PI)+.5,y:Math.acos(e.y)/Math.PI}},crossRight:function(e,t){var n=t.elements,o=new THREE.Vector3;return o.x=n[0]*e.x+n[1]*e.y+n[2]*e.z+n[3],o.y=n[4]*e.x+n[5]*e.y+n[6]*e.z+n[7],o.z=n[8]*e.x+n[9]*e.y+n[10]*e.z+n[11],o},getNormalDir:function(e,t,n){var o=e.clone().sub(n.position);if(t)var i=n.rot90Matrix.clone();else i=n.skyboxMesh.matrixWorld.clone();return(o=this.crossRight(o,i)).normalize(),o},getDirByLonLat:function(e,t){var n=new THREE.Vector3,o=THREE.Math.degToRad(90-t),i=THREE.Math.degToRad(e);return n.x=Math.sin(o)*Math.cos(i),n.y=Math.cos(o),n.z=Math.sin(o)*Math.sin(i),n},getLineIntersect(e){if(null!=(e=e||{}).A)var t=e.A,n=e.B,o=e.p1,i=e.p2;if(t.equals(n))return o.clone();var r=o.clone().sub(t).normalize(),a=i.clone().sub(n).normalize();r.angleTo(a);return function(){var e,r=o.x-t.x,a=o.y-t.y,s=o.z-t.z,l=i.x-n.x,c=i.y-n.y,u=i.z-n.z,h=t.x-n.x,d=t.y-n.y,p=t.z-n.z,f=r*r+a*a+s*s,m=r*l+a*c+s*u,v=l*l+c*c+u*u,g=r*h+a*d+s*p,y=l*h+c*d+u*p,w=f*v-m*m,b=w,E=w,x=0,T=0,P=function(t){e=(1==t?o:i).clone(),console.log(e+" 在后方交点，使用点"+t)}.bind(this);if(be.closeTo(w,0))x=0,b=1,T=y,E=v;else if(T=f*y-m*g,(x=m*y-v*g)<0)return P(1),e;if(T<0)return P(2),e;var k=0,M=0;k=be.closeTo(x,0)?0:x/b,M=be.closeTo(T,0)?0:T/E;var R=new THREE.Vector3(t.x+k*r,t.y+k*a,t.z+k*s),I=new THREE.Vector3(n.x+M*l,n.y+M*c,n.z+M*u);return R.clone().add(I).multiplyScalar(.5)}()},getShapeGeo:function(e,t){var n=new THREE.Shape;n.moveTo(e[0].x,e[0].y);for(var o=1,i=e.length;o<i;o++)n.lineTo(e[o].x,e[o].y);return t&&t.forEach((function(e){var t=new THREE.Path;t.moveTo(e[0].x,e[0].y);for(var o=1,i=e.length;o<i;o++)t.lineTo(e[o].x,e[o].y);n.holes.push(t)})),new THREE.ShapeBufferGeometry(n)},getUnPosPlaneGeo:function(){var e=new Uint16Array([0,1,2,0,2,3]),t=new Float32Array([0,0,1,0,1,1,0,1]),n=new THREE.BufferGeometry;return n.setIndex(new THREE.BufferAttribute(e,1)),n.addAttribute("uv",new THREE.BufferAttribute(t,2)),function(){return n}}(),getPlaneGeo:function(e,t,n,o){var i=this.getUnPosPlaneGeo().clone(),r=new Float32Array([e.x,e.y,e.z,t.x,t.y,t.z,n.x,n.y,n.z,o.x,o.y,o.z]);return i.addAttribute("position",new THREE.BufferAttribute(r,3)),i.computeVertexNormals(),i.computeBoundingSphere(),i},drawPlane:function(e,t,n,o,i){return new THREE.Mesh(this.getPlaneGeo(e,t,n,o),i)},movePlane:function(e,t,n,o,i){var r=new Float32Array([t.x,t.y,t.z,n.x,n.y,n.z,o.x,o.y,o.z,i.x,i.y,i.z]);e.geometry.addAttribute("position",new THREE.BufferAttribute(r,3)),e.geometry.computeBoundingSphere()}};Math.sign=function(e){return e<0?-1:1};var Ee={signedUrlDefaultExpireTime:24e4,signedUrlCheckInterval:1e4,signedUrlRefreshBuffer:15e3,dollhouseFOV:70,dollhouseNear:1,dollhouseFar:5e3,insideFOV:70,insideFOVMax:120,insideNear:.1,insideFar:5e3,insideLookSpeed:.12,insideLookLimitUp:40,insideLookLimitDown:-40,orthoNear:1,orthoFar:5e3,orthoBase:10,narrowLandscapeHeight:290,reallyNarrowLandscapeHeight:250,visionTilingStartDate:new Date("8/26/2016"),visionTilingStartVersion:"1.1.407.13667",windowHeightHighQualityThreshold:900,tourStepDelayDefault:3500,tourStepDelaySlideShow:5e3,workshopApsect:9/16,highQualityMaxZoom:2,ultraHighQualityMaxZoom:3},xe={};xe.RADIANS_PER_DEGREE=Math.PI/180,xe.DEGREES_PER_RADIAN=180/Math.PI,xe.Vector3=function(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0},xe.Matrix4=function(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),arguments.length>0&&console.error("MathLight.Matrix4: the constructor no longer reads arguments. use .set() instead.")},xe.Matrix4.prototype={identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){return this.elements.set(e.elements),this},applyToVector3:function(e){var t=e.x,n=e.y,o=e.z,i=this.elements;return e.x=i[0]*t+i[4]*n+i[8]*o+i[12],e.y=i[1]*t+i[5]*n+i[9]*o+i[13],e.z=i[2]*t+i[6]*n+i[10]*o+i[14],this},getInverse:function(e,t){var n=this.elements,o=e.elements,i=o[0],r=o[1],a=o[2],s=o[3],l=o[4],c=o[5],u=o[6],h=o[7],d=o[8],p=o[9],f=o[10],m=o[11],v=o[12],g=o[13],y=o[14],w=o[15],b=p*y*h-g*f*h+g*u*m-c*y*m-p*u*w+c*f*w,E=v*f*h-d*y*h-v*u*m+l*y*m+d*u*w-l*f*w,x=d*g*h-v*p*h+v*c*m-l*g*m-d*c*w+l*p*w,T=v*p*u-d*g*u-v*c*f+l*g*f+d*c*y-l*p*y,P=i*b+r*E+a*x+s*T;if(0===P){var k="MathLight.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(k);return console.warn(k),this.identity()}var M=1/P;return n[0]=b*M,n[1]=(g*f*s-p*y*s-g*a*m+r*y*m+p*a*w-r*f*w)*M,n[2]=(c*y*s-g*u*s+g*a*h-r*y*h-c*a*w+r*u*w)*M,n[3]=(p*u*s-c*f*s-p*a*h+r*f*h+c*a*m-r*u*m)*M,n[4]=E*M,n[5]=(d*y*s-v*f*s+v*a*m-i*y*m-d*a*w+i*f*w)*M,n[6]=(v*u*s-l*y*s-v*a*h+i*y*h+l*a*w-i*u*w)*M,n[7]=(l*f*s-d*u*s+d*a*h-i*f*h-l*a*m+i*u*m)*M,n[8]=x*M,n[9]=(v*p*s-d*g*s-v*r*m+i*g*m+d*r*w-i*p*w)*M,n[10]=(l*g*s-v*c*s+v*r*h-i*g*h-l*r*w+i*c*w)*M,n[11]=(d*c*s-l*p*s-d*r*h+i*p*h+l*r*m-i*c*m)*M,n[12]=T*M,n[13]=(d*g*a-v*p*a+v*r*f-i*g*f-d*r*y+i*p*y)*M,n[14]=(v*c*a-l*g*a-v*r*u+i*g*u+l*r*y-i*c*y)*M,n[15]=(l*p*a-d*c*a+d*r*u-i*p*u-l*r*f+i*c*f)*M,this},makeRotationFromQuaternion:function(e){var t=this.elements,n=e.x,o=e.y,i=e.z,r=e.w,a=n+n,s=o+o,l=i+i,c=n*a,u=n*s,h=n*l,d=o*s,p=o*l,f=i*l,m=r*a,v=r*s,g=r*l;return t[0]=1-(d+f),t[4]=u-g,t[8]=h+v,t[1]=u+g,t[5]=1-(c+f),t[9]=p-m,t[2]=h-v,t[6]=p+m,t[10]=1-(c+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}},xe.Quaternion=function(e,t,n,o){this._x=e||0,this._y=t||0,this._z=n||0,this._w=void 0!==o?o:1},xe.Quaternion.prototype={get x(){return this._x},set x(e){this._x=e},get y(){return this._y},set y(e){this._y=e},get z(){return this._z},set z(e){this._z=e},get w(){return this._w},set w(e){this._w=e},copy:function(e){this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w},inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this},setFromAxisAngle:function(e,t){var n=t/2,o=Math.sin(n);return this._x=e.x*o,this._y=e.y*o,this._z=e.z*o,this._w=Math.cos(n),this},setFromUnitVectors:function(){var e,t;return function(n,o){return void 0===e&&(e=new xe.Vector3),(t=xe.dot(n,o)+1)<1e-6?(t=0,Math.abs(n.x)>Math.abs(n.z)?xe.setVector(e,-n.y,n.x,0):xe.setVector(e,0,-n.z,n.y)):xe.cross(n,o,e),this._x=e.x,this._y=e.y,this._z=e.z,this._w=t,this.normalize()}}(),multiply:function(e){return this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var n=e._x,o=e._y,i=e._z,r=e._w,a=t._x,s=t._y,l=t._z,c=t._w;return this._x=n*c+r*a+o*l-i*s,this._y=o*c+r*s+i*a-n*l,this._z=i*c+r*l+n*s-o*a,this._w=r*c-n*a-o*s-i*l,this}},xe.convertWorkshopVector=function(e){return new xe.Vector3(-e.x,e.y,e.z)},xe.convertWorkshopQuaternion=function(e){return new xe.Quaternion(-e.x,e.y,e.z,-e.w).multiply(new xe.Quaternion(Math.sqrt(2)/2,Math.sqrt(2)/2,0,0))},xe.convertWorkshopOrthoZoom=function(e){return-1===e?-1:e/16*(window.innerWidth/window.innerHeight)/Ee.workshopApsect},xe.convertWorkshopPanoramaQuaternion=function(e){return new xe.Quaternion(e.x,-e.y,-e.z,e.w).normalize().multiply((new xe.Quaternion).setFromAxisAngle(new xe.Vector3(0,1,0),270*xe.RADIANS_PER_DEGREE))},xe.normalize=function(e){var t=e.x*e.x+e.y*e.y+e.z*e.z,n=Math.sqrt(t);e.x/=n,e.y/=n,e.z/=n},xe.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},xe.cross=function(e,t,n){var o=e.x,i=e.y,r=e.z;n.x=i*t.z-r*t.y,n.y=r*t.x-o*t.z,n.z=o*t.y-i*t.x},xe.setVector=function(e,t,n,o){e.x=t,e.y=n,e.z=o},xe.copyVector=function(e,t){t.x=e.x,t.y=e.y,t.z=e.z},xe.addVector=function(e,t){e.x+=t.x,e.y+=t.y,e.z+=t.z},xe.subVector=function(e,t){e.x-=t.x,e.y-=t.y,e.z-=t.z},xe.applyQuaternionToVector=function(e,t){var n=t.x,o=t.y,i=t.z,r=e.x,a=e.y,s=e.z,l=e.w,c=l*n+a*i-s*o,u=l*o+s*n-r*i,h=l*i+r*o-a*n,d=-r*n-a*o-s*i;t.x=c*l+d*-r+u*-s-h*-a,t.y=u*l+d*-a+h*-r-c*-s,t.z=h*l+d*-s+c*-a-u*-r},xe.angleBetweenVectors=function(e,t){return Math.acos(xe.dot(e,t))},xe.closeTo=function(e,t,n){var o=Math.pow(10,-(n||4)),i=Math.abs(e.x-t.x)<o&&Math.abs(e.y-t.y)<o&&Math.abs(e.z-t.z)<o;return e.w?i&&Math.abs(e.w-t.w)<o:i};var Te=new THREE.Raycaster,Pe={getPos2d:function(e,t,n,o){n=n||t.camera,o=o||t.domElement;var i,r,a=e.clone().project(n);i=(a.x+1)/2*o.clientWidth,r=(1-(a.y+1)/2)*o.clientHeight;var s=i<=o.clientWidth&&i>=0&&r<=o.clientHeight&&r>=0;return{pos:new THREE.Vector2(i,r),vector:a,trueSide:a.z<1,inSight:s}},ifShelter:function(e,t,n,o,i){n||(n=this.getPos2d(e,t)),o=o||t.camera;var r=new THREE.Vector3(n.x,n.y,-1).unproject(o),a=e.clone().sub(r).normalize();Te.set(r,a);var s=null==i?t.model.colliders:t.model.floors.index[i].collider.children,l=Te.intersectObjects(s),c=e.distanceTo(r);if(l&&l.length)for(var u=0;u<l.length;u++)if(l[u].distance<c)return!0},getPosAtPlane:function(e,t,n){var o=e,i=t.mouse,r=new THREE.Vector3(i.x,i.y,-1).unproject(t.camera);if(null!=n.y){var a=n.y;if("floorplan"==t.mode)var s=e.x,l=e.z;else{if(a<t.camera.position.y&&r.y<=o.y)return null;if(r.y==o.y)return void console.log("一样？？");if(o.y==a)return void console.log("一样2？？");s=((p=(r.y-a)/(o.y-a))*o.x-r.x)/(p-1),l=(p*o.z-r.z)/(p-1)}}else{var c=n.normalVec,u=n.pullPos;if(0!=c.y)return void console.log("N.y != 0");if(r.z==o.z)return void console.log("O.z==A.z？");if(0!=c.z&&0!=c.x){var h=c.x*(o.x-r.x)+c.y*(o.y-r.y)+c.z*(o.z-r.z);if(0==h)return void console.log("分母为0？？ return;");var d=-(c.x*r.x+c.y*r.y+c.z*r.z-(u.x*c.x+u.y*c.y+u.z*c.z))/h;s=d*(o.x-r.x)+r.x,a=d*(o.y-r.y)+r.y,l=d*(o.z-r.z)+r.z}else if(0==c.x){l=u.z;if(r.y==o.y)return void console.log("一样？？");if(o.y==a)return void console.log("一样2？？");if(o.z==l)return void console.log("一样3？？");s=((p=(r.z-l)/(o.z-l))*o.x-r.x)/(p-1),a=(p*o.y-r.y)/(p-1)}else if(0==c.z){s=u.x;if(r.y==o.y)return void console.log("一样？？");if(o.y==a)return void console.log("一样2？？");if(o.x==s)return void console.log("一样3？？");var p;a=((p=(r.x-s)/(o.x-s))*o.y-r.y)/(p-1),l=(p*o.z-r.z)/(p-1)}}return new THREE.Vector3(s,a,l)},getMouseIntersect:function(e,t,n){var o=new THREE.Raycaster;e.updateMatrixWorld();var i=new THREE.Vector3(n.x,n.y,-1).unproject(e),r=new THREE.Vector3(n.x,n.y,1).unproject(e).sub(i).normalize();o.set(i,r);var a=o.intersectObjects(t);return 0===a.length?null:a[0]},ifIntersectChunks:function(e,t,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=t.clone().sub(e).normalize(),r=o.InfinityLen?1/0:e.distanceTo(t)+(o.extLen||0),a=new THREE.Raycaster(e.clone(),i,0,r),s=a.intersectObjects(o.meshes||n.colliders);if(s&&s.length)return s;if(o.throughWidth){var l=be.getNormal({points:[{x:e.x,y:e.z},{x:t.x,y:t.z}]});l.multiplyScalar(o.throughWidth);var c=new THREE.Vector3(l.x,0,l.y),u=e.clone().add(c);a.set(u,i);var h=a.intersectObjects(o.meshes||n.colliders);if(a.set(e.clone().add(c.negate()),i),h&&h.length)return h;var d=a.intersectObjects(o.meshes||n.colliders);if(d&&d.length)return d}return null},getVisiblePano:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=[],i=e.clone(),r=n.panos||t.panos.list;return r.forEach((function(e){if(e.isAligned()){var r=e.position.clone(),a=new THREE.Raycaster(r.clone(),i.clone().sub(r).normalize(),0,r.distanceTo(i)-(n.tolerance||0)).intersectObjects(n.model||t.colliders,!0);a&&a.length||o.push(e)}})),o},raycastToFindFloor:function(){var e=[new THREE.Vector3(0,-1,0),new THREE.Vector3(1,-1,0),new THREE.Vector3(0,-1,1),new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,-1,-1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1)];return function(t,n){var o=[],i=[],r=[];for(var a in t.model.floors.list){var s=t.model.floors.list[a];n.y>=s.boundingBox.min.y&&n.y<=s.boundingBox.max.y&&(o.push(s),i.push.apply(i,L(s.collider.children)))}if(1==o.length)return o[0];if(o.length>1){for(var l=0;l<e.length;l++){var c=new THREE.Raycaster(n.clone(),e[l].clone()).intersectObjects(i);c.length&&function(){var e=c[0].object.parent.parent,t=r.find((function(t){return t.floor==e}));t?t.len++:r.push({floor:e,len:1})}()}return r.sort((function(e,t){t.len,e.len})),r[0]||(r=[],o.forEach((function(e){var t=e.boundingBox,o=[new THREE.Vector3(t.min.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.max.z),new THREE.Vector3(t.min.x,t.min.y,t.max.z),new THREE.Vector3(t.min.x,t.max.y,t.min.z),new THREE.Vector3(t.max.x,t.min.y,t.min.z),new THREE.Vector3(t.max.x,t.max.y,t.min.z),new THREE.Vector3(t.min.x,t.max.y,t.max.z),new THREE.Vector3(t.max.x,t.min.y,t.max.z)],i=0;o.forEach((function(e){return i+=e.distanceTo(n)})),r.push({floor:e,dis:i})})),r.sort((function(e,t){e.dis,t.dis}))),r[0].floor}return n.y<t.model.floors.list[0].center.y?(o=t.model.floors.list.sort((function(e,t){return e.boundingBox.min.y-t.boundingBox.min.y})))[0]:(o=t.model.floors.list.sort((function(e,t){return t.boundingBox.max.y-e.boundingBox.max.y})))[0]}}(),getQuaByAim:function(e,t){return(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,-1),e.clone().sub(t).normalize())},getAimByQua:function(e,t){return new THREE.Vector3(0,0,-1).applyQuaternion(e).add(t)}},ke={info(){var e;(e=console).log.apply(e,arguments)},debug(){var e;(e=console).debug.apply(e,arguments)},error(){var e;(e=console).error.apply(e,arguments)},warn(){var e;(e=console).warn.apply(e,arguments)},time(e){console.time(e)},timeEnd(e){console.timeEnd(e)},message(e){alert(e)}},Me=function(){this.actionSequence=[],this.actionSequenceInProgress=!1};Me.prototype.reset=function(e){this.actionSequenceInProgress=!1,this.actionSequence.length=0},Me.prototype.addZoomAction=function(){var e=null,t=null,n=!1,o=function(){e=null,this.actionSequence.length>0&&(this.actionSequence[0].start,this.actionSequence[this.actionSequence.length-1].end),this.reset()};return function(i,r,a){if(i!==r){n||(o=o.bind(this),n=!0),e&&(window.clearTimeout(e),e=null),a===t&&this.actionSequenceInProgress||(this.reset(),t=a),this.actionSequenceInProgress=!0;var s={start:i,end:r};this.actionSequence.push(s),e=window.setTimeout(o,150)}}}();var Re=function(){function e(){i(this,e),this.events=[],this.valid=!1}return u(e,[{key:"push",value:function(e,t){this.events.push({direction:e,pano:t}),this.valid=!0}},{key:"pop",value:function(e){var t=this.events.pop();return this.events.length<1&&(this.valid=!1),t}},{key:"peek",value:function(){return this.events.length?this.events[this.events.length-1]:{direction:null,pano:null}}},{key:"invalidate",value:function(){this.events=[],this.valid=!1}},{key:"reversePano",value:function(e){if(!this.valid)return null;var t=this.peek();return r.opposite(e)===t.direction?(this.pop(),t.pano):null}}]),e}(),Ie={getEaseOut:function(e){var t;return(e=Math.round(e))<2?(e=Math.PI/2,t=Ie.easeOutSine):t=function(t,n,o,i){return e>2&&console.log(e),-o/Math.pow(-i,e)*Math.pow(t-i,e)+o},{k:e,easeFun:t}},linearTween:function(e,t,n,o){return n*e/o+t},easeInQuad:function(e,t,n,o){return n*(e/=o)*e+t},easeOutQuad:function(e,t,n,o){return-n*(e/=o)*(e-2)+t},easeInOutQuad:function(e,t,n,o){return(e/=o/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,n,o){return n*(e/=o)*e*e+t},easeOutCubic:function(e,t,n,o){return e/=o,n*(--e*e*e+1)+t},easeInOutCubic:function(e,t,n,o){return(e/=o/2)<1?n/2*e*e*e+t:n/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,n,o){return n*(e/=o)*e*e*e+t},easeOutQuart:function(e,t,n,o){return e/=o,-n*(--e*e*e*e-1)+t},easeInOutQuart:function(e,t,n,o){return(e/=o/2)<1?n/2*e*e*e*e+t:-n/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,n,o){return n*(e/=o)*e*e*e*e+t},easeOutQuint:function(e,t,n,o){return e/=o,n*(--e*e*e*e*e+1)+t},easeInOutQuint:function(e,t,n,o){return(e/=o/2)<1?n/2*e*e*e*e*e+t:n/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,n,o){return-n*Math.cos(e/o*(Math.PI/2))+n+t},easeOutSine:function(e,t,n,o){return console.log("easeOutSine"),n*Math.sin(e/o*(Math.PI/2))+t},easeInOutSine:function(e,t,n,o){return-n/2*(Math.cos(Math.PI*e/o)-1)+t},easeInExpo:function(e,t,n,o){return n*Math.pow(2,10*(e/o-1))+t},easeOutExpo:function(e,t,n,o){return n*(1-Math.pow(2,-10*e/o))+t},easeInOutExpo:function(e,t,n,o){return(e/=o/2)<1?n/2*Math.pow(2,10*(e-1))+t:(e--,n/2*(2-Math.pow(2,-10*e))+t)},easeInCirc:function(e,t,n,o){return e/=o,-n*(Math.sqrt(1-e*e)-1)+t},easeOutCirc:function(e,t,n,o){return e/=o,e--,n*Math.sqrt(1-e*e)+t},easeInOutCirc:function(e,t,n,o){return(e/=o/2)<1?-n/2*(Math.sqrt(1-e*e)-1)+t:(e-=2,n/2*(Math.sqrt(1-e*e)+1)+t)},easeInElastic:function(e,t,n,o){var i=1.70158,r=0,a=n;return 0===e?t:1==(e/=o)?t+n:(r||(r=.3*o),a<Math.abs(n)?(a=n,i=r/4):i=r/(2*Math.PI)*Math.asin(n/a),-a*Math.pow(2,10*(e-=1))*Math.sin((e*o-i)*(2*Math.PI)/r)+t)},easeOutElastic:function(e,t,n,o){var i=1.70158,r=0,a=n;return 0===e?t:1==(e/=o)?t+n:(r||(r=.3*o),a<Math.abs(n)?(a=n,i=r/4):i=r/(2*Math.PI)*Math.asin(n/a),a*Math.pow(2,-10*e)*Math.sin((e*o-i)*(2*Math.PI)/r)+n+t)},easeInOutElastic:function(e,t,n,o){var i=1.70158,r=0,a=n;return 0===e?t:2==(e/=o/2)?t+n:(r||(r=o*(.3*1.5)),a<Math.abs(n)?(a=n,i=r/4):i=r/(2*Math.PI)*Math.asin(n/a),e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*o-i)*(2*Math.PI)/r)*-.5+t:a*Math.pow(2,-10*(e-=1))*Math.sin((e*o-i)*(2*Math.PI)/r)*.5+n+t)},easeInBack:function(e,t,n,o,i){return void 0===i&&(i=1.70158),n*(e/=o)*e*((i+1)*e-i)+t},easeOutBack:function(e,t,n,o,i){return void 0===i&&(i=1.70158),n*((e=e/o-1)*e*((i+1)*e+i)+1)+t},easeInOutBack:function(e,t,n,o,i){return void 0===i&&(i=1.70158),(e/=o/2)<1?n/2*(e*e*((1+(i*=1.525))*e-i))+t:n/2*((e-=2)*e*((1+(i*=1.525))*e+i)+2)+t},easeOutBounce:function(e,t,n,o){return(e/=o)<1/2.75?n*(7.5625*e*e)+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},easeInBounce:function(e,t,n,o){return n-Ie.easeOutBounce(o-e,0,n,o)+t},easeInOutBounce:function(e,t,n,o){return e<o/2?.5*Ie.easeInBounce(2*e,0,n,o)+t:.5*Ie.easeOutBounce(x,2*e-o,0,n,o)+.5*n+t}},Se={globalDone:null,funcs:[],counter:0,uniqueID:0,start(e,t,n,o,i,r,a){return o=o||0,this.funcs.push({func:e,current:-o*Math.abs(t),duration:(1-Math.max(o,0))*Math.abs(t),done:n,easing:i||Ie.linearTween,cycling:t<0,running:!0,debug:o<0,name:r||"T"+this.counter,id:void 0===a?this.counter:a,paused:!1}),e(0,16),this.counter+=1,e},trigger(e){var t=void 0===e.delayRatio?0:e.delayRatio,n=e.func||function(){},o=void 0===e.duration?0:e.duration;void 0!==e.cycling&&e.cycling&&(o=-Math.abs(o));var i=e.done||null,r=e.easing||Ie.linearTween,a=e.name||"R"+this.counter,s=void 0===e.id?this.counter:e.id;return this.start(n,o,i,t,r,a,s)},setTimeout(e,t,n){var o=void 0===n?this.counter:n;return this.trigger({done:e,duration:void 0===t?0:t,name:"O"+this.counter,id:o})},pause(){this.paused=!0},resume(){this.paused=!1},update(e){this.funcs.forEach((function(t){if(!(t.paused||(t.current+=1e3*e,t.current<0)))if(t.current>=t.duration&&!t.cycling){var n=t.easing(1,0,1,1);t.func(n,1e3*e),t.done&&t.done(),t.running=!1}else{var o=t.easing(t.current%t.duration/t.duration,0,1,1);(t.func(o,1e3*e)||!1)&&(t.done&&t.done(),t.running=!1)}}));var t=this.funcs.length;this.funcs=this.funcs.filter((function(e){return e.running}));var n=this.funcs.length;if(t>0&&0===n&&this.globalDone){var o=this.globalDone;this.globalDone=null,o()}},adjustSpeed(e,t){for(var n=this.getById(e),o=0;o<n.length;o++){var i=n[o];i.duration/=t,i.current/=t}},getById(e){return this.funcs.filter((function(t){return e===t.id}))},get(e){for(var t=0;t<this.funcs.length;t+=1)if(this.funcs[t].func===e)return this.funcs[t];return null},isRunning(e){var t=this.get(e);return null!==t&&t.running},countActive(){for(var e=0,t=0;t<this.funcs.length;t+=1)e+=this.funcs[t].running;return e},listActive(){for(var e=[],t=0;t<this.funcs.length;t+=1)this.funcs[t].running&&e.push(this.funcs[t].name);return e},done(e){this.globalDone=e},cancelById(e){var t=void 0===e?0:e;this.funcs=this.funcs.filter((function(e){return e.id!==t}))},cancel(e){this.funcs=this.funcs.filter((function(t){return t.func!==e}))},getUniqueId(){return this.uniqueID-=1,this.uniqueID}},Ce={mobileVersion(e,t){var n=window.navigator.userAgent.match(e);return n=n?n[1].split(t):[],{major:parseInt(n[0])||0,minor:parseInt(n[1])||0,patch:parseInt(n[2])||0}},isFullscreen:()=>document.fullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement,supportsFullscreen:()=>document.fullscreenEnabled||document.mozFullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled,isPointerLocked:()=>document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement,requestFullscreen(e,t){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):e.msRequestFullscreen&&e.msRequestFullscreen(),t&&$(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",Ce.requestPointerLock)},requestPointerLock(){var e;if(document.fullscreenElement)e=document.fullscreenElement();else if(document.mozFullscreenElement)e=document.mozFullscreenElement();else if(document.mozFullScreenElement)e=document.mozFullScreenElement();else{if(!document.webkitFullscreenElement)return;e=document.webkitFullscreenElement()}e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock(),$(document).off("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",this)},exitPointerLock(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()},exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()},details(){var e=navigator.userAgent.match("(Firefox|Chrome|Safari)/([\\d]+)");return e?{name:e[1],version:parseInt(e[2]),platform:navigator.platform}:{}},is(e){return this.details()&&this.details().name===e},inIframe:()=>window.parent!==window,aspectRatio(){var e=window.innerWidth/window.innerHeight;return isFinite(e)?e:0},userAgent:()=>window.navigator.userAgent,isMobile(){var e=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od|ad)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))},isLandscape(){return this.isMobile&&this.aspectRatio()>1},isSmallScreen:()=>screen.width/window.devicePixelRatio<240,detectWeixin:function(){return"micromessenger"==window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)},detectWeixinMiniProgram:function(){return window.navigator.userAgent.match("miniProgram")},detectIE:()=>-1!==window.navigator.userAgent.indexOf("MSIE ")||!!navigator.userAgent.match(/Trident.*rv\:11\./),detectSafari(){return-1!==window.navigator.userAgent.indexOf("Safari")&&!this.detectChrome()},detectFirefox:()=>-1!==window.navigator.userAgent.indexOf("Firefox"),detectChrome(){return-1!==window.navigator.userAgent.indexOf("Chrome")&&!this.detectOpera()},detectOpera:()=>-1!==window.navigator.userAgent.indexOf("OPR"),detectIOS(){return this.detectIPhone()||this.detectIPad()||this.detectIPod()},detectIPad(){var e=window.navigator.userAgent;return/iPad/.test(e)},detectIPod(){var e=window.navigator.userAgent;return/iPod/.test(e)},detectIPhone(){var e=window.navigator.userAgent;return/iPhone/.test(e)},detectAndroid:()=>-1!==window.navigator.userAgent.indexOf("Android"),detectAndroidMobile(){var e=window.navigator.userAgent;return this.detectAndroid()&&-1!==e.indexOf("Mobile")},detectSamsungNative(){var e=window.navigator.userAgent;return-1!==e.indexOf("SM-G900H")||-1!==e.indexOf("GT-I9500")||-1!==e.indexOf("SM-N900")},detectSamsungS6:()=>-1!==window.navigator.userAgent.indexOf("SM-G92"),detectHUAWEI5X:()=>-1!==window.navigator.userAgent.indexOf("KIW-TL00H"),detectWebVR:()=>!(!window.navigator.getVRDisplays||!window.VRDisplay),getVRDisplay(){var e=this;return new Promise((function(t,n){e.detectWebVR()?navigator.getVRDisplays().then((function(e){e.length>=1?t(e[0]):n(null)})).catch((function(){return n(null)})):n(null)}))},iosVersion(){if(!this.detectIOS())throw new DeviceMismatchException("Did not detect an iDevice");return this.mobileVersion(/((?:\d+\_?){1,3}) like Mac OS/,"_")},androidVersion(){if(!this.detectAndroid())throw new DeviceMismatchException("Did not detect an Android based device");return this.mobileVersion(/Android ((?:\d+\.?){1,3})/,".")},valueFromCookie(e,t){var n=new RegExp(e+"=([0-9a-f]+)(; ?|$)").exec(document.cookie);if(!n)return t;var o=n[1];return"boolean"==typeof t?"true"===o||"1"===o:"number"==typeof t?parseFloat(o):o},valueFromHash(e,t){var n=new RegExp("[#&?]"+e+"=([^#&?]*)").exec(window.location.href);if(!n)return t;var o=n[1];return"boolean"==typeof t?"true"===o||"1"===o:"number"==typeof t?parseFloat(o):window.decodeURIComponent(o)},valueFromUrl(e){return this.urlHasValue(e,!0)},urlHasValue:function(e,t){var n=window.location.search.substr(1).split("&");if(t){for(var o=0;o<n.length;o++){var i=n[o].split("=");if(2===i.length&&i[0]===e)return i[1]}return""}for(var r=0;r<n.length;r++){if(n[r].split("=")[0]==e)return!0}return!1}},Ae={green:new THREE.Color("#00c8ae"),lightGreen:new THREE.Color("#09e1c0"),zhiBlue:new THREE.Color(0,.458,.862),newBlue:new THREE.Color(4967932),altBlue:new THREE.Color(47355),tagDefault:new THREE.Color(223357),classicBlue:new THREE.Color(53759),mpYellow:new THREE.Color(16502016),mpOrange:new THREE.Color(16428055),mpBlue:new THREE.Color(12096),mpLtGrey:new THREE.Color(13751252),mpDkGrey:new THREE.Color(10000019),mpRed:new THREE.Color(12525854),mpOrangeDesat:new THREE.Color(16764529),mpBlueDesat:new THREE.Color(4034734),mpRedDesat:new THREE.Color(14705505),white:new THREE.Color(16777215),black:new THREE.Color(0),_desat(e,t){var n=t||.3,o=(new THREE.Color).copy(e).getHSL(e);return(new THREE.Color).setHSL(o.h,o.s*(1-n),o.l)},_darken(e,t){var n=t||.2,o=e.getHSL(e);return(new THREE.Color).setHSL(o.h,o.s,o.l*(1-n))}},De="black",Le="std",ze="walk",Ve={visions:2,debug:!1,version:"2.23.8-0-g24ec69e",skyboxRadius:2500,job:"dacf7dfa24ae47fab8fcebfe4dc41ab9",preTexture:"_50k_texture_jpg_high1",format:"_50k.dam",skyboxRadius:2500,modelBoundsPadding:5,showNeighbors:!1,useWheel:Ce.valueFromHash("wh",!0),crossOrigin:"anonymous",fancierTransition:!1,wireframe:!1,skyboxWireframe:!1,modelAlpha:1,highlightPanoSelection:!1,showSweeps:!0,showSkyboxes:!1,showMesh:!0,showFloors:!1,showFloorDuration:300,showFloorDelay:300,hideFloorDuration:300,hideFloorDelay:0,modelOpaWhenFloorPlaneShow:.3,reticuleOpacityTransitionTime:250,reticuleColor:Ae.newBlue,markerOpacityTransitionTime:500,guiAnimationSpeed:250,highlightAnimationDuration:500,modelComponentLoadSpinnerDelay:150,captureErrors:!1,maxMobileTextures:6,minimalMemoryMode:Ce.valueFromHash("m3",Ce.isMobile()),startupFlyinDelay:3e3,vrEnabled:!1,overlay:{width:1,height:.5,depth:.02},dollhouseDefault:{minDistance:15,maxDistance:50,minPolarAngle:THREE.Math.degToRad(10),maxPolarAngle:THREE.Math.degToRad(90)},hideReticuleTimeout:1e3,analytics:{inactivityThreshold:30,sessionTrackingRate:.15,maxTrackedErrors:20,sessionDurationPingFrequency:10,sessionDurationTimeout:15},flydown:{movementEasing:"easeInOutQuad",movementDelay:.001,rotationEasing:"easeInOutQuad",rotationDelay:.5,modelTextureDelay:.75,skyboxDelay:.75},transition:{flySpeed:.0043,flyTime:750,flytimeMaxDistanceThreshold:7,flytimeDistanceMultiplier:150,aimTime:1500,aimSlowFactor:1.5,blur:.8,movementEasing:"easeInOutQuad",blendEasing:"easeInOutQuad",fastForwardFactor:Ce.valueFromHash("mfis",3)},show360Views:{enabled:!0,transitionTime:1e3},quickstart:{enabled:1,animation:1400,showTextDelay:500,fadeOutDelay:3e3,fovChange:10},appConfig:{webvr_version:null,segment_key:null,embedly_key:null,branch_key:null,keen_write_key:null,keen_project_id:null},input:{longTapThreshold:200,moveToleranceNDC:.08,touchMoveThreshold:25},labels:{enabled:!1,hideUntilStart:!0,fadeInDuration:250,fadeInDelay:250,fadeOutDuration:250,fadeOutDelay:0,zoomHideThreshhold:{mobile:Ce.isSmallScreen()?.45:.6,desktop:2},zoomTruncateThreshhold:{mobile:Ce.isSmallScreen()?.35:.45,desktop:.85},minLengthForTruncate:16,truncateLength:12,truncateSuffix:"..."},tags:{enabled:Ce.valueFromHash("mt",1),startup:{hideUntilStart:!0,fadeInDuration:500,fadeInDelay:100},visibility:{anyDistance:!0,visibleDistance:8,cameraClearance:.1,alphaTestLevel:.05,hideViaFloor:!0,hideOffScreenDisc:!1,hideOffScreenObject:!1},disc:{opacity:1,disabledOpacity:.5,scale:{nearBound:1.5,farBound:4.8,linkFarBound:!1,linkPercent:40,maxSize:80,minSize:40,baseViewportSize:800,responsiveness:100}},pole:{enabled:!0,height:.5,width:2,opacity:.5,color:"white"},navigate:{nearestPano:!0,lineOfSight:!0,reactivate:!0,aimAt:"disc",tiltTolerance:25,rotateSpeedFactor:.6}},path:{color:Ae.newBlue,colorUp:Ae._desat(Ae.newBlue,.5),colorDown:Ae._darken(Ae.newBlue,.35),opacity:.5,style:"ribbon",height:.025,ribbonWidth:.24,outsideHeight:.5,waypointRadius:.5,waypointIndoorRadius:.24,waypointPulse:1e3,typ:De,meshFree:Ce.valueFromHash("mf",1),mapGuides:Ce.valueFromHash("guides",!0),fadeInTime:400,fadeOutTime:300},warp:{nearPanoDist:.1,matchCam:!1,blur:.33,fastTime:1500,teleportTime:1500,outsideTime:2e3,lookAheadMax:.3,lookAheadDist:2.5,softPushDist:.37,softPushEnd:.3,softBendAngle:8,softBendTilt:4,softBendEnd:.3,doBurns:Ce.valueFromHash("kb",!0),burnsAngle:35,minBurnsAngle:35,minDownAngle:-35,maxTurnPerSec:280,maxAimPerSec:35,minRotation:12,maxAimRotation:33.2,turnFriction:.2,flySpeed:.01,minWarpTime:1200,warpInterruptionRedirectTime:500,tourStepDelay:Ce.valueFromHash("st",0),walkDelay:0,walkMaxDist:50,walkMinDist:.8,walkSlideShowThreshhold:3e3,walkExtraPanosDistance:.4,timePerMeter:800,motionLeadTime:500,movementEasing:"easeInOutQuad",blendEasing:"easeInOutQuad",showBunny:!1,loop:Ce.valueFromHash("lp",!1),auto:Ce.valueFromHash("ts",-1),eOrder:"YXZ",stepFactor:.25,brakeStrength:2,minBrakeAngle:.1,maxBrakeAngle:1.8,climbEffort:4},rotationFriction:.05,rotationAccelerationInside:4.5,rotationAccelerationOutside:.15,rotationAfterMoveMultiplier:40,rotationAfterMoveHistoryCount:5,panFriction:.09,panAccelerationOutside:60,zoomNearLimit:.1,zoomFarLimit:10,navigation:{panoScores:!1,mouseDirection:!0,filterStrictness:.75,angleFactor:-30,directionFactor:10,distanceFactor:-1,optionalityFactor:3},sdkInit:!1,secretPanelWord:[38,38,40,40,37,39,37,39,66,65],console:Ce.valueFromHash("console",!1),noMeshFloorPositionOffset:new THREE.Vector3(0,-1.2,0),panoramaNeighbourMaxDistance:5,panoFloorClickRadius:.35,showScreenshotLocations:!1,showAxis:!1,showNeighbourRaycasts:!1,colorMarkerOnLoad:!1,colorMarkerByFloor:!1,tiling:{panoPreRenderRepeatDelay:2500,panoPreRenderDelay:500,preRenderTourPanos:Ce.valueFromHash("tileprerender",0),tilingFlagNames:["usetiles","tiles"],maxNavPanoQuality:Ce.valueFromHash("maxtileq",null),maxZoomPanoQuality:Ce.valueFromHash("maxztileq",null),overlayStyle:Ce.valueFromHash("tileoverlay",0),uploadIntervalDelay:Ce.valueFromHash("tileupdelay",10),initialIntervalDelay:Ce.valueFromHash("itiledelay",0),maxNonBaseUploadsPerFrame:Ce.valueFromHash("maxnbtpf",2),maxBaseUploadsPerFrame:Ce.valueFromHash("maxbtpf",6),customCompression:Ce.valueFromHash("tilecustcomp",0),mobileHighQualityOverride:!1,allowUltraHighResolution:!0},zoom:{enabled:!0,forceOff:Ce.valueFromHash("nozoom",0),overridemax:Ce.valueFromHash("maxzoom",null),overridemin:Ce.valueFromHash("minzoom",null),max:Ee.highQualityMaxZoom,min:1,transitionStyle:Ce.valueFromHash("zoomtrans",1),activationThreshold:1.1,restoreTime:500,zoomToDefaultWhenToPano:!0},profiling:{enabled:Ce.valueFromHash("mem",!1)}};(Ve=se.deepExtend(Ve,Ee,{insideFOV:Ce.valueFromHash("fov",Ee.insideFOV),insideFOVMax:Ce.valueFromHash("fovmax",Ee.insideFOVMax),panorama:{transitionTime:1e3,modelAlpha:0,modelAlphaDelay:Ve.flydown.modelTextureDelay,modelAlphaLength:1,skyboxOpacity:1,skyboxOpacityDelay:Ve.flydown.skyboxDelay,skyboxOpacityLength:.9,fovLength:1,fovDelay:0,cameraMatrixDuration:.8,cameraMatrixDelay:0,cameraMatrixEase:Ie.easeInCubic,reticuleOpacity:1,markerOpacity:.3,markerOpacityOnHover:1},dollhouse:{transitionTime:1e3,modelAlpha:1,modelAlphaDelay:0,modelAlphaLength:1-Ve.flydown.modelTextureDelay,skyboxOpacity:0,skyboxOpacityDelay:0,skyboxOpacityLength:1-Ve.flydown.skyboxDelay,fovLength:1,fovDelay:0,cameraMatrixDuration:.8,cameraMatrixDelay:.3,cameraMatrixEase:Ie.easeInOutQuad,reticuleOpacity:1,markerOpacity:0,markerOpacityOnHover:0},floorplan:{transitionTime:1e3,modelAlpha:1,modelAlphaDelay:0,modelAlphaLength:1-Ve.flydown.modelTextureDelay,skyboxOpacity:0,skyboxOpacityDelay:0,skyboxOpacityLength:1-Ve.flydown.skyboxDelay,fovLength:1,fovDelay:0,cameraMatrixDuration:.5,cameraMatrixDelay:0,cameraMatrixEase:Ie.easeOutCubic,reticuleOpacity:1,markerOpacity:0,markerOpacityOnHover:0,cameraHeight:50},transitioning:{reticuleOpacity:0,markerOpacity:.3,markerOpacityOnHover:1},"floorplan-dollhouse":{rotationDelay:0,rotationDuration:1},"floorplan-panorama":{rotationDelay:.5,rotationDuration:1},"dollhouse-panorama":{rotationDelay:.5,rotationDuration:1},"dollhouse-floorplan":{rotationDelay:0,rotationDuration:1,cameraMatrixDuration:1.05,cameraMatrixDelay:.5},"panorama-dollhouse":{rotationDelay:0,rotationDuration:.5},"panorama-floorplan":{transitionTime:1500,rotationDelay:0,rotationDuration:.5}})).path.meshFree&&(Ve.path.typ=ze),Ve.zoom.max=Ve.zoom.overridemax||Ve.zoom.max,Ve.zoom.min=Ve.zoom.overridemin||Ve.zoom.min,Ve.HorizontalBlurShader=new THREE.ShaderPass(THREE.HorizontalBlurShader),Ve.VerticalBlurShader=new THREE.ShaderPass(THREE.VerticalBlurShader),Ve.VerticalBlurShader.renderToScreen,Ve.aspect=window.innerWidth/window.innerHeight,isNaN(Ee.aspect)&&(Ee.aspect=1),Ve.sphereBufferGeometry=new THREE.SphereBufferGeometry(.1),Ve.planeBufferGeometry=new THREE.PlaneBufferGeometry(.4,.4,1,1),Ve.freeze=Object.freeze({FlyToPano:Se.getUniqueId(),FlyToNewMode:Se.getUniqueId(),FlyToSameMode:Se.getUniqueId(),FlyToViewFloor:Se.getUniqueId(),LookTransition:Se.getUniqueId(),ZoomTransition:Se.getUniqueId(),LookRotationForPlay:Se.getUniqueId(),wallLineShine:Se.getUniqueId(),spotShine:Se.getUniqueId(),rulerShine:Se.getUniqueId(),outsideFocus:Se.getUniqueId(),shopCircle:Se.getUniqueId()});var He=Ve,Oe={PANORAMA:"panorama",DOLLHOUSE:"dollhouse",FLOORPLAN:"floorplan",TRANSITIONING:"transitioning",toInt:function(e){switch(e){case this.PANORAMA:return 1;case this.DOLLHOUSE:return 2;case this.FLOORPLAN:return 3;case this.TRANSITIONING:return-1}throw new Error("未知模式: "+c)},fromInt:function(e){switch(e){case"1":case 1:return this.PANORAMA;case"2":case 2:return this.DOLLHOUSE;case"3":case 3:return this.FLOORPLAN}throw new Error("未知模式: "+c)}},Fe={UP:new THREE.Vector3(0,1,0),DOWN:new THREE.Vector3(0,-1,0),LEFT:new THREE.Vector3(-1,0,0),RIGHT:new THREE.Vector3(1,0,0),FORWARD:new THREE.Vector3(0,0,-1),BACK:new THREE.Vector3(0,0,1)};function Ne(e){return"[object Array]"===Object.prototype.toString.call(e)}function Be(e,t){if(Ne(e))for(var n=0;n<e.length;n++)t(e[n]);else t(e)}function je(e){var t="pending",n=[],o=[],i=[],r=null,a={done:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(Ne(arguments[e]))for(var o=arguments[e],i=0;i<o.length;i++)"resolved"===t&&o[i].apply(this,r),n.push(o[i]);else"resolved"===t&&arguments[e].apply(this,r),n.push(arguments[e]);return this},fail:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(Ne(arguments[e]))for(var n=arguments[e],i=0;i<n.length;i++)"rejected"===t&&n[i].apply(this,r),o.push(n[i]);else"rejected"===t&&arguments[e].apply(this,r),o.push(arguments[e]);return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(Ne(arguments[e]))for(var n=arguments[e],o=0;o<n.length;o++)"pending"===t&&i.push(n[o]);else"pending"===t&&i.push(arguments[e]);return this},then:function(e,t,n){return je((function(n){Be(e,(function(e){"function"==typeof e?s.done((function(){var t=e.apply(this,arguments);t&&"function"==typeof t?t.promise().then(n.resolve,n.reject,n.notify):n.resolve(t)})):s.done(n.resolve)})),Be(t,(function(e){"function"==typeof e?s.fail((function(){var t=e.apply(this,arguments);t&&"function"==typeof t?t.promise().then(n.resolve,n.reject,n.notify):n.reject(t)})):s.fail(n.reject)}))})).promise()},catch:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(Ne(arguments[e]))for(var n=arguments[e],i=0;i<n.length;i++)"rejected"===t&&n[i].apply(this,r),o.push(n[i]);else"rejected"===t&&arguments[e].apply(this,r),o.push(arguments[e]);return this},promise:function(e){if(null==e)return a;for(var t in a)e[t]=a[t];return e},state:function(){return t},debug:function(){console.log("[debug]",n,o,t)},isRejected:function(){return"rejected"===t},isResolved:function(){return"resolved"===t},pipe:function(e,t,n){return je((function(n){Be(e,(function(e){"function"==typeof e?s.done((function(){var t=e.apply(this,arguments);t&&"function"==typeof t?t.promise().then(n.resolve,n.reject,n.notify):n.resolve(t)})):s.done(n.resolve)})),Be(t,(function(e){"function"==typeof e?s.fail((function(){var t=e.apply(this,arguments);t&&"function"==typeof t?t.promise().then(n.resolve,n.reject,n.notify):n.reject(t)})):s.fail(n.reject)}))})).promise()}},s={resolveWith:function(e){if("pending"===t){t="resolved";for(var o=r=arguments.length>1?arguments[1]:[],i=0;i<n.length;i++)n[i].apply(e,o)}return this},rejectWith:function(e){if("pending"===t){t="rejected";for(var n=r=arguments.length>1?arguments[1]:[],i=0;i<o.length;i++)o[i].apply(e,n)}return this},notifyWith:function(e){if("pending"===t)for(var n=r=arguments.length>1?arguments[1]:[],o=0;o<i.length;o++)i[o].apply(e,n);return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},l=a.promise(s);return e&&e.apply(l,[l]),l}je.when=function(){if(arguments.length<2){var e=arguments.length?arguments[0]:void 0;return e&&"function"==typeof e.isResolved&&"function"==typeof e.isRejected?e.promise():je().resolve(e).promise()}return function(e){for(var t=je(),n=e.length,o=0,i=new Array(n),r=0;r<e.length;r++)!function(r){var a=null;e[r].done?e[r].done((function(){i[r]=arguments.length<2?arguments[0]:arguments,++o==n&&t.resolve.apply(t,i)})).fail((function(){t.reject(arguments)})):(a=e[r],e[r]=new Deferred,e[r].done((function(){i[r]=arguments.length<2?arguments[0]:arguments,++o==n&&t.resolve.apply(t,i)})).fail((function(){t.reject(arguments)})).resolve(a))}(r);return t.promise()}(arguments)};var Ue=je;function _e(){return new je}var We=function(){function e(t,n){i(this,e),this.version=1,this.cache=null,this.expires=0,this.projectNum=t,this.app=n}return u(e,[{key:"validate",value:function(e){return"catalog.json"in e&&Object.keys(e).length>0}},{key:"update",value:function(e){return this.cache=e,this.expires=Date.now()+constants.signedUrlDefaultExpireTime,_e.when()}},{key:"get",value:function(e){return this.app.resource.getViewImagesURL(e)}}]),e}();function Ze(e,t,n){return(Ze="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=w(e)););return e}(e,t);if(o){var i=Object.getOwnPropertyDescriptor(o,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}var Qe=function(){function e(){if(i(this,e),this.list=[],this.index={},Object.defineProperty(this,"length",{get:function(){return this.list.length}}),"function"!=typeof this.getIndex)throw new Error("IndexedCollection.getIndex not implemented in subclass.")}return u(e,[{key:"forEach",value:function(e){this.list.forEach(e)}},{key:"add",value:function(e){this.list.push(e),this.index[this.getIndex(e)]=e}},{key:"extend",value:function(e){for(var t=0;t<e.length;t++)this.add(e[t])}},{key:"get",value:function(e){return this.index[e]}},{key:"first",value:function(){return this.list[0]}},{key:"last",value:function(){return this.list[this.list.length-1]}},{key:"reIndex",value:function(){this.index={};var e=this;this.forEach((function(t){e.index[e.getIndex(t)]=t}))}},{key:"filter",value:function(e){var t=this.list.filter(e);return this.reIndex(),t}},{key:"reduce",value:function(e,t){return this.list.reduce(e,t)}},{key:"sort",value:function(e){return this.list.sort(e)}},{key:"indexOf",value:function(e){for(var t=0;t<this.list.length;++t)if(this.list[t]===e)return t;return-1}}]),e}(),Ge=function(){function e(t){i(this,e),this.chunksize=t||10,this.chunks={},this.boundingBoxes={},this.children=[],this.offset=new THREE.Vector3(0,.5,0),this.material=new THREE.MeshBasicMaterial({color:16777215*Math.random(),side:THREE.DoubleSide})}return u(e,[{key:"add",value:function(e){var t,n,o,i,r,a,s,l,c,u,h=e.attributes;h?(t=h.position.array,n=void 0!==e.index?e.index.array:void 0):t=e.vertices;var d=new THREE.Vector3;if(n)for(o=0,i=n.length;o<i;o+=3){var p=3*n[o],f=3*n[o+1],m=3*n[o+2];r=(t[p]+t[f]+t[m])/3,a=(t[p+1]+t[f+1]+t[m+1])/3,s=(t[p+2]+t[f+2]+t[m+2])/3,(l=Math.floor(r/this.chunksize)+"."+Math.floor(a/this.chunksize)+"."+Math.floor(s/this.chunksize))in this.chunks?(u=this.chunks[l],c=this.boundingBoxes[l]):(u=this.chunks[l]=[],c=this.boundingBoxes[l]=new THREE.Box3),u.push(t[p],t[p+1],t[p+2],t[f],t[f+1],t[f+2],t[m],t[m+1],t[m+2]),c.expandByPoint(d.set(t[p],t[p+1],t[p+2])),c.expandByPoint(d.set(t[f],t[f+1],t[f+2])),c.expandByPoint(d.set(t[m],t[m+1],t[m+2]))}else for(o=0,i=t.length;o<i;o+=9)r=(t[o]+t[o+3]+t[o+6])/3,a=(t[o+1]+t[o+4]+t[o+7])/3,s=(t[o+2]+t[o+5]+t[o+8])/3,(l=Math.floor(r/this.chunksize)+"."+Math.floor(a/this.chunksize)+"."+Math.floor(s/this.chunksize))in this.chunks?(u=this.chunks[l],c=this.boundingBoxes[l]):(u=this.chunks[l]=[],c=this.boundingBoxes[l]=new THREE.Box3),u.push(t[o],t[o+1],t[o+2],t[o+3],t[o+4],t[o+5],t[o+6],t[o+7],t[o+8]),c.expandByPoint(d.set(t[o],t[o+1],t[o+2])),c.expandByPoint(d.set(t[o+3],t[o+4],t[o+5])),c.expandByPoint(d.set(t[o+6],t[o+7],t[o+8]))}},{key:"build",value:function(){var e=new THREE.Object3D;for(var t in e.material=this.material,this.chunks){var n=this.chunks[t],o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.BufferAttribute(new Float32Array(n),3)),o.boundingBox=this.boundingBoxes[t];var i=new THREE.Mesh(o,this.material);i.material.visible=!1,e.add(i),this.chunks[t]=[]}return e}}]),e}(),qe=1,Ye=3,$e=1,Xe=4,Je=5,Ke=6,et=8,tt=100,nt={vector:function(e,t,n){var o=e.clone();return t=t.clone(),function(i){e.set(o.x*(1-i)+t.x*i,o.y*(1-i)+t.y*i,o.z*(1-i)+t.z*i),n&&n(e,i)}},quaternion:function(e,t,n){var o=e.clone();return function(i){e.copy(o).slerp(t,i),n&&n(e,i)}},property(e,t,n,o){var i=e[t];return function(r){e[t]=i*(1-r)+n*r,o&&o(e[t])}},uniform(e,t,n){var o=e.material.uniforms[t].value;return function(i){e.material.uniforms[t]&&(e.material.uniforms[t].value=o*(1-i)+n*i)}},matrix4(e,t){var n=e.clone();return function(o){for(var i=e.elements,r=n.elements,a=t.elements,s=0;s<16;s++)i[s]=r[s]*(1-o)+a[s]*o}},allUniforms(e,t,n){var o=e.map(function(e){return this.uniform(e,t,n)}.bind(this));return function(e){o.forEach((function(t){t(e)}))}}};function ot(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var it=function(e){f(n,THREE.Object3D);var t=ot(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this)).model=e,a.floorIndex=o,a.name=r||"楼层"+(o+1),a.panos=[],a.chunks=[],a.colliderBuilder=new Ge(3),a.collider=null,a.center=null,a.boundingBox=new THREE.Box3,a.size=null,a.hidden=!1,a.display=!0,a.conservativeBoundingBox=new THREE.Box3,a.debugColor=16777215*Math.random(),a.transition=null,a.entryArrow=[],a}return u(n,[{key:"enter",value:function(e){this.model.setFloor(this,e),this.show(!0)}},{key:"show",value:function(e){var t=this;this.hidden=!1,this.chunks.forEach(function(e){e.material.uniforms.opacity.value=1,e.material.transparent=!1}.bind(this));var n=this.model.$app.core.get("Player");"floorplan"==n.mode&&this.model.floorplanCadImg.showCad(),setTimeout((function(){n.labelManager&&n.labelManager.show(t.floorIndex),n.OverlayManager&&n.OverlayManager.show(t.floorIndex,!0)}),1)}},{key:"hide",value:function(e){var t=this;this.hidden=!0,this.chunks.forEach((function(e){e.material.uniforms.opacity.value=.2,e.material.transparent=!0}));var n=this.model.$app.core.get("Player");setTimeout((function(){n.labelManager&&n.labelManager.hide(t.floorIndex),n.OverlayManager&&n.OverlayManager.hide(t.floorIndex)}),1)}},{key:"toggle",value:function(e,t,n,o){(e=void 0===e?this.hidden:e)?this.show(t,n,o):this.hide(t,n,o)}},{key:"addChunk",value:function(e){e.renderOrder=Ye,this.add(e),this.chunks.push(e),this.boundingBox.union(e.geometry.boundingBox);var t=new THREE.Vector3;this.boundingBox.getSize(t),this.size=t,this.colliderBuilder.add(e.geometry)}},{key:"addPano",value:function(e){this.panos.push(e),this.add(e.skyboxMesh),e.marker&&this.add(e.marker);var t=new THREE.Vector3(1,1,1),n=(new THREE.Box3).setFromCenterAndSize(e.position,t);this.boundingBox.union(n)}},{key:"build",value:function(){this.collider=this.colliderBuilder.build(!0),this.add(this.collider);var e=new THREE.Vector3;this.boundingBox.getCenter(e),this.center=e,this.conservativeBoundingBox.copy(this.boundingBox),this.conservativeBoundingBox.min.y=se.lowerMedian(this.collider.children.map((function(e){return e.geometry.boundingBox.min.y})),5),this.conservativeBoundingBox.max.y=se.lowerMedian(this.collider.children.map((function(e){return e.geometry.boundingBox.max.y})),5),this.colliderBuilder=null}},{key:"toShortString",value:function(){return se.nth(this.floorIndex+1)}},{key:"toString",value:function(){return this.name}}]),n}();function rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var at=function(e){f(n,e);var t=rt(n);function n(e){var o;return i(this,n),(o=t.call(this)).model=e,o.exploded=!1,o}return u(n,[{key:"add",value:function(e){Ze(w(n.prototype),"add",this).call(this,e),this.model.add(e)}},{key:"getIndex",value:function(e){return e.floorIndex}},{key:"build",value:function(){this.list.forEach((function(e){e.build()}))}},{key:"nextFloor",value:function(e,t){return this.index[e.floorIndex+t]||null}},{key:"getOrMakeFloor",value:function(e){var t=this.index[e];return t||(t=new it(this.model,e),this.add(t)),t}},{key:"hide",value:function(){this.list.forEach((function(e){e.hide()}))}},{key:"show",value:function(){this.list.forEach((function(e){e.show()}))}}]),n}(Qe),st={PanoRenderComplete:"panorama.render.complete",TileRenderFailure:"panorama.tile.render.failed",TileRenderSuccess:"panorama.tile.render.success",TileUploadAttempted:"panorama.tile.upload.attempted",UploadAttemptedForAllTiles:"panorama.upload.attempted.all.tiles",ZoomLevelRenderStarted:"panorama.zoom.render.started"},lt=0,ct=1,ut=2,ht=3,dt=4,pt=5,ft={LoadComplete:"panorama.load.complete",LoadFailed:"panorama.load.failed",TileLoaded:"panorama.tile.loaded"},mt=1,vt=2,gt=3,yt=4,wt={uniforms:{map:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:"varying vec3 vWorldPosition;\n\nvoid main() {\n  vWorldPosition = position;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",fragmentShader:"uniform samplerCube map;\nuniform float opacity;\n\nvarying vec3 vWorldPosition;\n\nvoid main() {\n  vec4 color = textureCube( map, vec3( -vWorldPosition.x, vWorldPosition.yz ) );\n  gl_FragColor = vec4(color.rgb, opacity);\n}\n"},bt={uniforms:{panoPosition:{type:"v3",value:new THREE.Vector3}},vertexShader:"varying vec4 worldPosition;\n\nvoid main() {\n\n  worldPosition = modelMatrix * vec4(position, 1.0);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"uniform vec3 panoPosition;\nvarying vec4 worldPosition;\n\nvoid main() {\n\n  float depth = distance(worldPosition.xyz, panoPosition);\n  float color = 1.0 - depth / 10.0;\n  gl_FragColor = vec4(color, color, color, 1.0);\n\n}\n"},Et={uniforms:{minOpa:{type:"f",value:.14},minDistance:{type:"f",value:2.5},maxDistance:{type:"f",value:4},map:{type:"t",value:null},repeatInfoMap:{type:"t",value:null},modelAlpha:{type:"f",value:He.modelAlpha},opacity:{type:"f",value:1},progress:{type:"f",value:0},blackout:{type:"i",value:0},pano0Map:{type:"t",value:null},pano0Position:{type:"v3",value:new THREE.Vector3},pano0Matrix:{type:"m4",value:new THREE.Matrix4},pano1Map:{type:"t",value:null},pano1Position:{type:"v3",value:new THREE.Vector3},pano1Matrix:{type:"m4",value:new THREE.Matrix4},videoReady:{type:"",value:0},videoTexture:{type:"t",value:null},exposure:{type:"f",value:1},parameters:{type:"m4",value:(new THREE.Matrix4).set(4608,3456,8192,4096,1.95985,1.34,1739,2285,-.00173905,274835e-10,-.0340487,0,1235,954,2112,1584)},clipRect:{type:"v4",value:new THREE.Vector4(.1,.1,.5,.5)},blendFov:{type:"f",value:5}},vertexShader:"\n\n        uniform vec3 pano0Position;\n        uniform mat4 pano0Matrix;\n        \n        uniform vec3 pano1Position;\n        uniform mat4 pano1Matrix;\n\n        #if defined(checkDistance)\n        varying vec3 world_Position; \n        #endif\n\n        varying vec2 vUv;\n        varying vec3 vWorldPosition0;\n        varying vec3 vWorldPosition1;\n        \n        void main() {\n        \n            vUv = uv;\n            vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n            \n            #if defined(checkDistance)\n                world_Position = worldPosition.xyz; \n            #endif\n        \n            vec3 positionLocalToPanoCenter0 = worldPosition.xyz - pano0Position;\n            vWorldPosition0 = (vec4(positionLocalToPanoCenter0, 1.0) * pano0Matrix).xyz;\n            vWorldPosition0.x *= -1.0;\n            \n            vec3 positionLocalToPanoCenter1 = worldPosition.xyz - pano1Position;\n            vWorldPosition1 = (vec4(positionLocalToPanoCenter1, 1.0) * pano1Matrix).xyz;\n            vWorldPosition1.x *= -1.0;\n            \n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        \n        }\n\n    ",fragmentShader:"\n\n        #define PI 3.141592653 \n        \n        const vec4 BLACK=vec4(0.0,0.0,0.0,1.0);\n        const vec4 GREY2=vec4(0.5,0.5,0.5,1.0);  \n        const vec4 GREY=vec4(0.23,0.23,0.23,1.0); //cadImg greyArea to cover model\n        \n        uniform sampler2D map;\n        uniform float modelAlpha;\n        uniform float opacity;\n        uniform float progress;\n        uniform int blackout;\n        uniform vec3 pano0Position;\n        uniform vec3 pano1Position;\n        uniform float maxDistance;\n        uniform float minDistance;\n        uniform float minOpa;\n        \n   \n        #if defined(HasVideo)\n            uniform int videoReady;\n            uniform sampler2D videoTexture;\n            uniform float exposure;\n            uniform mat4 parameters;\n            uniform float blendFov;\n        #endif\n    \n         \n        \n        \n        #if defined(Not_Cube)\n            uniform sampler2D pano0Map;\n            uniform sampler2D pano1Map;      \n        #else\n            uniform samplerCube pano0Map;\n            uniform samplerCube pano1Map;\n        #endif\n        \n        #if defined(RepeatUV) \n            uniform sampler2D repeatInfoMap;\n        #endif\n        \n        \n        varying vec2 vUv;\n        varying vec3 vWorldPosition0;\n        varying vec3 vWorldPosition1;\n\n        #if defined(checkDistance)\n            varying vec3 world_Position; \n        #endif\n\n      \n        uniform vec4 clipRect;\n     \n\n        float linearStep( float start, float end, float value ) {\n\n            return clamp( (value - start) / (end - start), 0.0, 1.0 );\n        }\n\n        vec2 getSamplerCoord( vec3 direction ) \n        {\n            direction = normalize(direction);\n            float tx=atan(direction.x,direction.z)/(PI*2.0)+0.5;\n            float ty=acos(direction.y)/PI;\n\n            return vec2(tx,ty);\n        }\n\n        \n        #if defined(HasVideo)\n\n            #if (HasVideo == 8)\n            \n                float f42( float phi_undistorted )\n                {\n                    return  - 0.0497*phi_undistorted*phi_undistorted*phi_undistorted*phi_undistorted*phi_undistorted\n                            + 0.2548*phi_undistorted*phi_undistorted*phi_undistorted*phi_undistorted\n                            - 0.4303*phi_undistorted*phi_undistorted*phi_undistorted\n                            - 0.016 *phi_undistorted*phi_undistorted \n                            + 1.0068*phi_undistorted - 0.0004;\t\t \n                }\n\n                vec2 uv2CameraCoord( vec2 uv) \n                {\n                    vec2 coor;\n                    coor.x = (uv.x* parameters[0][0] - parameters[0][3]) / parameters[2][3];\n                    coor.y = (uv.y* parameters[1][0] - parameters[1][3]) / parameters[3][3];\n                    return coor;\n                }\n            \n                vec4 f44(sampler2D texture, vec2 dc)\n                {\n                \n                    float vm = parameters[0][0];\n                    float vb = parameters[1][0];\n                    float vy = parameters[2][0];\n                    float oh = parameters[3][0];\n\n                    float wa = parameters[0][1];\n                    float qa = parameters[1][1];\n                    float cx = parameters[2][1];\n                    float cy = parameters[3][1];\n            \n                    float tx = parameters[0][2];\n                    float ty = parameters[1][2];\n                    float tz = parameters[2][2];\n            \n                    //////////////////////////////////////////\n                    \n                    float focal_final = wa * 1000.0 / qa;\n            \n                    \n            \n                    float ptIn_x = dc.x * vy;\n                    float ptIn_y = (1.0 - dc.y) * oh;\n            \n                    float ptOut_x, ptOut_y;\n                    \n                    float size = vy > oh ? vy : oh;\n            \n                    float camx, camy;\n            \n                    camx = (ptIn_x - vy / 2.0) / size;\n                    camy = (ptIn_y - oh / 2.0) / size;\n            \n                    float lon, lat;\n            \n                    lon = camx * 2.0 * 3.1415926;\n                    lat = camy * 2.0 * 3.1415926;\n            \n                    float zq, zw, zr;\n            \n                    zq = 0.33 * tx + cos(lat) * sin(lon);\n                    zw = 0.33 * ty - sin(lat);\n                    zr = 0.33 * tz + cos(lat) * cos(lon);   \n            \n            \n                    float theta = atan(-zw, zq);\n            \n                    float al = atan( sqrt(zq * zq + zw * zw), zr);\n            \n                    float x12, x13;\n            \n                    float wea = f42(al);\n                    float r = focal_final * tan(wea);\n            \n                    x12 = cx + r * cos(theta);\n                    x13 = cy - r * sin(theta);\n            \n                    ptOut_x = x13 / vm;\n                    ptOut_y = x12 / vb;\n                    \n                    \n                    vec2 samplerCoord = vec2(ptOut_x, ptOut_y);\n\n                    #if VideoMapping == 1\n                        samplerCoord = uv2CameraCoord(samplerCoord);\n                    #endif\n            \n                    return texture2D(texture, samplerCoord);\n            \n                }\n\n                float smoothRect( vec4 clipRect, vec2 mixWidth, vec2 uv )\n                {\n                    float x = clipRect.x < clipRect.z ? \n                    \n                            step( clipRect.x, uv.x ) * linearStep( clipRect.x, clipRect.x + mixWidth.x, uv.x ) *\n                            step( uv.x, clipRect.z ) * linearStep( clipRect.z, clipRect.z - mixWidth.x, uv.x ):\n                            \n                            step( clipRect.x, uv.x ) * step( uv.x, 1.0 ) * linearStep( clipRect.x, clipRect.x + mixWidth.x, uv.x ) + \n                            step( 0.0, uv.x ) * step( uv.x, clipRect.z ) * linearStep( clipRect.z, clipRect.z - mixWidth.x, uv.x );\n                            \n                    \n                    float y = step( clipRect.y, uv.y ) * linearStep( clipRect.y, clipRect.y + mixWidth.y, uv.y )  // from\n                            * step( uv.y, clipRect.w ) * linearStep( clipRect.w, clipRect.w - mixWidth.y, uv.y ); // to \n                        \n                            \n                    return x * y;\n                }\n                \n                vec3 satEnhance( vec3 inputColor, float sat )\n                {\n                    float R = inputColor.r * 255.0;\n                    float G = inputColor.g * 255.0;\n                    float B = inputColor.b * 255.0;\n                    \n                    float Y = 0.257 * R + 0.564 * G + 0.098 * B + 16.0;\n                    float Cb = -0.148 * R - 0.291 * G + 0.439 * B + 128.0;\n                    float Cr = 0.439 * R - 0.368 * G - 0.071 * B + 128.0;\n\n                    Cr = sat * (Cr - 128.0) + 128.0;\n                    Cb = sat * (Cb - 128.0) + 128.0;   \n                    \n                    float newB = 1.164*(Y-16.0)+2.017*(Cb-128.0);\n                    float newR = 1.164*(Y-16.0)+1.596*(Cr-128.0);\n                    float newG = 1.164*(Y-16.0)-0.392*(Cb-128.0)-0.813*(Cr-128.0);\n                    \n                    newB /= 255.0;\n                    newR /= 255.0;\n                    newG /= 255.0;\n                    \n                    return vec3(newR, newG, newB); \n                }\n\n\n            #elif (HasVideo == 2)\n\n                float f42( float phi )\n                {\n                    return  (-2.08836240e-05) * pow(phi, 9.0)\n                            + (-2.20461427e-04)  * pow(phi, 8.0) \n                            + (-8.04183603e-03)  * pow(phi, 7.0) \n                            + (3.95783387e-02)  * pow(phi, 6.0)\n                            + (-6.51361598e-02)  * pow(phi, 5.0)\n                            + (3.16523167e-02)  * pow(phi, 4.0)\n                            + (-1.35220728e-02)  * pow(phi, 3.0) \n                            + (3.86472740e-03)  * pow(phi, 2.0)\n                            + (9.99717594e-01)  * pow(phi, 1.0) \n                            + (3.98472625e-06)  * pow(phi, 0.0);\t\t \n                }\n\n                vec2 uv2CameraCoord( vec2 uv) \n                {\n                    vec2 coor;\n                    coor.x = (uv.x* parameters[0][0] - parameters[0][3]) / parameters[2][3];\n                    coor.y = (uv.y* parameters[1][0] - parameters[1][3]) / parameters[3][3];\n                    return coor;\n                }\n            \n                vec4 f44(sampler2D texture, vec2 dc)\n                {\n                \n                    float iw = parameters[0][0];    //inputWidth\n                    float ih = parameters[1][0];    //inputHeight\n                    float ow = parameters[2][0];    //outputWidth\n                    float oh = parameters[3][0];    //outputHeight\n\n                    float wa = parameters[0][1]; //focal\n                    float qa = parameters[1][1]; //pixel\n                    float cx = parameters[2][1]; //cx\n                    float cy = parameters[3][1]; //cy\n            \n                    float tx = parameters[0][2];\n                    float ty = parameters[1][2];\n                    float tz = parameters[2][2];\n            \n                    //////////////////////////////////////////\n                    \n                    float focal_final = wa * 1000.0 / qa;\n            \n                    float ptIn_x = dc.x * ow;\n                    float ptIn_y = dc.y * oh;\n\n                    float ptOut_x, ptOut_y;\n                    \n                    float size = ow > oh ? ow : oh;\n\n                    float camx, camy;\n\n                    camx = (ptIn_x - ow / 2.0) / size;\n                    camy = (ptIn_y - oh / 2.0) / size;\n\n                    float lon, lat;\n\n                    lon = camx * 2.0 * 3.1415926;\n                    lat = -1.0 * camy * 2.0 * 3.1415926;\n\n                    float sphx, sphy, sphz;\n\n                    sphx = cos(lat) * sin(lon);\n                    sphy = -sin(lat);\n                    sphz = cos(lat) * cos(lon);\n\n                    float theta = atan(-sphy, sphx);\n\n                    float phi_undistorted = atan( sqrt(sphx * sphx + sphy * sphy), sphz);\n\n                    float phi_distorted = f42(phi_undistorted);\n                    float r             = focal_final * phi_distorted;\n\n                    float du = cx + r * cos(theta);\n                    float dv = cy - r * sin(theta);\n            \n                    ptOut_x = (du - 508.0) / 1984.0;\n                    ptOut_y = 1.0 - (dv - 508.0) / 1984.0;\n                    \n                    vec2 samplerCoord = vec2(ptOut_x, ptOut_y);\n                    \n    \n                    return texture2D(texture, samplerCoord);\n            \n                }\n\n            #elif (HasVideo == 3)\n            \n                float f42( float phi )\n                {\n                    return  (-1.47485770e-02) * pow(phi, 9.0)\n                        + (9.72111981e-02)  * pow(phi, 8.0) \n                        + (-2.48315153e-01)  * pow(phi, 7.0) \n                        + (3.20998529e-01)  * pow(phi, 6.0)\n                        + (-2.46321067e-01)  * pow(phi, 5.0)\n                        + (9.53838280e-02)  * pow(phi, 4.0)\n                        + (-4.29416319e-02)  * pow(phi, 3.0) \n                        + (1.84551397e-03)  * pow(phi, 2.0)\n                        + (9.99948738e-01)  * pow(phi, 1.0) \n                        + (5.00118946e-07)  * pow(phi, 0.0);;\t\t \n                }\n\n                vec2 uv2CameraCoord( vec2 uv) \n                {\n                    vec2 coor;\n                    coor.x = (uv.x* parameters[0][0] - parameters[0][3]) / parameters[2][3];\n                    coor.y = (uv.y* parameters[1][0] - parameters[1][3]) / parameters[3][3];\n                    return coor;\n                }\n            \n                vec4 f44(sampler2D texture, vec2 dc)\n                {\n                \n                    float vm = parameters[0][0];\n                    float vb = parameters[1][0];\n                    float vy = parameters[2][0];\n                    float oh = parameters[3][0];\n\n                    float wa = parameters[0][1];\n                    float qa = parameters[1][1];\n                    float cx = parameters[2][1];\n                    float cy = parameters[3][1];\n            \n                    float tx = parameters[0][2];\n                    float ty = parameters[1][2];\n                    float tz = parameters[2][2];\n            \n                    //////////////////////////////////////////\n                    \n                    float focal_final = wa;\n            \n                    float ptIn_x = dc.x * vy;\n                    float ptIn_y = (1.0 - dc.y) * oh;\n            \n                    float ptOut_x, ptOut_y;\n                    \n                    float size = vy > oh ? vy : oh;\n            \n                    float camx, camy;\n            \n                    camx = (ptIn_x - vy / 2.0) / size;\n                    camy = (ptIn_y - oh / 2.0) / size;\n            \n                    float lon, lat;\n            \n                    lon = camx * 2.0 * 3.1415926;\n                    lat = camy * 2.0 * 3.1415926;\n            \n                    float sphx, sphy, sphz;\n                \n                    sphx =  cos(lat) * sin(lon);\n                    sphy =  - sin(lat);\n                    sphz =  cos(lat) * cos(lon);   \n\n                    ///////////////////////////////////////////\n                    //apply rz to video stitch\n\n                    float r00 = cos(tz);\n                    float r01 = -1.0 * sin(tz);\n                    float r02 = 0.0;\n\n                    float r10 = sin(tz);\n                    float r11 = cos(tz);\n                    float r12 = 0.0;\n\n                    float r20 = 0.0;\n                    float r21 = 0.0;\n                    float r22 = 1.0;\n\n                    float zq, zw, zr;\n\n                    zq = r00*sphx + r01*sphy + r02*sphz;\n                    zw = r10*sphx + r11*sphy + r12*sphz;\n                    zr = r20*sphx + r21*sphy + r22*sphz;\n\n                    ///////////////////////////////////////////\n                    float theta = atan(-zw, zq);\n            \n                    float al = atan( sqrt(zq * zq + zw * zw), zr);\n            \n                    float x12, x13;\n            \n                    float wea = f42(al);\n                    float r = focal_final * (wea);\n            \n                    x12 = cx + r * cos(theta);\n                    x13 = cy - r * sin(theta);\n            \n                    ptOut_x = x13 / vm;\n                    ptOut_y = x12 / vb;\n                    \n                    \n                    vec2 samplerCoord = vec2(ptOut_x, ptOut_y);\n\n                    #if VideoMapping == 1\n                        samplerCoord = uv2CameraCoord(samplerCoord);\n                    #endif\n                    \n                    samplerCoord.x = 1.0 - samplerCoord.x;\n                    samplerCoord.y = 1.0 - samplerCoord.y;\n\n                    return texture2D(texture, samplerCoord);\n                }\n\n                float smoothRect( vec4 clipRect, vec2 mixWidth, vec2 uv )\n                {\n                    float x = clipRect.x < clipRect.z ? \n                    \n                            step( clipRect.x, uv.x ) * linearStep( clipRect.x, clipRect.x + mixWidth.x, uv.x ) *\n                            step( uv.x, clipRect.z ) * linearStep( clipRect.z, clipRect.z - mixWidth.x, uv.x ):\n                            \n                            step( clipRect.x, uv.x ) * step( uv.x, 1.0 ) * linearStep( clipRect.x, clipRect.x + mixWidth.x, uv.x ) + \n                            step( 0.0, uv.x ) * step( uv.x, clipRect.z ) * linearStep( clipRect.z, clipRect.z - mixWidth.x, uv.x );\n                            \n                    \n                    float y = step( clipRect.y, uv.y ) * linearStep( clipRect.y, clipRect.y + mixWidth.y, uv.y )  // from\n                            * step( uv.y, clipRect.w ) * linearStep( clipRect.w, clipRect.w - mixWidth.y, uv.y ); // to \n                        \n                            \n                    return x * y;\n                }\n\n                vec3 satEnhance( vec3 inputColor, float sat )\n                {\n                    float R = inputColor.r * 255.0;\n                    float G = inputColor.g * 255.0;\n                    float B = inputColor.b * 255.0;\n                    \n                    float Y = 0.257 * R + 0.564 * G + 0.098 * B + 16.0;\n                    float Cb = -0.148 * R - 0.291 * G + 0.439 * B + 128.0;\n                    float Cr = 0.439 * R - 0.368 * G - 0.071 * B + 128.0;\n\n                    Cr = sat * (Cr - 128.0) + 128.0;\n                    Cb = sat * (Cb - 128.0) + 128.0;   \n                    \n                    float newB = 1.164*(Y-16.0)+2.017*(Cb-128.0);\n                    float newR = 1.164*(Y-16.0)+1.596*(Cr-128.0);\n                    float newG = 1.164*(Y-16.0)-0.392*(Cb-128.0)-0.813*(Cr-128.0);\n                    \n                    newB /= 255.0;\n                    newR /= 255.0;\n                    newG /= 255.0;\n                    \n                    return vec3(newR, newG, newB); \n                }\n\n                vec3 conAdjust( vec3 inputColor, float alpha )\n                {\n                    float R = inputColor.r * 255.0;\n                    float G = inputColor.g * 255.0;\n                    float B = inputColor.b * 255.0;\n\n                    float newB = alpha * (B - 0.5) + 0.5;\n                    float newG = alpha * (G - 0.5) + 0.5;\n                    float newR = alpha * (R - 0.5) + 0.5;\n\n                    newB /= 255.0;\n                    newR /= 255.0;\n                    newG /= 255.0;\n\n                    return vec3(newR, newG, newB); \n                }\n\n\n            #endif\n\n                \n\n        #endif\n\n\n        #if defined(RepeatUV) \n            float getUV(float num, float cellSize, float mul){ \n                float index = floor(num / cellSize);  //第index隔间\n                float start = index * cellSize;  //区间起始\n                float delta = num - start;    //相比起始的增量\n                float delta_mul = delta * mul;  //放大后的增量 \n                delta_mul = delta_mul - cellSize * floor(delta_mul / cellSize);    //求余。 最终需要的增加量，但是不能超过该区间，所以多出来的要缩减，repeat\n                \n                return start + delta_mul;\n            }\n            float round(float num){\n                float intPart = floor(num);\n                if(num - intPart < 0.5)return intPart;\n                else return intPart+1.0;\n            }  \n        #endif\n        \n    \n        void main()\n        {\n            \n            \n            \n            #if (defined(Not_Cube) || defined(HasVideo)) \n                vec2 samplerCoord0 = getSamplerCoord(vWorldPosition0.xyz);\n                vec2 samplerCoord1 = getSamplerCoord(vWorldPosition1.xyz);\n            #endif\n            \n            \n            vec4 color;\n            \n            #if defined(Not_Cube)\n                vec4 colorFromPano0=texture2D(pano0Map,samplerCoord0);\n                vec4 colorFromPano1=texture2D(pano1Map,samplerCoord1);\n            #else\n                vec4 colorFromPano0=textureCube(pano0Map,vWorldPosition0.xyz);\n                vec4 colorFromPano1=textureCube(pano1Map,vWorldPosition1.xyz);\n                #ifdef HasVideo\n                    samplerCoord0.x -= 0.25;    //全景图和Cube的水平采样起始坐标相差90度，这里矫正 0.25 个采样偏移\n                    samplerCoord1.x -= 0.25;    //全景图和Cube的水平采样起始坐标相差90度，这里矫正 0.25 个采样偏移\n                #endif\n            #endif\n\n            // #ifdef HasVideo\n            //     colorFromPano0 /= exposure;\n            //     colorFromPano1 /= exposure;\n            // #endif\n        \n\n            if(blackout==0)\n            {\n                color=mix(colorFromPano0,colorFromPano1,progress);\n            }\n            else if(blackout==1)\n            {\n                color=mix(colorFromPano0,BLACK,min(1.0,progress*2.0));\n                color=mix(color,colorFromPano1,max(0.0,progress*2.0-1.0));\n            }\n            else if(blackout==2)\n            {\n                color=mix(colorFromPano0,BLACK,progress);\n            }\n            else if(blackout==3)\n            {\n                color=mix(BLACK,colorFromPano1,max(0.0,progress*2.0-1.0));\n            }\n            \n        \n        \n        \n        \n        \n            vec2 uv = vUv;\n            \n            #if defined(RepeatUV) \n                  \n                vec4 infoColor = texture2D(repeatInfoMap, vUv);  \n                float mul = round(infoColor.r * 255.0 / 5.0)   +   round(infoColor.g * 255.0 / 5.0) / 10.0; \n          \n                if(mul>0.0 && mul != 1.0){\n                    float cellCount = 8.0;  \n                    \n                    float cellSize = 1.0 / cellCount;\n                    float dir = round(infoColor.b * 255.0 / 5.0);\n                    if (dir == 0.0) {\n                        uv.x = getUV(uv.x, cellSize, mul) ;\n                    }else if (dir == 1.0) {\n                        uv.y = getUV(uv.y, cellSize, mul) ; \n                    }else{\n                        uv.x = getUV(uv.x, cellSize, mul) ;\n                        uv.y = getUV(uv.y, cellSize, mul) ;\n                    } \n                }\n            \n            #endif\n         \n            vec4 colorFromTexture = texture2D(map,uv);\n            color = mix(color, colorFromTexture, modelAlpha); \n\n\n            #if defined(HasVideo)\n\n                vec4 colorFromVideo = vec4(0.0,0.0,0.0,0.0);\n               \n                \n               \n                #if HasVideo == 8\n\n                    colorFromVideo = f44(videoTexture, samplerCoord1);\n                    //colorFromVideo.rgb = satEnhance( colorFromVideo.rgb, 1.15 );\n                    colorFromVideo.rgb *= exposure;\n\n                    vec2 transitionSize = 80.0 / vec2( 4096.0, 2048.0 );\n\n                   \n                    #if VideoMapping == 0\n                        float alpha = linearStep(0.3, 0.33, samplerCoord1.x) * 1.0 - linearStep(0.66, 0.7, samplerCoord1.x);\n                        color = mix(color, colorFromVideo, alpha * float(videoReady));\n                    #elif VideoMapping == 1\n\n                   \n                        float rect = smoothRect( vec4(\n                            0.4166, 0.2833,\n                            0.5833, 0.7133\n                        ), vec2( blendFov / 360.0, blendFov / 180.0 ), samplerCoord1 );\n\n                        color = mix(color, colorFromVideo, rect * float(videoReady) * max(0.0,progress*2.0-1.0));\n                    \n                    #elif VideoMapping == 2\n\n                        samplerCoord1 = fract(samplerCoord1);\n\n                        vec2 clipUV = vec2(\n                            clipRect.x < clipRect.z ? linearStep( clipRect.x, clipRect.z, samplerCoord1.x ) : linearStep( clipRect.x, clipRect.z + 1.0, samplerCoord1.x < clipRect.z ? samplerCoord1.x + 1.0 : samplerCoord1.x ),\n                            linearStep( clipRect.y, clipRect.w, samplerCoord1.y )\n                        );\n                        clipUV.y = 1.0- clipUV.y;\n\n                        colorFromVideo = texture2D( videoTexture, clipUV );\n                        float rect = smoothRect( clipRect, vec2(0.02,0.02), samplerCoord1 );\n\n                      \n                        color = mix( color, colorFromVideo, rect * float(videoReady) * max(0.0,progress*2.0-1.0) );\n\n                    #endif\n\n                #elif HasVideo == 2\n\n                    colorFromVideo = f44(videoTexture, samplerCoord1);\n                    float alphaX = linearStep( 0.31, 0.33, samplerCoord1.x) * 1.0 - linearStep(0.65, 0.67, samplerCoord1.x);\n                    float alphaY = linearStep( 0.15, 0.17, 1.0 - samplerCoord1.y) * 1.0 - linearStep(0.82, 0.84, 1.0 - samplerCoord1.y);\n                    color = mix(color, colorFromVideo, alphaX * alphaY * float(videoReady) * max(0.0,progress*2.0-1.0));\t\n\n                #elif HasVideo == 3\n\n                    float cx = parameters[2][1]; //cx\n                    float cy = parameters[3][1]; //cy\n\n                    float diffx = (cx - 1824.0) / 16416.0;\n                    float diffy = (cy - 2736.0) / 7576.0;\n\n                    colorFromVideo = f44(videoTexture, samplerCoord1);\n                    //colorFromVideo.rgb = conAdjust( colorFromVideo.rgb, 1.1 );\n                    //colorFromVideo.rgb = satEnhance( colorFromVideo.rgb, 1.15 );\n                    colorFromVideo.rgb *= exposure;\n               \n\n                    vec2 transitionSize = 80.0 / vec2( 4096.0, 2048.0 );\n\n                   \n                    #if VideoMapping == 0\n                        float alpha = linearStep(0.3, 0.33, samplerCoord1.x) * 1.0 - linearStep(0.66, 0.7, samplerCoord1.x);\n                        color = mix(color, colorFromVideo, alpha * float(videoReady));\n                    #elif VideoMapping == 1\n                    \n                        float rect = smoothRect( vec4(\n                            0.4277-diffx, 0.28-diffy,\n                            0.572-diffx, 0.72-diffy\n                        ), vec2( blendFov / 360.0, blendFov / 180.0 ), samplerCoord1 );\n\n                        color =  mix(color, colorFromVideo, rect * float(videoReady) * max(0.0,progress*2.0-1.0));\n                    \n                    #elif VideoMapping == 2\n\n                        samplerCoord1 = fract(samplerCoord1);\n\n                        vec2 clipUV = vec2(\n                            clipRect.x < clipRect.z ? linearStep( clipRect.x, clipRect.z, samplerCoord1.x ) : linearStep( clipRect.x, clipRect.z + 1.0, samplerCoord1.x < clipRect.z ? samplerCoord1.x + 1.0 : samplerCoord1.x ),\n                            linearStep( clipRect.y, clipRect.w, samplerCoord1.y )\n                        );\n                        clipUV.y = 1.0- clipUV.y;\n\n                        colorFromVideo = texture2D( videoTexture, clipUV );\n\n                        \n                        float rect = smoothRect( clipRect, vec2(0.02,0.02), samplerCoord1 );\n\n                      \n                        color = mix( color, colorFromVideo, rect * float(videoReady) * max(0.0,progress*2.0-1.0) );\n\n                    #endif\n\n                #endif\n\n\n            #endif\n\n            float whiteness = 1.0-smoothstep(0.1, 1.0, opacity); \n            color = mix(color, GREY,  whiteness ); \n            \n            float opa = opacity;\n            #if defined(checkDistance)\n                vec3 cameraPos = mix(pano0Position, pano1Position, progress);\n                float dis = distance(cameraPos, world_Position);\n                float disOpa=minOpa;\n                if(dis < minDistance)\n                {\n                    disOpa=1.0;\n                }\n                else if(dis<maxDistance)\n                {\n                    float k=(minOpa-1.0)/(maxDistance-minDistance);\n                    disOpa=k*dis+1.0-k*minDistance;\n                }  \n                float whiteness2 = 1.0-smoothstep(0.1,0.2,disOpa);  \n                color = mix(color, GREY2,  whiteness2); \n                opa *= disOpa;\n                \n            #endif\n            \n   \n            //color.rgb = vec3( samplerCoord1, 0.0 );\n       \n            gl_FragColor = vec4(color.rgb,opa);\n\n\n           \n        }\n    "},xt={uniforms:{map:{type:"t",value:null},modelAlpha:{type:"f",value:He.modelAlpha},depthmapRatio:{type:"f",value:0},opacity:{type:"f",value:1},progress:{type:"f",value:0},considerOcclusion:{type:"i",value:He.fancierTransition},highlightPanoSelection:{type:"i",value:0},useThirdPano:{type:"i",value:He.useThirdPano},pano0Map:{type:"t",value:null},pano0Depth:{type:"t",value:null},pano0Position:{type:"v3",value:new THREE.Vector3},pano0Matrix:{type:"m4",value:new THREE.Matrix4},pano0Weight:{type:"f",value:He.transition.pano0Weight},pano1Map:{type:"t",value:null},pano1Depth:{type:"t",value:null},pano1Position:{type:"v3",value:new THREE.Vector3},pano1Matrix:{type:"m4",value:new THREE.Matrix4},pano1Weight:{type:"f",value:He.transition.pano1Weight},pano2Map:{type:"t",value:null},pano2Depth:{type:"t",value:null},pano2Position:{type:"v3",value:new THREE.Vector3},pano2Matrix:{type:"m4",value:new THREE.Matrix4},pano2Weight:{type:"f",value:He.transition.pano2Weight}},vertexShader:"uniform vec3 pano0Position;\nuniform mat4 pano0Matrix;\n\nuniform vec3 pano1Position;\nuniform mat4 pano1Matrix;\n\nuniform vec3 pano2Position;\nuniform mat4 pano2Matrix;\n\nvarying vec2 vUv;\nvarying vec3 vWorldPosition0;\nvarying vec3 vWorldPosition1;\nvarying vec3 vWorldPosition2;\n\nvarying vec4 worldPosition;\n\nvoid main() {\n\n  vUv = uv;\n  worldPosition = modelMatrix * vec4(position, 1.0);\n\n  vec3 positionLocalToPanoCenter0 = worldPosition.xyz - pano0Position;\n  vWorldPosition0 = (vec4(positionLocalToPanoCenter0, 1.0) * pano0Matrix).xyz;\n  vWorldPosition0.x *= -1.0;\n\n  vec3 positionLocalToPanoCenter1 = worldPosition.xyz - pano1Position;\n  vWorldPosition1 = (vec4(positionLocalToPanoCenter1, 1.0) * pano1Matrix).xyz;\n  vWorldPosition1.x *= -1.0;\n\n  vec3 positionLocalToPanoCenter2 = worldPosition.xyz - pano2Position;\n  vWorldPosition2 = (vec4(positionLocalToPanoCenter2, 2.0) * pano2Matrix).xyz;\n  vWorldPosition2.x *= -1.0;\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"uniform sampler2D map;\nuniform float depthmapRatio;\nuniform float modelAlpha;\nuniform float opacity;\nuniform float progress;\nuniform int considerOcclusion;\nuniform int highlightPanoSelection;\nuniform int useThirdPano;\n\nuniform vec3 pano0Position;\nuniform samplerCube pano0Map;\nuniform samplerCube pano0Depth;\nuniform float pano0Weight;\n\nuniform vec3 pano1Position;\nuniform samplerCube pano1Map;\nuniform samplerCube pano1Depth;\nuniform float pano1Weight;\n\nuniform vec3 pano2Position;\nuniform samplerCube pano2Map;\nuniform samplerCube pano2Depth;\nuniform float pano2Weight;\n\nvarying vec2 vUv;\nvarying vec3 vWorldPosition0;\nvarying vec3 vWorldPosition1;\nvarying vec3 vWorldPosition2;\n\nvarying vec4 worldPosition;\n\nvoid main() {\n\n  vec4 depthFromPano0 = textureCube( pano0Depth, vWorldPosition0.xyz );\n  vec4 depthFromPano1 = textureCube( pano1Depth, vWorldPosition1.xyz );\n  vec4 depthFromPano2 = textureCube( pano2Depth, vWorldPosition2.xyz );\n\n  vec4 colorFromPano0 = textureCube( pano0Map, vWorldPosition0.xyz );\n  vec4 colorFromPano1 = textureCube( pano1Map, vWorldPosition1.xyz );\n  vec4 colorFromPano2 = textureCube( pano2Map, vWorldPosition2.xyz );\n\n  float distanceToPano0 = distance(worldPosition.xyz, pano0Position);\n  float distanceToPano1 = distance(worldPosition.xyz, pano1Position);\n  float distanceToPano2 = distance(worldPosition.xyz, pano2Position);\n\n  float cameraToPano0 = distance(cameraPosition.xyz, pano0Position);\n  float cameraToPano1 = distance(cameraPosition.xyz, pano1Position);\n  float cameraToPano2 = distance(cameraPosition.xyz, pano2Position);\n\n  float contributionFromPano0 = cameraToPano0 == 0.0 ? 1000.0 : pano0Weight / cameraToPano0;\n  float contributionFromPano1 = cameraToPano1 == 0.0 ? 1000.0 : pano1Weight / cameraToPano1;\n  float contributionFromPano2 = cameraToPano2 == 0.0 ? 1000.0 : pano2Weight / cameraToPano2;\n\n  contributionFromPano0 *= 1.0 / distanceToPano0;\n  contributionFromPano1 *= 1.0 / distanceToPano1;\n  contributionFromPano2 *= 1.0 / distanceToPano2;\n\n  if(considerOcclusion == 1) {\n    bool occludedFromPano0 = distanceToPano0 / 10.0 > 1.01 - depthFromPano0.x;\n    bool occludedFromPano1 = distanceToPano1 / 10.0 > 1.01 - depthFromPano1.x;\n    bool occludedFromPano2 = distanceToPano2 / 10.0 > 1.01 - depthFromPano2.x;\n\n    if(occludedFromPano0){contributionFromPano0 *= 0.1;}\n    if(occludedFromPano1){contributionFromPano1 *= 0.1;}\n    if(occludedFromPano2){contributionFromPano2 *= 0.1;}\n    //if(occludedFromPano0 && occludedFromPano1 && !occludedFromPano2) { contributionFromPano2 += 0.5; }\n  }\n\n  float contributionSum = contributionFromPano0 + contributionFromPano1 + contributionFromPano2;\n  contributionFromPano0 /= contributionSum;\n  contributionFromPano1 /= contributionSum;\n  contributionFromPano2 /= contributionSum;\n\n  vec4 colorFromPanos = colorFromPano0 * contributionFromPano0;\n  colorFromPanos += colorFromPano1 * contributionFromPano1;\n  colorFromPanos += colorFromPano2 * contributionFromPano2;\n\n  vec4 depthFromPanos = depthFromPano0 * contributionFromPano0;\n  depthFromPanos += depthFromPano1 * contributionFromPano1;\n  depthFromPanos += depthFromPano2 * contributionFromPano2;\n\n  vec4 colorFromTexture = texture2D( map, vUv );\n  colorFromPanos = mix(colorFromPanos, colorFromTexture, modelAlpha);\n\n  if(highlightPanoSelection == 1) {\n    colorFromPanos.r = contributionFromPano0;\n    colorFromPanos.g = contributionFromPano1;\n    colorFromPanos.b = contributionFromPano2;\n  }\n\n  gl_FragColor = vec4(mix(colorFromPanos, depthFromPanos, depthmapRatio).rgb, opacity);\n\n}\n"},Tt={uniforms:{map:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:"varying vec2 vUv;\n\nvoid main() {\n\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"\n        uniform sampler2D map; uniform float opacity; varying vec2 vUv;\n              \n            vec4 grey = vec4(0.23, 0.23, 0.23, 1.0);    //cadImg greyArea to cover model,   base color\n             \n            void main() {\n                vec2 uv = vUv; \n                vec4 colorFromTexture = texture2D( map, uv );\n                float whiteness = 1.0 - smoothstep(0.1, 1.0, opacity); \n                colorFromTexture = mix(colorFromTexture, grey, whiteness );  \n                gl_FragColor = vec4(colorFromTexture.rgb, opacity); \n            }\n        "},Pt={uniforms:{map:{type:"t",value:null},opacity:{type:"f",value:1},color:{type:"c",value:new THREE.Color(He.path.color)}},vertexShader:"varying vec2 vUv;\nvarying vec3 vN;\nvarying vec4 vP;\n\nvoid main() {\n\n  vUv = uv;\n  vN= normalMatrix * normal;\n  vP = modelViewMatrix * vec4( position, 1.0 );\n  gl_Position = projectionMatrix * vP;\n}\n",fragmentShader:"uniform sampler2D map;\nuniform float opacity;\nvarying vec2 vUv;\nuniform vec3 color;\nvarying vec3 vN; // show-1182\nvarying vec4 vP; // show-1182\n\nvoid main() {\n\t// TODO add scroll-in and pulsing behaviors\n\tvec3 vNn = normalize(vN);\n\tvec3 vPn = normalize(vP.xyz);\n\tfloat f = pow(1.0-abs(dot(vNn,vPn)),0.2);\n  vec4 colorFromTexture = texture2D( map, vUv );\n  colorFromTexture.a *= f;\n  gl_FragColor = vec4((color.rgb*colorFromTexture.rgb),\n  \t\t\t\t\t\t(opacity*colorFromTexture.a));\n}\n"},kt={uniforms:{radius:{type:"f",value:0}},vertexShader:"varying vec4 worldPosition;\n\nvoid main() {\n\n  worldPosition = modelMatrix * vec4(position, 1.0);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}\n",fragmentShader:"varying vec4 worldPosition;\nuniform float radius;\n\nvoid main() {\n\n  vec4 topColor = vec4(0.094, 0.102, 0.11, 1.0);\n  vec4 bottomColor = vec4(0.2, 0.216, 0.235, 1.0);\n  float normalizedHeight = (worldPosition.y + radius) / (radius * 2.0);\n  float ratio = smoothstep(0.0, 0.5, normalizedHeight);\n  gl_FragColor = mix(bottomColor, topColor, ratio);\n\n}\n"},Mt={uniforms:{opacity:{type:"f",value:0},color:{type:"c",value:new THREE.Color},bg:{type:"t",value:null},mask:{type:"t",value:null}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"uniform float opacity;\nuniform vec3 color;\nuniform sampler2D bg;\nuniform sampler2D mask;\n\nvarying vec2 vUv;\n\nvoid main() {\n  vec4 maskColor = texture2D(mask, vUv);\n  vec4 bgColor = texture2D(bg, vUv);\n  vec3 mappedColor = mix(bgColor.rgb, color, maskColor.a);\n  gl_FragColor = vec4(mappedColor, bgColor.a * opacity);\n}\n"},Rt={uniforms:{uTime:{value:0},opacity:{value:1},dark:{type:"i",value:0},openning:{type:"f",value:0},uColor:{value:(new THREE.Color).setRGB(0,.7843137254901961,.6862745098039216)}},vertexShader:"\n\n        uniform float uTime;\n        uniform float openning;\n\n        varying vec2 vUv;\n        \n\n        vec3 scalePos( vec3 pos ) {\n\n            float s = 1.0 + 0.3 * abs( sin(uTime) ) ;\n\n            pos.x *= s;\n            pos.y *= s;\n            pos.z *= s;\n\n            return pos;\n        }\n\n        void main() \n        {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( scalePos( position ), 1.0);\n        }\n\n    ",fragmentShader:"\n    \n        uniform float uTime;\n        uniform vec3 uColor;\n        uniform float opacity;\n        uniform int dark;\n        \n        varying vec2 vUv;\n        \n        vec4 circle( vec2 position, vec2 center, float radius  )\n        {\n            vec4 backgroundColor = vec4( 0.0, 0.0, 0.0, 0.0 );\n\n            vec4 color = mix( backgroundColor, vec4(uColor, 1.0 ),  smoothstep( radius + 0.05, radius, length( position - center )) );\n            \n            return color;\n        }\n\n\n        vec4 ring( vec2 position, vec2 center, vec2 radius )\n        {\n        \n            float len = length( position - center );\n\n            float alpha = smoothstep( radius.x - 0.03, radius.x + 0.01, len) - smoothstep(radius.y - 0.03, radius.y + 0.03, len);\n\n            return mix( vec4( 0.0 ), vec4( 1.0 ), alpha);\n        }\n\n\n\n        void main() {\n\n\n            vec2 uv = vUv * 2.0 - 1.0;\n\n            //uv *= (0.85 + abs( sin(uTime) * 0.5 ));\n\n            \n            vec4 mainColor = vec4( 0.0 );\n            mainColor += circle( uv, vec2(0.0), 0.4 );\n            mainColor += ring( uv, vec2(0.0), vec2(0.3, 0.35));\n\n            \n            float r = (uv.x * uv.x + uv.y * uv.y) * 4.0;\n            \n            float intensity = sin( r - uTime * 2.5 );\n            float alpha = 1.0 - 0.25* r;\n\n            intensity = intensity * step(r, 3.5 ) * step(1.0, r);\t\n            intensity =  smoothstep( 0.9, 1.0, intensity );\n\n            mainColor += vec4( vec3(intensity), intensity * alpha);\n            \n            \n            \n            gl_FragColor = vec4(mainColor.rgb, mainColor.a * opacity);\n            \n        }\n    "},It={uniforms:{opacity:{type:"f",value:1},dark:{type:"i",value:0},map:{type:"t",value:null},uTime:{value:0},openning:{type:"f",value:0}},vertexShader:"\n\n        uniform float openning;\n        uniform float uTime;\n\n        varying vec2 vUv;\n\n        vec3 scalePos( vec3 pos ) {\n\n            float s = cos(openning * 3.1415926*0.28) * (1.0 + 0.3 * abs( sin(uTime)) * step( openning, 0.5 ) );\n\n            pos.x *= s;\n            pos.y *= s;\n            pos.z *= s;\n\n            return pos;\n        }\n\n        \n        \n        void main() \n        {\n            vUv = uv;\n\n            gl_Position = projectionMatrix * viewMatrix *  modelMatrix * vec4( scalePos(position), 1.0);\n        }\n    \n    ",fragmentShader:"\n\n        uniform float opacity;\n        uniform int dark;\n        uniform float uTime;\n        uniform sampler2D map;\n        uniform float openning;\n        \n        varying vec2 vUv;\n        \n\n        vec4 circle( vec2 position, vec2 center, float radius, vec4 color )\n        {\n            vec4 backgroundColor = vec4( 0.0 );\n            \n            float alpha =  smoothstep( radius + 0.03, radius - 0.03,  length( position - center ));\n\n            return mix( backgroundColor, color,  alpha );\n        }\n\n        vec4 ring( vec2 position, vec2 center, vec2 radius, vec4 color )\n        {\n            vec4 backgroundColor = vec4( 0.0, 0.0, 0.0, 0.0);\n                \n            float len = length( position - center );\n            \n            float alpha = smoothstep( radius.x - 0.03, radius.x + 0.03, len) - smoothstep(radius.y - 0.03, radius.y + 0.03, len);\n            \n            return mix( backgroundColor, color, alpha);\n        }\n\n        void main() {\n\n            vec2 uv = vUv;\n\n            vec4 color = texture2D(map, uv);\n            \n            if(dark == 1  && (color.r + color.g + color.b < 240.0*3.0/255.0))\n            {\n                color.rgb *= 0.9;\n            }\n\n\n            vec2 coord = uv * 2.0 - 1.0;\n            vec4 opennedColor = vec4(0.0);\n\n            opennedColor += circle( coord, vec2(0.0), 0.25, vec4(1.0, 1.0, 1.0, 0.5) );\n            opennedColor += circle( coord, vec2(0.0), 0.5, vec4(1.0, 1.0, 1.0, 0.3) );\n\n            color = mix( color, opennedColor, openning );\n            \n            gl_FragColor = vec4(color.rgb, color.a * opacity);\n        }\n\n    "},St={uniforms:{opacity:{type:"f",value:1},dark:{type:"i",value:0},map:{type:"t",value:null},uTime:{value:0},openning:{type:"f",value:0}},vertexShader:"\n\n        uniform float openning;\n        uniform float uTime;\n\n        varying vec2 vUv;\n\n        \n        \n        void main() \n        {\n            vUv = uv;\n\n            gl_Position = projectionMatrix * viewMatrix *  modelMatrix * vec4(position, 1.0);\n        }\n    \n    ",fragmentShader:"\n\n        uniform float opacity;\n        uniform int dark;\n        uniform float uTime;\n        uniform sampler2D map;\n        uniform float openning;\n        \n        varying vec2 vUv;\n        \n\n        vec4 circle( vec2 position, vec2 center, float radius, vec4 color )\n        {\n            vec4 backgroundColor = vec4( 0.0 );\n            \n            float alpha =  smoothstep( radius + 0.03, radius - 0.03,  length( position - center ));\n\n            return mix( backgroundColor, color,  alpha );\n        }\n\n        vec4 ring( vec2 position, vec2 center, vec2 radius, vec4 color )\n        {\n            vec4 backgroundColor = vec4( 0.0, 0.0, 0.0, 0.0);\n                \n            float len = length( position - center );\n            \n            float alpha = smoothstep( radius.x - 0.03, radius.x + 0.03, len) - smoothstep(radius.y - 0.03, radius.y + 0.03, len);\n            \n            return mix( backgroundColor, color, alpha);\n        }\n\n        void main() {\n\n            vec2 uv = vUv;\n\n            vec4 color = texture2D(map, uv);\n            \n            if(dark == 1  && (color.r + color.g + color.b < 240.0*3.0/255.0))\n            {\n                color.rgb *= 0.9;\n            }\n\n\n            vec2 coord = uv * 2.0 - 1.0;\n            vec4 opennedColor = vec4(0.0);\n\n            opennedColor += circle( coord, vec2(0.0), 0.25, vec4(1.0, 1.0, 1.0, 0.5) );\n            opennedColor += circle( coord, vec2(0.0), 0.5, vec4(1.0, 1.0, 1.0, 0.3) );\n\n            color = mix( color, opennedColor, openning );\n            \n            gl_FragColor = vec4(color.rgb, color.a * opacity);\n        }\n\n    "},Ct={uniforms:{map:{type:"t",value:null},opacity:{type:"f",value:1},pulse:{type:"f",value:1},nearFade:{type:"v2",value:new THREE.Vector2(2*He.insideNear,2*He.path.waypointIndoorRadius)},color:{type:"c",value:new THREE.Color(He.newBlue)}},vertexShader:"varying vec2 vUv;\nvarying vec4 vPointView;\n\nvoid main() {\n\n  vUv = uv;\n  vPointView = modelViewMatrix * vec4( position, 1.0 );\n  gl_Position = projectionMatrix * vPointView;\n\n}\n",fragmentShader:"uniform sampler2D map;\nuniform float opacity;\nuniform float pulse; // another opacity, with a different clock\nuniform vec2 nearFade;\nvarying vec2 vUv;\nvarying vec4 vPointView;\nuniform vec3 color;\n\nvoid main() {\n\t// TODO add scroll-in and pulsing behaviors\n\tfloat depthFade = min(1.0, (abs(vPointView.z)-nearFade.x)/(nearFade.y-nearFade.x));\n  vec4 colorFromTexture = texture2D( map, vUv );\t\t// we only use the alpha!\n  gl_FragColor = vec4(color.rgb,\n  \t\t\t\t\t\t(pulse*opacity*colorFromTexture.a * depthFade));\n}\n"},At={uniforms:{opacity:{type:"f",value:1},pano1Map:{type:"t",value:null},pano1Matrix:{type:"m4",value:new THREE.Matrix4}},vertexShader:"uniform mat4 pano1Matrix;varying vec3 vWorldPosition;void main(){vWorldPosition=(vec4(position,1.0)*pano1Matrix).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",fragmentShader:"uniform float opacity;varying vec3 vWorldPosition;\n#define PI 3.141592653 \n\n#if defined(Not_Cube)\nuniform sampler2D pano1Map;vec4 texCubemapWith2D(sampler2D t,vec3 dir){dir=normalize(dir);float tx=atan(dir.x,dir.z)/(PI*2.0)+0.5;float ty=acos(dir.y)/PI;vec4 color=texture2D(t,vec2(tx,ty));return color;}\n#else\nuniform samplerCube pano1Map;\n#endif\nvoid main(){\n#if defined(Not_Cube)\nvec4 colorFromPanos=texCubemapWith2D(pano1Map,vec3(-1.0*vWorldPosition.x,vWorldPosition.yz));\n#else\nvec4 colorFromPanos=textureCube(pano1Map,vec3(-1.0*vWorldPosition.x,vWorldPosition.yz));\n#endif\ngl_FragColor=vec4(colorFromPanos.rgb,opacity);}"},Dt={uniforms:{uColor:{type:"vec4",value:null},uTime:{type:"f",value:0}},vertexShader:"\n    \n        varying vec2 vUv;\n         \n        void main() \n        {\n            vUv = uv;\n            \n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n\n    ",fragmentShader:"\n    \n        #define PI2 6.2831852    \n\n        uniform vec4 uColor;\n        uniform float uTime;\n\n        varying vec2 vUv;\n\n        float lerp( float a, float b, float alpha ) \n        {\n            return a + (b -a ) * alpha;\n        }\n\n        vec4 ring( vec2 uv, vec2 radius )\n        {\n            float len = length( uv );\n            float angle = atan( uv.y, uv.x );\n            float opacity = 0.7;\n            \n            float progress = fract( uTime / 4000.0 );\n\n            float step1 = step( 0.0, progress );\n            float step2 = step( 0.25, progress );\n            float step3 = step( 0.75, progress );\n\n            float progressStep1 = smoothstep( 0.0, 0.25, progress );\n            float progressStep2 = smoothstep( 0.25, 1.0, progress );\n           \n            radius *= progressStep1 * step1;\n            opacity *= (1.0 - smoothstep( 0.7, 1.0, progress ));\n\n            float alpha =  smoothstep( radius.x - 0.01, radius.x, len ) - smoothstep( radius.y, radius.y + 0.01, len );\n            \n            float speed = step2 * ( progressStep2 * 20.0 );\n\n            float period = floor(30.0 - 29.0 * progressStep2);\n                \n            float interval = lerp( 0.0, 0.012, 1.0- progressStep2 );\n        \n            float dashed = smoothstep( interval * period, interval * period, fract( period * angle / PI2  + speed ) )\n                        - smoothstep( 1.0 - interval * period, 1.0 - interval * period , fract( period * angle / PI2 + speed ) );\n            \n            alpha *= dashed;\n                \n            return mix( vec4(0.0), vec4(1.0, 1.0, 1.0, opacity), alpha );\n        }\n\n\n        void main()\n        {\n\n            vec2 uv = vUv * 2.0 - 1.0;\n\n            vec4 mainColor = vec4(0);\n\n            mainColor += ring(uv, vec2(0.2, 0.22));\t\t\n             \n            gl_FragColor = mainColor;\n        }\n    "},Lt={uniforms:{opacity:{type:"f",value:1},dark:{type:"i",value:0},map:{type:"t",value:null},position:{value:new THREE.Vector3(0,0,0)}},vertexShader:"\n\n        varying vec2 vUv;\n\n\n        void main() \n        {\n            vUv = uv;\n\n            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0);\n\n            vec2 scale;\n            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n            scale *= mvPosition.z * 0.5;\n\n            vec2 alignedPosition = position.xy * scale;\n\n            mvPosition.xy += alignedPosition;\n\n            gl_Position = projectionMatrix *  mvPosition;\n\n        }\n    ",fragmentShader:"\n    \n        uniform float opacity;\n        uniform int dark;\n        uniform sampler2D map;\n        \n        \n        varying vec2 vUv;\n        \n        void main()\n        {\n\n            vec4 color = texture2D(map, vUv); \n\n            if( dark == 1 && (color.r + color.g + color.b < 240.0*3.0/255.0))\n            {\n                color.rgb *= 0.9;\n            } \n\n            gl_FragColor = vec4(color.rgb, color.a * opacity);\n        }\n        \n    "},zt={uniforms:{progress:{type:"f",value:0},map0:{type:"t",value:null},map1:{type:"t",value:null},map2:{type:"t",value:null},opacity:{type:"f",value:0}},vertexShader:"\n        uniform float progress;\n        varying vec2 vUv0; varying vec2 vUv1; varying vec2 vUv2;\n         vec2 Scale(vec2 vuv, float scale){\n            scale = 1.0/scale; \n             vuv.x=(uv.x-0.5) * scale + 0.5;  \n                vuv.y=(uv.y-0.5) * scale + 0.5 ;               \n               return vuv   ;       \t\t\t\t\t \t\t\n         }\t\n\n         void main(){\n             float baseScale =  0.78;\n             float s1 = 1.0; float s2 = 1.28;\n            float scale1 = progress * (s2 - s1) + s1;\n            vUv1 = Scale(uv, scale1 * baseScale);\n            float scale2;\n            if(progress < 0.5){\n                float s1 = 1.0; float s2 = 1.16; \n                scale2 = 2.0 * progress * (s2 - s1) + s1;\n            }else{\n                float s1 = 1.16; float s2 = 1.27;\n                scale2 = 2.0 *(progress - 0.5) * (s2 - s1) + s1;\n            }\n            \n            vUv2 = Scale(uv, scale2 * baseScale);\n             vUv0 = Scale(uv, baseScale);\n\n             gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\n\n        }\n\n    ",fragmentShader:"\n        uniform sampler2D map0;uniform sampler2D map1; uniform sampler2D map2;\n        uniform float opacity;\n        uniform float progress;\n        vec4 noRepeat(sampler2D sampler, vec2 uv){\t\t\t\t\t \n              vec4 color;\n               if(uv.x<0.0)      \t  color = vec4(0.0, 0.0, 0.0, 0.0)                ;\n               else if(uv.x>1.0)       color = vec4(0.0, 0.0, 0.0, 0.0)                ;\n                else if(uv.y<0.0)       color = vec4(0.0, 0.0, 0.0, 0.0)                ;\n              else if(uv.y>1.0)       color = vec4(0.0, 0.0, 0.0, 0.0)                ;\t\n              else color = texture2D(sampler, uv);\n                return color         ;\t\t\n         }\n         vec4  mixColor(vec4 downColor,vec4  upColor){\n             return vec4(upColor.rgb * upColor.a + (1.0 - upColor.a) * downColor.rgb, upColor.a+downColor.a);//下层的分量通过上层的a来决定，暂时这么设置\n            //vec4 sum = downColor + upColor; \n            //if(sum.a == 0.0){\n            //\treturn sum;\n            //}\n            //float upPct = upColor.a / sum.a;\n            //float downPct = downColor.a / sum.a; \n            //return vec4(upColor.rgb * upPct + downColor.rgb * downPct , sum.a );\n         }\n         varying vec2 vUv0; varying vec2 vUv1; varying vec2 vUv2; \n         void main(){\n             float op1, op2;\n             if(progress<0.5){\n                 op1 = 0.49; \n                 op2 = 2.0 * progress * (0.48 - 1.0) + 1.0;\n             }else{\n                op1 = 2.0 * (progress - 0.5) * (0.0 - 0.49) + 0.49;\n                op2 = 2.0 * (progress - 0.5) * (0.0 - 0.48) + 0.48;\n             }\n\n             vec4 color0 = noRepeat(map0, vUv0);\n             vec4 color1 = noRepeat(map1, vUv1);\n             vec4 color2 = noRepeat(map2, vUv2);\n             color1.a *= op1;\n             color2.a *= op2;\n             \n            \n            #if defined(useColor2)    \n                gl_FragColor = mixColor(mixColor(color0 , color1), color2); //为什么苹果渲染的发黑//这样稍微柔和一些\n            #else\t\n                gl_FragColor = mixColor(mixColor(color2 , color0), color1 ); //这个叠放顺序也是试出来比较好的一种。color0基底由于外框部分都是0,0,0,0作为下层会被取一部分黑色，所以只能放上层，而内层的color1也要放上层，所以color2就是最下层。\n             #endif \n            gl_FragColor.a *= opacity;\n         }\n\n    "};function Vt(e){e.vertexShader&&(e.vertexShader="precision highp float;\nprecision highp int;\n\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\n"+e.vertexShader),e.fragmentShader&&(e.fragmentShader="precision highp float;\nprecision highp int;\n\nuniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n"+e.fragmentShader)}Vt(wt),Vt(bt),Vt(Et),Vt(xt),Vt(Tt),Vt(Pt),Vt(kt),Vt(Mt),Vt(Rt),Vt(It),Vt(St),Vt(Ct),Vt(At),Vt(Dt),Vt(Lt),Vt(zt);var Ht={cube:wt,customDepth:bt,model:Et,modelDebug:xt,modelOutside:Tt,ribbon:Pt,skysphere:kt,tagDisc:Mt,tagDiscDefault:Rt,tagDiscCustom:It,tagVideoMarker:St,waypoint:Ct,basicTextured:{uniforms:{tDiffuse:{type:"t",value:null},alpha:{type:"f",value:1}},vertexShader:"varying vec2 vUv;\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"varying vec2 vUv;\nuniform float alpha;\nuniform sampler2D tDiffuse;\nvoid main() {\n  vec4 texColor = texture2D(tDiffuse, vUv);\n  gl_FragColor = vec4(texColor.rgb, texColor.a * alpha);\n}"},copyCubeMap:{uniforms:{tDiffuse:{type:"t",value:null},alpha:{type:"f",value:1}},vertexShader:"varying vec3 vWorldPos;\nvoid main() {\n  vWorldPos = vec3(-position.x, -position.y, position.z);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:"varying vec3 vWorldPos;\nuniform float alpha;\nuniform samplerCube tDiffuse;\nvoid main() {\n  vec4 texColor = textureCube(tDiffuse, vWorldPos);\n  gl_FragColor = vec4(texColor.rgb, texColor.a * alpha);\n}"},skybox:At,videoLoading:Dt,videoMakerWidget:Lt,videoPanoMarker:zt},Ot=function(e,t){return function(){for(var n=new Array(arguments.length),o=0;o<n.length;o++)n[o]=arguments[o];return e.apply(t,n)}},Ft=Object.prototype.toString;function Nt(e){return"[object Array]"===Ft.call(e)}function Bt(e){return void 0===e}function jt(e){return null!==e&&"object"==typeof e}function Ut(e){if("[object Object]"!==Ft.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function _t(e){return"[object Function]"===Ft.call(e)}function Wt(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),Nt(e))for(var n=0,o=e.length;n<o;n++)t.call(null,e[n],n,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}var Zt={isArray:Nt,isArrayBuffer:function(e){return"[object ArrayBuffer]"===Ft.call(e)},isBuffer:function(e){return null!==e&&!Bt(e)&&null!==e.constructor&&!Bt(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:jt,isPlainObject:Ut,isUndefined:Bt,isDate:function(e){return"[object Date]"===Ft.call(e)},isFile:function(e){return"[object File]"===Ft.call(e)},isBlob:function(e){return"[object Blob]"===Ft.call(e)},isFunction:_t,isStream:function(e){return jt(e)&&_t(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:Wt,merge:function e(){var t={};function n(n,o){Ut(t[o])&&Ut(n)?t[o]=e(t[o],n):Ut(n)?t[o]=e({},n):Nt(n)?t[o]=n.slice():t[o]=n}for(var o=0,i=arguments.length;o<i;o++)Wt(arguments[o],n);return t},extend:function(e,t,n){return Wt(t,(function(t,o){e[o]=n&&"function"==typeof t?Ot(t,n):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}};function Qt(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Gt=function(e,t,n){if(!t)return e;var o;if(n)o=n(t);else if(Zt.isURLSearchParams(t))o=t.toString();else{var i=[];Zt.forEach(t,(function(e,t){null!=e&&(Zt.isArray(e)?t+="[]":e=[e],Zt.forEach(e,(function(e){Zt.isDate(e)?e=e.toISOString():Zt.isObject(e)&&(e=JSON.stringify(e)),i.push(Qt(t)+"="+Qt(e))})))})),o=i.join("&")}if(o){var r=e.indexOf("#");-1!==r&&(e=e.slice(0,r)),e+=(-1===e.indexOf("?")?"?":"&")+o}return e};function qt(){this.handlers=[]}qt.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},qt.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},qt.prototype.forEach=function(e){Zt.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var Yt=qt,$t=function(e,t,n){return Zt.forEach(n,(function(n){e=n(e,t)})),e},Xt=function(e){return!(!e||!e.__CANCEL__)},Jt=function(e,t){Zt.forEach(e,(function(n,o){o!==t&&o.toUpperCase()===t.toUpperCase()&&(e[t]=n,delete e[o])}))},Kt=function(e,t,n,o,i){return function(e,t,n,o,i){return e.config=t,n&&(e.code=n),e.request=o,e.response=i,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,n,o,i)},en=Zt.isStandardBrowserEnv()?{write:function(e,t,n,o,i,r){var a=[];a.push(e+"="+encodeURIComponent(t)),Zt.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),Zt.isString(o)&&a.push("path="+o),Zt.isString(i)&&a.push("domain="+i),!0===r&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},tn=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],nn=Zt.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");function o(e){var o=e;return t&&(n.setAttribute("href",o),o=n.href),n.setAttribute("href",o),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}return e=o(window.location.href),function(t){var n=Zt.isString(t)?o(t):t;return n.protocol===e.protocol&&n.host===e.host}}():function(){return!0},on=function(e){return new Promise((function(t,n){var o=e.data,i=e.headers;Zt.isFormData(o)&&delete i["Content-Type"];var r=new XMLHttpRequest;if(e.auth){var a=e.auth.username||"",s=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";i.Authorization="Basic "+btoa(a+":"+s)}var l=function(e,t){return e&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(t)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}(e.baseURL,e.url);if(r.open(e.method.toUpperCase(),Gt(l,e.params,e.paramsSerializer),!0),r.timeout=e.timeout,r.onreadystatechange=function(){if(r&&4===r.readyState&&(0!==r.status||r.responseURL&&0===r.responseURL.indexOf("file:"))){var o,i,a,s,l,c="getAllResponseHeaders"in r?(o=r.getAllResponseHeaders(),l={},o?(Zt.forEach(o.split("\n"),(function(e){if(s=e.indexOf(":"),i=Zt.trim(e.substr(0,s)).toLowerCase(),a=Zt.trim(e.substr(s+1)),i){if(l[i]&&tn.indexOf(i)>=0)return;l[i]="set-cookie"===i?(l[i]?l[i]:[]).concat([a]):l[i]?l[i]+", "+a:a}})),l):l):null,u={data:e.responseType&&"text"!==e.responseType?r.response:r.responseText,status:r.status,statusText:r.statusText,headers:c,config:e,request:r};!function(e,t,n){var o=n.config.validateStatus;n.status&&o&&!o(n.status)?t(Kt("Request failed with status code "+n.status,n.config,null,n.request,n)):e(n)}(t,n,u),r=null}},r.onabort=function(){r&&(n(Kt("Request aborted",e,"ECONNABORTED",r)),r=null)},r.onerror=function(){n(Kt("Network Error",e,null,r)),r=null},r.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),n(Kt(t,e,"ECONNABORTED",r)),r=null},Zt.isStandardBrowserEnv()){var c=(e.withCredentials||nn(l))&&e.xsrfCookieName?en.read(e.xsrfCookieName):void 0;c&&(i[e.xsrfHeaderName]=c)}if("setRequestHeader"in r&&Zt.forEach(i,(function(e,t){void 0===o&&"content-type"===t.toLowerCase()?delete i[t]:r.setRequestHeader(t,e)})),Zt.isUndefined(e.withCredentials)||(r.withCredentials=!!e.withCredentials),e.responseType)try{r.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&r.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&r.upload&&r.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){r&&(r.abort(),n(e),r=null)})),o||(o=null),r.send(o)}))},rn={"Content-Type":"application/x-www-form-urlencoded"};function an(e,t){!Zt.isUndefined(e)&&Zt.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var sn,ln={adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(sn=on),sn),transformRequest:[function(e,t){return Jt(t,"Accept"),Jt(t,"Content-Type"),Zt.isFormData(e)||Zt.isArrayBuffer(e)||Zt.isBuffer(e)||Zt.isStream(e)||Zt.isFile(e)||Zt.isBlob(e)?e:Zt.isArrayBufferView(e)?e.buffer:Zt.isURLSearchParams(e)?(an(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):Zt.isObject(e)?(an(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(e){return e>=200&&e<300}};ln.headers={common:{Accept:"application/json, text/plain, */*"}},Zt.forEach(["delete","get","head"],(function(e){ln.headers[e]={}})),Zt.forEach(["post","put","patch"],(function(e){ln.headers[e]=Zt.merge(rn)}));var cn=ln;function un(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var hn=function(e){return un(e),e.headers=e.headers||{},e.data=$t(e.data,e.headers,e.transformRequest),e.headers=Zt.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),Zt.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||cn.adapter)(e).then((function(t){return un(e),t.data=$t(t.data,t.headers,e.transformResponse),t}),(function(t){return Xt(t)||(un(e),t&&t.response&&(t.response.data=$t(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},dn=function(e,t){t=t||{};var n={},o=["url","method","data"],i=["headers","auth","proxy","params"],r=["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","timeoutMessage","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","decompress","maxContentLength","maxBodyLength","maxRedirects","transport","httpAgent","httpsAgent","cancelToken","socketPath","responseEncoding"],a=["validateStatus"];function s(e,t){return Zt.isPlainObject(e)&&Zt.isPlainObject(t)?Zt.merge(e,t):Zt.isPlainObject(t)?Zt.merge({},t):Zt.isArray(t)?t.slice():t}function l(o){Zt.isUndefined(t[o])?Zt.isUndefined(e[o])||(n[o]=s(void 0,e[o])):n[o]=s(e[o],t[o])}Zt.forEach(o,(function(e){Zt.isUndefined(t[e])||(n[e]=s(void 0,t[e]))})),Zt.forEach(i,l),Zt.forEach(r,(function(o){Zt.isUndefined(t[o])?Zt.isUndefined(e[o])||(n[o]=s(void 0,e[o])):n[o]=s(void 0,t[o])})),Zt.forEach(a,(function(o){o in t?n[o]=s(e[o],t[o]):o in e&&(n[o]=s(void 0,e[o]))}));var c=o.concat(i).concat(r).concat(a),u=Object.keys(e).concat(Object.keys(t)).filter((function(e){return-1===c.indexOf(e)}));return Zt.forEach(u,l),n};function pn(e){this.defaults=e,this.interceptors={request:new Yt,response:new Yt}}pn.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=dn(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[hn,void 0],n=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)n=n.then(t.shift(),t.shift());return n},pn.prototype.getUri=function(e){return e=dn(this.defaults,e),Gt(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},Zt.forEach(["delete","get","head","options"],(function(e){pn.prototype[e]=function(t,n){return this.request(dn(n||{},{method:e,url:t,data:(n||{}).data}))}})),Zt.forEach(["post","put","patch"],(function(e){pn.prototype[e]=function(t,n,o){return this.request(dn(o||{},{method:e,url:t,data:n}))}}));var fn=pn;function mn(e){this.message=e}mn.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},mn.prototype.__CANCEL__=!0;var vn=mn;function gn(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var n=this;e((function(e){n.reason||(n.reason=new vn(e),t(n.reason))}))}gn.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},gn.source=function(){var e;return{token:new gn((function(t){e=t})),cancel:e}};var yn=gn;function wn(e){var t=new fn(e),n=Ot(fn.prototype.request,t);return Zt.extend(n,fn.prototype,t),Zt.extend(n,t),n}var bn=wn(cn);bn.Axios=fn,bn.create=function(e){return wn(dn(bn.defaults,e))},bn.Cancel=vn,bn.CancelToken=yn,bn.isCancel=Xt,bn.all=function(e){return Promise.all(e)},bn.spread=function(e){return function(t){return e.apply(null,t)}},bn.isAxiosError=function(e){return"object"==typeof e&&!0===e.isAxiosError};var En=bn,xn=bn;En.default=xn;var Tn=En,Pn=null;Promise.prototype.done=Promise.prototype.then,Promise.prototype.fail=Promise.prototype.catch,void 0===window.TextEncoder&&(window.TextEncoder=function(){function e(){i(this,e)}return u(e,[{key:"encode",value:function(e){return unescape(encodeURIComponent(e)).split("").map((function(e){return e.charCodeAt()}))}}]),e}(),window.TextDecoder=function(){function e(){i(this,e)}return u(e,[{key:"decode",value:function(e){return decodeURIComponent(escape(String.fromCharCode.apply(null,e)))}}]),e}());var kn=Tn.create({baseURL:W.server||""});kn.interceptors.request.use((function(e){return e.headers.token=Ce.valueFromUrl("token")||localStorage.getItem("token")||"",e}),(function(e){return Promise.reject(e)})),kn.interceptors.response.use((function(e){if(!/json/gi.test(e.headers["content-type"]))return e.data;if("arraybuffer"===e.request.responseType){var t=new TextDecoder("utf-8");return JSON.parse(t.decode(new Uint8Array(e.data)))}return Pn&&!1===e.data.success&&Pn.Scene.emit("error",{type:"network",code:e.data.code,message:e.data.message}),e.data}),(function(e){if(Pn){var t=null;t=e.response&&e.response.data?e.response.data:{code:500,message:e},Pn.Scene.emit("error",{type:"network",code:t.code,message:t.message})}return e.response&&e.response.data?Promise.reject(e.response):Promise.reject(e)}));var Mn={retry(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return new Promise((function(o,i){e().then(o).catch((function(r){t<=1?i(r):setTimeout((function(){Mn.retry(e,t-1,n).then(o).catch(i)}),n)}))}))},get:e=>kn.get(e),getImage(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;if("aws"==W.region&&-1!=e.indexOf("x-oss-process=image")){var n=e.split("?");e=n[0]+encodeURIComponent("?"+n[1].replace(/\//g,"@"))}return Mn.retry((function(){return new Promise((function(t,n){var o=new Image;o.crossOrigin="anonymous",o.src=e,o.onload=function(){t(o)},o.onerror=function(){n("[".concat(e,"] load fail"))}}))}),t)},getText:e=>kn.get(e,{responseType:"text"}),getBueffer:e=>kn.get(e,{responseType:"arraybuffer"}),getBlob:e=>kn.get(e,{responseType:"blob"}),post:(e,t)=>kn.post(e,t),postFile(e,t){var n=new FormData,o=null;for(var i in t.onUploadProgress&&(o=t.onUploadProgress,delete t.onUploadProgress),t)if("files"===i&&t[i].length>0)for(var r=0;r<t[i].length;r++){var a=t[i][r];a instanceof File?n.append(i,a):a.file?a.filename?n.append(i,a.file,a.filename):n.append(i,a.file):console.warn("file is wong !",t)}else"file"==i||"filename"===i?"file"==i&&(t.filename?n.append("file",t[i],t.filename):n.append("file",t[i])):n.append(i,t[i]);return kn.post(e,n,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:o})}};var Rn=oe(),In={data:{},load:function(e,t,n){var o=In.data[e];return o?(t&&setTimeout((function(){t(o)}),1),o):(o=new THREE.Texture,He.minimalMemoryMode&&(o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.generateMipmaps=!1),o.sourceFile=e,In.data[e]=o,Mn.getImage(e).then((function(e){o.image=e,o.needsUpdate=!0,t&&t(o)})).catch(n),o)},loadBase64:function(e,t){t=t||"png";var n=new THREE.Texture;return n.image=document.createElement("img"),n.image.setAttribute("src","data:image/"+t+";base64,"+e),He.minimalMemoryMode&&(n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.generateMipmaps=!1),n.needsUpdate=!0,n},isLoaded:function(e){return!!In.data[e]},getImageURL:function(e){return Rn+e}},Sn="zhiHouse"==W.applicationName?Ae.zhiBlue:Ae.lightGreen,Cn=null,An={createLine:function(e,t){var n=new THREE.BufferGeometry,o=new Float32Array(6);n.addAttribute("position",new THREE.BufferAttribute(o,3));o=n.attributes.position.array;for(var i=0;i<2;i++)o[3*i]=e[i].x,o[3*i+1]=e[i].y,o[3*i+2]=e[i].z;var r={linewidth:t.width||1,color:t.color||Sn,transparent:!t.dontAlwaysSeen,depthTest:!!t.dontAlwaysSeen},a=t.mat||t.deshed?new THREE.LineDashedMaterial(Object.assign(r,{dashSize:t.dashSize||.1,gapSize:t.dashSize||.1})):new THREE.LineBasicMaterial(r),s=new THREE.Line(n,a);return s.renderOrder=t.renderOrder||4,t.deshed&&s.computeLineDistances(),s},moveLine:function(e,t){for(var n=e.geometry.attributes.position.array,o=0;o<2;o++)null!=t[o]&&(n[3*o]=t[o].x,n[3*o+1]=t[o].y,n[3*o+2]=t[o].z);e.geometry.attributes.position.needsUpdate=!0,e.geometry.computeBoundingSphere()},createBoldLine:function(e,t,n){Cn=n;var o=(t=t||{})&&t.cylinder,i=e[1].clone().sub(e[0]),r=function(){o.lastVector=i;var e=new THREE.Vector3(0,-1,0),t=e.clone().cross(i).normalize(),n=e.angleTo(i);o.quaternion.setFromAxisAngle(t,n)};if(t&&"init"==t.type){if((o=new THREE.Mesh).material=t.mat,0==i.length())return o;r()}if(0==i.length())return o;if("update"!=t.type){var a=e[0].clone().add(e[1]).multiplyScalar(.5);o.position.copy(a),o.lastVector&&"moveAndRotate"!=t.type?o.lastVector&&i.angleTo(o.lastVector)>0&&r():r()}var s=e[0].distanceTo(e[1]),l=t&&t.standPos||Cn.position,c=W.isMobile?20:40,u=e[0].distanceTo(l),h=e[1].distanceTo(l),d=be.getFootPoint(l,e[0],e[1]);if(t.constantBold||"panorama"!=Cn.mode)var p=[new THREE.Vector2(.1,s/2),new THREE.Vector2(.1,-s/2)];else if(d.clone().sub(e[0]).dot(d.clone().sub(e[1]))>0)p=[new THREE.Vector2(u/c,s/2),new THREE.Vector2(h/c,-s/2)];else{var f=d.distanceTo(l),m=d.distanceTo(e[0]);p=[new THREE.Vector2(u/c,s/2),new THREE.Vector2(f/c,s/2-m),new THREE.Vector2(h/c,-s/2)]}return o.geometry&&o.geometry.dispose(),o.geometry=new THREE.LatheBufferGeometry(p,4),o.renderOrder=2,o},updateBoldLine:function(e,t,n,o,i){this.createBoldLine(t,{type:n,cylinder:e,standPos:o,constantBold:i},Cn)},createFatLineMat:function(e){var t={color:e.color||16777215,linewidth:e.width||5,transparent:!0,depthTest:!e.alwaysShow,polygonOffset:!0,polygonOffsetFactor:2.5*-e.width||-5,polygonOffsetUnits:-4};return e.dashed?new THREE.LineDashedMaterial(t):new THREE.LineBasicMaterial(t)},createFatLine:function(e,t){var n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e),3)),n.addAttribute("color",new THREE.BufferAttribute(new Float32Array(t.color||[1,1,1]),3));var o=t.material||this.createFatLineMat(t),i=new THREE.Line(n,o);return i.computeLineDistances(),i.scale.set(1,1,1),i.renderOrder=2,i},moveFatLine:function(e,t){e.geometry.setPositions(t)}};function Dn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Ln=new THREE.PlaneBufferGeometry(.4,.4,1,1),zn=In.load(In.getImageURL("images/play-64.png")),Vn=In.load(In.getImageURL("images/256-1.png")),Hn=In.load(In.getImageURL("images/256-3.png")),On=In.load(In.getImageURL("images/256-2.png")),Fn=null,Nn=[],Bn=function(e){f(n,THREE.Mesh);var t=Dn(n);function n(e){var o;i(this,n),(o=t.call(this)).pano=e,o.geometry=Ln,o.widget=null;var r=se.loadTextureFromCache(In.getImageURL("images/marker.png"));return o.material=new THREE.MeshBasicMaterial({map:r,side:THREE.DoubleSide,opacity:0,transparent:!0,depthWrite:!1,depthTest:!1}),o.renderOrder=Xe,o.name="marker",o.layers.set(ct),o.updateMatrixWorld(),He.colorMarkerOnLoad&&o.on("load",(function(){this.marker.material.color.set(65280)})),o}return u(n,[{key:"updateStyle",value:function(e,t,n){"normal"==e?this.material==Fn&&(this.material=this.normalMaterial,t.flagSpot=null):this.material!=Fn&&(Fn||(Fn=new Wn,_n()),this.normalMaterial=this.material,this.material=Fn,this.setWidget(e,t))}},{key:"setWidget",value:function(e,t){var n=new Zn(e,"flagSpot___"+t.id,{position:t.position.clone(),state:"videoPanoFlag",sid:"flagSpot___"+t.id,style:"videoMarker",pano:t});n.style="videoMarker",n.disc.material.uniforms.map.value=zn;n.createMarkLine({type:"flagSpot",stemLineLen:.5,markerPos:this.position}).marker=this,n.rePos(n.markLine.groundPoint.clone().add(new THREE.Vector3(0,.5,0))),Nn.push(n),t.flagSpot=n,this.material.depthTest=!1;var o=t.marker.visible;Object.defineProperty(t.marker,"visible",{get:function(){return o},set:function(e){t.flagSpot&&(e?t.flagSpot.show():t.flagSpot.hide()),o=e}})}}]),n}(),jn=[],Un=0;function _n(){for(var e=0;e<jn.length;e++)jn[e].uniforms.progress.value=Un;Nn.forEach((function(e){return e.update()})),Un>1&&(Un=0),Un+=.01,window.requestAnimationFrame(_n)}var Wn=function(e){f(n,THREE.RawShaderMaterial);var t=Dn(n);function n(){var e;i(this,n),e=t.call(this);var o=THREE.UniformsUtils.clone(Ht.videoPanoMarker.uniforms);return o.map0.value=Vn,o.map1.value=Hn,o.map2.value=On,o.opacity.value=1,e.vertexShader=Ht.videoPanoMarker.vertexShader,e.fragmentShader=Ht.videoPanoMarker.fragmentShader,e.uniforms=o,e.transparent=!0,Ce.detectIOS()&&(e.defines.useColor2=""),jn.push(h(e)),e}return n}(),Zn=function(e){f(n,EventEmitter);var t=Dn(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this)).model=e,a.sid=o,a.floor=null,a.floors=[],a.position=(new THREE.Vector3).copy(r.position),a.content={},a.initContent(r),a.snapInfo=r.snapInfo,a.style=r.style||"default",a.color=(new THREE.Color).setRGB(0,.7843137254901961,.6862745098039216),r.color&&a.color.setStyle(r.color),a.styleImageURL=r.styleImageURL,a.hoverColor=Ae._darken(a.content.color,.2),a.animTime=0,a.animated=!1,a.openning=0,a.openTransition=null,a.mode=Oe.PANORAMA,a.obj3d=null,a.disc=null,a.discWorldPosition=null,a.discScale=.06,a.floorIndex=r.floorIndex,a.visibleTransition=null,a.hoveringDisc=!1,a.state=r.state,a.videoPano=r.pano,a.build(),a}return u(n,[{key:"initContent",value:function(e){this.content.description=e.description,this.content.label=e.label,this.content.link=e.link,this.content.outLink=e.outLink,this.content.color=(new THREE.Color).set(e.color||Ae.tagDefault),this.content.fileName=e.fileName||{},this.content.fileSrc=e.fileSrc||{},this.content.media=e.media||[]}},{key:"getFloors",value:function(){var e=this;this.floors=[],this.visiblePanos&&this.visiblePanos.forEach((function(t){e.model.panos.index[t]&&(e.floors.includes(e.model.panos.index[t].floor)||e.floors.push(e.model.panos.index[t].floor))})),this.floor&&!this.floors.includes(this.floor)&&this.floors.push(this.floor)}},{key:"rePos",value:function(e){this.position.copy(e),this.obj3d.position.copy(e)}},{key:"createMarkLine",value:function(e){return this.markLine=new Qn({type:e.type,stemLineLen:e.stemLineLen,markerPos:e.markerPos,tag:this,model:this.model}),this.markLine}},{key:"build",value:function(){return this.floor=this.videoPano.floor,this.floorIndex=this.floor.floorIndex,this.floor&&(this.obj3d=this.buildObject3D(),this.floor.add(this.obj3d)),this.getFloors(),this}},{key:"buildObject3D",value:function(){var e=new THREE.Object3D;e.position.copy(this.position);var t=this.model.$app.config;"shop"==t.name||"grave"==t.name?(this.defaultStyleMaterial=new THREE.RawShaderMaterial({transparent:!0,vertexShader:Ht.tagDiscDefault2.vertexShader,fragmentShader:Ht.tagDiscDefault2.fragmentShader,uniforms:THREE.UniformsUtils.clone(Ht.tagDiscDefault2.uniforms),depthTest:!1}),this.customStyleMaterial=new THREE.RawShaderMaterial({transparent:!0,vertexShader:Ht.tagDiscCustom.vertexShader,fragmentShader:Ht.tagDiscCustom.fragmentShader,uniforms:THREE.UniformsUtils.clone(Ht.tagDiscCustom.uniforms),depthTest:!1})):(this.defaultStyleMaterial=new THREE.RawShaderMaterial({transparent:!0,vertexShader:Ht.tagDiscDefault.vertexShader,fragmentShader:Ht.tagDiscDefault.fragmentShader,uniforms:THREE.UniformsUtils.clone(Ht.tagDiscDefault.uniforms),depthTest:!1}),this.defaultStyleMaterial.uniforms.uColor.value.copy(this.color),this.customStyleMaterial=new THREE.RawShaderMaterial({transparent:!0,vertexShader:Ht.tagDiscCustom.vertexShader,fragmentShader:Ht.tagDiscCustom.fragmentShader,uniforms:THREE.UniformsUtils.clone(Ht.tagDiscCustom.uniforms),depthTest:!1})),this.animated=!0;var n=t.isMobile?new THREE.PlaneBufferGeometry(1.4,1.4):new THREE.PlaneBufferGeometry(1,1);return this.customStyleMaterial.uniforms.map.value=null,this.disc=new THREE.Mesh(n,new THREE.RawShaderMaterial({transparent:!0,vertexShader:Ht.tagVideoMarker.vertexShader,fragmentShader:Ht.tagVideoMarker.fragmentShader,uniforms:THREE.UniformsUtils.clone(Ht.tagDiscCustom.uniforms),depthTest:!1})),this.disc.layers.set(ht),this.disc.renderOrder=et,this.disc.tag=this,this.disc.name="disc",e.add(this.disc),e.name="tagGroup",e}},{key:"hide",value:function(e,t){if(!this.hidden){this.hidden=!0;var n=KanKan.Deferred();if(0===this.disc.material.uniforms.opacity.value&&!Se.isRunning(this.visibleTransition))return n.resolve().promise();e=e||0,t=t||0,Se.cancel(this.visibleTransition),this.markLine&&this.markLine.hide();var o=this.disc.material.uniforms.opacity.value/1,i=t+e,r=t/i;return this.visibleTransition=Se.start(function(e){var t=nt.property(e.disc.material.uniforms.opacity,"value",0);return function(e){t(e)}}(this),i*o,(function(){n.resolve()}),r,Ie[He.warp.blendEasing]),n.promise()}}},{key:"show",value:function(e,t){if(this.hidden){this.hidden=!1;var n=KanKan.Deferred();if(1===this.disc.material.uniforms.opacity.value&&!Se.isRunning(this.visibleTransition))return n.resolve().promise();e=e||0,t=t||0,Se.cancel(this.visibleTransition),this.markLine&&this.markLine.show();var o=(1-this.disc.material.uniforms.opacity.value)/1,i=t+e,r=t/i;return this.visibleTransition=Se.start(function(e){var t=nt.property(e.disc.material.uniforms.opacity,"value",1);return function(e){t(e)}}(this),i*o,(function(){n.resolve()}),r,Ie[He.warp.blendEasing]),n.promise()}}},{key:"update",value:function(){this.disc&&(this.discWorldPosition=this.disc.getWorldPosition(new THREE.Vector3),this.updateDisc())}},{key:"updateDisc",value:function(){var e=this.model.mode,t=this.model.player.camera,o=He.tags.visibility,i=He.tags.disc.scale,r=e===Oe.DOLLHOUSE||e===Oe.FLOORPLAN?He.tags.visibility.visibleDistance:t.position.distanceTo(this.discWorldPosition);if(this.obj3d.visible=0!==this.disc.material.opacity&&(o.anyDistance||r<=o.visibleDistance||e===Oe.TRANSITIONING)&&(!o.hideViaFloor||this.tagVisibleOnCurrentFloor(e))&&(!o.hideOffScreenDisc||!this.offScreen(this.disc,t))&&(!o.hideOffScreenObject||!this.offScreen(this.obj3d,t)),this.obj3d.visible&&this.disc.visible){this.disc.quaternion.copy(t.quaternion);var a=be.getScaleForConstantSize({maxSize:i.maxSize,minSize:"videoPanoFlag"==this.state&&e!=Oe.PANORAMA?30:i.minSize,nearBound:i.nearBound,farBound:i.farBound,camera:t,position:this.discWorldPosition,dom:this.model.$app.dom}),s=1+He.tags.disc.scale.responsiveness/100*(n.viewportScale()-1);this.discScale=a*s;try{this.model.player.linkEditor.setTagVisible?this.discScale*=1.5:this.isMeasurePoint?this.discScale*=.9:this.model.$app.TagManager.editHandle.editing&&(this.discScale*=2.5)}catch(e){}this.disc.scale.set(this.discScale,this.discScale,this.discScale),this.animated&&(this.animTime+=.016,this.disc.material.uniforms.uTime.value=this.animTime)}}},{key:"tagVisibleOnCurrentFloor",value:function(e){return!(e===Oe.DOLLHOUSE||e===Oe.FLOORPLAN)||this.model.allFloorsVisible||!!this.floors.find((function(e){return!e.hidden}))}},{key:"updateVideoFlagVisible",value:function(){this.obj3d.visible&&"dollhouse"==this.model.player.mode&&(this.model.allFloorsVisible&&Pe.ifShelter(this.position,null,this.model.currentFloor.floorIndex)?this.videoPano.marker.visible=!1:this.videoPano.marker.visible=!!this.videoPano.marker.visibleOri)}}],[{key:"viewportScale",value:function(){var e=document.getElementsByClassName("player")[0];return n.viewportWidth===e.clientWidth&&n.viewportHeight===e.clientHeight||(n.viewportWidth=e.clientWidth,n.viewportHeight=e.clientHeight,n.currentViewportScale=Math.sqrt(Math.min(n.viewportWidth,n.viewportHeight)/He.tags.disc.scale.baseViewportSize)),n.currentViewportScale}}]),n}(),Qn=function(){function e(t){i(this,e),this.tag=t.tag,this.groundPoint=t.groundPoint||t.markerPos,this.stemLine=An.createLine([t.stemLineLen?this.groundPoint.clone().add(new THREE.Vector3(0,t.stemLineLen,0)):t.tag.position,this.groundPoint],{width:2,color:t.stemLineColor||"#eee"}),this.stemLine.name="markGroup-stemLine",this.stemLine.layers.set(ht),this.stemLine2&&this.stemLine2.layers.set(ht),this.tag.obj3d.parent.add(this.stemLine),this.stemLine2&&this.tag.obj3d.parent.add(this.stemLine2)}return u(e,[{key:"hide",value:function(){this.stemLine.visible=!1}},{key:"show",value:function(){this.stemLine.visible=!0}}]),e}(),Gn=0,qn=1,Yn=2,$n=3,Xn=4,Jn=5,Kn={};function eo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}Kn.TILE_SIZE=512,Kn.FACES_PER_PANO=6,Kn.LocationOnTile={Center:0,UpperLeft:1,UpperRight:2,LowerRight:3,LowerLeft:4},Kn.getTileVector=function(e,t,n,o,i,r,a,s){var l=e/t,c=t/e*2,u=c/2,h=o/l*2-1+u,d=(i=l-1-i)/l*2-1+u;switch(r=r||Kn.LocationOnTile.Center){case Kn.LocationOnTile.UpperLeft:h-=u,d+=u,h+=a*c;break;case Kn.LocationOnTile.UpperRight:h+=u,d+=u,d-=a*c;break;case Kn.LocationOnTile.LowerRight:h+=u,d-=u,h-=a*c;break;case Kn.LocationOnTile.LowerLeft:h-=u,d-=u,d+=a*c;break;case Kn.LocationOnTile.Center:}switch(n){case Gn:xe.setVector(s,-1,d,-h);break;case qn:xe.setVector(s,1,d,h);break;case Yn:xe.setVector(s,-h,1,-d);break;case $n:xe.setVector(s,-h,-1,d);break;case Xn:xe.setVector(s,-h,d,1);break;case Jn:xe.setVector(s,h,d,-1)}xe.normalize(s)},Kn.getFaceForTile=function(e,t){var n=Kn.TILE_SIZE;e<Kn.TILE_SIZE&&(n=e);var o=Math.floor(e/n),i=o*o;return Math.floor(t/i)},Kn.getTileLocation=function(e,t,n){var o=Kn.TILE_SIZE;e<Kn.TILE_SIZE&&(o=e);var i=Kn.getFaceForTile(e,t),r=Math.floor(e/o),a=t-i*(r*r);return n.tileX=a%r,n.tileY=Math.floor(a/r),n.face=i,n.faceTileIndex=a,n},Kn.getTileCountForSize=function(e){if(e<=Kn.TILE_SIZE)return Kn.FACES_PER_PANO;var t=Math.floor(e/Kn.TILE_SIZE);return t*t*Kn.FACES_PER_PANO},Kn.getRelativeDirection=function(){var e=new xe.Matrix4,t=new xe.Quaternion;return function(n,o){t.copy(n),t.inverse(),e.makeRotationFromQuaternion(t),e.applyToVector3(o),xe.normalize(o)}}(),Kn.matchingTilesInDirection=function(){var e=new xe.Vector3,t=new xe.Vector3(0,0,-1),n=new xe.Quaternion,o=function(e,t){e.push({face:t.face,faceTileIndex:t.faceTileIndex,tileX:t.tileX,tileY:t.tileY})},i=function(){var e={face:-1,faceTileIndex:-1,tileX:-1,tileY:-1};return function(t,n,i){for(var r=Kn.getTileCountForSize(t),a=0,s=0;s<r;s++)Kn.getTileLocation(t,s,e),n&&!n(e)||(a++,i&&o(i,e));return a}}();return function(o,r,a,s,l,c){var u=r<Kn.TILE_SIZE?r:Kn.TILE_SIZE;if(!s&&!l)return i(r,null,c);var h=!!l;if(l=l||s,l=Math.max(0,Math.min(l,360)),s=Math.max(0,Math.min(s,360)),xe.copyVector(a,e),Kn.getRelativeDirection(o.quaternion,e),h){n.setFromUnitVectors(e,t);return i(r,(function(e){return Kn.isTileWithinFrustum(r,u,e.face,e.tileX,e.tileY,n,s,l)}),c)}return i(r,(function(t){return Kn.isTileWithinFOV(r,u,t.face,t.tileX,t.tileY,e,s)}),c)}}(),Kn.isTileWithinFrustum=function(){var e=new xe.Vector3;return function(t,n,o,i,r,a,s,l){for(var c=Math.tan(.5*l*xe.RADIANS_PER_DEGREE),u=-c,h=Math.tan(.5*s*xe.RADIANS_PER_DEGREE),d=-h,p=Kn.mapFaceToCubemapFace(o),f=0,m=0,v=0,g=0,y=0,w=Kn.LocationOnTile.Center;w<=Kn.LocationOnTile.LowerLeft;w++)if(Kn.getTileVector(t,n,p,i,r,w,0,e),xe.applyQuaternionToVector(a,e),e.z>=-1e-5);else{var b=-1/e.z,E=e.x*b,x=e.y*b;x>c?f++:x<u&&m++,E>h?v++:E<d&&g++,y++}return m!==y&&f!==y&&v!==y&&g!==y}}(),Kn.isTileWithinFOV=function(){var e=new xe.Vector3,t=new xe.Vector3(0,1,0),n=new xe.Vector3(1,0,0);return function(o,i,r,a,s,l,c){var u=Kn.mapFaceToCubemapFace(r);if(xe.cross(l,t,n),Kn.getTileVector(o,i,u,a,s,Kn.LocationOnTile.Center,0,e),Kn.isWithinFOV(e,l,c,null))return!0;for(var h=c/360,d=Math.floor(1/h),p=0,f=0;f<d;f++){for(var m=Kn.LocationOnTile.UpperLeft;m<=Kn.LocationOnTile.LowerLeft;m++)if(Kn.getTileVector(o,i,u,a,s,m,p,e),Kn.isWithinFOV(e,l,c,null))return!0;p+=h}return!1}}(),Kn.isWithinFOV=function(){var e=new xe.Vector3,t=new xe.Vector3;return function(n,o,i,r){if(xe.copyVector(n,t),r){xe.copyVector(r,e),xe.normalize(e);var a=xe.dot(e,n);e.x*=a,e.y*=a,e.z*=a,xe.subVector(t,e)}var s=i/2*xe.RADIANS_PER_DEGREE,l=Math.cos(s);return xe.dot(t,o)>=l}}(),Kn.mapFaceToCubemapFace=function(){var e={0:Yn,1:Xn,2:Gn,3:Jn,4:qn,5:$n};return function(t){return e[t]}}();var to=function(e){f(n,THREE.Object3D);var t=eo(n);function n(){var e,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,n),e=t.call(this);var r=new THREE.Texture;return r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,e.sprite=new THREE.Sprite(new THREE.SpriteMaterial({map:r,color:16777215,transparent:!0,depthTest:!1,depthWrite:!1})),e.add(e.sprite),e.sprite.renderOrder=null!=o.renderOrder?o.renderOrder:2,e.rectBorderThick=o.rectBorderThick||0,e.textBorderThick=o.textBorderThick||0,e.fontface="Arial",e.fontsize=o.fontsize||16,e.textBorderColor=o.textBorderColor||{r:0,g:0,b:0,a:0},e.backgroundColor=o.backgroundColor||{r:255,g:255,b:255,a:1},e.textColor=o.textColor||{r:0,g:0,b:0,a:1},e.borderColor=o.borderColor||{r:0,g:0,b:0,a:0},e.borderRadius=o.borderRadius||6,null!=o.text&&e.setText(o.text),e.name=o.name,e.addEventListener("dispose",e.dispose.bind(h(e))),e}return u(n,[{key:"setText",value:function(e){this.text!==e&&(this.text=e+"",this.updateTexture())}},{key:"setTextColor",value:function(e){this.textColor=e,this.updateTexture()}},{key:"setBorderColor",value:function(e){this.borderColor=e,this.updateTexture()}},{key:"setBackgroundColor",value:function(e){this.backgroundColor=e,this.updateTexture()}},{key:"setPos",value:function(e){this.position.copy(e),this.sprite.update()}},{key:"update",value:function(){this.sprite.update()}},{key:"setVisible",value:function(e){this.visible=e}},{key:"setUniforms",value:function(e,t){this.sprite.setUniforms(e,t)}},{key:"updateTexture",value:function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.font="Bold "+this.fontsize+"px "+this.fontface,t["font-weight"]=100;var n=t.measureText(this.text).width,o=new THREE.Vector2(this.fontsize,.4*this.fontsize),i=2*o.x+n+2*this.rectBorderThick,r=2*o.y+this.fontsize+2*this.rectBorderThick;t.canvas.width=i,t.canvas.height=r,t.font="Bold "+this.fontsize+"px "+this.fontface;t.textBaseline="middle",t.strokeStyle="rgba("+this.borderColor.r+","+this.borderColor.g+","+this.borderColor.b+","+this.borderColor.a+")",t.lineWidth=this.rectBorderThick,t.fillStyle="rgba("+this.backgroundColor.r+","+this.backgroundColor.g+","+this.backgroundColor.b+","+this.backgroundColor.a+")",this.roundRect(t,this.rectBorderThick/2,this.rectBorderThick/2,i-this.rectBorderThick,r-this.rectBorderThick,this.borderRadius),this.textBorderThick&&(t.strokeStyle="rgba("+this.textBorderColor.r+","+this.textBorderColor.g+","+this.textBorderColor.b+","+this.textBorderColor.a+")",t.lineWidth=this.textBorderThick,t.strokeText(this.text,this.rectBorderThick+o.x,r/2+2)),t.fillStyle="rgba("+this.textColor.r+","+this.textColor.g+","+this.textColor.b+","+this.textColor.a+")",t.fillText(this.text,this.rectBorderThick+o.x,r/2+2);var a=new THREE.Texture(e);a.minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,a.needsUpdate=!0,this.sprite.material.map&&this.sprite.material.map.dispose(),this.sprite.material.map=a,this.sprite.scale.set(.01*i,.01*r,1)}},{key:"roundRect",value:function(e,t,n,o,i,r){e.beginPath(),e.moveTo(t+r,n),e.lineTo(t+o-r,n),e.arcTo(t+o,n,t+o,n+r,r),e.lineTo(t+o,n+i-r),e.arcTo(t+o,n+i,t+o-r,n+i,r),e.lineTo(t+r,n+i),e.arcTo(t,n+i,t,n+i-r,r),e.lineTo(t,n+r),e.arcTo(t,n,t+r,n,r),e.closePath(),e.fill(),e.stroke()}},{key:"dispose",value:function(){this.sprite.material.uniforms.map.value.dispose(),this.parent&&this.parent.remove(this),this.sprite.dispatchEvent({type:"dispose"}),this.removeAllListeners()}}]),n}();function no(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var oo=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2),io={sizeInfo:{minSize:200,maxSize:250,nearBound:.8,farBound:10},backgroundColor:{r:255,g:255,b:255,a:.4},textColor:{r:0,g:0,b:0,a:1},borderRadius:15,renderOrder:Je},ro=function(e){f(n,EventEmitter);var t=no(n);function n(e,o,r,a,s){var l,c,u,d,p;if(i(this,n),(l=t.call(this)).raycastToFindFloor=function(){var e=[new THREE.Vector3(0,-1,0),new THREE.Vector3(1,-1,0),new THREE.Vector3(0,-1,1),new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,-1,-1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1)];return function(){for(var t=0;t<e.length;t++){var n=new THREE.Raycaster(this.position.clone(),e[t].clone()).intersectObjects(this.model.colliders);if(n.length)return n[0].object.parent.parent}return null}}(),l.findNeighourPanos=function(){return this.model.panos.setNeighbour(this.id,this.id,!1),this.model.panos.forEach(function(e){if(e!==this&&(!this.model.panos.neighbourMap[this.id]||void 0===this.model.panos.neighbourMap[this.id][e.id])){var t=this.position.distanceTo(e.position);if(t>He.panoramaNeighbourMaxDistance)return this.model.panos.setNeighbour(this,e,!1),void n.raycastsSkipped++;var o=e.position.clone().sub(this.position).normalize(),i=new THREE.Raycaster(this.position,o.clone(),0,t).intersectObjects(this.model.colliders);n.raycastsDone++,this.model.panos.setNeighbour(this,e,0===i.length),He.showNeighbourRaycasts&&(i.length?this.floor.model.add(new THREE.ArrowHelper(o,this.position,i[0].distance,16711680)):this.floor.model.add(new THREE.ArrowHelper(o,this.position,t,16777215,0,0)))}}.bind(this)),this.model.panos.neighbourMap[this.id]},l.enter=(c=null,function(){this.setZoomed(!1),this.emit(ft.Enter,c,this),c=this,this.model.setHighMap(this)}),l.loadTiledPano=(u={},d={},p={},function(e,t,n,o,i,r){null!=o||(o=!0),null!=i||(i=!0);var a=this.getWaitDeferred(e),s=a.deferred,l=null,c=null;if(n&&("number"==typeof n?l=n:(l=n.hFov,c=n.vFov)),this.isLoaded(e))s.resolve(e);else{if(!a.active){a.active=!0;var h=this.id+":"+e;if(u[h]=u[h]||[],p[h]=null,n){var f=[],m=Kn.matchingTilesInDirection(this,e,t,l,c,f);p[h]=f,u[h].forEach((function(e){var t=p[h].find((function(t){return e.faceTileIndex==t.faceTileIndex&&e.face==t.face}));t&&(t.loaded=!0)})),p[h].some((function(e){return!e.loaded}))||(s.resolve(e),this.resetWaitDeferred(e),p[h]=null),ke.info("Loading partial pano: "+this.id+" with "+m+" tiles")}d[this.id]||(d[this.id]=!0,this.on(ft.LoadComplete,function(e,t){var n=this.getWaitDeferred(e).deferred;n&&"pending"===n.state()&&this.highestPartialTileRenderOpCompleted>=e&&(n.resolve(e,t),this.resetWaitDeferred(e))}.bind(this)),this.on(ft.LoadFailed,function(e){var t=this.getWaitDeferred(e).deferred;t&&"pending"===t.state()&&this.highestPartialTileRenderOpCompleted>=e&&(t.reject(e),this.resetWaitDeferred(e))}.bind(this)),this.on(ft.TileLoaded,function(e,t,n){var o=this.id+":"+e;u[o]=u[o]||[];var i=Kn.getTileLocation(e,t,{}),r=i.faceTileIndex,a=i.face;u[o].push({faceTileIndex:r,face:a});var s=this.getWaitDeferred(e).deferred;if(s&&"pending"===s.state()&&(s.notify(e,t,n),p[o])){var l=p[o].find((function(e){return e.faceTileIndex==r&&e.face==a}));l&&(l.loaded=!0),p[o].some((function(e){return!e.loaded}))||(this.onPanoRendered(this.id,e,n,!0),s.resolve(e,n),this.resetWaitDeferred(e),p[o]=null)}}.bind(this)))}this.tileDownloader.clearForceQueue(),this.tileDownloader.forceQueueTilesForPano(this,e,t,l,c,r),this.tiledPanoRenderTarget=this.panoRenderer.activateTiledPano(this,this.qualityManager.getMaxNavPanoSize(),o),this.panoRenderer.renderPanoTiles(this.id,t,i)}return s.promise()}),l.$app=e,l.model=l.$app.core.get("Player").model,l.id=o,l.neighbourUUIDs=r.neighbours||[],l.neighbourPanos=null,l.floor=null,l.floorIndex=r.subgroup||0,l.failedLoadingAt=0,l.maxLoadRetries=4,l.origin=r.position.clone(),l.position=r.position.clone(),l.quaternion=r.quaternion.clone(),l.skyboxMesh=new THREE.Mesh(He.sphereBufferGeometry),l.skyboxMesh.position.copy(l.position),l.skyboxMesh.name="skybox",l.debugColor=(new THREE.Color).setHSL(.06+.53*Math.random(),.8+.2*Math.random(),.5+.2*Math.random()),l.floorPosition=r.puck?r.puck.clone():null,l.marker=null,l.noBlocks=[],l.blocks=[],l.seeMarkers=r.seeMarkers,l.isAssist=r.isAssist,l.tiled=null!=r.tiled?r.tiled:l.model.supportsTiles&&!r.isAssist,l.isAligned()&&!l.isAssist&&(l.marker=new Bn(h(l))),l.tiled){l.solidSkybox=null;var f=(new THREE.Quaternion).multiplyQuaternions(l.quaternion,oo);l.skyboxMesh.quaternion.copy(f),l.skyboxMesh.updateMatrix(),l.skyboxMesh.updateMatrixWorld(),l.rot90Matrix=l.skyboxMesh.matrixWorld.clone()}else{l.solidSkybox=new THREE.Texture([null,null,null,null,null,null]),l.solidSkybox.flipY=!1,He.minimalMemoryMode&&(l.solidSkybox.minFilter=THREE.LinearFilter,l.solidSkybox.magFilter=THREE.LinearFilter,l.solidSkybox.generateMipmaps=!1);f=r.quaternion.clone();l.quaternion=(new THREE.Quaternion).multiplyQuaternions(f,oo)}return l.skyboxMesh.material.color=new THREE.Color(1,1,1),l.skyboxMesh.quaternion.copy(l.quaternion),l.skyboxMesh.name="skybox",l.skyboxMesh.visible=!1,l.skyboxMesh.updateMatrix(),l.skyboxMesh.updateMatrixWorld(),l.zoomed=!1,l.panoRenderer=null,l.qualityManager=null,l.tileDownloader=null,l.tiledPanoRenderTarget=null,l.resolutionPromise={},l.minimumTiledPanoLoaded=!1,l.highestPartialTileRenderOpCompleted=0,l.highestFullTileRenderOpCompleted=0,l.shouldRedrawOnBaseLoaded=!1,l.lockUntilRenderingComplete=!1,a?(l.hasVideo=!0,l.videoInfo=a):l.hasVideo=!1,l.panoVideo=!1,l}return u(n,[{key:"exit",value:function(){this.tiled?(this.clearWaitDeferreds(),this.minimumTiledPanoLoaded=!1,this.tiledPanoRenderTarget=null,this.setZoomed(!1),this.panoRenderer.deactivateTiledPano(this),this.highestPartialTileRenderOpCompleted=0,this.highestFullTileRenderOpCompleted=0):(this.solidSkybox.dispose(),this.solidSkybox.loaded=!1,this.solidSkybox.version=0),this.emit("exit")}},{key:"hoverOn",value:function(e){this.hasVideo&&this.panoVideoRenderer.ifEnable()||this.marker&&Se.start(nt.property(this.marker.material,"opacity",He[e].markerOpacityOnHover),250)}},{key:"hoverOff",value:function(e){this.hasVideo&&this.panoVideoRenderer.ifEnable()||this.marker&&Se.start(nt.property(this.marker.material,"opacity",He[e].markerOpacity),250)}},{key:"build1",value:function(){this.floor=this.floor||this.model.floors.get(this.floorIndex)||this.raycastToFindFloor()||this.model.getFloorAtPoint(this.position),this.floor.addPano(this),this.floorPosition=this.floorPosition||this.raycastFloorPosition(),this.neighbourPanos=this.neighbourPanos||this.findNeighourPanos(),He.colorMarkerByFloor&&this.marker&&this.marker.material.color.set(this.floor.debugColor)}},{key:"build2",value:function(){this.floorPosition=this.floorPosition||this.interpolateFloorPosition(),this.height=this.position.distanceTo(this.floorPosition),this.placeMarker()}},{key:"placeMarker",value:function(){this.marker&&(this.marker.position.copy(this.floorPosition),this.marker.position.y+=.01,this.marker.lookAt(new THREE.Vector3(0,1,0).add(this.marker.position)))}},{key:"attachToPanoRenderer",value:function(e){this.panoRenderer=e,this.panoRenderer.on(st.TileRenderSuccess,this.onTileRendered.bind(this)),this.panoRenderer.on(st.PanoRenderComplete,this.onPanoRendered.bind(this)),this.panoRenderer.on(st.TileRenderFailure,this.onTileRenderFail.bind(this)),this.panoRenderer.on(st.UploadAttemptedForAllTiles,this.onUploadAttemptedForAllTiles.bind(this))}},{key:"updateMakerStyle",value:function(){this.hasVideo&&this.panoVideoRenderer.ifEnable()||this.panoVideo?this.marker.updateStyle(this.model,this):this.marker.updateStyle("normal",this)}},{key:"updateMarkerVisible",value:function(e,t){this.flagSpot&&(t.linkEditor&&t.linkEditor.setPanoVisible||t.linkEditor.checkHasNeighbor(this)?this.marker.visible=!0:this.marker.visible=!1)}},{key:"createVrMarker",value:function(e,t){var n=this;this.isAligned()&&(this.vrMarker=new THREE.Sprite(new THREE.SpriteMaterial({transparent:!0,opacity:.75,map:e,depthTest:!1})),this.vrMarker.name="vrMarker",this.vrMarker.scale.set(.16,.16,1),this.vrMarker.boluoType="vr",this.vrMarker.position.copy(this.position),this.vrMarker.position.y-=.2,this.vrMarker.enabled=!0,this.vrMarker.visible=!1,this.vrMarker.renderOrder=Xe,this.vrMarker.pano=this,this.model.vrMarkers.push(this.vrMarker),this.model.add(this.vrMarker),this.vrMarker.addEventListener("click",(function(){"portrait"!=window.VRScreenType&&t.flyToPano({pano:n})})))}},{key:"attachToPanoVideoRenderer",value:function(e){this.hasVideo&&(this.panoVideoRenderer=e,this.on(ft.Enter,e.onVideoPanoramasEnter.bind(e)),this.on(ft.Exit,e.onVideoPanoramasExit.bind(e)))}},{key:"getWaitDeferred",value:function(e){var t=this.resolutionPromise[this.id];t||(t={},this.resolutionPromise[this.id]=t);var n=t[e];return n||(n={deferred:_e(),active:!1},t[e]=n),n}},{key:"resetWaitDeferred",value:function(e){var t=this.getWaitDeferred(e);t.active=!1,t.deferred=_e()}},{key:"clearWaitDeferreds",value:function(){var e=this.resolutionPromise[this.id];for(var t in e||(e={},this.resolutionPromise[this.id]=e),e)if(e.hasOwnProperty(t)){var n=e[t];n.active=!1,n.deferred=_e()}}},{key:"onUploadAttemptedForAllTiles",value:function(e,t,n){e===this.id&&(t===this.qualityManager.getPanoSize(mt)&&this.shouldRedrawOnBaseLoaded&&(this.shouldRedrawOnBaseLoaded=!1,this.panoRenderer.resetRenderStatus(this.id,!0,!1),this.panoRenderer.renderPanoTiles(this.id,null,!0,!0)))}},{key:"onTileRendered",value:function(e,t,n,o){e===this.id&&this.emit(ft.TileLoaded,t,n,o)}},{key:"onPanoRendered",value:function(e,t,n,o){e===this.id&&(this.minimumTiledPanoLoaded=!0,this.updateSkyboxForZoomLevel(),t>this.highestPartialTileRenderOpCompleted&&(this.highestPartialTileRenderOpCompleted=t),!o&&t>this.highestFullTileRenderOpCompleted&&(this.highestFullTileRenderOpCompleted=t),this.emit("load",t),this.model.emit("load",this),this.emit(ft.LoadComplete,t,n))}},{key:"setZoomed",value:function(e){this.zoomed=e,this.updateSkyboxForZoomLevel(),e?this.model.showHighMap():this.model.hideHighMap()}},{key:"ensureSkyboxReadyForRender",value:function(){this.tiled||(this.solidSkybox.loaded||(this.solidSkybox.needsUpdate=!0),this.solidSkybox.loaded=!0)}},{key:"updateSkyboxForZoomLevel",value:function(){this.minimumTiledPanoLoaded&&this.model.updateProjectedPanos(this)}},{key:"getSkyboxTexture",value:function(){return this.tiled?this.minimumTiledPanoLoaded?this.zoomed&&this.qualityManager.maxRenderTargetSize>this.qualityManager.maxNavPanoSize?this.panoRenderer.zoomRenderTarget.texture:this.tiledPanoRenderTarget.texture:null:this.solidSkybox}},{key:"onTileRenderFail",value:function(e,t,n){e===this.id&&this.emit(ft.LoadFailed,t)}},{key:"isLoaded",value:function(e){return this.tiled?(e&&"string"==typeof e&&console.error("Wrong panoSize given to Panorama.isLoaded(); a tiled pano uses PanoSizeClass"),!!this.minimumTiledPanoLoaded&&(!e||this.highestFullTileRenderOpCompleted>=e)):(e&&"number"==typeof e&&console.error("Wrong panoSize given to Panorama.isLoaded(); a non-tiled pano uses high/low."),!!this.solidSkybox.high||e in this.solidSkybox)}},{key:"loadCube",value:function(e){if(this.isLoaded(e))return ke.info("Skipping load of pano, already loaded"),Ue.when();this.emit("loading",e),this.model.emit("loading",this);var t=this.getCubemapUrls(this.id,e);return Mn.getImage(t).then(function(t){return this.solidSkybox[e]=t,this.solidSkybox.minFilter=THREE.LinearFilter,"high"!==e&&this.solidSkybox.high||(this.solidSkybox.image=this.solidSkybox[e],this.solidSkybox.low=null),this.solidSkybox.needsUpdate=!0,this.emit("load",e),this.model.emit("load",this),this}.bind(this),function(){ke.error("Downloading cubemap for pano",this.id,"failed"),this.failedLoadingAt=Date.now()}.bind(this),(function(){console.log("load cubeTex 出现问题？")}))}},{key:"loadCubeImage",value:function(e){var t=_e(),n=new Image;return n.onerror=function(){t.reject()},n.onload=function(){t.resolve(n)},n.crossOrigin=THREE.ImageUtils.crossOrigin,n.src=e,t}},{key:"getCubemapUrls",value:function(e,t){return this.$app.resource.getViewImagesURL("pan/".concat(t,"/").concat(e,".jpg"))}},{key:"worldPosition",value:function(){return this.position}},{key:"isAligned",value:function(){return!0}},{key:"addLabel",value:function(){this.removeLabel(),this.label=new to(Object.assign({},io,{text:this.id})),this.label.position.copy(this.floorPosition),this.floor.add(this.label)}},{key:"removeLabel",value:function(){this.label&&(this.floor.remove(this.label),this.label.material.dispose(),this.label=null)}}]),n}();function ao(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}ro.raycastsSkipped=0,ro.raycastsDone=0,ro.filters={inDirection:function(e,t,n){return function(o){return o.position.clone().sub(e).normalize().dot(t)>n}},inFloorDirection:function(e,t,n){return function(o){return o.floorPosition.clone().sub(e).normalize().dot(t)>n}},inPanoDirection:function(e,t,n){return n=He.navigation.panoScores?He.navigation.filterStrictness:n,function(o){var i=o.floorPosition.clone().sub(e).normalize(),r=o.position.clone().sub(e).normalize();return i.dot(t)>n||r.dot(t)>n}},atFloor:function(e){return function(t){return!e||t.floor===e}},not:function(e){return function(t){return t!==e}},notIn:function(e){return function(t){return-1===e.indexOf(t)}},isLoaded:function(){return function(e){return e.isLoaded()}},isNotLoaded:function(){return function(e){return!e.isLoaded()}},isCloseEnoughTo:function(e,t){return function(n){return e.distanceTo(n.floorPosition)<t}},hasMinimumHeightDifferenceTo:function(e,t){return function(n){return Math.abs(n.position.y-e.y)>t}},isNotBehindNormal:function(e,t){var n=new THREE.Vector3;return t=t.clone(),function(o){return n.copy(o.position).sub(e).normalize().dot(t)>0}},isNeighbourPanoTo:function(e){return function(t){return!e||!e.neighbourPanos||!!e.neighbourPanos[t.id]}},isNeighbourOfNeighbourTo:function(e){return function(t){return!!e.neighbourPanos[t.id]||e.neighbourUUIDs.some((function(n){var o=e.model.panos.get(n);return!!o&&o.neighbourPanos[t.id]}))}},isNotRecentlyFailed:function(e){return function(t){return Date.now()-t.failedLoadingAt>e}},isOnVisibleFloor:function(){return function(e){return!e.floor.hidden}},isPanoAligned:function(){return function(e){return e.isAligned()}},isInFanAngle:function(e,t,n){return function(o){var i=t.setY(0),r=o.position.clone().sub(e).setY(0);return i.angleTo(r)<=n}}},ro.sortFunctions={distanceToPoint:function(e){return function(t,n){return t.position.distanceTo(e)-n.position.distanceTo(e)}},floorDistanceToPoint:function(e){return function(t,n){return t.floorPosition.distanceTo(e)-n.floorPosition.distanceTo(e)}},choose:function(e){return function(t,n){return e.id===t.id?-1:e.id===n.id?1:0}}},ro.scoreFunctions={distance:function(e,t){return t=t||He.navigation.distanceFactor,function(n){return e?e.position.distanceTo(n.position)*t:0}},distanceSquared:function(e,t){return t=t||He.navigation.distanceFactor,function(n){return e?e.position.distanceToSquared(n.position)*t:0}},direction:function(e,t){return function(n){return n.position.clone().sub(e).normalize().dot(t)*He.navigation.directionFactor}},angle:function(e,t){return function(n){return n.position.clone().sub(e).normalize().angleTo(t)*He.navigation.angleFactor}},inFieldOfView:function(e,t){return function(n){return n.position.clone().sub(e).normalize().dot(t)>.75?10:-1}},optionality:function(e){return function(t){return t.neighbourUUIDs.filter((function(t){return!(t in e.neighbourUUIDs)&&t!==e.id})).length*He.navigation.optionalityFactor}},penalizeHeightDifferenceUnder:function(e,t){return function(n){return e.y-n.position.y<t?-20:0}}};var so=function(e){f(n,e);var t=ao(n);function n(){var e;return i(this,n),(e=t.call(this)).closestPanoTowardPoint=function(e){var t=e.point,n=e.require||[],o=e.rank||[];e.force;var i=e.getAll;n.push(ro.filters.isPanoAligned()),e.floor&&n.push(ro.filters.atFloor(e.floor));var r={position:t};o.push(ro.scoreFunctions.distanceSquared(r,-2));var a=this.sortByScore(n,o);return i?a:a&&a.length>0&&a[0].pano},e.neighbourMap={},e.map=null,e}return u(n,[{key:"getIndex",value:function(e){return e.id}},{key:"find",value:function(e,t){var n=se.filterAll(this.list,e);return 0===n.length?null:(t&&t.forEach((function(e){n=se.stableSort(n,e)})),n[0])}},{key:"sortByScore",value:function(e,t){var n=se.filterAll(this.list,e);return 0===n.length?null:n=n.map((function(e){return{pano:e,score:t.reduce((function(t,n){return t+n(e)}),0)}})).sort((function(e,t){return t.score-e.score}))}},{key:"lowestByScore",value:function(e,t,n){return this.findRankedByScore(0,e,t,n)}},{key:"findRankedByScore",value:function(e,t,n,o){o&&(o.candidates=null,o.pano=null),e||(e=0);var i=this.sortByScore(t,n);return!i||0===i.length||e>=i.length?null:(o&&(o.candidates=i,o.pano=i[e].pano),i[e].pano)}},{key:"getNeighbours",value:function(e){return this.neighbourMap[e.id]}},{key:"setNeighbour",value:function(e,t,n){return this.neighbourMap[e.id]||(this.neighbourMap[e.id]={}),this.neighbourMap[t.id]||(this.neighbourMap[t.id]={}),this.neighbourMap[e.id][e.id]=!0,this.neighbourMap[t.id][t.id]=!0,this.neighbourMap[e.id][t.id]=n,this.neighbourMap[t.id][e.id]=n,this.neighbourMap[e.id]}},{key:"findClosest",value:function(e,t){var n=[ro.filters.isPanoAligned()];return t&&n.push(ro.filters.inDirection(e,t,.75)),this.find(n,[ro.sortFunctions.distanceToPoint(e)])}},{key:"fadeMarkerOpacity",value:function(e,t,n){if(Se.cancelById("fadeMarkerOpacity"),this.list.findIndex((function(e){return e.marker}))<0)logger.info("marker findIndex<0");else{var o,i=function(e,n){e.member=e.member.filter((function(t){return t.marker&&t.marker.material.opacity!=e.toOp})),Se.trigger({func:function(t,n){e.member.forEach((function(n){var o=n.marker.oldOpacity,i=o+t*(e.toOp-o);n.marker&&(n.marker.material.opacity=i)}))}.bind(this),duration:null==t?He.markerOpacityTransitionTime:t,name:"_fpm_"+n,id:"fadeMarkerOpacity"})};this.forEach((function(e){e.marker&&(e.marker.oldOpacity=e.marker.material.opacity)})),o=(e=null==e?He.panorama.markerOpacity:e)>0&&n?n:[{member:this.list,toOp:e}];for(var r=0;r<o.length;r++)i(o[r],r)}}}]),n}(Qe);function lo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var co=function(e){f(n,THREE.Mesh);var t=lo(n);function n(e,o,r){var a;i(this,n),e=e.clone().expandByScalar(.01);var s=new THREE.Vector3;e.getSize(s);var l=new THREE.BoxGeometry(s.x,s.y,s.z);l.computeBoundingBox(),a=t.call(this,l,o);var c=new THREE.Vector3;return e.getCenter(c),a.position.copy(c),a.frustumCulled=!1,r&&a.add(new THREE.WireframeHelper(h(a))),a}return n}();function uo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var ho=function(e){f(n,THREE.RawShaderMaterial);var t=uo(n);function n(e,o){if(i(this,n),(e=e||{}).not_Cube){var r=e.defines||{};r.Not_Cube="",e.defines=r}o=o||"model";return t.call(this,se.extendObject({fragmentShader:Ht[o].fragmentShader,vertexShader:Ht[o].vertexShader,uniforms:THREE.UniformsUtils.clone(Ht[o].uniforms),name:"ModelTextureMaterial"},e))}return u(n,[{key:"setProjectedPanos",value:function(e,t,n){n&&(this.uniforms.progress.value=0),e.ensureSkyboxReadyForRender(),this.uniforms.pano0Map.value=e.getSkyboxTexture(),this.uniforms.pano0Position.value.copy(e.position),this.uniforms.pano0Matrix.value.copy(e.skyboxMesh.matrixWorld),t.ensureSkyboxReadyForRender(),delete this.defines.HasVideo,t.hasVideo&&(this.uniforms.exposure.value=t.videoInfo.exposure||1,this.uniforms.blendFov.value=t.videoInfo.blendFov||5,t.videoInfo.clipRect&&this.uniforms.clipRect.value.set(t.videoInfo.clipRect.leftBottom.x,t.videoInfo.clipRect.leftBottom.y,t.videoInfo.clipRect.rightTop.x,t.videoInfo.clipRect.rightTop.y),this.defines.VideoMapping=t.videoInfo.mapping||0,this.defines.HasVideo=t.videoInfo.cameraType||8),this.needsUpdate=!0,this.uniforms.pano1Map.value=t.getSkyboxTexture(),this.uniforms.pano1Position.value.copy(t.position),this.uniforms.pano1Matrix.value.copy(t.skyboxMesh.matrixWorld)}}]),n}();function po(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var fo=function(e){f(n,e);var t=po(n);function n(e){var o;i(this,n),ke.time("Computing a nice bounding cubemap");var r=new ho({side:THREE.BackSide,transparent:!0});return r.uniforms.modelAlpha.value=0,r.uniforms.opacity.value=1-He.modelAlpha,(o=t.call(this,e,r)).renderOrder=$e,ke.timeEnd("Computing a nice bounding cubemap"),o}return n}(co);function mo(){}mo.prototype={on:function(e,t,n){var o=this.e||(this.e={});return(o[e]||(o[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){var o=this;function i(){o.off(e,i),t.apply(n,arguments)}return i._=t,this.on(e,i,n)},emit:function(e){for(var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),o=0,i=n.length;o<i;o++)n[o].fn.apply(n[o].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),o=n[e],i=[];if(o&&t)for(var r=0,a=o.length;r<a;r++)o[r].fn!==t&&o[r].fn._!==t&&i.push(o[r]);return i.length?n[e]=i:delete n[e],this}};var vo=mo,go=mo;vo.TinyEmitter=go;var yo={map:{type:"t",value:null},opacity:{type:"f",value:0},opaRadius:{type:"f",value:.2}},wo="varying vec2 vUv;void main() {  vUv = uv;  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );}",bo="uniform sampler2D map; uniform float opacity;uniform float opaRadius;varying vec2 vUv; void main() {    vec2 vUv2 = vec2(vUv.x*2.0 - 1.0, vUv.y*2.0 - 1.0);  vec4 colorFromTexture = texture2D( map, vUv );  float  opa = 1.0;  float r = vUv2.x*vUv2.x + vUv2.y*vUv2.y;  if(r > 1.0) opa = 0.0;   else if(r < opaRadius)opa = 1.0;  else{\tfloat a = -1.0 / ((opaRadius - 1.0)*(opaRadius - 1.0));\tfloat b = -2.0 * a * opaRadius;\tfloat c = 1.0 + a * opaRadius * opaRadius;    opa = a * r*r + b * r + c;    }  gl_FragColor = vec4(colorFromTexture.rgb,    opacity * min(colorFromTexture.a, opa)   );}";function Eo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var xo={floorLogo:{name:"floorLogoImg.png",geometry:new THREE.Vector4(2.5,2.5,1,1),size:100,position:new THREE.Vector3(0,-1.49,0),renderOrder:99}},To=function(e){f(n,e);var t=Eo(n);function n(e){var o,r,a;return i(this,n),(o=t.call(this)).changefloorLogoOpa=function(e){if(this.firstLogo){var t=0==e.index?this.firstLogo:this.secondLogo;Se.cancelById("flOpa_"+e.index),null!=e.from&&(t.material.uniforms.opacity.value=e.from),e.dur?Se.start(nt.uniform(t,"opacity",e.opa),e.dur||0,null,e.delay||0,Ie.easeInQuad,"changefloorLogoOpa","flOpa_"+e.index):t.material.uniforms.opacity.value=e.opa}},o.updateFloorlogo=(r=new THREE.Quaternion,a=function(e,t,n){return Math.abs(e-t)<n},function(e){var t,n;if(!this.fixDirection&&e&&this.firstLogo&&this.secondLogo&&((this.firstLogo.visible||0!=this.firstLogo.material.uniforms.opacity.value||this.secondLogo.visible||0!=this.secondLogo.material.uniforms.opacity.value)&&(n=!0),n)){var o,i=this.app.core.get("Player").camera.quaternion;if((o=a(i.x,r.x,.005)&&a(i.y,r.y,.005)&&a(i.z,r.z,.005)&&a(i.w,r.w,.005))||(r=i.clone()),!o){if(!t){var s=new THREE.Vector3(0,0,-1);s.applyQuaternion(e),s.setY(0);var l=(new THREE.Matrix4).lookAt(s,new THREE.Vector3,new THREE.Vector3(0,1,0));t=(new THREE.Quaternion).setFromRotationMatrix(l);var c=new THREE.Quaternion(0,.7071067811865476,.7071067811865476,0);t.multiply(c)}this.firstLogo.quaternion.copy(t),this.secondLogo.quaternion.copy(t)}}}),o.setDir=function(e){this.fixDirection&&(this.firstLogo.rotation.z=THREE.Math.degToRad(-e),this.secondLogo.rotation.z=THREE.Math.degToRad(-e))},o.app=e,o.ready=!1,o.firstLogo={visible:!0},o.secondLogo={visible:!0},o.fixDirection=!1,o}return u(n,[{key:"bindEvents",value:function(){}},{key:"createFloorLogo",value:function(){var e=this.getLogo(),t=e.url,n=e.size/100,o=In.load(t);this.firstLogo=this.getLogoMesh(o),this.secondLogo=this.getLogoMesh(o),this.secondLogo.visible=!1,this.firstLogo.scale.set(n,n,n),this.secondLogo.scale.set(n,n,n),this.emit("ready"),this.ready=!0}},{key:"changeFloorLogo",value:function(e){if(this.ready){if(this.firstLogo.material.uniforms.map.value&&this.firstLogo.material.uniforms.map.value.dispose(),this.secondLogo.material.uniforms.map.value&&this.secondLogo.material.uniforms.map.value.dispose(),e.url){var t=In.load(e.url);this.firstLogo.material.uniforms.map.value=t,this.secondLogo.material.uniforms.map.value=t}else if(e.id){var n=In.load(this.app.resource.getAppURL("images/floorlogos/".concat(e.id,".png")));this.firstLogo.material.uniforms.map.value=n,this.secondLogo.material.uniforms.map.value=n}else if(e.image){var o=new THREE.Texture(e.image);o.needsUpdate=!0,this.firstLogo.material.uniforms.map.value=o,this.secondLogo.material.uniforms.map.value=o,this.firstLogo.material.needsUpdate=!0,this.secondLogo.material.needsUpdate=!0}if(e.size){var i=e.size/100;this.firstLogo.scale.set(i,i,i),this.secondLogo.scale.set(i,i,i)}}}},{key:"getLogo",value:function(){var e=this.app.store.getValue("metadata"),t=e.floorLogo||"0";"zh"!=this.app.config.lang&&(t="en/"+t);var n=e.floorLogoSize||100;return{url:"user"===e.floorLogo?this.app.resource.getUserResourceURL(e.floorLogoFile):this.app.resource.getAppURL("images/floorlogos/".concat(t,".png")),size:n}}},{key:"getLogoMesh",value:function(e){var t=THREE.UniformsUtils.clone(yo);t.map.value=e;var n=new THREE.ShaderMaterial({fragmentShader:bo,vertexShader:wo,uniforms:t,side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1}),o=new THREE.Mesh(new THREE.PlaneGeometry(2.5,2.5,1,1),n);o.name="floorlogo";var i=xo.floorLogo.size/100;return o.scale.set(i,i,i),o.position.set(xo.floorLogo.position.x,xo.floorLogo.position.y,xo.floorLogo.position.z),o.lookAt(o.position.clone().add(new THREE.Vector3(0,1,0))),o.renderOrder=xo.floorLogo.renderOrder,o}}]),n}(vo),Po=THREE.BoxBufferGeometry,ko=THREE.BufferGeometry,Mo=THREE.Color,Ro=THREE.CylinderBufferGeometry,Io=THREE.DoubleSide,So=THREE.Euler,Co=THREE.Float32BufferAttribute,Ao=THREE.Line,Do=THREE.LineBasicMaterial,Lo=THREE.Matrix4,zo=THREE.Mesh,Vo=THREE.MeshBasicMaterial,Ho=THREE.Object3D,Oo=THREE.OctahedronBufferGeometry,Fo=THREE.PlaneBufferGeometry,No=THREE.Quaternion,Bo=THREE.Raycaster;THREE.SphereBufferGeometry;var jo=THREE.TorusBufferGeometry,Uo=THREE.Vector3,_o=function(e,t,n){void 0===t&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),Ho.call(this),this.visible=!1,this.domElement=t;var o=new Wo(n);this.add(o);var i=new Zo(n);this.add(i);var r=this;this.player=n.player,this.options=n,B("camera",e),B("object",void 0),B("enabled",!0),B("axis",null),B("mode","translate"),B("translationSnap",null),B("rotationSnap",null),B("scaleSnap",null),B("space","world"),B("size",1),B("dragging",!1),B("showX",!0),B("showY",!0),B("showZ",!0);var a={type:"change"},s={type:"mouseDown"},l={type:"mouseUp",mode:r.mode},c={type:"objectChange"},u=new Bo,h=new Uo,d=new Uo,p=new No,f={X:new Uo(1,0,0),Y:new Uo(0,1,0),Z:new Uo(0,0,1)},m=new Uo,v=new Uo,g=new Uo,y=new Uo,w=new Uo,b=new Uo,E=0,x=new Uo,T=new No,P=new Uo,k=new Uo,M=new No,R=new No,I=new Uo,S=new Uo,C=new No,A=new Uo,D=new Uo,L=new No,z=new No,V=new Uo,H=new Uo,O=new Uo,F=new No,N=new Uo;function B(e,t){var n=t;Object.defineProperty(r,e,{get:function(){return void 0!==n?n:t},set:function(t){n!==t&&(n=t,i[e]=t,o[e]=t,r.dispatchEvent({type:e+"-changed",value:t}),r.dispatchEvent(a))}}),r[e]=t,i[e]=t,o[e]=t}function j(e){r.enabled&&r.pointerHover(r.player.mouse)}function U(e){r.enabled&&(r.pointerHover(r.player.mouse),r.pointerDown(r.player.mouse))}function _(e){r.enabled&&r.dragging&&r.pointerMove(r.player.mouse)}function Z(e){r.enabled&&r.pointerUp(r.player.mouse)}B("worldPosition",D),B("worldPositionStart",S),B("worldQuaternion",L),B("worldQuaternionStart",C),B("cameraPosition",x),B("cameraQuaternion",T),B("pointStart",m),B("pointEnd",v),B("rotationAxis",y),B("rotationAngle",E),B("eye",H),t.addEventListener("mousedown",U,!1),t.addEventListener("touchstart",U,!1),t.addEventListener("mousemove",j,!1),t.addEventListener("touchmove",j,!1),t.addEventListener("touchmove",_,!1),document.addEventListener("mouseup",Z,!1),t.addEventListener("touchend",Z,!1),t.addEventListener("touchcancel",Z,!1),t.addEventListener("touchleave",Z,!1),this.dispose=function(){t.removeEventListener("mousedown",U),t.removeEventListener("touchstart",U),t.removeEventListener("mousemove",j),document.removeEventListener("mousemove",_),t.removeEventListener("touchmove",j),t.removeEventListener("touchmove",_),document.removeEventListener("mouseup",Z),t.removeEventListener("touchend",Z),t.removeEventListener("touchcancel",Z),t.removeEventListener("touchleave",Z),this.traverse((function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}))},this.attach=function(e){return this.object=e,this.visible=!0,W.isTyping=!0,this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,W.isTyping=!1,this},this.setSize=function(e,t){this.fatLineMats.forEach((function(e){}))},this.player.$app.core.get("SceneRenderer").addComponent(this),this.switchEditState=function(e){"overlay"==e||"panovideo"==e&&(this.mode="scale"),this.editState=e},this.handleDragStart=function(){this.editState&&this.onPointerDown()},this.handleDragging=function(){this.editState&&this.onPointerMove()},this.handleDragEnd=function(){this.editState&&this.onPointerUp()},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(k,M,I),this.object.matrixWorld.decompose(D,L,V),R.copy(M).inverse(),z.copy(L).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(x,T,P),H.copy(x).sub(D).normalize(),Ho.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){var t=new THREE.Vector3(e.x,e.y,-1).unproject(this.camera);u.set(t,this.player.getMouseDirection(e));var n=u.intersectObjects(o.picker[this.mode].children,!0)[0]||!1;n?(this.axis=n.object.name,this.intersect=n.object,this.player.domElement.style.cursor="pointer"):(this.intersect=null,this.axis=null,this.player.domElement.style.cursor="")}},this.pointerDown=function(e){if(!(void 0===this.object||!0===this.dragging||void 0!==e.button&&0!==e.button||0!==e.button&&void 0!==e.button||null===this.axis)){var t=new THREE.Vector3(e.x,e.y,-1).unproject(this.camera);u.set(t,this.player.getMouseDirection(e));var n=u.intersectObjects([i],!0)[0]||!1;if(n){var o=this.space;if("scale"===this.mode?o="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(o="world"),"local"===o&&"rotate"===this.mode){var r=this.rotationSnap;"X"===this.axis&&r&&(this.object.rotation.x=Math.round(this.object.rotation.x/r)*r),"Y"===this.axis&&r&&(this.object.rotation.y=Math.round(this.object.rotation.y/r)*r),"Z"===this.axis&&r&&(this.object.rotation.z=Math.round(this.object.rotation.z/r)*r)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),O.copy(this.object.position),F.copy(this.object.quaternion),N.copy(this.object.scale),this.object.matrixWorld.decompose(S,C,A),m.copy(n.point).sub(S),this.player.cameraControls.activeControl&&(this.player.cameraControls.activeControl.enabled=!1)}this.dragging=!0,s.mode=this.mode,this.dispatchEvent(s)}},this.pointerMove=function(e){var t=this.axis,o=this.mode,r=this.object,s=this.space;if("scale"===o?s="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(s="world"),console.log(t),void 0!==r&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){var l=new THREE.Vector3(e.x,e.y,-1).unproject(this.camera);u.set(l,this.player.getMouseDirection(e));var x=u.intersectObjects([i],!0)[0]||!1;if(!1!==x){if(v.copy(x.point).sub(S),"translate"===o){if(g.copy(v).sub(m),"local"===s&&"XYZ"!==t&&g.applyQuaternion(z),-1===t.indexOf("X")&&(g.x=0),-1===t.indexOf("Y")&&(g.y=0),-1===t.indexOf("Z")&&(g.z=0),"local"===s&&"XYZ"!==t?g.applyQuaternion(F).divide(I):g.applyQuaternion(R).divide(I),r.overlayType){var T=r.floor.boundingBox.min.y-g.y-O.y;T>0&&T<.024&&(g.y=r.floor.boundingBox.min.y-O.y)}r.position.copy(g).add(O),this.translationSnap&&("local"===s&&(r.position.applyQuaternion(p.copy(F).inverse()),-1!==t.search("X")&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.position.applyQuaternion(F)),"world"===s&&(r.parent&&r.position.add(h.setFromMatrixPosition(r.parent.matrixWorld)),-1!==t.search("X")&&(r.position.x=Math.round(r.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(r.position.y=Math.round(r.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(r.position.z=Math.round(r.position.z/this.translationSnap)*this.translationSnap),r.parent&&r.position.sub(h.setFromMatrixPosition(r.parent.matrixWorld))))}else if("scale"===o){if(-1!==t.search("XYZ")){var P=v.length()/m.length();v.dot(m)<0&&(P*=-1),n.NoScaleZ?d.set(P,P,1):d.set(P,P,P)}else h.copy(m),d.copy(v),h.applyQuaternion(z),d.applyQuaternion(z),d.divide(h),-1===t.search("X")&&(d.x=1),-1===t.search("Y")&&(d.y=1),-1===t.search("Z")&&(d.z=1);if("overlay"==this.editState){if(N.x*d.x*He.overlay.width<.1)return;if(N.x*d.x*He.overlay.width>10)return;if(N.y*d.y*He.overlay.height<.1)return;if(N.y*d.y*He.overlay.height>10)return}r.scale.copy(N).multiply(d),this.scaleSnap&&(-1!==t.search("X")&&(r.scale.x=Math.round(r.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(r.scale.y=Math.round(r.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(r.scale.z=Math.round(r.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap)),"overlay"==this.editState&&(r.width=He.overlay.width*r.scale.x,r.height=He.overlay.height*r.scale.y,this.player.EditOverlay.updateOverlayScaleDisplay())}else if("rotate"===o){if(g.copy(v).sub(m),"floorplan"==this.player.mode)var k=this.player.cameraControls.cameras.floorplan,M=5/((k.right-k.left)/k.aspect);else M=5/D.distanceTo(h.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(y.copy(H),E=v.angleTo(m),w.copy(m).normalize(),b.copy(v).normalize(),E*=b.cross(w).dot(H)<0?1:-1):"XYZE"===t?(y.copy(g).cross(H).normalize(),E=g.dot(h.copy(y).cross(this.eye))*M):"X"!==t&&"Y"!==t&&"Z"!==t||(y.copy(f[t]),h.copy(f[t]),"local"===s&&h.applyQuaternion(L),E=g.dot(h.cross(H).normalize())*M),this.rotationSnap&&(E=Math.round(E/this.rotationSnap)*this.rotationSnap),this.rotationAngle=E,"local"===s&&"E"!==t&&"XYZE"!==t?(r.quaternion.copy(F),r.quaternion.multiply(p.setFromAxisAngle(y,E)).normalize()):(y.applyQuaternion(R),r.quaternion.copy(p.setFromAxisAngle(y,E)),r.quaternion.multiply(F).normalize())}this.dispatchEvent(a),this.dispatchEvent(c)}}},this.pointerUp=function(e){this.dragging&&null!==this.axis&&(l.mode=this.mode,this.dispatchEvent(l)),this.dragging=!1,void 0===e.button&&(this.axis=null),this.player.cameraControls.activeControl&&(this.player.cameraControls.activeControl.pointerDragOn=!1,this.player.cameraControls.activeControl.enabled=!0)},this.onPointerDown=U,this.onPointerMove=_,this.onPointerUp=Z,this.getMode=function(){return r.mode},this.setMode=function(e){r.mode=e},this.setTranslationSnap=function(e){r.translationSnap=e},this.setRotationSnap=function(e){r.rotationSnap=e},this.setScaleSnap=function(e){r.scaleSnap=e},this.setSpace=function(e){r.space=e},this.update=function(){console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}};_o.prototype=Object.assign(Object.create(Ho.prototype),{constructor:_o,isTransformControls:!0});var Wo=function(e){Ho.call(this),this.type="TransformControlsGizmo",this.player=e.player;var t=new Vo({depthTest:!1,depthWrite:!1,transparent:!0,side:Io,fog:!1}),n=new Do({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),o=t.clone();o.opacity=.35;var i=t.clone();i.opacity=.1;var r=t.clone();r.color.set(16711680);var a=t.clone();a.color.set(65280);var s=t.clone();s.color.set(255);var l=t.clone();l.opacity=.75,l.color.set(53501),l.clone().color.set(16776960),l.clone().color.set(65535),l.clone().color.set(16711935),t.clone().color.set(16776960);var c=n.clone();c.color.set(16711680);var u=An.createFatLineMat({width:3,color:16711680,alwaysShow:!0,opacity:.9});e.fatLineMats.push(u);var h=n.clone();h.color.set(65280);var d=An.createFatLineMat({width:3,color:65280,alwaysShow:!0,opacity:.9});e.fatLineMats.push(d);var p=n.clone();p.color.set(255);var f=An.createFatLineMat({width:3,color:255,alwaysShow:!0,opacity:.9});e.fatLineMats.push(f),n.clone().color.set(65535),n.clone().color.set(16711935);var m=n.clone();m.color.set(16776960);var v=n.clone();v.color.set(7895160),m.clone().opacity=.25;var g=new Ro(0,.07,.2,12,1,!1),y=new Po(.125,.125,.125),w=new ko;w.addAttribute("position",new Co([0,0,0,1,0,0],3));var b={},E=An.createFatLine([0,0,0,.5,0,0],{});b["x+"]=E.geometry,E=An.createFatLine([0,0,0,-.5,0,0],{}),b["x-"]=E.geometry,E=An.createFatLine([0,0,0,0,.5,0],{}),b["y+"]=E.geometry,E=An.createFatLine([0,0,0,0,-.5,0],{}),b["y-"]=E.geometry,E=An.createFatLine([0,0,0,0,0,.5],{}),b["z+"]=E.geometry,E=An.createFatLine([0,0,0,0,0,-.5],{}),b["z-"]=E.geometry;var x,T=function(e,t){var n=new THREE.Line(e,t);return n.computeLineDistances(),n.scale.set(1,1,1),n.renderOrder=4,n},P=function(e,t){for(var n=new ko,o=[],i=0;i<=64*t;++i)o.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return n.addAttribute("position",new Co(o,3)),n},k={X:[[new zo(g,r),[.5,0,0],[0,0,-Math.PI/2],null,"fwd"],[T(b["x+"],u)]],Y:[[new zo(g,a),[0,.5,0],null,null,"fwd"],[T(b["y+"],d)]],Z:[[new zo(g,s),[0,0,.5],[Math.PI/2,0,0],null,"fwd"],[T(b["z+"],f)]]},M={X:[[new zo(new Ro(.2,0,.5,4,1,!1),o),[.3,0,0],[0,0,-Math.PI/2]]],Y:[[new zo(new Ro(.2,0,.5,4,1,!1),o),[0,.3,0]]],Z:[[new zo(new Ro(.2,0,.5,4,1,!1),o),[0,0,.3],[Math.PI/2,0,0]]]},R={START:[[new zo(new Oo(.01,2),i),null,null,null,"helper"]],END:[[new zo(new Oo(.01,2),i),null,null,null,"helper"]],DELTA:[[new Ao((x=new ko,x.addAttribute("position",new Co([0,0,0,1,1,1],3)),x),i),null,null,null,"helper"]],X:[[new Ao(w,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Ao(w,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Ao(w,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},I={X:[[new Ao(P(1,.5),c)],[new zo(new Oo(.04,0),r),[0,0,.99],null,[1,3,1]]],Y:[[new Ao(P(1,.5),h),null,[0,0,-Math.PI/2]],[new zo(new Oo(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new Ao(P(1,.5),p),null,[0,Math.PI/2,0]],[new zo(new Oo(.04,0),s),[.99,0,0],null,[1,3,1]]],XYZE:[[new Ao(P(1,1),v),null,[0,Math.PI/2,0]]]},S={AXIS:[[new Ao(w,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},C={X:[[new zo(new jo(1,.1,4,24),o),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new zo(new jo(1,.1,4,24),o),[0,0,0],[Math.PI/2,0,0]]],Z:[[new zo(new jo(1,.1,4,24),o),[0,0,0],[0,0,-Math.PI/2]]]},A={X:[[new zo(y,r),[.5,0,0],[0,0,-Math.PI/2]],[T(b["x+"],u),null,null]],Y:[[new zo(y,a),[0,.5,0]],[T(b["y+"],d)]],XYZX:[[new zo(new Po(.125,.125,.125),l.clone()),[.5,.5,0]]]},D={X:[[new zo(new Ro(.2,0,.5,4,1,!1),o),[.3,0,0],[0,0,-Math.PI/2]]],Y:[[new zo(new Ro(.2,0,.5,4,1,!1),o),[0,.3,0]]],XYZX:[[new zo(new Po(.2,.2,.2),o),[.5,.5,0]]]},L={X:[[new Ao(w,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Ao(w,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Ao(w,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},z=function(e){var t=new Ho;for(var n in e)for(var o=e[n].length;o--;){var i=e[n][o][0].clone(),r=e[n][o][1],a=e[n][o][2],s=e[n][o][3],l=e[n][o][4];if(i.name=n,i.tag=l,r&&i.position.set(r[0],r[1],r[2]),a&&i.rotation.set(a[0],a[1],a[2]),s&&i.scale.set(s[0],s[1],s[2]),i.updateMatrix(),i.geometry.clone()){var c=i.geometry.clone();c.applyMatrix(i.matrix),i.geometry=c}else i.geometry.applyMatrix(i.matrix);i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t},V=new Uo(0,0,0),H=new So,O=new Uo(0,1,0),F=new Uo(0,0,0),N=new Lo,B=new No,j=new No,U=new No,_=new Uo(1,0,0),W=new Uo(0,1,0),Z=new Uo(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=z(k)),this.add(this.gizmo.rotate=z(I)),this.add(this.gizmo.scale=z(A)),this.add(this.picker.translate=z(M)),this.add(this.picker.rotate=z(C)),this.add(this.picker.scale=z(D)),this.add(this.helper.translate=z(R)),this.add(this.helper.rotate=z(S)),this.add(this.helper.scale=z(L)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var t=this.space;"scale"===this.mode&&(t="local");var n="local"===t?this.worldQuaternion:U;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var o=[];o=(o=(o=o.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);var i=this.worldPosition.distanceTo(this.cameraPosition);if("transitioning"!=this.player.mode||"floorplan"!=this.player.modeTran.split("-")[0]&&"floorplan"!=this.player.modeTran.split("-")[1]){if("floorplan"==this.player.mode){i=((r=this.player.cameraControls.cameras.floorplan).right-r.left)/r.aspect}}else{var r,a=((r=this.player.cameraControls.cameras.floorplan).right-r.left)/r.aspect;i=Math.min(i,a)}for(var s=i*this.size/7,l=0;l<o.length;l++){var c=o[l];if(c.visible=!0,c.rotation.set(0,0,0),c.position.copy(this.worldPosition),c.scale.set(1,1,1).multiplyScalar(s),"helper"!==c.tag){if(c.quaternion.copy(n),"translate"===this.mode||"scale"===this.mode){var u=.99;e.dontHideWhenFaceCamera||("X"!==c.name&&"XYZX"!==c.name||Math.abs(O.copy(_).applyQuaternion(n).dot(this.eye))>u&&(c.scale.set(1e-10,1e-10,1e-10),c.visible=!1),"Y"!==c.name&&"XYZY"!==c.name||Math.abs(O.copy(W).applyQuaternion(n).dot(this.eye))>u&&(c.scale.set(1e-10,1e-10,1e-10),c.visible=!1),"Z"!==c.name&&"XYZZ"!==c.name||Math.abs(O.copy(Z).applyQuaternion(n).dot(this.eye))>u&&(c.scale.set(1e-10,1e-10,1e-10),c.visible=!1),"XY"===c.name&&Math.abs(O.copy(Z).applyQuaternion(n).dot(this.eye))<.2&&(c.scale.set(1e-10,1e-10,1e-10),c.visible=!1),"YZ"===c.name&&Math.abs(O.copy(_).applyQuaternion(n).dot(this.eye))<.2&&(c.scale.set(1e-10,1e-10,1e-10),c.visible=!1),"XZ"===c.name&&Math.abs(O.copy(W).applyQuaternion(n).dot(this.eye))<.2&&(c.scale.set(1e-10,1e-10,1e-10),c.visible=!1));var h=!1;O.copy(Z).applyQuaternion(n).dot(this.eye)<0&&(h=!0),-1!==c.name.search("X")&&(O.copy(_).applyQuaternion(n).dot(this.eye)<0?(c instanceof THREE.Line?c.geometry=b["x-"]:c.scale.x*=-1,this.parent.object&&c.position.add(new THREE.Vector3(-this.parent.object.width/2,0,h||"XYZX"==c.name?0:this.parent.object.depth).applyQuaternion(c.quaternion))):(c instanceof THREE.Line&&(c.geometry=b["x+"]),this.parent.object&&c.position.add(new THREE.Vector3(this.parent.object.width/2,0,h||"XYZX"==c.name?0:this.parent.object.depth).applyQuaternion(c.quaternion)))),-1!==c.name.search("Y")&&(O.copy(W).applyQuaternion(n).dot(this.eye)<0?(c instanceof THREE.Line?c.geometry=b["y-"]:c.scale.y*=-1,this.parent.object&&c.position.add(new THREE.Vector3(0,-this.parent.object.height/2,h||"XYZX"==c.name?0:this.parent.object.depth).applyQuaternion(c.quaternion))):(c instanceof THREE.Line&&(c.geometry=b["y+"]),this.parent.object&&c.position.add(new THREE.Vector3(0,this.parent.object.height/2,h||"XYZX"==c.name?0:this.parent.object.depth).applyQuaternion(c.quaternion)))),-1!==c.name.search("Z")&&(h?c instanceof THREE.Line?c.geometry=b["z-"]:c.scale.z*=-1:(c instanceof THREE.Line&&(c.geometry=b["z+"]),this.parent.object&&c.position.add(new THREE.Vector3(0,0,this.parent.object.depth).applyQuaternion(c.quaternion))))}else"rotate"===this.mode&&(j.copy(n),O.copy(this.eye).applyQuaternion(B.copy(n).inverse()),-1!==c.name.search("E")&&c.quaternion.setFromRotationMatrix(N.lookAt(this.eye,F,W)),"X"===c.name&&(B.setFromAxisAngle(_,Math.atan2(-O.y,O.z)),B.multiplyQuaternions(j,B),c.quaternion.copy(B)),"Y"===c.name&&(B.setFromAxisAngle(W,Math.atan2(O.x,O.z)),B.multiplyQuaternions(j,B),c.quaternion.copy(B)),"Z"===c.name&&(B.setFromAxisAngle(Z,Math.atan2(O.y,O.x)),B.multiplyQuaternions(j,B),c.quaternion.copy(B)));c.visible=c.visible&&(-1===c.name.indexOf("X")||this.showX),c.visible=c.visible&&(-1===c.name.indexOf("Y")||this.showY),c.visible=c.visible&&(-1===c.name.indexOf("Z")||this.showZ),c.visible=c.visible&&(-1===c.name.indexOf("E")||this.showX&&this.showY&&this.showZ),c.material._opacity=c.material._opacity||c.material.opacity,c.material._color=c.material._color||c.material.color.clone(),c.material.color.copy(c.material._color),c.material.opacity=c.material._opacity,this.enabled?this.axis&&(c.name===this.axis||this.axis.split("").some((function(e){return c.name===e}))?(c.material.opacity=1,c.material.color.lerp(new Mo(1,1,1),.5)):(c.material.opacity*=.25,c.material.color.lerp(new Mo(1,1,1),.5))):(c.material.opacity*=.5,c.material.color.lerp(new Mo(1,1,1),.5))}else c.visible=!1,"AXIS"===c.name?(c.position.copy(this.worldPositionStart),c.visible=!!this.axis,"X"===this.axis&&(B.setFromEuler(H.set(0,0,0)),c.quaternion.copy(n).multiply(B),Math.abs(O.copy(_).applyQuaternion(n).dot(this.eye))>.9&&(c.visible=!1)),"Y"===this.axis&&(B.setFromEuler(H.set(0,0,Math.PI/2)),c.quaternion.copy(n).multiply(B),Math.abs(O.copy(W).applyQuaternion(n).dot(this.eye))>.9&&(c.visible=!1)),"Z"===this.axis&&(B.setFromEuler(H.set(0,Math.PI/2,0)),c.quaternion.copy(n).multiply(B),Math.abs(O.copy(Z).applyQuaternion(n).dot(this.eye))>.9&&(c.visible=!1)),"XYZE"===this.axis&&(B.setFromEuler(H.set(0,Math.PI/2,0)),O.copy(this.rotationAxis),c.quaternion.setFromRotationMatrix(N.lookAt(F,O,W)),c.quaternion.multiply(B),c.visible=this.dragging),"E"===this.axis&&(c.visible=!1)):"START"===c.name?(c.position.copy(this.worldPositionStart),c.visible=this.dragging):"END"===c.name?(c.position.copy(this.worldPosition),c.visible=this.dragging):"DELTA"===c.name?(c.position.copy(this.worldPositionStart),c.quaternion.copy(this.worldQuaternionStart),V.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),V.applyQuaternion(this.worldQuaternionStart.clone().inverse()),c.scale.copy(V),c.visible=this.dragging):(c.quaternion.copy(n),this.dragging?c.position.copy(this.worldPositionStart):c.position.copy(this.worldPosition),this.axis&&(c.visible=-1!==this.axis.search(c.name)))}Ho.prototype.updateMatrixWorld.call(this)}};Wo.prototype=Object.assign(Object.create(Ho.prototype),{constructor:Wo,isTransformControlsGizmo:!0});var Zo=function(e){zo.call(this,new Fo(1e4,1e4,2,2),new Vo({color:"#ff0000",visible:!1,wireframe:!0,side:Io,transparent:!0,opacity:.6})),this.type="TransformControlsPlane";var t=new Uo(1,0,0),n=new Uo(0,1,0),o=new Uo(0,0,1),i=new Uo,r=new Uo,a=new Uo,s=new Lo,l=new No;this.updateMatrixWorld=function(){var e=this.space;switch(this.parent.intersect?this.position.copy(this.parent.intersect.position):this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),t.set(1,0,0).applyQuaternion("local"===e?this.worldQuaternion:l),n.set(0,1,0).applyQuaternion("local"===e?this.worldQuaternion:l),o.set(0,0,1).applyQuaternion("local"===e?this.worldQuaternion:l),a.copy(n),this.mode){case"translate":case"scale":switch(this.axis){case"X":a.copy(this.eye).cross(t),r.copy(t).cross(a);break;case"Y":a.copy(this.eye).cross(n),r.copy(n).cross(a);break;case"Z":a.copy(this.eye).cross(o),r.copy(o).cross(a);break;case"XY":r.copy(o);break;case"YZ":r.copy(t);break;case"XZ":a.copy(o),r.copy(n);break;case"XYZ":case"E":default:r.set(0,0,0)}break;case"rotate":default:r.set(0,0,0)}0===r.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(i.set(0,0,0),r,a),this.quaternion.setFromRotationMatrix(s)),Ho.prototype.updateMatrixWorld.call(this)}};Zo.prototype=Object.assign(Object.create(zo.prototype),{constructor:Zo,isTransformControlsPlane:!0});new THREE.Box2;var Qo="move",Go="rotate",qo="zoom",Yo="endRotation",$o="moveModel",Xo="mode.changed",Jo="mode.changing",Ko="pano.chosen",ei="closest.pano.changing",ti="flyin.finished",ni="flying.started",oi="flying.ended",ii="ready",ri="start.inside",ai="start.outside",si="view.changed",li="warp.interrupted.flyto",ci="input.start",ui=function(){function e(t){i(this,e),this.app=t,this.config=this.app.config,this.show=!0,this.done=0,this.ready=!1,this.deferred=_e()}return u(e,[{key:"init",value:function(e){var t=this;this.player=this.app.core.get("Player"),this.model=e,this.app.store.getValue("flooruser")?this.createCad():this.app.store.on("flooruser",(function(){return t.createCad()})),this.player.on(Jo,(function(e,n,o){n==Oe.FLOORPLAN?t.showCad():t.hideCad()}))}},{key:"showCad",value:function(){var e=this;if(this.show){if(!this.ready)return this.deferred.then((function(){return e.showCad()}));this.hideCad();var t=this.model.floors.index[this.model.currentFloor.floorIndex].plane;t&&(t.material.opacity=1,t.visible=!0)}}},{key:"hideCad",value:function(){var e=this;if(!this.ready)return this.deferred.then((function(){return e.hideCad()}));this.model.floors.forEach((function(e){e.plane?(e.plane.visible=!1,e.plane.material.opacity=0):console.warn("还没有创建plane")}))}},{key:"displayCad",value:function(e){this.show=e,this.show?this.showCad():this.hideCad()}},{key:"createCad",value:function(){var e=this,t=new THREE.TextureLoader;this.model.floors.forEach((function(n){n.floorTexture&&(n.floorTexture.dispose(),n.floorTexture=null),t.load(e.app.resource.getUserResourceURL("floor-cad-".concat(n.floorIndex,".png")),(function(t){t.needsUpdate=!0,n.floorTexture=t,e.createPlane(n.floorIndex)}),(function(t){++e.done==e.model.floors.length&&(e.ready=!0,e.deferred.resolve()),console.warn("没有floorplan_".concat(n.floorIndex,".png"))}))}))}},{key:"createPlane",value:function(e){var t=this.model.floors.index[e],n=t.boundingBox,o=this.center=n.getCenter(),i=n.getSize(),r=new THREE.PlaneBufferGeometry(1,1),a=null,s=this.getCadInfo(e);if(!s||this.app.store.getValue("flooruser").vesion)a=new THREE.Mesh(r,new THREE.MeshBasicMaterial({map:null,opacity:0,transparent:!0,side:THREE.DoubleSide,depthTest:!1,visible:!1}));else{var l=new THREE.MeshBasicMaterial({map:t.floorTexture,opacity:this.player.modeTran&&"floorplan"==this.player.modeTran.split("-")[1]?1:0,transparent:!0,side:THREE.DoubleSide,depthTest:!1});l.needsUpdate=!0,a=new THREE.Mesh(r,l),s.bound&&(i.x=s.bound.right-s.bound.left,i.z=s.bound.bottom-s.bound.top,o.x=(s.bound.right+s.bound.left)/2,o.z=(s.bound.bottom+s.bound.top)/2)}this.model.add(a),t.plane=a,a.rotateX(-Math.PI/2);var c=this.app.store.getValue("metadata"),u=parseFloat(c.floorPlanAngle||0);a.rotateZ(u),a.renderOrder=10,a.name="floorplanImg",s&&this.adjustPlane(n,e,i,o,!1,s),this.changeModelOpacity(e),this.changeCadVisible(null,{autoJudge:!0}),++this.done==this.model.floors.length&&(this.ready=!0,this.deferred.resolve(),this.player.mode==Oe.FLOORPLAN&&this.showCad())}},{key:"updatePlanes",value:function(){var e=this,t=new THREE.TextureLoader;this.model.floors.forEach(function(){var n=S(C.mark((function n(o){return C.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o.floorTexture&&(o.floorTexture.dispose(),o.floorTexture=null),t.load(e.app.resource.getUserResourceURL("floor-cad-".concat(o.floorIndex,".png"),!0),(function(t){t.needsUpdate=!0,o.floorTexture=t,e.updatePlane(o.floorIndex,t)}),(function(t){++e.done==e.model.floors.length&&(e.ready=!0,e.deferred.resolve()),console.warn("没有 floorplan_".concat(o.floorIndex,".png"))}));case 2:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}},{key:"updatePlane",value:function(e,t){var n=this.model.floors.index[e],o=n.boundingBox,i=this.center=o.getCenter(),r=o.getSize();n.plane.renderOrder=10,n.plane.name="floorplanImg";var a=this.app.store.getValue("metadata"),s=parseFloat(a.floorPlanAngle||0);n.plane.rotation.z=0,n.plane.rotateZ(s);var l=this.getCadInfo(e);console.log(l,"----after"),!l||this.app.store.getValue("flooruser").vesion?(n.plane.material.opacity=0,n.plane.material.map=null,n.plane.material.needsUpdate=!0,n.plane.material.visible=!1):l.bound&&(r.x=l.bound.right-l.bound.left,r.z=l.bound.bottom-l.bound.top,i.x=(l.bound.right+l.bound.left)/2,i.z=(l.bound.bottom+l.bound.top)/2,n.plane.material.map=t,n.plane.material.needsUpdate=!0,n.plane.material.visible=!0,this.adjustPlane(o,e,r,i,!1,l)),this.changeModelOpacity(e),this.changeCadVisible(null,{autoJudge:!0}),++this.done==this.model.floors.length&&(this.ready=!0,this.deferred.resolve())}},{key:"getCadInfo",value:function(e){var t=this.app.store.getValue("flooruser").cadInfo;if(t instanceof Array)if(1==this.model.floors.list.length)t=t[0];else{var n=t.find((function(t){return t.subgroup==e}));n||(n=t[e]),t=n}else if(!t){for(var o=this.app.store.getValue("floorcad").floors,i=0;i<o.length;++i)if(o[i].subgroup==e){t=o[i].cadInfo;break}if(t){this.model.floors.index[e].floorTexture.image.width=1920,this.model.floors.index[e].floorTexture.image.height=937;var r=this.getScreenXY({x:t.cadBoundingBox.x_min,y:t.cadBoundingBox.y_max},t),a=this.getScreenXY({x:t.cadBoundingBox.x_max,y:t.cadBoundingBox.y_min},t);t.left=r.x,t.top=r.y,t.right=this.model.floors.index[e].floorTexture.image.width-a.x,t.bottom=this.model.floors.index[e].floorTexture.image.height-a.y,t.bound={},t.bound.top=-1*t.cadBoundingBox.y_max,t.bound.bottom=-1*t.cadBoundingBox.y_min,t.bound.left=t.cadBoundingBox.x_min,t.bound.right=t.cadBoundingBox.x_max}}return t}},{key:"getCurrentScale",value:function(e){e=e.clone().applyEuler(new THREE.Euler(0,0,0));return Math.max(Math.abs(e.x),Math.abs(e.z)*(1920/937))/2/10*Math.max(1.62,1.2)}},{key:"getScreenXY",value:function(e,t){var n=e.x,o=e.y,i=960+(n-this.model.center.x)*t.res,r=468.5-(o+this.model.center.z)*t.res;return i=.5+i<<0,r=.5+r<<0,{x:1*Math.floor(i),y:1*Math.floor(r)}}},{key:"adjustPlane",value:function(e,t,n,o,i,r){var a=this.model.floors.index[t];if(i)a.plane.position.y=e.max.y+.1;else{n=n||e.getSize(),o=o||e.getCenter();var s=a.floorTexture.image.width,l=a.floorTexture.image.height,c=a.cadImgRatio=n.x/(s-r.left-r.right),u=c*s,h=c*l;this.width=u,this.height=h;var d=(r.left-r.right)/2*c,p=(r.top-r.bottom)/2*c;a.plane.position.set(o.x-d,e.max.y+.1,o.z-p),a.plane.scale.set(u,h,1),this.player.planLabels.forEach((function(e){return e.update()}))}}},{key:"changeModelOpacity",value:function(e){}},{key:"changeCadVisible",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};null!=t.show&&(this.show=t.show),t.autoJudge,this.model.floors.forEach((function(t){t.plane?t.plane.visible=!!e:console.warn("还没有创建plane")}))}},{key:"remove",value:function(){this.model.floors.forEach((function(e){null!=e.plane&&(e.plane.parent.remove(e.plane),e.plane.geometry.dispose(),e.plane.material.dispose(),e.plane=null),e.cadImgRatio=null})),this.removeEntryArrow(),this.removeRoomLabels(),this.show=null,this.initedCad=!1}},{key:"changePlaneOpacity",value:function(e,t,n){}}]),e}();function hi(e,t){var n=this;this.player=t,this.sid=e.sid,this.setPoints(e.points),this.state=e.state||"active",this.elem=document.createElement("div"),this.elem.className="ruler",this.elem.setAttribute("data-name",""),this.elem.style.display="none",document.querySelector(".widgets-rulers").append(this.elem),this.text=e.text||"",this.length=Math.round(100*this.points[0].distanceTo(this.points[1]))/100,this.text="约"+this.length+"米",window.ifTest&&e.color&&setTimeout((function(){n.elem.querySelector("em").background=e.color}),1e3),this.elem.innerHTML='\n\t\t<div class="ruler-line">\n\t\t\t<em></em>\n\t\t\t<div class="ruler-label">\n\t\t\t\t<div class="ruler-label-point"></div>\n\t\t\t\t<span class="ruler-label-name">'.concat(this.text,"</span>\n\t\t\t</div>\n\t\t</div>\n\t"),this.player.cornerRulers.push(this)}hi.prototype.setPoints=function(e){this.points=e},hi.prototype.remove=function(){this.elem.remove()},hi.prototype.getCrossPoint=function(e,t){var n,o,i,r=objects.player.domElement.clientWidth,a=objects.player.domElement.clientHeight,s=(t.x-e.x)/(t.y-e.y),l=function(t){return s*(t-e.y)+e.x},c=function(t){return 1/s*(t-e.x)+e.y};return t.x>r||t.x<0?(i=t.x>r?r:0,t.y<0||t.y>a?((n=l(o=t.y<0?0:a))>r||n<0)&&(o=c(n=i)):o=c(n=i)):n=l(o=t.y<0?0:a),new THREE.Vector2(n,o)},hi.prototype.getPosInCrossPoint=function(e,t){var n=objects.player.domElement.clientWidth,o=objects.player.domElement.clientHeight;return be.getCrossPointAtRect(e,t,n,o,0,0)},hi.prototype.getPosAtSphere=function(e){this.fishPoints=[],this.points.forEach(function(t){var n=Pe.getPosAtSphere(t.clone(),e);this.fishPoints.push(n)}.bind(this))};hi.prototype.getPosInScreen=function(e,t,n){var o=e.point.clone().add(t.point).multiplyScalar(.5),i=Pe.getPos2d(o);if(i.trueSide){var r=e.pos2d.trueSide?e.pos2d:t.pos2d;return i.inSight&&(i.pos=this.getPosInCrossPoint(r.pos,i.pos),i.vector=null),{result:"p1p2",p1:r,p2:i}}if(!(n+1>1)){var a=e.pos2d.trueSide?e:t;return this.getPosInScreen(a,{point:o,pos2d:i},++n)}},hi.prototype.update=function(){if("panorama"==objects.player.mode&&"active"==this.state){var e=Pe.getPos2d(this.points[0]),t=Pe.getPos2d(this.points[1]);if(!e.trueSide||!t.trueSide){if(!e.trueSide&&!t.trueSide)return void this.elem.css("display","none");var n=this.getPosInScreen({point:this.points[0],pos2d:e},{point:this.points[1],pos2d:t},0);if(!n)return void this.elem.css("display","none");e=n.p1,t=n.p2}var o=e.pos,i=t.pos,r=o.distanceTo(i);if(0!=r){var a=Math.acos((o.x-i.x)/r);a%=360,a*=180/Math.PI;var s=o.clone().sub(i),l=new THREE.Vector3(s.x,s.y,0),c=new THREE.Vector3(1,0,0);a*=l.cross(c).z>0?1:-1,this.elem.find(".ruler-line").css({width:r+"px",left:t.pos.x+"px",top:t.pos.y+"px",transform:"rotate("+-a+"deg)"});var u,h,d=.5,p=objects.player.domElement.clientWidth,f=objects.player.domElement.clientHeight;if(e.inSight&&t.inSight)u=(o.x+i.x)/2;else{var m,v;m=e.inSight?o.clone():this.getCrossPoint(i,o),v=t.inSight?i.clone():this.getCrossPoint(o,i);var g=m.clone().add(v).multiplyScalar(.5);if(u=g.x,h=g.y,g.x>p||g.x<0||g.y>f||g.y<0)return void this.elem.css("display","none");if(i.x==o.x){if(i.y==o.y)return void console.warn("pos1和2一样？？？");d=i.y<o.y?(h-i.y)/(o.y-i.y):(i.y-h)/(i.y-o.y)}else d=i.x<o.x?(u-i.x)/(o.x-i.x):(i.x-u)/(i.x-o.x);if(d<0||d>1)return void this.elem.css("display","none")}this.elem.css("display",""),"left"!=this.dir&&u<p/2||"right"==this.dir?this.elem.find(".ruler-label").addClass("reverse"):this.elem.find(".ruler-label").removeClass("reverse"),this.elem.find(".ruler-label").css({transform:"rotate("+a+"deg)",left:100*d+"%"})}else console.warn("ruler间距为0！")}else this.elem.css("display","none")};var di,pi=function(){function e(t){i(this,e),this.updateRulersVisi=function(e){var t,n=objects.player;if(this.roomInfo)if(window.showAllRulerForTest)n.cornerRulers.forEach((function(e){e.state="active",e.update()}));else{if(!1===e||!this.rulerVisi||config.isEdit&&(objects.mainDesign&&objects.mainDesign.editing||"screen"==store.getters.page)||"panorama"!=n.mode||settings.vrEnabled||!n.currentPano||1==this.version&&null==n.currentPano.belongToRoom||objects.tagManager.editSpot.setSpotPos||!n.currentPano.isAligned()||n.enteringView||n.EditOverlay&&n.EditOverlay.editing||n.EditPanoVideo&&n.EditPanoVideo.editing)return t&&[t.horizon,t.verti&&t.verti,t.last&&t.last.horizon].forEach((function(e){e&&(e.state="unable",e.update())})),void(t=null);var o=n.currentPano.visibleRulerInfos;if(o){var i=[],r=n.getDirection().setY(0).normalize(),a=[function(e){return-e.pointBtm.distanceTo(n.position)/3},function(e){var t=e.pointBtm.clone().sub(n.position).setY(0).normalize(),o=r.dot(t);return 10*Math.pow(o,3)},function(e){var t=2;return e.horizon.length<.4&&(!e.last||e.last.horizon.length<.4)&&(t-=1),t}],s=common.sortByScore(o,[],a);if(s&&s[0]&&s[0].item!=t||(!s||!s[0])&&t){if(t&&(t.horizon.state="unable",i.push(t.horizon),t.verti&&(t.verti.state="unable",i.push(t.verti)),t.last&&(t.last.horizon.state="unable",i.push(t.last.horizon))),s&&s[0]){(t=s[0].item).horizon.state="active",t.verti&&(t.verti.state="active"),t.last&&(t.last.horizon.state="active");var l=t.pointBtm.distanceTo(n.currentPano.origin);l>2*t.horizon.length?t.horizon.dir=this.isClockWise?"left":"right":t.horizon.dir="",t.last&&(l>2*t.last.horizon.length?t.last.horizon.dir=this.isClockWise?"right":"left":t.last.horizon.dir="")}else t=null;n.rulerGroupShowing=t}t&&(i.push(t.horizon),t.last&&i.push(t.last.horizon),t.verti&&i.push(t.verti)),i.forEach((function(e){e.update()}))}}},this.app=t,this.roomInfo={},this.rulerVisi=!1,this.version=2,this.cad=null,this.planeNeedAdjust=[],this.appType=null}return u(e,[{key:"showRule",value:function(e,t){var n=this;this.rulerVisi=e,config.isEdit?e?objects.player.mode&&objects.player.currentPano&&objects.player.FlyToMode("panorama",(function(){n.shineRulers(!0)})):this.shineRulers(!1):("vrhouse"==config.name?"vrhouse"==t||this.cad&&this.initRoomInfo(this.cad):e?this.cad&&this.initRoomInfo(this.cad):(this.initType="noRuler",this.cad&&this.initRoomInfo(this.cad,"noRuler")),this.updateRulersVisi())}},{key:"init",value:function(e){this.model=e}},{key:"beforeInit",value:function(e){return!!e&&((!Object.keys(this.roomInfo).length||!this.roomInfo[Object.keys(this.roomInfo)[0]].rooms.length)&&!!this.app.store.getValue("metadata"))}},{key:"initRoomInfo",value:function(e){var t=this;if(console.log(e),this.beforeInit(e)){new THREE.MeshBasicMaterial({transparent:!0,wireframe:!0,opacity:.3,color:"#ff9999",depthTest:!1,side:THREE.DoubleSide});var n=new THREE.Object3D;this.model.add(n),n.visible=!1,this.cad=e,this.initFloorPlan(e),this.reSetSkyBox(),"noRuler"!=this.initType&&this.model.panos.list.forEach((function(e){t.ifPanoSeePoints(e,t.roomInfo)})),this.rulerVisi&&this.updateRulersVisi(),this.planeNeedAdjust.length&&(this.planeNeedAdjust.forEach((function(e){var n=t.roomInfo[e.index].boundingBox;n.max.y!=-1/0&&t.model.floorplanCadImg.adjustPlane(n,e.index,null,null,e.onlyHeight)})),this.planeNeedAdjust=[])}}},{key:"initFloorPlan",value:function(e){var t=this;e.floors.forEach((function(e,n){var o=[],i=[],r=new THREE.Box3;e.block&&e.block.forEach((function(n,a){var s,l=[],c=n.ground,u=n.wall,h=t.searchItemById(n.top,e["vertex-z"]).z,d=t.searchItemById(n.bottom,e["vertex-z"]).z,p=[];if(c.length>0)c.forEach((function(o,i){var a=t.searchItemById(o,e["vertex-xy"]),s=t.searchItemById(c[(i+1)%c.length],e["vertex-xy"]),f=searchWallByPoint(e,o,c[(i+1)%c.length]),m=u.includes(f);t.dealPointInfo({point1:a,point2:s,points:p,type:"block",top:h,bottom:d,pointInfos:l,parentIndex:n.id,index:i,isOutSide:!m,boundingBox:r}),t.addWall({point1:a,point2:s,top:h,bottom:d,type:"wall",index:n.id+"_"+i})})),s=p.length>2;else if(u.length){var f,m=[];if(u.length>1){var v=t.searchItemById(u[0],e.segment),g=t.searchItemById(u[1],e.segment);if(g.a==v.a||g.b==v.a)f=!0;else{if(g.a!=v.b&&g.b!=v.b)return void console.error("wall不连续？？？ block: ".concat(n.id));f=!1}}u.forEach((function(o,i){var a=t.searchItemById(o,e.segment);if(0==m.length&&!f||m[m.length-1]==a.a){m.push(a.a,a.b);var c=t.searchItemById(a.a,e["vertex-xy"]),u=t.searchItemById(a.b,e["vertex-xy"])}else{if(!(0==m.length&&f||m[m.length-1]==a.b))return void console.error("wall不连续？？wallId:".concat(o," block: ").concat(n.id));c=t.searchItemById(a.b,e["vertex-xy"]),u=t.searchItemById(a.a,e["vertex-xy"]);m.push(a.b,a.a)}t.dealPointInfo({point1:c,point2:u,points:p,type:"block",top:h,bottom:d,pointInfos:l,parentIndex:n.id,index:i,boundingBox:r}),t.addWall({point1:c,point2:u,top:h,bottom:d,type:"wall",index:n.id+"_"+i}),s=m[0]==m[m.length-1]}))}t.dealRoom({points:p,pointInfos:l,isClosedRing:s,type:"block",index:a,allPointsInfos:o,rooms:i}),t.addWall({points:p,bottom:d,top:h,type:"floor",index:a})})),e.hole.forEach((function(n,a){if(!n.plane||0!=n.plane.z){var s=[];if(!(n.point.length<2)){var l=t.searchItemById(n.inside,e.block),c=t.searchItemById(l.top,e["vertex-z"]).z,u=t.searchItemById(l.bottom,e["vertex-z"]).z,h=[];n.point.forEach((function(e,o){var i=n.point[(o+1)%n.point.length];t.dealPointInfo({point1:e,point2:i,points:h,type:"hole",top:c,bottom:u,pointInfos:s,parentIndex:a,index:o,boundingBox:r}),t.addWall({point1:e,point2:i,top:c,bottom:u,type:"wall",index:a+"_"+o})})),t.dealRoom({points:h,pointInfos:s,isClosedRing:n.point.length>2,type:"hole",index:n.inside,rooms:i,allPointsInfos:o})}}})),e.furnColumn.concat(e.furnFlue).forEach((function(e,n){for(var a=[],s=e.top,l=e.bottom,c=[],u=0,h=e.pos.length;u<h;u+=2){var d={x:e.pos[u],y:e.pos[u+1]},p={x:e.pos[(u+2)%e.pos.length],y:e.pos[(u+3)%e.pos.length]};t.dealPointInfo({point1:d,point2:p,points:c,type:"freeColumn",top:s,bottom:l,pointInfos:a,parentIndex:n,index:u/2,boundingBox:r})}t.dealRoom({points:c,pointInfos:a,isClosedRing:!0,type:"column",index:n,allPointsInfos:o,rooms:i})})),function(){var t=this,n=[1,3,2,0];e.column.forEach((function(a,s){var l=[],c=t.searchRoomByLine(e,a.line);if(c){for(var u=t.searchItemById(c.top,e["vertex-z"]).z,h=t.searchItemById(c.bottom,e["vertex-z"]).z,d=[],p=0;p<3;p++){var f={x:a.pos[2*n[p]],y:a.pos[2*n[p]+1]},m={x:a.pos[2*n[p+1]],y:a.pos[2*n[p+1]+1]};t.dealPointInfo({point1:f,point2:m,points:d,type:"column",top:u,bottom:h,pointInfos:l,parentIndex:s,index:p/2,boundingBox:r,rooms:i,allPointsInfos:o})}t.dealRoom({points:d,pointInfos:l,isClosedRing:!1,type:"column",index:s,allPointsInfos:o,rooms:i})}else console.log("有柱子找不到房间 ",s)}))}();n=app.model.floors.list.length>1?null!=e.subgroup?e.subgroup:e.id:app.model.floors.list[0].floorIndex;t.roomInfo[n]={pointInfos:o,boundingBox:r,center:r.getCenter(),rooms:i,oriRoomGroup:oriRoomGroup},null!=e.name&&(objects.model.floors.index[n].name=e.name)}))}},{key:"addWall",value:function(e){if(config.isEdit){var t;if("wall"==e.type){var n=new THREE.Vector3(e.point1.x,e.top,-e.point1.y),o=new THREE.Vector3(e.point2.x,e.top,-e.point2.y),i=new THREE.Vector3(e.point1.x,e.bottom,-e.point1.y),r=new THREE.Vector3(e.point2.x,e.bottom,-e.point2.y);t=be.getPlaneGeo(n,o,r,i)}else if("floor"==e.type){if(e.points.length<3)return;t=be.getShapeGeo(e.points);var a=new THREE.Matrix4;a.set(1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1),t.applyMatrix(a),t.computeVertexNormals()}var s=new THREE.Mesh(t,_material);s.name="tagBound_"+e.type+"_"+e.index,"floor"==e.type&&s.position.setY(e.bottom),oriRoomGroup.add(s)}}},{key:"searchItemById",value:function(e,t){return t.filter((function(t){return t.id==e}))}},{key:"dealPointInfo",value:function(e){console.error(e);try{var t=new THREE.Vector3(e.point1.x,e.bottom,-e.point1.y)}catch(e){console.log(1)}var n=new THREE.Vector3(e.point2.x,e.bottom,-e.point2.y),o=new THREE.Vector3(e.point1.x,e.top,-e.point1.y);if("noRuler"!=this.initType){e.points.push({x:t.x,y:t.z});var i={pointBtm:t,pointTop:o};i.horizon=new hi({sid:"r_horiz_"+e.type+e.parentIndex+"_"+e.index,points:[t,n],state:"unable"}),e.isOutSide||(i.verti=new hi({sid:"r_verti_"+e.type+e.parentIndex+"_"+e.index,points:[t,o],state:"unable"})),i.visiblePanos=[],e.pointInfos.push(i)}e.boundingBox.expandByPoint(t),e.boundingBox.expandByPoint(n),e.boundingBox.expandByPoint(o)}},{key:"dealRoom",value:function(e){var t;if(!("noRuler"==this.initType||e.points.length<2)){var n=be.getArea(e.points)>0,o={type:e.type,pointInfos:e.pointInfos,isClockWise:n,point2ds:e.points,panos:[]};e.rooms.push(o),e.isClosedRing?e.pointInfos.forEach((function(t,n){t.last=e.pointInfos[(n+e.pointInfos.length-1)%e.pointInfos.length],t.next=e.pointInfos[(n+1)%e.pointInfos.length],t.room=o})):e.pointInfos.forEach((function(t,n){0!=n&&(t.last=e.pointInfos[n-1]),n!=e.pointInfos.length&&(t.next=e.pointInfos[n+1]),t.room=o})),(t=e.allPointsInfos).push.apply(t,L(e.pointInfos)),console.log(e.type+e.index+" isClockWise "+n)}}},{key:"getColor",value:function(e,t,n){var o=(e+1)*parseInt(256/t);return o=o.toString(16),"block"==n?"#"+o+o+o:"#0000"+o}},{key:"searchRoomByLine",value:function(e,t){for(var n=0;n<e.block.length;n++)if(e.block[n].ground.includes(t)||e.block[n].wall.includes(t))return e.block[n]}},{key:"searchWallByPoint",value:function(e,t,n){for(var o=0,i=e.segment.length;o<i;o++){var r=e.segment[o];if(r.a==t&&r.b==n||r.a==n&&r.b==t)return r.id}}},{key:"ifPanoSeePoints",value:function(e,t){e.visibleRulerInfos=[];var n=t[e.floorIndex];if(n){for(var o=0;o<n.rooms.length;o++){var i,r=n.rooms[o];i=be.isPointInArea(r.point2ds,{x:e.position.x,y:e.position.z}),r.pointInfos.forEach((function(t){if((n=t.pointBtm.distanceTo(e.position))<Math.max(t.last?1.5*t.last.horizon.length:0,t.horizon?1.5*t.horizon.length:0,4)){if(t.last&&t.next){var n=t.pointBtm.clone().sub(e.position).setY(0),o=t.next.pointBtm.clone().sub(t.pointBtm).setY(0),a=t.last.pointBtm.clone().sub(t.pointBtm).setY(0);if(i==r.isClockWise?o.clone().cross(n).y>0&&t.horizon.length>.2||a.clone().cross(n).y<0&&t.last.horizon.length>.2:o.clone().cross(n).y<0&&t.horizon.length>.2||a.clone().cross(n).y>0&&t.last.horizon.length>.2)return}t.visiblePanos.push(e),e.visibleRulerInfos.push(t)}}))}e.belongToRoom=null}else console.error("ifPanoSeePoints 没找到楼层")}}]),e}();function fi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var mi=de(di=function(e){f(n,THREE.Object3D);var t=fi(n);function n(e){var o;i(this,n),(o=t.call(this)).setupCustomProperties=function(){var e=He.modelAlpha;Object.defineProperty(this,"alpha",{get:function(){return e},set:function(t){e=t,this.chunks.forEach((function(t){t.material&&t.material.uniforms.modelAlpha&&(t.material.uniforms.modelAlpha.value=e)}))}})},o.toggleAlpha=function(){this.alpha<1?this.alpha=1:this.alpha=0},o.waitForLoad=function(e,t){t()||(this.waitQueue.push({object:e,isLoadedCallback:t}),1===this.waitQueue.length&&this.emit("waiting"))},o.hide=function(){this.floors.hide()},o.show=function(){this.floors.show()},o.floorNames=function(){return this.floors.names()},o.setFloor=function(e,t){this.allFloorsVisible&&this.emit("allfloors.toggled",!1,this.currentFloor),this.allFloorsVisible=!1,this._setFloor(e,t)},o.toggleAllFloors=function(e){this.allFloorsVisible=void 0!==e?e:!this.allFloorsVisible,this.emit("allfloors.toggled",this.allFloorsVisible,this.currentFloor),this._setFloor(this.currentFloor)},o._setFloor=function(e,t,n){t=t||this.mode,this.emit("floor.changed",e,t,this.currentFloor),this.currentFloor=e,t===Oe.PANORAMA?this.show():t!==Oe.FLOORPLAN&&t!==Oe.DOLLHOUSE||this.floors.list.forEach(function(e,t){var o=e===this.currentFloor||this.allFloorsVisible;e.toggle(o,n||this.allFloorsVisible)}.bind(this));var o=this,i=e;Se.start((function(){}),He.showFloorDelay,function(){o.floors.forEach((function(e){e.chunks.forEach((function(t){t.renderOrder=e===i?qe:Ye}))}))}.bind(this))},o.toggleExplode=function(){this.floors.toggleExplodeHorizontal()},o.toggleExplodeUp=function(){this.floors.toggleExplodeVertical()},o.nextFloor=function(e){return this.floors.nextFloor(this.currentFloor,e)},o.addFloor=function(e){this.floors.add(e)},o.getFloorAtPoint=function(e){return this.floors.getFloorAtPoint(e)},o.addChunk=function(e,t){this.floors.getOrMakeFloor(e).addChunk(t),this.chunks.push(t)},o.setMode=function(e){if(!this.supportedModes[e])throw new BasicException("Mode not supported for this model: "+e);this.mode=e,this.chunks.forEach((function(t){t.setMode(e)}))},o.build=function(){var e=this;this.currentFloor=this.floors.last(),this.floors.build(),this.colliders=this.floors.reduce((function(e,t){return e.concat(t.collider.children)}),[]),this.panos.forEach((function(t){t.build1(),t.on("enter",(function(){t.floor!==e.currentFloor&&e.setFloor(t.floor)}))})),this.panos.forEach((function(e){e.build2()})),this.floors.forEach(function(e){this.boundingBox.union(e.boundingBox)}.bind(this));var t=new THREE.Vector3,n=new THREE.Vector3;this.boundingBox.getSize(t),this.boundingBox.getCenter(n),this.size=t,this.center=n,this.floors.forEach(function(e){ke.info("Floor "+e+": "+e.children.length+" chunks, "+e.panos.length+" panos.")}.bind(this)),this.skybox=new fo(this.boundingBox),this.skybox.matrixWorldNeedsUpdate=!0,this.add(this.skybox);var o=this.$app.core.get("PanoVideoRenderer").videosInfo;if(o){var i=o.parameters;this.updateVideoRenderParameters(i)}return ke.debug("Done building model"),ro.raycastsDone>0&&(ke.warn("raycasts: "+ro.raycastsDone),ke.warn("raycasts skipped: "+ro.raycastsSkipped)),this.floorLogos.createFloorLogo(),this.add(this.floorLogos.firstLogo),this.add(this.floorLogos.secondLogo),setTimeout((function(){e.floorplanCadImg.init(e),e.wallManager.init(e)}),100),this.addHighMapCube(),Promise.resolve(this)},o.updateProjectedPanos=function(e){this.projectedPano0&&this.projectedPano1&&(e==this.projectedPano0||e==this.projectedPano1)&&this.setProjectedPanos(this.projectedPano0,this.projectedPano1,!1)},o.setProjectedPanos=function(e,t,n){null!=n||(n=!0),n=!!n,this.projectedPano0=e,this.projectedPano1=t,this.skybox.material.setProjectedPanos(e,t,n),this.chunks.forEach((function(o){o.materialInside.setProjectedPanos(e,t,n)}))},o.setSide=function(e){this.floors.forEach((function(t){t.collider.material.side=e}))},o.fadePanoMarkers=function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this.player.currentPano;if(He.vrEnabled&&"portrait"!=window.VRScreenType)this.updateVrMarker();else if(null!=o.vrCustomer&&(this.markerUnable=!!o.vrCustomer),!this.markerUnable||null!=o.vrCustomer){var r=function(){var e=[];n.player.model.panos.forEach((function(t){t.hasVideo||t.panoVideo?o.hideVideoFlag||t.floor.hidden?t.updateMarkerVisible(!1,n.player):t.updateMarkerVisible(!0,n.player):e.push(t)})),n.panos.fadeMarkerOpacity(1,t,[{toOp:0,member:e}])};if(0==e)r();else if(this.player.mode==Oe.PANORAMA&&i){var a,s=[],l=[];if(i.hasVideo&&this.$app.core.get("PanoVideoRenderer").ifEnable()){if(i.videoInfo.dir)var c=i.videoInfo.dir.clone(),u=THREE.Math.degToRad(i.videoInfo.hfov/2);else{var h=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(this.supportsTiles?90:180)),d=Fe.FORWARD.clone().applyQuaternion(h.multiply(i.quaternion)).add(i.position);c=d.clone().sub(i.position),u=THREE.Math.degToRad(32.5)}a=ro.filters.isInFanAngle(i.position,c,u)}else if(i.panoVideo){c=i.panoVideo.dir.clone(),u=THREE.Math.degToRad(i.panoVideo.hfov/2);a=ro.filters.isInFanAngle(i.position,c,u)}this.player.model.panos.forEach((function(e){a&&a(e)||!(i.seeMarkers.indexOf(e.id)>-1)?e.hasVideo||e.panoVideo?e.marker.visible=!1:l.push(e):e.hasVideo||e.panoVideo?n.$app.core.get("PanoVideoRenderer").ifEnable()&&(e.marker.visible=!0):s.push(e)})),this.panos.fadeMarkerOpacity(e,t,[{toOp:He.panorama.markerOpacity,member:s},{toOp:0,member:l}])}else"panorama"!=this.player.modeTran.split("-")[1]&&r()}},o.outsideAllowed=function(){return this.supportedModes[Oe.DOLLHOUSE]&&this.supportedModes[Oe.FLOORPLAN]},o.getOption=function(e){return{autoload:!1,floors:!0,local:!1,url:e.config.num,urlFiles:"http://www.4dage.com/BigScene7niu/api/player/models/"+e.config.num+"/files",useVisionModelData:!0}},o.getModelMeta=function(e){return{sid:e.config.num,name:"四维时代",status:"viewable",floors:"",metainfo:{allowed_methods:["GET","OPTIONS","HEAD"]},image:"http://7xo6he.com2.z0.glb.qiniucdn.com/images/images1/07.13.2015_16.22.30.jpg",images:[],job:{uuid:"dacf7dfa24ae47fab8fcebfe4dc41ab9"},layers:[]}};var r=o.getOption(e),a=o.getModelMeta(e);return o.$app=e,o.sid=a.sid,o.data=a,o.options=r,o.urls=new We(o.sid,e),o.outdoorPanoLocations=[],o.floors=new at(h(o)),o.floorsEnabled=void 0===r.floors||r.floors,o.changingFloor=!1,o.chunks=[],o.panos=new so,o.colliders=[],o.loadPanosPromise=null,o.loadMeshTexturesPromise=null,o.auxDataPromise=null,o.meshTexturesLoaded=!1,o.meshTextures=[],o.mattertags={},o.tagsShown=!1,o.shouldShowMattertags=!1,o.has360Views=!1,o.showingLabels=He.labels.enabled&&a.player_options.labels,o.supportedModes={},o.supportedModes[Oe.PANORAMA]=!0,o.supportedModes[Oe.DOLLHOUSE]=!a.player_options||a.player_options.dollhouse&&browser.valueFromHash("dh",1),o.supportedModes[Oe.FLOORPLAN]=!a.player_options||a.player_options.floor_plan&&browser.valueFromHash("dh",1),o.supportedModes[Oe.TRANSITIONING]=!0,o.supportsTiles=!0,o.supportsVR=a.is_vr,o.mode=Oe.DOLLHOUSE,o.size=null,o.center=null,o.boundingBox=new THREE.Box3,o.currentFloor=null,o.allFloorsVisible=!0,o.projectedPano0=null,o.projectedPano1=null,o.floorsEnabled&&a.floors&&-1!==a.floors.indexOf(",")&&a.floors.split(",").forEach(function(e,t){this.addFloor(new Floor(this,t,e.trim()))}.bind(h(o))),o.waitQueue=[],o.on("load",function(e){0!==this.waitQueue.length&&(this.waitQueue=this.waitQueue.filter((function(e){return!e.isLoadedCallback()})),0===this.waitQueue.length&&this.emit("waiting-done"))}.bind(h(o))),o.setupCustomProperties(),o.vrMarkers=[],o.floorLogos=new To(o.$app),o.floorplanCadImg=new ui(o.$app),o.wallManager=new pi(o.$app),o}return u(n,[{key:"createTranControl",value:function(e){var t={player:e,fatLineMats:[],dontHideWhenFaceCamera:!0,scaleAxis:["x","y"],NoScaleZ:!0};this.transformControls=new _o(e.camera,e.domElement,t),this.transformControls.fatLineMats=t.fatLineMats,this.transformControls.space="local",this.transformControls.setSize(1.2),this.add(this.transformControls),this.transformControls.visible=!1}},{key:"updateVideoTexture",value:function(e){this.skybox&&(this.skybox.material.uniforms.videoTexture.value=e),this.chunks.forEach((function(t){t.materialInside.uniforms.videoTexture.value=e}))}},{key:"suspendVideoRender",value:function(){this.skybox&&(this.skybox.material.uniforms.videoReady.value=0),this.chunks.forEach((function(e){e.materialInside.uniforms.videoReady.value=0}))}},{key:"resumeVideoRender",value:function(){this.skybox&&(this.skybox.material.uniforms.videoReady.value=1,this.skybox.material.uniforms.progress.value=1),this.chunks.forEach((function(e){e.materialInside.uniforms.videoReady.value=1,e.materialInside.uniforms.progress.value=1}))}},{key:"updateVideoRenderParameters",value:function(e){var t=this;this.skybox.material.uniforms.parameters.value.set(e.inputWidth,e.inputHeight,e.outputWidth,e.outputHeight,e.focal,e.pixel,e.centerX,e.centerY,e.translateX,e.translateY,e.translateZ,0,e.lenOffsetX,e.lenOffsetY,e.videoWidth,e.videoHeight),8==e.cameraType?this.skybox.material.defines.HasVideo=8:2==e.cameraType?this.skybox.material.defines.HasVideo=2:3==e.cameraType&&(this.skybox.material.defines.HasVideo=3),this.skybox.material.defines.VideoMapping=e.mapping,this.skybox.material.needsUpdate=!0,this.chunks.forEach((function(n){n.materialInside.uniforms.parameters.value.set(e.inputWidth,e.inputHeight,e.outputWidth,e.outputHeight,e.focal,e.pixel,e.centerX,e.centerY,e.translateX,e.translateY,e.translateZ,0,e.lenOffsetX,e.lenOffsetY,e.videoWidth,e.videoHeight),8==e.cameraType?n.materialInside.defines.HasVideo=8:2==e.cameraType?n.materialInside.defines.HasVideo=2:3==e.cameraType&&(t.skybox.material.defines.HasVideo=3),n.materialInside.defines.VideoMapping=e.mapping,n.materialInside.needsUpdate=!0}))}},{key:"updateVrMarker",value:function(e){var t=this;if(this.player.currentPano.isAligned()){if(e=null==e?He.vrEnabled:e)for(var n in this.panos.index){var o=this.panos.index[n];o.isAligned()&&(o.marker.opacity=0)}else this.fadePanoMarkers(null,null);this.vrMarkers.forEach((function(n){n.visible=e&&t.player.currentPano.id!=n.pano.id&&!!t.player.currentPano.neighbourPanos[n.pano.id];//!! 是防止undefined
}))}}},{key:"addHighMapCube",value:function(){if("tiles/4k"==this.$app.store.getValue("metadata").sceneResolution&&2048==this.$app.core.get("QualityManager").maxRenderTargetSize){for(var e=new THREE.PlaneGeometry(1,1,1,1),t=new THREE.Object3D,n=0;n<6;n++){for(var o=new THREE.Object3D,i=0;i<8;i++)for(var r=0;r<8;r++){var a=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:2}));a.position.set(i-3.5,r-3.5,-4),a.visible=!1,o.add(a)}switch(n){case Gn:o.rotation.set(0,Math.PI/2,0);break;case qn:o.rotation.set(0,-Math.PI/2,0);break;case Yn:var s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),l=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);o.quaternion.copy(s).multiply(l);break;case $n:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),l=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);o.quaternion.copy(s).multiply(l);break;case Xn:o.rotation.set(0,Math.PI,0);break;case Jn:o.rotation.set(0,0,0)}o.scale.set(1,-1,1),t.add(o)}t.name="highMapCube",this.highMapCube=t,this.add(t),t.scale.set(.21,.21,.21),this.highMapCube.visible=!1}}},{key:"isHighMapLoaded",value:function(e,t,n){return!!this.highMapCube.children[e].children[8*t+n].material.map}},{key:"updateHighMap",value:function(e,t,n,o){var i=this.highMapCube.children[t].children[8*n+o];i.material.map=e,i.visible=!0,i.material.needsUpdate=!0}},{key:"resetHighMap",value:function(){var e=this;this.highMapCube&&(this.highMapCube.children.forEach((function(t){return t.children.forEach((function(t){if(t.material.map){t.material.map.dispose(),t.material.map.loaded=!1,t.material.map.version=0;var n=e.$app.core.get("SceneRenderer").renderer.properties.get(t.material.map);e.$app.core.get("SceneRenderer").renderer.context.deleteTexture(n.__webglTexture),t.material.map=null,t.material.needsUpdate=!0,t.visible=!1}}))})),this.highMapCube.visible=!1)}},{key:"setHighMap",value:function(e){this.highMapCube&&(this.highMapCube.position.copy(e.position),this.highMapCube.quaternion.copy(e.quaternion))}},{key:"showHighMap",value:function(){this.highMapCube&&(this.highMapCube.visible=!0)}},{key:"hideHighMap",value:function(){this.highMapCube&&(this.highMapCube.visible=!1)}}]),n}())||di;function vi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var gi=function(e){f(n,EventEmitter);var t=vi(n);function n(e){var o;return i(this,n),e=e||{},(o=t.call(this)).position=new THREE.Vector3,o.quaternion=new THREE.Quaternion,o.update(e),o}return u(n,[{key:"isValid",value:function(){return!!this.cameraMode}},{key:"update",value:function(e){return this.cameraMode=e.cameraMode||this.cameraMode,this.pano=e.pano||this.pano,e.position&&this.position.copy(e.position),e.quaternion&&this.quaternion.copy(e.quaternion),this}}]),n}();function yi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var wi=function(e){f(n,THREE.Mesh);var t=yi(n);function n(e){var o;i(this,n),o=t.call(this);var r=THREE.UniformsUtils.clone(Ht.waypoint.uniforms);return r.map.value=se.loadTextureFromCache(In.getImageURL("images/blueReticle.png")),r.opacity.value=0,(o=t.call(this,new THREE.PlaneBufferGeometry(.4,.4,1,1),new THREE.RawShaderMaterial({side:THREE.DoubleSide,depthWrite:!1,depthTest:!1,transparent:!0,vertexShader:Ht.waypoint.vertexShader,fragmentShader:Ht.waypoint.fragmentShader,uniforms:r,name:"waypoint",opacity:0}))).layers.set(ut),o.renderOrder=Ke,o.player=e,o.direction=new THREE.Vector3,o.hidden=!0,o.mouseLastMoveTime=Date.now(),o}return u(n,[{key:"move",value:function(e,t,n){this.hidden=n,this.mouseLastMoveTime=Date.now()}},{key:"hide",value:function(){this.hidden||(this.hidden=!0,Se.start(nt.property(this.material.uniforms.opacity,"value",0),He.reticuleOpacityTransitionTime))}},{key:"show",value:function(){this.hidden=!1,this.material.opacity<=0&&Se.start(nt.property(this.material.uniforms.opacity,"value",He[this.player.mode].reticuleOpacity),He.reticuleOpacityTransitionTime)}},{key:"update",value:function(){Date.now()-this.mouseLastMoveTime>He.hideReticuleTimeout&&!this.hidden&&this.hide()}},{key:"updatePosition",value:function(e,t){if(!this.hidden){if(!t)return this.hide();var n=t.point,o=e.distanceTo(n),i=1+.01*o;o<1&&(i-=1-o),this.show(),this.scale.set(i,i,i),this.direction=this.direction.multiplyScalar(.8),this.direction.add(t.face.normal.clone().multiplyScalar(.2)),this.position.copy(n).add(t.face.normal.clone().multiplyScalar(.01)),this.lookAt(this.position.clone().add(this.direction))}}}]),n}(),bi="move",Ei="interaction.direct",xi="interaction.key",Ti="input.start",Pi="input.pinch",ki="input.scroll",Mi="autopan.interrupt",Ri="autopan.complete",Ii="autopan.clamped",Si="longtap",Ci=Object.freeze({None:0,Queued:1,ForceQueued:2,Downloading:3,Downloaded:4,DownloadFailed:5}),Ai=Object.freeze({None:0,DirectionalFOV:1}),Di=function(){var e=function e(t,n){var o=e._panoSpaceDir,i=e._fovThreshold,r=e._fovThresholdNarrow,a=Math.max(Math.min(o.dot(t.direction),1),-1),s=Math.max(Math.min(o.dot(n.direction),1),-1);return t._dot=a,n._dot=s,a>=i&&s<i?-1:a<i&&s>=i?1:a>=r&&s<r?-1:a<r&&s>=r||t.panoSize>n.panoSize?1:n.panoSize>t.panoSize?-1:-(a-s)};return e._panoSpaceDir=new THREE.Vector3,e._fovThreshold=-1,e._fovThresholdNarrow=-1,e}(),Li=function(){function e(t,n,o,r,a){i(this,e),this.filterAndPrioritize=function(){var t=[],n=[],o=[];return function(i,r,a){this.populateNeighborPanos(this.priorityCriteria.pano,r,t),this.populateScoredPanos(this.priorityCriteria.pano,r,n,this.priorityCriteria.cameraDir,e.MAX_SCORED_PANOS_TOCONSIDER);var s=this.baseSize,l=this.standardSize,c=this.highSize,u=this.ultraHighSize;this.queueTilesForPano(i,a,this.priorityCriteria.pano,s),this.priorityCriteria.upcomingPanos&&this.queueTilesForPanos(i,this.priorityCriteria.upcomingPanos,a,s,e.MAX_UPCOMING_PANOS_TOADD),o.length=0,this.canDownloadSize(l)&&this.queueTilesInDirectionForPano(o,a,this.priorityCriteria.pano,l,this.priorityCriteria.cameraPosition,this.priorityCriteria.cameraDir,e.DIRECTIONAL_FOV_NARROW),e.sortPanoTiles(o,this.priorityCriteria.pano,this.priorityCriteria.cameraDir),e.appendQueue(i,o),this.queueTilesForPanos(i,n,a,s,e.MAX_SCORED_PANOS_TOADD),o.length=0,this.canDownloadSize(c)&&this.queueTilesInDirectionForPano(o,a,this.priorityCriteria.pano,c,this.priorityCriteria.cameraPosition,this.priorityCriteria.cameraDir,e.DIRECTIONAL_FOV_NARROW),this.canDownloadSize(u)&&this.queueTilesInDirectionForPano(o,a,this.priorityCriteria.pano,u,this.priorityCriteria.cameraPosition,this.priorityCriteria.cameraDir,e.DIRECTIONAL_FOV_NARROW),e.sortPanoTiles(o,this.priorityCriteria.pano,this.priorityCriteria.cameraDir),e.appendQueue(i,o),o.length=0,this.canDownloadSize(l)&&this.queueTilesInDirectionForPano(o,a,this.priorityCriteria.pano,l,this.priorityCriteria.cameraPosition,this.priorityCriteria.cameraDir,e.DIRECTIONAL_FOV),this.canDownloadSize(c)&&this.queueTilesInDirectionForPano(o,a,this.priorityCriteria.pano,c,this.priorityCriteria.cameraPosition,this.priorityCriteria.cameraDir,e.DIRECTIONAL_FOV),this.canDownloadSize(u)&&this.queueTilesInDirectionForPano(o,a,this.priorityCriteria.pano,u,this.priorityCriteria.cameraPosition,this.priorityCriteria.cameraDir,e.DIRECTIONAL_FOV),e.sortPanoTiles(o,this.priorityCriteria.pano,this.priorityCriteria.cameraDir),e.appendQueue(i,o),this.queueTilesForPanos(i,t,a,s)}}(),this.queueTilesForPano=function(){var e={filter:Ai.None};return function(t,n,o,i){return this.filterAndQueueTileDownloadDescriptors(t,n,o,i,e)}}(),this.queueTilesForPanosInDirection=function(){var e=new THREE.Vector3;return function(t,n,o,i,r,a,s,l){for(var u=0,h=0;h<o.length;h++){var d=o[h];if(e.copy(d.position),e.sub(r),e.normalize(),Math.max(Math.min(a.dot(e),1),-1)>=c.getFOVDotThreshold(s))if(u+=this.queueTilesInDirectionForPano(t,n,d,i,r,a,s)>0?1:0,l&&u>=l)break}return u}}(),this.queueTilesInDirectionForPano=function(){var e={filter:Ai.DirectionalFOV,direction:new THREE.Vector3,fov:60},t=new THREE.Vector3;return function(n,o,i,r,a,s,l){return t.copy(s),Kn.getRelativeDirection(i.quaternion,t),e.direction.copy(t),e.fov=l,this.filterAndQueueTileDownloadDescriptors(n,o,i,r,e)}}(),this.filterAndQueueTileDownloadDescriptors=function(){var e=[];return function(t,n,o,i,r){var a=n.getTileDownloadDescriptors(o,i);e.length=0,this.filterTileDownloadDescriptors(o,a,e,r);for(var s=0,l=0;l<e.length;l++){var c=e[l];c&&(t.push(c),s++)}return s}}(),this.filterTileDownloadDescriptors=(new THREE.Vector3,function(e,t,n,o){var i,r;switch(o.filter){case Ai.DirectionalFOV:for(i=0;i<t.length;i++)r=t[i],Kn.isTileWithinFOV(r.panoSize,r.tileSize,r.face,r.tileX,r.tileY,o.direction,o.fov)&&n.push(r);break;default:for(i=0;i<t.length;i++)r=t[i],n.push(r)}for(i=0;i<n.length;i++)r=n[i],this.canIncludeDescriptor(r)||(n[i]=null)}),this.qualityManager=t,this.maxNavQuality=this.qualityManager.getMaxNavPanoSize(),this.maxZoomQuality=this.qualityManager.getMaxZoomPanoSize(),this.baseSize=n,this.standardSize=o,this.highSize=r,this.ultraHighSize=a,this.priorityCriteria=new e.PriorityCriteria(null,new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(0,0,-1))}return u(e,[{key:"updateCriteria",value:function(e,t,n,o){this.priorityCriteria.pano=e,this.priorityCriteria.cameraPosition.copy(t),this.priorityCriteria.cameraDir.copy(n),this.priorityCriteria.upcomingPanos=o,this.maxNavQuality=this.qualityManager.getMaxNavPanoSize(),this.maxZoomQuality=this.qualityManager.getMaxZoomPanoSize()}},{key:"canDownloadSize",value:function(e){return this.maxNavQuality>=e||this.maxZoomQuality>=e&&this.zoomingActive}},{key:"populateNeighborPanos",value:function(e,t,n){(n=n||[]).length=0;var o=t.getNeighbours(e);for(var i in o)if(o.hasOwnProperty(i)){var r=t.get(i);n.push(r)}return n}},{key:"populateScoredPanos",value:function(t,n,o,i,r){(o=o||[]).length=0;var a=[ro.filters.inPanoDirection(t.position,i,e.DIRECTION_SCORE_STRICTNESS),ro.filters.not(t)],s=[ro.scoreFunctions.distanceSquared(t),ro.scoreFunctions.direction(t.position,i)],l=n.sortByScore(a,s);if(l)for(var c=0;c<l.length&&c<r;c++){var u=l[c].pano;o.push(u)}return o}},{key:"queueTilesForPanos",value:function(e,t,n,o,i){for(var r=0,a=0;a<t.length;a++){var s=t[a];if(r+=this.queueTilesForPano(e,n,s,o)>0?1:0,i&&r>=i)break}return r}},{key:"queueTilesInDirectionForPanos",value:function(e,t,n,o,i,r,a,s){for(var l=0,c=0;c<n.length;c++){var u=n[c];if(l+=this.queueTilesInDirectionForPano(e,t,u,o,r,a)>0?1:0,s&&l>=s)break}return l}},{key:"canIncludeDescriptor",value:function(e){return e.status!==Ci.Downloading&&e.status!==Ci.Downloaded}},{key:"canIncludePano",value:function(e,t){return!e.isLoaded(t)}},{key:"setZoomingActive",value:function(e){e!==this.zoomingActive&&(this.zoomingActive=e)}}],[{key:"PriorityCriteria",value:function(e,t,n,o,i){this.pano=e,this.cameraPosition=(new THREE.Vector3).copy(t),this.cameraDir=(new THREE.Vector3).copy(n),this.panoSpaceDir=(new THREE.Vector3).copy(o),this.upcomingPanos=i,this.copy=function(e){this.pano=e.pano,this.cameraPosition.copy(e.cameraPosition),this.cameraDir.copy(e.cameraDir),this.panoSpaceDir.copy(e.panoSpaceDir),this.upcomingPanos=i},this.zoomingActive=!1}},{key:"appendQueue",value:function(e,t){if(e&&t)for(var n=0;n<t.length;n++)e.push(t[n])}},{key:"getFOVDotThreshold",value:function(e){return Math.cos(THREE.Math.degToRad(e/2))}},{key:"sortPanoTiles",value:function(t,n,o){Di._panoSpaceDir.copy(o),Kn.getRelativeDirection(n.quaternion,Di._panoSpaceDir),Di._fovThresholdNarrow=be.getFOVDotThreshold(e.DIRECTIONAL_FOV_NARROW),Di._fovThreshold=be.getFOVDotThreshold(e.DIRECTIONAL_FOV),t.sort(Di)}},{key:"insertSortedPanoTile",value:function(t,n,o,i){Di._panoSpaceDir.copy(i),Kn.getRelativeDirection(o.quaternion,Di._panoSpaceDir),Di._fovThresholdNarrow=be.getFOVDotThreshold(e.DIRECTIONAL_FOV_NARROW),Di._fovThreshold=be.getFOVDotThreshold(e.DIRECTIONAL_FOV);for(var r=-1,a=0;a<t.length;a++){if(Di(n,t[a])<=0){r=a;break}}if(-1===r)t[t.length]=n;else{for(var s=t.length;s>r;s--)t[s]=t[s-1];t[r]=n}}}]),e}();Li.DIRECTIONAL_FOV=180,Li.DIRECTIONAL_FOV_NARROW=120,Li.MAX_SCORED_PANOS_TOCONSIDER=6,Li.MAX_SCORED_PANOS_TOADD=2,Li.MAX_UPCOMING_PANOS_TOADD=3,Li.DIRECTION_SCORE_STRICTNESS=.75;var zi={clampVFOV:function(e,t,n,o){return zi.getHFOVFromVFOV(e,n,o)>t?zi.getVFOVFromHFOV(t,n,o):e},getHFOVForCamera:function(e,t,n){return zi.getHFOVFromVFOV(e.fov,t,n)},getHFOVFromVFOV:function(e,t,n){return 2*Math.atan(Math.tan(e*xe.RADIANS_PER_DEGREE/2)*(t/n))*xe.DEGREES_PER_RADIAN},getVFOVFromHFOV:function(e,t,n){return 2*Math.atan(Math.tan(e*xe.RADIANS_PER_DEGREE/2)*(n/t))*xe.DEGREES_PER_RADIAN}},Vi={ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,SPACE:32,RETURN:13,SEMICOLON:186,PLUSEQUALS:187,DASHUNDERSCORE:189,OPENBRACKET:219};Ce.detectFirefox()&&(Vi.SEMICOLON=59,Vi.PLUSEQUALS=61,Vi.DASHUNDERSCORE=173);var Hi="model-added",Oi="active-model-changed",Fi=0,Ni=1,Bi=2,ji=3;function Ui(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var _i=function(e){f(n,e);var t=Ui(n);function n(e){var o;return i(this,n),(o=t.call(this,e)).panoId=e.panoId,o.orthoZoom=e.orthoZoom,o.floorVisibility=e.floorVisibility,o.thumbUrl=e.thumbUrl,o.name=e.name,o}return u(n,[{key:"isPano",value:function(){return this.panoId&&""!==this.panoId}}]),n}(gi),Wi=function(){function e(t,n,o){i(this,e),this.flightStepWalk=function(e,t,n){var o=new THREE.Vector3,i=new THREE.Vector3,r=function(e,t){var n=Math.min(this.player.position.distanceTo(e.position),He.transition.flytimeMaxDistanceThreshold)*He.transition.flytimeDistanceMultiplier+He.transition.flyTime;i.copy(Fe.FORWARD),this.player.getDirection(i),o.copy(t).sub(e.position).normalize();var r=o.dot(i),a=Math.acos(r),s=a/n;return s>.001&&(n*=s/.001,a<1&&(n*=1.2)),n};return function(e,t,n){if(this.warpInterrupted)n&&n();else if(this.activeTransType!==l.WALK)this._clearWarpShading(),this._warpStopFlying(),this.player.spider.draw(),this.placeCpm(),n&&n();else if(this.player.currentPano!==e){var o={pano:e,lookAtPoint:t,duration:null,maxDistanceOverride:He.warp.walkMaxDist,skipWarpingCheck:!1,constantMoveSpeed:!0};o.duration=r.call(this,e,t),this.player.nonInterruptingFlyToPano(o,n)}else n&&n()}}(),this.warpTravel_WALK=function(){var e=[];return function(t){var n=this.player.model.panos;e.length=0;for(var o=null,i=!1,r=0;r<this.nodes.length;r++){var a=this.nodes[r],s=n.get(a);this.nodes.length,i=o&&s.position.distanceTo(o.position)<He.warp.walkMinDist,o&&i||(e.push(a),o=s)}i&&this.nodes.length>1&&(e[e.length-1]=this.nodes[this.nodes.length-1]);var l=e.length,c=n.get(e[l-1]),u=new Array(l+1);u[u.length-1]=function(){t&&t()}.bind(this);for(var h=l-1,d=u.length-1;d>0;d-=1){var p=e[h];c=n.get(p);var f=new THREE.Vector3;this.getLookAtForWalkingTourNode(e,h,f),u[d-1]=this.makeWalkFlightFunc(c,f,u[d]),h--}u[0]()}}(),this.getLookAtForWalkingTourNode=function(){var e=new THREE.Vector3,t=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3,i=new THREE.Vector3;return function(r,a,s){var l=r.length;if(a>=l)return!1;var c=1,u=1;t.set(0,0,0),i.set(0,0,0);for(var h=null,d=a;d<a+3&&!(d>=l);d++){if(h=this.player.model.panos.get(r[d]),this.getOrientationForWalkingTourNode(r,d,n),d===a&&e.copy(n),o.copy(n),d>a){var p=o.dot(e)<.65;c*=p?.2:.75,u*=p?.2:.4}n.multiplyScalar(c),t.add(n),i.lerp(h.position,u)}return t.normalize(),s.copy(i),s.add(t),!0}}(),this.obj3d=null,this.nodes=[],this.colorHull=[],this.shortPaths={},this.floorHull=null,this.cameraHull=null,this.floorPathDistance=0,this.floorCurvePoints=null,this.floorCurveColors=null,this.camCurvePoints=null,this.warpDestHeroLoc=null,this.warpDestPano=null,this.warpPathPoints=null,this.warpPathLengths=[0],this.warpLength=0,this.closeWarpDistance=4,this.UP=Fe.UP.clone(),this.longestStep=0,this.upcomingTransType=null,this.burnsDir=1,this.prevNextDist=0,this.nextI=0,this.activeTransType=null,this.lastTransType=null,this.bunnyObj=null,this.director=t,this.player=n,this.playerControls=o,this.modelManager=n.modelManager,this.updateModel(),this.bindEvents(),this.warping=!1,this.waitingToWarp=!1,this.warpInterrupted=!1,this.warpInterruptionBlackoutStyle=null,this.warpInterruptionTravelTime=null,this.pathImg={},this.brushPrefs={linewidth:7,strokeWidth:15,cvSegments:48,paveStep:.1,paveWidth:.2,lookBlendDist:3,maxTurn:THREE.Math.degToRad(2)},this.hintPrefs={rad:.18,width:.0125,depth:.0625,setBack:-.04,markRad:.25,markInnerRad:.16},this.init()}return u(e,[{key:"init",value:function(){this.pathImg.pathEnd=se.loadTextureFromCache(In.getImageURL("images/pathEnd.png"))}},{key:"setScene",value:function(e){this.createCpm(e)}},{key:"updateModel",value:function(){this.model=this.modelManager.getActiveModel()}},{key:"bindEvents",value:function(){this.modelManager.on(Oi,this.updateModel.bind(this))}},{key:"pointPathDistance",value:function(e){for(var t=0,n=1;n<e.length;n+=1)t+=e[n-1].distanceTo(e[n]);return t}},{key:"pointPathLengths",value:function(e){for(var t=[0],n=1;n<e.length;n+=1)t.push(t[n-1]+e[n-1].distanceTo(e[n]));return t}},{key:"interpAlongPath",value:function(e,t,n){var o,i=new THREE.Vector3,r=t[t.length-1];if(n<1){o=n*r;for(var a=1;a<t.length;a+=1)if(t[a]>o){var s=(o-t[a-1])/(t[a]-t[a-1]);return i.copy(e[a]),i.sub(e[a-1]),i.multiplyScalar(s),i.add(e[a-1]),i}}else i.copy(e[e.length-1]);return i}},{key:"pathHeight",value:function(){return He.path.height}},{key:"createBunnyObj",value:function(e){this.bunnyObj||(this.bunnyObj=new THREE.AxesHelper(.1),this.bunnyObj.visible=He.warp.showBunny),this.bunnyObj.parent&&this.bunnyObj.parent.remove(this.bunnyObj),e.add(this.bunnyObj)}},{key:"createCpm",value:function(e){if(!this.currentPanoMarker){var t=this.makeWaypointObj(this.pathImg.pathEnd,"Current");t.material.uniforms.opacity.value=0,this.currentPanoMarker={mesh:t,placed:!1}}this.currentPanoMarker.mesh.parent&&this.currentPanoMarker.mesh.parent.remove(this.currentPanoMarker.mesh),this.placeCpm(),this.currentPanoMarker.mesh.parent||e.add(this.currentPanoMarker.mesh)}},{key:"placeCpm",value:function(){if(He.path.mapGuides&&this.player.currentPano&&this.player.currentPano.isAligned()){var e=this.player.currentPano.floor;this.currentPanoMarker.mesh.parent!==this.player.currentPano.floor&&(this.currentPanoMarker.mesh.parent&&this.currentPanoMarker.mesh.parent.remove(this.currentPanoMarker.mesh),e.add(this.currentPanoMarker.mesh)),this.currentPanoMarker.mesh.position.copy(this.player.currentPano.floorPosition).sub(e.position),this.currentPanoMarker.mesh.position.y+=this.pathHeight(),this.currentPanoMarker.placed=!0}else this.popOutCpm()}},{key:"fadeInCpm",value:function(e){this.player.mode===Oe.PANORAMA&&this.player.currentPano&&!this.player.currentPano.isAligned()||He.path.mapGuides&&this.currentPanoMarker.placed&&Se.start(nt.property(this.currentPanoMarker.mesh.material.uniforms.opacity,"value",1),e)}},{key:"fadeOutCpm",value:function(e){Se.start(nt.property(this.currentPanoMarker.mesh.material.uniforms.opacity,"value",0),e)}},{key:"popInCpm",value:function(){He.path.mapGuides&&this.currentPanoMarker.placed&&this.fadeInCpm(2)}},{key:"popOutCpm",value:function(){this.fadeOutCpm(2)}},{key:"buildWarpDestinationDescriptor",value:function(e,t,n,o,i,r){return new _i({cameraMode:o,position:e,quaternion:t,panoId:n,orthoZoom:r,floorVisibility:i,thumbUrl:null,name:null})}},{key:"buildWarpDestinationDescriptorFromHero",value:function(e){return this.buildWarpDestinationDescriptor(e.position,e.quaternion,this.getHeroId(e),e.cameraMode,e.floorVisibility,e.orthoZoom)}},{key:"setWarpDestination",value:function(e){this.warpDestHeroLoc=e}},{key:"setWarpDestinationByHeroIndex",value:function(e){var t=this.getHeroDescriptorByHeroIndex(e);return null!==t&&(this.setWarpDestination(t),!0)}},{key:"setWarpDestinationByPano",value:function(e,t){return!!this.model.panos.get(e.id)&&this.setWarpDestinationByPanoId(e.id,t)}},{key:"setWarpDestinationByPanoId",value:function(e,t){var n=this.model.panos.get(e);if(n){t=t||new THREE.Quaternion;var o=this.buildWarpDestinationDescriptor(n.position,t,n.id,"panorama",[],-1);return this.setWarpDestination(o),!0}return!1}},{key:"getHeroDescriptorByHeroIndex",value:function(e){var t=objects.play.heroCount();if(null!==this.warpDestHeroLoc&&t<2)return ke.info("ShowPath.getHeroDescriptorByHeroIndex() -> Only one hero location is available."),this.model.getHeroDescriptorByIndex(0);var n=this.model.getHeroDescriptorByIndex(e);n=util.getPlayDataItem(e),1==objects.store.getters["guide/plays"][e].type&&(n=util.getPlayDataItem(e,0));var o=util.convertHighlight(n),i=new _i(o);if(i){var r=i.isPano()?i.panoId:i.cameraMode;ke.debug('ShowPath.getHeroDescriptorByHeroIndex() -> New brush/warp destination: "'+r+'" out of '+t+" choices.")}return i}},{key:"getHeroDescriptorByPano",value:function(e){return this.model.panos.get(e.id)?this.getHeroDescriptorByPanoId(e.id):null}},{key:"getHeroDescriptorByPanoId",value:function(e){var t=this.getHeroIndexFromPanoId(e);return this.getHeroDescriptorByHeroIndex(t)}},{key:"getHeroIndexFromPanoId",value:function(e){for(var t=0;t<this.model.heroLocations.length;t++){var n=this.model.heroLocations[t],o=this.getHeroId(n);if(o&&o===e)return t}return-1}},{key:"getHeroPano",value:function(e){if(null===e)return ke.warn("getHeroPano(): no destination"),null;var t=this.getHeroId(e),n=this.model.panos.get(t);return void 0===n&&(n=null,""!==t&&ke.debug('unable to find pano "'+t+'"')),n}},{key:"getHeroId",value:function(e){return e.panoId}},{key:"setWarpDestPano",value:function(){return this.warpDestPano=this.getHeroPano(this.warpDestHeroLoc),this.warpDestPano}},{key:"findShortestPath",value:function(e,t){if(!e||!t)return null;var n=He.warp.walkExtraPanosDistance,o=e.id+":"+t.id+":"+n;if(this.shortPaths.hasOwnProperty(o))return this.shortPaths[o]?this.shortPaths[o].slice():null;var i=t.id+":"+e.id+":"+n;if(this.shortPaths.hasOwnProperty(i))return this.shortPaths[i]?this.shortPaths[i].slice().reverse():null;var r=this.model.panos.aStarSearch(e,t);return this.model.panos.includeNodesNearPath(r,n),this.shortPaths[o]=r?r.slice():null,r}},{key:"makePathHulls",value:function(e){var t,n,o,i,r,a=0,s=[],l=[],c=[],u=this.model.panos;i=(t=u.get(e[0])).floor.floorIndex;for(var h=0;h<e.length;h+=1)(n=(t=u.get(e[h])).floorPosition.clone().sub(this.model.position)).y+=this.pathHeight(),s.push(n),l.push(t.position.clone()),o=t.floor.floorIndex,c.push(o>i?He.path.colorUp:o<i?He.path.colorDown:He.path.color),h>0&&((r=l[h].distanceTo(l[h-1]))>a&&(a=r));return a>this.longestStep&&(this.longestStep=a,ke.debug("path contains "+a+" meter segment")),{floor:s,camera:l,color:c}}},{key:"makeFloorCurves",value:function(e,t,n){var o=this.player.mode===Oe.PANORAMA?He.path.waypointIndoorRadius:He.path.waypointRadius,i=this.pointPathDistance(e)-2*o,r=e.slice(0),a=r[1].clone().sub(r[0]);a.y=0,a.normalize().multiplyScalar(o),r[0]=(new THREE.Vector3).copy(r[0]).add(a),(a=r[r.length-2].clone().sub(r[r.length-1])).y=0,a.normalize().multiplyScalar(o),r[r.length-1]=(new THREE.Vector3).copy(r[r.length-1]).add(a);var s=new THREE.CatmullRomCurve3(r),l=Math.floor(i/n);l=4*Math.floor(l/4),l=Math.max(4,l);for(var c,u,h=s.getSpacedPoints(l),d=[],p=new THREE.Vector3,f=0;f<h.length;f+=1){u=0,c=h[f].distanceTo(e[0]);for(var m=1;m<e.length;m+=1)p.copy(h[f]).sub(e[m]),p.y*=4,p.length()<c&&(u=m);d.push(t[u])}return{distance:i,points:h,colors:d}}},{key:"makeCameraCurvePoints",value:function(e,t){var n=this.pointPathDistance(e);return new THREE.CatmullRomCurve3(e).getSpacedPoints(Math.max(2,Math.floor(n/t)))}},{key:"setPathHulls",value:function(e){var t=this.makePathHulls(e);this.floorHull=t.floor,this.cameraHull=t.camera,this.colorHull=t.color}},{key:"setFloorCurves",value:function(){var e=this.makeFloorCurves(this.floorHull,this.colorHull,this.brushPrefs.paveStep);this.floorPathDistance=e.distance,this.floorCurvePoints=e.points,this.floorCurveColors=e.colors}},{key:"setCameraCurvePoints",value:function(){this.camCurvePoints=this.makeCameraCurvePoints(this.cameraHull,He.warp.stepFactor*this.brushPrefs.paveStep)}},{key:"chooseWarpPath",value:function(e){var t,n,o,i=this.playerControls.cameras[Oe.PANORAMA];if(this.player.currentPano===this.warpDestPano||!e)return this.warpPathPoints=null,this.warpLength=0,!1;this.nodes=this.findShortestPath(this.player.currentPano,this.warpDestPano),this.setPathHulls(this.nodes),void 0===this.nodes||null===this.nodes||this.nodes.length<1?(ke.debug("warp path to unreachable node"),n=(t=this.warpDestPano.position.clone().sub(i.position)).clone().negate(),t.multiplyScalar(.15).add(i.position),n.multiplyScalar(.15).add(this.warpDestPano.position),t.y=i.position.y,n.y=this.warpDestPano.position.y,o=new THREE.CubicBezierCurve3(i.position.clone(),t,n,this.warpDestPano.position.clone()),this.warpPathPoints=o.getSpacedPoints(this.brushPrefs.cvSegments)):(ke.debug("follow warp path (path distance was "+this.nodes.length+" nodes, "+this.floorPathDistance+")"),this.setCameraCurvePoints(),this.warpPathPoints=this.camCurvePoints.slice(0)),this.warpLength=0,this.warpPathLengths=[0];for(var r=new THREE.Vector3,a=new THREE.Vector3,s=Math.cos(THREE.Math.degToRad(He.warp.minBrakeAngle)),l=Math.cos(THREE.Math.degToRad(He.warp.maxBrakeAngle)),c=1;c<this.warpPathPoints.length;c+=1){r.copy(this.warpPathPoints[c-1]).sub(this.warpPathPoints[c]);var u=r.length();r.y*=He.warp.climbEffort;var h=r.length()/u;if(c>1){r.setY(0).normalize(),a.copy(this.warpPathPoints[c-2]).sub(this.warpPathPoints[c-1]).setY(0).normalize();var d=Math.min(1,r.dot(a)),p=1+(He.warp.brakeStrength-1)*(1-THREE.Math.smoothstep(d,l,s));h=Math.max(p,h)}this.warpLength+=u*h,this.warpPathLengths[c]=this.warpLength}return!0}},{key:"drawPathRibbon",value:function(e,t){this.bunnyObj.visible=He.warp.showBunny;for(var n=.6*He.path.ribbonWidth*.5,o=new THREE.Vector3,i=new THREE.Vector3(0,this.pathHeight(),0),r=new THREE.Geometry,a=new THREE.Vector3,s=0;s<e.length;s+=1){a.copy(e[s]),0===s?a.sub(e[s+1]):a.sub(e[s-1]).negate(),a.normalize(),o.crossVectors(a,Fe.UP),o.multiplyScalar(n);var l=(new THREE.Vector3).copy(e[s]).add(i);l.sub(o),r.vertices.push(l),(l=(new THREE.Vector3).copy(e[s]).add(i)).add(o),r.vertices.push(l)}var c,u,h,d=0;for(s=0;s<e.length-1;s+=1){var p=2*s,f=d,m=d+=e[s+1].distanceTo(e[s]),v=t[s],g=t[s+1];(c=new THREE.Face3(p,p+1,p+2)).vertexColors=[new THREE.Color(v),new THREE.Color(v),new THREE.Color(g)],r.faces.push(c),r.faceVertexUvs[0].push([new THREE.Vector2(0,f),new THREE.Vector2(1,f),new THREE.Vector2(0,m)]),(c=new THREE.Face3(p+2,p+1,p+3)).vertexColors=[new THREE.Color(g),new THREE.Color(v),new THREE.Color(g)],r.faces.push(c),r.faceVertexUvs[0].push([new THREE.Vector2(0,m),new THREE.Vector2(1,f),new THREE.Vector2(1,m)])}r.computeFaceNormals(),r.computeVertexNormals(),this.player.mode===Oe.PANORAMA?((h=THREE.UniformsUtils.clone(Ht.ribbon.uniforms)).map.value=this.pathImg.path,h.opacity.value=0,h.color.value.set(He.path.color),u=new THREE.RawShaderMaterial({side:THREE.DoubleSide,depthWrite:!1,transparent:!0,vertexShader:Ht.ribbon.vertexShader,fragmentShader:Ht.ribbon.fragmentShader,uniforms:h,name:"ribbonT",opacity:0})):u=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,name:"ribbonOut",vertexColors:THREE.VertexColors});var y=new THREE.Mesh(r,u);return y.name="ribbon",this.player.mode===Oe.PANORAMA&&(y.renderOrder=tt),y}},{key:"drawPathPavement",value:function(e){for(var t,n=new THREE.Vector3,o=new THREE.Geometry,i=new THREE.Vector3,r=0;r<e.length;r+=1)i.copy(e[r]),0===r?i.sub(e[r+1]).negate():i.sub(e[r-1]),i.normalize(),n.crossVectors(i,Fe.UP),n.multiplyScalar(this.brushPrefs.paveWidth),(t=(new THREE.Vector3).copy(e[r])).sub(n),o.vertices.push(t),o.vertices.push((new THREE.Vector3).copy(e[r])),(t=(new THREE.Vector3).copy(e[r])).add(n),o.vertices.push(t);var a,s,l;for(r=0;r<e.length-1;r+=1)a=3*r+1,l=(s=.25*r)+.25,o.faces.push(new THREE.Face3(a-1,a,a+3)),o.faceVertexUvs[0].push([new THREE.Vector2(0,s),new THREE.Vector2(.5,s),new THREE.Vector2(.5,l)]),o.faces.push(new THREE.Face3(a+3,a+2,a-1)),o.faceVertexUvs[0].push([new THREE.Vector2(.5,l),new THREE.Vector2(0,l),new THREE.Vector2(0,s)]),o.faces.push(new THREE.Face3(a+3,a,a+1)),o.faceVertexUvs[0].push([new THREE.Vector2(.5,l),new THREE.Vector2(.5,s),new THREE.Vector2(1,s)]),o.faces.push(new THREE.Face3(a+3,a+1,a+4)),o.faceVertexUvs[0].push([new THREE.Vector2(.5,l),new THREE.Vector2(1,s),new THREE.Vector2(1,l)]);var c=this.player.mode===Oe.PANORAMA?new THREE.MeshBasicMaterial({color:He.path.color,side:THREE.DoubleSide,transparent:!0,depthWrite:!1,opacity:0,name:"paveT",map:this.pathImg.path}):new THREE.MeshBasicMaterial({color:He.path.color,side:THREE.DoubleSide,transparent:!0,depthWrite:!1,opacity:1,name:"paveO",map:this.pathImg.path});return new THREE.Mesh(o,c)}},{key:"makeWaypointObj",value:function(e,t){var n=new THREE.Geometry,o=this.player.mode===Oe.PANORAMA?He.path.waypointIndoorRadius:He.path.waypointRadius,i=this.pathHeight();n.vertices.push(new THREE.Vector3(-o,i,o),new THREE.Vector3(-o,i,-o),new THREE.Vector3(o,i,-o),new THREE.Vector3(o,i,o)),n.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(2,3,0)),n.faceVertexUvs[0].push([new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)]),n.faceVertexUvs[0].push([new THREE.Vector2(1,1),new THREE.Vector2(0,1),new THREE.Vector2(0,0)]);var r=THREE.UniformsUtils.clone(Ht.waypoint.uniforms);r.map.value=e,r.opacity.value=0,r.color.value.set(He.path.color);var a={side:THREE.DoubleSide,depthWrite:!1,depthTest:!1,transparent:!0,vertexShader:Ht.waypoint.vertexShader,fragmentShader:Ht.waypoint.fragmentShader,uniforms:r,name:"waypoint",opacity:0};this.player.mode!==Oe.PANORAMA&&(a.depthTest=!1,a.name="wayPtOut");var s=new THREE.RawShaderMaterial(a),l=new THREE.Mesh(n,s);return l.renderOrder=Xe,l.name=t,l}},{key:"makeStartMarker",value:function(e,t){var n=(new THREE.Vector3).copy(t[1]).sub(t[0]);n.y=0,n.normalize();var o=Math.acos(n.x),i=this.makeWaypointObj(this.pathImg.pathStart,"Start");return i.rotateOnAxis(new THREE.Vector3(0,1,0),o),i.position.copy(e),i}},{key:"makeEndMarker",value:function(e){var t=this.makeWaypointObj(this.pathImg.pathEnd,"End"),n=this.model.panos.get(this.nodes[0]).floor.floorIndex,o=this.model.panos.get(this.nodes[this.nodes.length-1]).floor.floorIndex;return n<o?t.material.uniforms.color.value.set(He.path.colorUp):n>o&&t.material.uniforms.color.value.set(He.path.colorDown),t.position.copy(e),t}},{key:"pathClean",value:function(e){if(e){for(var t in e.children)this.pathClean(e.children[t]);e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}}},{key:"discardPathObject",value:function(){if(this.obj3d){var e=this.obj3d.parent;e&&e.remove(this.obj3d),this.pathClean(this.obj3d)}this.obj3d=null,this.popInCpm()}},{key:"discardSlow",value:function(){if(this.obj3d){if(this.player.mode!==Oe.PANORAMA)return void this.discardPathObject();for(var e,t=0,n=function(){this.discardPathObject()}.bind(this),o=0;o<this.obj3d.children.length;o+=1)void 0!==(e=this.obj3d.children[o]).material&&!0===e.material.transparent&&(void 0!==e.material.uniforms?Se.start(nt.property(e.material.uniforms.opacity,"value",0),He.path.fadeOutTime,n,0,Ie[He.warp.blendEasing]):Se.start(nt.property(e.material,"opacity",0),He.path.fadeOutTime,n,0,Ie[He.warp.blendEasing]),t+=1,n=null);0===t&&this.discardPathObject(),this.player.mode!==Oe.PANORAMA&&this.fadeInCpm(He.path.fadeInTime-3)}}},{key:"appearSlow",value:function(){var e;this.fadeOutCpm(He.path.fadeInTime);for(var t=this.player.mode===Oe.PANORAMA?He.path.opacity:1,n=0;n<this.obj3d.children.length;n+=1)void 0!==(e=this.obj3d.children[n]).material&&!0===e.material.transparent&&(void 0!==e.material.uniforms?Se.start(nt.property(e.material.uniforms.opacity,"value",t),He.path.fadeInTime,null,0,Ie[He.warp.blendEasing]):Se.start(nt.property(e.material,"opacity",t),He.path.fadeInTime,null,0,Ie[He.warp.blendEasing]))}},{key:"update",value:function(){this.obj3d&&this.obj3d.updateMatrixWorld()}},{key:"calcBurnsAmount",value:function(e){var t=THREE.Math.degToRad(He.warp.burnsAngle);if(this.player.mode===Oe.PANORAMA){var n=this.burnsDir*t;if(this.upcomingTransType===De)return n;var o=e;if(null===o)return ke.warn("Transition request for non-highlight"),n;var i=this.getHeroDescriptorByHeroIndex(o);if(null===i)return n;if(!i.isPano())return n;var r=this.getHeroPano(i),a=this.playerControls.cameras[Oe.PANORAMA],s=Fe.FORWARD.clone().applyQuaternion(a.quaternion).setY(0).normalize(),l=Math.min(THREE.Math.degToRad(He.warp.minBurnsAngle),t),c=function(e){var n=Math.acos(Math.min(1,e.dot(s))),o=(new THREE.Vector3).crossVectors(s,e);return Math.max(l,Math.min(Math.abs(n),t))*Math.sign(o.y)};if(r===this.player.currentPano)return c(Fe.FORWARD.clone().applyQuaternion(i.quaternion).setY(0).normalize());var u=this.findShortestPath(this.player.currentPano,r);if(null==u||u.length<1)return ke.debug("Empty path ahead..."),n;var h=this.makePathHulls(u),d=new THREE.CatmullRomCurve3(h.camera),p=Math.min(.1,He.warp.lookAheadDist/d.getLength());return c(d.getPointAt(p).clone().sub(a.position).setY(0).normalize())}return this.player.mode===Oe.DOLLHOUSE?.02*this.burnsDir:this.burnsDir}},{key:"waitNextStep",value:function(e,t){var n=He.warp.tourStepDelay;n||(n=this.lastTransType===De?constants.tourStepDelaySlideShow:constants.tourStepDelayDefault);var o=new THREE.Euler,i=new THREE.Vector3;ke.debug("Starting wait: "+(void 0!==t));var r=this.calcBurnsAmount(e),a=function(){this.endWarpState(),this.player.mode===Oe.DOLLHOUSE&&(this.playerControls.cameras[Oe.DOLLHOUSE].controls.rotationAcceleration.x=0),t&&t()}.bind(this),s=function(e,t){if(this.warpInterrupted)return a(),!0;var s=t||1e3/60;if(He.warp.doBurns)if(this.player.mode===Oe.PANORAMA){var l=this.playerControls.cameras[Oe.PANORAMA];o.setFromQuaternion(WarpcameraStyle.quaternion,He.warp.eOrder);var c=s*r/n;o.y+=c,i.set(0,0,-1),i.applyEuler(o),i.add(l.position),l.controls.lookAt(i),l.controls.lookVector.copy(i),l.lookAt(i)}else this.player.mode===Oe.DOLLHOUSE?this.playerControls.controls[Oe.DOLLHOUSE].rotationAcceleration.x=r:this.playerControls.controls[Oe.FLOORPLAN].absoluteScale*=.9996}.bind(this);this.startWarpState(),Se.start(s,n,a,0,Ie.easeInOutQuad,"wait")}},{key:"warpToNonPano",value:function(e){if(this.discardPathObject(),this.warpDestHeroLoc.cameraMode===Oe.DOLLHOUSE||this.warpDestHeroLoc.cameraMode===Oe.FLOORPLAN){var t=function(){e&&e()}.bind(this);this.player.flyToNewMode({mode:this.warpDestHeroLoc.cameraMode,duration:He.warp.outsideTime,warpDest:this.warpDestHeroLoc,callback:t,force:!0})}else ke.warn("no warp destination!!!"),e&&e()}},{key:"_resetWarpShaderParams",value:function(e){this.player.mode===Oe.PANORAMA&&(void 0!==e.material.uniforms.blackout&&(e.material.uniforms.blackout.value=0),void 0!==e.material.uniforms.modelAlpha&&(e.material.uniforms.modelAlpha.value=0))}},{key:"_clearWarpShading",value:function(){for(var e=this.model.chunks,t=0;t<e.length;t+=1)this._resetWarpShaderParams(e[t]),e[t].visible=!0;this._resetWarpShaderParams(this.model.skybox)}},{key:"_warpStopFlying",value:function(){this.activeTransType=null,this.placeCpm()}},{key:"_wrapupTravelOnlyBits",value:function(){this._warpStopFlying(),this.warpPathPoints&&(this.player.currentPano.exit(),this.warpDestPano.enter(),this.player.currentPano=this.warpDestPano),this.placeCpm()}},{key:"_wrapupTravel",value:function(e){this._wrapupTravelOnlyBits(),this.warpCameraAim(e)}},{key:"_wrapupWarpShading",value:function(e){this._clearWarpShading(),this._wrapupTravel(e)}},{key:"wrapupWarpShadingOnly",value:function(e,t){t!==Bi&&this._clearWarpShading(),this._wrapupTravelOnlyBits(),this.upcomingTransType=null,e&&e()}},{key:"_warpCameraAim",value:function(e,t){var n=this.warpDestHeroLoc.quaternion,o=this.playerControls.cameras[Oe.PANORAMA],i=new THREE.Vector3(0,0,1).applyQuaternion(n).normalize(),r=new THREE.Vector3(0,0,1).applyQuaternion(o.quaternion).normalize().dot(i),a=THREE.Math.radToDeg(Math.acos(r)),s=new THREE.Euler(0,0,0,He.warp.eOrder).setFromQuaternion(n,He.warp.eOrder),l=(new THREE.Euler).setFromQuaternion(o.quaternion,He.warp.eOrder),c=new THREE.Euler(s.x-l.x,s.y-l.y,s.z-l.z,He.warp.eOrder);c.y=be.constrainedTurn(c.y),this.burnsDir=Math.sign(c.y);var u=new THREE.Euler(0,0,0,He.warp.eOrder),h=new THREE.Vector3,d=function(e,t){return!!this.warpInterrupted||(u.x=l.x+e*c.x,u.y=l.y+e*c.y,u.z=l.z+e*c.z,h.set(0,0,-1),h.applyEuler(u),h.add(o.position),o.controls.lookAt(h),o.controls.lookVector.copy(h),void o.lookAt(h))}.bind(this);return a>He.warp.minRotation?Se.start(d,e,t,0,Ie[He.warp.movementEasing]):(ke.debug("Aim angle only is "+a.toPrecision(3)+" degrees, skipping explicit re-aim"),void(t&&t()))}},{key:"_warpBendAim",value:function(e,t,n,o){var i=o||0,r=this.playerControls.cameras[Oe.PANORAMA],a=new THREE.Euler(0,0,0,He.warp.eOrder).setFromQuaternion(this.warpDestHeroLoc.quaternion,He.warp.eOrder),s=(new THREE.Euler).setFromQuaternion(r.quaternion,He.warp.eOrder),l=new THREE.Euler(a.x-s.x,a.y-s.y,a.z-s.z,He.warp.eOrder);l.y=be.constrainedTurn(l.y);var c=Math.min(THREE.Math.degToRad(He.warp.softBendTilt),Math.abs(l.x));l.x=c*Math.sign(l.x),c=Math.min(THREE.Math.degToRad(Math.max(0,He.warp.softBendAngle)),c),this.burnsDir=Math.sign(l.y),c*=Math.sign(l.y),l.y=c;var u=new THREE.Euler(0,0,0,He.warp.eOrder),h=new THREE.Vector3,d=function(e,t){if(e<.5)u.x=s.x+e*l.x,u.y=s.y+e*l.y,u.z=s.z+e*l.z;else{var n=(1-e)*He.warp.softBendEnd;u.x=a.x-n*l.x,u.y=a.y-n*l.y,u.z=a.z-n*l.z}h.set(0,0,-1),h.applyEuler(u),h.add(r.position),r.controls.lookAt(h),r.controls.lookVector.copy(h),r.lookAt(h)}.bind(this);return Se.start(d,t,n,i,Ie[He.warp.movementEasing])}},{key:"_warpStepCameraAim",value:function(e,t,n){var o=this.playerControls.cameras[Oe.PANORAMA],i=new THREE.Euler(0,0,0,He.warp.eOrder).setFromQuaternion(this.warpDestHeroLoc.quaternion,He.warp.eOrder),r=(new THREE.Euler).setFromQuaternion(o.quaternion,He.warp.eOrder),a=new THREE.Euler(i.x-r.x,i.y-r.y,i.z-r.z,He.warp.eOrder);a.y=be.constrainedTurn(a.y),this.burnsDir=Math.sign(a.y);var s=new THREE.Euler(0,0,0,He.warp.eOrder),l=new THREE.Vector3,c=function(e,t){e<.5?s.copy(r):s.copy(i),l.set(0,0,-1),l.applyEuler(s),l.add(o.position),o.controls.lookAt(l),o.controls.lookVector.copy(l),o.lookAt(l)}.bind(this);return Se.start(c,t,n,0,Ie[He.warp.movementEasing])}},{key:"setBurnsDir",value:function(){var e=this.playerControls.cameras[Oe.PANORAMA],t=new THREE.Euler(0,0,0,He.warp.eOrder).setFromQuaternion(this.warpDestHeroLoc.quaternion,He.warp.eOrder),n=(new THREE.Euler).setFromQuaternion(e.quaternion,He.warp.eOrder),o=new THREE.Euler(t.x-n.x,t.y-n.y,t.z-n.z,He.warp.eOrder);o.y=be.constrainedTurn(o.y),this.burnsDir=Math.sign(o.y)}},{key:"stepWarpPath",value:function(e,t){var n=this.playerControls.cameras[Oe.PANORAMA],o=this.warpPathPoints?this.warpPathPoints[0]:e;if(!o)return n.position.copy(this.warpDestPano.position),!0;var i=this.warpDestPano.position;if(null!==this.nodes&&this.cameraHull&&this.cameraHull.length>1){var r=new THREE.Vector3;t<.5?r.copy(this.cameraHull[1]).sub(o).normalize().multiplyScalar(He.warp.softPushDist*t).add(o):r.copy(this.cameraHull[this.cameraHull.length-2]).sub(i).normalize().multiplyScalar(He.warp.softPushDist*He.warp.softPushEnd*(1-t)).add(i),n.position.copy(r)}else t<.5?n.position.copy(o):n.position.copy(i)}},{key:"interruptAndFastForward",value:function(e,t){this.warping&&(this.warpInterrupted=!0,this.warpInterruptionBlackoutStyle=e,this.warpInterruptionTravelTime=t,null!==this.warpInterruptionBlackoutStyle&&void 0!==this.warpInterruptionBlackoutStyle||(this.warpInterruptionBlackoutStyle=Ni),null!==this.warpInterruptionTravelTime&&void 0!==this.warpInterruptionTravelTime||(this.warpInterruptionTravelTime=He.minWarpTime))}},{key:"warpCameraAim",value:function(e){var t=He.warp.minWarpTime;if(this.upcomingTransType===De)t=He.warp.teleportTime;else{var n=this.playerControls.cameras[Oe.PANORAMA],o=new THREE.Euler(0,0,0,He.warp.eOrder).setFromQuaternion(this.warpDestHeroLoc.quaternion,He.warp.eOrder),i=(new THREE.Euler).setFromQuaternion(n.quaternion,He.warp.eOrder),r=new THREE.Euler(o.x-i.x,o.y-i.y,o.z-i.z,He.warp.eOrder);r.y=be.constrainedTurn(r.y);var a=1e3*Math.abs(r.y)/THREE.Math.degToRad(He.warp.maxAimPerSec);t=Math.max(t,a)}var s=function(){this._warpStopFlying(),this.discardSlow(),e&&e()}.bind(this);this._warpCameraAim(t,s)}},{key:"warpCommonParameters",value:function(e,t,n,o){this.model.skybox.material.uniforms.blackout.value=o;var i=nt.uniform(this.model.skybox,"progress",1),r=nt.allUniforms(this.model.chunks,"progress",1),a=!1,s=function(){if(this.warpInterrupted)return a=!0,!0}.bind(this),l=function(e,t){return n&&a?(this.model.skybox.material.uniforms.progress.value=0,!0):void i(e,t)}.bind(this),c=function(e,t){return n&&a?(r(0),!0):void r(e,t)}.bind(this);Se.start(s,e,null,t,null,"safeHaltWatch"),Se.start(l,e,null,t,Ie[He.warp.blendEasing],"skyboxProgress"),Se.start(c,e,null,t,Ie[He.warp.blendEasing],"chunkProgress")}},{key:"warpTravel_STD",value:function(e){var t,n=Math.min(He.warp.lookAheadMax,He.warp.lookAheadDist/this.warpLength),o=this.playerControls.cameras[a.PANORAMA],i=(Math.min(.25,3/this.warpLength),Math.min(.35,7/this.warpLength)),r=new THREE.Euler(0,0,0,He.warp.eOrder),s=new THREE.Vector3,c=(new THREE.Euler).setFromQuaternion(o.quaternion,He.warp.eOrder),u=(new THREE.Euler).copy(c),h=o.position.clone(),p=new THREE.Matrix4,f=new THREE.Euler,m=He.warp.minWarpTime;m+=this.warpLength*He.warp.timePerMeter,He.warp.flySpeed>.01&&(m=1e3*this.warpLength/He.warp.flySpeed);var v=!1,y=this.warpDestHeroLoc.quaternion,w=new THREE.Vector3(0,0,-1).applyQuaternion(y).normalize(),b=this.warpPathPoints[this.warpPathPoints.length-1].clone().sub(this.warpPathPoints[this.warpPathPoints.length-2]).normalize(),E=b.dot(w),x=THREE.Math.radToDeg(Math.acos(E)),T=function(e){var t=i;return THREE.Math.smoothstep(e,0,t)*(1-THREE.Math.smoothstep(e,1-t,1))},P=function(){return p.lookAt(h,t,Fe.UP),r.setFromRotationMatrix(p,He.warp.eOrder),c.setFromQuaternion(o.quaternion,He.warp.eOrder),f.set(r.x-c.x,r.y-c.y,r.z-c.z,He.warp.eOrder),be.constrainedTurn(f.y)}.bind(this),k=function(e,t){if(this.warpInterrupted)return v=!0,!0}.bind(this),M=function(e,t){return v||!this.warpPathPoints?(effects.blur(0),!0):void effects.blur(e)}.bind(this),R=nt.allUniforms(this.model.chunks,"modelAlpha",1),I=function(e,t){return v||!this.warpPathPoints?(R(0),!0):void R(e,t)}.bind(this),S=function(e,t){if(!this.warpPathPoints)return o.position.copy(this.warpDestPano.position),!0;if(v)return!0;var n=this.interpAlongPath(this.warpPathPoints,this.warpPathLengths,e);o.position.copy(n),h=this.interpAlongPath(this.warpPathPoints,this.warpPathLengths,.99*e)}.bind(this),C=function(e,o){return this.warpPathPoints?!!v||void(t=this.interpAlongPath(this.warpPathPoints,this.warpPathLengths,Math.min(e+n,1))):(ke.debug("Lost bunny."),!0)}.bind(this),A=function(e,i){if(v)return ke.debug(">>>> Walkthrough interupted at t="+e),!0;if(!this.warpPathPoints)return!0;var a=this.warpLength*e,l=THREE.Math.smoothstep(a,0,this.brushPrefs.lookBlendDist),d=THREE.Math.smoothstep(a,this.warpLength-this.brushPrefs.lookBlendDist,this.warpLength);He.warp.matchCam&&(l*=1-d),p.lookAt(h,t,Fe.UP),r.setFromRotationMatrix(p,He.warp.eOrder),c.setFromQuaternion(o.quaternion,He.warp.eOrder),f.set(r.x-c.x,r.y-c.y,r.z-c.z,He.warp.eOrder),f.y=be.constrainedTurn(f.y),r.x=c.x+l*f.x,r.y=c.y+l*f.y,r.z=c.z+l*f.z,f.set(r.x-u.x,r.y-u.y,r.z-u.z,He.warp.eOrder),f.y=be.constrainedTurn(f.y);var m=THREE.Math.degToRad(He.warp.maxTurnPerSec)*i/1e3;f.y=Math.sign(f.y)*Math.min(m,Math.abs(f.y)),u.x=u.x+f.x*He.warp.turnFriction,u.y=u.y+f.y*He.warp.turnFriction,u.z=u.z+f.z*He.warp.turnFriction,u.x=Math.max(THREE.Math.degToRad(He.warp.minDownAngle),u.x);var g=t.clone().sub(h).normalize();if(x<He.warp.maxAimRotation&&d>0){var y=1-d;g.x=g.x*y+d*b.x,g.y=g.y*y+d*b.y,g.z=g.z*y+d*b.z,g.normalize()}this.bunnyObj.position.copy(o.position).add(g),s.set(0,0,-1).applyEuler(u).normalize(),s.multiplyScalar(8),s.add(o.position),e>1-n&&He.warp.matchCam||(o.controls.lookAt(s),o.controls.lookVector.copy(s),o.lookAt(s))}.bind(this),D=function(){v?(this.discardSlow(),this.upcomingTransType=l.BLACK,this.warpTravel_BLACK(-.5,this.warpInterruptionTravelTime,ji,e)):this._wrapupWarpShading(e)}.bind(this);C(0);var L=He.warp.motionLeadTime+1e3*Math.abs(P())/THREE.Math.degToRad(He.warp.maxTurnPerSec),z=L/(m+=L);this.warpCommonParameters(m,z,!0,Fi),Se.start(k,m,null,0,null,"_haltWatcher"),He.warp.blur>0&&(g.blurStrength=He.warp.blur,Se.start(M,m,null,z,T,"blurring")),Se.start(I,m,null,z,T,"modelAlpha"),Se.start(S,m,null,z,d[He.warp.blendEasing],"followPath"),Se.start(C,m,null,z,d[He.warp.blendEasing],"goBunny"),Se.start(A,m,D,0,d[He.warp.blendEasing],"lookAtBunny")}},{key:"warpTravel_BLACK",value:function(e,t,n,o){this.player.model.floorLogos.firstLogo.visible=!1,this.player.model.floorLogos.secondLogo.visible=!1;var i=e||0;null!=t||(t=He.warp.teleportTime),this.warpCommonParameters(t,i,!1,n),this.model.chunks.forEach((function(e){e.material.uniforms.blackout.value=n})),this._warpBendAim(null,t,null,i);var r=function(){this.wrapupWarpShadingOnly(o,n)}.bind(this),a=this.player.position.clone();Se.start(this.stepWarpPath.bind(this,a),t,r,i,Ie[He.warp.blendEasing],"stepMotion")}},{key:"makeWalkFlightFunc",value:function(e,t,n){return this.flightStepWalk.bind(this,e,t,n)}},{key:"getOrientationForWalkingTourNode",value:function(e,t,n){var o=e.length;if(t>=o)return!1;if(t===o-1)n.copy(Fe.FORWARD).applyQuaternion(this.warpDestHeroLoc.quaternion);else{var i=this.player.model.panos.get(e[t]),r=this.player.model.panos.get(e[t+1]);n.copy(r.position).sub(i.position)}return n.normalize(),!0}},{key:"warpCameraTravel",value:function(e,t,n,o){if(this.activeTransType=this.upcomingTransType,this.lastTransType=this.activeTransType,this.upcomingTransType=null,e)this.activeTransType===De?this.warpTravel_BLACK(null,n,t,o):this.activeTransType===ze?this.warpTravel_WALK(function(){this._clearWarpShading(),this._warpStopFlying(),this.player.spider.draw(),this.placeCpm(),o&&o()}.bind(this)):this.warpTravel_STD(o);else{var i=function(){this._wrapupTravel(o)}.bind(this),r={pano:this.warpDestPano,lookAtPoint:null,duration:null,maxDistanceOverride:null,skipWarpingCheck:!1};this.player.flyToPano(r,i)}}},{key:"startWarpState",value:function(){this.warping=!0,this.warpInterrupted=!1,this.warpInterruptionBlackoutStyle=null,this.warpInterruptionTravelTime=null}},{key:"endWarpState",value:function(){this.warping=!1}},{key:"warpToPano",value:function(e,t,n,o){if(this.warping)ke.warn("Cannot warp when already warping");else{if(this.upcomingTransType=e,this.activeTransType=null,!this.setWarpDestPano())return this.upcomingTransType=null,void this.warpToNonPano(o);if(this.player.mode!==Oe.PANORAMA)return this.upcomingTransType=null,this.discardSlow(),void this.player.flyToNewMode({mode:Oe.PANORAMA,pano:this.warpDestPano,duration:He.warp.outsideTime,warpDest:this.warpDestHeroLoc,callback:o,force:!0});if(!this.warpDestPano)return ke.warn("no warp destination, callback dropped"),void(this.upcomingTransType=null);var i=!(this.model.panos.isNeighbour(this.player.currentPano,this.warpDestPano)&&this.warpDestPano!==this.player.currentPano&&this.warpDestPano.position.distanceTo(this.player.currentPano.position)<He.warp.nearPanoDist),r=this.chooseWarpPath(i);if(r&&this.upcomingTransType!==ze){var a=function(){this.waitingToWarp=!1,this.warpToPano(e,t,n,o)}.bind(this);if(this.player.checkAndWaitForPanoLoad(this.warpDestPano,"high","low",this.player.basePanoSize,a))return void(this.waitingToWarp=!0)}this.player.currentPano||(ke.warn("Arrived at a very strange spot!"),this.player.currentPano=this.warpDestPano,this.placeCpm(),this.fadeOutCpm(He.path.fadeOutTime),this.player.spider.draw()),ke.debug("Warping to pano ",this.warpDestPano.position),this.upcomingTransType!==ze&&this.player.emit(Ko,this.player.currentPano,this.warpDestPano),this.startWarpState();var s=function(){this.endWarpState(),o&&o()}.bind(this);r?this.warpCameraTravel(i,t,n,s):this.warpCameraAim(s),this.player.smoothZoomToDefault(He.zoom.restoreTime)}}}]),e}(),Zi="zoom.in",Qi="zoom.out",Gi="zoom.max",qi="zoom.min";function Yi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var $i=function(e){f(n,EventEmitter);var t=Yi(n);function n(e){var o;return i(this,n),(o=t.call(this)).player=e,o.instances=new Map,o.video=null,o}return u(n,[{key:"addVideo",value:function(e){var t=this._createVideo(this._getVideoPath(e));return this.instances.set(e,t),t}},{key:"getVideo",value:function(e){var t=this.instances.get(e);return t||(t=this.addVideo(e)),t.videoElement}},{key:"_getVideoPath",value:function(e){return this.player.$app.resource.getUserResourceURL(e+".flv")}},{key:"_createVideo",value:function(e){var t=document.createElement("video");t.setAttribute("crossOrigin","anonymous"),t.setAttribute("playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("controls","true"),t.autoplay=!1,t.muted=!0,t.loop=!0,t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.zIndex="1000",t.style.width="200px",t.style.display="none",t.player=this;var n=flvjs.createPlayer({type:"flv",url:e});return n.videoElement=t,n.attachMediaElement(t),n.on(flvjs.Events.ERROR,this._onPlayerError.bind(this)),n.load(),n}},{key:"_onPlayerError",value:function(){console.warn("视频加载失败")}}]),n}();function Xi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Ji=function(e){f(n,EventEmitter);var t=Xi(n);function n(e){var o;return i(this,n),(o=t.call(this)).player=e,o.video=null,o.videos=new Map,o}return u(n,[{key:"addVideo",value:function(e){var t=this._createVideoElement(this._getVideoPath(e));return this.videos.set(e,t),t}},{key:"getVideo",value:function(e){var t=this.videos.get(e);return t||(t=this.addVideo(e)),t}},{key:"_getVideoPath",value:function(e){return this.player.$app.resource.getUserResourceURL(e+".mp4")}},{key:"_createVideoElement",value:function(e){var t=document.createElement("video");return t.setAttribute("crossOrigin","anonymous"),t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("x5-video-player-type","h5"),t.setAttribute("controls","true"),t.autoplay=!0,t.muted=!0,t.loop=!0,t.src=e,t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.zIndex="1000",t.style.width="300px",t.style.height="300px",t.style.display=Ce.urlHasValue("debug")?"block":"none",t}}]),n}();function Ki(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var er=function(e){f(n,THREE.Object3D);var t=Ki(n);function n(e,o){var r;i(this,n),(r=t.call(this)).player=e,r._planeGeometry=new THREE.PlaneGeometry(He.overlay.width,He.overlay.height,1,1),r._boxGeometry=new THREE.BoxBufferGeometry(He.overlay.width,He.overlay.height,He.overlay.depth);var a=L(r._boxGeometry.index.array);a.splice(24,6),r._boxGeometry.setIndex(new THREE.BufferAttribute(new Uint16Array(a),1)),r._boxMat=new THREE.MeshBasicMaterial({color:"#eeeeee",transparent:!0,opacity:.8});var s=Ce.detectAndroidMobile()&&Ce.detectWeixin()&&!Ce.detectWeixinMiniProgram();return r.overlayVideoPlayer=s?new $i(r.player):new Ji(r.player),console.log("nonsupportH5Video? "+s),r.info=o,r.sid=o.sid,r.build(o),r.name="overlay_"+r.sid,r.floor=r.player.model.floors.get(o.floorIndex)||r.raycastToFindFloor(),r.updateVisibleOnFloor(),r}return u(n,[{key:"raycastToFindFloor",value:function(){return this.floor=Pe.raycastToFindFloor(this.player,this.plane.getWorldPosition()),this.floor||(console.error("Overlay raycastToFindFloor cannot find floor？"),this.floor=this.model.floors.first()),this.floor}},{key:"updateVisibleOnFloor",value:function(e){(this.player.model.currentFloor==this.floor||this.player.model.allFloorsVisible||"panorama"==this.player.modeTran.split("-")[1]||this.player.EditOverlay&&this.player.EditOverlay.editPlane==this)&&!this.info.hide?this.visible=!0:this.visible=!1}},{key:"build",value:function(e){var t=new THREE.Mesh(this._planeGeometry,new THREE.MeshBasicMaterial({color:"#00c8af",opacity:.4,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-.9,polygonOffsetUnits:-4}));if(t.renderOrder=3,this.add(t),this.plane=t,this.player.OverlayManager.add(this),e.media){if(e.media.includes("video"))e.media=this.overlayVideoPlayer.getVideo(e.sid),e.type="video",e.media.addEventListener("ended",(function(){e.media.play(),e.media.paused?console.log("overlay没重复播放成功 需要点击"):console.log("重播放成功")}));else if(e.media.includes("photo")){var n=new Image;n.crossOrigin="anonymous",n.src=this.player.$app.resource.getUserResourceURL(e.poster),e.media=n,e.type="photo"}t.material.opacity=1,t.material.color=new THREE.Color(1,1,1)}null==e.width&&(e.width=He.overlay.width),null==e.height&&(e.height=He.overlay.height),this.setFromInfo(e),e.hasBox&&this.addBox(!0)}},{key:"setFromInfo",value:function(e){var t=this.plane;e.width&&(this.scale.setX(e.width/He.overlay.width),this.width=e.width),e.height&&(this.scale.setY(e.height/He.overlay.height),this.height=e.height),e.depth&&this.scale.setZ(e.depth/He.overlay.depth,this.depth=e.depth),e.pos&&this.position.copy(e.pos),e.qua&&this.quaternion.copy(e.qua),e.hide&&(this.visible=!e.hide),e.type&&(t.material.map?(t.material.map.image=e.media,t.material.map.needsUpdate=!0):("video"==e.type?t.material.map=new THREE.VideoTexture(e.media):(t.material.map=new THREE.Texture(e.media),t.material.map.needsUpdate=!0),t.material.map.wrapS=t.material.map.wrapT=THREE.ClampToEdgeWrapping,t.material.map.minFilter=THREE.LinearFilter,t.material.map.magFilter=THREE.LinearFilter,t.material.map.generateMipmaps=!0),this.file=e.file),this.overlayType=e.type,!!this.hasBox!=!!e.hasBox&&this.addBox(!this.hasBox)}},{key:"addBox",value:function(e){if(e!=!!this.hasBox){if(e){var t=new THREE.Mesh(this._boxGeometry,this._boxMat);t.position.set(0,0,He.overlay.depth/2),t.renderOrder=3,this.plane.position.set(0,0,He.overlay.depth),this.add(t),this.box=t}else this.plane.position.set(0,0,0),this.remove(this.box),this.box=null;this.hasBox=e,this.updateMatrixWorld()}}},{key:"dispose",value:function(){this.plane.material.dispose(),this.plane.material.map=null,this.parent.remove(this)}}]),n}(),tr={priorityEvent:[{hoverOverlay:"pointer"},{addOverlay:"url(https://4dkk.4dage.com/v3-test/img/box_video.png),auto"},{hoverFootMarker:"pointer"}],list:[],currentCursorIndex:null,init:function(e){this.domElements=[e.domElement]},add:function(e){var t=this.priorityEvent.find((function(t){return t[e]}));t?this.list.includes(e)||(this.judge({addItem:t,name:e}),this.list.push(e)):console.error("CursorDeal  未定义优先级 name:"+e)},remove:function(e){var t=this.list.indexOf(e);t>-1&&(this.list.splice(t,1),this.judge())},judge:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t.addItem){var n=this.priorityEvent.indexOf(t.addItem);(n<this.currentCursorIndex||null==this.currentCursorIndex)&&(this.domElements.forEach((function(e){return e.style.cursor=t.addItem[t.name]})),this.currentCursorIndex=n)}else{var o={index:1/0,cursor:null};this.list.forEach((function(t){var n=e.priorityEvent.find((function(e){return e[t]})),i=e.priorityEvent.indexOf(n);i<o.index&&(o.index=i,o.cursor=n[t])})),this.currentCursorIndex=o.index,this.domElements.forEach((function(e){return e.style.cursor=o.cursor||""}))}}};function nr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var or=function(e){f(n,EventEmitter);var t=nr(n);function n(e){var o;i(this,n),(o=t.call(this)).player=e,o.group=new THREE.Object3D,o.group.name="OverlayGroup",e.OverlayManager=h(o),o.withBox=!0,o.lineMat=An.createFatLineMat({alwaysShow:!0,width:W.isMobile?2:3,color:"#4fffff",opacity:.3}),o.model=o.player.model,o.model.add(o.group),o.player.$app.core.get("SceneRenderer").addComponent(h(o)),o.VideoManager=o.player.$app.VideoManager;var r=o.player.$app.store.getValue("metadata");if(r.boxVideos&&r.boxVideos.length){var a=r.boxVideos[0];a.pos=(new THREE.Vector3).fromArray(a.pos),a.qua=(new THREE.Quaternion).fromArray(a.qua),o.add(new er(o.player,a))}return r.boxPhotos&&r.boxPhotos.length&&r.boxPhotos.forEach((function(e){e.pos=(new THREE.Vector3).fromArray(e.pos),e.qua=(new THREE.Quaternion).fromArray(e.qua),o.add(new er(o.player,e))})),o}return u(n,[{key:"add",value:function(e){this.group.add(e)}},{key:"show",value:function(e,t){this.group.children.forEach((function(n){t&&n.info.hide||"all"!=e&&n.floor.floorIndex!=e||(n.visible=!0)}))}},{key:"hide",value:function(e){this.group.children.forEach((function(t){"all"!=e&&t.floor.floorIndex!=e||(t.visible=!1)}))}},{key:"setSize",value:function(e,t){this.openOverlay&&this.resizeOverlay()}},{key:"hoverOverlay",value:function(e,t){var n=this;if(this.group.visible){var o;if(this.withBox&&e?e=(o=e.parent).plane:o=e,e){if(tr.add("hoverOverlay"),o.visible&&o!=this.hoveringPlane){this.hoveringPlane&&this.hoverOverlay(null);for(var i=e.geometry.vertices,r=new THREE.Object3D,a=[0,1,3,2],s=0;s<4;s++){var l=[i[a[s]].x,i[a[s]].y,i[a[s]].z,i[a[(s+1)%4]%4].x,i[a[(s+1)%4]%4].y,i[a[(s+1)%4]%4].z];r.add(An.createFatLine(l,{material:this.lineMat}))}this.group.children.forEach((function(e){var t=n.withBox?e.plane:e;t.border&&(t.border.children.forEach((function(e){return e.geometry.dispose()})),t.remove(t.border))})),e.border=r,e.add(r),this.hoveringPlane=o,this.lineMat.opacity=0,Se.cancelById(He.freeze.wallLineShine,!0),Se.start(function(e){this.lineMat.opacity=e}.bind(this),200,null,0,Ie[He.transition.blendEasing],"wallLineShine",He.freeze.wallLineShine)}}else{if(this.hoveringPlane){var c=function(){u.border.children.forEach((function(e){e.geometry.dispose()})),u.remove(u.border)},u=this.withBox?this.hoveringPlane.plane:this.hoveringPlane;Se.cancelById(He.freeze.wallLineShine),"soon"==t?(this.lineMat.opacity=0,c()):Se.start(function(e){this.lineMat.opacity=1-e}.bind(this),200,c,0,Ie[He.transition.blendEasing],"wallLineShine",He.freeze.wallLineShine,c),this.hoveringPlane=null}tr.remove("hoverOverlay")}}}},{key:"getMatFromCss",value:function(e){if(e.includes("matrix3d"))var t=e.slice(9,-1).split(",");else t=e.slice(7,-1).split(",");if(t.forEach((function(e,n){t[n]=parseFloat(e)})),16==t.length)var n=(new THREE.Matrix4).fromArray(t);else if(6==t.length)n=(new THREE.Matrix4).fromArray([t[0],t[1],0,0,t[2],t[3],0,0,0,0,1,0,t[4],t[5],0,1]);return n}},{key:"getCssFromMatrix",value:function(e){return"matrix3d("+e.elements+")"}},{key:"getOverlayOpenPos",value:function(e){var t=e.width/(.9*$("#player").width()),n=e.height/(.9*$("#player").height()),o=1/Math.max(t,n),i=-e.width*o/$("#player").width(),r=player.cameraControls.activeControl?player.cameraControls.activeControl.camera:player.camera,a=new THREE.Vector3(i,0,-1).unproject(r).clone().sub(player.camera.position),s=player.getDirection(),l=s.angleTo(a),c=e.width/2/Math.tan(l);this.withBox&&(c+=e.plane.position.length());var u=player.camera.position.clone().add(s.clone().multiplyScalar(c));return this.useCssRender||this.updatePlaneElemStyle(o),u}},{key:"updatePlaneElemStyle",value:function(e){this.openOverlay.elem.css({width:this.openOverlay.width*e+"px",height:this.openOverlay.height*e+"px"})}},{key:"getPlanePos",value:function(e){return this.withBox?(new THREE.Vector3).setFromMatrixPosition(e.plane.matrixWorld):e.position.clone()}},{key:"clickOverlay",value:function(e,t){var n=this;if(!this.openOverlay||e){var o=this.withBox&&e?e.plane:e;"video"==e.overlayType&&o.material.map.image.play();var i=this.model.player.domElement.clientWidth/this.model.player.domElement.clientHeight*Math.tan(THREE.Math.degToRad(this.model.player.zoomFov/2)),r=e.width/2/i;console.log("goodDistance "+r),r*=r,0==Pe.getVisiblePano(e.plane.getWorldPosition(),this.model).length&&console.warn("clickOverlay 找不到visiblePanos");var a={};if(this.player.$app.Camera.flyToPoint(e.position.clone(),{rank:[function(t){var n=new THREE.Vector3(0,0,1).applyQuaternion(e.quaternion),o=t.position.clone().sub(e.position),i=n.angleTo(o);return a[t.id]=i,i=100*-i}],require:[function(t){return t.floorIndex==e.floor.floorIndex}]}),!t){var s=this.player.EditOverlay&&this.player.EditOverlay.editing;if(s&&!(this.player.EditOverlay.editPlane&&this.player.EditOverlay.editPlane.uuid!=e.uuid||this.player.EditOverlay.isAdding&&this.player.domElement.style.cursor.indexOf("box_video.png")<0))return s?(console.log("videos/panel/display面板出现"),void setTimeout((function(){var t=JSON.parse(JSON.stringify(e.info));t.sid=e.sid,t.type=e.overlayType,n.VideoManager.emit("videos/panel/display",t),n.player.EditOverlay.updateOverlayPanel(e),e.updateVisibleOnFloor(),n.player.EditOverlay.controlSelectOverlay(e.visible?e:null)}),10)):void tr.remove("hoverOverlay")}}}}]),n}();function ir(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var rr=function(e){f(n,EventEmitter);var t=ir(n);function n(e){var o;return i(this,n),(o=t.call(this)).editing=!1,o.overlayMaxCount=1,o.meshGroup=new THREE.Object3D,o.player=e,o}return u(n,[{key:"checkIfCanInit",value:function(){return this.player.model&&this.player.model.chunks.length&&this.player.currentPano&&this.player.model.transformControls}},{key:"waitToInit",value:function(){var e=this;console.log("waitToInit");var t=setInterval((function(){e.checkIfCanInit()&&(e.init(),clearInterval(t))}),50)}},{key:"init",value:function(){var e=this;this.checkIfCanInit()?(this.VideoManager=this.player.$app.VideoManager,this.transformControls=this.player.model.transformControls,this.meshGroup.name="overlay-group",this.player.model.add(this.meshGroup),this.meshGroup.visible=!1,this.player.OverlayManager.group.children.forEach((function(t){e.updateOverlayInfo(t)})),window.addEventListener("keydown",(function(t){var n;if(!e.editing){switch(t.which){case 87:n="translate";break;case 82:n="scale"}n&&e.VideoManager.emit("videos/panel/switchTclMode",n),t.stopPropagation()}})),this.enter()):this.waitToInit()}},{key:"enter",value:function(){this.editing||(this.editing=!0,this.meshGroup.visible=!0,this.transformControls.switchEditState("overlay"),this.player.cameraControls.controls.dollhouse.resetRanges(3),this.player.cameraControls.controls.panorama.insideLookLimitDown=W.isMobile?-55:-50)}},{key:"leave",value:function(){this.editing&&(this.editing=!1,this.endAddPlane(),this.meshGroup.visible=!1,this.transformControls.switchEditState(null),this.player.cameraControls.controls.dollhouse.resetRanges(),this.player.cameraControls.controls.panorama.insideLookLimitDown=null)}},{key:"beginToAddPlane",value:function(){this.player.reticule.visible=!1,this.isAdding=!0,tr.add("addOverlay")}},{key:"endAddPlane",value:function(){this.isAdding=!1,tr.remove("addOverlay"),this.player.reticule.visible=!0}},{key:"addOverlay",value:function(e){var t=e.intersect.point,n=new er(this.player,{sid:se.getRandomSid(),floorIndex:this.player.model.currentFloor.floorIndex});n.position.copy(t),this.player.getMouseDirection().angleTo(e.intersect.face.normal)<Math.PI/2?(n.lookAt(e.intersect.face.normal.clone().negate().add(t)),n.position.add(e.intersect.face.normal.clone().negate().multiplyScalar(.01))):(n.lookAt(e.intersect.face.normal.clone().add(t)),n.position.add(e.intersect.face.normal.clone().multiplyScalar(.01))),n.modified="new",n.updateMatrixWorld(),this.player.OverlayManager.clickOverlay(n),this.VideoManager.emit("videos/panel/switchTclMode","translate"),this.endAddPlane()}},{key:"updateOverlayInfo",value:function(e){e.info={width:e.width,height:e.height,depth:He.overlay.depth*e.scale.z,pos:e.position.clone(),qua:e.quaternion.clone(),media:e.plane.material.map.image,file:e.file,type:e.overlayType,hasBox:e.hasBox,hide:!e.visible}}},{key:"undoEdit",value:function(){if(this.editPlane){var e=this.editPlane;"new"==e.modified?this.disposeOverlay(e):(e.setFromInfo(e.info),"delete"==e.modified&&this.player.OverlayManager.add(e))}}},{key:"updateOverlayScaleDisplay",value:function(){var e=this.editPlane,t=Math.abs(e.width)/190,n=Math.abs(e.height)/190,o=1/Math.max(t,n),i=Math.round(Math.abs(e.width)*o),r=Math.round(Math.abs(e.height)*o);console.log(e.width,e.height,e.depth),this.VideoManager.emit("videos/panel/changeSize",{wText:e.width.toFixed(2),hText:e.height.toFixed(2),width:i,height:r,depth:e.depth})}},{key:"updateOverlayPanel",value:function(e){this.editPlane=e;var t=e.plane,n=t.material.map&&t.material.map.image;this.VideoManager.emit("videos/panel/updatePoster",n),this.updateOverlayScaleDisplay(),e.hasBox?this.VideoManager.emit("videos/panel/changeDepth",e.scale.z*He.overlay.depth*100):this.VideoManager.emit("videos/panel/changeDepth",0)}},{key:"controlSelectOverlay",value:function(e){e?this.transformControls.attach(e):this.transformControls.detach()}},{key:"useImgRatio",value:function(e){var t=this.editPlane.plane;if(t.material.map){var n=t.material.map.image,o="video"==this.editPlane.overlayType?n.videoWidth:n.width,i="video"==this.editPlane.overlayType?n.videoHeight:n.height;if("suitSize"==e){var r=Math.min(Math.max(o,i)/200,1);if(o>i)var a=r,s=r*i/o;else s=r,a=r*o/i}else{var l=Math.sqrt(Math.abs(this.editPlane.width*this.editPlane.height)/(o*i));a=l*o*(this.editPlane.width<0?-1:1),s=l*i*(this.editPlane.height<0?-1:1)}this.editPlane.scale.setX(a/He.overlay.width),this.editPlane.scale.setY(s/He.overlay.height),this.editPlane.width=a,this.editPlane.height=s,this.updateOverlayScaleDisplay()}}},{key:"overlayUploaded",value:function(e,t){var n=this.editPlane.plane;t.style.width="100%",t.style.height="100%",t instanceof HTMLVideoElement?(n.material.map=new THREE.VideoTexture(t),n.material.map.image.play(),this.editPlane.overlayType="video",t.autoplay=!0,t.loop=!0,t.volume=0,t.muted=!0):(n.material.map=new THREE.Texture(t),n.material.map.needsUpdate=!0,this.editPlane.overlayType="photo"),n.material.map.minFilter=THREE.LinearFilter,null==this.editPlane.depth&&(this.editPlane.addBox(!0),this.editPlane.depth=.01,this.editPlane.scale.z=.01/He.overlay.depth),this.useImgRatio(),this.editPlane.file=e,n.material.opacity=1,n.material.color=new THREE.Color(1,1,1),n.material.needsUpdate=!0,this.VideoManager.emit("videos/panel/updatePoster",t)}},{key:"getOverlaySavingInfo",value:function(){var e=this.editPlane;if(e.file||e.plane.material.map&&e.plane.material.map.image){var t={width:be.toPrecision(e.width,4),height:be.toPrecision(e.height,4),depth:be.toPrecision(He.overlay.depth*e.scale.z,4),pos:be.toPrecision(e.position.toArray(),4),qua:be.toPrecision(e.quaternion.toArray(),4),sid:e.sid,hasBox:e.hasBox?1:0,media:[e.overlayType],hide:!e.visible,floorIndex:e.floor.floorIndex},n=this;return{data:t,type:"new"==e.modified?1:0,needSaveMedia:!e.info||e.file!=e.info.file,done:function(){e.modified=!1,n.updateOverlayInfo(e)}}}}},{key:"disposeOverlay",value:function(e){e==this.player.OverlayManager.hoveringPlane&&this.player.OverlayManager.hoverOverlay(null,"soon"),e.dispose(),e.modified="delete"}},{key:"DeleteOverlay",value:function(e,t){var n=this;t(e.sid,(function(){n.disposeOverlay(e),n.controlSelectOverlay(null)}))}}]),n}();function ar(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}me("store",(function(){return function(e){f(r,e);var t,n,o=ar(r);function r(){var e;return i(this,r),(e=o.call(this)).__store={},e}return u(r,[{key:"get",value:function(){var e=S(C.mark((function e(t,n){var o;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n&&(this.$app.resource.reload=!0),!this.__store[t]||n){e.next=3;break}return e.abrupt("return",this.__store[t]);case 3:if(o=null,"function"!=typeof this.$app.resource[t]){e.next=8;break}return e.next=7,this.$app.resource[t]();case 7:o=e.sent;case 8:return this.$app.resource.reload=!1,e.abrupt("return",this.__store[t]||o);case 10:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getAppImage",value:(n=S(C.mark((function e(t){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.__store[t]){e.next=2;break}return e.abrupt("return",this.__store[t]);case 2:return e.next=4,this.$app.resource.getAppImage(t);case 4:return e.abrupt("return",this.__store[t]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getUserImage",value:(t=S(C.mark((function e(t){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.__store[t]){e.next=2;break}return e.abrupt("return",this.__store[t]);case 2:return e.next=4,this.$app.resource.getUserImage(t);case 4:return e.abrupt("return",this.__store[t]);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getValue",value:function(e){return this.__store[e]}},{key:"set",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(void 0===e)return this;n&&(this.__store[e]=t),this.emit(e,t)}}]),r}(vo)}));var sr,lr={WalkManger:{enter:'单击<img src="'.concat(In.getImageURL("images/roam/roam_checked.png"),'" crossorigin="anonymous">设置选中点位漫游可行。'),firstPointLimit:"初始点位无法隐藏。",link:"漫游到选中点位时，操作点位可以行走。",unLink:"漫游到选中点位时，操作点位不可行走。",show:"该点位已显示",hide:"已隐藏该点位，漫游时将不再显示",deactive:'单击<img src="'.concat(In.getImageURL("images/roam/roam_visible.png"),'" crossorigin="anonymous">设置点位漫游可行。'),activeHidePoint:'该点位已隐藏，点击<img src="'.concat(In.getImageURL("images/roam/roam_visible.png"),'" crossorigin="anonymous">可显示。')},TagManger:{unLink:"在该点位漫游时不再显示选中热点。"}};function cr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var ur=In.load(In.getImageURL("images/End_256.png")),hr=In.load(In.getImageURL("images/End_unable_256.png"));In.load(In.getImageURL("images/mutil_connect_normal256.png")),In.load(In.getImageURL("images/mutil_connect_unable256.png"));var dr=In.load(In.getImageURL("images/mutil_connect_upper.png")),pr=In.load(In.getImageURL("images/mutil_connect_lower.png")),fr=In.load(In.getImageURL("images/roam/roam_invisible.png")),mr=In.load(In.getImageURL("images/roam/roam_visible.png")),vr=In.load(In.getImageURL("images/roam/roam_uncheck.png")),gr=In.load(In.getImageURL("images/roam/roam_checked.png")),yr=function(){function e(t){var n=this;i(this,e),this.player=t,this.setPanoVisible=!1,this.setMultiFloorPanoVisible=!1,this.setTagVisible=!1,this.footIcons,this.actionIcons,this.activePano,this.panoVLines={},this.panoVTemp,this.tagVsetting,this.tagsVLines={},this.tagVTemp,sr=t.model.panos,this.ifAllPanoNoNeighbor(),this.meshGroup=new THREE.Object3D,this.meshGroup.name="setVisible-group",t.model.add(this.meshGroup),this.player.model.on("floor.changed",(function(e,t){(n.setTagVisible||n.setPanoVisible)&&n.gotoFloor(e.floorIndex)}))}return u(e,[{key:"enterSet",value:function(e){var t=this;if(this.player.$app.gui.toast({event:"DialogList3D.WalkManger.enter",content:lr.WalkManger.enter,showClose:!0}),"panoVisible"==e){if(!this.player.modeTran)return void(this.player.afterCModeFuc=function(){t.enterSet(e)});this.player.flyoutType="beginSetPanoVisible",this.beginSetPanoVisible(),this.setPanoVisible=!0,setTimeout((function(){t.player.flyToMode("floorplan",t.updateFootIconSize.bind(t))}),10)}else this.player.flyToMode("floorplan",this.beginSetTagVisible.bind(this))}},{key:"toggle",value:function(e){var t=this;console.log("walk/Set    "+e);var n=this.activePano;if(e){var o=sr.sortByScore([function(e){return e.isAligned()}],[function(e){return-e.position.distanceTo(n.position)}]);if(1==o.length)return void console.log("仅有一个漫游点");var i=[],r=Math.max(2*-o[1].score,4);if("all"==e)(i=o.filter((function(e){return 0!=e.score&&e.pano.footIcon.visible}))).forEach((function(e){return t.panoVLines[e.pano.id]&&t.panoVLines[e.pano.id].visible||t.dealPanoVisible(e.pano.id)}));else{for(var a=function(e,t){var n=e.position.clone(),o=t.position.clone();return Pe.ifIntersectChunks(n,o,{})},s=1;s<o.length;s++)if(-o[s].score<r)a(n,o[s].pano)&&(o[s].block=!0),o[s].good=!0;else{if(i||(i=o.filter((function(e){return e.good&&!e.block}))),!(i.length<2))break;if(!a(n,o[s].pano))if(0==i.length)i.push(o[s]);else{var l=i[0].pano.position.clone().sub(n.position).setY(0),c=o[s].pano.position.clone().sub(n.position).setY(0);if(l.angleTo(c)>Math.PI/2){console.log("再加一个  角度"+THREE.Math.radToDeg(l.angleTo(c)));break}}}0==i.length&&i.push(o[0]),i.forEach((function(e){return t.dealPanoVisible(e.pano.id)}))}console.log(i)}else{var u=this.player.$app.core.get("Scene").firstView;if(u.pano.footIcon==this.activePano.footIcon&&this.checkHasNeighbor(u.pano,"beforeCreateLine"))return this.player.$app.WalkManager.emit(this.checkLinkStatus()),this.player.$app.gui.toast({event:"DialogList3D.WalkManger.firstPointLimit",content:lr.WalkManger.firstPointLimit,showClose:!0}),!1;for(var h in this.panoVLines)this.panoVLines[h].visible&&this.dealPanoVisible(h)}return!0}},{key:"setDisplay",value:function(e){var t=this;sr.forEach((function(e){return e.updateMarkerVisible(null,t.player)})),this.player.path.currentPanoMarker.mesh.visible=!e,this.player.OverlayManager&&(this.player.OverlayManager.group.visible=!e),this.player.reticule.visible=!e}},{key:"beginSetPanoVisible",value:function(){this.panoVTemp={},this.player.currentPano.floor!=this.player.model.currentFloor&&this.player.gotoFloor(this.player.currentPano.floor.floorIndex),this.SetOnePanoVisible(this.player.currentPano),this.setDisplay(!0),this.player.$app.WalkManager.emit(this.checkLinkStatus(),"enter")}},{key:"SetOnePanoVisible",value:function(e){this.activePano!=e&&(this.activePano=e,this.delVisibleLines(),this.showFootIcons(e,!0),this.createPanoVisiLines(e))}},{key:"checkPanoVisiChange",value:function(){if(Object.keys(this.panoVTemp).length)return!0;for(var e in this.panoVLines){var t=this.panoVLines[e];if(t.name.indexOf("new")>-1&&t.visible)return!0;if(-1==t.name.indexOf("new")&&!t.visible)return!0}return!1}},{key:"saveLastPanoVi",value:function(e){var t=[];for(var n in this.panoVLines){var o=this.panoVLines[n];o.name.indexOf("new")>-1&&o.visible?t.push({type:"add",id:n}):-1!=o.name.indexOf("new")||o.visible||t.push({type:"sub",id:n})}if(t.length){var i=e&&e.id||this.activePano.id;this.savePanoVisiChange(i,t)}}},{key:"savePanoVisiChange",value:function(e,t){for(var n=this.searchNeib(e),o=n.seeMarkers,i=n.neighbourUUIDs,r=n.neighbourPanos,a=0;a<t.length;a++){var s,l=this.searchNeib(t[a].id),c=l.seeMarkers,u=l.neighbourUUIDs,h=l.neighbourPanos;if("add"==t[a].type)c.push(e),u.push(e),h[e]=!0,o.push(t[a].id),i.push(t[a].id),r[t[a].id]=!0;else(s=c.indexOf(e))>-1&&c.splice(s,1),(s=u.indexOf(e))>-1&&u.splice(s,1),h[e]=!1,(s=o.indexOf(t[a].id))>-1&&o.splice(s,1),(s=i.indexOf(t[a].id))>-1&&i.splice(s,1),r[t[a].id]=!1;this.panoVTemp[t[a].id]={neighbourPanos:h,seeMarkers:c,neighbourUUIDs:u}}this.panoVTemp[e]={neighbourPanos:r,seeMarkers:o,neighbourUUIDs:i}}},{key:"pauseSetPanoVisible",value:function(e,t){var n=this;this.setPanoVisible&&("unsaved"==e?this.saveLastPanoVi():(this.panoVTemp={},this.startEditPano=null),this.delVisibleLines(),this.activePano=null,this.showFootIcons(null,!0,t),sr.forEach((function(e){return n.changeIconVisiState(e.footIcon,n.checkHasNeighbor(e))})))}},{key:"finishSetPanoVisible",value:function(){this.setPanoVisible&&(this.setPanoVisible=!1,this.hideFootIcons(),this.delVisibleLines(),this.recoverAllState2(),this.activePano=null,this.startEditPano=null,this.panoVTemp={},this.player.flyoutType=null,this.setDisplay(!1),tr.remove("hoverFootMarker"))}},{key:"savePanoVisibles",value:function(e){this.activePano&&this.saveLastPanoVi(this.activePano);var t=[];for(var n in this.panoVTemp)t.push({panoID:n,visibles:this.turnToPanoIndex(this.panoVTemp[n].seeMarkers),visibles3:this.turnToPanoIndex(this.panoVTemp[n].neighbourUUIDs)});if(0!=t.length)return t;console.warn("PanoLink没有改变")}},{key:"afterSavePanoVisibles",value:function(){var e=this;for(var t in this.panoVTemp){var n=sr.index[t];n.seeMarkers=this.panoVTemp[t].seeMarkers,n.neighbourUUIDs=this.panoVTemp[t].neighbourUUIDs,n.neighbourPanos=this.panoVTemp[t].neighbourPanos}var o=this;if(this.checkHasNeighbor(this.player.currentPano))this.noPanoHasNeighbor=!1;else{var i=sr.sortByScore([function(t){return e.checkHasNeighbor(t)}],[function(e){return-e.position.distanceTo(o.player.currentPano.position)}]);i&&i.length?(this.player.currentPano=i[0].pano,this.noPanoHasNeighbor=!1):this.noPanoHasNeighbor=!0}this.pauseSetPanoVisible(),this.player.$app.WalkManager.emit("walkManager.deactive"),this.updateFootIconSize()}},{key:"searchNeib",value:function(e){var t={};return this.panoVTemp[e]?(t.seeMarkers=this.panoVTemp[e].seeMarkers,t.neighbourUUIDs=this.panoVTemp[e].neighbourUUIDs,t.neighbourPanos=this.panoVTemp[e].neighbourPanos):(t.seeMarkers=sr.index[e].seeMarkers.slice(0),t.neighbourUUIDs=sr.index[e].neighbourUUIDs.slice(0),t.neighbourPanos=se.cloneObject(sr.index[e].neighbourPanos)),t}},{key:"turnToPanoIndex",value:function(e){for(var t=[],n=0;n<e.length;n++){var o=sr.index[e[n]],i=sr.list.indexOf(o);t.push(i)}return t}},{key:"beginSetTagVisible",value:function(){this.setTagVisible||(this.setTagVisible=!0,this.tagVTemp={},this.setDisplay(!0))}},{key:"SetOneTagVisible",value:function(e){this.tagVsetting!=e&&(this.tagVsetting&&this.saveLastTagVi(this.tagVsetting),this.tagVsetting=e,this.delVisibleLines(),this.showFootIcons(this.player.currentPano),this.createTagVisiLines(e),this.updateFootIconSize(),this.player.$app.TagManager.emit(this.checkTagLinkStatus()))}},{key:"checkTagVisiChange",value:function(){if(Object.keys(this.tagVTemp).length)return!0;for(var e in this.tagsVLines){var t=this.tagsVLines[e];if(t.name.indexOf("new")>-1&&t.visible)return!0;if(-1==t.name.indexOf("new")&&!t.visible)return!0}return!1}},{key:"checkTagLinkStatus",value:function(){var e=Object.values(this.tagsVLines).filter((function(e){return e.visible}));return this.footIcons.filter((function(e){return e.visible})).length==e.length?"tagManager.linkAll":0==e.length?"tagManager.linkNone":"tagManager.linkSome"}},{key:"saveLastTagVi",value:function(){var e=!1,t=this.tagVTemp[this.tagVsetting.sid]||this.tagVsetting.visiblePanos.slice(0);for(var n in this.tagsVLines){var o=this.tagsVLines[n];if(o.name.indexOf("new")>-1&&o.visible)t.push(this.player.model.panos.index[n]),e=!0;else if(-1==o.name.indexOf("new")&&!o.visible){var i=t.map((function(e){return e.id})).indexOf(n);if(-1==i){console.log("visiblePanos删除error");continue}t.splice(i,1),e=!0}}e&&(this.tagVTemp[this.tagVsetting.sid]=t)}},{key:"pauseSetTagVisible",value:function(e){this.setTagVisible&&this.tagVsetting&&("unsaved"==e?this.saveLastTagVi(this.tagVsetting):this.tagVTemp={},this.delVisibleLines(),this.hideFootIcons(),this.tagVsetting=null)}},{key:"finishSetTagVisible",value:function(){this.setTagVisible&&(this.pauseSetTagVisible(),this.setTagVisible=!1,this.setDisplay(!1))}},{key:"saveTagVisibles",value:function(){this.tagVsetting&&this.saveLastTagVi(this.tagVsetting);var e=[];for(var t in this.tagVTemp)e.push({sid:t,value:this.tagVTemp[t].map((function(e){return e.id}))});return e}},{key:"afterSaveTagVisibles",value:function(){this.finishSetTagVisible()}},{key:"createTagVisiLines",value:function(e){var t=this;(this.tagVTemp[e.sid]||e.visiblePanos).forEach((function(n){n.floor.floorIndex==t.player.model.currentFloor.floorIndex&&t.createTagSingleLine(n,"old",e)}))}},{key:"createTagSingleLine",value:function(e,t,n){var o=An.createLine([e.floorPosition.clone(),n.position.clone()],{color:Ae.green});this.meshGroup.add(o),o.name="tagVL-"+t+"-"+e.id,this.tagsVLines[e.id]=o,this.changeIconLinkState(sr.index[e.id].footIcon,"linked")}},{key:"dealTagVisible",value:function(e,t){this.tagsVLines[t]?(this.tagsVLines[t].visible=!this.tagsVLines[t].visible,this.changeIconLinkState(sr.index[t].footIcon,!!this.tagsVLines[t].visible&&"linked"),this.tagsVLines[t].visible||this.player.$app.gui.toast({event:"DialogList3D.TagManger.unLink",content:lr.TagManger.unLink,showClose:!0})):this.createTagSingleLine(sr.index[t],"new",e),this.player.$app.TagManager.emit(this.checkTagLinkStatus())}},{key:"setTagHideAll",value:function(e){var t=this;Object.keys(this.tagsVLines).forEach((function(e){t.tagsVLines[e].visible=!1,t.changeIconLinkState(sr.index[e].footIcon,!1)}))}},{key:"setTagShowAll",value:function(e){var t=this;this.footIcons.filter((function(e){return e.visible})).forEach((function(n){var o=n.pano.id;t.tagsVLines[o]?(t.tagsVLines[o].visible=!0,t.changeIconLinkState(sr.index[o].footIcon,"linked")):t.createTagSingleLine(sr.index[o],"new",e)}))}},{key:"delVisibleLines",value:function(){for(var e in this.tagsVLines)this.tagsVLines[e].geometry.dispose(),this.tagsVLines[e].material.dispose(),this.meshGroup.remove(this.tagsVLines[e]),delete this.tagsVLines[e];for(var e in this.panoVLines)this.panoVLines[e].geometry.dispose(),this.panoVLines[e].material.dispose(),this.meshGroup.remove(this.panoVLines[e]),delete this.panoVLines[e]}},{key:"createPanoVisiLines",value:function(e,t){var n=this.panoVTemp[e.id]&&this.panoVTemp[e.id].neighbourPanos||e.neighbourPanos;for(var o in n)n[o]&&o!=e.id&&this.createPanoSingleLine(e,"old",o)}},{key:"createPanoSingleLine",value:function(e,t,n){var o=sr.index[n],i=o.floorPosition.clone(),r=An.createLine([e.floorPosition.clone(),i],{color:Ae.green,deshed:o.floorIndex!=e.floorIndex});this.meshGroup.add(r),r.name="PanoVL-"+t+"-"+n,o.floorIndex!=e.floorIndex&&(r.material.opacity=.5),this.panoVLines[n]=r,this.activePano&&(o.floorIndex!=e.floorIndex?this.changeIconLinkState(sr.index[n].footIcon,"floorLinked"):this.changeIconLinkState(sr.index[n].footIcon,"linked"))}},{key:"dealPanoVisible",value:function(e,t){var n=this;if(this.setMultiFloorPanoVisible){if(this.linkToFloorPano){var o=this.linkToFloorPano.footIcon;this.changeIconLinkState(o,!1),this.changeFloorIconState(o)||(o.status="visible",o.material.uniforms.map.value=ur)}else this.player.$app.WalkManager.emit("walkManager.multiFloorLinking");this.linkToFloorPano=t.pano,this.changeIconLinkState(t,"center"),"upper"==this.setMultiFloorPanoVisible?(t.status="floor",t.material.uniforms.map.value=pr):(t.status="floor",t.material.uniforms.map.value=dr)}else if(t&&"FootIcon"==t.type)this.activePano?e==this.activePano.id?(this.startEditPano||(this.startEditPano=this.activePano),this.player.$app.WalkManager.emit("walkManager.deactive"),this.pauseSetPanoVisible("unsaved"),this.actionIcons.forEach((function(e){return e.material.map="invisible"==e.footIcon.status?fr:mr})),this.player.$app.gui.toast({event:"DialogList3D.WalkManger.deactive",content:lr.WalkManger.deactive})):(this.lastFloorActivePano=null,this.pauseSetPanoVisible("unsaved"),this.SetOnePanoVisible(sr.index[e]),this.player.$app.WalkManager.emit("walkManager.active",this.checkLinkStatus())):(this.lastFloorActivePano=null,this.SetOnePanoVisible(sr.index[e]),this.player.$app.WalkManager.emit("walkManager.active",this.checkLinkStatus()));else if(!t||"ActionIcon"==t.type)if(this.activePano){var i;if(this.panoVLines[e]?(this.panoVLines[e].visible=!this.panoVLines[e].visible,i=this.panoVLines[e].visible,this.changeIconLinkState(sr.index[e].footIcon,!!this.panoVLines[e].visible&&"linked")):(this.createPanoSingleLine(this.activePano,"new",e),i=!0),this.startEditPano||(this.startEditPano=this.activePano),i)this.changeIconVisiState(sr.index[e].footIcon,!0),this.changeIconVisiState(sr.index[this.activePano.id].footIcon,!0),t&&"ActionIcon"==t.type&&this.player.$app.WalkManager.emit(this.checkLinkStatus());else{var r=this.checkHasNeighbor(sr.index[e]),a=this.checkHasNeighbor(this.activePano);this.changeIconVisiState(sr.index[e].footIcon,r),this.changeIconVisiState(sr.index[this.activePano.id].footIcon,a),t&&"ActionIcon"==t.type&&(this.player.$app.WalkManager.emit(this.checkLinkStatus()),a||(this.activePano==this.player.$app.core.get("Scene").firstView.pano?this.player.$app.gui.toast({event:"DialogList3D.WalkManger.firstPointLimit",content:lr.WalkManger.firstPointLimit}):this.player.$app.gui.toast({event:"DialogList3D.WalkManger.hide",content:lr.WalkManger.hide})))}}else{if("invisible"==t.footIcon.status){if(this.panoVTemp[e]){var s=Object.keys(this.panoVTemp[e].neighbourPanos),l=[];s.forEach((function(e){return l.push({type:"add",id:e})})),this.savePanoVisiChange(e,l)}else{var c=Pe.getVisiblePano(sr.index[e].position,this.player.model).map((function(e){return e.id})),u=[];c.forEach((function(e){return u.push({type:"add",id:e})})),this.savePanoVisiChange(e,u)}this.player.$app.gui.toast({event:"DialogList3D.WalkManger.show",content:lr.WalkManger.show})}else{this.createPanoVisiLines(sr.index[e],!0),Object.values(this.panoVLines).forEach((function(e){return e.visible=!1}));var h=this.player.$app.core.get("Scene").firstView;if(h.pano.footIcon==t.footIcon)return this.player.$app.gui.toast({event:"DialogList3D.WalkManger.firstPointLimit",content:lr.WalkManger.firstPointLimit}),!1;var d=this.panoVTemp[h.pano.id]&&this.panoVTemp[h.pano.id].neighbourUUIDs||h.pano.neighbourUUIDs;1==d.length&&d[0]==e&&this.player.$app.gui.toast({event:"DialogList3D.WalkManger.firstPointLimit",content:lr.WalkManger.firstPointLimit}),this.player.$app.gui.toast({event:"DialogList3D.WalkManger.hide",content:lr.WalkManger.hide}),this.saveLastPanoVi(sr.index[e])}sr.forEach((function(e){return n.changeIconVisiState(e.footIcon,n.checkHasNeighbor(e))}))}this.updateFootIconSize()}},{key:"showFootIcons",value:function(e,t,n){var o=this;if(!this.footIcons){this.footIcons=[],this.actionIcons=[];var i=.4;i*=40/Math.sqrt(Math.min(this.player.domElement.clientWidth,this.player.domElement.clientHeight)),i=THREE.Math.clamp(i,.3,.7);var r=new THREE.PlaneGeometry(i,i,1,1),a=r.clone();for(var s in a.scale(.5,.5,.5),sr.index)if(sr.index[s].isAligned()){var l=new wr(r,sr.index[s]);l.visible=!1,sr.index[s].footIcon=l;var c=new br(l,a,sr.index[s]);l.actionIcon=c,this.meshGroup.add(l),l.add(c),this.footIcons.push(l),this.actionIcons.push(c)}}n=n||this.player.model.currentFloor,sr.list.forEach((function(i){if(i.isAligned())if(i.floor==n)i.footIcon.visible=!0,o.changeIconLinkState(i.footIcon,!1),t&&o.changeIconVisiState(i.footIcon,o.checkHasNeighbor(sr.index[i.id],"beforeCreateLine")),e&&i==e?(i.footIcon.oriScale=new THREE.Vector3(1.5,1.5,1.5),t&&o.changeIconLinkState(i.footIcon,"center")):(i.footIcon.oriScale=new THREE.Vector3(1,1,1),i.footIcon.actionIcon.visible=!0);else{var r=(o.panoVTemp&&o.panoVTemp[i.id]?o.panoVTemp[i.id].neighbourUUIDs:i.neighbourUUIDs).filter((function(t){return e&&t==e.id}));i.footIcon.oriScale=new THREE.Vector3(1,1,1),r.length>0?(t&&o.changeFloorIconState(i.footIcon),i.footIcon.visible=!0,o.changeIconLinkState(i.footIcon,"floorLinked")):i.footIcon.visible=!1}}))}},{key:"checkHasNeighbor",value:function(e,t){var n=this.panoVTemp&&this.panoVTemp[e.id]?this.panoVTemp[e.id].neighbourPanos:e.neighbourPanos;if("beforeCreateLine"==t||e!=this.activePano){for(var o in n)if(o!=e.id&&n[o]){if(this.activePano&&this.activePano.id==o&&this.panoVLines[e.id]&&!this.panoVLines[e.id].visible)continue;return!0}return!1}for(var o in this.panoVLines)if(this.panoVLines[o].visible)return!0}},{key:"ifAllPanoNoNeighbor",value:function(){for(var e in sr.index)if(sr.index[e].isAligned()&&this.checkHasNeighbor(sr.index[e]))return!1;return this.noPanoHasNeighbor=!0,!0}},{key:"changeIconLinkState",value:function(e,t){var n;"linked"==t&&(n=Ae.green,e.actionIcon.material.map=gr),"floorLinked"==t&&(n="#d5f12e",e.actionIcon.visible=!1,e.material.uniforms.opacity.value=.5),"center"==t&&(n="#d5f12e",e.actionIcon.visible=!1),0==t&&(n="#fff",e.actionIcon.material.map=vr);try{e.material.uniforms.color.value.set(n)}catch(e){console.log(e)}}},{key:"checkFloorLinkStatus",value:function(){var e=this,t="walkManager.unlinkFloor",n=(this.panoVTemp[this.activePano.id]&&this.panoVTemp[this.activePano.id].neighbourUUIDs||sr.index[this.activePano.id].neighbourUUIDs).map((function(e){return sr.index[e]})).filter((function(t){return t.floorIndex!=e.activePano.floorIndex}))[0];n&&n.floor.center.y>this.activePano.floor.center.y&&(t="walkManager.linkUpperFloor"),n&&n.floor.center.y<this.activePano.floor.center.y&&(t="walkManager.linkLowerFloor"),this.player.$app.WalkManager.emit(t)}},{key:"checkLinkStatus",value:function(){this.checkFloorLinkStatus();var e=Object.values(this.panoVLines).filter((function(e){return e.visible}));return this.footIcons.filter((function(e){return e.visible})).length==e.length+1?"walkManager.linkAll":0==e.length?"walkManager.linkNone":"walkManager.linkSome"}},{key:"changeIconVisiState",value:function(e,t){(e.pano==this.player.$app.core.get("Scene").firstView.pano&&(t=!0),t)?(e.status="visible",e.material.uniforms.map.value=ur,this.activePano||(e.actionIcon.material.map=mr),e.material.uniforms.opacity.value=1,this.changeFloorIconState(e)):(e.status="invisible",e.material.uniforms.map.value=hr,this.activePano||(e.actionIcon.material.map=fr),this.activePano&&this.activePano.id==e.name?(e.material.uniforms.opacity.value=1,this.player.$app.gui.toast({event:"DialogList3D.WalkManger.activeHidePoint",content:lr.WalkManger.activeHidePoint})):e.material.uniforms.opacity.value=.5)}},{key:"changeFloorIconState",value:function(e){var t=sr.index[e.name],n=(this.panoVTemp&&this.panoVTemp[t.id]?this.panoVTemp[t.id].neighbourUUIDs:t.neighbourUUIDs).filter((function(e){return sr.index[e].floorIndex!=t.floorIndex})).map((function(e){return sr.index[e].floor}));return!!n.length&&(n[0].center.y>t.floor.center.y&&(e.status="floor",e.material.uniforms.map.value=dr),n[0].center.y<t.floor.center.y&&(e.status="floor",e.material.uniforms.map.value=pr),!0)}},{key:"getClosestOtherFloorPano",value:function(e,t){return sr.closestPanoTowardPoint({point:e.position,getAll:!0}).map((function(e){return e.pano})).filter((function(n){return"up"==t?n.floorIndex>e.floorIndex:n.floorIndex<e.floorIndex}))[0]}},{key:"getUpperFloor",value:function(e){var t=this.player.model.floors,n=t.index[e],o={index:e,height:9999};return t.list.forEach((function(e){e.center.y>n.center.y&&Math.abs(e.center.y-n.center.y)<Math.abs(o.height-n.center.y)&&(o.index=e.floorIndex,o.height=e.center.y)})),o.index}},{key:"getLowerFloor",value:function(e){var t=this.player.model.floors,n=t.index[e],o={index:e,height:9999};return t.list.forEach((function(e){e.center.y<n.center.y&&Math.abs(e.center.y-n.center.y)<Math.abs(o.height-n.center.y)&&(o.index=e.floorIndex,o.height=e.center.y)})),o.index}},{key:"recoverAllState2",value:function(){for(var e=0;e<this.footIcons.length;e++)this.footIcons[e].material.uniforms.opacity.value=1,this.footIcons[e].material.uniforms.map.value=ur}},{key:"hideFootIcons",value:function(){if(this.footIcons)for(var e=0;e<this.footIcons.length;e++)this.footIcons[e].visible=!1,this.footIcons[e].actionIcon.visible=!0}},{key:"updateFootIconSize",value:function(){if(this.footIcons){var e=be.getScaleForConstantSize({width2d:150,position:new THREE.Vector3,camera:this.player.camera,dom:this.player.$app.dom}),t=this.player;e=THREE.Math.clamp(e,.45,3.2),this.footIcons.forEach((function(n){n.visible&&n.scale.copy(n.oriScale).multiplyScalar(e),n.quaternion.copy(t.quaternion)}))}}},{key:"resetTagVisiByModel",value:function(){var e=[];for(var t in objects.tagManager.tags){var n=objects.tagManager.tags[t];if("videoPanoFlag"!=n.state){var o=n.getVisiblePanos();e.push({sid:n.sid,value:o})}}return e}},{key:"afterResetTagVisibles",value:function(e){e.forEach((function(e){objects.tagManager.tags[e.sid].setVisiblePanos(e.value)})),"panorama"==objects.player.mode&&objects.tagManager.updateVisible("panorama")}},{key:"resetVisiblesByModel",value:function(){this.resetTagVisiByModel()}},{key:"gotoFloor",value:function(e){var t=this;if(this.player.model.currentFloor.floorIndex!=e){var n=this.player.model.floors.index[e];this.activePano&&(this.lastFloorActivePano=this.activePano),this.setTagVisible?this.pauseSetTagVisible("unsaved",n):this.setPanoVisible&&(this.pauseSetPanoVisible("unsaved",n),setTimeout((function(){t.lastFloorActivePano&&t.lastFloorActivePano.floorIndex==e?(t.SetOnePanoVisible(t.lastFloorActivePano),t.player.$app.WalkManager.emit("walkManager.active",t.checkLinkStatus())):t.player.$app.WalkManager.emit("walkManager.deactive")}),1));var o=this.getFitBoundSize(n),i=n.boundingBox.getCenter(new THREE.Vector3);this.player.focusPoint({modelSize:o,aim:i})}}},{key:"getFitBoundSize",value:function(e,t){t||(t=e.size);var n=(this.player.domElement.clientWidth+this.player.domElement.clientHeight)/160,o=t.x,i=t.y;return new THREE.Vector3(o<n?(n+e.size.x)/2:Math.min(o+.3*e.size.x,e.size.x),1,i<n?(n+e.size.z)/2:Math.min(i+.3*e.size.z,e.size.z))}}]),e}(),wr=function(e){f(n,THREE.Mesh);var t=cr(n);function n(e,o){var r;return i(this,n),(r=t.call(this)).geometry=e,r.material=new THREE.RawShaderMaterial({vertexShader:Ht.waypoint.vertexShader,fragmentShader:Ht.waypoint.fragmentShader,uniforms:THREE.UniformsUtils.clone(Ht.waypoint.uniforms),transparent:!0,depthWrite:!1,depthTest:!1,name:"footIcon"}),r.material.uniforms.map.value=ur,r.material.uniforms.color.value.set("#ffffff"),r.renderOrder=Xe,r.type="FootIcon",r.name=o.id,r.pano=o,r.status="",r.position.copy(o.floorPosition.clone()),r.lookAt(r.position.clone().add(new THREE.Vector3(0,1,0))),r}return n}(),br=function(e){f(n,THREE.Mesh);var t=cr(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this)).geometry=o,a.material=new THREE.MeshPhongMaterial({map:vr,transparent:!0,depthTest:!1,name:"footIcon"}),a.footIcon=e,a.renderOrder=Xe+1,a.type="ActionIcon",a.name=r.id,a.pano=r,a.position.set(.2,.2,0),a}return n}(),Er=function(){function e(t,n){i(this,e),this.player=t,this.position=n.pos,this.sid=n.sid,this.text=n.text||"",this.toPano=n.toPano,this.clickFun=n.clickFun,this.noLine=n.noLine,this.driftDir=n.driftDir,this.floorIndex=n.floorIndex,this.elem=document.createElement("div"),this.elem.className="room-label",this.elem.style.display="none",this.elem.innerHTML="<a><p><span>".concat(this.text,"</span></p></a>"),n.container?n.container.append(this.elem):document.querySelector(".widgets-doll-labels").append(this.elem),this.player.dollLabels.push(this),this.elem.addEventListener("click",this.clickFuc.bind(this)),this.enable=!0,this.type="doll",this.pos2d=new THREE.Vector3,this.noLine&&(this.elem.className+=" noLine")}return u(e,[{key:"changeText",value:function(e){this.elem.querySelector("span").innerHTML=this.text=e}},{key:"update",value:function(){if("dollhouse"!==this.player.mode||!this.enable||!this.text||this.player.model.currentFloor.floorIndex!=this.floorIndex&&!this.player.model.allFloorsVisible||this.player.EditOverlay&&this.player.EditOverlay.editing||this.player.linkEditor&&(this.player.linkEditor.setPanoVisible||this.player.linkEditor.setTagVisible))this.elem.style.display="none";else{var e=Pe.getPos2d(this.position,this.player);if(e.trueSide)if(Pe.ifShelter(this.position,this.player,{x:e.vector.x,y:e.vector.y},null,this.player.model.allFloorsVisible?null:this.floorIndex))this.elem.style.display="none";else{if(this.elem.style.display="",this.driftDir){var t=Pe.getPos2d(this.position.clone().add(this.driftDir),this.player),n=this.elem.children[0].getBoundingClientRect(),o=be.getCrossPointAtRect(t.pos,e.pos,n.width,n.height,e.pos.x-n.width/2,e.pos.y-n.height/2).sub(e.pos.clone()),i=100/this.position.distanceTo(this.player.camera.position),r=e.pos.clone().add(o.multiplyScalar((i+o.length())/o.length()));this.elem.style.left=r.x+"px",this.elem.style.top=r.y+"px"}else this.elem.style.left=e.pos.x+"px",this.elem.style.top=e.pos.y+"px";this.pos2d=e.vector}else this.elem.style.display="none"}}},{key:"clickFuc",value:function(){this.toPano?this.player.flyToPano({pano:this.toPano}):this.clickFun&&this.clickFun()}},{key:"remove",value:function(){var e=this.elem.parentElement;e&&e.removeChild(this.elem);var t=this.player.dollLabels.indexOf(this);t>-1&&this.player.dollLabels.splice(t,1)}}]),e}();function xr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Tr=1.6,Pr=.2,kr=new THREE.Vector3(0,0,-1),Mr=new THREE.MeshStandardMaterial({transparent:!0,color:new THREE.Color(1,1,1),opacity:.45,metalness:1,emissive:new THREE.Color(.85,.85,.85)}),Rr=Mr.clone();Rr.opacity=.9;var Ir=function(e){f(n,THREE.Object3D);var t=xr(n);function n(e,o){var r;i(this,n),(r=t.call(this)).player=e;var a=r.createArrow();r.add(a),a.oriPosition=a.position.clone();for(var s=1;s<4;s++){var l=a.clone();l.position.setZ(1.8*s),l.oriPosition=l.position.clone(),r.add(l)}return r.name="entryArrow",e.model.add(h(r)),r.scale.set(Pr,Pr,Pr),r.setPosition(o),r.currentHighLight=0,console.log("create entryArrow"),r}return u(n,[{key:"createArrow",value:function(){var e=[{x:0,y:0},{x:1,y:.8},{x:1,y:Tr},{x:0,y:.8},{x:-1,y:Tr},{x:-1,y:.8}],t=new THREE.Shape;t.moveTo(e[0].x,e[0].y);for(var n=1,o=e.length;n<o;n++)t.lineTo(e[n].x,e[n].y);t.lineTo(e[0].x,e[0].y);var i=new THREE.ExtrudeBufferGeometry(t,{depth:.4,bevelEnabled:!1}),r=new THREE.Mesh(i,Mr);return r.rotation.x=Math.PI/2,r}},{key:"setPosition",value:function(e){var t=new THREE.Vector3(e.points2d[0].x,e.bottom+.4*Pr,-e.points2d[0].y),n=new THREE.Vector3(e.points2d[1].x,e.bottom+.4*Pr,-e.points2d[1].y),o=t.clone().add(n).multiplyScalar(.5),i=t.clone().sub(n).normalize(),r=new THREE.Matrix4;r.set(0,0,1,0,0,1,0,0,1,0,0,0,0,0,0,1),i.applyMatrix4(r);var a=e.points2d[1].x-e.points2d[0].x,s=e.points2d[1].y-e.points2d[0].y,l="RIGHT"==e.openSide&&Math.abs(s)<.001||"LEFT"==e.openSide&&Math.abs(a)<.001?i.multiplyScalar(-1):i;"reverse"==e.enter&&(l=l.multiplyScalar(-1)),this.enterDir=l,e.direWith&&(o.add(l.clone().multiplyScalar(t.distanceTo(n))),l.multiplyScalar(-1)),this.position.copy(o);var c=be.getQuaBetween2Vector(kr,l,new THREE.Vector3(0,1,0));this.quaternion.copy(c),this.addLabel(o,l,e.floorIndex),this.entryPos=o}},{key:"addLabel",value:function(e,t,n){var o=this.player.model.panos.closestPanoTowardPoint({point:e});o||console.error("what!!! no closetPano");this.dollLabelOriPos=e.clone().sub(t.clone().multiplyScalar(1.4000000000000001));var i=new Er(this.player,{sid:"entry",pos:this.dollLabelOriPos,driftDir:t,noLine:!0,text:W.i18n("model.enter"),toPano:o,floorIndex:n});this.player.defaultRoomLabels.push(i),this.dollLabel=i}},{key:"moveCloseToWall",value:function(e){this.children.forEach((function(t){t.position.z=t.oriPosition.z+e})),this.dollLabel.position=this.dollLabelOriPos.clone().sub(this.enterDir.clone().multiplyScalar(e*Pr))}},{key:"reSetHeight",value:function(e){this.position.setY(e),this.dollLabel.position.y=e,this.dollLabelOriPos.y=e}},{key:"animate",value:function(){var e=this;this.children.forEach((function(t,n){n==e.currentHighLight?t.material=Rr:t.material=Mr})),this.currentHighLight=(this.currentHighLight-1+this.children.length)%this.children.length,this.stopAnimation(),this.animation=setTimeout(this.animate.bind(this),200)}},{key:"stopAnimation",value:function(){clearTimeout(this.animation),this.animation=null}},{key:"dispose",value:function(){this.parent.remove(this),this.stopAnimation()}},{key:"show",value:function(){this.visible=!0,this.animate()}},{key:"hide",value:function(){this.visible=!1,this.stopAnimation()}}],[{key:"switchDepthTest",value:function(e){Mr.depthTest=e,Rr.depthTest=e}}]),n}(),Sr={forward:new THREE.Vector3(0,0,-1),back:new THREE.Vector3(0,0,1),left:new THREE.Vector3(-1,0,0),right:new THREE.Vector3(1,0,0)},Cr=function(){function e(t,n){i(this,e),this.player=t,this.position=n.pos,this.text=n.text||"",this.aim=n.aim,this.toPano=n.toPano,this.door=n.door,this.visiblePanos=n.visiblePanos,this.sameRoomPanos=n.sameRoomPanos,this.doorDir=n.doorDir,this.floorIndex=n.floorIndex,this.enable=null==n.enable||n.enable,this.elem=document.createElement("div"),this.elem.className="door show-arrow",this.elem.style.display="none",this.elem.innerHTML="<a>".concat(this.text,"</a>"),n.container?n.container.append(this.elem):document.querySelector(".widgets-doors").append(this.elem),this.player.doorLabels.push(this),this.elem.addEventListener("pointerup",this.clickFuc.bind(this)),this.type="door",this.pos2d=new THREE.Vector3,this.getDirection(),this.updateVisible()}return u(e,[{key:"updateVisible",value:function(e){e?this.sameRoomPanos.includes(e)||(this.enable=!1):this.visiblePanos.includes(this.player.currentPano)?this.enable=!0:this.enable=!1}},{key:"update",value:function(){if("panorama"!==this.player.mode||!this.enable||!this.text||He.vrEnabled&&He.vrSplitScreen||this.player.linkEditor&&(this.player.linkEditor.setPanoVisible||this.player.linkEditor.setTagVisible))this.elem.style.display="none";else{var e=Pe.getPos2d(this.position,this.player);e.trueSide?(this.elem.style.left=e.pos.x+"px",this.elem.style.top=e.pos.y+"px",He.vrEnabled?this.elem.style.transform="rotate("+window.screenFaceOrient+"deg)":this.elem.style.transform="",this.elem.style.display="",this.pos2d=e.vector):this.elem.style.display="none"}}},{key:"getDirection",value:function(){var t=e.getToward(this.doorDir);this.elem.className+=" "+t}},{key:"clickFuc",value:function(e){this.toPano?(e.stopPropagation(),this.player.flyToPano({pano:this.toPano,lookAtPoint:this.aim.clone().setY(this.toPano.position.y),duration:1800})):console.error("doorlabel没有toPano")}},{key:"remove",value:function(){this.elem.parentElement.removeChild(this.elem);var e=this.player.doorLabels.indexOf(this);e>-1&&this.player.doorLabels.splice(e,1)}}],[{key:"getToward",value:function(e){for(var t in Sr){var n=Sr[t].clone().dot(e.setY(0).normalize());if(Math.acos(n)<Math.PI/4)return t}console.warn("没有找到朝向..")}},{key:"updateCameraDir",value:function(t){if("panorama"==t.mode&&0!=t.doorLabels.length){var n=t.getDirection(),o=e.getToward(n);document.querySelector(".widgets-doors").setAttribute("data-camera-toward",o)}}}]),e}();U('#compass {\r\n    display: none;\r\n    position: absolute;\r\n    width: 90px;\r\n    height: 90px;\r\n    pointer-events: none;\r\n}\r\n\r\n#compass .north {\r\n    color: #02a0e9;\r\n    top: 0;\r\n}\r\n#compass .south {\r\n    color: #ff1414;\r\n    bottom: 0;\r\n}\r\n\r\n#compass .dirText {\r\n    text-align: center;\r\n    font-size: 10px;\r\n    position: absolute;\r\n    line-height: 25px;\r\n\r\n    color: rgb(255, 255, 255);\r\n    top: 50%;\r\n    left: 50%;\r\n    width: 45%;\r\n    height: 0px;\r\n    transform-origin: left center;\r\n}\r\n\r\n#compass .dirText span {\r\n    display: block;\r\n    position: absolute;\r\n    right: 5px;\r\n    top: 0;\r\n    width: 20px;\r\n    height: 20px;\r\n    line-height: 20px;\r\n    margin-top: -10px;\r\n}\r\n\r\n#compass .center {\r\n    width: 50px;\r\n    height: 50px;\r\n    background-size: contain;\r\n    background-position: center;\r\n    top: 50%;\r\n    left: 50%;\r\n    transform: translate(-50%, -50%);\r\n    position: absolute;\r\n}\r\n#compass .center canvas{\r\n    position: relative;\r\n    left: 0;\r\n    top: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    display: block;\r\n    background-color: transparent;\r\n}\r\n\r\n.widgets-doll-labels a, .widgets-plan-labels a, .widgets-doors a {\r\n    color: #fff;\r\n    font-size: 14px;\r\n    line-height: normal;\r\n    font-family: OpenSans,sans-serif;\r\n    user-select: none;\r\n}\r\n\r\n.widgets-doll-labels .room-label {\r\n    position: absolute;\r\n    width: 0;\r\n    height: 0;\r\n    -webkit-transform: translateZ(0);\r\n    transform: translateZ(0);\r\n    -webkit-animation: room-label 0.3s ease 0.1s;\r\n    animation: room-label 0.3s ease 0.1s;\r\n    -webkit-animation-fill-mode: both;\r\n    animation-fill-mode: both;\r\n    cursor: pointer;\r\n}\r\n\r\n.widgets-doll-labels .room-label:not(.noLine):after {\r\n    content: "";\r\n    display: block;\r\n    position: absolute;\r\n    width: 4px;\r\n    height: 68px;\r\n    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAABQCAYAAADYxx/bAAAASElEQVQYlY2QwQoAIAhDR///x6Z2CCaGSpfHNoegcHdfAGwBCKVUMdAMK7IKm2Wh2oSOdkaUhVbG3u++x7aqPbX9lWVEdn9/AGvVUp4wTpLmAAAAAElFTkSuQmCC");\r\n    background-size: contain;\r\n    background-repeat: no-repeat;\r\n    bottom: 0;\r\n    left: 50%;\r\n    -webkit-transform: translate(-50%);\r\n    transform: translate(-50%);\r\n}\r\n.widgets-doll-labels .room-label a {\r\n    display: block;\r\n    position: absolute;\r\n    line-height: 22px;\r\n    top: -66px;\r\n    transform: translate(-50%, -100%);\r\n    text-align: center;\r\n    white-space: nowrap;\r\n    font-size: 12px;\r\n    font-style: normal;\r\n    pointer-events: auto;\r\n    \r\n    background-repeat: no-repeat;\r\n    background-size: 100% 100%;\r\n    background: rgba(210, 210, 210, 0.7);\r\n    border: 1px solid rgba(255, 255, 255, 0.4);\r\n    border-radius: 3px;  \r\n    text-shadow: 0px 1px 3px rgb(0,0, 0,  0.5);\r\n}\r\n    .widgets-doll-labels .room-label a::before {\r\n        content: "";\r\n        position: absolute;\r\n        left: -1px;\r\n        top: -1px;\r\n        width: 10px;\r\n        height: 10px;\r\n        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgd2lkdGg9IjZweCIgaGVpZ2h0PSI2cHgiIHZpZXdCb3g9IjAgMCA2IDYiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+DQogICAgPHRpdGxlPm1hcF9jb3JuZXIgIDwvdGl0bGU+DQogICAgPGcgaWQ9Iumhtemdoi0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4NCiAgICAgICAgPGcgaWQ9IuWxleekuueVjOmdoi3kuInnu7QiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC01Ni4wMDAwMDAsIC0yNzAuMDAwMDAwKSIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJub256ZXJvIj4NCiAgICAgICAgICAgIDxnIGlkPSLnvJbnu4QtMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMxLjAwMDAwMCwgMjcwLjAwMDAwMCkiPg0KICAgICAgICAgICAgICAgIDxnIGlkPSLlvaLnirbnu5PlkIgtKy3lvaLnirbnu5PlkIgt6JKZ54mIIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNS4wMDAwMDAsIDAuMDAwMDAwKSI+DQogICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik02LDYgTDUsNiBMNSwyLjcwNSBMMy4zMDEsMSBMMCwxIEwwLDAgTDMuNzE1MjI2NDEsMCBMNiwyLjI5MzQ0Nzk1IEw2LDYgWiIgaWQ9Im1hcF9jb3JuZXItLSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMy4wMDAwMDAsIDMuMDAwMDAwKSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0zLjAwMDAwMCwgLTMuMDAwMDAwKSAiPjwvcGF0aD4NCiAgICAgICAgICAgICAgICA8L2c+DQogICAgICAgICAgICA8L2c+DQogICAgICAgIDwvZz4NCiAgICA8L2c+DQo8L3N2Zz4=);\r\n        background-repeat: no-repeat;\r\n        background-position: top left;\r\n    }\r\n    .widgets-doll-labels .room-label a::after {\r\n        content: "";\r\n        position: absolute;\r\n        left: -1px;\r\n        bottom: -1px;\r\n        width: 10px;\r\n        height: 10px;\r\n        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgd2lkdGg9IjZweCIgaGVpZ2h0PSI2cHgiIHZpZXdCb3g9IjAgMCA2IDYiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+DQogICAgPHRpdGxlPm1hcF9jb3JuZXIgIDwvdGl0bGU+DQogICAgPGcgaWQ9Iumhtemdoi0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4NCiAgICAgICAgPGcgaWQ9IuWxleekuueVjOmdoi3kuInnu7QiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC01Ni4wMDAwMDAsIC0yNzAuMDAwMDAwKSIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJub256ZXJvIj4NCiAgICAgICAgICAgIDxnIGlkPSLnvJbnu4QtMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMxLjAwMDAwMCwgMjcwLjAwMDAwMCkiPg0KICAgICAgICAgICAgICAgIDxnIGlkPSLlvaLnirbnu5PlkIgtKy3lvaLnirbnu5PlkIgt6JKZ54mIIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNS4wMDAwMDAsIDAuMDAwMDAwKSI+DQogICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik02LDYgTDUsNiBMNSwyLjcwNSBMMy4zMDEsMSBMMCwxIEwwLDAgTDMuNzE1MjI2NDEsMCBMNiwyLjI5MzQ0Nzk1IEw2LDYgWiIgaWQ9Im1hcF9jb3JuZXItLSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMy4wMDAwMDAsIDMuMDAwMDAwKSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0zLjAwMDAwMCwgLTMuMDAwMDAwKSAiPjwvcGF0aD4NCiAgICAgICAgICAgICAgICA8L2c+DQogICAgICAgICAgICA8L2c+DQogICAgICAgIDwvZz4NCiAgICA8L2c+DQo8L3N2Zz4=);\r\n        background-repeat: no-repeat;\r\n        background-position: top left;\r\n        transform: rotate(270deg);\r\n    }\r\n    .widgets-doll-labels .room-label a > p {\r\n        margin: 0;\r\n        padding: 2px 10px;\r\n        height: 100%;\r\n        line-height: 1.5;\r\n    }\r\n        .widgets-doll-labels .room-label a > p::before {\r\n            content: "";\r\n            position: absolute;\r\n            right: -1px;\r\n            top: -1px;\r\n            width: 10px;\r\n            height: 10px;\r\n            background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgd2lkdGg9IjZweCIgaGVpZ2h0PSI2cHgiIHZpZXdCb3g9IjAgMCA2IDYiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+DQogICAgPHRpdGxlPm1hcF9jb3JuZXIgIDwvdGl0bGU+DQogICAgPGcgaWQ9Iumhtemdoi0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4NCiAgICAgICAgPGcgaWQ9IuWxleekuueVjOmdoi3kuInnu7QiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC01Ni4wMDAwMDAsIC0yNzAuMDAwMDAwKSIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJub256ZXJvIj4NCiAgICAgICAgICAgIDxnIGlkPSLnvJbnu4QtMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMxLjAwMDAwMCwgMjcwLjAwMDAwMCkiPg0KICAgICAgICAgICAgICAgIDxnIGlkPSLlvaLnirbnu5PlkIgtKy3lvaLnirbnu5PlkIgt6JKZ54mIIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNS4wMDAwMDAsIDAuMDAwMDAwKSI+DQogICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik02LDYgTDUsNiBMNSwyLjcwNSBMMy4zMDEsMSBMMCwxIEwwLDAgTDMuNzE1MjI2NDEsMCBMNiwyLjI5MzQ0Nzk1IEw2LDYgWiIgaWQ9Im1hcF9jb3JuZXItLSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMy4wMDAwMDAsIDMuMDAwMDAwKSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0zLjAwMDAwMCwgLTMuMDAwMDAwKSAiPjwvcGF0aD4NCiAgICAgICAgICAgICAgICA8L2c+DQogICAgICAgICAgICA8L2c+DQogICAgICAgIDwvZz4NCiAgICA8L2c+DQo8L3N2Zz4=);\r\n            background-repeat: no-repeat;\r\n            background-position: top left;\r\n            transform: rotate(90deg);\r\n        }\r\n        .widgets-doll-labels .room-label a > p::after {\r\n            content: "";\r\n            position: absolute;\r\n            right: -1px;\r\n            bottom: -1px;\r\n            width: 10px;\r\n            height: 10px;\r\n            background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgd2lkdGg9IjZweCIgaGVpZ2h0PSI2cHgiIHZpZXdCb3g9IjAgMCA2IDYiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+DQogICAgPHRpdGxlPm1hcF9jb3JuZXIgIDwvdGl0bGU+DQogICAgPGcgaWQ9Iumhtemdoi0xIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4NCiAgICAgICAgPGcgaWQ9IuWxleekuueVjOmdoi3kuInnu7QiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC01Ni4wMDAwMDAsIC0yNzAuMDAwMDAwKSIgZmlsbD0iI0ZGRkZGRiIgZmlsbC1ydWxlPSJub256ZXJvIj4NCiAgICAgICAgICAgIDxnIGlkPSLnvJbnu4QtMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMxLjAwMDAwMCwgMjcwLjAwMDAwMCkiPg0KICAgICAgICAgICAgICAgIDxnIGlkPSLlvaLnirbnu5PlkIgtKy3lvaLnirbnu5PlkIgt6JKZ54mIIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNS4wMDAwMDAsIDAuMDAwMDAwKSI+DQogICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik02LDYgTDUsNiBMNSwyLjcwNSBMMy4zMDEsMSBMMCwxIEwwLDAgTDMuNzE1MjI2NDEsMCBMNiwyLjI5MzQ0Nzk1IEw2LDYgWiIgaWQ9Im1hcF9jb3JuZXItLSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMy4wMDAwMDAsIDMuMDAwMDAwKSBzY2FsZSgtMSwgMSkgdHJhbnNsYXRlKC0zLjAwMDAwMCwgLTMuMDAwMDAwKSAiPjwvcGF0aD4NCiAgICAgICAgICAgICAgICA8L2c+DQogICAgICAgICAgICA8L2c+DQogICAgICAgIDwvZz4NCiAgICA8L2c+DQo8L3N2Zz4=);\r\n            background-repeat: no-repeat;\r\n            background-position: top left;\r\n            transform: rotate(180deg);\r\n        }\r\n\r\n.widgets-doll-labels .room-label.noLine a {\r\n    top: 16px;\r\n}\r\n\r\n.widgets-doll-labels .room-label a span {\r\n    white-space: nowrap;\r\n    user-select: none;\r\n}\r\n\r\n.widgets-doll-labels .room-label.with-entrance:after {\r\n    display: none;\r\n}\r\n\r\n.widgets-doll-labels .room-label.with-entrance a {\r\n    top: 50%;\r\n    width: 38.5px;\r\n    height: 15.75px;\r\n    background-size: 38.5px 15.75px;\r\n    -webkit-transform: translate(-50%, -50%);\r\n    transform: translate(-50%, -50%);\r\n}\r\n\r\n.widgets-doll-labels .room-label.with-entrance a span {\r\n    margin-left: -0.875px;\r\n    margin-top: -0.875px;\r\n}\r\n\r\n.widgets-plan-labels .room-label {\r\n    position: absolute;\r\n    -webkit-animation: room-label 0.3s ease 0.1s;\r\n    animation: room-label 0.3s ease 0.1s;\r\n    -webkit-animation-fill-mode: both;\r\n    animation-fill-mode: both;\r\n}\r\n\r\n.widgets-plan-labels .room-label a {\r\n    display: block;\r\n    position: absolute;\r\n    line-height: 24px;\r\n    -webkit-transform: translate(-50%);\r\n    transform: translate(-50%, -50%);\r\n    text-align: center;\r\n    white-space: nowrap;\r\n    font-size: 14px;\r\n    font-style: normal;\r\n}\r\n\r\n.widgets-doors {\r\n    position: absolute;\r\n    pointer-events: none;\r\n    top: 0;\r\n    left: 0;\r\n    bottom: 0;\r\n    right: 0;\r\n}\r\n\r\n.widgets-doors[data-camera-toward=right] .door.show-arrow.right a:before,\r\n.widgets-doors[data-camera-toward=forward] .door.show-arrow.right a:before {\r\n    margin-right: 3.5px;\r\n    -webkit-transform: rotate(180deg);\r\n    transform: rotate(180deg);\r\n}\r\n\r\n.widgets-doors[data-camera-toward=right] .door.show-arrow.right a:before,\r\n.widgets-doors[data-camera-toward=forward] .door.show-arrow.forward a:before,\r\n.widgets-doors[data-camera-toward=forward] .door.show-arrow.left a:after,\r\n.widgets-doors[data-camera-toward=forward] .door.show-arrow.right a:before {\r\n    content: "";\r\n    position: relative;\r\n    display: inline-block;\r\n    width: 10.5px;\r\n    height: 10.5px;\r\n    background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDE0IDEwIj4NCiAgPGcgaWQ9ImltZ19hcnJvdyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcyMSAtNTkzKSI+DQogICAgPHBhdGggaWQ9Iui3r+W+hF8xNDQ1IiBkYXRhLW5hbWU9Iui3r+W+hCAxNDQ1IiBkPSJNNTI1LjU4LDUxMC43NzNsLTQuNzM4LTQuNTg4YS42MjIuNjIyLDAsMCwwLS40MzQtLjE3M0g1MTcuN2EuNjI1LjYyNSwwLDAsMSwuNDM1LjE3M2w0LjczOCw0LjU4OGEuMzcuMzcsMCwwLDEsMCwuNTRsLTQuNzM5LDQuNTMyYS42MjEuNjIxLDAsMCwxLS40MzIuMTY3aDIuNzExYS42MjEuNjIxLDAsMCwwLC40MzEtLjE2N2w0LjczOS00LjUzMkEuMzcuMzcsMCwwLDAsNTI1LjU4LDUxMC43NzNaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDkuMzAzIDg2Ljk4OSkiIGZpbGw9IiNmZmYiLz4NCiAgICA8cGF0aCBpZD0i6Lev5b6EXzE0NDYiIGRhdGEtbmFtZT0i6Lev5b6EIDE0NDYiIGQ9Ik01MjUuNTgsNTEwLjc3M2wtNC43MzgtNC41ODhhLjYyMi42MjIsMCwwLDAtLjQzNC0uMTczSDUxNy43YS42MjUuNjI1LDAsMCwxLC40MzUuMTczbDQuNzM4LDQuNTg4YS4zNy4zNywwLDAsMSwwLC41NGwtNC43MzksNC41MzJhLjYyMS42MjEsMCwwLDEtLjQzMi4xNjdoMi43MTFhLjYyMS42MjEsMCwwLDAsLjQzMS0uMTY3bDQuNzM5LTQuNTMyQS4zNy4zNywwLDAsMCw1MjUuNTgsNTEwLjc3M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMy4zMDMgODYuOTg5KSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC41Ii8+DQogIDwvZz4NCjwvc3ZnPg0K) no-repeat 50%;\r\n    background-size: 100% 100%;\r\n    vertical-align: middle;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="forward"] .door.show-arrow.left a:after {\r\n    margin-left: 4px;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="forward"] .door.show-arrow.back a:after,\r\n.widgets-doors[data-camera-toward="right"] .door.show-arrow.left a:after {\r\n    content: "";\r\n    display: inline-block;\r\n    vertical-align: middle;\r\n    width: 10.5px;\r\n    height: 10.5px;\r\n    background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDE0IDEwIj4NCiAgPGcgaWQ9ImltZ19hcnJvdyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcyMSAtNTkzKSI+DQogICAgPHBhdGggaWQ9Iui3r+W+hF8xNDQ1IiBkYXRhLW5hbWU9Iui3r+W+hCAxNDQ1IiBkPSJNNTI1LjU4LDUxMC43NzNsLTQuNzM4LTQuNTg4YS42MjIuNjIyLDAsMCwwLS40MzQtLjE3M0g1MTcuN2EuNjI1LjYyNSwwLDAsMSwuNDM1LjE3M2w0LjczOCw0LjU4OGEuMzcuMzcsMCwwLDEsMCwuNTRsLTQuNzM5LDQuNTMyYS42MjEuNjIxLDAsMCwxLS40MzIuMTY3aDIuNzExYS42MjEuNjIxLDAsMCwwLC40MzEtLjE2N2w0LjczOS00LjUzMkEuMzcuMzcsMCwwLDAsNTI1LjU4LDUxMC43NzNaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDkuMzAzIDg2Ljk4OSkiIGZpbGw9IiNmZmYiLz4NCiAgICA8cGF0aCBpZD0i6Lev5b6EXzE0NDYiIGRhdGEtbmFtZT0i6Lev5b6EIDE0NDYiIGQ9Ik01MjUuNTgsNTEwLjc3M2wtNC43MzgtNC41ODhhLjYyMi42MjIsMCwwLDAtLjQzNC0uMTczSDUxNy43YS42MjUuNjI1LDAsMCwxLC40MzUuMTczbDQuNzM4LDQuNTg4YS4zNy4zNywwLDAsMSwwLC41NGwtNC43MzksNC41MzJhLjYyMS42MjEsMCwwLDEtLjQzMi4xNjdoMi43MTFhLjYyMS42MjEsMCwwLDAsLjQzMS0uMTY3bDQuNzM5LTQuNTMyQS4zNy4zNywwLDAsMCw1MjUuNTgsNTEwLjc3M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMy4zMDMgODYuOTg5KSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC41Ii8+DQogIDwvZz4NCjwvc3ZnPg0K) no-repeat 50%;\r\n    background-size: 100% 100%;\r\n    margin-left: 4px;\r\n    -webkit-transform: rotate(-90deg);\r\n    transform: rotate(-90deg);\r\n}\r\n\r\n.widgets-doors[data-camera-toward=forward] .door.show-arrow.forward a:before ,\r\n.widgets-doors[data-camera-toward=right] .door.show-arrow.back a:before {\r\n    margin-right: 3.5px;\r\n    -webkit-transform: rotate(180deg);\r\n    transform: rotate(180deg);\r\n}\r\n\r\n.widgets-doors[data-camera-toward="right"] .door.show-arrow.back a:before,\r\n.widgets-doors[data-camera-toward="right"] .door.show-arrow.forward a:after {\r\n    content: "";\r\n    position: relative;\r\n    display: inline-block;\r\n    width: 10.5px;\r\n    height: 10.5px;\r\n    background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDE0IDEwIj4NCiAgPGcgaWQ9ImltZ19hcnJvdyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcyMSAtNTkzKSI+DQogICAgPHBhdGggaWQ9Iui3r+W+hF8xNDQ1IiBkYXRhLW5hbWU9Iui3r+W+hCAxNDQ1IiBkPSJNNTI1LjU4LDUxMC43NzNsLTQuNzM4LTQuNTg4YS42MjIuNjIyLDAsMCwwLS40MzQtLjE3M0g1MTcuN2EuNjI1LjYyNSwwLDAsMSwuNDM1LjE3M2w0LjczOCw0LjU4OGEuMzcuMzcsMCwwLDEsMCwuNTRsLTQuNzM5LDQuNTMyYS42MjEuNjIxLDAsMCwxLS40MzIuMTY3aDIuNzExYS42MjEuNjIxLDAsMCwwLC40MzEtLjE2N2w0LjczOS00LjUzMkEuMzcuMzcsMCwwLDAsNTI1LjU4LDUxMC43NzNaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDkuMzAzIDg2Ljk4OSkiIGZpbGw9IiNmZmYiLz4NCiAgICA8cGF0aCBpZD0i6Lev5b6EXzE0NDYiIGRhdGEtbmFtZT0i6Lev5b6EIDE0NDYiIGQ9Ik01MjUuNTgsNTEwLjc3M2wtNC43MzgtNC41ODhhLjYyMi42MjIsMCwwLDAtLjQzNC0uMTczSDUxNy43YS42MjUuNjI1LDAsMCwxLC40MzUuMTczbDQuNzM4LDQuNTg4YS4zNy4zNywwLDAsMSwwLC41NGwtNC43MzksNC41MzJhLjYyMS42MjEsMCwwLDEtLjQzMi4xNjdoMi43MTFhLjYyMS42MjEsMCwwLDAsLjQzMS0uMTY3bDQuNzM5LTQuNTMyQS4zNy4zNywwLDAsMCw1MjUuNTgsNTEwLjc3M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMy4zMDMgODYuOTg5KSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC41Ii8+DQogIDwvZz4NCjwvc3ZnPg0K) no-repeat 50%;\r\n    background-size: 100% 100%;\r\n    vertical-align: middle;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="right"] .door.show-arrow.forward a:after {\r\n    margin-left: 4px;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="left"] .door.show-arrow.right a:after {\r\n    -webkit-transform: rotate(-90deg);\r\n    transform: rotate(-90deg);\r\n}\r\n\r\n.widgets-doors[data-camera-toward=back] .door.show-arrow.back a:after,\r\n.widgets-doors[data-camera-toward=left] .door.show-arrow.left a:after,\r\n.widgets-doors[data-camera-toward=left] .door.show-arrow.back a:after,\r\n.widgets-doors[data-camera-toward=left] .door.show-arrow.right a:after {\r\n    content: "";\r\n    display: inline-block;\r\n    vertical-align: middle;\r\n    width: 10.5px;\r\n    height: 10.5px;\r\n    background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDE0IDEwIj4NCiAgPGcgaWQ9ImltZ19hcnJvdyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcyMSAtNTkzKSI+DQogICAgPHBhdGggaWQ9Iui3r+W+hF8xNDQ1IiBkYXRhLW5hbWU9Iui3r+W+hCAxNDQ1IiBkPSJNNTI1LjU4LDUxMC43NzNsLTQuNzM4LTQuNTg4YS42MjIuNjIyLDAsMCwwLS40MzQtLjE3M0g1MTcuN2EuNjI1LjYyNSwwLDAsMSwuNDM1LjE3M2w0LjczOCw0LjU4OGEuMzcuMzcsMCwwLDEsMCwuNTRsLTQuNzM5LDQuNTMyYS42MjEuNjIxLDAsMCwxLS40MzIuMTY3aDIuNzExYS42MjEuNjIxLDAsMCwwLC40MzEtLjE2N2w0LjczOS00LjUzMkEuMzcuMzcsMCwwLDAsNTI1LjU4LDUxMC43NzNaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDkuMzAzIDg2Ljk4OSkiIGZpbGw9IiNmZmYiLz4NCiAgICA8cGF0aCBpZD0i6Lev5b6EXzE0NDYiIGRhdGEtbmFtZT0i6Lev5b6EIDE0NDYiIGQ9Ik01MjUuNTgsNTEwLjc3M2wtNC43MzgtNC41ODhhLjYyMi42MjIsMCwwLDAtLjQzNC0uMTczSDUxNy43YS42MjUuNjI1LDAsMCwxLC40MzUuMTczbDQuNzM4LDQuNTg4YS4zNy4zNywwLDAsMSwwLC41NGwtNC43MzksNC41MzJhLjYyMS42MjEsMCwwLDEtLjQzMi4xNjdoMi43MTFhLjYyMS42MjEsMCwwLDAsLjQzMS0uMTY3bDQuNzM5LTQuNTMyQS4zNy4zNywwLDAsMCw1MjUuNTgsNTEwLjc3M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMy4zMDMgODYuOTg5KSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC41Ii8+DQogIDwvZz4NCjwvc3ZnPg0K) no-repeat 50%;\r\n    background-size: 100% 100%;\r\n    margin-left: 4px;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="left"] .door.show-arrow.back a:after {\r\n    position: relative;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="left"] .door.show-arrow.forward a:before {\r\n    position: relative;\r\n    margin-right: 3.5px;\r\n    -webkit-transform: rotate(180deg);\r\n    transform: rotate(180deg);\r\n}\r\n\r\n.widgets-doors[data-camera-toward="back"] .door.show-arrow.forward a:after,\r\n.widgets-doors[data-camera-toward="left"] .door.show-arrow.forward a:before {\r\n    content: "";\r\n    display: inline-block;\r\n    width: 10.5px;\r\n    height: 10.5px;\r\n    background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDE0IDEwIj4NCiAgPGcgaWQ9ImltZ19hcnJvdyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcyMSAtNTkzKSI+DQogICAgPHBhdGggaWQ9Iui3r+W+hF8xNDQ1IiBkYXRhLW5hbWU9Iui3r+W+hCAxNDQ1IiBkPSJNNTI1LjU4LDUxMC43NzNsLTQuNzM4LTQuNTg4YS42MjIuNjIyLDAsMCwwLS40MzQtLjE3M0g1MTcuN2EuNjI1LjYyNSwwLDAsMSwuNDM1LjE3M2w0LjczOCw0LjU4OGEuMzcuMzcsMCwwLDEsMCwuNTRsLTQuNzM5LDQuNTMyYS42MjEuNjIxLDAsMCwxLS40MzIuMTY3aDIuNzExYS42MjEuNjIxLDAsMCwwLC40MzEtLjE2N2w0LjczOS00LjUzMkEuMzcuMzcsMCwwLDAsNTI1LjU4LDUxMC43NzNaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDkuMzAzIDg2Ljk4OSkiIGZpbGw9IiNmZmYiLz4NCiAgICA8cGF0aCBpZD0i6Lev5b6EXzE0NDYiIGRhdGEtbmFtZT0i6Lev5b6EIDE0NDYiIGQ9Ik01MjUuNTgsNTEwLjc3M2wtNC43MzgtNC41ODhhLjYyMi42MjIsMCwwLDAtLjQzNC0uMTczSDUxNy43YS42MjUuNjI1LDAsMCwxLC40MzUuMTczbDQuNzM4LDQuNTg4YS4zNy4zNywwLDAsMSwwLC41NGwtNC43MzksNC41MzJhLjYyMS42MjEsMCwwLDEtLjQzMi4xNjdoMi43MTFhLjYyMS42MjEsMCwwLDAsLjQzMS0uMTY3bDQuNzM5LTQuNTMyQS4zNy4zNywwLDAsMCw1MjUuNTgsNTEwLjc3M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMy4zMDMgODYuOTg5KSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC41Ii8+DQogIDwvZz4NCjwvc3ZnPg0K) no-repeat 50%;\r\n    background-size: 100% 100%;\r\n    vertical-align: middle;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="back"] .door.show-arrow.forward a:after {\r\n    margin-left: 4px;\r\n    -webkit-transform: rotate(-90deg);\r\n    transform: rotate(-90deg);\r\n}\r\n\r\n.widgets-doors[data-camera-toward="back"] .door.show-arrow.right a:after {\r\n    margin-left: 4px;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="back"] .door.show-arrow.left a:before,\r\n.widgets-doors[data-camera-toward="back"] .door.show-arrow.right a:after {\r\n    content: "";\r\n    position: relative;\r\n    display: inline-block;\r\n    width: 10.5px;\r\n    height: 10.5px;\r\n    background: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNCIgaGVpZ2h0PSIxMCIgdmlld0JveD0iMCAwIDE0IDEwIj4NCiAgPGcgaWQ9ImltZ19hcnJvdyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTcyMSAtNTkzKSI+DQogICAgPHBhdGggaWQ9Iui3r+W+hF8xNDQ1IiBkYXRhLW5hbWU9Iui3r+W+hCAxNDQ1IiBkPSJNNTI1LjU4LDUxMC43NzNsLTQuNzM4LTQuNTg4YS42MjIuNjIyLDAsMCwwLS40MzQtLjE3M0g1MTcuN2EuNjI1LjYyNSwwLDAsMSwuNDM1LjE3M2w0LjczOCw0LjU4OGEuMzcuMzcsMCwwLDEsMCwuNTRsLTQuNzM5LDQuNTMyYS42MjEuNjIxLDAsMCwxLS40MzIuMTY3aDIuNzExYS42MjEuNjIxLDAsMCwwLC40MzEtLjE2N2w0LjczOS00LjUzMkEuMzcuMzcsMCwwLDAsNTI1LjU4LDUxMC43NzNaIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMDkuMzAzIDg2Ljk4OSkiIGZpbGw9IiNmZmYiLz4NCiAgICA8cGF0aCBpZD0i6Lev5b6EXzE0NDYiIGRhdGEtbmFtZT0i6Lev5b6EIDE0NDYiIGQ9Ik01MjUuNTgsNTEwLjc3M2wtNC43MzgtNC41ODhhLjYyMi42MjIsMCwwLDAtLjQzNC0uMTczSDUxNy43YS42MjUuNjI1LDAsMCwxLC40MzUuMTczbDQuNzM4LDQuNTg4YS4zNy4zNywwLDAsMSwwLC41NGwtNC43MzksNC41MzJhLjYyMS42MjEsMCwwLDEtLjQzMi4xNjdoMi43MTFhLjYyMS42MjEsMCwwLDAsLjQzMS0uMTY3bDQuNzM5LTQuNTMyQS4zNy4zNywwLDAsMCw1MjUuNTgsNTEwLjc3M1oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMy4zMDMgODYuOTg5KSIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iMC41Ii8+DQogIDwvZz4NCjwvc3ZnPg0K) no-repeat 50%;\r\n    background-size: 100% 100%;\r\n    vertical-align: middle;\r\n}\r\n\r\n.widgets-doors[data-camera-toward="back"] .door.show-arrow.left a:before {\r\n    margin-right: 3.5px;\r\n    -webkit-transform: rotate(180deg);\r\n    transform: rotate(180deg);\r\n}\r\n\r\n.widgets-doors .door {\r\n    position: absolute;\r\n    width: 0;\r\n    height: 0;\r\n    /* display: none; */\r\n    -webkit-animation: viewport-door-label 0.3s ease 1s;\r\n    animation: viewport-door-label 0.3s ease 1s;\r\n    -webkit-animation-fill-mode: both;\r\n    animation-fill-mode: both;\r\n    -webkit-transform: translateZ(0);\r\n    transform: translateZ(0);\r\n    cursor: pointer;\r\n}\r\n\r\n.widgets-doors .door a {\r\n    display: block;\r\n    position: absolute;\r\n    top: 50%;\r\n    left: 50%;\r\n    -webkit-transform: translate(-50%, -50%);\r\n    transform: translate(-50%, -50%);\r\n    border-radius: 1.75px;\r\n    background: rgba(0, 0, 0, 0.5);\r\n    line-height: 14px;\r\n    padding: 8px 8px;\r\n    border-radius: 4px;\r\n    white-space: nowrap;\r\n    font-size: 14px;\r\n    font-style: normal;\r\n    pointer-events: auto;\r\n    -webkit-transition: background 0.3s ease, color 0.3s ease, -webkit-transform 1s ease;\r\n    transition: background 0.3s ease, color 0.3s ease, -webkit-transform 1s ease;\r\n    transition: transform 1s ease, background 0.3s ease, color 0.3s ease;\r\n    transition: transform 1s ease, background 0.3s ease, color 0.3s ease, -webkit-transform 1s ease;\r\n}\r\n\r\n.widgets-doors .door a:after {\r\n    -webkit-transition: opacity 0.3s ease;\r\n    transition: opacity 0.3s ease;\r\n}\r\n\r\n.widgets-doors .door a:active {\r\n    background: rgba(0, 0, 0, 0.5);\r\n    color: hsla(0, 0%, 100%, 0.5);\r\n}\r\n\r\n.widgets-doors .door a:active:after {\r\n    opacity: 0.5;\r\n}\r\n\r\n@-webkit-keyframes room-label {\r\n    0% {\r\n        opacity: 0;\r\n        margin-top: 8.75px;\r\n    }\r\n\r\n    to {\r\n        opacity: 1;\r\n        margin-top: 0;\r\n    }\r\n}\r\n\r\n@keyframes room-label {\r\n    0% {\r\n        opacity: 0;\r\n        margin-top: 8.75px;\r\n    }\r\n\r\n    to {\r\n        opacity: 1;\r\n        margin-top: 0;\r\n    }\r\n}\r\n\r\n@-webkit-keyframes door-label {\r\n    0% {\r\n        opacity: 0;\r\n        margin-top: 8.75px;\r\n    }\r\n\r\n    to {\r\n        opacity: 1;\r\n        margin-top: 0;\r\n    }\r\n}\r\n\r\n@keyframes door-label {\r\n    0% {\r\n        opacity: 0;\r\n        margin-top: 8.75px;\r\n    }\r\n\r\n    to {\r\n        opacity: 1;\r\n        margin-top: 0;\r\n    }\r\n}',{});var Ar=function(){function e(t){i(this,e),this.sortByScore=function(e,t,n){var o=se.filterAll(e,t);return 0===o.length?null:o=o.map((function(e){return{item:e,score:n.reduce((function(t,n){return t+n(e)}),0)}})).sort((function(e,t){return t.score-e.score}))},this.player=t;var n=document.createElement("div");n.className="widgets-doll-labels",t.domElement.append(n);var o=document.createElement("div");o.className="widgets-plan-labels",t.domElement.append(o);var r=document.createElement("div");r.className="widgets-doors",t.domElement.append(r),this.player.$app.store.getValue("flooruser")&&this.init(),this.player.$app.store.on("flooruser",this.init.bind(this))}return u(e,[{key:"init",value:function(){for(var e=this,t=this.player.$app.store.getValue("flooruser"),n=!0,o=0;o<t.floors.length;o++)for(var i in t.floors[o])if(t.floors[o][i]instanceof Array&&t.floors[o][i].length>0){n=!1;break}n||(this.player.defaultRoomLabels.forEach((function(e){return e.remove()})),this.player.defaultRoomLabels=[],t.floors.forEach((function(n,o){var i=e.player.model.floors.index[o];if(i){i.entryArrow=[];var r=i.boundingBox.min.y,a=JSON.parse(JSON.stringify(n));if(a.symbols&&Object.keys(a.symbols).forEach((function(n){var o=a.symbols[n];o.endPoint=Dr(o.endPoint,t.angle,e.player.model.center),o.startPoint=Dr(o.startPoint,t.angle,e.player.model.center),o.points2d=o.points2d.map((function(n){return Dr(n,t.angle,e.player.model.center)}))})),a.tags&&Object.keys(a.tags).forEach((function(n){var o=a.tags[n];o.center=Dr(o.center,t.angle,e.player.model.center),o.points2d=o.points2d.map((function(n){return Dr(n,t.angle,e.player.model.center)}))})),a.rooms&&Object.keys(a.rooms).forEach((function(n){var o=a.rooms[n];o.center=Dr(o.center,t.angle,e.player.model.center)})),a.points&&Object.keys(a.points).forEach((function(n){var o=a.points[n],i=Dr({x:o.x,y:o.y},t.angle,e.player.model.center);o.x=i.x,o.y=i.y})),a.symbols){for(var s,l=Object.keys(a.symbols),c=0;c<l.length;c++)a.symbols[l[c]].enter&&((s=JSON.parse(JSON.stringify(a.symbols[l[c]]))).bottom=r+.1,s.floorIndex=o,i.entryArrow.push(new Ir(e.player,s)),e.player.model.currentFloor.floorIndex==o?e.updateEntryVisi(!0,o):e.updateEntryVisi(!1,o));e.moveEntryArrow(o)}a.tags=a.tags||{},e.hasPlaneLabels=a.tags.length>0;var u=i.center.y;Object.keys(a.tags).forEach((function(t){var n=a.tags[t],r=n.title,s=n.des+n.unit+"<sup>2</sup>",l=n.des?"约"+s:"";if(r||l){var c=r&&l?r+"<br>"+s:r||l,h="floorplan"==e.player.modeTran.split("-")[1]?new THREE.Vector3(0,-1,0):new THREE.Vector3(0,1,0),d=n.center,p=new THREE.Vector3(d.x,-999*h.y,-d.y),f=new THREE.Raycaster(p,h,.001,9999).intersectObject(i.children[0]);f[0]?(p=f[0].point).y+=.5:p.y=u;var m=e.player.model.panos.closestPanoTowardPoint({point:p,floor:i});m||console.error("what!!! no closetPano");var v=new Er(e.player,{sid:t,pos:p.clone(),text:c,toPano:m,floorIndex:o});e.player.defaultRoomLabels.push(v),e.player.defaultRoomLabels.forEach((function(e){e.update()}))}})),e.initDoorLabels(o,JSON.parse(JSON.stringify(a)))}else ke.warn("floor[".concat(o,"] is empty"))})),this.initedLabel=!0,this.setPlanLabelVisi())}},{key:"initDoorLabels",value:function(e,t){var n=this,o=[];if(t.rooms&&t.rooms[0]&&t.rooms[0].wallPointIDs){var i=this.player.model.floors.index[e],r=i.boundingBox.min.y;console.log("floorJson",t),Object.keys(t.tags).forEach((function(e){var n=t.tags[e];n.__panos=[],n.title||delete t.tags[e]})),console.log(t.rooms);var a={};Object.keys(t.symbols).forEach((function(e){var n=t.symbols[e];"SingleDoor"!=n.geoType&&"SlideDoor"!=n.geoType&&"DoubleDoor"!=n.geoType||(a[e]=n)})),t.rooms.forEach((function(e,t){e.name="",e.doors=Object.values(a).filter((function(t){return e.wallIds.indexOf(t.parent)>-1}))||[],e.taggings=[],e.panos=[]})),Object.keys(a).forEach((function(e){var n=a[e];n.doorLabels=[],o.push(n),n.center={x:(n.points2d[0].x+n.points2d[1].x)/2,y:(n.points2d[0].y+n.points2d[1].y)/2},n.atRooms=[],t.rooms.forEach((function(e){var t=e.doors.find((function(e){return e.vectorId==n.vectorId}));t&&(n.linePoints=t.linePoints,e.doors.push(n),n.atRooms.push(e))}))})),t.rooms.forEach((function(e){e.doors=e.doors.filter((function(e){return e.atRooms}))})),i.panos.forEach((function(e){e._atRoom=null})),t.rooms.forEach((function(e){e.points=e.wallPointIDs.map((function(e){return t.points[e]})),null==e.closetParent&&(i.panos.forEach((function(o){!o._atRoom&&o.isAligned()&&n.searchAtRoom(t,e,o,{x:o.position.x,y:-o.position.z},(function(e){o._atRoom=e,e.panos.push(o)}))})),Object.keys(t.tags).forEach((function(o){var i=t.tags[o];i._atRoom||n.searchAtRoom(t,e,i,{x:i.center.x,y:i.center.y},(function(e){i._atRoom=e,e.taggings.push(i),e.name+=i.title+" "}))}))),e.taggings.length&&e.panos.forEach((function(o){var i=n.sortByScore(e.taggings,[function(e){var i=new THREE.Vector2(o.position.x,o.position.z),r=new THREE.Vector2(e.center.x,-e.center.y);return!n.isShelter(t,r,i)}],[function(e){var t=new THREE.Vector2(o.position.x,o.position.z),n=new THREE.Vector2(e.center.x,-e.center.y);return-t.distanceTo(n)}]);i&&i[0]&&i[0].item.__panos.push(o)}))})),Object.keys(t.tags).forEach((function(e){var o=t.tags[e],i=o.__panos.filter((function(e){return e.neighbourUUIDs.length>0}));i.length&&(o.clickToPano=n.sortByScore(i,[],[function(e){var t=new THREE.Vector2(e.position.x,e.position.z),n=new THREE.Vector2(o.center.x,-o.center.y);return-t.distanceTo(n)}])[0].item)})),i.taggingTables=Object.values(t.tags).filter((function(e){return e.clickToPano}));var s="floor".concat(e,"(").concat(t.name||"no name",") 共有").concat(t.rooms.length,"个房间，分别是  ");t.rooms.forEach((function(e){s+="\n房间".concat(e.roomId," :  ").concat(e.name," ")})),t.rooms.forEach((function(o){0!=o.taggings.length&&(be.getArea(o.points),o.doors.forEach((function(a){if(!(a.atRooms.length<2)){if(o.closetChilds){var s=a.atRooms.find((function(e){return a.startPoint&&a.endPoint}));be.getArea(s.points)}var l=be.getNormal({points:[a.startPoint,a.endPoint]}),c=new THREE.Vector3(l.x,0,-l.y),u=!1,h=o.panos.filter((function(e){return e.neighbourUUIDs.length>0}));0==h.length&&(u=!0,h=i.panos.filter((function(e){if(0!=e.neighbourUUIDs.length){var t=new THREE.Vector2(a.center.x,-a.center.y),n=new THREE.Vector2(e.position.x,e.position.z);if(!(t.distanceTo(n)>5)){var o=e.position.clone().sub(new THREE.Vector3(a.center.x,0,-a.center.y));return c.angleTo(o)<Math.PI/2||void 0}}})));var d=n.sortByScore(h,[],[function(e){var t=0;if(u){var n=e.position.clone().sub(new THREE.Vector3(a.center.x,0,-a.center.y));t=2*-c.angleTo(n)}var o=new THREE.Vector2(a.center.x,-a.center.y),i=new THREE.Vector2(e.position.x,e.position.z);return-o.distanceTo(i)+t}]);d&&(d=d[0].item);var p=n.sortByScore(o.taggings,[],[function(e){var t=d?new THREE.Vector2(d.position.x,d.position.z):new THREE.Vector2(a.center.x,a.center.y),n=new THREE.Vector2(e.center.x,-e.center.y);return-t.distanceTo(n)}])[0].item,f=new THREE.Vector3(a.center.x,r+.3,-a.center.y),m=a.atRooms.find((function(e){return e!=o&&e.name}));m||(m=a.atRooms.find((function(e){return e!=o})));var v=Math.PI/6,g=m.panos,y=g.filter((function(e){var o=e.position.clone().setY(0).distanceTo(f.clone().setY(0));if(!(o<1.5||o>15))return o>4||g.find((function(t){return ro.filters.isInFanAngle(f,e.position.clone().sub(f).setY(0),v)(t)}))?!n.isShelter(t,f,e.position,a.line):void 0})),w=new Cr(n.player,{doorDir:c,text:p.title,pos:f,visiblePanos:y,sameRoomPanos:g,toPano:d,aim:new THREE.Vector3(p.center.x,0,-p.center.y),floorIndex:e});w.door=a,w.forRoom=o,w.forTag=p,a.doorLabels.push(w),n.player.defaultRoomLabels.push(w)}})))})),o=o.filter((function(e){return e.atRooms.length>1})),s+="\n中通门共有".concat(o.length,"扇： \n"),o.forEach((function(e,t){s+="门".concat(e.vectorId,"在 "),e.atRooms.forEach((function(e){s+="房间".concat(e.roomId,"(").concat(e.name,")、 ")})),s+="的边上 \n"})),console.log("%c".concat(s),"color:#13f"),this.player.doorLabels.forEach((function(e){e.update()})),this.player.updateLabelZIndex(["doorLabels"]),Cr.updateCameraDir(this.player)}else console.log("没有room or 数据不标准  得不到doorlabels")}},{key:"setPlanLabelVisi",value:function(e,t){if(null==(this.player.$app.store.getValue("metadata")||{}).floorPlanAngle&&this.initedLabel){null==e&&(e=this.player.model.floorplanCadImg.show);var n=this.player.planLabels;null!=t&&(n=n.filter((function(e){return e.floorIndex==t}))),n.forEach((function(t){t.enable=e,t.update()}))}}},{key:"setDoorLabelVisi",value:function(e,t){if(null==(this.player.$app.store.getValue("metadata")||{}).floorPlanAngle&&this.initedLabel){var n=this.player.doorLabels;null!=t&&(n=n.filter((function(e){return e.floorIndex==t}))),n.forEach((function(t){t.enable=e,t.update()}))}}},{key:"setDollLabelVisi",value:function(e,t){if(null==(this.player.$app.store.getValue("metadata")||{}).floorPlanAngle&&this.initedLabel){var n=this.player.dollLabels;null!=t&&(n=n.filter((function(e){return e.floorIndex==t}))),n.forEach((function(t){t.enable=e,t.update()}))}}},{key:"updateEntryVisi",value:function(e,t){var n=this,o=!(this.player.model.floorplanCadImg&&!this.player.model.floorplanCadImg.show||this.player.linkEditor&&this.player.linkEditor.setPanoVisible),i=this.player.model.floors;null!=t&&(i=i.filter((function(e){return e.floorIndex==t}))),i.forEach((function(t){if(t.entryArrow.length){if(o)if(0==e)o=!1;else{var i=n.player.modeTran.split("-")[1];o="floorplan"==i||"panorama"!=i&&"dollhouse"==i}t.entryArrow.forEach((function(e){return o?e.show():e.hide()}))}}))}},{key:"moveEntryArrow",value:function(e){var t=this.player.model.floors.index[e];if(t.entryArrow.length&&t.cadImgRatio){var n=24*this.player.model.floors.index[e].cadImgRatio;t.entryArrow.forEach((function(e){return e.moveCloseToWall(n)}))}}},{key:"searchAtRoom",value:function(e,t,n,o,i){var r=this;if(be.isPointInArea(t.points,o)){if(t.closetChilds)t.closetChilds.find((function(t){return r.searchAtRoom(e,e.rooms.find((function(e){return e.roomId==t})),n,o,i)}))||i(t);else i(t);return!0}}},{key:"order",value:function(e,t,n){var o=n.find((function(t){return t.id==e})),i=n.find((function(e){return e.id==t})),r=n.indexOf(o);return(n.indexOf(i)-r+n.length)%n.length==1}},{key:"isShelter",value:function(e,t,n,o){var i=this,r=[new THREE.Vector2(t.x,-t.z),new THREE.Vector2(n.x,-n.z)];return Object.values(e.walls).find((function(t){if(t.id!=o){var n=[i.searchItemById(t.start,Object.values(e.points)),i.searchItemById(t.end,Object.values(e.points))];return be.isLineIntersect(r,n)}}))}},{key:"searchItemById",value:function(e,t){for(var n=0,o=t.length;n<o;n++)if(t[n].vectorId==e)return t[n]}},{key:"show",value:function(e){this.updateEntryVisi(!0,e),this.setPlanLabelVisi(!0,e),this.setDoorLabelVisi(!0,e),this.setDollLabelVisi(!0,e)}},{key:"hide",value:function(e){this.updateEntryVisi(!1,e),this.setPlanLabelVisi(!1,e),this.setDoorLabelVisi(!1,e),this.setDollLabelVisi(!1,e)}},{key:"reset",value:function(){this.player.defaultRoomLabels.forEach((function(e){return e.remove()})),this.player.model.floors.forEach((function(e){e.entryArrow.forEach((function(e){return e.dispose()}))}))}},{key:"gotoFloor",value:function(e){this.hide(),this.show(e)}}]),e}();function Dr(e,t,n){var o=new THREE.Vector2(e.x,e.y);if(Math.abs(t)<.01||Math.abs(t-2*Math.PI)<.01)return o;var i=(o.x-n.x)*Math.cos(t)-(o.y- -1*n.z)*Math.sin(t)+n.x,r=(o.y- -1*n.z)*Math.cos(t)+(o.x-n.x)*Math.sin(t)+-1*n.z;return o.x=i,o.y=r,o}var Lr=new THREE.Vector3(0,0,-1),zr=function(){function e(t){i(this,e),this.angle=0,this.quar=new THREE.Quaternion,this.player=t,this.config=t.$app.config,this.init(),this.show=!1}return u(e,[{key:"init",value:function(){var e=this;if(this.dom=document.createElement("div"),this.dom.id="compass",this.dom.innerHTML='\n            <div class="dirText north">\n                <span>N</span>\n            </div>\n            <div class="center"></div>\n        ',this.player.domElement.append(this.dom),this.dirTextDiv=this.dom.querySelector(".dirText"),this.centerDiv=this.dom.querySelector(".center"),this.span=this.dirTextDiv.querySelector("span"),this.config.view?(this.dom.style.right=this.config.mobile?"1%":"2%",this.dom.style.top=this.config.mobile?"10%":"4%"):(this.dom.style.right=this.config.mobile?"1%":"260px",this.dom.style.top=this.config.mobile?"10%":"60px"),this.centerDiv.style.width="50px",this.centerDiv.style.height="50px",this.config.mobile){var t=this.player.getSize(),n=t.clientWidth,o=t.clientHeight,i=Math.min(n,o);if(i<450){var r=Math.round(i/450*1e3)/1e3;this.dom.transform=" scale(".concat(r,")")}}try{this.renderer=new THREE.WebGLRenderer({antialias:this.config.antialias,alpha:!0}),this.renderer.autoClear=!0,this.renderer.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1),this.renderer.domElement.setAttribute("name","compass"),this.renderer.setClearAlpha(0),this.renderer.setSize(50,50,!1,window.devicePixelRatio?window.devicePixelRatio:1)}catch(e){throw new RendererCreationException("Unable to create a WebGL rendering context")}this.centerDiv.appendChild(this.renderer.domElement),this.camera=new THREE.PerspectiveCamera,this.camera.fov=70,this.scene=new THREE.Scene,this.scene.add(this.camera),this.createCompass(),this.player.on("scene/LoadHouseFloor",(function(){e.setNorth()})),this.player.on("changeDir",(function(){e.setNorth()}));var a=this.player.$app.store.getValue("flooruser");this.angle=(a.compass-THREE.Math.radToDeg(a.angle)+360)%360||0,this.player.$app.store.on("flooruser",(function(t){e.angle=(t.compass-THREE.Math.radToDeg(t.angle)+360)%360||0}))}},{key:"createCompass",value:function(){var e=new THREE.ConeBufferGeometry(.7,2,4,!0),t=new THREE.ConeBufferGeometry(.7,2,4,!0),n=new THREE.MeshBasicMaterial({vertexColors:!0}),o=function(e,t,n){for(var o=[],i=0,r=e.attributes.position.count;i<r;++i)o.push(1,1,1);var a=function(e,t){o[3*e+0]=t[0],o[3*e+1]=t[1],o[3*e+2]=t[2]},s=[(t[0]+n[0])/2,(t[1]+n[1])/2,(t[2]+n[2])/2];a(1,t),a(5,t),a(6,t),a(2,s),a(3,s),a(7,s),a(4,n),a(8,n),a(9,n),e.addAttribute("color",new THREE.BufferAttribute(new Float32Array(o),3))},i=[20/255,146/255,170/255];o(e,[1/255,238/255,245/255],i),o(t,i,[40/255,60/255,103/255]);var r=new THREE.Mesh(e,n);r.position.setY(1),e.computeVertexNormals(),t.computeVertexNormals();var a=new THREE.Object3D;a.add(r);var s=new THREE.Mesh(t,n);s.rotation.x=Math.PI,s.position.setY(-1),a.add(s),a.rotation.z=Math.PI/2,a.rotation.y=Math.PI/2,a.scale.set(.7,.7,.7),this.scene.add(a),this.cones=a}},{key:"setNorth",value:function(){var e=this.player.$app.store.getValue("flooruser").floors;if(e&&e.length){var t=e[0],n=this.player.$app.store.getValue("metadata")||{};this.angle=(t&&t.dire||0)+THREE.Math.radToDeg(parseFloat(n.floorPlanAngle||0)),this.cones.rotation.y=Math.PI/2-THREE.Math.degToRad(this.angle),console.log("dir:"+t.dire+", floorPlanAngle:"+n.floorPlanAngle),this.update(),this.player.model.floorLogos.setDir(this.angle)}}},{key:"update",value:function(e){this.show&&(e||(e=this.player.camera.quaternion.clone()),this.cones.rotation.y=Math.PI/2-this.angle/180*Math.PI,this.updateCamera(e),this.updateLabel(e),this.render())}},{key:"updateLabel",value:function(e){var t,n=this.player.getDirection(),o=Lr.clone();if("transitioning"==this.player.mode){var i=new THREE.Camera;i.position.copy(this.camera.position),i.lookAt(i.position.clone().add(n)),t=i.quaternion.inverse().premultiply(e)}var r=new THREE.Vector3(0,1,0);t&&r.applyQuaternion(t),n.projectOnPlane(r),o.projectOnPlane(r);var a=n.angleTo(o);n.cross(o).y>0&&(a=-a);var s=this.angle-90+THREE.Math.radToDeg(a);this.dirTextDiv.style.transform="rotate("+s+"deg)",this.span.style.transform="rotate("+-s+"deg)"}},{key:"updateCamera",value:function(e){this.camera.quaternion.copy(e);var t=this.player.getDirection();this.camera.position.copy(t.multiplyScalar(5).negate())}},{key:"render",value:function(){this.renderer.render(this.scene,this.camera)}},{key:"setDisplay",value:function(e){this.show=!!e,this.show?(this.update(),this.dom.style.display="block"):this.dom.style.display="none"}},{key:"autoJudgeDisplay",value:function(){"panorama"!=this.player.modeTran.split("-")[1]?this.setDisplay(!0):this.setDisplay(!1)}},{key:"setDomLeft",value:function(){this.dom.css({right:"none",left:this.config.mobile?"1%":"2%"})}}]),e}();function Vr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}window.flyToPanoCount=0,me("Player",(function(){return function(e){f(n,EventEmitter);var t=Vr(n);function n(){var e,o,r,a,s,l;return i(this,n),(e=t.call(this)).setupCustomProperties=function(e){var t=e||Oe.PANORAMA;Object.defineProperty(this,"mode",{get:function(){return t},set:function(e){var n=t;t=e,this.onModeUpdated(n,t)}})},e.isOutsideMode=function(e){return(e=e||this.mode)===Oe.DOLLHOUSE||e===Oe.FLOORPLAN},e.is360View=function(e,t){return!1},e.setScene=function(){var e=this.$app.core.get("SceneRenderer").scene;this.sceneIntersectionPlane=e.plane,this.path.setScene(e),this.moveReticuleToScene(e)},e.moveReticuleToScene=function(e){this.reticule.parent&&this.reticule.parent.remove(this.reticule),e.add(this.reticule)},e.updateModel=function(){this.model=this.modelManager.getActiveModel(),this.model.player=this,this.on(Ko,this.model.setProjectedPanos.bind(this.model)),this.on(ni,this.model.resetHighMap.bind(this.model))},e.updateModelDependentData=function(){this.cameraControls.setModelForControls(this.model)},e.handleControlMove=function(e){this.emit(Qo,e),this.mode===Oe.PANORAMA&&this.emit(Go,{quaternion:this.cameraControls.activeControl.camera.quaternion,mode:Oe.PANORAMA,currentPanoId:this.currentPano?this.currentPano.id:null,type:"rotate"})},e.handleControlInputStart=function(e){this.emit(ci,e)},e.onModeUpdated=function(e,t){this.cameraControls.activateControls(t),this.emit(Xo,e,t),"transitioning"==t?(e=this.modeTran.split("-")[0])==Oe.PANORAMA&&(this.flyingToTag=this.flyRotate=this.flyingWithRot=!1,this.model.chunks.forEach((function(e){e.visible=!0}))):(t=this.modeTran.split("-")[1],this.isOutsideMode(e)&&this.isOutsideMode(t)||this.model.fadePanoMarkers(),Oe.PANORAMA)},e.isWarping=function(){return!1},e.isWaitingToWarp=function(){return!1},e.bindEvents=function(e){e!==document&&e.setAttribute("tabindex",-1),e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("mouseover",this.onMouseOver.bind(this)),e.addEventListener("mouseout",this.onMouseOut.bind(this)),e.addEventListener("mouseup",this.onMouseUp.bind(this)),e.addEventListener("touchstart",this.onTouchStart.bind(this),{passive:!1}),e.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!1}),e.addEventListener("touchend",this.onTouchEnd.bind(this)),e.addEventListener("pointerdown",this.onPointerDown.bind(this)),e.addEventListener("pointermove",this.onPointerMove.bind(this)),e.addEventListener("pointerup",this.onPointerUp.bind(this)),e.addEventListener("pointerout",this.onPointerOut.bind(this)),e.addEventListener("pointercancel",this.onPointerCancel.bind(this)),document.addEventListener("keydown",this.onKeyDown.bind(this)),this.cameraControls.on(bi,this.handleControlMove.bind(this)),this.cameraControls.on(Ti,this.handleControlInputStart.bind(this)),this.cameraControls.on(Pi,this.handleControlPinch.bind(this)),this.cameraControls.on(ki,this.handleControlScroll.bind(this))},e.onMouseDown=function(e){e.currentTarget!==document&&e.currentTarget.focus(),0===e.button&&(this.handleInputStart.call(this,e.clientX,e.clientY,!1),this.updateIntersect())},e.onMouseMove=function(e){this.isTouchEvent=!1,this.handleInputMove.call(this,e.clientX,e.clientY,!1)},e.onMouseOver=function(e){this.containsMouse=!0,!this.mouseDown||0!==e.which&&0!==e.buttons||(this.mouseDown=!1)},e.onMouseOut=function(e){this.containsMouse=!1},e.onMouseUp=function(e){this.handleInputEnd.call(this,e.clientX,e.clientY,!1),this.emit(Yo,{rotationSpeed:this.cameraControls.activeControl?this.cameraControls.activeControl.rotationSpeed:null,type:"endRotation"})},e.onTouchStart=function(e){if(e.currentTarget!==document&&e.currentTarget.focus(),!this.mouseDown){this.couldBeLongTap=!0;var t=se.average(e.changedTouches,"clientX"),n=se.average(e.changedTouches,"clientY");this.handleInputStart.call(this,t,n,!0),this.mouseDownTimer=setTimeout(function(){this.updateIntersect(),this.handleInputEnd.call(this,t,n,!0)}.bind(this),He.input.longTapThreshold)}},e.onTouchMove=function(e){var t=se.average(e.changedTouches,"clientX"),n=se.average(e.changedTouches,"clientY");this.handleInputMove.call(this,t,n,!0)},e.onTouchEnd=function(e){if(clearTimeout(this.mouseDownTimer),this.mouseDown){this.couldBeLongTap=!1,this.updateIntersect();var t=se.average(e.changedTouches,"clientX"),n=se.average(e.changedTouches,"clientY");this.handleInputEnd.call(this,t,n,!0),this.emit(Yo)}},e.onPointerDown=function(e){return e.currentTarget!==document&&e.currentTarget.focus(),this.mouseDown||"mouse"===e.pointerType?this.onMouseDown(e):(this.couldBeLongTap=!0,this.handleInputStart.call(this,e.clientX,e.clientY,!0),void(this.mouseDownTimer=setTimeout(function(){this.updateIntersect(),this.handleInputEnd.call(this,e.clientX,e.clientY,!0)}.bind(this),He.input.longTapThreshold)))},e.onPointerMove=function(e){"mouse"!==e.pointerType?this.handleInputMove.call(this,e.clientX,e.clientY,!0):this.onMouseMove(e)},e.onPointerUp=function(e){this.mouseDown&&"mouse"!==e.pointerType?(this.mouseDownTimer&&clearTimeout(this.mouseDownTimer),this.couldBeLongTap=!1,this.updateIntersect(),this.handleInputEnd.call(this,e.clientX,e.clientY,!0),this.emit(Yo)):this.onMouseUp(e)},e.onPointerOut=function(e){this.mouseDown=!1},e.onPointerCancel=function(e){this.mouseDown=!1},e.onKeyDown=function(e){if(this.$app.config.useShortcutKeys){var t=function(){this.cameraControls.activeControl&&this.cameraControls.activeControl.emit(bi,"key")}.bind(this),n=e.which;switch(n){case Vi.F:t(),this.changeFloor(-1);break;case Vi.R:t(),this.changeFloor(1)}if(this.mode===Oe.PANORAMA)switch(n){case Vi.UPARROW:case Vi.W:this.flyLocalDirection(Fe.FORWARD.clone());break;case Vi.DOWNARROW:case Vi.S:this.flyLocalDirection(Fe.BACK.clone());break;case Vi.A:this.flyLocalDirection(Fe.LEFT.clone());break;case Vi.D:this.flyLocalDirection(Fe.RIGHT.clone())}if(this.started)switch(n){case Vi.ONE:this.insideMode();break;case Vi.TWO:this.flyToNewMode({mode:Oe.DOLLHOUSE});break;case Vi.THREE:this.flyToNewMode({mode:Oe.FLOORPLAN})}}},e.handleScrollPinchZoom=function(e){var t=e,n=this.zoomLevel;this.zoomBy(t),this.currentPano&&this.zoomStats.addZoomAction(n,this.zoomLevel,this.currentPano.id)},e.handleControlPinch=function(e){He.zoom.enabled?this.handleScrollPinchZoom(1-e):this.flyLocalDirection(new THREE.Vector3(0,0,e).normalize())},e.handleControlScroll=function(e){this.emit(qo,{zoom:e,type:"zoom"}),He.zoom.enabled?(e>0?e=1+this.scrollZoomSpeed:e<0&&(e=1-this.scrollZoomSpeed),0!==e&&this.handleScrollPinchZoom(e)):this.flyLocalDirection(new THREE.Vector3(0,0,-e).normalize())},e.handleInputStart=function(e,t,n,o){var i={x:e,y:t};o||(i=be.handelPadding(e,t,this.domElement)),be.convertScreenPositionToNDC(i.x,i.y,this.mouse,this.domElement),be.convertScreenPositionToNDC(i.x,i.y,this.mouseAtMouseDown,this.domElement),this.mouseCouldBeClickToMove=!0,this.mouseDown=!0,this.OverlayManager&&(this.intersect=this.getMouseIntersect(null,this.OverlayManager.group.children.concat(this.model.colliders)),this.intersect&&(this.intersect.object.overlayType||this.intersect.object.parent.overlayType)?this.OverlayManager.hoverOverlay(this.intersect.object):this.OverlayManager.hoverOverlay(null),this.OverlayManager.group.children.forEach((function(e){"video"==e.overlayType&&e.plane.material.map.image.play()}))),this.EditPanoVideo&&this.EditPanoVideo.editing?this.EditPanoVideo.dealPointerDown():this.EditPanoMosaic&&this.EditPanoMosaic.editing?this.EditPanoMosaic.dealPointerDown():this.model.transformControls&&this.model.transformControls.handleDragStart(),this.aimQuaternion=null},e.handleInputMove=function(e,t,n){this.isTouchEvent=n;var o=be.handelPadding(e,t,this.domElement);be.convertScreenPositionToNDC(o.x,o.y,this.mouse,this.domElement),this.mouseAtMouseDown.distanceTo(this.mouse)>He.input.moveToleranceNDC&&(this.mouseCouldBeClickToMove=!1,this.couldBeLongTap=!1,clearTimeout(this.mouseDownTimer),this.model.transformControls&&this.model.transformControls.handleDragging()),this.EditPanoMosaic&&this.EditPanoMosaic.editing&&this.EditPanoMosaic.dealPointerMove(),this.mouseLastMoveTime=Date.now(),this.reticule.move(e,t,n)},e.handleInputEnd=function(e,t,n){var o=this;if(this.isTouchEvent=n,this.mouseDown=!1,this.cameraControls.controls[Oe.PANORAMA].emit("interaction.direct"),!n&&this.couldBeLongTap)return!0;if(this.model.transformControls&&this.model.transformControls.handleDragEnd(),this.EditPanoVideo&&this.EditPanoVideo.dealPointerUp(),this.EditPanoMosaic&&this.EditPanoMosaic.dealPointerUp(),this.handleLongTap())return!0;if(this.mouseCouldBeClickToMove){if(this.flying)return this.flyToPanoClosestToMouse();//!0; 改for panoTask
if(this.linkEditor&&this.linkEditor.setPanoVisible){var i=[].concat(L(this.linkEditor.actionIcons),L(this.linkEditor.footIcons)).filter((function(e){return e.pano.floorIndex==o.model.currentFloor.floorIndex}));if(this.intersect=this.getMouseIntersect(null,i),this.intersect&&this.intersect.object.visible){var r=this.intersect.object;if("ActionIcon"!=r.type||this.linkEditor.activePano||"floor"!=r.footIcon.status)this.linkEditor.dealPanoVisible(this.intersect.object.name,this.intersect.object);else{var a=this;this.$app.WalkManager.emit("walkManager.floorPointHide",(function(){a.linkEditor.dealPanoVisible(a.intersect.object.name,a.intersect.object)}))}}return}if(this.linkEditor&&this.linkEditor.setTagVisible)return void(this.linkEditor.tagVsetting&&this.intersect&&this.intersect.object.visible&&this.linkEditor.dealTagVisible(this.linkEditor.tagVsetting,this.intersect.object.name));if(this.OverlayManager.hoveringPlane)return void this.OverlayManager.clickOverlay(this.OverlayManager.hoveringPlane);if(this.intersect&&this.EditOverlay&&this.EditOverlay.isAdding)return this.EditOverlay.addOverlay({intersect:this.intersect});var s;if(this.emit("pointerDown",{intersect:this.intersect,consume:function(){s=!0}}),s)return;if(this.cameraControls.activeControl&&this.cameraControls.activeControl.emit(bi,this.isTouchEvent?"touch":"mouse"),this.history.invalidate(),this.intersect)return this.flyToPanoClosestToMouse();if(this.mode===Oe.PANORAMA){var l=this.closestPanoInDirection(this.getMouseDirection());return l?this.flyToPano({pano:l}):this.bump(this.getMouseDirection())}}this.intersect&&this.closestPano&&this.closestPano.hoverOff(this.mode)},e.handleLongTap=function(){if(this.couldBeLongTap&&(!this.isPanoHover||this.mode!==Oe.PANORAMA))return this.cameraControls.activeControl&&this.cameraControls.activeControl.emit(Si,"touch"),!0},e.start=function(e){var t=this,n=e.mode,o=e.pano,i=e.position,r=e.quaternion,a=e.tag,s=e.quickstart,l=_e();this.updateModelDependentData(),this.updateFromControls();var c=this.is360View(n,o);return!this.model.outsideAllowed()||c||s?this.startInside(o,i,r,a,l):(this.startOutside(e,l),this.once(oi,(function(e){t.emit(ii,c,e,a),t.started=!0}))),this.compass=new zr(this),this.linkEditor=new yr(this),this.labelManager=new Ar(this),l},e.startOutside=function(e,t){var n=e.mode,o=e.pano,i=e.position,r=e.quaternion,a=e.zoom,s=e.floorVisibility,l=e.tag;this.emit(ai,He[n].transitionTime),this.isOutsideMode(n)?(this.model.warpDestFloors(s,!0),Se.cancelById(He.freeze.FlyToViewFloor),n===Oe.FLOORPLAN?this.floorplanMode(i,r,a):this.dollhouseMode(i,r),t.resolve(!1)):this.startInsideWithFlyin(o,i,r,l,t),this.beforeChangeMode(null,n)},e.startInside=function(e,t,n,o,i){i=i||_e(),this.currentPano=e;var r=e&&!e.isAligned();if(t=r?e.position:t||e.position,n=n||e.quaternion,e){var a=this.startInside.bind(this,e,t,n,o,i);if(this.checkAndWaitForPanoLoad(e,"high","low",this.basePanoSize,a))return}return this.modeTran="panorama-panorama",this.beforeChangeMode(null,Oe.PANORAMA,this.currentPano,0),this.afterChangeMode(null,Oe.PANORAMA),e.enter(),this.mode=Oe.PANORAMA,e.floor.enter(this.mode),this.emit(Ko,this.currentPano,this.currentPano),this.switchCameraMode(this.mode,n),this.emit(ri,r),i.resolve(!0),i},e.startInsideWithFlyin=function(e,t,n,o,i){if(i=i||_e(),this.dollhouseMode(),!e)return ke.warn("Player.startInsideWithFlyin() -> targetPano is invalid."),i.resolve(!1),i;t=t||e.position;var r=n||this.cameraControls.activeControl.camera.quaternion,a=e.position;return this.fitDollhouse(a,t,r),setTimeout(function(t){this.cameraControls.activeControl&&(this.cameraControls.activeControl.maxDistance=t);var o={mode:Oe.PANORAMA,pano:e,quaternion:n,callback:function(){this.emit(ti),i.resolve(!0)}.bind(this)};this.flyToNewMode(o)}.bind(this,this.cameraControls.activeControl.maxDistance),He.startupFlyinDelay),i},e.checkAndWaitForPanoLoad=(o={},r={},a={},function(e,t,n,i,s,l,c,u,h,d){if(a[e.id]=s,function(){for(var e in o)if(o.hasOwnProperty(e)&&o[e]&&performance.now()-r[e]<5e3)return!0;return!1}())return!0;var p=function(t,n,i){se.delayOneFrame(function(){o[t]=!1,a[e.id]&&a[e.id](n,i)}.bind(this))}.bind(this,e.id),f=function(e,t){se.delayOneFrame(function(){o[e]=!1,l&&l(t)}.bind(this))}.bind(this,e.id);try{return null!=u||(u=!0),e.tiled?o[e.id]=this.checkAndWaitForTiledPanoLoad(e,i,p,f,c,u,h,d):o[e.id]=this.checkAndWaitForWholePanoLoad(e,t,n,p,u),o[e.id]&&(r[e.id]=performance.now()),o[e.id]}catch(t){throw o[e.id]=!1,r[e.id]=performance.now()-5e3,t}}),e.checkAndWaitForWholePanoLoad=function(e,t,n,o,i){if(!e)throw new BasicException("Player.checkAndWaitForWholePanoLoad() -> Cannot load texture for null pano.");return i&&this.model.waitForLoad(e,(function(){return e.isLoaded(n)})),!e.isLoaded(t)&&(e.loadCube(t).done(o),!0)},e.checkAndWaitForTiledPanoLoad=(s=new THREE.Vector3,function(e,t,n,o,i,r,a,l){if(!e)throw new BasicException("Player.checkAndWaitForTiledPanoLoad() -> Cannot load texture for null pano.");if(s.copy(Fe.FORWARD),this.getDirection(s),!e.isLoaded(t))return r&&this.model.waitForLoad(e,(function(){return e.isLoaded(t)})),e.loadTiledPano(t,s,null,a,l).done(function(e,t){n&&n(e,t)}.bind(this)).fail(function(e){o&&o(e)}.bind(this)).progress(function(e,t,n){i&&i(e,t,n)}.bind(this)),!0}),e.switchCameraMode=function(e,t,n,o,i){var r,a=this.cameraControls.controls[e],s=a.camera;e==Oe.PANORAMA?(s.position.copy(this.currentPano.position),r=t?Fe.FORWARD.clone().applyQuaternion(t):this.getDirection().setY(0).normalize(),a.lookAt(r.add(s.position))):(n&&a.target.copy(n),o&&s.position.copy(o),e==Oe.DOLLHOUSE?(n||a.target.copy(this.target.clone().setY(this.model.center.y)),o||(o=this.position.clone(),this.mode===Oe.PANORAMA?o.add(new THREE.Vector3(0,6,0)).add(this.getDirection().multiplyScalar(-10)):o.add(Fe.DOWN.clone().applyQuaternion(this.quaternion).multiplyScalar(6)).setY(6),s.position.copy(o))):e==Oe.FLOORPLAN&&(n||a.target.copy(this.model.center).setY(0),o||(s.position.copy(this.model.center).setY(He.floorplan.cameraHeight),a.rotateToView(this.model.size,this.getDirection())),i?a.currentScale=a.absoluteScale=i:a.zoomToContain(this.model.size)));a.update(0)},e.update=function(){var e={};return function(t){var n=this;if(this.updatePersistentZooming(t),this.updateFromControls(t),this.hasChanged(e)&&(this.lastChangeTime=Date.now(),!this.mouseDown&&this.containsMouse&&this.updateIntersect(),this.emit(si)),this.OverlayManager&&this.OverlayManager.group.children.forEach((function(e){if(e.box){var t=new THREE.Vector3(0,0,1).applyQuaternion(e.quaternion),o=t.clone().multiplyScalar(e.depth).add(e.position);e.box.visible=t.dot(o.sub(n.camera.position))<0}})),this.linkEditor&&(this.linkEditor.setTagVisible||this.linkEditor.setPanoVisible)&&this.linkEditor.updateFootIconSize(),this.compass&&this.compass.update(this.quaternion),this.dollLabels.concat(this.planLabels).concat(this.doorLabels).forEach((function(e){e.update()})),this.updateLabelZIndex(["dollLabels","doorLabels"]),Cr.updateCameraDir(this),"panorama"==this.mode&&this.measureRulers.forEach((function(e){e.update()})),e.cameraChanged2&&this.model.floorLogos.updateFloorlogo(this.camera&&this.camera.quaternion,this),this.model.supportsTiles){var o=this.panosTaskList.length>1?this.panosTaskList.map((function(e){return e.pano})):[];this.updateTileDownloader(o),this.updatePanoRenderer()}this.reticule.update(),this.cachedPanoCandidates&&He.navigation.panoScores&&this.model.panos.showPanoScores(this.cachedPanoCandidates),this.updateControlLocks(),this.model.supportsTiles&&this.updateZoomPano(),this.emit("update",{x:this.position.x,y:this.position.z,lon:this.cameraControls.controls.panorama.lon,hasChanged:e,mode:this.mode})}}(),e.updateLabelZIndex=function(e){var t=this;e.forEach((function(e){"dollLabels"==e&&"dollhouse"!=t.mode||"doorLabels"==e&&"panorama"!=t.mode||t[e].sort((function(e,t){return t.pos2d.z-e.pos2d.z})).forEach((function(e,t){e.elem.style.zIndex=t}))}))},e.updatePersistentZooming=function(e){1===this.zooming?this.zoomBy(1+this.zoomSpeed*e):-1===this.zooming&&this.zoomBy(1-this.zoomSpeed*e)},e.updateControlLocks=function(){this.currentPano&&this.model.supportsTiles&&(this.cameraControls.controls[Oe.PANORAMA].locked=He.vrEnabled||!this.currentPano.highestFullTileRenderOpCompleted&&this.currentPano.lockUntilRenderingComplete)},e.updatePanoRenderer=function(){var e=new THREE.Vector3;return function(t){var n=this.nextPano||this.currentPano;this.$app.core.get("PanoRenderer").hasQueuedTiles()&&n&&(e.copy(Fe.FORWARD),this.getDirection(e),this.$app.core.get("PanoRenderer").updateDirection(e))}}(),e.updatePreRendering=function(){var e={};return function(t){if(1===He.tiling.preRenderTourPanos&&this.preRenderingEnabled){var n=this.nextPano||this.currentPano;if(n&&t&&t.length>1){var o=t.findIndex((function(e){if(e.id===n.id)return!0}));if(o>=0&&o+1<t.length){var i=t[o+1];i.isLoaded(this.basePanoSize)||e[i.id]||(window.setTimeout(function(t){this.checkAndWaitForPanoLoad(t,"high","low",this.basePanoSize,null,null,null,!1,!1,!1),window.setTimeout(function(t){e[t.id]=!1}.bind(this,t),He.tiling.panoPreRenderRepeatDelay)}.bind(this,i),He.tiling.panoPreRenderDelay),e[i.id]=!0)}}}}}(),e.enablePreRendering=function(){this.preRenderingEnabled=!0},e.updateTileDownloader=function(){var e=new THREE.Vector3;return function(t){var n=this.nextPano||this.currentPano;n&&(e.copy(Fe.FORWARD),this.getDirection(e),this.$app.core.get("TileDownloader").tilePrioritizer.updateCriteria(n,this.position,e,t.length>0?t:null),this.$app.core.get("TileDownloader").processPriorityQueue=!0)}}(),e.updateFromControls=function(e){null!=e||(e=0),this.cameraControls.activeControl&&(this.cameraControls.activeControl.update(e),this.quaternion.copy(this.cameraControls.activeControl.camera.quaternion),this.position.copy(this.cameraControls.activeControl.camera.position),this.target.copy(this.cameraControls.activeControl.target),this.cameraControls.activeControl.camera.updateProjectionMatrix(),this.camera.projectionMatrix.copy(this.cameraControls.activeControl.camera.projectionMatrix),this.emit("updateFromControls",this,e)),this.camera.position.copy(this.position),this.camera.quaternion.copy(this.quaternion),this.camera.updateMatrix(),this.camera.updateMatrixWorld()},e.updateIntersect=function(){var e=this.flying,t=this.isOutsideMode()&&this.cameraControls.controls[this.mode].isEngaged(),n=Se.getById(He.freeze.LookTransition);if(e||t||this.isTouchEvent||n.length&&n[0].running,this.linkEditor&&(this.linkEditor.setPanoVisible||this.linkEditor.setTagVisible))return this.intersect=this.getMouseIntersect(null,this.linkEditor.footIcons),void(this.intersect&&this.intersect.object.visible?tr.add("hoverFootMarker"):tr.remove("hoverFootMarker"));if(this.OverlayManager){if(this.intersect=this.getMouseIntersect(null,this.OverlayManager.group.children.filter((function(e){return e.visible})).map((function(e){return e.plane})).concat(this.model.colliders).concat([this.model.skybox])),this.intersect&&(this.intersect.object.overlayType||this.intersect.object.parent.overlayType))return this.OverlayManager.hoverOverlay(this.intersect.object);this.OverlayManager.hoverOverlay(null)}else this.intersect=this.getMouseIntersect(null,null);this.intersect&&this.updateClosestPano(this.intersect),this.closestPano||this.closestPanoInDirection(this.getMouseDirection())?(this.reticule.updatePosition(this.position,this.intersect),He.navigation.panoScores&&!He.navigation.mouseDirection&&this.closestPanoInDirection(this.getDirection())):this.reticule.hide()},e.getMouseDirection=function(e){e=e||this.mouse;var t=new THREE.Vector3(e.x,e.y,-1).unproject(this.camera);return new THREE.Vector3(e.x,e.y,1).unproject(this.camera).sub(t).normalize()},e.getMouseIntersect=function(e,t,n){e=e||this.mouse.clone(),t||(t=this.model.floors.reduce((function(e,t){return t.hidden?e:e.concat(t.collider.children)}),this.mode===Oe.PANORAMA?this.panoMarkers:[]),this.mode===Oe.PANORAMA&&t.push(this.model.skybox));var o=new THREE.Vector3(e.x,e.y,-1).unproject(this.camera);this.raycaster.set(o,this.getMouseDirection(e));var i=this.raycaster.intersectObjects(t);if(0===i.length)return null;if("getAll"==n)return i;var r=i[0];r.face&&(r.normal=r.face.normal.applyQuaternion(r.object.quaternion),this.position.clone().sub(r.point).dot(r.normal)<0&&r.normal.negate(),this.currentPano?r.onFloor=r.point.y<this.position.y-.5*this.currentPano.height:r.onFloor=r.point.y<this.position.y-.5,r.horizontal=r.normal.y>.8);return r},e.updateClosestPano=function(e){var t=this;if(this.mode!==Oe.TRANSITIONING){var n=[];if(this.mode===Oe.PANORAMA){if(!this.currentPano)return;n.push(ro.filters.not(this.currentPano)),n.push(ro.filters.inFloorDirection(this.currentPano.floorPosition,this.getDirection(),.25)),n.push(ro.filters.isNeighbourPanoTo(this.currentPano)),n.push(ro.filters.isCloseEnoughTo(e.point,He.panoFloorClickRadius)),n.push(ro.filters.isNotBehindNormal(e.point,e.normal))}else n.push((function(e){return t.linkEditor.checkHasNeighbor(e)||e==t.$app.core.get("Scene").firstView.pano})),n.push(ro.filters.isOnVisibleFloor()),this.mode!==Oe.FLOORPLAN&&n.push(ro.filters.inDirection(this.position,this.getDirection(),.25));var o=this.model.panos.find(n,[ro.sortFunctions.floorDistanceToPoint(e.point)]);o!==this.closestPano?(o&&(this.isPanoHover=!0),this.emit(ei,this.closestPano,o,this.mode),this.closestPano=o):this.isPanoHover=!1}},e.dollhouseMode=function(e,t){this.modeTran="dollhouse-panorama",this.emit(Jo,this.mode,Oe.DOLLHOUSE),this.mode=Oe.DOLLHOUSE,this.cameraControls.controls[Oe.DOLLHOUSE].reset();var n=new THREE.Vector3(this.model.center.x,0,this.model.center.z),o=new THREE.Vector3(15,10,15);if(e&&t){var i=Fe.FORWARD.clone().applyQuaternion(t),r=(e=this.model.center.clone().sub(e)).dot(i);r>0?n=i.clone().multiplyScalar(r).add(e):ke.warn("Tried to initiate dollhouse mode that wasn'quaternion looking at the model",e,t)}this.cameraControls.controls[Oe.DOLLHOUSE].resetRanges(0,!0),this.cameraControls.controls[Oe.DOLLHOUSE].target.copy(n),this.cameraControls.cameras[Oe.DOLLHOUSE].position.copy(o),this.updateFromControls(),this.model.alpha=1,this.model.skybox.material.uniforms.opacity.value=0},e.insideMode=function(e,t){var n=_e(),o=t||null;if(this.mode!==Oe.PANORAMA&&this.mode!==Oe.TRANSITIONING){var i=[];this.model.currentFloor&&i.push(ro.filters.atFloor(this.model.currentFloor)),e=e||this.currentPano||this.model.panos.find(i,[ro.sortFunctions.distanceToPoint(this.cameraControls.activeControl.target)]),this.flyToNewMode({mode:Oe.PANORAMA,pano:e,callback:o}).done(n.resolve.bind(n)).fail(n.reject.bind(n))}else{var r="Cannot change mode during mode transition";this.mode===Oe.PANORAMA&&(r="Already in panorama mode"),n.reject(r)}return n.promise()},e.fitDollhouse=function(e,t,n){var o=this.model.boundingBox.max.y,i=Fe.FORWARD.clone().applyQuaternion(n);n=i.clone().add(e),this.cameraControls.activeControl.target.copy(n),this.cameraControls.activeControl.camera.position.set(0,2.4*o,0).add(e).add(i.multiplyScalar(-10))},e.floorplanMode=function(e,t,n){this.mode=Oe.FLOORPLAN;var o=this.cameraControls.controls[Oe.FLOORPLAN];o.reset();var i=e||this.model.center;if(o.target.copy(i).setY(0),o.camera.position.copy(i).setY(He.floorplan.cameraHeight),n?(o.currentScale=n/(window.innerWidth/window.innerHeight),o.absoluteScale=o.currentScale):o.zoomToContain(this.model.size),t){var r=Fe.LEFT.clone().applyQuaternion(t);o.rotateLeft(-Math.atan2(r.x,r.z))}else o.rotateToView(this.model.size,this.getDirection());o.update(0)},e.getAimToNextPano=function(e,t,n){var o,i={importance:0,aim:null};if(this.emit("ifFocusPoint",i),i.aim&&(i.importance>=3||!t)&&(t=i.aim),!t)if(e.panoVideo)o=!0,t=e.position.clone().add(e.panoVideo.dir);else if(o=!t&&e.hasVideo&&this.$app.core.get("PanoVideoRenderer")&&this.$app.core.get("PanoVideoRenderer").ifEnable())if(e.videoInfo.dir)t=e.position.clone().add(e.videoInfo.dir);else{var r=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(this.model.supportsTiles?90:180));t=Fe.FORWARD.clone().applyQuaternion(r.multiply(e.quaternion)).add(e.position)}return{aimQua:n=t?Pe.getQuaByAim(t,e.position):n,hasVideo:o}},e.flyToPano=function(e,t){var n=this;if(!this.locked){var o=e.pano,i=e.lookAtPoint,r=e.quaternion,a=e.duration,s=e.aimDuration,l=e.maxDistanceOverride;e.skipWarpingCheck;var c=e.constantMoveSpeed,u=null,h=null,d=e.zoomLevel||(He.zoom.zoomToDefaultWhenToPano?1:this.zoomLevel),p=e.cancelLookFun;if(!(this.unableChangePano||this.EditPanoMosaic&&this.EditPanoMosaic.editVideo&&this.EditPanoMosaic.editVideo.pano!=o)){var f=this.getAimToNextPano(o,i,r);r=f.aimQua;if(f.hasVideo,this.mode===Oe.PANORAMA){var m=this.is360View(this.mode,o)||this.is360View(this.mode,this.currentPano);if(this.judgePanoTask(e,m)&&(o&&(u=se.deepExtend(e),h=function(){se.delayOneFrame(function(){u.retry=!0,this.flyToPano(u,t)}.bind(this))}.bind(this)),!o||!this.checkAndWaitForPanoLoad(o,"high","low",this.basePanoSize,h))){var v=e.finalCallback=function(e){t&&t(e),this.nextPanoTask()}.bind(this);this.currentPano||(this.currentPano=o);var g=a;if("number"!=typeof a){var y=l||He.transition.flytimeMaxDistanceThreshold,w=Math.min(this.currentPano.position.distanceTo(o.position),y);g=e.flySpeed&&c?w/e.flySpeed:w*He.transition.flytimeDistanceMultiplier+He.transition.flyTime}if(e.duration=g,console.log("flytopano",e.pano.id,"duration",g),this.zoomLevel!==d)switch(He.zoom.transitionStyle){case 1:this.smoothZoomLevelTo(d,g/2);break;case 2:return u=se.deepExtend(e),h=this.flyToPano.bind(this,u,t),void this.smoothZoomLevelTo(d,He.zoom.restoreTime*(this.zoomLevel-d),h)}if(r&&!m){var b=this.cameraControls.activeControl.camera.quaternion.clone(),E=b.clone(),x=new THREE.Vector3;if(Se.cancelById(He.freeze.LookTransition),g*=He.transition.aimSlowFactor,o===this.currentPano){var T=Fe.FORWARD.clone().applyQuaternion(b),P=Fe.FORWARD.clone().applyQuaternion(r),k=T.angleTo(P);return this.flyRotate=!0,null!=s||(s=1*Math.sqrt(k)/He.tags.navigate.rotateSpeedFactor*1e3),void Se.start(function(e){if(this.mode!=Oe.PANORAMA)return Se.cancelById(He.freeze.LookTransition),void v();E.copy(b),nt.quaternion(E,r)(e),x.copy(Pe.getAimByQua(E,this.cameraControls.activeControl.camera.position)),this.cameraControls.activeControl.lookAt(x)}.bind(this),s,v,0,Ie[He.transition.movementEasing],null,He.freeze.LookTransition,p)}}if(o===this.currentPano||this.flying)return void v();this.flying=!0,this.position.clone();var M=this.currentPano;this.nextPano=o,ke.debug("Flying to pano ",o.position),this.emit(Ko,this.currentPano,o),this.emit(ni,{panoId:o.id,lastPanoId:M.id,type:"flyToPano"}),this.model.currentFloor=o.floor,this.doorLabels.forEach((function(e){return e.updateVisible(o)})),this.model.floorLogos.changefloorLogoOpa({index:0,opa:0,dur:g,delay:.7}),this.model.floorLogos.secondLogo.position.copy(o.floorPosition.clone().sub(this.model.position)),this.model.floorLogos.secondLogo.visible=!0,this.model.floorLogos.changefloorLogoOpa({index:1,opa:1,dur:250}),r&&!m&&(this.flyingWithRot=!0,Se.start((function(e){if(n.mode!=Oe.PANORAMA)return Se.cancelById(He.freeze.LookTransition),void v();E.copy(b),nt.quaternion(E,r)(e),x.copy(Pe.getAimByQua(E,n.cameraControls.activeControl.camera.position)),n.cameraControls.activeControl.lookAt(x)}),g,null,0,Ie[He.transition.movementEasing],null,He.freeze.LookTransition,p)),e.chunkProgress=this.adjustTransition(o),this.startTransition(e)}}else this.flyToNewMode({mode:Oe.PANORAMA,pano:o,duration:a,quaternion:r,callback:t})}}},e.startTransition=function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=e.constantMoveSpeed?null:e.easeOut?Ie.easeOutQuad:Ie[He.transition.movementEasing];Se.cancelById(He.freeze.FlyToPano,!0);var i=this.currentPano.position.distanceTo(e.pano.position);Se.start((function(o,r){var a=Se.getById(He.freeze.FlyToPano)[0],s=n+o*(1-n),l=e.currentSpeed=(s-e.progress)*i/r;if(o>0&&o<1&&r){var c=function(e,t){var n=.06;Math.abs(e-1)>n&&(e=e>1?1.06:.94),Se.adjustSpeed(He.freeze.FlyToPano,e)};if(e.constantMoveSpeed)l>0&&!be.closeTo(l,e.flySpeed)&&e.flySpeed&&(e.flySpeed,c(e.flySpeed/l));else if(e.easeOut){s>.05&&s<.8&&a.duration>1500&&c(1+.05*s)}}s>.5&&t.panosTaskList.length>1&&t.checkAndWaitForPanoLoad(t.panosTaskList[1].pano,"high","low",t.basePanoSize,(function(){})),t.model.skybox.material.uniforms.progress.value=s;var u=t.currentPano.position.clone(),h=e.pano.position.clone();nt.vector(u,h)(s),t.cameraControls.cameras[Oe.PANORAMA].position.copy(u),e.progress=s,e.chunkProgress&&t.model.chunks.forEach((function(e){return e.material.uniforms.progress.value=s}))}),e.duration,this.afterFlyToPano.bind(this,e),0,o,"chunkFly",He.freeze.FlyToPano),e.flyCount++},e.nextPanoTask=function(){this.panosTaskList.splice(0,1),this.panosTaskList.length&&(this.panosTaskList[0].dealingTask=!0,this.flyToPano(this.panosTaskList[0]))},e.judgePanoTask=function(e,t){e.progress=e.progress||0,e.flyCount=0;var n=this.panosTaskList.length;if(!e.retry&&!e.dealingTask){if((e.lookAtPoint||t)&&n>1)return console.log("正在执行panosTaskList任务");var o=this.panosTaskList[0];o&&o.lookAtPoint&&(e.canConstantlyWalk=!1);var i=e.canConstantlyWalk;if(0==n||i){if(n>0){if(this.panosTaskList.some((function(t){return t.pano==e.pano})))return;if(n>2)return;if(!o.constantMoveSpeed&&0==o.flyCount)return void console.log("currentTask.flyCount == 0,稍后再添加")}this.panosTaskList.push(e),n++}if(n>1){var r=this.panosTaskList[n-2],a=e.pano.position.distanceTo(r.pano.position);if(e.easeOut=!0,e.duration=2*a/He.transition.flySpeed,!o.constantMoveSpeed){var s=this.currentPano.position.distanceTo(o.pano.position),l=(1-o.progress)*s/(o.currentSpeed||He.transition.flySpeed);o.constantMoveSpeed=!0,o.flySpeed=He.transition.flySpeed,o.duration=l,this.startTransition(o,o.progress)}return void(r.constantMoveSpeed||(r.constantMoveSpeed=!0,r.flySpeed=He.transition.flySpeed,r.easeFun=null,r.duration=null))}}return!0},e.adjustTransition=function(e){if(this.currentPano.noBlocks.includes(e.id));else if(this.currentPano.blocks[e.id])this.hideWalls=this.currentPano.blocks[e.id],this.hideWalls.forEach((function(e){e.visible=!1}));else{var t=this.currentPano.origin.clone(),n=e.origin.clone(),o=n.clone().sub(t).normalize().multiplyScalar(.1),i=t.clone().sub(o),r=n.clone().add(o),a=Pe.ifIntersectChunks(i,r,this.model,{throughWidth:.08,meshes:this.model.chunks});a?(this.hideWalls=a.map((function(e){return e.object.visible=!1,e.object})),this.currentPano.blocks[e.id]=this.hideWalls.slice(0)):this.currentPano.noBlocks.push(e.id)}return!0},e.afterFlyToPano=function(e){this.currentPano.isAligned()&&(this.lastPano=this.currentPano),this.currentPano!==e.pano&&(this.currentPano.exit(),e.pano.enter(),this.currentPano=e.pano,this.nextPano=null,this.path.placeCpm(),this.mode==Oe.PANORAMA&&this.path.fadeOutCpm(He.path.fadeOutTime)),this.emit(oi,{targetPosition:e.pano.position,currentPosition:e.pano.position,targetPano:e.pano,currentPano:this.currentPano}),this.mode==Oe.PANORAMA&&(this.flying=!1,this.model.floorLogos.firstLogo.position.copy(this.model.floorLogos.secondLogo.position),this.model.floorLogos.changefloorLogoOpa({index:0,opa:1,dur:0}),this.model.floorLogos.secondLogo.visible=!1),this.model.chunks.forEach((function(e){e.material.uniforms.progress&&(e.material.uniforms.progress.value=1),e.visible=!0})),this.model.fadePanoMarkers(),this.doorLabels.forEach((function(e){return e.updateVisible()})),e.finalCallback()},e.fastToPano=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.flying&&!this.isWarping()){var n=t.pano||this.model.panos.index[t.panoId];if(!n)return console.error("fastToPano pano 无");this.position.clone();var o=this.currentPano,i=t.duration||1500;this.path.warpDestPano=n;var r=function(){e.waitingToWarp=!1,e.fastToPano(t)};this.checkAndWaitForPanoLoad(n,"high","low",this.basePanoSize,r)?this.waitingToWarp=!0:(this.emit("pano.chosen",o,n),this.emit(ni,{panoId:n.id,lastPanoId:o.id,type:"flyToPano"}),this.flying=!0,this.nextPano=n,this.path.warpDestHeroLoc={panoId:t.panoId,position:n.position,quaternion:t.quaternion||this.quaternion.clone()},this.path.warpTravel_BLACK(null,i,1,(function(){e.afterFlyToPano({position:n.position,pano:n,finalCallback:t.callback})})))}},e.flyToPanoClosestToMouse=function(){if(Date.now()-this.mouseLastMoveTime>50&&(this.intersect=this.getMouseIntersect(),this.intersect&&this.updateClosestPano(this.intersect)),this.closestPano)return this.flyToPano({pano:this.closestPano});var e=this.getMouseDirection();this.flyDirection(e)||this.flyToPano({pano:this.currentPano})},e.flyLocalDirection=function(e){if(!(this.panosTaskList.length>1||1==this.panosTaskList.length&&this.panosTaskList[0].progress<.6)){var t=this.getDirection(e),n=1===e.z?.4:.75,o=1===Math.abs(e.x);return this.flyDirection(t,n,o)}},e.flyDirection=function(e,t,n){var o=_e();this.history.invalidate();var i=this.closestPanoInDirection(e,t,n);return i?this.flyToPano({pano:i,canConstantlyWalk:this.canConstantlyWalk},o.resolve.bind(o,!0)):0==this.panosTaskList.length&&(this.bump(e),o.resolve(!1)),o.promise()},e.closestPanoInDirection=function(e,t,n){return this.rankedPanoInDirection(0,e,t,n)},e.rankedPanoInDirection=(l={pano:null,candidates:[]},function(e,t,n,o){e||(e=0),n=void 0!==n?n:.75;var i=o?"angle":"direction",r=this.panosTaskList.length?this.panosTaskList[this.panosTaskList.length-1].pano:this.currentPano,a=[ro.filters.isPanoAligned(),ro.filters.inPanoDirection(r.position,t,n),ro.filters.isNeighbourPanoTo(r),ro.filters.not(r)],s=[ro.scoreFunctions.distanceSquared(r),ro.scoreFunctions[i](r.position,t)];return this.model.panos.findRankedByScore(e,a,s,l),this.cachedPanoCandidates=l.candidates,l.pano}),e.bump=function(e){var t=this;if(this.mode===Oe.PANORAMA&&!this.flying&&!this.isWarping()){var n,o,i,r=He.transition,a=(r.flytimeMaxDistanceThreshold*r.flytimeDistanceMultiplier+r.flyTime)/10,s=this.camera.getWorldDirection().dot(e);if(Math.abs(s)>.5)n=function(){Se.start(nt.property(this.cameraControls.cameras[Oe.PANORAMA],"zoom",s>0?1.04:.96),a,o,0,Ie.easeInOutSine,"bumpZStart")}.bind(this),o=function(){Se.start(nt.property(this.cameraControls.cameras[Oe.PANORAMA],"zoom",1),3*a,i,0,Ie.easeInOutSine,"bumpZRelax")}.bind(this);else{var l=this.camera.position.clone(),c=e.clone();this.raycaster.set(l,c);var u=this.model.floors.reduce((function(e,t){return e.concat(t.collider.children)}),[]),h=this.raycaster.intersectObjects(u),d=h.length>0?h[0].distance/25:.04,p=l.clone().add(c.multiplyScalar(d));n=function(){Se.start(nt.vector(this.cameraControls.cameras[Oe.PANORAMA].position,p),a,o,0,Ie.easeInOutSine,"bumpTStart")}.bind(this),o=function(){Se.start(nt.vector(this.cameraControls.cameras[Oe.PANORAMA].position,l),5*a,i,0,Ie.easeInOutSine,"bumpTRelax")}.bind(this)}i=function(){"panorama"==t.mode&&(t.flying=!1,t.emit(oi,{targetPano:t.currentPano,currentPano:t.currentPano}))},this.flying=!0,n()}},e.changeFloor=function(e){if(!this.is360View(this.mode,this.currentPano))if(this.mode===Oe.PANORAMA){var t=this.history.reversePano(e);t?this.flyToPano({pano:t}):this.changeFloorByScore(e)}else this.model.setFloor(this.model.nextFloor(e)||this.model.currentFloor)},e.changeFloorByScore=function(){var e={pano:null,candidates:[]};return function(t){var n=this.model.nextFloor(t);return n?(this.model.panos.lowestByScore([ro.filters.atFloor(n),ro.filters.isPanoAligned()],[ro.scoreFunctions.distance(this.currentPano),ro.scoreFunctions.direction(this.position,new THREE.Vector3(0,t,0)),ro.scoreFunctions.penalizeHeightDifferenceUnder(this.position,.5)],e),void(e.pano?(this.cachedPanoCandidates=e.candidates,this.history.push(t,this.currentPano),this.flyToPano({pano:e.pano})):ke.warn("No pano found on selected floor, not moving there."))):void ke.debug("player.changeFloor("+t+"): no such floor")}}(),e.gotoFloor=function(e){var t=e-this.model.currentFloor.floorIndex;this.changeFloor(t)},e.getDirection=function(e){return(e=e||(new THREE.Vector3).copy(Fe.FORWARD)).applyQuaternion(this.camera.quaternion)},e.flyToNewMode=function(e,t){var n=(e=e||{}).mode,o=e.pano,i=e.duration;e.warpDest;var r=e.callback;e.force;var a=e.quaternion,s=e.target,l=e.position,c=e.currentScale;if(t=t||_e(),this.isWarping())return ke.warn("Player.flyToNewMode() -> Cannot fly when warping"),r&&r(!1),t.reject("Cannot change mode during tour transition");if(this.mode===Oe.TRANSITIONING)return r&&r(!1),t.reject("Cannot change mode during mode transition");if(n===this.mode)return r&&r(!1),t.resolve(),t;ke.debug("Switching mode to "+n);var u=function(){se.delayOneFrame(function(){this.flyToNewMode(e,t)}.bind(this))}.bind(this);if(o&&this.checkAndWaitForPanoLoad(o,"low","low",this.basePanoSize,u))return t.promise();if(!this.model.meshTexturesLoaded&&this.isOutsideMode(n))return ke.info("Waiting for model textures to be loaded before going out to dollhouse"),this.model.waitForLoad(this.model,function(){return this.model.meshTexturesLoaded}.bind(this)),this.model.loadMeshTextures().done(u),u(),t.promise();this.history.invalidate();var h=this.mode,d=this.cameraControls.cameras[n],p=se.deepExtend({},He[n],He[h+"-"+n]);this.modeTran=this.mode+"-"+n;var f=p.transitionTime;void 0!==i&&(f=i),this.emit(Jo,h,n,o),o&&(this.currentPano=o),this.switchCameraMode(n,a,s,l,c),Se.cancelById(He.freeze.LookTransition);var m=(new THREE.Vector3).copy(this.position);n===Oe.PANORAMA?(this.emit(Ko,o,o),setTimeout(function(){o.floor.enter(n)}.bind(this),f/2),this.path.fadeOutCpm(He.path.fadeOutTime)):(this.path.placeCpm(),this.path.fadeInCpm(He.path.fadeInTime),n===Oe.FLOORPLAN&&this.model.currentFloor.enter(n));var v=this.currentPano,g=this.position.clone();return this.emit(ni,{mode:e.mode,duration:e.duration,target:e.target,position:e.position,quaternion:e.quaternion?(new THREE.Quaternion).set(e.quaternion._x,e.quaternion._y,e.quaternion._z,e.quaternion._w):null,zoom:e.zoom,panoId:e.pano?e.pano.id:null,lastPanoId:v&&v.id,type:"flyToNewMode"}),this.flying=!0,this.isOutsideMode(n)&&this.is360View(h,v)?(n==Oe.DOLLHOUSE&&(d.position.set(15,10,15),d.controls.target.set(this.model.center.x,0,this.model.center.z),d.controls.update()),p.blackoutStyle=BlackoutStyle.FADEIN,f=He.show360Views.transitionTime):this.isOutsideMode(h)&&this.is360View(n,o)?(this.mode=n,p.blackoutStyle=BlackoutStyle.END,f=He.show360Views.transitionTime):(Se.start(nt.property(this.model,"alpha",p.modelAlpha,null),f*p.modelAlphaLength,null,p.modelAlphaDelay,null,He.freeze.FlyToNewMode),Se.start(nt.vector(this.position,d.position),f,null,He.flydown.movementDelay,Ie[He.flydown.movementEasing],null,He.freeze.FlyToNewMode),Se.start(nt.quaternion(this.quaternion,d.quaternion),f*p.rotationDuration,null,p.rotationDelay,Ie[He.flydown.rotationEasing],null,He.freeze.FlyToNewMode),Se.start(nt.matrix4(this.camera.projectionMatrix,d.projectionMatrix),f*p.cameraMatrixDuration,null,p.cameraMatrixDelay,p.cameraMatrixEase,null,He.freeze.FlyToNewMode),Se.start(nt.uniform(this.model.skybox,"opacity",p.skyboxOpacity),f*p.skyboxOpacityLength,null,p.skyboxOpacityDelay,null,He.freeze.FlyToNewMode),Se.start(nt.property(this.reticule.material.uniforms.opacity,"value",0),f,null,He.freeze.FlyToNewMode)),Se.setTimeout(function(){this.flying=!1,h===Oe.PANORAMA&&n!==Oe.PANORAMA?this.currentPano.exit():h!==Oe.PANORAMA&&n===Oe.PANORAMA&&(this.currentPano!==v&&v.exit(),this.currentPano.enter()),h===Oe.DOLLHOUSE&&this.cameraControls.controls[Oe.DOLLHOUSE].resetRanges(),this.mode=n,this.afterChangeMode(h,n),this.emit(oi,{targetPosition:m,currentPosition:g,targetPano:this.currentPano,currentPano:v}),r&&r(),t.resolve()}.bind(this),f,He.freeze.FlyToNewMode),this.mode=Oe.TRANSITIONING,this.beforeChangeMode(h,n,o,f),t.promise()},e.setSize=function(e,t){var n=e/t;this.baseFov=zi.clampVFOV(He.insideFOV,He.insideFOVMax,e,t);var o=zi.getHFOVFromVFOV(He.insideFOV,e,t);for(var i in o>He.insideFOVMax?this.baseFov=zi.getVFOVFromHFOV(He.insideFOVMax,e,t):this.baseFov=He.insideFOV,this.cameraControls.cameras){var r=this.cameraControls.cameras[i];r.fov=r.staticFov?r.staticFov:this.baseFov*(1/this.zoomLevel),r.updateAspect(n)}},e.toJSON=function(){var e={};return this.cameraControls.activeControl?((e=this.cameraControls.activeControl.toJSON()).camera_mode=Oe.toInt(this.mode),this.isOutsideMode()?this.model.allFloorsVisible?e.floor_visibility=[]:e.floor_visibility=this.model.floors.list.map((function(e){return e.hidden?0:1})):Oe.PANORAMA&&(e.scan_id=this.currentPano.id),e):e},e.zoomBy=function(e){this.zoomTo(this.zoomLevel*e)},e.zoomIn=function(){this.zoomBy(1+this.zoomSpeed)},e.zoomOut=function(){this.zoomBy(1-this.zoomSpeed)},e.zoomTo=function(e,t){if((t||He.zoom.enabled&&this.mode===Oe.PANORAMA&&this.zoomEnabled)&&(e<He.zoom.min&&(e=He.zoom.min),e>He.zoom.max&&(e=He.zoom.max),e>this.zoomLevel?(this.emit(Zi),e===He.zoom.max&&this.emit(Gi)):e<this.zoomLevel&&(this.emit(Qi),e===He.zoom.min&&this.emit(qi)),this.cameraControls.activeControl)){var n=this.cameraControls.activeControl.camera;this.zoomLevel=e,n.fov=this.baseFov*(1/this.zoomLevel),n.updateProjectionMatrix(),this.zoomFov=n.fov,this.emit("zoomTo",e)}},e.zoomDefault=function(){this.zoomTo(1,!0)},e.smoothZoomToDefault=function(e,t){var n,o=this.zoomLevel,i=function(e){e>1&&(e=1),n=o*(1-e)+e,this.zoomTo(n,!0)}.bind(this),r=function(){this.zoomDefault(),t&&window.setTimeout(t,50)}.bind(this);Se.start(i,e,r,null,0,Ie[He.transition.blendEasing])},e.smoothZoomFovTo=function(e,t,n){var o=this.baseFov/e;this.smoothZoomLevelTo(o,t,n)},e.smoothZoomLevelTo=function(e,t,n){if(this.zoomLevel!=e){var o,i=this.zoomLevel,r=function(t){t>1&&(t=1),o=i*(1-t)+t*e,this.zoomTo(o,!0)}.bind(this);Se.start(r,t,n,null,0,Ie[He.transition.blendEasing])}},e.updateZoomPano=function(){var e=this.$app.core.get("QualityManager"),t=this.$app.core.get("PanoRenderer");if(!t.zoomPanoRenderingDisabled&&this.mode===Oe.PANORAMA){var n=this.currentPano;if(n){var o="2k"==e.navTileClass&&"4k"==e.tileClass?1.7:He.zoom.activationThreshold,i=He.highestQualityTile||this.zoomLevel>o,r=!(this.flying&&this.nextPano&&this.nextPano!==this.currentPano)&&!this.isWarping(),a=i&&r;this.$app.core.get("TileDownloader").tilePrioritizer.setZoomingActive(a),t.setZoomingActive(a,n,!0);var s=function(n,o){t.resetRenderStatus(n.id,!1,!0,e.getMaxNavPanoSize()),t.clearAllQueuedUploadsForPano(n.id),t.renderPanoTiles(n.id,null,!1,!1),n.setZoomed(o)}.bind(this);if(a&&(!n.zoomed||e.zoomLevelResolution&&"4k"!=e.zoomLevelResolution)?(n.zoomed||s(n,!0),"1k"==e.navTileClass&&"1k"!=e.tileClass&&this.zoomLevel<2?t.enableHighQuality(function(){"4k"!=e.tileClass&&s(n,!0)}.bind(this)):t.enableUltraHighQualityMode(function(){e.useUltraHighResolutionPanos&&!He.zoom.overridemax&&(He.zoom.max=He.ultraHighQualityMaxZoom),s(n,!0)}.bind(this))):!i&&n.zoomed&&s(n,!1),a&&"1k"==e.navTileClass&&"4k"==e.tileClass){var l=function(n){e.updateMaximums(),t.setupZoomRenderTarget()};e.zoomLevelResolution=this.zoomLevel>=2?"4k":this.zoomLevel>1.1?"2k":"1k",this.oldZoomLevel<2&&this.zoomLevel>=2?(l(),s(n,i)):this.oldZoomLevel<=He.zoom.activationThreshold&&this.zoomLevel>He.zoom.activationThreshold?l():this.oldZoomLevel>2&&this.zoomLevel<=2?(l(),s(n,i)):this.oldZoomLevel>He.zoom.activationThreshold&&this.zoomLevel<=He.zoom.activationThreshold&&l(),this.oldZoomLevel=this.zoomLevel}}}},e.hasChanged=function(e){if(!this.previousState)return this.previousState={allFloorsVisible:this.model.allFloorsVisible,position:this.position.clone(),quaternion:this.quaternion.clone(),mouse:this.mouse.clone(),currentFloor:this.model.currentFloor,projectionMatrix:this.camera.projectionMatrix.clone(),worldMatrix:this.camera.matrixWorld.clone(),mode:this.mode,modelPosition:this.model.position.clone(),modelCenter:this.model.center.clone(),zoomLevel:this.zoomLevel},e.cameraChanged=!0,e.cameraChanged2=!0,e.cameraChanged3=!0,!0;var t=this.position.equals(this.previousState.position)&&this.quaternion.equals(this.previousState.quaternion)&&this.camera.matrixWorld.equals(this.previousState.worldMatrix)&&this.camera.projectionMatrix.equals(this.previousState.projectionMatrix)&&this.mode===this.previousState.mode&&this.zoomLevel===this.previousState.zoomLevel&&this.model.center.equals(this.previousState.modelCenter)&&this.model.position.equals(this.previousState.modelPosition),n=t&&this.mouse.equals(this.previousState.mouse)&&this.model.allFloorsVisible===this.previousState.allFloorsVisible&&this.model.currentFloor===this.previousState.currentFloor&&null===this.nextPano;return e.cameraChanged=!t,n?(e.cameraChanged2=!1,e.cameraChanged3=!1):(e.cameraChanged2=!xe.closeTo(this.quaternion,this.previousState.quaternion,5)||!xe.closeTo(this.position,this.previousState.position,4),e.cameraChanged3=!xe.closeTo(this.quaternion,this.previousState.quaternion,3)||!xe.closeTo(this.position,this.previousState.position,3)),e.allFloorsVisible=this.model.allFloorsVisible!==this.previousState.allFloorsVisible,e.moved=!this.position.equals(this.previousState.position),e.rotated=!this.quaternion.equals(this.previousState.quaternion),e.mouseMoved=!this.mouse.equals(this.previousState.mouse),e.floorChanged=this.model.currentFloor!==this.previousState.currentFloor,e.cameraProjectionChanged=!this.camera.projectionMatrix.equals(this.previousState.projectionMatrix),e.cameraWorldMatrixChanged=!this.camera.matrixWorld.equals(this.previousState.worldMatrix),e.modeChanged=this.mode!==this.previousState.mode,e.modelPositionChanged=!this.model.position.equals(this.previousState.modelPosition),e.modelCenterChanged=!this.model.center.equals(this.previousState.modelCenter),e.nextPanoActive=null!==this.nextPano,e.zoomLevel=this.zoomLevel!==this.previousState.zoomLevel,this.previousState.allFloorsVisible=this.model.allFloorsVisible,this.previousState.position.copy(this.position),this.previousState.quaternion.copy(this.quaternion),this.previousState.mouse.copy(this.mouse),this.previousState.currentFloor=this.model.currentFloor,this.previousState.projectionMatrix.copy(this.camera.projectionMatrix),this.previousState.worldMatrix.copy(this.camera.matrixWorld),this.previousState.mode=this.mode,this.previousState.modelPosition.copy(this.model.position),this.previousState.modelCenter.copy(this.model.center),this.previousState.zoomLevel=this.zoomLevel,!n},e.getToMode=function(){return this.modeTran.split("-")[1]},e.flyToMode=function(e,t,n){var o=this;if(this.mode==e)t&&t();else if("transitioning"==this.mode)this.once(oi,(function(){o.flyToMode(e,t,n)}));else{this.once(oi,(function(){t()}));try{this.flyToNewMode({mode:e,pano:"panorama"==e&&this.currentPano,duration:n})}catch(e){console.log("flyToMode遇到问题？")}}},e.vrModeChange=function(){He.vrEnabled?(He.vrEnabled=!1,window.VRScreenNotFull||Ce.exitFullscreen()):(He.vrEnabled=!0,window.VRScreenNotFull||Ce.requestFullscreen(document.body))},e.focusPoint=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(console.log("focusPoint"),"floorplan"==this.mode){var t=e.modelSize||new THREE.Vector3(10,10,10),n=(r=this.cameraControls.controls.floorplan).getDefaultAbsoluteScale(t),o=r.absoluteScale,i=r.target.clone();Se.cancelById(He.freeze.outsideFocus,!0),Se.start(function(t){r.absoluteScale=n*t+o*(1-t),r.target=e.aim.clone().multiplyScalar(t).add(i.clone().multiplyScalar(1-t)),r.camera.position.copy(r.target.clone().add(r.offset))}.bind(this),e.dur||600,null,0,Ie[He.transition.blendEasing],"outsideFocus",He.freeze.outsideFocus,null)}else if("dollhouse"==this.mode){var r=this.cameraControls.controls.dollhouse,a=e.radius||10,s=(i=r.target.clone(),r.offset.clone().normalize()),l=r.offset.length();Se.cancelById(He.freeze.outsideFocus,!0),Se.start(function(t){r.target=e.aim.clone().multiplyScalar(t).add(i.clone().multiplyScalar(1-t));var n=a*t+l*(1-t);r.camera.position.copy(r.target.clone().add(s.clone().multiplyScalar(n)))}.bind(this),e.dur||600,null,0,Ie[He.transition.blendEasing],"outsideFocus",He.freeze.outsideFocus,null)}},e.getSnapAngleInfo=function(){var e={metadata:{}},t=this.camera.quaternion.clone();switch(this.mode){case"panorama":e.metadata.scan_id=this.currentPano.id;break;case"floorplan":var n=this.getSize(),o=n.clientWidth,i=n.clientHeight;(t=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(90))).multiply(this.camera.quaternion),e.metadata.camera_mode=1,e.metadata.ortho_zoom=be.toPrecision(this.cameraControls.activeControl.currentScale/(o/i),4);break;case"dollhouse":e.metadata.camera_mode=2}return e.metadata.camera_position=this.camera.position.clone(),e.metadata.camera_quaternion=t,e.metadata.lon=this.cameraControls.activeControl.lon,e.metadata.lat=this.cameraControls.activeControl.lat,e.sid="4dkk"+(new Date).getTime(),e.name="",e.mode=this.mode,e},e.model=new mi(e.$app),e.currentPano=null,e.nextPano=null,e.camera=null,e.paused=!1,e.flying=!1,e.sceneIntersectionPlane=null,e.target=new THREE.Vector3,e.mouse=new THREE.Vector3(1.1,1.1,.5),e.mouseAtMouseDown=new THREE.Vector2,e.mouseCouldBeClickToMove=!1,e.mouseLastMoveTime=Date.now(),e.mouseDown=!1,e.mouseDownTimer=null,e.couldBeLongTap=!1,e.containsMouse=!0,e.isTouchEvent=!1,e.isPanoHover=!1,e.reticule=new wi(h(e)),e.panoMarkers=[],e.quaternion=new THREE.Quaternion,e.position=new THREE.Vector3(15,10,15),e.previousState=null,e.lastInsideView=new gi,e.last360View=new gi,e.raycaster=new THREE.Raycaster,e.intersect=null,e.lastChangeTime=Date.now(),e.history=new Re,e.cameraControls=null,e.domElement=null,e.cachedPanoCandidates=null,e.basePanoSize=0,e.standardPanoSize=0,e.highPanoSize=0,e.ultraHighPanoSize=0,e.zoomLevel=1,e.zooming=0,e.zoomSpeed=.5,e.scrollZoomSpeed=.06,e.zoomSpeedAdjust=.05,e.defaultZoomIncrement=.2,e.baseFov=He.insideFOV,e.zoomFov=e.baseFov,e.zoomEnabled=!0,e.measureRulers=[],e.cornerRulers=[],e.planLabels=[],e.dollLabels=[],e.doorLabels=[],e.defaultRoomLabels=[],e.preRenderingEnabled=!1,e.setupCustomProperties(Oe.PANORAMA),e.zoomStats=new Me,e.cameraControls=e.$app.core.get("CameraControls"),e.modelManager=e.$app.core.get("ModelManager"),e.started=!1,e._locked=!1,e.panosTaskList=[],e.setPanoTaskEnable(!0),e}return u(n,[{key:"init",value:function(){this.domElement=this.$app.dom.querySelector(".player"),this.camera=this.$app.core.get("SceneRenderer").camera,this.path=new Wi(this.director,this,this.cameraControls),this.basePanoSize=this.$app.core.get("QualityManager").getPanoSize(mt),this.standardPanoSize=this.$app.core.get("QualityManager").getPanoSize(vt),this.highPanoSize=this.$app.core.get("QualityManager").getPanoSize(gt),this.ultraHighPanoSize=this.$app.core.get("QualityManager").getPanoSize(yt),this.$app.core.get("TileDownloader").processPriorityQueue=!1,this.$app.core.get("TileDownloader").tilePrioritizer=new Li(this.$app.core.get("QualityManager"),this.basePanoSize,this.standardPanoSize,this.highPanoSize,this.ultraHighPanoSize),this.bindEvents(this.domElement),this.updateModel(),tr.init(this)}},{key:"locked",get:function(){return this._locked},set:function(e){this.model.panos.forEach((function(t){t.marker.visible=!e})),this._locked=e}},{key:"setPanoTaskEnable",value:function(e){this.canConstantlyWalk=e,e||(this.panosTaskList=[])}},{key:"if",value:function(e){newPano=se.deepExtend(toPano),retryCallback=function(){se.delayOneFrame(function(){newPano.retry=!0,this.flyToPano(newPano,callbackFunc)}.bind(this))}.bind(this)}},{key:"getSize",value:function(){var e=this.$app.dom.querySelector('.player[name="main"]');return{clientWidth:e.clientWidth,clientHeight:e.clientHeight}}},{key:"beforeChangeMode",value:function(e,t,n,o){e==Oe.PANORAMA?(this.labelManager&&this.labelManager.updateEntryVisi(!0,this.model.currentFloor.floorIndex),this.model.floorLogos.firstLogo.visible=!1,this.model.floorLogos.secondLogo.visible=!1):e==Oe.FLOORPLAN?Ir.switchDepthTest(!0):Oe.DOLLHOUSE,t==Oe.PANORAMA?(this.model.floorLogos.firstLogo.position.copy(n.floorPosition.clone().sub(this.model.position)),this.model.floorLogos.secondLogo.position.copy(this.model.floorLogos.firstLogo.position),this.compass&&this.compass.setDisplay(!1),this.labelManager&&this.labelManager.updateEntryVisi(!1,this.model.currentFloor.floorIndex)):t==Oe.FLOORPLAN?(setTimeout(Ir.switchDepthTest.bind(this,!1),.5*o),this.labelManager&&this.labelManager.setPlanLabelVisi(!0,this.model.currentFloor.floorIndex)):Oe.DOLLHOUSE,this.$app.Camera.emit("mode.beforeChange",{fromMode:e,toMode:t,floorIndex:this.model.currentFloor.floorIndex})}},{key:"afterChangeMode",value:function(e,t,n,o){e==Oe.PANORAMA?this.compass&&this.compass.autoJudgeDisplay():e==Oe.FLOORPLAN?this.labelManager&&this.labelManager.setPlanLabelVisi(!1,this.model.currentFloor.floorIndex):Oe.DOLLHOUSE,t==Oe.PANORAMA?(this.model.floorLogos.firstLogo.visible=!0,this.model.floorLogos.changefloorLogoOpa({index:0,from:0,opa:1,dur:150}),this.doorLabels.forEach((function(e){return e.updateVisible()}))):t==Oe.FLOORPLAN||t==Oe.DOLLHOUSE&&this.model.floors.forEach((function(e){e.entryArrow.forEach((function(e){return e.dollLabel.update()}))})),this.$app.Camera.emit("mode.afterChange",{fromMode:e,toMode:t,floorIndex:this.model.currentFloor.floorIndex}),this.panosTaskList=[]}}]),n}()})),me("QualityManager",(function(){return function(){function e(t,n,o){i(this,e),this.maxNavPanoSize=-1,this.maxZoomPanoSize=-1,this.devicePixelDensity=t,this.deviceScreenSize=n,this.clientBandwidth=o,this.panoSizeClassMap={},this.useHighResolutionPanos=!0,this.useUltraHighResolutionPanos=!1,this.modelHasUltraHighPanos=!1,this.maxRenderTargetSize=W.mobile?2048:4096}return u(e,[{key:"init",value:function(){this.buildPanoSizeClassMap(this.devicePixelDensity,this.deviceScreenSize,this.clientBandwidth),this.ultraHighSize=this.getPanoSize(yt),this.highSize=this.getPanoSize(gt),this.standardSize=this.getPanoSize(vt),this.baseSize=this.getPanoSize(mt),He.tiling.maxZoomPanoQuality&&this.ultraHighSize<=He.tiling.maxZoomPanoQuality&&(He.tiling.allowUltraHighResolution=!0),this.highQualityThreshold=Ce.valueFromHash("threshold2k",Ee.windowHeightHighQualityThreshold),this.updateMaximums(),this.$app.core.get("ModelManager").on(Oi,this.onModelChanged.bind(this)),this.navTileClass="2k","tiles/4k"==this.$app.store.getValue("metadata").sceneResolution?this.tileClass="4k":this.tileClass="2k","1k"==this.tileClass&&(this.navTileClass="1k",this.useHighResolutionPanos=!1)}},{key:"updateFromModel",value:function(e){this.updateUltraHighResolutionSettings(e)}},{key:"updateHighResolutionSettings",value:function(e){showcase.modelDataPromisesTiles(e.data)?this.useHighResolutionPanos=!0:this.useHighResolutionPanos=!1,this.updateMaximums()}},{key:"updateUltraHighResolutionSettings",value:function(e){He.tiling.allowUltraHighResolution&&this.modelHasUltraHighPanos?this.useUltraHighResolutionPanos=!0:this.useUltraHighResolutionPanos=!1,this.updateMaximums()}},{key:"enableUltraHighQualityMode",value:function(){this.modelHasUltraHighPanos=!0,this.updateUltraHighResolutionSettings(null)}},{key:"ultraHighQualityModeEnabled",value:function(){return this.modelHasUltraHighPanos}},{key:"onModelChanged",value:function(e){this.updateFromModel(e.model),this.updateMaximums()}},{key:"updateMaximums",value:function(){this.maxNavPanoSize=He.tiling.maxNavPanoQuality||this.detectMaxNavPanoSize(),this.maxZoomPanoSize=He.tiling.maxZoomPanoQuality||this.detectMaxZoomPanoSize(),this.maxZoomPanoSize<this.maxNavPanoSize&&(this.maxNavPanoSize=this.maxZoomPanoSize)}},{key:"buildPanoSizeClassMap",value:function(){this.panoSizeClassMap[mt]=512,this.panoSizeClassMap[vt]=1024,this.panoSizeClassMap[gt]=2048,this.panoSizeClassMap[yt]=4096}},{key:"getPanoSize",value:function(e){return this.panoSizeClassMap[e]}},{key:"getMaxPossiblePanoSize",value:function(){return this.getPanoSize(yt)}},{key:"getMaxPanoSize",value:function(){return this.maxZoomPanoSize}},{key:"getMaxNavPanoSize",value:function(){return this.maxNavPanoSize}},{key:"getMaxZoomPanoSize",value:function(){return this.maxZoomPanoSize}},{key:"detectMaxNavPanoSizeClass",value:function(){switch(this.navTileClass){case"1k":return vt;case"2k":default:return gt}}},{key:"detectMaxNavPanoSize",value:function(){var e=this.detectMaxNavPanoSizeClass();return this.getPanoSize(e)}},{key:"detectMaxZoomPanoSize",value:function(){return this.zoomLevelResolution?"4k"==this.zoomLevelResolution&&this.useUltraHighResolutionPanos?this.getPanoSize(yt):"1k"!=this.zoomLevelResolution&&this.useHighResolutionPanos?this.getPanoSize(gt):this.getPanoSize(vt):this.useHighResolutionPanos?this.useUltraHighResolutionPanos?this.getPanoSize(yt):this.getPanoSize(gt):this.getPanoSize(vt)}}]),e}()}));var Hr={getCubemapUrls:function(e,t,n){return[0,1,2,3,4,5].map(function(o,i){return e.get("pan/"+n+"/"+t+"_skybox"+r(o)+".jpg")}.bind(this))},mapFaceToCubemapFace:function(e){return{0:Yn,1:Xn,2:Gn,3:Jn,4:qn,5:$n}[e]}},Or="tiledownloader.download.success",Fr="tiledownloader.pano.download.complete";function Nr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}me("TileDownloader",(function(){var e,t;return t=e=function(e){f(n,EventEmitter);var t=Nr(n);function n(e){var o;return i(this,n),(o=t.call(this)).forceQueueTilesForPano=function(){var e=[],t=[];return function(n,o,i,r,a,s){e.length=0;for(var l=this.getTileDownloadDescriptors(n,o),c=0;c<l.length;c++){var u=l[c];u.status!==Ci.None&&u.status!==Ci.Queued||e.push(u)}if(i&&e.length>0){Li.sortPanoTiles(e,n,i),t.length=0,Kn.matchingTilesInDirection(n,o,i,r,a,t);for(var h=0,d=function(e){return e.face===p.face&&e.faceTileIndex===p.faceTileIndex};h<e.length;){var p=e[h];t.findIndex(d)<0?e.splice(h,1):h++}}for(var f=0;f<e.length;f++)this.forceQueue.push(e[f]);this.setStatusForAllDescriptors(this.forceQueue,Ci.ForceQueued),this.clearFromQueue(this.priorityQueue,Ci.ForceQueued,!1),s&&this.processQueueForDownloading(this.forceQueue,!0)}}(),o.cleanupActiveDownloads=function(){var e=[];return function(){e.length=0;for(var t=0;t<this.activeDownloads.length;t++){var n=this.activeDownloads[t];n.status!==Ci.Downloaded&&n.status!==Ci.Failed&&e.push(n)}this.activeDownloads.length=0,this.activeDownloads.push.apply(this.activeDownloads,e)}}(),o.getTileUrl=function(){var e={256:"256",512:"512",1024:"1k",2048:"2k",4096:"4k"},t={face:-1,faceTileIndex:-1,tileX:-1,tileY:-1};return function(n,o,i,r,a){Kn.getTileLocation(o,r,t);var s=Math.floor(o/i),l=s*s,c=Math.floor(r/l),u="";1===He.tiling.customCompression&&He.tiling["q"+e[o]];var h=this.$app.store.getValue("metadata").sceneResolution;return u=h+"/"+n+"_skybox"+c+".jpg?x-oss-process=","512"==e[o]?u+="image/resize,h_512":("1k"==e[o]||"2k"==e[o]?u+="image/resize,m_lfit,w_"+o+"/crop,w_512,h_512,":u=h+"/"+n+"_skybox"+c+".jpg?x-oss-process=image/crop,w_512,h_512,",u+=0==t.tileX?"x_0,":"x_"+(512*t.tileX-1)+",",u+=0==t.tileY?"y_0":"y_"+(512*t.tileY-1)),u=this.getTiles(u)}}(),o.panos=null,o.retryMinimumTime=1e4,o.urls=null,o.panoLoadCallbacks={},o.downloadDescriptors={},o.priorityQueue=[],o.forceQueue=[],o.activeDownloads=[],o.tilePrioritizer=null,o.refreshInterval=null,o.processPriorityQueue=!1,o.concurrentDownloads=e.concurrentDownloads||1,o.downloadTestResults={},o.freeze=Object.freeze({Testing:1,Success:2,Fail:3}),o}return u(n,[{key:"init",value:function(){}},{key:"setUrls",value:function(e){this.urls=e}},{key:"setPanoData",value:function(e,t,n){this.panos=e,this.imagePanos=t,this.panoGroupId=n}},{key:"start",value:function(){this.refreshUpdateInterval(0)}},{key:"stop",value:function(){window.cancel(this.refreshInterval)}},{key:"refreshUpdateInterval",value:function(e){e||(e=0),this.refreshInterval=window.setTimeout(function(){this.update()?this.refreshUpdateInterval(n.ACTIVE_REFRESH_DELAY):this.refreshUpdateInterval(n.IDLE_REFRESH_DELAY)}.bind(this),e)}},{key:"update",value:function(){var e=this.forceQueue.length>0;return this.processQueueForDownloading(this.forceQueue),this.processPriorityQueue&&(this.queuePrioritizedTilesForPanos(this.panos),this.priorityQueue.length>0&&(e=!0),this.processQueueForDownloading(this.priorityQueue)),e}},{key:"clearForceQueue",value:function(){this.clearQueue(this.forceQueue)}},{key:"queuePrioritizedTilesForPanos",value:function(e){this.tilePrioritizer&&(this.clearQueue(this.priorityQueue),this.tilePrioritizer.filterAndPrioritize(this.priorityQueue,e,this),this.clearFromQueue(this.priorityQueue,Ci.None,!0),this.setStatusOrRemoveForAllDescriptors(this.priorityQueue,Ci.Queued))}},{key:"clearQueue",value:function(e){this.setStatusForAllDescriptors(e,Ci.None),e.length=0}},{key:"clearFromQueue",value:function(e,t,n){for(var o=0;o<e.length;o++){var i=e[o];i&&(t===i.status&&!n||t!==i.status&&n)&&(e[o]=null)}}},{key:"setStatusForAllDescriptors",value:function(e,t){for(var n=0;n<e.length;n++){var o=e[n];o&&(o.status=t)}}},{key:"setStatusOrRemoveForAllDescriptors",value:function(e,t){for(var n=0;n<e.length;n++){var o=e[n];o&&(o.status!==t?o.status=t:e[n]=null)}}},{key:"getTileDownloadDescriptors",value:function(e,t){var n=this.getAllTileDownloadDescriptorsForPano(e),o=n[t];return o||(o=this.buildDownloadDescriptorArray(t),n[t]=o,this.initTileDownloadDescriptors(o,e,t)),o}},{key:"getAllTileDownloadDescriptorsForPano",value:function(e){var t=this.downloadDescriptors[e.id];return t||(t={},this.downloadDescriptors[e.id]=t),t}},{key:"processQueueForDownloading",value:function(e,t){if(this.cleanupActiveDownloads(),this.activeDownloads.length<this.concurrentDownloads||t)for(var n=t?e.length:this.concurrentDownloads-this.activeDownloads.length,o=0,i=0;o<n&&e.length>0;i++){var r=e.shift();r&&(this.startDownload(r),o++)}}},{key:"testDownload",value:function(e,t,n){var o=this.downloadTestResults[e];if(o)o===this.freeze.Success?n(!0):o===this.freeze.Fail&&n(!1);else{this.downloadTestResults[e]=this.freeze.Testing;var i=this.panos.list[0],r=this.getTileUrl(i.id,e,t,0),a=function(t){this.downloadTestResults[e]=this.freeze.Success,n(!0)}.bind(this),s=function(){this.downloadTestResults[e]=this.freeze.Fail,n(!1)}.bind(this);this.loadImage(r,0,a,s)}}},{key:"startDownload",value:function(e){e.status=Ci.Downloading;var t=this.getTileUrl(e.pano.id,e.panoSize,e.tileSize,e.tileIndex,e.pano.alignmentType);this.activeDownloads.push(e),this.loadImage(t,n.DOWNLOAD_RETRIES,this.downloadComplete.bind(this,e),this.downloadFailed.bind(this,e))}},{key:"downloadFailed",value:function(e,t){}},{key:"downloadComplete",value:function(e,t){if(e.panoGroupId===this.panoGroupId){var n=this.getPanoLoadCallbacks(e.pano,e.panoSize);e.status=Ci.Downloaded,n&&n.onProgress&&n.onProgress(e.pano,e.panoSize);var o={panoId:e.pano.id,image:t,tileSize:e.tileSize,panoSize:e.panoSize,tileIndex:e.tileIndex,faceTileIndex:e.faceTileIndex,totalTiles:e.totalTiles,face:e.face,tileX:e.tileX,tileY:e.tileY,direction:e.direction};e.image=t,this.emit(Or,o),this.isPanoDownloaded(e.pano,e.panoSize)&&(o={panoId:e.pano.id,tileSize:e.tileSize,panoSize:e.panoSize},this.emit(Fr,o),n&&n.onLoad&&n.onLoad(e.pano,e.panoSize))}}},{key:"isPanoDownloaded",value:function(e,t){var n=this.getTileDownloadDescriptors(e,t);if(n.length<=0)return!1;for(var o=0;o<n.length;o++){if(n[o].status!==Ci.Downloaded)return!1}return!0}},{key:"setPanoLoadCallbacks",value:function(e,t,n,o,i){var r=e.id+":"+this.$app.core.get("QualityManager").getPanoSize(t);this.panoLoadCallbacks[r]={onLoad:n,onFail:o,onProgress:i}}},{key:"getPanoLoadCallbacks",value:function(e,t){var n=e.id+":"+t;return this.panoLoadCallbacks[n]}},{key:"buildDownloadDescriptorArray",value:function(e){for(var t=Kn.getTileCountForSize(e),n=[],o=0;o<t;o++){var i=this.buildDownloadDescriptor();n.push(i)}return n}},{key:"buildDownloadDescriptor",value:function(){return{panoGroupId:null,pano:null,panoSize:-1,tileSize:-1,tileIndex:-1,totalTiles:-1,faceTileIndex:-1,status:Ci.None,url:null,image:null,direction:new THREE.Vector3,face:-1,cubeFace:-1,tileX:-1,tileY:-1}}},{key:"initTileDownloadDescriptors",value:function(e,t,n){for(var o=0;o<e.length;o++){var i=e[o];this.initTileDownloadDescriptor(i,t,n,o)}}},{key:"initTileDownloadDescriptor",value:function(e,t,n,o){var i=n>=Kn.TILE_SIZE?Kn.TILE_SIZE:n;e.face=Kn.getFaceForTile(n,o),e.cubeFace=Hr.mapFaceToCubemapFace(e.face),e.panoGroupId=this.panoGroupId,e.pano=t,e.panoSize=n,e.tileSize=i,e.tileIndex=o,e.totalTiles=Kn.getTileCountForSize(n),e.status=Ci.None,e.image=null,Kn.getTileLocation(e.panoSize,e.tileIndex,e),Kn.getTileVector(e.panoSize,e.tileSize,e.cubeFace,e.tileX,e.tileY,Kn.LocationOnTile.Center,0,e.direction)}},{key:"loadImage",value:function(e,t,n,o){Mn.getImage(e,t).then((function(e){n(e)}))}},{key:"getTiles",value:function(e){return this.urls.get(e)}}]),n}(),e.IDLE_REFRESH_DELAY=500,e.ACTIVE_REFRESH_DELAY=16,e.DOWNLOAD_RETRIES=4,t}));var Br="scene-renderer-context-created",jr="after-render";function Ur(e,t){this.tree=e,this.parent=t,this.children=[],this.id=++qr}function _r(e,t,n,o,i,r,a,s){if(e){a=a||TileTree.TraversalType.PreOrder;var l=o*Qr+n;if(a===TileTree.TraversalType.PreOrder&&(i&&i(e,t,l,n,o),r&&r.push(e)),e.children&&0!==e.children.length){for(var c=o*Qr,u=n*Qr,h=0;h<Qr;h++)for(var d=0;d<Qr;d++)_r(e.children[d*Qr+h],t+1,u+h,c+d,i,r,a);a===TileTree.TraversalType.PostOrder&&(i&&i(e,t,l,n,o),r&&r.push(e))}}}function Wr(e,t,n){if(n>e.levels)return null;var o=new Ur(e,t);e.allNodes.push(o);for(var i=0;i<Gr;i++)o.children[i]=Wr(e,o,n+1);return o}function Zr(e,t,n,o,i){if(!e)return null;if(0===n)return e;if(!e.children||0===e.children.length)return null;var r=Math.pow(Qr,n)/Qr,a=o%r,s=i%r,l=Math.floor(i/r),c=Math.floor(o/r),u=l*Qr+c;return Zr(e.children[u],t+1,n-1,a,s)}window.TileTree=function(e,t){this.levels=t,this.tileSize=e,this.root=null,this.allNodes=[],function(e){e.root=Wr(e,null,0)}(this)};var Qr=2,Gr=Qr*Qr;TileTree.TraversalType=Object.freeze({PreOrder:0,PostOrder:1});var qr=0;TileTree.getLevelCountForSize=function(e,t){var n=0;for(t<e&&(t=e);!((t/=Qr)<e);)n++;return n},TileTree.getSizeForLevel=function(e,t){return Math.pow(Qr,t)*e},TileTree.prototype.getSubNode=function(e,t,n){(!t||e<this.tileSize)&&(t=0),(!n||e<this.tileSize)&&(n=0),e<this.tileSize&&(e=this.tileSize);var o=TileTree.getLevelCountForSize(this.tileSize,e);return Zr(this.root,0,o,t,n)},TileTree.prototype.breadthFirst=function(e){var t=!!(e=e||{}).nullLevelEnd,n=e.maxLevel,o=e.minLevel,i=e.callback,r=e.saveVisited,a=[],s={},l=0;for(a.push(this.root),a.push(s);a.length>0&&!(n&&l>n);){var c=a.shift();if(c===s)(!o||l>=o)&&(i&&t&&i(null),r&&t&&r.push(null)),a.length>0&&a.push(s),l++;else{if(c.children)for(var u=0;u<c.children.length;u++){c.children[u]&&a.push(c.children[u])}var h=this.getFaceIndexFromNode(c);(!o||l>=o)&&(i&&i(c,l,h),r&&r.push(c))}}},TileTree.prototype.getFaceIndexFromNode=function(e){if(!e)return-1;for(var t=1,n=e,o=0,i=0;;){var r=n.parent;if(!r)break;for(var a=-1,s=0;s<r.children.length;s++)r.children[s]===n&&(a=s);o=a%Qr*t+o,i=Math.floor(a/Qr)*t+i,t*=Qr,n=r}return i*t+o},TileTree.prototype.depthFirst=function(e,t,n){_r(this.root,0,0,0,e,t,n,this.tileSize)};var Yr=TileTree;function $r(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}function Xr(){this.uploadIntervalCancelled||(this.overlayTilesLoaded||!this.usingTileOverlay?(Jr=!0,this.updateUploadQueue(this.maxNonBaseUploadsPerFrame,this.maxBaseUploadsPerFrame),this.peekNextFromUploadQueue()?this.refreshUploadInterval(Kr):this.uploadInterval=null):this.refreshUploadInterval(this.uploadIntervalDelay))}var Jr=!1,Kr=He.tiling.uploadIntervalDelay,ea=He.tiling.initialIntervalDelay,ta=He.tiling.maxNonBaseUploadsPerFrame,na=He.tiling.maxBaseUploadsPerFrame,oa=0,ia=1;me("PanoRenderer",(function(){return function(e){f(n,EventEmitter);var t=$r(n);function n(e){var o,r,a,s;return i(this,n),(o=t.call(this)).updateActivePanos=function(){var e=[];return function(t,n){e.length=0;for(var o=0;o<this.activePanos.length;o++){t&&e.length===n&&e.push(t);var i=this.activePanos[o],r=this.getActiveRenderTargetDescriptor(i.id);t&&i.id===t.id||!this.isRenderTargetDescriptorValid(r)||e.push(i)}t&&n>=e.length&&e.push(t),this.activePanos.length=0,this.activePanos.push.apply(this.activePanos,e)}}(),o.renderPanoTiles=function(){var e=[];return function(t,n,o,i){this.zoomRenderTarget&&this.zoomRenderTarget.width===this.$app.core.get("QualityManager").getMaxZoomPanoSize()||this.zoomPanoRenderingDisabled||this.setupZoomRenderTarget(),n=n||this.direction||Vectors.FORWARD;var r=this.getActiveRenderTargetDescriptor(t);if(!this.isRenderTargetDescriptorValid(r))throw new BasicException("PanoRenderer.renderPanoTiles() -> Cannot render to a pano that is not activated.");for(var a=0;a<Kn.FACES_PER_PANO;a++){var s=this.getTileTree(t,a);e.length=0,s.breadthFirst({saveVisited:e});for(var l=0;l<e.length;l++){var c=e[l];this.queueTileUpload(c.tile,!1,i||0===l&&o)}}this.updateDirection(n)}}(),o.getNextFromUploadQueue=function(){var e=function(e){var t=e.shift();return t.uploadQueued=!1,t};return function(){if(this.forceQueue.length>0)return e(this.forceQueue);var t=this.getTopUploadQueue();return t&&t.length>0?e(t):null}}(),o.refreshUploadInterval=function(){var e=null;return function(t){this.uploadIntervalCancelled||(e||(e=Xr.bind(this)),null!=t||(t=Kr),Jr||(t=ea),this.uploadInterval=window.setTimeout(e,t),this.uploadIntervalDelay=t)}}(),o.update=function(){var e=performance.now(),t=0;return function(){this.uploadIntervalCancelled=!0,window.clearTimeout(this.uploadInterval),this.uploadInterval=null,//!(i > w || 0 === t) || !this.overlayTilesLoaded && this.usingTileOverlay || (this.updateUploadQueue(this.maxNonBaseUploadsPerFrame, this.maxBaseUploadsPerFrame),
!(performance.now()-e>Kr||0===t)||!this.overlayTilesLoaded&&this.usingTileOverlay||(this.updateUploadQueue(this.maxNonBaseUploadsPerFrame,this.maxBaseUploadsPerFrame),e=performance.now()),t++}}(),o.uploadTile=(r={},a=He.tiling.overlayStyle,s={},function(e,t){var n=this,o=1==this.index?this.sceneRenderer2:this.$app.core.get("SceneRenderer"),i=e.panoId,l=e.image,c=e.tileSize,u=e.panoSize,h=e.tileIndex,d=e.totalTiles,p=e.tileX,f=e.tileY,m=!0,v=!1,g=!1,y=(this.getPanoDescriptor(i),this.getPanoLODDescriptor(i,u)),w=this.getActiveRenderTargetDescriptor(i),b=w.renderTarget,E=w.size;this.isPanoZoomed(i)&&this.zoomRenderTarget&&(b=this.zoomRenderTarget,E=this.zoomRenderTarget.width);var x=function(){y.uploaded.includes(h)||(y.uploaded.push(h),y.uploadCount++),n.emit(st.TileRenderSuccess,i,u,h,d),y.uploadCount===d&&n.emit(st.PanoRenderComplete,i,u,d),n.setUploaded(e,!0),n.addCoverageForNode(e.node)};if(this.isRenderTargetDescriptorValid(w)||(m=!1,v=!1),t||(this.anyUploaded(e.node)&&(m=!1,v=!0,g=!0),this.isTileUploaded(e)&&(m=!1,v=!1,g=!0)),m){var T=c/u*E,P=p*c/u*E,k=f*c/u*E;if(r[c]||(r[c]=o.initSizedTexture2D(c,THREE.ClampToEdgeWrapping)),u>this.$app.core.get("QualityManager").maxRenderTargetSize)var M=o.initSizedTexture2D(c,THREE.ClampToEdgeWrapping),R=this.$app.core.get("Player").model.isHighMapLoaded(e.cubeFace,p,f);else M=r[c];if(o.uploadTexture2D(l,M,0,0,c,c),u>this.$app.core.get("QualityManager").maxRenderTargetSize)R||this.$app.core.get("Player").model.updateHighMap(M,e.cubeFace,p,f);else if(1===a||2===a){var I=1===a?this.overlayTilesBasic:this.overlayTilesEnhanced;o.renderToCubeMap(M,b,c,c,0,0,c,c,P,k,T,T,e.cubeFace),o.renderToCubeMap(I[u],b,c,c,0,0,c,c,P,k,T,T,e.cubeFace,THREE.NormalBlending,!0,.5)}else o.renderToCubeMap(M,b,c,c,0,0,c,c,P,k,T,T,e.cubeFace);x()}else g?x():(s[i+":"+u+":"+h]=!0,this.setUploaded(e,!1));return e.uploadAttempted||(y.uploadAttempts++,this.emit(st.TileUploadAttempted,i,u,h,d)),e.uploadAttempted=!0,y.uploadAttempts===d&&this.emit(st.UploadAttemptedForAllTiles,i,u,d),v}),o.tileDirectory={},o.activeRenderTargetDescriptors={},o.activePanos=[],o.panoLODDescriptors={},o.panoDescriptors={},o.tileTrees={},o.forceQueue=[],o.uploadQueues={},o.uploadInterval=null,o.uploadIntervalCancelled=!1,o.usingTileOverlay=!1,o.overlayTilesLoaded=!1,o.overlayTileBase=null,o.overlayTilesBasic={},o.overlayTilesEnhanced={},o.zoomRenderTarget=null,o.zoomPano=null,o.zoomingActive=!1,o.zoomPanoId=null,o.zoomPanoRenderingDisabled=!1,o.direction=new THREE.Vector3,o.initTime=-1,o.maxBaseUploadsPerFrame=na,o.maxNonBaseUploadsPerFrame=ta,o.M=[],o.index=e||0,o}return u(n,[{key:"init",value:function(e,t,n){1==this.index&&(this.sceneRenderer2=e,this.tileDownloader2=t),this.initTime=performance.now(),this.bindEvents()}},{key:"getActivePanoTextures",value:function(e){e=e||[];for(var t=0;t<M.length;t++){var n=M[t];n.renderTarget&&n.renderTarget.texture&&e.push(n.renderTarget.texture)}}},{key:"hasQueuedTiles",value:function(){var e=this.peekNextFromUploadQueue();return null!=e}},{key:"getActiveRenderTargetDescriptor",value:function(e){return this.activeRenderTargetDescriptors[e]}},{key:"setActiveRenderTargetDescriptor",value:function(e,t){this.activeRenderTargetDescriptors[e]=t}},{key:"bindEvents",value:function(){1==this.index?this.tileDownloader2.on(Or,this.onTileDownloaded.bind(this)):this.$app.core.get("TileDownloader").on(Or,this.onTileDownloaded.bind(this))}},{key:"setupZoomRenderTarget",value:function(){var e=this.$app.core.get("QualityManager");if("2k"!=e.maxRenderTargetSize||"2k"!=e.getMaxNavPanoSize())if(e.getMaxZoomPanoSize()>=e.getMaxNavPanoSize()&&("2k"!=e.tileClass||"1k"!=e.tileClass)){var t=1==this.index?this.sceneRenderer2:this.$app.core.get("SceneRenderer");if(this.zoomRenderTarget&&this.zoomRenderTarget.width===e.getMaxZoomPanoSize())return;var n=this.zoomRenderTarget;if(e.getMaxZoomPanoSize()>e.maxRenderTargetSize)return;if(this.zoomRenderTarget=this.initTiledPano(e.getMaxZoomPanoSize(),!1),n){var o=n.width,i=this.zoomRenderTarget.width;t.copyCubeMap(n.texture,this.zoomRenderTarget,o,o,i,i),n.texture.dispose(),n.texture.loaded=!1,n.texture.version=0,t.deallocateCubeTexture(n.texture),n.texture=null}this.zoomPanoRenderingDisabled=!1}else this.zoomPanoRenderingDisabled=!0}},{key:"enableHighQuality",value:function(e){this.$app.core.get("QualityManager").highQualityModeStarted||(this.setupZoomRenderTarget(),e(),this.$app.core.get("QualityManager").highQualityModeStarted=!0)}},{key:"enableUltraHighQualityMode",value:function(e){var t=this.$app.core.get("QualityManager");if("2k"==t.tileClass||"1k"==t.tileClass)return this.enableHighQuality(e);if(!t.ultraHighQualityModeEnabled()){var n=t.getPanoSize(yt);this.$app.core.get("TileDownloader").testDownload(n,Kn.TILE_SIZE,function(t){t&&(this.$app.core.get("QualityManager").enableUltraHighQualityMode(),this.setupZoomRenderTarget(),e())}.bind(this))}}},{key:"activateTiledPano",value:function(e,t,n){n&&this.clearAllQueuedUploads();for(var o=0;o<Kn.FACES_PER_PANO;o++)this.initTileTree(e.id,o,this.$app.core.get("QualityManager").getMaxPossiblePanoSize());this.linkAllTilesAndNodes(e);var i=this.getActiveRenderTargetDescriptor(e.id),r=t;if(r>this.$app.core.get("QualityManager").getMaxNavPanoSize()&&(r=this.$app.core.get("QualityManager").getMaxNavPanoSize()),!i||r!==i.size){if(i&&this.deactiveDescripor(i.renderTarget),!(i=this.activeDescripor(r))){var a=this.initTiledPano(r,!1);(i=this.initDescriptor(a.width)).renderTarget=a}i.pano=e,this.resetPanoDescriptor(e.id),this.resetPanoLODDescriptors(e.id),this.resetRenderStatus(e.id,!0,!0)}this.setActiveRenderTargetDescriptor(e.id,i);var s=n?0:1;return this.updateActivePanos(e,s),i.renderTarget}},{key:"deactivateTiledPano",value:function(e){var t=this.getActiveRenderTargetDescriptor(e.id);this.isRenderTargetDescriptorValid(t)&&(this.deactiveDescripor(t.renderTarget),this.setActiveRenderTargetDescriptor(e.id,null));var n=this.getUploadQueueForPano(e.id);this.clearUploadQueue(n),this.updateActivePanos()}},{key:"getActivePanoCount",value:function(){return this.activePanos.length}},{key:"resetRenderStatus",value:function(e,t,n,o){var i=null;o&&(i=Yr.getLevelCountForSize(Kn.TILE_SIZE,o)+1);for(var r=function(e,o,i,r){n&&(o.tile.zoomUploaded=!1),t&&(o.tile.uploaded=!1)},a=0;a<Kn.FACES_PER_PANO;a++){this.getTileTree(e,a).breadthFirst({callback:r.bind(this,a),minLevel:i})}}},{key:"copyBaseRenderStatusToZoomed",value:function(e){for(var t=Yr.getLevelCountForSize(Kn.TILE_SIZE,this.$app.core.get("QualityManager").getMaxNavPanoSize()),n=function(e,t,n,o){t.tile.zoomUploaded=t.tile.uploaded,t.zoomCovered=t.covered},o=0;o<Kn.FACES_PER_PANO;o++){this.getTileTree(e,o).breadthFirst({callback:n.bind(this,o),maxLevel:t})}}},{key:"isRenderTargetDescriptorValid",value:function(e){return e&&e.renderTarget}},{key:"isPanoActive",value:function(e){var t=this.getActiveRenderTargetDescriptor(e);return this.isRenderTargetDescriptorValid(t)}},{key:"isPanoZoomed",value:function(e){return this.zoomingActive&&this.zoomPanoId===e}},{key:"initTileTree",value:function(e,t,n){var o=this.tileTrees[e];o||(o=[],this.tileTrees[e]=o);var i=o[t];if(!i){var r=Yr.getLevelCountForSize(Kn.TILE_SIZE,n);i=new Yr(Kn.TILE_SIZE,r),o[t]=i}}},{key:"getTileTree",value:function(e,t){var n=this.tileTrees[e];if(!n)throw new BasicException("PanoRenderer.getTileTree() -> Tree array not yet initialized!");var o=n[t];if(!o)throw new BasicException("PanoRenderer.getTileTree() -> Tree not yet initialized!");return o}},{key:"initTiledPano",value:function(e,t){var n,o,i=1==this.index?this.sceneRenderer2.renderer:this.$app.core.get("SceneRenderer").renderer;n=new THREE.WebGLRenderTargetCube(e,e,{stencilBuffer:!1}),(o=new THREE.CubeTexture([])).image=[null,null,null,null,null,null],o.flipY=!0,o.format=THREE.RGBAFormat,t?(o.generateMipmaps=!0,o.magFilter=THREE.LinearFilter,o.minFilter=THREE.LinearMipMapLinearFilter):(o.generateMipmaps=!1,o.magFilter=THREE.LinearFilter,o.minFilter=THREE.LinearFilter),i.setRenderTarget(n),i.setRenderTarget(null);var r=i.properties.get(o);return r.__image__webglTextureCube=r.__webglTexture,n}},{key:"getUploadQueueForPano",value:function(e){var t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}},{key:"isTileUploaded",value:function(e){return this.isPanoZoomed(e.panoId)?e.zoomUploaded:e.uploaded}},{key:"setUploaded",value:function(e,t){this.isPanoZoomed(e.panoId)?e.zoomUploaded=t:e.uploaded=t}},{key:"queueTileUpload",value:function(e,t,n){var o=this.getActiveRenderTargetDescriptor(e.panoId);if(this.isRenderTargetDescriptorValid(o)&&e.downloaded&&!this.isTileUploaded(e)&&(!e.uploadQueued||n)&&(!(e.panoSize>this.$app.core.get("QualityManager").getMaxNavPanoSize())||this.zoomingActive)){var i=this.getUploadQueueForPano(e.panoId);n?this.uploadTile(e,!1):(this.shoulPushToFrontOfQueue(e)?this.forceQueue.push(e):t&&this.direction?Li.insertSortedPanoTile(i,e,o.pano,this.direction):i.push(e),e.uploadQueued=!0,this.uploadInterval||this.uploadIntervalCancelled||this.refreshUploadInterval(0))}}},{key:"shoulPushToFrontOfQueue",value:function(e){return 0===Yr.getLevelCountForSize(Kn.TILE_SIZE,e.panoSize)}},{key:"getTopUploadQueue",value:function(){for(var e=null,t=null,n=oa;n<=ia;n++)for(var o=0;o<this.activePanos.length;o++)if(e=this.activePanos[o],(t=this.getUploadQueueForPano(e.id)).length>0)switch(n){case oa:if(0===t[0].level)return t;break;case ia:return t}return null}},{key:"peekNextFromUploadQueue",value:function(){if(this.forceQueue.length>0)return this.forceQueue[0];var e=this.getTopUploadQueue();return e&&e.length>0?e[0]:null}},{key:"clearAllQueuedUploads",value:function(){this.clearAllUploadQueues(null,0)}},{key:"clearAllQueuedUploadsForPano",value:function(e){this.clearAllUploadQueues(e,0)}},{key:"clearAllUploadQueues",value:function(e,t){if(e)this.clearUploadQueue(this.getUploadQueueForPano(e),t),this.clearUploadQueue(this.forceQueue,t,e);else{for(var n=0;n<this.activePanos.length;n++){var o=this.activePanos[n];this.clearUploadQueue(this.getUploadQueueForPano(o.id),t)}this.clearUploadQueue(this.forceQueue,t)}}},{key:"clearUploadQueue",value:function(e,t,n){null!=t||(t=0);for(var o=0;o<e.length;){var i=e[o];(!n||n&&n===i.panoId)&&i.level>=t?(i.uploadQueued=!1,e.splice(o,1)):o++}}},{key:"updateUploadQueue",value:function(e,t){e||(e=1);for(var n=0,o=0;!(o>=t||n>=e);){var i=this.getNextFromUploadQueue();if(!i)break;if(0!==i.level?n++:o++,!(i.panoSize>this.$app.core.get("QualityManager").getMaxNavPanoSize())||this.zoomingActive){var r=this.getActiveRenderTargetDescriptor(i.panoId);this.isRenderTargetDescriptorValid(r)&&this.uploadTile(i,i.forceUpload)}}}},{key:"updateDirection",value:function(e){if(e=e||this.direction){this.direction=e;for(var t=0;t<this.activePanos.length;t++){var n=this.activePanos[t],o=this.getUploadQueueForPano(n.id);Li.sortPanoTiles(o,n,this.direction)}}}},{key:"linkTileAndNode",value:function(e,t){t.tile=e,e.node=t}},{key:"linkAllTilesAndNodes",value:function(e){for(var t=function(t,n,o,i,r){var a=this.getTileDirectoryEntry(e.id,n,i,r);this.linkTileAndNode(a,o)},n=0;n<Kn.FACES_PER_PANO;n++){var o=this.getTileTree(e.id,n);o.breadthFirst({callback:t.bind(this,o,n)})}}},{key:"anyUploaded",value:function(e){if(!e)return!1;if(e.tile&&this.isTileUploaded(e.tile))return!0;if(e.children)for(var t=0;t<e.children.length;t++){var n=e.children[t];if(this.anyUploaded(n))return!0}return!1}},{key:"setNodeCovered",value:function(e,t){this.isPanoZoomed(e.tile.panoId)?e.zoomCovered=t:e.covered=t}},{key:"isNodeCovered",value:function(e){return!!e&&(this.isPanoZoomed(e.tile.panoId)?e.zoomCovered:e.covered)}},{key:"addCoverageForNode",value:function(e){if(this.setNodeCovered(e,!0),e.parent&&e.covered){var t=e.parent;this.nodeSubcovered(t)&&this.addCoverageForNode(t,!0)}}},{key:"calcFullCoverage",value:function(e){var t=!1;if(e.children)for(var n=0;n<e.children.length;n++){var o=e.children[n];t=t||this.calcFullCoverage(o)}e.covered=e.tile.uploaded||t}},{key:"nodeSubcovered",value:function(e){if(!e.children)return!1;for(var t=0;t<e.children.length;t++)if(!e.children[t]||!this.isNodeCovered(e.children[t]))return!1;return!0}},{key:"resetPanoDescriptor",value:function(e){this.getPanoDescriptor(e)}},{key:"getPanoDescriptor",value:function(e){var t=this.panoDescriptors[e];return t||(t={},this.panoDescriptors[e]=t),t}},{key:"resetPanoLODDescriptors",value:function(e){var t=this.getPanoLODDescriptors(e);for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];o.uploadCount=0,o.uploadAttempts=0,o.uploaded=[]}}},{key:"getPanoLODDescriptor",value:function(e,t){var n=this.getPanoLODDescriptors(e),o=n[t];return o||(o={uploadCount:0,uploadAttempts:0,uploaded:[]},n[t]=o),o}},{key:"getPanoLODDescriptors",value:function(e){var t=this.panoLODDescriptors[e];return t||(t={},this.panoLODDescriptors[e]=t),t}},{key:"onTileDownloaded",value:function(e){var t=Yr.getLevelCountForSize(Kn.TILE_SIZE,e.panoSize),n=this.getTileDirectoryEntry(e.panoId,e.face,t,e.faceTileIndex);if(n.downloaded=!0,n.image=e.image,n.panoSize=e.panoSize,n.tileX=e.tileX,n.tileY=e.tileY,n.totalTiles=e.totalTiles,n.tileIndex=e.tileIndex,n.faceTileIndex=e.faceTileIndex,n.face=e.face,n.cubeFace=Hr.mapFaceToCubemapFace(e.face),n.panoId=e.panoId,n.tileSize=e.tileSize,n.direction=(new THREE.Vector3).copy(e.direction),n.node=null,n.level=Yr.getLevelCountForSize(Kn.TILE_SIZE,n.panoSize),this.isPanoActive(n.panoId)){var o=this.getTileTree(n.panoId,n.face).getSubNode(n.panoSize,n.tileX,n.tileY);this.linkTileAndNode(n,o),this.queueTileUpload(n,!0)}}},{key:"getTileDirectoryEntry",value:function(e,t,n,o){var i=this.tileDirectory[e];i||(i={},this.tileDirectory[e]=i);var r=16384*t+1024*n+o,a=i[r];return a||(a={downloaded:!1,uploaded:!1,zoomUploaded:!1},i[r]=a),a._key=e+":"+t+":"+n+":"+o,a._tileKey=r,a}},{key:"setZoomingActive",value:function(e,t,n){this.zoomPanoRenderingDisabled||e===this.zoomingActive&&this.zoomPanoId===t.id||(this.zoomingActive=e,this.zoomPanoId=t.id,this.zoomingActive&&(this.zoomPanoId!==t.id||n)&&this.updateZoomedPanoFromBase(t))}},{key:"updateZoomedPanoFromBase",value:function(e){if(!this.zoomPanoRenderingDisabled&&this.zoomRenderTarget){var t=1==this.index?this.sceneRenderer2:this.$app.core.get("SceneRenderer"),n=this.getActiveRenderTargetDescriptor(e.id);if(n&&n.renderTarget){var o=Math.min(this.$app.core.get("QualityManager").maxRenderTargetSize,this.$app.core.get("QualityManager").getMaxZoomPanoSize()),i=n.renderTarget,r=n.size;t.copyCubeMap(i.texture,this.zoomRenderTarget,r,r,o,o),this.copyBaseRenderStatusToZoomed(e.id)}}}},{key:"add",value:function(e){this.M.push(e)}},{key:"initDescriptor",value:function(e){var t={renderTarget:null,inUse:!1,size:-1,pano:null};return t.inUse=!0,t.size=e,this.add(t),t}},{key:"activeDescripor",value:function(e){for(var t=0;t<this.M.length;t++){var n=this.M[t];if(!n.inUse&&n.size===e)return n.inUse=!0,n}return null}},{key:"deactiveDescripor",value:function(e){for(var t=0;t<this.M.length;t++){var n=this.M[t];if(n.renderTarget===e)return n.inUse=!1,!0}return!1}}]),n}()}));var ra="panorama.videorenderer.suspendrender",aa="panorama.videorenderer.resumerender",sa="panorama.videorenderer.textured",la="panorama.videorenderer.canplayvideo",ca="panorama.videorenderer.startvideo";function ua(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}function ha(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}me("ModelManager",(function(){return function(e){f(n,EventEmitter);var t=ua(n);function n(){var e;return i(this,n),(e=t.call(this)).modelMap={},e.activeModel=null,e.modelCount=0,e}return u(n,[{key:"init",value:function(){this.bindEvents()}},{key:"bindEvents",value:function(){this.$app.core.get("PanoRenderer").on(st.TileRenderSuccess,this.onTileRendered.bind(this)),this.$app.core.get("PanoVideoRenderer").on(sa,this.onVideoTextureUpdate.bind(this)),this.$app.core.get("PanoVideoRenderer").on(ra,this.onSuspendVideoRender.bind(this)),this.$app.core.get("PanoVideoRenderer").on(aa,this.onResumeVideoRender.bind(this))}},{key:"onTileRendered",value:function(e,t,n,o){}},{key:"onVideoTextureUpdate",value:function(e){this.activeModel&&this.activeModel.updateVideoTexture(e)}},{key:"onSuspendVideoRender",value:function(){this.activeModel&&this.activeModel.suspendVideoRender()}},{key:"onResumeVideoRender",value:function(){this.activeModel&&this.activeModel.resumeVideoRender()}},{key:"addModel",value:function(e){this.modelMap[e.sid]=e,0===this.modelCount&&this.activateModel(e.sid),this.modelCount++,this.emit(Hi)}},{key:"activateModel",value:function(e){var t=this.modelMap[e];if(!t)throw new BasicException("Tried to activate invalid model!");var n=this.activeModel;this.activeModel=t,this.$app.core.get("TileDownloader").setPanoData(t.panos,[],t.sid),this.$app.core.get("TileDownloader").setUrls(t.urls),t.panos.forEach(function(e){e.attachToPanoRenderer(this.$app.core.get("PanoRenderer")),e.attachToPanoVideoRenderer(this.$app.core.get("PanoVideoRenderer")),e.tileDownloader=this.$app.core.get("TileDownloader"),e.qualityManager=this.$app.core.get("QualityManager")}.bind(this)),this.emit(Oi,{oldModel:n,model:t})}},{key:"getActiveModel",value:function(){return this.activeModel}}]),n}()}));var da=function(e){f(n,THREE.PerspectiveCamera);var t=ha(n);function n(e){var o;return i(this,n),(o=t.call(this,zi.clampVFOV(He.insideFOV),window.innerWidth/window.innerHeight,He.insideNear,He.insideFar)).controls=null,o}return u(n,[{key:"updateAspect",value:function(e){this.aspect=e,this.updateProjectionMatrix()}}]),n}();function pa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var fa=function(e){f(n,THREE.PerspectiveCamera);var t=pa(n);function n(e){var o;return i(this,n),(o=t.call(this,zi.clampVFOV(Ee.dollhouseFOV),window.innerWidth/window.innerHeight,Ee.dollhouseNear,Ee.dollhouseFar)).controls=null,o}return u(n,[{key:"updateAspect",value:function(e){isNaN(e)&&(e=1),this.aspect=e,this.updateFov(),this.updateProjectionMatrix()}},{key:"updateFov",value:function(){this.aspect<this.suitModelAspect?this.fov=zi.getVFOVFromHFOV(this.suitModelAspectHFov,this.aspect,1):this.fov=Ee.dollhouseFOV}}]),n}();function ma(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var va=function(e){f(n,THREE.OrthographicCamera);var t=ma(n);function n(e){var o;i(this,n),o=t.call(this);var r=window.innerWidth/window.innerHeight;return(o=t.call(this,-Ee.orthoBase,Ee.orthoBase,Ee.orthoBase/r,-Ee.orthoBase/r,Ee.orthoNear,Ee.orthoFar)).controls=null,o.updateAspect(r),o}return u(n,[{key:"updateAspect",value:function(e){isNaN(e)&&(e=1),this.aspect=e}}]),n}(),ga=0,ya=1,wa=2;function ba(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Ea=function(e){f(n,EventEmitter);var t=ba(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this)).camera=e,a.camera.controls=h(a),a.player=r,a.dom=o,a.target=new THREE.Vector3(0,0,0),a.lookVector=new THREE.Vector3,a.lookSpeed=.05,a.rotationAcc=new THREE.Vector2,a.rotationSpeed=new THREE.Vector2,a.lat=0,a.lon=0,a.phi=0,a.theta=0,a.enabled=!1,a.locked=!1,a.pointer=new THREE.Vector2(0,0),a.pointersLimit=2,a.pointers=[],a.rotationDifference=new THREE.Vector2,a.rotationHistory=[],a.pointerDragOn=!1,a.pointerDragStart=new THREE.Vector2(0,0),a.pinchDistance=0,a.moveStart=new THREE.Vector2,a.moveTolerance=.01,a}return u(n,[{key:"usable",value:function(){return this.enabled&&!this.locked}},{key:"lookAt",value:function(e){var t=this.camera.position.clone().sub(e),n=Math.atan(t.z/t.x);n+=t.x<0?Math.PI:0,n+=t.x>0&&t.z<0?2*Math.PI:0,this.lon=THREE.Math.radToDeg(n)+180;var o=Math.sqrt(t.x*t.x+t.z*t.z),i=Math.atan(t.y/o);this.lat=-THREE.Math.radToDeg(i)}},{key:"startRotationFrom",value:function(e,t){var n=be.handelPadding(e,t,this.dom);be.convertScreenPositionToNDC(n.x,n.y,this.pointer,this.dom),this.pointerDragOn=!0,this.pointerDragStart.copy(this.pointer),this.moveStart.copy(this.pointer),this.rotationHistory=[],this.rotationSpeed.set(0,0)}},{key:"onMouseOver",value:function(e){!this.pointerDragOn||0!==e.which&&0!==e.buttons||this.onMouseUp(e)}},{key:"onTouchStart",value:function(e){if(this.usable()){switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:this.startRotationFrom(e.touches[0].clientX,e.touches[0].clientY);break;case 2:var t=(e.touches[0].clientX-e.touches[1].clientX)/window.innerWidth,n=(e.touches[0].clientY-e.touches[1].clientY)/window.innerHeight;this.pinchDistance=Math.sqrt(t*t+n*n)}this.emit(Ti,"touch")}}},{key:"onPointerDown",value:function(e){this.usable()&&"touch"===e.pointerType&&(this.pointers.length<this.pointersLimit&&this.pointers.push({id:e.pointerId,clientX:e.clientX,clientY:e.clientY}),e.touches=this.pointers,this.onTouchStart(e),this.emit(Ti,"pointer"))}},{key:"onMouseDown",value:function(e){if(this.usable()){switch(e.preventDefault(),e.stopPropagation(),e.button){case ga:this.startRotationFrom(e.clientX,e.clientY)}this.emit(Ti,"mouse")}}},{key:"updateRotation",value:function(){if(this.usable()&&this.pointerDragOn){this.camera.matrixWorld=new THREE.Matrix4;var e=new THREE.Vector3(this.pointerDragStart.x,this.pointerDragStart.y,-1).unproject(this.camera),t=new THREE.Vector3(this.pointer.x,this.pointer.y,-1).unproject(this.camera),n=Math.sqrt(e.x*e.x+e.z*e.z),o=Math.sqrt(t.x*t.x+t.z*t.z),i=Math.atan2(e.y,n),r=Math.atan2(t.y,o);this.camera.updateMatrix(),this.camera.updateMatrixWorld(),this.rotationDifference.y=THREE.Math.radToDeg(i-r),e.y=0,t.y=0;var a=Math.acos(e.dot(t)/e.length()/t.length());isNaN(a)||(this.rotationDifference.x=THREE.Math.radToDeg(a),this.pointerDragStart.x<this.pointer.x&&(this.rotationDifference.x*=-1)),this.pointerDragStart.copy(this.pointer)}}},{key:"onMouseMove",value:function(e){if(this.usable()){var t=be.handelPadding(e.clientX,e.clientY,this.dom);be.convertScreenPositionToNDC(t.x,t.y,this.pointer,this.dom),this.pointerDragOn&&(Math.abs(this.pointer.x-this.moveStart.x)>this.moveTolerance||Math.abs(this.pointer.y-this.moveStart.y)>this.moveTolerance)&&this.emit(bi,"mouse")}}},{key:"onTouchMove",value:function(e){if(this.usable())switch(this.emit(bi,"touch"),e.touches.length){case 1:var t=be.handelPadding(e.touches[0].clientX,e.touches[0].clientY,this.dom);be.convertScreenPositionToNDC(t.x,t.y,this.pointer,this.dom);break;case 2:var n=(e.touches[0].clientX-e.touches[1].clientX)/window.innerWidth,o=(e.touches[0].clientY-e.touches[1].clientY)/window.innerHeight,i=this.pinchDistance-Math.sqrt(n*n+o*o);Math.abs(i)>.01&&(this.emit(Ei),this.emit(Pi,i),this.pinchDistance-=i)}}},{key:"onPointerMove",value:function(e){this.usable()&&"touch"===e.pointerType&&(this.pointers.forEach((function(t){e.pointerId===t.id&&(t.clientX=e.clientX,t.clientY=e.clientY)})),e.touches=this.pointers,this.onTouchMove(e))}},{key:"endRotation",value:function(){this.pointerDragOn=!1;var e=se.averageVectors(this.rotationHistory);this.rotationSpeed.set(e.x*He.rotationAfterMoveMultiplier,e.y*He.rotationAfterMoveMultiplier)}},{key:"onTouchEnd",value:function(e){this.usable()&&(e.preventDefault(),e.stopPropagation(),this.endRotation())}},{key:"onMouseUp",value:function(e){this.usable()&&(e.preventDefault(),e.stopPropagation(),this.endRotation())}},{key:"onPointerUp",value:function(e){this.usable()&&"touch"===e.pointerType&&(this.pointers.forEach(function(t,n){e.pointerId===t.id&&this.pointers.splice(n,1)}.bind(this)),e.touches=this.pointers,this.onTouchEnd(e))}},{key:"update",value:function(e){if(!this.locked){for(this.updateRotation(),this.rotationHistory.push(this.rotationDifference.clone());this.rotationHistory.length>He.rotationAfterMoveHistoryCount;)this.rotationHistory.shift();this.lon+=this.rotationDifference.x,this.lat+=this.rotationDifference.y,this.rotationDifference.set(0,0),this.rotationSpeed.x=this.rotationSpeed.x*(1-He.rotationFriction)+this.rotationAcc.x*He.rotationAccelerationInside,this.rotationSpeed.y=this.rotationSpeed.y*(1-He.rotationFriction)+this.rotationAcc.y*He.rotationAccelerationInside,this.lon+=this.rotationSpeed.x*e,this.lat+=this.rotationSpeed.y*e,this.lat=Math.max(Ee.insideLookLimitDown,Math.min(He.insideLookLimitUp,this.lat)),this.phi=THREE.Math.degToRad(90-this.lat),this.theta=THREE.Math.degToRad(this.lon),this.lookVector.x=Math.sin(this.phi)*Math.cos(this.theta),this.lookVector.y=Math.cos(this.phi),this.lookVector.z=Math.sin(this.phi)*Math.sin(this.theta),this.target.copy(this.lookVector).add(this.camera.position),this.camera.lookAt(this.target)}}},{key:"onMouseWheel",value:function(e){if(this.usable()){var t=e.wheelDelta||-e.detail;this.emit(Ei),this.emit(ki,t)}}},{key:"onKeyDown",value:function(e){this.player.$app.config.useShortcutKeys&&this.usable()&&(e.metaKey||e.ctrlKey||(e.preventDefault(),this.handleKeyDown(e.which)))}},{key:"handleKeyDown",value:function(e){var t=function(e,t){this.rotationAcc[e]=t}.bind(this);this.emit(xi);var n=!0;switch(e){case Vi.LEFTARROW:case Vi.J:t("x",-1);break;case Vi.RIGHTARROW:case Vi.L:t("x",1);break;case Vi.I:t("y",1);break;case Vi.K:t("y",-1);break;default:n=!1}n&&this.emit(bi,"key")}},{key:"onKeyUp",value:function(e){this.usable()&&(e.preventDefault(),e.stopPropagation(),this.handleKeyUp(e.which))}},{key:"handleKeyUp",value:function(e){switch(e){case Vi.LEFTARROW:case Vi.J:case Vi.RIGHTARROW:case Vi.L:this.rotationAcc.x=0;break;case Vi.I:case Vi.K:this.rotationAcc.y=0}}},{key:"startRotating",value:function(e,t){e&&(this.rotationAcc.x=e),t&&(this.rotationAcc.y=t)}},{key:"stopRotating",value:function(e){e&&(this.rotationSpeed.x=this.rotationSpeed.y=0),this.rotationAcc.set(0,0)}},{key:"reset",value:function(){this.pointerDragOn=!1,this.rotationAcc.set(0,0),this.rotationSpeed.set(0,0),this.pointers=[]}},{key:"toJSON",value:function(){return{camera_position:{x:be.toPrecision(this.camera.position.x,4),y:be.toPrecision(this.camera.position.y,4),z:be.toPrecision(this.camera.position.z,4)},camera_quaternion:{x:be.toPrecision(this.camera.quaternion.x,4),y:be.toPrecision(this.camera.quaternion.y,4),z:be.toPrecision(this.camera.quaternion.z,4),w:be.toPrecision(this.camera.quaternion.w,4)}}}},{key:"setStateFromJSON",value:function(e){this.camera.position.copy(e.camera_position),this.camera.quaternion.copy(e.camera_quaternion)}}]),n}(),xa=-1,Ta=0,Pa=1,ka=2,Ma=3,Ra=4;function Ia(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Sa=function(e){f(n,EventEmitter);var t=Ia(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this)).setAutoPanPosition=function(e,t){var n=new THREE.Vector3,o=new THREE.Vector3;return function(e,t){n.copy(this.camera.position),void 0===e&&null===e||n.setX(e),void 0===t&&null===t||n.setZ(t);var i=this.camera.position.distanceTo(this.target),r=Vector3.FORWARD.clone().applyQuaternion(this.camera.quaternion);this.targetClamped=!1,o.copy(n).addScaledVector(r,i),this.targetBounds.containsPoint(o)||(this.targetBounds.clampPoint(o,o),n.copy(o).addScaledVector(r,-i),this.targetClamped=!0),this.autoPanPosition.x=n.x,this.autoPanPosition.z=n.z,this.autoPan&&this.stopAutoPanning()}}(),a.camera=e,a.camera.controls=h(a),a.player=r,a.enabled=!1,a.target=new THREE.Vector3,a.targetBounds=new THREE.Box3,a.zoomSpeed=1,a.minDistance=0,a.maxDistance=1/0,a.scale=1,a.dollyStart=new THREE.Vector2,a.dollyEnd=new THREE.Vector2,a.dollyDelta=new THREE.Vector2,a.noRotateUpDown=!1,a.rotateSpeed=1,a.keyboardZoomSpeed=0,a.keyPanSpeed=7,a.autoRotate=!1,a.autoRotateSpeed=2,a.minPolarAngle=THREE.Math.degToRad(25),a.maxPolarAngle=THREE.Math.degToRad(65),a.rotationAcceleration=new THREE.Vector2,a.rotationSpeed=new THREE.Vector2,a.rotateStart=new THREE.Vector2,a.rotateEnd=new THREE.Vector2,a.rotateDelta=new THREE.Vector2,a.phiDelta=0,a.thetaDelta=0,a.rotateCenter=new THREE.Vector2,a.rotateStartVec=new THREE.Vector2,a.rotateEndVec=new THREE.Vector2,a.autoPan=!1,a.autoPanPosition=new THREE.Vector3,a.panAcceleration=new THREE.Vector2,a.panSpeed=new THREE.Vector2,a.panStart=new THREE.Vector2,a.panEnd=new THREE.Vector2,a.panDelta=new THREE.Vector2,a.panOffset=new THREE.Vector3,a.panVector=new THREE.Vector3,a.offset=new THREE.Vector3,a.lastPosition=new THREE.Vector3,a.state=xa,a.mouseActions={},a.mouseActions[ga]=Ta,a.mouseActions[ya]=Pa,a.mouseActions[wa]=ka,a.touchActions={},a.touchActions[1]=Ta,a.touchActions[2]=Ra,a.lastMoveTime=0,a.pointersLimit=2,a.pointers=[],a.angle=1e-6,a}return u(n,[{key:"setBounds",value:function(e){this.targetBounds=e}},{key:"isEngaged",value:function(){return this.state!==xa}},{key:"rotateLeft",value:function(e){void 0===e&&(e=this.getAutoRotationAngle()),this.thetaDelta-=e}},{key:"rotateUp",value:function(e){this.noRotateUpDown||(void 0===e&&(e=this.getAutoRotationAngle()),this.phiDelta-=e)}},{key:"panLeft",value:function(e){isNaN(e)&&(e=0);var t=this.camera.matrix.elements;this.panOffset.set(t[0],0,t[2]).normalize(),this.panOffset.multiplyScalar(-e),this.panVector.add(this.panOffset)}},{key:"panUp",value:function(e){isNaN(e)&&(e=0);var t=this.camera.matrix.elements;this.panOffset.set(t[4],0,t[6]).normalize(),this.panOffset.multiplyScalar(-e),this.panVector.add(this.panOffset)}},{key:"stopAutoPanning",value:function(){var e=this.autoPan;this.autoPan=!1,this.emit(this.targetClamped?Ii:e?Mi:Ri)}},{key:"dollyIn",value:function(e){void 0===e&&(e=this.getZoomScale()),this.scale/=e}},{key:"dollyOut",value:function(e){void 0===e&&(e=this.getZoomScale()),this.scale*=e}},{key:"updatePan",value:function(e){if(this.panSpeed.multiplyScalar(1-He.panFriction).addScaledVector(this.panAcceleration,He.panAccelerationOutside*e),this.pan(-this.panSpeed.x,this.panSpeed.y),this.autoPan){var t=(new THREE.Vector3).copy(this.autoPanPosition).sub(this.camera.position);t.setY(0).clampLength(0,50*e),this.target.add(t),this.camera.position.add(t),this.autoPanPosition.x===this.camera.position.x&&this.autoPanPosition.z===this.camera.position.z&&(this.autoPan=!1,this.stopAutoPanning())}}},{key:"update",value:function(e,t){if(!this.updateForCad){e||(e=1/60),this.rotationSpeed.multiplyScalar(1-He.rotationFriction).addScaledVector(this.rotationAcceleration,He.rotationAccelerationOutside*e),this.rotateLeft(-this.rotationSpeed.x),this.noRotateUpDown||this.rotateUp(this.rotationSpeed.y),this.updatePan(e);var n=this.camera.position;this.offset.copy(n).sub(this.target);var o=Math.atan2(this.offset.x,this.offset.z),i=Math.atan2(Math.sqrt(this.offset.x*this.offset.x+this.offset.z*this.offset.z),this.offset.y);this.autoRotate&&this.rotateLeft(this.getAutoRotationAngle()),o+=this.thetaDelta,i+=this.phiDelta,i=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,i)),i=Math.max(this.angle,Math.min(Math.PI-this.angle,i)),this.lon=o,this.lat=i;var r=this.updateZoom();r=Math.max(this.minDistance,Math.min(this.maxDistance,r)),this.target.add(this.panVector),this.targetBounds.clampPoint(this.target,this.target),this.offset.x=r*Math.sin(i)*Math.sin(o),this.offset.y=r*Math.cos(i),this.offset.z=r*Math.sin(i)*Math.cos(o),n.copy(this.target).add(this.offset),this.camera.lookAt(this.target),this.thetaDelta=0,this.phiDelta=0,this.scale=1,this.panVector.set(0,0,0),this.lastPosition.distanceTo(this.camera.position)>0&&this.lastPosition.copy(this.camera.position)}}},{key:"getAutoRotationAngle",value:function(){return 2*Math.PI/60/60*this.autoRotateSpeed}},{key:"getZoomScale",value:function(){return Math.pow(.95,this.zoomSpeed)}},{key:"onMouseDown",value:function(e){if(this.enabled){switch(e.preventDefault(),this.stopAutoPanning(),this.mouseDown=!0,this.state=this.mouseActions[e.button],this.state){case Ta:this.rotateStart.set(e.clientX,e.clientY),this.rotationSpeed.set(0,0),this.noRotateUpDown&&(this.rotateCenter=Pe.getPos2d(this.target,this.player).pos,this.rotateStartVec.subVectors(this.rotateStart,this.rotateCenter));break;case Pa:this.dollyStart.set(e.clientX,e.clientY);break;case ka:this.panStart.set(e.clientX,e.clientY)}this.emit(Ti,"mouse")}}},{key:"onMouseMove",value:function(e){if(this.enabled&&this.mouseDown&&0!==e.buttons){switch(e.preventDefault(),this.state){case Ta:if(this.rotateEnd.set(e.clientX,e.clientY),this.noRotateUpDown){this.rotateEndVec.subVectors(this.rotateEnd,this.rotateCenter);var t=be.getVec2Angle(this.rotateStartVec,this.rotateEndVec),n=new THREE.Vector3(this.rotateEndVec.x,this.rotateEndVec.y,0),o=new THREE.Vector3(this.rotateStartVec.x,this.rotateStartVec.y,0);n.clone().cross(o).z<0&&(t*=-1),this.rotateLeft(t),this.rotateStartVec.copy(this.rotateEndVec)}else this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateLeft(2*Math.PI*this.rotateDelta.x/this.player.domElement.clientWidth*this.rotateSpeed),this.rotateUp(2*Math.PI*this.rotateDelta.y/this.player.domElement.clientHeight*this.rotateSpeed),this.rotateStart.copy(this.rotateEnd);break;case Pa:this.dollyEnd.set(e.clientX,e.clientY),this.dollyDelta.subVectors(this.dollyEnd,this.dollyStart),(this.dollyDelta.y>0?this.dollyIn:this.dollyOut).call(this),this.dollyStart.copy(this.dollyEnd);break;case ka:this.panEnd.set(e.clientX,e.clientY),this.panDelta.subVectors(this.panEnd,this.panStart),this.pan(this.panDelta.x,this.panDelta.y),this.panStart.copy(this.panEnd)}this.emit(bi,"mouse"),this.lastMoveTime=e.timeStamp,this.update();var i={};i.quaternion=this.camera.quaternion,i.position=this.camera.position,i.target=this.target,this.player.emit($o,{info:i,mode:this.player.mode,type:"moveModel"})}}},{key:"onMouseUp",value:function(e){this.enabled&&(this.mouseDown=!1,this.state=xa,"mouseover"!==e.type&&(e.timeStamp>this.lastMoveTime+100?(this.rotationSpeed.set(0,0),this.rotationAcceleration.set(0,0)):this.rotationAcceleration.set(-this.rotateDelta.x,this.rotateDelta.y),this.update(),this.rotationAcceleration.set(0,0),this.rotateDelta.set(0,0)))}},{key:"onMouseOver",value:function(e){0!==e.which&&0!==e.buttons||this.onMouseUp(e)}},{key:"onMouseWheel",value:function(e){if(this.enabled&&He.useWheel){this.emit(bi,"wheel");var t=e.wheelDelta||-e.detail,n=this.dollyIn;t>0&&(n=this.dollyOut),n.call(this),this.update();var o={};this.player.mode===Oe.FLOORPLAN?(o.scale=this.absoluteScale,this.player.emit($o,{info:o,mode:Oe.FLOORPLAN,type:"moveModel"})):this.player.mode===Oe.DOLLHOUSE&&(o.quaternion=this.camera.quaternion,o.position=this.camera.position,o.target=this.target,this.player.emit($o,{info:o,mode:Oe.DOLLHOUSE,type:"moveModel"}))}}},{key:"onKeyDown",value:function(e){this.enabled&&(e.metaKey||e.ctrlKey||(e.preventDefault(),this.handleKeyDown(e.which)))}},{key:"navRotationAcc",value:function(e,t){"y"===e?this.noRotateUpDown?this.keyboardZoomSpeed=t:this.rotationAcceleration.y=t:this.rotationAcceleration.x=t}},{key:"navPanAcc",value:function(e,t){this.stopAutoPanning(),this.panAcceleration[e]=t}},{key:"handleKeyDown",value:function(e){var t=!0;switch(e){case Vi.UPARROW:case Vi.I:this.navRotationAcc("y",1);break;case Vi.DOWNARROW:case Vi.K:this.navRotationAcc("y",-1);break;case Vi.LEFTARROW:case Vi.J:this.navRotationAcc("x",-1);break;case Vi.RIGHTARROW:case Vi.L:this.navRotationAcc("x",1);break;case Vi.W:this.navPanAcc("y",1);break;case Vi.S:this.navPanAcc("y",-1);break;case Vi.A:this.navPanAcc("x",-1);break;case Vi.D:this.navPanAcc("x",1);break;default:t=!1}t&&this.emit(bi,"key")}},{key:"onKeyUp",value:function(e){this.enabled&&(e.preventDefault(),e.stopPropagation(),this.handleKeyUp(e.which))}},{key:"handleKeyUp",value:function(e){switch(e){case Vi.I:case Vi.K:case Vi.UPARROW:case Vi.DOWNARROW:this.keyboardZoomSpeed=0,this.rotationAcceleration.y=0;break;case Vi.J:case Vi.L:case Vi.LEFTARROW:case Vi.RIGHTARROW:this.rotationAcceleration.x=0;break;case Vi.S:case Vi.W:this.panAcceleration.y=0;break;case Vi.A:case Vi.D:this.panAcceleration.x=0}}},{key:"onTouchStart",value:function(e){if(this.enabled||this.state===xa){e.preventDefault(),e.stopPropagation(),this.stopAutoPanning();var t=function(){if(2===e.touches.length){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this.dollyStart.set(t,n)}}.bind(this),n=function(){this.panStart.set(se.average(e.touches,"pageX"),se.average(e.touches,"pageY"))}.bind(this),o=function(){if(this.noRotateUpDown){var t=new THREE.Vector2(e.touches[0].pageX,e.touches[0].pageY),n=new THREE.Vector2(e.touches[1].pageX,e.touches[1].pageY);this.rotateStartVec.subVectors(t,n),this.rotateStart=t,this.rotateCenter=Pe.getPos2d(this.target,this.player).pos}else this.rotateStart.set(se.average(e.touches,"pageX"),se.average(e.touches,"pageY"))}.bind(this);switch(this.state=this.touchActions[e.touches.length],this.state){case Ra:t();case ka:n();break;case Ma:t();case Ta:o()}this.rotationSpeed.set(0,0),this.emit(Ti,"touch")}}},{key:"onTouchMove",value:function(e){if(this.enabled&&this.state!==xa){e.preventDefault(),e.stopPropagation();var t=function(){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;this.dollyEnd.set(t,n);var o=this.dollyEnd.length()/this.dollyStart.length();return o>1?this.dollyIn(o):this.dollyOut(1/o),this.dollyStart.copy(this.dollyEnd),o}.bind(this),n=function(){this.panEnd.set(se.average(e.touches,"pageX"),se.average(e.touches,"pageY")),this.panDelta.subVectors(this.panEnd,this.panStart),this.pan(this.panDelta.x,this.panDelta.y),this.panStart.copy(this.panEnd),this.rotateDelta.set(0,0)}.bind(this),o=function(t,n){var o=new THREE.Vector2(e.touches[0].pageX,e.touches[0].pageY),i=o.clone().rotateAround(this.rotateCenter,n).clone().sub(this.rotateCenter).multiplyScalar(1/t),r=this.rotateCenter.clone().sub(this.rotateStart);this.panDelta.addVectors(i,r),this.pan(this.panDelta.x,this.panDelta.y),this.rotateStart=o}.bind(this),i=function(){if(this.noRotateUpDown){var t=new THREE.Vector2(e.touches[0].pageX,e.touches[0].pageY),n=new THREE.Vector2(e.touches[1].pageX,e.touches[1].pageY);this.rotateEndVec.subVectors(t,n);var o=be.getVec2Angle(this.rotateStartVec,this.rotateEndVec),i=new THREE.Vector3(this.rotateEndVec.x,this.rotateEndVec.y,0),r=new THREE.Vector3(this.rotateStartVec.x,this.rotateStartVec.y,0);return i.clone().cross(r).z<0&&(o*=-1),this.rotateLeft(o),this.rotateStartVec.copy(this.rotateEndVec),o}this.rotateEnd.set(se.average(e.touches,"pageX"),se.average(e.touches,"pageY")),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateLeft(2*Math.PI*this.rotateDelta.x/this.player.domElement.clientWidth*this.rotateSpeed),this.rotateUp(2*Math.PI*this.rotateDelta.y/this.player.domElement.clientHeight*this.rotateSpeed),this.rotateStart.copy(this.rotateEnd)}.bind(this);switch(this.state){case Ra:t();case ka:n();break;case Ma:o(t(),i());break;case Pa:t();break;case Ta:i();break;default:this.state=xa}this.lastMoveTime=e.timeStamp,this.emit(bi,"touch")}}},{key:"onTouchEnd",value:function(e){this.enabled&&(this.state===Ta&&(e.timeStamp>this.lastMoveTime+100?(this.rotationSpeed.set(0,0),this.rotationAcceleration.set(0,0)):this.rotationAcceleration.set(-this.rotateDelta.x,this.rotateDelta.y)),this.state=xa,this.update(),this.rotationAcceleration.set(0,0),this.rotateDelta.set(0,0))}},{key:"onPointerDown",value:function(e){this.enabled&&("touch"===e.pointerType&&(this.pointers.length<this.pointersLimit&&!this.pointers.find((function(t){return t.id==e.pointerId}))&&this.pointers.push({id:e.pointerId,pageX:e.pageX,pageY:e.pageY}),e.touches=this.pointers,this.onTouchStart(e)),this.emit(Ti,"pointer"))}},{key:"onPointerMove",value:function(e){this.enabled&&"touch"===e.pointerType&&(this.pointers.forEach((function(t){e.pointerId===t.id&&(t.pageX=e.pageX,t.pageY=e.pageY,t.pressed=e.pressed)})),e.touches=this.pointers,this.onTouchMove(e))}},{key:"onPointerUp",value:function(e){this.enabled&&"touch"===e.pointerType&&(this.pointers=this.pointers.filter((function(t){return t.id!=e.pointerId})),e.touches=this.pointers,this.onTouchEnd(e))}},{key:"reset",value:function(){this.state=xa,this.stopAutoPanning(),this.rotationSpeed.set(0,0),this.rotationAcceleration.set(0,0),this.panSpeed.set(0,0),this.panAcceleration.set(0,0)}},{key:"toJSON",value:function(){return{camera_position:{x:be.toPrecision(this.camera.position.x,4),y:be.toPrecision(this.camera.position.y,4),z:be.toPrecision(this.camera.position.z,4)},camera_quaternion:{x:be.toPrecision(this.camera.quaternion.x,4),y:be.toPrecision(this.camera.quaternion.y,4),z:be.toPrecision(this.camera.quaternion.z,4),w:be.toPrecision(this.camera.quaternion.w,4)}}}}]),n}();function Ca(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Aa=function(e){f(n,e);var t=Ca(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this,e,o,r)).minPolarAngle=He.dollhouseDefault.minPolarAngle,a.maxPolarAngle=He.dollhouseDefault.maxPolarAngle,a.minDistance=He.dollhouseDefault.minDistance,a.maxDistance=He.dollhouseDefault.maxDistance,a.adjustedMinDistance=a.minDistance,a.adjustedMaxDistance=a.maxDistance,a.dom=o,a}return u(n,[{key:"pan",value:function(e,t){this.camera.updateMatrix();var n=this.camera.position.clone().sub(this.target).length();n*=Math.tan(this.camera.fov/2*Math.PI/180),this.panLeft(2*e*n/this.player.domElement.clientWidth),this.panUp(-2*t*n/this.player.domElement.clientHeight)}},{key:"updateZoom",value:function(){return this.offset.length()*this.scale}},{key:"setZoomBounds",value:function(e){var t=e.min.distanceTo(e.max);this.adjustedMinDistance=Math.max(Math.min(t/2,He.dollhouseDefault.minDistance),0),this.adjustedMaxDistance=Math.min(Math.max(t,He.dollhouseDefault.maxDistance),He.skyboxRadius),this.minDistance=this.adjustedMinDistance,this.maxDistance=this.adjustedMaxDistance}},{key:"resetRanges",value:function(e,t){e?(this.minDistance=Math.min(e,this.minDistance),this.maxDistance=Math.max(e,this.maxDistance)):(this.minDistance=this.adjustedMinDistance,this.maxDistance=this.adjustedMaxDistance),t?(this.minPolarAngle=THREE.Math.degToRad(-15),this.maxPolarAngle=THREE.Math.degToRad(89.9)):(this.minPolarAngle=He.dollhouseDefault.minPolarAngle,this.maxPolarAngle=He.dollhouseDefault.maxPolarAngle)}},{key:"toJSON",value:function(){return Sa.prototype.toJSON.call(this)}}]),n}(Sa);function Da(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var La=function(e){f(n,e);var t=Da(n);function n(e,o,r){var a;return i(this,n),(a=t.call(this,e,o,r)).minDistance=15,a.maxDistance=100,a.noRotateUpDown=!0,a.minPolarAngle=0,a.maxPolarAngle=0,a.mouseActions[ga]=ka,a.mouseActions[ya]=Pa,a.mouseActions[wa]=Ta,a.touchActions[1]=ka,a.touchActions[2]=Ma,a.absoluteScale=1,a.currentScale=1,a.dom=o,a.$app=r.$app,a.plane=null,a.cadSize=null,a.floorTexture=null,a}return u(n,[{key:"zoomToContain",value:function(e,t){var n=this.getDefaultAbsoluteScale(e,t);this.absoluteScale=n,this.currentScale=this.absoluteScale}},{key:"getDefaultAbsoluteScale",value:function(e,t,n){null!=n&&void 0!==n||(n=this.$app.store.getValue("metadata").floorPlanAngle,n=parseFloat(n)),e=e.clone().applyEuler(new THREE.Euler(0,n,0));var o=Math.max(Math.abs(e.x),Math.abs(e.z)*this.camera.aspect),i=Math.min(window.innerWidth-400,window.innerHeight-200);return t=null!=t&&null!=t?t:Math.max(2*i/800,2),o/2/He.orthoBase*t}},{key:"rotateToView",value:function(e,t){var n=0,o=Ce.aspectRatio()<1,i=e.x<e.z,r=this.$app.store.getValue("metadata");n=void 0!==r.floorPlanAngle?-1*parseFloat(r.floorPlanAngle):o===i?0:Math.PI/2,this.rotateLeft(n),this.update(0)}},{key:"pan",value:function(e,t){this.camera.updateMatrix(),this.panLeft(e*(this.camera.right-this.camera.left)/this.player.domElement.clientWidth),this.panUp(-t*(this.camera.top-this.camera.bottom)/this.player.domElement.clientHeight)}},{key:"updateZoom",value:function(){this.absoluteScale*=this.scale-.03*this.keyboardZoomSpeed,this.absoluteScale=Math.max(He.zoomNearLimit,Math.min(this.absoluteScale,He.zoomFarLimit)),this.currentScale=.8*this.currentScale+.2*this.absoluteScale;var e=this.snapshotTopAspect?this.camera.aspect/this.snapshotTopAspect:1;return this.camera.left=-He.orthoBase*this.currentScale*e,this.camera.right=He.orthoBase*this.currentScale*e,this.camera.top=He.orthoBase*this.currentScale*e/this.camera.aspect,this.camera.bottom=-He.orthoBase*this.currentScale*e/this.camera.aspect,this.camera.updateProjectionMatrix(),this.offset.length()}},{key:"updateDirect",value:function(e){e.floorPlanAngle||(e.floorPlanAngle=0),this.camera.left=-e.width/2,this.camera.right=e.width/2,this.camera.top=e.height/2,this.camera.bottom=-e.height/2,this.camera.updateProjectionMatrix(),this.camera.rotation.set(-Math.PI/2,0,e.floorPlanAngle);var t=new THREE.Vector2(e.defaultCenter.x,-e.defaultCenter.y),n=(new THREE.Vector2).copy(e.center).rotateAround(t,-e.floorPlanAngle);this.camera.position.setX(n.x),this.camera.position.setZ(n.y),this.updateForCad=!0}},{key:"updateForRotateCad",value:function(e){e.floorPlanAngle||(e.floorPlanAngle=0),this.camera.rotation.set(-Math.PI/2,0,e.floorPlanAngle);var t=new THREE.Vector2(e.defaultCenter.x,-e.defaultCenter.y),n=(new THREE.Vector2).copy(e.center).rotateAround(t,-e.floorPlanAngle);this.camera.position.setX(n.x),this.camera.position.setZ(n.y);var o=this.$app.core.get("Player").model;this.absoluteScale=this.getDefaultAbsoluteScale(o.size,null,e.floorPlanAngle),this.currentScale=this.absoluteScale;var i=this.snapshotTopAspect?this.camera.aspect/this.snapshotTopAspect:1;this.camera.left=-He.orthoBase*this.currentScale*i,this.camera.right=He.orthoBase*this.currentScale*i,this.camera.top=He.orthoBase*this.currentScale*i/this.camera.aspect,this.camera.bottom=-He.orthoBase*this.currentScale*i/this.camera.aspect,this.camera.updateProjectionMatrix(),this.updateForCad=!0}},{key:"recoverToUpdate",value:function(){this.updateForCad=!1,this.target.copy(this.camera.position),this.target.setY(this.camera.position.y-1);var e=this.$app.store.getValue("metadata"),t=parseFloat(e.floorPlanAngle||0);this.thetaDelta=t,this.absoluteScale=this.currentScale=this.camera.right/He.orthoBase,this.update(1)}},{key:"toJSON",value:function(){var e=new THREE.Quaternion,t=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(90)),n=new THREE.Quaternion;return function(){var o=Sa.prototype.toJSON.call(this);return e.copy(o.camera_quaternion),n.copy(t),n.multiply(e),o.camera_quaternion.x=math.toPrecision(n.x,4),o.camera_quaternion.y=math.toPrecision(n.y,4),o.camera_quaternion.z=math.toPrecision(n.z,4),o.camera_quaternion.w=math.toPrecision(n.w,4),o.ortho_zoom=math.toPrecision(this.currentScale*this.camera.aspect,4),o}}}]),n}(Sa);function za(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}me("CameraControls",(function(){return function(e){f(n,EventEmitter);var t=za(n);function n(){var e;return i(this,n),(e=t.call(this)).activeControl=null,e.controls={},e.cameras={},e}return u(n,[{key:"init",value:function(e,t){this.setUpControls(e,t),this.bindEvents(e)}},{key:"activateControls",value:function(e){this.activeControl&&(this.activeControl.reset(),this.activeControl.enabled=!1),this.controls[e]&&(this.controls[e].enabled=!0),this.activeControl=this.controls[e]}},{key:"setUpControls",value:function(e,t){var n={},o={},i=(t=t||[Oe.PANORAMA,Oe.DOLLHOUSE,Oe.FLOORPLAN],[da,fa,va]),r=[Ea,Aa,La];t.forEach(function(t,a){n[t]=new i[a](e),o[t]=new r[a](n[t],e,this.$app.core.get("Player")),o[t].on(bi,this.emit.bind(this,bi)),o[t].on(Ti,this.emit.bind(this,Ti)),o[t].on(Ei,this.emit.bind(this,Ei)),o[t].on(xi,this.emit.bind(this,xi)),o[t].on(Pi,this.emit.bind(this,Pi)),o[t].on(ki,this.emit.bind(this,ki))}.bind(this)),this.controls=o,this.cameras=n}},{key:"bindEvents",value:function(e){var t=this;e.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("mouseup",this.onMouseUp.bind(this)),e.addEventListener("mouseover",this.onMouseOver.bind(this)),He.useWheel&&(e.addEventListener("mousewheel",this.onMouseWheel.bind(this),{passive:!1}),e.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),{passive:!1})),e.addEventListener("touchstart",this.onTouchStart.bind(this),{passive:!1}),e.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!1}),e.addEventListener("touchend",this.onTouchEnd.bind(this)),e.addEventListener("contextmenu",(function(e){e.preventDefault()})),e.addEventListener("pointerdown",this.onPointerDown.bind(this)),e.addEventListener("pointermove",this.onPointerMove.bind(this)),e.addEventListener("pointerup",this.onPointerUp.bind(this)),e.addEventListener("pointerout",this.onPointerCancel.bind(this)),e.addEventListener("pointercancel",this.onPointerCancel.bind(this)),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),this.$app.core.get("ModelManager").on(Oi,function(e){this.setModelForControls(e.model)}.bind(this)),this.on("syncCadAnd3D",(function(e){t.controls[Oe.FLOORPLAN].updateDirect(e)})),this.on("syncCadAnd3DForRotate",(function(e){t.controls[Oe.FLOORPLAN].updateForRotateCad(e)}))}},{key:"setModelForControls",value:function(e){this.controls[Oe.DOLLHOUSE].setZoomBounds(e.boundingBox);var t=e.boundingBox.clone().expandByScalar(He.modelBoundsPadding);[Oe.DOLLHOUSE,Oe.FLOORPLAN].forEach(function(e){this.controls[e].setBounds(t)}.bind(this))}},{key:"onMouseDown",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onMouseDown(e)}},{key:"onMouseMove",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onMouseMove(e)}},{key:"onMouseUp",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onMouseUp(e)}},{key:"onMouseOver",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onMouseOver(e)}},{key:"onMouseWheel",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onMouseWheel(e)}},{key:"onTouchStart",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onTouchStart(e)}},{key:"onTouchMove",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onTouchMove(e)}},{key:"onTouchEnd",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onTouchEnd(e)}},{key:"onPointerDown",value:function(e){if(e.preventDefault(),this.activeControl)switch(e.pointerType){case"mouse":this.activeControl.onMouseDown(e);break;default:this.activeControl.onPointerDown(e)}}},{key:"onPointerMove",value:function(e){if(e.preventDefault(),this.activeControl)switch(e.pointerType){case"mouse":this.activeControl.onMouseMove(e);break;default:this.activeControl.onPointerMove(e)}}},{key:"onPointerUp",value:function(e){if(e.preventDefault(),this.activeControl){switch(e.pointerType){case"mouse":this.activeControl.onMouseUp(e);break;default:this.activeControl.onPointerUp(e)}this.emit("pointerUp")}}},{key:"onPointerCancel",value:function(e){e.preventDefault(),this.activeControl&&"mouse"!==e.pointerType&&this.activeControl.onPointerUp(e)}},{key:"onKeyDown",value:function(e){this.$app.config.useShortcutKeys&&(e.metaKey||e.ctrlKey||(e.preventDefault(),this.activeControl&&this.activeControl.onKeyDown(e)))}},{key:"onKeyUp",value:function(e){e.preventDefault(),this.activeControl&&this.activeControl.onKeyUp(e)}}]),n}()}));var Va="panovideo.canplay",Ha="panovideo.start",Oa="panovideo.resume",Fa="panovideo.pause",Na="panovideo.stop",Ba="panovideo.switch";function ja(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ua(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ua(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,i=function(){};return{s:i,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,r=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw r}}}}function Ua(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function _a(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Wa=function(e){f(n,EventEmitter);var t=_a(n);function n(e,o){var r;return i(this,n),(r=t.call(this)).domElement=e,r.os="",r.environment="",r._resource=new Map,o.forEach((function(e,t){var n=r._createVideoElement(e.mp4.url,0==r._resource.size);r._resource.set(t,{url:e.mp4.url,video:n,texture:r._createTexture(n),loaded:!0})})),r.video=null,r.texture=new THREE.VideoTexture,r.texture.minFilter=THREE.LinearFilter,r.isFirstPlay=!0,r.isMuted=!0,r}return u(n,[{key:"_createTexture",value:function(e){var t=new THREE.VideoTexture(e);return t.minFilter=THREE.LinearFilter,t.uploaded=!1,t}},{key:"_createVideoElement",value:function(e){var t;if((t=document.createElement("video")).setAttribute("crossOrigin","anonymous"),t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("x5-video-player-type","h5"),t.setAttribute("controls","true"),t.autoplay=!1,t.muted=this.isMuted,t.loop=!0,t.src=e,t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.zIndex="1000",t.style.width="300px",t.style.height="300px",t.style.display=Ce.urlHasValue("debug")?"block":"none",this.domElement.appendChild(t),!n.videoReady){n.videoReady=!0,window.listener=window.document.body,window.listener.addEventListener("touchstart",(function e(){t.play(),t.pause(),window.listener.removeEventListener("touchstart",e,!1)}),!1)}return t}},{key:"_onCanPlay",value:function(){this.emit(Va)}},{key:"_onPlaying",value:function(){var e=this;this.emit(Ba,this.texture),this.video.ontimeupdate=function(t){e.video.currentTime>.5&&(e.emit(Oa),e.video.ontimeupdate=null,e.isFirstPlay=!1)},this.isFirstPlay&&this.emit(Ha)}},{key:"_onPause",value:function(e){this.video&&(this.video._isPaused=!0),this.emit(Fa)}},{key:"preload",value:function(e){var t=this;if(e!=this.video&&!e._isPrepload){e.muted=!0;try{top.WeixinJSBridge&&top.WeixinJSBridge.invoke("getNetworkType",{},(function(t){e.play()}),!1)}catch(t){e.play()}e.onplaying=function(){e.pause(),e._isPrepload=!0,t.video&&!t.video._isPaused&&t.video.play()}}}},{key:"preloadAll",value:function(){this.video&&(this.video._isPaused=this.video.paused);var e,t=ja(this._resource.values());try{for(t.s();!(e=t.n()).done;){var n=e.value;this.preload(n.video)}}catch(e){t.e(e)}finally{t.f()}}},{key:"preloadPano",value:function(e){var t=this._resource.get(e.id);t&&this.preload(t.video)}},{key:"startVideo",value:function(e){var t=this._resource.get(e);t&&(t.video.autoplay=!0,t.video.onplaying=this._onPlaying.bind(this),t.video.onpause=this._onPause.bind(this),t.video.oncanplay=this._onCanPlay.bind(this),this.video=t.video,this.texture=t.texture,this.video.paused?this.play(this.video):this._onPlaying())}},{key:"pauseVideo",value:function(e){var t=this._resource.get(e);t&&(t.video.pause(),t.video.muted=!0,t.video.onplaying=null)}},{key:"play",value:function(e){if(this.isFirstPlay||!e._isCanplay)if(Ce.detectWeixin())try{top.WeixinJSBridge&&top.WeixinJSBridge.invoke("getNetworkType",{},(function(t){e.play(),e._isCanplay=!0}),!1)}catch(t){e.play(),e._isCanplay=!0}else e.play(),e._isCanplay=!0,Ce.detectAndroidMobile()?this.domElement.addEventListener("touchend",this.onDomElementTouchEnd.bind(this)):Ce.detectIOS()?this.domElement.addEventListener("touchstart",this.onDomElementTouchStart.bind(this)):this.domElement.addEventListener("mousedown",this.onDomElementMouseDown.bind(this));else e.play()}},{key:"pause",value:function(){this.video&&(this.video._isPaused=!0,this.video.pause())}},{key:"resume",value:function(){this.video?(this.play(this.video),this.video.onplaying=this._onPlaying.bind(this)):console.warn("PanoVideoRenderer: 没有可播放的视频")}},{key:"setMuted",value:function(e){var t,n=ja(this._resource.values());try{for(n.s();!(t=n.n()).done;){t.value.video.muted=e}}catch(e){n.e(e)}finally{n.f()}this.isMuted=e}},{key:"onDomElementTouchStart",value:function(){this.isMuted||(this.video.muted=!1,this.domElement.removeEventListener("touchstart",this.onDomElementTouchStart))}},{key:"onDomElementTouchEnd",value:function(){this.isMuted||(this.video.muted=!1,this.domElement.removeEventListener("touchend",this.onDomElementTouchEnd))}},{key:"onDomElementMouseDown",value:function(){this.isMuted||(this.video.muted=!1,this.domElement.removeEventListener("mousedown",this.onDomElementMouseDown))}}]),n}();function Za(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Qa(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Qa(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,i=function(){};return{s:i,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,r=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw r}}}}function Qa(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function Ga(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}Wa.videoReady=!1;var qa,Ya,$a=function(e){f(n,EventEmitter);var t=Ga(n);function n(e,r){var a;return i(this,n),(a=t.call(this)).domElement=e,a.instances=new Map,r.forEach((function(e,t){a.instances.set(t,a._createVideo(e.flv.url))})),a.video=null,a.texture=new o.VideoTexture,a.texture.minFilter=o.LinearFilter,a.isFirstPlay=!0,a.isMuted=!0,a}return u(n,[{key:"_createVideo",value:function(e){var t=document.createElement("video");t.setAttribute("crossOrigin","anonymous"),t.setAttribute("playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("controls","true"),t.autoplay=!1,t.muted=!0,t.loop=!0,t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.zIndex="1000",t.style.width="200px",t.style.display=Ce.urlHasValue("debug")?"block":"none",this.domElement.appendChild(t);var n=flvjs.createPlayer({type:"flv",url:e},{lazyLoad:!0,lazyLoadMaxDuration:5});return n.videoElement=t,n.attachMediaElement(t),n.on(flvjs.Events.ERROR,this._onPlayerError.bind(this)),n}},{key:"_onPlayerError",value:function(e){console.warn("球幕视频资源加载错误:",e)}},{key:"_onPlaying",value:function(){var e=this;this.emit(Ba,this.texture),this.video.ontimeupdate=function(t){e.video.currentTime>.2&&(e.emit(Oa),e.isFirstPlay&&e.emit(Ha),e.isFirstPlay=!1,e.video.ontimeupdate=null)}}},{key:"_onPause",value:function(){this.emit(Fa),this.state=0}},{key:"preloadPano",value:function(e){var t=this.instances.get(e.id);t&&0==t.buffered.length&&t.load()}},{key:"startVideo",value:function(e){var t=this.instances.get(e);t&&(0==t.buffered.length&&t.load(),this.video=t.videoElement,this.video.onplaying=this._onPlaying.bind(this),this.video.onpause=this._onPause.bind(this),this.texture.image=this.video,this.video.paused?this.play(this.video):this._onPlaying())}},{key:"pauseVideo",value:function(e){var t=this.instances.get(e);t&&(t.videoElement.pause(),t.videoElement.onplaying=null)}},{key:"play",value:function(e){this.isFirstPlay?(e.play(),Ce.detectAndroidMobile()?this.domElement.addEventListener("touchend",this.onDomElementTouchEnd.bind(this)):Ce.detectIOS()?this.domElement.addEventListener("touchstart",this.onDomElementTouchStart.bind(this)):this.domElement.addEventListener("mousedown",this.onDomElementMouseDown.bind(this))):e.play()}},{key:"pause",value:function(){this.video&&this.video.pause()}},{key:"resume",value:function(){this.video?this.play(this.video):console.warn("FlvVideoPlayer: 没有可播放的视频")}},{key:"setMuted",value:function(e){var t,n=Za(this.instances.values());try{for(n.s();!(t=n.n()).done;){t.value.videoElement.muted=e}}catch(e){n.e(e)}finally{n.f()}this.isMuted=e}},{key:"onDomElementTouchStart",value:function(){this.setMuted(!1),this.domElement.removeEventListener("touchstart",this.onDomElementTouchStart)}},{key:"onDomElementTouchEnd",value:function(){this.setMuted(!1),this.domElement.removeEventListener("touchstart",this.onDomElementTouchEnd)}},{key:"onDomElementMouseDown",value:function(){this.setMuted(!1),this.domElement.removeEventListener("mousedown",this.onDomElementMouseDown)}}]),n}();function Xa(){Ya={version:1,upPath:"",videoPath:qa.resource.getViewResourceURL("video/"),videoInfos:new Map,parameters:{inputWidth:0,inputHeight:0,outputWidth:0,outputHeight:0,focal:0,pixel:0,centerX:0,centerY:0,translateX:0,translateY:0,translateZ:0,lenOffsetX:0,lenOffsetY:0,videoWidth:0,videoHeight:0,mapping:0,cameraType:0,blend_fov:5}}}var Ja=null;function Ka(e,t,n){t&&(JSON.parse(t).forEach((function(t){e.videoInfos.set(t.panoId,{dir:(new THREE.Vector3).copy(t.dir),hfov:parseFloat(t.hfov),vfov:parseFloat(t.vfov),mp4:{url:e.videoPath+t.panoId+"-user.mp4"+n},mpeg:{url:e.videoPath+t.panoId+"-user.ts",size:t.tsSize+n},flv:{url:e.videoPath+t.panoId+"-user.flv"+n},exposure:1,clipRect:t.rect,mapping:2})})),e.parameters.mapping=2,e.parameters.cameraType=8)}var es={handle:function(e,t){qa=t,Ya||Xa();var n="";if(void 0!==e.version&&(n="?imagesVersion="+e.version),!e.videos)return e.videos={version:Ya.version,videos:Ya.videoInfos,parameters:Ya.parameters},void Ka(Ya,e.videosUser,n);try{var o=e.videos;if(!o.data||!o.data.length)return e.videos={version:Ya.version,videos:Ya.videoInfos,parameters:Ya.parameters},void Ka(Ya,e.videosUser,n)}catch(e){console.error(e)}var i,r=e.sceneFrom||"pro";if("pro"==r){var a=e.videos,s=a.version||0;return Ya.version=s,Ya.parameters.cameraType=8,1==s?a.data.forEach((function(e){Ya.videoInfos.set(e.id,{mp4:{url:Ya.videoPath+e.id+".mp4"+n},mpeg:{url:Ya.videoPath+e.id+".ts",size:e.tsSize+n},flv:{url:Ya.videoPath+e.id+".flv"+n},exposure:Number(e.value)||1,mapping:0,cameraType:8,blend_fov:e.blend_fov||5})})):s>1&&a.data.forEach((function(e){Ya.videoInfos.set(e.id,{mp4:{url:Ya.videoPath+e.id+".mp4"+n},mpeg:{url:Ya.videoPath+e.id+".ts"+n,size:e.tsSize},flv:{url:Ya.videoPath+e.id+".flv"+n},exposure:Number(e.value)||1,mapping:1,cameraType:8,blend_fov:e.blend_fov||5})})),(i=a.upPath,Ja||(Ja=new Promise((function(e,t){i||t("找不到参数请求地址"),Mn.getText(i).then((function(t){return e(t)})).catch((function(e){return t(e)}))})).then((function(e){var t=e.split(/\n/).filter((function(e){return""!=e.trim()})).map((function(e){return e.split(":")})),n=Number(t[0][1]),o=Number(t[1][1]),i=t[2][1].trim().split(/\s+/).map((function(e){return Number(e)})),r=t[7][0].trim().split(/\s+/).map((function(e){return Number(e)}))[3],a=t[8][0].trim().split(/\s+/).map((function(e){return Number(e)}))[3],s=t[9][0].trim().split(/\s+/).map((function(e){return Number(e)}))[3];return Ya.parameters.focal=n,Ya.parameters.pixel=o,Ya.parameters.centerX=i[0],Ya.parameters.centerY=i[1],Ya.parameters.translateX=r,Ya.parameters.translateY=a,Ya.parameters.translateZ=s,Ya})).catch((function(e){return console.warn("球幕视频【八目】：参数文件加载失败",e),Ya})).finally((function(){return Ya})))).then((function(t){return s<=2?(t.parameters.inputWidth=2304,t.parameters.inputHeight=1728,t.parameters.outputWidth=2048,t.parameters.outputHeight=1024):s>2&&(t.parameters.inputWidth=4608,t.parameters.inputHeight=3456,t.parameters.outputWidth=8192,t.parameters.outputHeight=4096,t.parameters.lenOffsetX=1235,t.parameters.lenOffsetY=954,t.parameters.videoWidth=2112,t.parameters.videoHeight=1584,t.parameters.mapping=1),e.videos={version:t.version,videos:t.videoInfos,parameters:t.parameters},Ka(t,e.videosUser,n),t})).catch((function(e){throw e}))}if("lite"==r){var l=e.videos,c=l.version||0;Ya.version=c,Ya.parameters.cameraType=2;var u="";return void 0!==e.version&&(u="?imagesVersion="+e.version),1==c&&l.data.forEach((function(e){Ya.videoInfos.set(e.id,{mp4:{url:Ya.videoPath+e.id+".mp4"+u},mpeg:{url:Ya.videoPath+e.id+".ts",size:e.tsSize+u},flv:{url:Ya.videoPath+e.id+".flv"+u},exposure:Number(e.value)||1,mapping:1,cameraType:2,blend_fov:e.blend_fov||5})})),function(e){return Ja||(Ja=new Promise((function(t,n){e||n("找不到参数请求地址"),Mn.getText(e,null,(function(e){t(e)}),(function(e){n(e)}))})).then((function(e){var t={};return e.split("\n").map((function(e){if(e.length>0){var n=e.split(":"),o=n[0],i=n[1].trim().split(" ");t[o]=Number(i[0])}})),Ya.parameters.focal=t.focal,Ya.parameters.centerX=t.cx,Ya.parameters.centerY=t.cy,Ya.parameters.translateX=t.tx,Ya.parameters.translateY=t.ty,Ya.parameters.translateZ=t.tz,Ya})).catch((function(e){return console.warn("球幕视频【双目】：参数文件加载失败"),Ya})).finally((function(){return Ya})))}(l.upPath).then((function(t){return 1==c&&(t.parameters.inputWidth=3e3,t.parameters.inputHeight=3e3,t.parameters.outputWidth=4096,t.parameters.outputHeight=2048,t.parameters.pixel=1.12),e.videos={version:t.version,videos:t.videoInfos,parameters:t.parameters},t})).catch((function(e){throw e}))}if("minion"==r){var h=e.videos,d=h.version||0;Ya.version=d,Ya.parameters.cameraType=3;var p="";return void 0!==e.version&&(p="?imagesVersion="+e.version),h.data.forEach((function(e){Ya.videoInfos.set(e.id,{mp4:{url:Ya.videoPath+e.id+".mp4"+p},mpeg:{url:Ya.videoPath+e.id+".ts",size:e.tsSize+p},flv:{url:Ya.videoPath+e.id+".flv"+p},exposure:Number(e.value)||1,mapping:1,cameraType:3,blend_fov:e.blend_fov||5})})),function(e){return Ja||(Ja=new Promise((function(t,n){e||n("找不到参数请求地址"),t(Mn.getText(e))})).then((function(e){var t={};return e.split("\n").map((function(e){if(e.length>0){var n=e.split(":"),o=n[0],i=n[1].trim().split(" ");t[o]=Number(i[0])}})),Ya.parameters.focal=t.focal,Ya.parameters.centerX=t.cx,Ya.parameters.centerY=t.cy,Ya.parameters.translateX=t.rx,Ya.parameters.translateY=t.ry,Ya.parameters.translateZ=t.rz,Ya})).catch((function(e){return console.warn("球幕视频【转台】：参数文件加载失败",e),Ya})).finally((function(){return Ya})))}(h.upPath).then((function(t){return t.parameters.inputWidth=5472,t.parameters.inputHeight=3648,t.parameters.outputWidth=4096,t.parameters.outputHeight=2048,t.parameters.lenOffsetX=920,t.parameters.lenOffsetY=500,t.parameters.videoWidth=3630,t.parameters.videoHeight=2670,t.parameters.pixel=1.12,e.videos={version:t.version,videos:t.videoInfos,parameters:t.parameters},Ka(t,e.videosUser,p),t})).catch((function(e){throw e}))}console.warn("有尚不支持的相机来源：",r)},getEnvironment:function(){Ya||Xa();var e="PC",t="H5";return Ce.detectAndroidMobile()?e="Android":Ce.detectIOS()&&(e="Ios"),Ce.detectWeixin()&&(t="WeChat",navigator.userAgent.match("miniProgram")&&(t="WeChatMiniprogram")),{os:e,environment:t}}},ts=0,ns=1;function os(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}function is(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}me("PanoVideoRenderer",(function(){return function(e){f(n,EventEmitter);var t=os(n);function n(){var e;i(this,n),e=t.call(this),window.panoVideoRenderer=h(e),e.version=1,e.videoPlayer=null,e.activePanorama=null,e.nearestPano=null,e.ready=!1,e._state=ts,e.texture=null,e.isGuiding=!1,e.isRecording=!1,e.isSoundRecording=!1,e.loadingAnimEnable=!0,e.loadingTimeStamp=0,e.loadingUITimer=0,e.loadingUIAnimHandler=0;var o=THREE.UniformsUtils.clone(Ht.videoLoading.uniforms);return o.uColor.value=new THREE.Vector4(0,.7843137254901961,.6862745098039216,.7),e.loadingUI=new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),new THREE.RawShaderMaterial({uniforms:o,vertexShader:Ht.videoLoading.vertexShader,fragmentShader:Ht.videoLoading.fragmentShader,transparent:!0})),e.loadingUI.visible=!1,e}return u(n,[{key:"init",value:function(e){var t=this;this.videosInfo=e,e?(this.version=e.version,this.initVideoPlayer(this.$app.dom,this.version,e.videos),this.$app.core.get("Player").on("guide/play/start",(function(e){t.isGuiding=!0,t.setMuted(!0)})),this.$app.core.get("Player").on("guide/play/pause",(function(e){t.isGuiding=!1,t.setMuted(!1)})),this.$app.core.get("Player").on("guide/play/stop",(function(e){t.isGuiding=!1,t.setMuted(!1)})),this.ready=!0,(Ce.detectIE()||navigator.userAgent.match("JSN-AL00"))&&(this.ready=!1,console.warn("浏览器不支持球幕视频")),this.$app.core.get("SceneRenderer").scene.add(this.loadingUI)):ke.warn("PanoVideoRenderer初始化失败,数据为空")}},{key:"initVideoPlayer",value:function(e,t,n){var o=es.getEnvironment(),i=o.os,r=o.environment;this.videoPlayer="Android"==i&&"WeChat"==r?new $a(e,n):new Wa(e,n),this.videoPlayer.on(Va,this.onVideoCanPlay.bind(this)),this.videoPlayer.on(Ha,this.onVideoStartPlay.bind(this)),this.videoPlayer.on(Ba,this.onVideoSwitch.bind(this)),this.videoPlayer.on(Oa,this.onVideoResume.bind(this)),this.videoPlayer.on(Fa,this.onVideoPause.bind(this)),this.videoPlayer.on(Na,this.onVideoStop.bind(this))}},{key:"activatePanorama",value:function(e){var t=this;e.hasVideo&&this.ready&&(this.activePanorama=e,this.started=!0,this.videoPlayer.startVideo(e.id),this.loadingUITimer=setTimeout((function(){t.showLoading(e),window.clearTimeout(t.loadingUITimer)}),500))}},{key:"deactivePanorama",value:function(e){null!=e&&null!=e.id&&this.videoPlayer.pauseVideo(e.id),this.activePanorama=null}},{key:"getActivePanorama",value:function(){return this.activePanorama}},{key:"showLoading",value:function(e){if(this.loadingAnimEnable){var t=(new THREE.Vector3).copy(e.position),n=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(this.$app.core.get("Player").model.supportsTiles?90:180)),o=new THREE.Vector3(0,0,-1).applyQuaternion(n.multiply(e.quaternion));this.loadingUI.position.copy(t).add(o),this.loadingUI.lookAt(t),this.loadingTimeStamp=performance.now(),this.loadingAnimte(0)}}},{key:"hideLoading",value:function(){this.loadingUI.visible=!1,window.cancelAnimationFrame(this.loadingUIAnimHandler),window.clearTimeout(this.loadingUITimer)}},{key:"loadingAnimte",value:function(e){this.loadingUI.material.uniforms.uTime.value=performance.now()-this.loadingTimeStamp,this.loadingUIAnimHandler=window.requestAnimationFrame(this.loadingAnimte.bind(this))}},{key:"suspend",value:function(){if(!this.ready)return!1;this.videoPlayer.pause(),this.emit(ra)}},{key:"resume",value:function(){if(!this.ready)return!1;this.videoPlayer.resume()}},{key:"canPhonate",value:function(){return 0==this.isGuiding&&0==this.isRecording&&0==this.isSoundRecording}},{key:"setMuted",value:function(e){this.videoPlayer&&(this.canPhonate()||(e=!0),this.videoPlayer.setMuted(e))}},{key:"getState",value:function(){return this._state}},{key:"onVideoPanoramasEnter",value:function(e,t){}},{key:"onVideoPanoramasExit",value:function(e){}},{key:"onVideoCanPlay",value:function(){this.emit(la)}},{key:"onVideoStartPlay",value:function(){this.emit(ca)}},{key:"onVideoSwitch",value:function(e){this.texture=e,this.emit(sa,e)}},{key:"onVideoResume",value:function(){this._state=ns,this.emit(aa),this.hideLoading()}},{key:"onVideoPause",value:function(){this._state=ts,this.emit(ra)}},{key:"onVideoStop",value:function(){this._state=ts,this.emit(ra)}},{key:"ifEnable",value:function(){return this.ready}}]),n}()})),me("DisplayController",(function(){return function(e){f(n,EventEmitter);var t=is(n);function n(e){var o;return i(this,n),(o=t.call(this)).fadeInSpeed=e,null!==o.fadeInSpeed&&void 0!==o.fadeInSpeed||(o.fadeInSpeed=0),o.panoVideoRenderer=null,o}return u(n,[{key:"init",value:function(){this.container=this.$app.core.get("Player").domElement,this.panoVideoRenderer=this.$app.core.get("PanoVideoRenderer"),this.updateModel(),this.bindEvents()}},{key:"bindEvents",value:function(){this.$app.core.get("Player").on(ni,this.handlePlayerFlyingStarted.bind(this)),this.$app.core.get("Player").on(oi,this.handlePlayerFlyingEnded.bind(this)),this.$app.core.get("Player").on(Jo,this.handlePlayerModeChanging.bind(this)),this.$app.core.get("Player").on(Xo,this.handlePlayerModeChanged.bind(this)),this.$app.core.get("Player").on(ei,this.handleClosestPanoChanging.bind(this)),this.$app.core.get("Player").on(ri,this.handleStartInside.bind(this)),this.$app.core.get("Player").on(ai,this.handleStartOutside.bind(this))}},{key:"updateModel",value:function(){this.model=this.$app.core.get("ModelManager").getActiveModel()}},{key:"handlePlayerFlyingStarted",value:function(e){var t=this.model.panos.index[e.lastPanoId];this.panoVideoRenderer.deactivePanorama(t),this.panoVideoRenderer.setMuted(!0)}},{key:"handlePlayerFlyingEnded",value:function(e){var t=e.targetPano;this.panoVideoRenderer.setMuted(!1),t&&this.model.mode==Oe.PANORAMA&&this.panoVideoRenderer.activatePanorama(t)}},{key:"handlePlayerModeChanging",value:function(e,t,n){var o,i=this.$app.core.get("ModelManager").getActiveModel();o=this.$app.core.get("Player").is360View(t,n)?0:He[t].markerOpacity,i.fadePanoMarkers(o),i.setMode(t)}},{key:"handlePlayerModeChanged",value:function(e,t){var n=this.$app.core.get("ModelManager").getActiveModel(),o=t===Oe.PANORAMA?THREE.DoubleSide:THREE.FrontSide;n.setSide(o),n.setMode(t)}},{key:"handleClosestPanoChanging",value:function(e,t,n){n!==Oe.TRANSITIONING&&(e&&e.hoverOff(n),t&&t.hoverOn(n))}},{key:"handleStartInside",value:function(e){var t=He[this.$app.core.get("Player").mode],n=e?0:t.transitionTime*t.skyboxOpacityLength;this.fadeIn(this.fadeInSpeed),this.model.alpha=0,this.model.skybox.material.uniforms.opacity.value=1,this.model.fadePanoMarkers(null,null,{player:this.$app.core.get("Player")});var o=this.$app.core.get("Player").reticule;Se.start(nt.property(o.material,"opacity",0),n,null,0,null,"retReOpac")}},{key:"handleStartOutside",value:function(e){this.fadeIn(e)}},{key:"fadeIn",value:function(e){null!=e||(e=2e3,logger.warn("DisplayController.fadeIn -> no transition time specified, defaulting to 2000 ms.")),this.model&&(this.model.chunks.forEach((function(e){return e.visible=!0})),this.model.panos.forEach((function(e){return e.updateMakerStyle()})))}}]),n}()})),me("QuickstartManager",(function(){return function(){function e(t,n,o,r,a){i(this,e),this.locked=!1,this.qualityManager=t,this.scene=n,this.camera=o,this.controls=r,this.quickStartcamera=r.camera,this.view=null,this.panoVideoRenderer=a,this.unlockDom=null,this.unlockHanlde=null,this.loadPromise=null,this.ready=!1,this.touchStartPosition=new THREE.Vector2(0,0),this.touchMoveDelta=new THREE.Vector2(0,0),this.touchPrevPosition=new THREE.Vector2(0,0),this.touchMoveOffset=new THREE.Vector2(0,0),this.enter=!1,this.canEnter=!1,this.animFov=null,this.animRotation=null,this.initTarget=new THREE.Vector3(0,0,0),this.enterView={pano:null,quaternion:new THREE.Quaternion,position:new THREE.Vector3,fov:He.insideFOV}}return u(e,[{key:"init",value:function(e,t){if(this.dom=this.$app.core.get("Player").domElement,this.pano=e.pano,this.setSize(window.innerWidth,window.innerHeight),this.initView(e),this.skybox=new THREE.Mesh(new THREE.BoxBufferGeometry(1,1,1),new ho({side:THREE.DoubleSide})),this.skybox.material.uniforms.map.value=e.pano.getSkyboxTexture(),this.skybox.quaternion.copy(e.quaternion),this.scene.add(this.skybox),this.skybox.material.depthTest=!1,this.skybox.material.depthWrite=!1,this.skybox.renderOrder=1e3,this.skybox.name="quickStartSkyBox",this.skybox.material.uniforms.modelAlpha.value=0,this.skybox.position.copy(this.pano.position),this.skybox.visible=!0,this.scene.add(this.skybox),this.pano.attachToPanoVideoRenderer(this.$app.core.get("PanoVideoRenderer")),this.$app.core.get("PanoVideoRenderer").on(ca,this.onVideoStartPlay.bind(this)),this.$app.core.get("PanoVideoRenderer").on(sa,this.onVideoTextureUpdate.bind(this)),this.$app.core.get("PanoVideoRenderer").on(aa,this.onVideoRenderResume.bind(this)),this.$app.core.get("PanoVideoRenderer").on(ra,this.onVideoRenderSuspend.bind(this)),this.$app.core.get("PanoVideoRenderer").videosInfo){var n=this.$app.core.get("PanoVideoRenderer").videosInfo.parameters;this.skybox.material.uniforms.parameters.value.set(n.inputWidth,n.inputHeight,n.outputWidth,n.outputHeight,n.focal,n.pixel,n.centerX,n.centerY,n.translateX,n.translateY,n.translateZ,0,n.lenOffsetX,n.lenOffsetY,n.videoWidth,n.videoHeight),8==n.cameraType?this.skybox.material.defines.HasVideo=8:2==n.cameraType&&(this.skybox.material.defines.HasVideo=2),this.skybox.material.defines.VideoMapping=n.mapping,this.skybox.material.uniforms.videoReady.value=0,this.skybox.material.uniforms.progress.value=1}}},{key:"initView",value:function(e){this.view=e;var t=e.pano;e.mode,e.zoom,e.position,e.quaternion,this.controls.locked=!1,this.controls.camera.position.copy(t.position),this.initTarget.copy(new THREE.Vector3(0,0,-1).applyQuaternion(e.quaternion)).add(e.position),this.controls.lookAt(this.initTarget),this.quickStartcamera.fov=this.view.fov,this.quickStartcamera.aspect=window.innerWidth/window.innerHeight,this.quickStartcamera.updateProjectionMatrix(),this.camera.fov=this.view.fov,this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.position.copy(this.quickStartcamera.position),this.camera.quaternion.copy(this.quickStartcamera.quaternion),this.enterView.pano=t,this.enterView.position.copy(this.view.position),this.enterView.quaternion.copy(this.view.quaternion),this.enterView.fov=this.view.fov,this.controls.update(.016),this.controls.locked=!0,this.controls.limitDownAngel=this.controls.lat,this.view.position.copy(this.quickStartcamera.position),this.view.quaternion.copy(this.quickStartcamera.quaternion)}},{key:"load",value:function(e){var t=this;if(this.loadPromise)return this.loadPromise;var n=this.$app.store.__store.metadata;if(this.view=e,this.view.pano.shouldRedrawOnBaseLoaded=!0,this.view.pano.tiled){this.init(e,n);var o=document.querySelector(".player[name=main]"),i=this.qualityManager.getPanoSize(mt),r=this.qualityManager.getPanoSize(vt),a=zi.getHFOVForCamera(this.quickStartcamera,o.clientWidth,o.clientHeight),s=this.quickStartcamera.fov,l=Fe.FORWARD.clone().applyQuaternion(this.view.quaternion),c=this.view.pano.loadTiledPano(r,l,{hFov:a,vFov:s},!1,!1,!0),u=this.view.pano.loadTiledPano(i,l.clone().negate(),null,!1,!1,!0);this.loadPromise=new Promise((function(e){(t.pano.hasVideo?u:c).then(e)}))}else this.loadPromise=new Promise((function(e){t.pano.hasVideo?t.pano.loadCube("low").then((function(){return e()})):t.pano.loadCube("high").then((function(){return e()}))}));return this.loadPromise.then((function(){t.ready=!0,t.skybox.material.setProjectedPanos(t.pano,t.pano)})),this.loadPromise}},{key:"onVideoStartPlay",value:function(){}},{key:"onVideoTextureUpdate",value:function(e){this.skybox.material.uniforms.videoTexture.value=e}},{key:"onVideoRenderResume",value:function(){this.skybox.material.uniforms.videoReady.value=1,this.$app.Scene.emit("panorama.videorenderer.resumerender")}},{key:"onVideoRenderSuspend",value:function(){this.skybox.material.uniforms.videoReady.value=0,this.$app.Scene.emit("panorama.videorenderer.suspendrender")}},{key:"watingUnlock",value:function(){var e=this;return this.locked=!0,this.controls.locked=!0,new Promise((function(t){e.unlockHanlde=t}))}},{key:"autoUnlock",value:function(){return this.locked=!1,this.app.active=!0,this.controls.locked=!1,this.controls.limitDownAngel=null,this.pano.hasVideo&&Ce.detectIOS()?this.panoVideoRenderer.setMuted(!1):this.panoVideoRenderer.setMuted(!0),this.panoVideoRenderer.activatePanorama(this.pano),Promise.resolve(!0)}},{key:"activate",value:function(){this.panoVideoRenderer.setMuted("0"==Ce.urlQueryValue("sound")),this.panoVideoRenderer.activatePanorama(this.pano)}},{key:"unlock",value:function(e){var t=this;if(this.enter)this.controls.rotationAcc.set(0,0);else{this.enter=!0,this.app.emit("unlock"),this.controls.locked=!1,this.controls.rotationAcc.set(e.x>0?.3:-.3,0),this.controls.limitDownAngel=null,this.animFov&&Se.cancel(this.animFov);try{parent.postMessage({num:config.projectNum,cmd:"unlocking",isParent:top==self},"*")}catch(e){console.error("跨域",e)}this.animFov=Se.start(nt.property(this.quickStartcamera,"fov",70),3e3,(function(){t.unlockHanlde&&t.unlockHanlde(),t.locked=!1,t.enter=!0,t.controls.locked=!1,t.controls.rotationAcc.set(0,0),t.controls.limitDownAngel=null;try{parent.postMessage({num:config.projectNum,cmd:"unlocked",isParent:top==self},"*")}catch(e){console.error("跨域",e)}}),0,Ie.easeOutCubic)}}},{key:"exit",value:function(){this.enter=!1,this.pano.enter(),this.controls.rotationAcc.set(0,0),this.controls.limitDownAngel=null,this.animFov&&Se.cancel(this.animFov),this.app.player.model?this.app.player.flyToPano({pano:this.pano}):this.smoothLookAt(this.initTarget,1e3)}},{key:"smoothLookAt",value:function(e,t){var n=this;t=t||1e3;var o=e.clone().sub(this.controls.camera.position).normalize(),i=this.controls.lookVector.clone(),r=new THREE.Vector3;new THREE.Vector3;this.animFov=Se.start((function(e){r.lerpVectors(i,o,e),n.controls.lookAt(r.add(n.controls.camera.position))}),t)}},{key:"cancelRotate",value:function(){this.enter&&this.app.startOption.needUnlock&&this.controls.rotationAcc.set(0,0)}},{key:"update",value:function(e){this.locked,this.controls.update(e),this.camera.position.copy(this.quickStartcamera.position),this.camera.quaternion.copy(this.quickStartcamera.quaternion),this.camera.fov=this.quickStartcamera.fov,this.camera.updateProjectionMatrix(),this.view.position.copy(this.quickStartcamera.position),this.view.quaternion.copy(this.quickStartcamera.quaternion),this.view.fov=this.quickStartcamera.fov}},{key:"setSize",value:function(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix()}},{key:"destroy",value:function(){this.scene.remove(this.skybox),this.controls.rotationAcc.set(0,0)}},{key:"attachDom",value:function(e){e.addEventListener("touchstart",this.onTouchStart.bind(this)),e.addEventListener("touchmove",this.onTouchMove.bind(this)),e.addEventListener("touchend",this.onTouchEnd.bind(this))}},{key:"onTouchEvent",value:function(e,t){"touchstart"==t.type?this.onTouchStart(t):"touchmove"==t.type?this.onTouchMove(t):"touchend"==t.type&&this.onTouchEnd(t)}},{key:"onTouchStart",value:function(e){this.touchStartPosition.set(e.touches[0].clientX,e.touches[0].clientY),this.touchPrevPosition.set(e.touches[0].clientX,e.touches[0].clientY),this.touchMoveDelta.set(0,0),this.touchMoveOffset.set(0,0),this.enter||0==this.app.needUnlock?(this.controls.rotationAcc.set(0,0),this.controls.onTouchStart(e)):this.canEnter=!1,this._start={x:e.touches[0].clientX,y:e.touches[0].clientY}}},{key:"onTouchMove",value:function(e){if(this._move={x:e.touches[0].clientX,y:e.touches[0].clientY},this.touchMoveDelta.set(e.touches[0].clientX-this.touchPrevPosition.x,e.touches[0].clientY-this.touchPrevPosition.y),this.touchPrevPosition.set(e.touches[0].clientX,e.touches[0].clientY),this.touchMoveOffset.set(e.touches[0].clientX-this.touchStartPosition.x,e.touches[0].clientY-this.touchStartPosition.y),this.enter||0==this.app.needUnlock)this.controls.onTouchMove(e);else{var t=-this.touchMoveDelta.x;Math.abs(this.getAngle(this._start,this._move))<15&&0==this.enter&&this.unlock(new THREE.Vector2(t,0))}}},{key:"onTouchEnd",value:function(e){(this.enter||0==this.app.needUnlock)&&this.controls.onTouchEnd(e)}},{key:"getAngle",value:function(e,t){var n=t.x-e.x,o=t.y-e.y;return 360*Math.atan(o/n)/(2*Math.PI)}}]),e}()}));var rs={currentBlur:0,aspect:He.aspect,blurStrength:1,hblurPass:He.HorizontalBlurShader,vblurPass:He.VerticalBlurShader,bindEvents(e){e.on(Xo,(function(e,t){e===Oe.PANORAMA&&(Se.cancel(rs.blur),Se.cancel(rs.addBlur),Se.start(rs.removeBlur,500,null,0,null,"deblur"))}))},blur(e){rs.currentBlur=e;var t=e*rs.blurStrength;He.VerticalBlurShader.uniforms.v.value=t/512*rs.aspect,He.HorizontalBlurShader.uniforms.h.value=t/512},addBlur(e){e=Math.max(e,rs.currentBlur),rs.blur(e)},removeBlur(e){e=Math.min(1-e,rs.currentBlur),rs.blur(e)}};rs.blur(0);var as=function e(t){i(this,e),this.message=t};function ss(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var ls,cs,us=function(e){f(n,e);var t=ss(n);function n(e){return i(this,n),t.call(this,e)}return n}(as),hs={};hs.Init=function(e,t){if(cs=t,(ls=e).renderer&&!ls.newRenderer){var n=se.loadTextureFromCache(In.getImageURL("images/circleMarker.png"));cs.model.panos.list.forEach((function(e){e.createVrMarker(n,cs)})),ls.newRenderer=new vs(ls.renderer,ls,ls.camera),ls.isHuawei5X=Ce.detectHUAWEI5X(),ls.oldRenderer=ls.renderer;var o=!1,i=!1;Object.defineProperty(He,"vrEnabled",{get:function(){return o},set:function(e){if((e=!!e)&&He.vrSplitScreen?(ls.renderer=ls.newRenderer,cs.cameraControls.cameras.panorama.staticFov=70):(ls.renderer=ls.oldRenderer,cs.cameraControls.cameras.panorama.staticFov=null),o=e,"portrait"!=window.VRScreenType&&(hs.cursor.visible=e,ls.setSize(window.innerWidth,window.innerHeight),cs.model.updateVrMarker(e,cs)),cs.cameraControls.controls.panorama.locked=e,e)setTimeout((function(){if(console.log("orientEnable"+window.orientEnable),He.vrEnabled&&!window.orientEnable&&Ce.detectIOS()){var e=Ce.iosVersion();if(12==e.major&&e.minor>=2)window.VRScreenNotFull||(Ce.detectSafari()?$alert({content:i18n.t("modules.base.vr_fail_safari_tips")}):$alert({content:i18n.t("modules.base.vr_fail_app_tips")}));else if(e.major>=13){var t=window.vrPermission&&("granted"!=window.vrPermission.deviceMotion||"granted"!=window.vrPermission.deviceOrientation);setTimeout((function(){He.vrEnabled&&!window.orientEnable&&(ps("reset"),window.DeviceMotionEvent&&window.DeviceMotionEvent.requestPermission&&"function"==typeof window.DeviceMotionEvent.requestPermission?(console.log("开始获取权限1"),window.DeviceMotionEvent.requestPermission().then((function(e){console.log("permissionState1: "+e),ps("deviceMotion",e)})).catch((function(e){ps("deviceMotion",!1),console.log(e)}))):(console.log("window.DeviceMotionEvent undefined"),ps("deviceMotion",!1)),window.DeviceOrientationEvent&&window.DeviceOrientationEvent.requestPermission&&"function"==typeof window.DeviceOrientationEvent.requestPermission?(console.log("开始获取权限2"),window.DeviceOrientationEvent.requestPermission().then((function(e){console.log("permissionState2: "+e),ps("deviceOrientation",e)})).catch((function(e){ps("deviceOrientation",!1),console.log(e)}))):(console.log("window.DeviceOrientationEvent undefined"),ps("deviceOrientation",!1)))}),t?0:150)}else console.log("陀螺仪未能启用 ios "+e.major+"."+e.minor)}}),200);else{var t=cs.position,n=(new THREE.Quaternion).copy(cs.camera.quaternion),i=new THREE.Vector3(0,0,-1).applyQuaternion(n).add(t);i.x==t.x&&i.z==t.z?console.log("看向正地面时无法lookAt,无法更新camera转向，直接退出vr"):cs.cameraControls.activeControl.lookAt(i)}}}),Object.defineProperty(He,"vrSplitScreen",{get:function(){return i},set:function(e){i!=(e=!!e)&&(i=e,He.vrEnabled&&"portrait"!=window.VRScreenType&&(e?(ls.renderer=ls.newRenderer,cs.cameraControls.cameras.panorama.staticFov=70):(ls.renderer=ls.oldRenderer,cs.cameraControls.cameras.panorama.staticFov=null),console.log("vrSplitScreen"),ls.setSize(window.innerWidth,window.innerHeight)))}}),90!=window.orientation&&270!=window.orientation||(He.vrSplitScreen=!0),fs(.5,!0,1,16777215,0);var r={setSize:function(e,t){ls.camera.aspect=e/t}};ls.resizeListeners.push(r)}};var ds={},ps=function(e,t){"reset"==e?ds={}:(ds[e]=t,2!=Object.keys(ds).length||"granted"==ds.deviceMotion&&"granted"==ds.deviceOrientation||console.error("运动和方向访问失败"))},fs=function(e,t,n,o,i){var r,a=new THREE.SpriteMaterial({opacity:n,color:o,transparent:t,map:ys(In.getImageURL("images/vrCursor.png")),needsUpdate:!0,side:THREE.DoubleSide});a.map.offset=new THREE.Vector2(1/17*i,0),a.map.repeat=new THREE.Vector2(1/17,1),a.depthTest=!1,a.blending=THREE.AdditiveBlending,(r=new THREE.Sprite(a)).scale.set(e,e,e),r.position.z=-5,r.visible=!1,r.name="cursor",r.renderOrder=Xe,ls.camera.add(r),ls.scene.add(ls.camera),hs.cursor=r;var s=new ms(ls.scene,r,ls.camera);hs.cursor.triggerTargetEvent=s.triggerTargetEvent,ls.updateListeners=[s].concat(ls.updateListeners)};window.orientEnable=0;var ms=function(e,t,n){this.cursor=t,this.raycaster=new THREE.Raycaster,this.targetEventObj={},this.type=1,this.canStartAnimation=!0;var o=this;this.target=n,this.euler=new THREE.Euler,this.q0=new THREE.Quaternion,this.q1=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.zee=new THREE.Vector3(0,0,1),this.alpha=-1e3,this.beta=-1e3,this.gamma=-1e3,this.orient=THREE.Math.degToRad(window.orientation||0),window.addEventListener("orientationchange",(function(){o.orient=THREE.Math.degToRad(window.orientation||0)})),window.addEventListener("deviceorientation",(function(e){if(He.vrEnabled||!window.orientEnable){window.orientEnable||(window.orientEnable=1);var t=THREE.Math.degToRad(e.alpha),n=THREE.Math.degToRad(e.beta),i=THREE.Math.degToRad(e.gamma);this.isHuawei5X?(-1e3===o.alpha&&(o.alpha=t),-1e3===o.beta&&(o.beta=n),-1e3===o.gamma&&(o.gamma=i),Math.abs(t-o.alpha)>.06&&(o.alpha=t),Math.abs(n-o.beta)>.006&&(o.beta=n),Math.abs(i-o.gamma)>.006&&(o.gamma=i)):(o.alpha=t,o.beta=n,o.gamma=i)}})),this.setObjectQuaternion=function(e,t,n,i,r){o.euler.set(n,t,-i,"YXZ"),e.setFromEuler(o.euler),e.multiply(o.q1),e.multiply(o.q0.setFromAxisAngle(o.zee,-r))},parent!==window&&window.addEventListener("message",(function(e){if(e.data&&!(e.data&&e.data.type&&e.data.type.indexOf("webpack")>-1)){var t="string"==typeof e.data?JSON.parse(e.data):e.data,n=-1!==window.navigator.userAgent.indexOf("KIW-TL00H");t&&t.alpha&&t.beta&&t.gamma&&function(e){var n=THREE.Math.degToRad(t.alpha),i=THREE.Math.degToRad(t.beta),r=THREE.Math.degToRad(t.gamma);e?(-1e3===o.alpha&&(o.alpha=n),-1e3===o.beta&&(o.beta=i),-1e3===o.gamma&&(o.gamma=r),Math.abs(n-o.alpha)>.06&&(o.alpha=n),Math.abs(i-o.beta)>.006&&(o.beta=i),Math.abs(r-o.gamma)>.006&&(o.gamma=r)):(o.alpha=n,o.beta=i,o.gamma=r)}(n)}})),this.update=function(e){TWEEN.update(),window.ifTest&&He.vrEnabled?this.triggerTargetEvent():He.vrEnabled&&(this.setObjectQuaternion(cs.cameraControls.activeControl.camera.quaternion,this.alpha,this.beta,this.gamma,this.orient),this.triggerTargetEvent())},this.triggerTargetEvent=function(){var e=this.choseObj(),t=e?e.object:void 0;this.targetEventObj.currentObj=t,t!==this.targetEventObj.lastObj&&(t&&this.autoCursorPosition(e),1===this.type?(this.cursorAnimate&&this.cursorAnimate.stop(),t&&t.enabled&&this.startAnimate(function(){this.clickCallback(t)}.bind(this))):this.type,this.targetEventObj.lastObj=t)},this.choseObj=function(){this.raycaster.setFromCamera({x:0,y:0},n);var e=this.raycaster.intersectObjects(cs.model.vrMarkers);if(e.length>0)return e[0]},this.clickCallback=function(e){this.runTHREEAction(e,"onclick")},this.runTHREEAction=function(e,t){switch(t){case"onclick":e._listeners&&e._listeners.click&&e._listeners.click.forEach((function(e){e()}));break;case"onhover":e._listeners&&e._listeners.hover&&e._listeners.hover.forEach((function(e){e()}));break;case"onout":e._listeners&&e._listeners.out&&e._listeners.out.forEach((function(e){e()}))}},this.startAnimate=function(e){this.canStartAnimation&&this.initAnimation(e)},this.initAnimation=function(e){var t=this,n=this.cursor.material.map.offset;t.canStartAnimation=!1,this.cursorAnimate=new TWEEN.Tween(n).to({x:1},1e3).onStart((function(){t.canStartAnimation=!1})).onStop((function(){t.canStartAnimation=!0,this.x=0,n.x=0})).onUpdate((function(){})).onComplete((function(){e(),n.x=0,setTimeout((function(){t.canStartAnimation=!0}),1500)})),this.cursorAnimate.easing((function(e){return Math.floor(17*e)/17})),this.cursorAnimate.start()},this.autoCursorPosition=function(e){var t=Math.abs(e.distance-10);this.cursor.position.z=-t,t/=10,this.cursor.scale.set(t,t,t)}},vs=function(e,t,n){var o=new gs(n);window.VRCamera=o,o.bananaAspect=.8,this.width,this.height,this.name="vrRenderer";var i=this;this.setSize=function(t,n){e.setSize.call(this,t,n),i.width=t,i.height=n},this.render=function(t,n,i,r){var a,s;if(n.__RESS__SKIP__STEREO__)return e.render(t,n,i,r);if("PerspectiveCamera"===n.type)a=o.cameraL,s=o.cameraR,t.updateMatrixWorld(),null===n.parent&&n.updateMatrixWorld(),o.vrCameraUpdate(n);else{if("OrthographicCamera"!==n.type)return DEBUG&&console.error("Unsupported renderer: ",n.type);a=s=n}e.setScissorTest(!0),e.setScissor(0,0,this.width/2,this.height),e.setViewport(0,0,this.width/2,this.height),e.render.call(this,t,a,i,r),e.setScissor(this.width/2,0,this.width/2,this.height),e.setViewport(this.width/2,0,this.width/2,this.height),e.render.call(this,t,s,i,r),e.setScissorTest(!1)},this.__proto__={__proto__:e}},gs=function(e){this.type="StereoCamera",this._aspect=1,this._overlap=.064,this.cameraL=new THREE.PerspectiveCamera,this.cameraL.layers.enable(0),this.cameraL.near=.01,this.cameraL.matrixAutoUpdate=!1,this.cameraR=new THREE.PerspectiveCamera,this.cameraR.layers.enable(0),this.cameraR.near=.01,this.cameraR.matrixAutoUpdate=!1,this.eyeRight=new THREE.Matrix4,this.eyeLeft=new THREE.Matrix4,this.vrCameraNeedsUpdate=!0,Object.defineProperty(this,"bananaAspect",{get:function(){return this._aspect},set:function(e){this._aspect!==e&&(this.vrCameraNeedsUpdate=!0),this._aspect=e}}),Object.defineProperty(this,"overlap",{get:function(){return this._overlap},set:function(e){this._overlap!==e&&(this.vrCameraNeedsUpdate=!0),this._overlap=e}}),this.vrCameraUpdate=function(e){if(this.vrCameraNeedsUpdate=this.vrCameraNeedsUpdate||this.bananaFov!==e.fov||this.bananaReal_aspect!==e.aspect*this.bananaAspect||this.bananaNear!==e.near||this.bananaFar!==e.far,this.vrCameraNeedsUpdate){this.vrCameraNeedsUpdate=!1,console.debug("vrCameraUpdate"),this.bananaFocus=e.focus,this.bananaFov=50,this.bananaReal_aspect=e.aspect*this.bananaAspect,this.bananaNear=e.near,this.bananaFar=e.far,console.debug(e.aspect),this.bananaFocus=10;var t,n,o=e.projectionMatrix.clone(),i=this.overlap/2,r=i*this.bananaNear/this.bananaFocus,a=this.bananaNear*Math.tan(Math.PI/180*this.bananaFov*.5);this.eyeLeft.elements[12]=-i,this.eyeRight.elements[12]=i,t=-a*this.bananaReal_aspect+r,n=a*this.bananaReal_aspect+r,o.elements[0]=2*this.bananaNear/(n-t),o.elements[8]=(n+t)/(n-t),this.cameraL.projectionMatrix.copy(o),t=-a*this.bananaReal_aspect-r,n=a*this.bananaReal_aspect-r,o.elements[0]=2*this.bananaNear/(n-t),o.elements[8]=(n+t)/(n-t),this.cameraR.projectionMatrix.copy(o)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(this.eyeLeft),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(this.eyeRight)}},ys=function(e){var t=new THREE.TextureLoader;return t.crossOrigin="anonymous",t.load(e)};function ws(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}function bs(e){var t,n,o,i,r,a=Math.floor,s=new Array(64),l=new Array(64),c=new Array(64),u=new Array(64),h=new Array(65535),d=new Array(65535),p=new Array(64),f=new Array(64),m=[],v=0,g=7,y=new Array(64),w=new Array(64),b=new Array(64),E=new Array(256),x=new Array(2048),T=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],P=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],k=[0,1,2,3,4,5,6,7,8,9,10,11],M=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],R=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],I=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],S=[0,1,2,3,4,5,6,7,8,9,10,11],C=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],A=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function D(e,t){for(var n=0,o=0,i=new Array,r=1;r<=16;r++){for(var a=1;a<=e[r];a++)i[t[o]]=[],i[t[o]][0]=n,i[t[o]][1]=r,o++,n++;n*=2}return i}function L(e){for(var t=e[0],n=e[1]-1;n>=0;)t&1<<n&&(v|=1<<g),n--,--g<0&&(255==v?(z(255),z(0)):z(v),g=7,v=0)}function z(e){m.push(e),m.length}function V(e){z(e>>8&255),z(255&e)}function H(e,t,n,o,i){for(var r,a=i[0],s=i[240],l=function(e,t){var n,o,i,r,a,s,l,c,u,h,d=0;for(u=0;u<8;++u){n=e[d],o=e[d+1],i=e[d+2],r=e[d+3],a=e[d+4],s=e[d+5],l=e[d+6];var f=n+(c=e[d+7]),m=n-c,v=o+l,g=o-l,y=i+s,w=i-s,b=r+a,E=r-a,x=f+b,T=f-b,P=v+y,k=v-y;e[d]=x+P,e[d+4]=x-P;var M=.707106781*(k+T);e[d+2]=T+M,e[d+6]=T-M;var R=.382683433*((x=E+w)-(k=g+m)),I=.5411961*x+R,S=1.306562965*k+R,C=.707106781*(P=w+g),A=m+C,D=m-C;e[d+5]=D+I,e[d+3]=D-I,e[d+1]=A+S,e[d+7]=A-S,d+=8}for(d=0,u=0;u<8;++u){n=e[d],o=e[d+8],i=e[d+16],r=e[d+24],a=e[d+32],s=e[d+40],l=e[d+48];var L=n+(c=e[d+56]),z=n-c,V=o+l,H=o-l,O=i+s,F=i-s,N=r+a,B=r-a,j=L+N,U=L-N,_=V+O,W=V-O;e[d]=j+_,e[d+32]=j-_;var Z=.707106781*(W+U);e[d+16]=U+Z,e[d+48]=U-Z;var Q=.382683433*((j=B+F)-(W=H+z)),G=.5411961*j+Q,q=1.306562965*W+Q,Y=.707106781*(_=F+H),$=z+Y,X=z-Y;e[d+40]=X+G,e[d+24]=X-G,e[d+8]=$+q,e[d+56]=$-q,d++}for(u=0;u<64;++u)h=e[u]*t[u],p[u]=h>0?h+.5|0:h-.5|0;return p}(e,t),c=0;c<64;++c)f[T[c]]=l[c];var u=f[0]-n;n=f[0],0==u?L(o[0]):(L(o[d[r=32767+u]]),L(h[r]));for(var m=63;m>0&&0==f[m];m--);if(0==m)return L(a),n;for(var v,g=1;g<=m;){for(var y=g;0==f[g]&&g<=m;++g);var w=g-y;if(w>=16){v=w>>4;for(var b=1;b<=v;++b)L(s);w&=15}r=32767+f[g],L(i[(w<<4)+d[r]]),L(h[r]),g++}return 63!=m&&L(a),n}function O(e){if(e<=0&&(e=1),e>100&&(e=100),r!=e){(function(e){for(var t=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],n=0;n<64;n++){var o=a((t[n]*e+50)/100);o<1?o=1:o>255&&(o=255),s[T[n]]=o}for(var i=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],r=0;r<64;r++){var h=a((i[r]*e+50)/100);h<1?h=1:h>255&&(h=255),l[T[r]]=h}for(var d=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],p=0,f=0;f<8;f++)for(var m=0;m<8;m++)c[p]=1/(s[T[p]]*d[f]*d[m]*8),u[p]=1/(l[T[p]]*d[f]*d[m]*8),p++})(e<50?Math.floor(5e3/e):Math.floor(200-2*e)),r=e}}this.encode=function(e,r){(new Date).getTime(),r&&O(r),m=[],v=0,g=7,V(65496),V(65504),V(16),z(74),z(70),z(73),z(70),z(0),z(1),z(1),z(0),V(1),V(1),z(0),z(0),function(){V(65499),V(132),z(0);for(var e=0;e<64;e++)z(s[e]);z(1);for(var t=0;t<64;t++)z(l[t])}(),function(e,t){V(65472),V(17),z(8),V(t),V(e),z(3),z(1),z(17),z(0),z(2),z(17),z(1),z(3),z(17),z(1)}(e.width,e.height),function(){V(65476),V(418),z(0);for(var e=0;e<16;e++)z(P[e+1]);for(var t=0;t<=11;t++)z(k[t]);z(16);for(var n=0;n<16;n++)z(M[n+1]);for(var o=0;o<=161;o++)z(R[o]);z(1);for(var i=0;i<16;i++)z(I[i+1]);for(var r=0;r<=11;r++)z(S[r]);z(17);for(var a=0;a<16;a++)z(C[a+1]);for(var s=0;s<=161;s++)z(A[s])}(),V(65498),V(12),z(3),z(1),z(0),z(2),z(17),z(3),z(17),z(0),z(63),z(0);var a=0,h=0,d=0;v=0,g=7,this.encode.displayName="_encode_";for(var p,f,E,T,D,F,N,B,j,U=e.data,_=e.width,W=e.height,Z=4*_,Q=0;Q<W;){for(p=0;p<Z;){for(F=D=Z*Q+p,N=-1,B=0,j=0;j<64;j++)F=D+(B=j>>3)*Z+(N=4*(7&j)),Q+B>=W&&(F-=Z*(Q+1+B-W)),p+N>=Z&&(F-=p+N-Z+4),f=U[F++],E=U[F++],T=U[F++],y[j]=(x[f]+x[E+256>>0]+x[T+512>>0]>>16)-128,w[j]=(x[f+768>>0]+x[E+1024>>0]+x[T+1280>>0]>>16)-128,b[j]=(x[f+1280>>0]+x[E+1536>>0]+x[T+1792>>0]>>16)-128;a=H(y,c,a,t,o),h=H(w,u,h,n,i),d=H(b,u,d,n,i),p+=32}Q+=8}if(g>=0){var G=[];G[1]=g+1,G[0]=(1<<g+1)-1,L(G)}return V(65497),"undefined"==typeof module?new Uint8Array(m):Buffer.from(m)},(new Date).getTime(),e||(e=50),function(){for(var e=String.fromCharCode,t=0;t<256;t++)E[t]=e(t)}(),t=D(P,k),n=D(I,S),o=D(M,R),i=D(C,A),function(){for(var e=1,t=2,n=1;n<=15;n++){for(var o=e;o<t;o++)d[32767+o]=n,h[32767+o]=[],h[32767+o][1]=n,h[32767+o][0]=o;for(var i=-(t-1);i<=-e;i++)d[32767+i]=n,h[32767+i]=[],h[32767+i][1]=n,h[32767+i][0]=t-1+i;e<<=1,t<<=1}}(),function(){for(var e=0;e<256;e++)x[e]=19595*e,x[e+256>>0]=38470*e,x[e+512>>0]=7471*e+32768,x[e+768>>0]=-11059*e,x[e+1024>>0]=-21709*e,x[e+1280>>0]=32768*e+8421375,x[e+1536>>0]=-27439*e,x[e+1792>>0]=-5329*e}(),O(e),(new Date).getTime()}window.addEventListener("orientationchange",(function(e){console.log("vr orientation ".concat(window.orientation)),0==window.orientation||180==window.orientation?He.vrSplitScreen=!1:He.vrSplitScreen=!0})),new THREE.RawShaderMaterial({fragmentShader:Ht.skysphere.fragmentShader,vertexShader:Ht.skysphere.vertexShader,uniforms:THREE.UniformsUtils.clone(Ht.skysphere.uniforms),side:THREE.BackSide,name:"skysphereBG"}),window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame,me("SceneRenderer",(function(){return function(e){f(n,EventEmitter);var t=ws(n);function n(){var e,o,r,a,s,l,c,u,h,d;return i(this,n),(e=t.call(this)).createScene=function(e){this.camera=new THREE.PerspectiveCamera,this.camera.layers.enable(ct),this.camera.layers.enable(ut),this.camera.layers.enable(ht),this.scene=new THREE.Scene,this.light=new THREE.AmbientLight(16777215),this.scene.add(this.light)},e.addComponent=function(e){this.components.push(e),e.update&&this.updateListeners.push(e),e.setSize&&(this.resizeListeners.push(e),this.forceUpdateSize=!0)},e.removeComponent=function(e){var t=function(t){return t!==e};this.components=this.components.filter(t),this.updateListeners=this.updateListeners.filter(t),this.resizeListeners=this.resizeListeners.filter(t)},e.start=function(e){if(this.started)throw new as("Can't start SceneRenderer, already started");this.createContext(e),this.initComposer(),this.started=!0;try{hs.Init(this,this.$app.core.get("Player"))}catch(e){console.error(e)}(this.animate=this.animate.bind(this))()},e.createContext=function(e){try{this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.autoClear=!0,this.renderer.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor("#292929",1),this.emit(Br)}catch(e){throw new us("Unable to create a WebGL rendering context")}e.appendChild(this.renderer.domElement)},e.initComposer=function(){this.composer=new THREE.EffectComposer(this.renderer),this.composer.addPass(new THREE.RenderPass(this.scene,this.camera)),this.composer.addPass(this.effects.hblurPass),this.composer.addPass(this.effects.vblurPass)},e.setSize=function(e,t){this.renderWidth=e,this.renderHeight=t,this.effects.aspect=e/t,this.renderer.setSize(e,t),this.composer.setSize(e,t);for(var n=0;n<this.resizeListeners.length;n++)this.resizeListeners[n].setSize(e,t);this.emit("resize",e,t)},e.render=function(){this.effects.currentBlur>0?this.composer.render():this.renderer.render(this.scene,this.camera)},e.updateScreenSize=function(e){var t,n,i,s=!1;e&&!e.resize&&null!=e.width&&null!=e.height?(n=e.width,i=e.height,s=!0,t=1):(n=this.renderer.domElement.parentElement.clientWidth,i=this.renderer.domElement.parentElement.clientHeight,e&&e.resize&&(o=this.renderWidth,r=this.renderHeight),(n!==o||i!==r||this.forceUpdateSize||a!=window.devicePixelRatio)&&(o=n,r=i,s=!0,a=window.devicePixelRatio,t=window.devicePixelRatio)),s&&(this.setSize(n,i,t),this.forceUpdateSize=!1)},e.updateComponents=function(){for(var e=Math.min(1,this.updateClock.getDelta()),t=0;t<this.updateListeners.length;t++)this.updateListeners[t].update(e)},e.suspend=function(){this.started=!1,this.suspendedObjects=this.scene.children.map(function(e){return this.scene.remove(e),e}.bind(this)),this.render()},e.resume=function(){this.suspendedObjects.forEach(function(e){this.scene.add(e)}.bind(this)),this.suspendedObjects=[],this.started=!0,this.animate()},e.animate=function(){this.started&&(window.requestAnimationFrame(this.animate),this.updateScreenSize(),this.updateComponents(),this.render(),this.emit(jr))},e.getImageData=function(){var e=document.createElement("canvas"),t=e.getContext("2d");return function(n,o,i){return e.width===o&&e.height===i||(e.width=o,e.height=i),t.drawImage(n,0,0,o,i),t.getImageData(0,0,o,i)}}(),e.initSizedTexture2D=function(e,t,n){var o=this.renderer,i=o.context,r=o.state,a=new THREE.Texture(null);a.flipY=!1,!0!==n&&(n=!1),a.generateMipmaps=n;var s=o.paramThreeToGL(a.format),l=o.paramThreeToGL(a.type),c=o.properties.get(a),u=i.createTexture();r.bindTexture(i.TEXTURE_2D,u),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,a.flipY),i.texImage2D(i.TEXTURE_2D,0,s,e,e,0,s,l,null),a.wrapS=t,a.wrapT=t;var h=o.paramThreeToGL(t);return i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,h),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,h),n?(a.magFilter=THREE.LinearFilter,a.minFilter=THREE.LinearMipMapLinearFilter,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_NEAREST),i.generateMipmap(i.TEXTURE_2D)):(a.magFilter=THREE.LinearFilter,a.minFilter=THREE.LinearFilter,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)),r.bindTexture(i.TEXTURE_2D,null),c.__webglTexture=u,a},e.deallocateCubeTexture=function(e){var t=this.renderer,n=t.context,o=t.properties.get(e);n.deleteTexture(o.__image__webglTextureCube)},e.renderToCubeMap=(s=!1,l=null,c=null,u=null,h=null,d=null,function(e,t,n,o,i,r,a,p,f,m,v,g,y,w,b,E){var x=this.oldRenderer||this.renderer;s||((c=new THREE.OrthographicCamera(-.5,.5,.5,-.5,-200,200)).position.z=150,(l=new THREE.Scene).add(c),u=new THREE.ShaderMaterial({uniforms:{tDiffuse:{type:"scene",value:null},alpha:{type:"startYinTile",value:1}},vertexShader:Ht.basicTextured.vertexShader,fragmentShader:Ht.basicTextured.fragmentShader,depthWrite:!1,depthTest:!1,side:THREE.DoubleSide}),h=new THREE.PlaneBufferGeometry(1,1),(d=new THREE.Mesh(h,u)).position.z=0,l.add(d),s=!0);var T=h.getAttribute("uv");T.setDynamic(!0),T.needsUpdate=!0;var P=T.array,k=i/n,M=r/o,R=a/n,I=p/o;P[0]=k,P[1]=M+I,P[2]=k+R,P[3]=M+I,P[4]=k,P[5]=M,P[6]=k+R,P[7]=M;var S=h.getAttribute("position");S.setDynamic(!0),S.needsUpdate=!0;var C=S.array,A=f/t.width-.5,D=m/t.height-.5,L=v/t.width,z=g/t.height;C[0]=A,C[1]=D+z,C[3]=A+L,C[4]=D+z,C[6]=A,C[7]=D,C[9]=A+L,C[10]=D,x.properties.get(l),u.uniforms.tDiffuse.value=e,u.blending=w||THREE.NoBlending,u.transparent=!!b,null!=E||(E=1),u.uniforms.alpha.value=E,u.needUpdate=!0,t.activeCubeFace=y,t.viewport.set(0,0,t.width,t.height);var V=x.autoClear;x.autoClear=!1,x.render(l,c,t,!1),x.autoClear=V}),e.copyCubeMap=function(){var e=!1,t=null,n=null,o=null,i=null,r=null,a=new THREE.Euler;return function(s,l,c,u,h,d,p,f,m){if(!e){(n=new THREE.OrthographicCamera(-1,1,1,-1,0,200)).position.set(0,0,0),(t=new THREE.Scene).add(n),o=new THREE.ShaderMaterial({uniforms:{tDiffuse:{type:"t",value:null},alpha:{type:"f",value:1}},vertexShader:Ht.copyCubeMap.vertexShader,fragmentShader:Ht.copyCubeMap.fragmentShader,depthWrite:!1,depthTest:!1,side:THREE.DoubleSide}),i=new THREE.BoxGeometry(2,2,2),r=new THREE.Mesh(i,o),t.add(r),e=!0}for(var v=0;v<6;v++)this.getCubeOrientationForCubeFace(v,a),r.rotation.copy(a),r.matrixWorldNeedsUpdate=!0,r.updateMatrixWorld(),o.uniforms.tDiffuse.value=s,o.blending=p||THREE.NoBlending,o.transparent=!!f,null!=m||(m=1),o.uniforms.alpha.value=m,o.needUpdate=!0,l.activeCubeFace=v,l.viewport.set(0,0,h,d),this.renderer.render(t,n,l,!1)}}(),e.getCubeOrientationForCubeFace=function(e,t){switch(e){case Gn:t.set(0,-Math.PI/2,0);break;case qn:t.set(0,Math.PI/2,0);break;case Yn:t.set(Math.PI/2,Math.PI,0);break;case $n:t.set(-Math.PI/2,Math.PI,0);break;case Xn:t.set(0,-Math.PI,0);break;case Jn:t.set(0,0,0)}},e.scene=null,e.camera=null,e.light=null,e.renderer=null,e.effects=rs,e.animateCallback=null,e.composer=null,e.qualityManager=null,e.updateClock=new THREE.Clock,e.components=[],e.updateListeners=[],e.resizeListeners=[],e.forceUpdateSize=!1,e.started=!1,e.textures={},e.suspendedObjects=[],e.vrMode=!1,e}return u(n,[{key:"uploadTexture2D",value:function(e,t,n,o,i,r){var a=this.renderer,s=a.context,l=a.state,c=a.properties.get(t);l.bindTexture(s.TEXTURE_2D,c.__webglTexture),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,t.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,t.unpackAlignment),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,a.paramThreeToGL(t.wrapS)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,a.paramThreeToGL(t.wrapT)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,a.paramThreeToGL(t.magFilter)),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,a.paramThreeToGL(t.minFilter)),s.texSubImage2D(s.TEXTURE_2D,0,n,o,s.RGBA,s.UNSIGNED_BYTE,e),t.generateMipmaps&&s.generateMipmap(s.TEXTURE_2D),l.bindTexture(s.TEXTURE_2D,null)}}]),n}()}));var Es=function(){var e=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),t=4017,n=799,o=3406,i=2276,r=1567,a=3784,s=5793,l=2896;function c(){}function u(e,t){for(var n,o,i=0,r=[],a=16;a>0&&!e[a-1];)a--;r.push({children:[],index:0});var s,l=r[0];for(n=0;n<a;n++){for(o=0;o<e[n];o++){for((l=r.pop()).children[l.index]=t[i];l.index>0;){if(0===r.length)throw new Error("Could not recreate Huffman Table");l=r.pop()}for(l.index++,r.push(l);r.length<=n;)r.push(s={children:[],index:0}),l.children[l.index]=s.children,l=s;i++}n+1<a&&(r.push(s={children:[],index:0}),l.children[l.index]=s.children,l=s)}return r[0].children}function h(t,n,o,i,r,a,s,l,c){o.precision,o.samplesPerLine,o.scanLines;var u=o.mcusPerLine,h=o.progressive;o.maxH,o.maxV;var d=n,p=0,f=0;function m(){if(f>0)return f--,p>>f&1;if(255==(p=t[n++])){var e=t[n++];if(e)throw new Error("unexpected marker: "+(p<<8|e).toString(16))}return f=7,p>>>7}function v(e){for(var t,n=e;null!==(t=m());){if("number"==typeof(n=n[t]))return n;if("object"!=typeof n)throw new Error("invalid huffman sequence")}return null}function g(e){for(var t=0;e>0;){var n=m();if(null===n)return;t=t<<1|n,e--}return t}function y(e){var t=g(e);return t>=1<<e-1?t:t+(-1<<e)+1}var w=0;var b,E=0;function x(e,t,n,o,i){var r=n%u,a=(n/u|0)*e.v+o,s=r*e.h+i;t(e,e.blocks[a][s])}function T(e,t,n){var o=n/e.blocksPerLine|0,i=n%e.blocksPerLine;t(e,e.blocks[o][i])}var P,k,M,R,I,S,C=i.length;S=h?0===a?0===l?function(e,t){var n=v(e.huffmanTableDC),o=0===n?0:y(n)<<c;t[0]=e.pred+=o}:function(e,t){t[0]|=m()<<c}:0===l?function(t,n){if(w>0)w--;else for(var o=a,i=s;o<=i;){var r=v(t.huffmanTableAC),l=15&r,u=r>>4;if(0!==l)n[e[o+=u]]=y(l)*(1<<c),o++;else{if(u<15){w=g(u)+(1<<u)-1;break}o+=16}}}:function(t,n){for(var o=a,i=s,r=0;o<=i;){var l=e[o],u=n[l]<0?-1:1;switch(E){case 0:var h=v(t.huffmanTableAC),d=15&h;if(r=h>>4,0===d)r<15?(w=g(r)+(1<<r),E=4):(r=16,E=1);else{if(1!==d)throw new Error("invalid ACn encoding");b=y(d),E=r?2:3}continue;case 1:case 2:n[l]?n[l]+=(m()<<c)*u:0==--r&&(E=2==E?3:0);break;case 3:n[l]?n[l]+=(m()<<c)*u:(n[l]=b<<c,E=0);break;case 4:n[l]&&(n[l]+=(m()<<c)*u)}o++}4===E&&0==--w&&(E=0)}:function(t,n){var o=v(t.huffmanTableDC),i=0===o?0:y(o);n[0]=t.pred+=i;for(var r=1;r<64;){var a=v(t.huffmanTableAC),s=15&a,l=a>>4;if(0!==s)n[e[r+=l]]=y(s),r++;else{if(l<15)break;r+=16}}};var A,D,L,z,V=0;for(D=1==C?i[0].blocksPerLine*i[0].blocksPerColumn:u*o.mcusPerColumn,r||(r=D);V<D;){for(k=0;k<C;k++)i[k].pred=0;if(w=0,1==C)for(P=i[0],I=0;I<r;I++)T(P,S,V),V++;else for(I=0;I<r;I++){for(k=0;k<C;k++)for(L=(P=i[k]).h,z=P.v,M=0;M<z;M++)for(R=0;R<L;R++)x(P,S,V,M,R);if(++V===D)break}if(f=0,(A=t[n]<<8|t[n+1])<65280)throw new Error("marker was not found");if(!(A>=65488&&A<=65495))break;n+=2}return n-d}function d(e,c){var u,h,d=[],p=c.blocksPerLine,f=c.blocksPerColumn,m=p<<3,v=new Int32Array(64),g=new Uint8Array(64);function y(e,u,h){var d,p,f,m,v,g,y,w,b,E,x=c.quantizationTable,T=h;for(E=0;E<64;E++)T[E]=e[E]*x[E];for(E=0;E<8;++E){var P=8*E;0!=T[1+P]||0!=T[2+P]||0!=T[3+P]||0!=T[4+P]||0!=T[5+P]||0!=T[6+P]||0!=T[7+P]?(d=s*T[0+P]+128>>8,p=s*T[4+P]+128>>8,f=T[2+P],m=T[6+P],v=l*(T[1+P]-T[7+P])+128>>8,w=l*(T[1+P]+T[7+P])+128>>8,g=T[3+P]<<4,y=T[5+P]<<4,b=d-p+1>>1,d=d+p+1>>1,p=b,b=f*a+m*r+128>>8,f=f*r-m*a+128>>8,m=b,b=v-y+1>>1,v=v+y+1>>1,y=b,b=w+g+1>>1,g=w-g+1>>1,w=b,b=d-m+1>>1,d=d+m+1>>1,m=b,b=p-f+1>>1,p=p+f+1>>1,f=b,b=v*i+w*o+2048>>12,v=v*o-w*i+2048>>12,w=b,b=g*n+y*t+2048>>12,g=g*t-y*n+2048>>12,y=b,T[0+P]=d+w,T[7+P]=d-w,T[1+P]=p+y,T[6+P]=p-y,T[2+P]=f+g,T[5+P]=f-g,T[3+P]=m+v,T[4+P]=m-v):(b=s*T[0+P]+512>>10,T[0+P]=b,T[1+P]=b,T[2+P]=b,T[3+P]=b,T[4+P]=b,T[5+P]=b,T[6+P]=b,T[7+P]=b)}for(E=0;E<8;++E){var k=E;0!=T[8+k]||0!=T[16+k]||0!=T[24+k]||0!=T[32+k]||0!=T[40+k]||0!=T[48+k]||0!=T[56+k]?(d=s*T[0+k]+2048>>12,p=s*T[32+k]+2048>>12,f=T[16+k],m=T[48+k],v=l*(T[8+k]-T[56+k])+2048>>12,w=l*(T[8+k]+T[56+k])+2048>>12,g=T[24+k],y=T[40+k],b=d-p+1>>1,d=d+p+1>>1,p=b,b=f*a+m*r+2048>>12,f=f*r-m*a+2048>>12,m=b,b=v-y+1>>1,v=v+y+1>>1,y=b,b=w+g+1>>1,g=w-g+1>>1,w=b,b=d-m+1>>1,d=d+m+1>>1,m=b,b=p-f+1>>1,p=p+f+1>>1,f=b,b=v*i+w*o+2048>>12,v=v*o-w*i+2048>>12,w=b,b=g*n+y*t+2048>>12,g=g*t-y*n+2048>>12,y=b,T[0+k]=d+w,T[56+k]=d-w,T[8+k]=p+y,T[48+k]=p-y,T[16+k]=f+g,T[40+k]=f-g,T[24+k]=m+v,T[32+k]=m-v):(b=s*h[E+0]+8192>>14,T[0+k]=b,T[8+k]=b,T[16+k]=b,T[24+k]=b,T[32+k]=b,T[40+k]=b,T[48+k]=b,T[56+k]=b)}for(E=0;E<64;++E){var M=128+(T[E]+8>>4);u[E]=M<0?0:M>255?255:M}}for(var w=0;w<f;w++){var b=w<<3;for(u=0;u<8;u++)d.push(new Uint8Array(m));for(var E=0;E<p;E++){y(c.blocks[w][E],g,v);var x=0,T=E<<3;for(h=0;h<8;h++){var P=d[b+h];for(u=0;u<8;u++)P[T+u]=g[x++]}}}return d}function p(e){return e<0?0:e>255?255:e}return c.prototype={load:function(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(){var e=new Uint8Array(t.response||t.mozResponseArrayBuffer);this.parse(e),this.onload&&this.onload()}.bind(this),t.send(null)},parse:function(t){var n=0;function o(){var e=t[n]<<8|t[n+1];return n+=2,e}function i(e){var t,n,o=0,i=0;for(n in e.components)e.components.hasOwnProperty(n)&&(o<(t=e.components[n]).h&&(o=t.h),i<t.v&&(i=t.v));var r=Math.ceil(e.samplesPerLine/8/o),a=Math.ceil(e.scanLines/8/i);for(n in e.components)if(e.components.hasOwnProperty(n)){t=e.components[n];for(var s=Math.ceil(Math.ceil(e.samplesPerLine/8)*t.h/o),l=Math.ceil(Math.ceil(e.scanLines/8)*t.v/i),c=r*t.h,u=a*t.v,h=[],d=0;d<u;d++){for(var p=[],f=0;f<c;f++)p.push(new Int32Array(64));h.push(p)}t.blocksPerLine=s,t.blocksPerColumn=l,t.blocks=h}e.maxH=o,e.maxV=i,e.mcusPerLine=r,e.mcusPerColumn=a}t.length;var r,a,s,l,c=null,p=null,f=[],m=[],v=[],g=[],y=o();if(65496!=y)throw new Error("SOI not found");for(y=o();65497!=y;){switch(y){case 65280:break;case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var w=(s=void 0,l=void 0,s=o(),l=t.subarray(n,n+s-2),n+=l.length,l);65504===y&&74===w[0]&&70===w[1]&&73===w[2]&&70===w[3]&&0===w[4]&&(c={version:{major:w[5],minor:w[6]},densityUnits:w[7],xDensity:w[8]<<8|w[9],yDensity:w[10]<<8|w[11],thumbWidth:w[12],thumbHeight:w[13],thumbData:w.subarray(14,14+3*w[12]*w[13])}),65518===y&&65===w[0]&&100===w[1]&&111===w[2]&&98===w[3]&&101===w[4]&&0===w[5]&&(p={version:w[6],flags0:w[7]<<8|w[8],flags1:w[9]<<8|w[10],transformCode:w[11]});break;case 65499:for(var b=o()+n-2;n<b;){var E=t[n++],x=new Int32Array(64);if(E>>4==0)for(U=0;U<64;U++){x[e[U]]=t[n++]}else{if(E>>4!=1)throw new Error("DQT: invalid table spec");for(U=0;U<64;U++){x[e[U]]=o()}}f[15&E]=x}break;case 65472:case 65473:case 65474:o(),(r={}).extended=65473===y,r.progressive=65474===y,r.precision=t[n++],r.scanLines=o(),r.samplesPerLine=o(),r.components={},r.componentsOrder=[];var T,P=t[n++];for(B=0;B<P;B++){T=t[n];var k=t[n+1]>>4,M=15&t[n+1],R=t[n+2];r.componentsOrder.push(T),r.components[T]={h:k,v:M,quantizationIdx:R},n+=3}i(r),m.push(r);break;case 65476:var I=o();for(B=2;B<I;){var S=t[n++],C=new Uint8Array(16),A=0;for(U=0;U<16;U++,n++)A+=C[U]=t[n];var D=new Uint8Array(A);for(U=0;U<A;U++,n++)D[U]=t[n];B+=17+A,(S>>4==0?g:v)[15&S]=u(C,D)}break;case 65501:o(),a=o();break;case 65498:o();var L=t[n++],z=[];for(B=0;B<L;B++){_=r.components[t[n++]];var V=t[n++];_.huffmanTableDC=g[V>>4],_.huffmanTableAC=v[15&V],z.push(_)}var H=t[n++],O=t[n++],F=t[n++],N=h(t,n,r,z,a,H,O,F>>4,15&F);n+=N;break;case 65535:255!==t[n]&&n--;break;default:if(255==t[n-3]&&t[n-2]>=192&&t[n-2]<=254){n-=3;break}throw new Error("unknown JPEG marker "+y.toString(16))}y=o()}if(1!=m.length)throw new Error("only single frame JPEGs supported");for(var B=0;B<m.length;B++){var j=m[B].components;for(var U in j)j[U].quantizationTable=f[j[U].quantizationIdx],delete j[U].quantizationIdx}this.width=r.samplesPerLine,this.height=r.scanLines,this.jfif=c,this.adobe=p,this.components=[];for(B=0;B<r.componentsOrder.length;B++){var _=r.components[r.componentsOrder[B]];this.components.push({lines:d(0,_),scaleX:_.h/r.maxH,scaleY:_.v/r.maxV})}},getData:function(e,t){var n,o,i,r,a,s,l,c,u,h,d,f,m,v,g,y,w,b,E,x,T,P=this.width/e,k=this.height/t,M=0,R=e*t*this.components.length,I=new Uint8Array(R);switch(this.components.length){case 1:for(n=this.components[0],h=0;h<t;h++)for(a=n.lines[0|h*n.scaleY*k],u=0;u<e;u++)d=a[0|u*n.scaleX*P],I[M++]=d;break;case 2:for(n=this.components[0],o=this.components[1],h=0;h<t;h++)for(a=n.lines[0|h*n.scaleY*k],s=o.lines[0|h*o.scaleY*k],u=0;u<e;u++)d=a[0|u*n.scaleX*P],I[M++]=d,d=s[0|u*o.scaleX*P],I[M++]=d;break;case 3:for(T=!0,this.adobe&&this.adobe.transformCode?T=!0:void 0!==this.colorTransform&&(T=!!this.colorTransform),n=this.components[0],o=this.components[1],i=this.components[2],h=0;h<t;h++)for(a=n.lines[0|h*n.scaleY*k],s=o.lines[0|h*o.scaleY*k],l=i.lines[0|h*i.scaleY*k],u=0;u<e;u++)T?(d=a[0|u*n.scaleX*P],f=s[0|u*o.scaleX*P],b=p(d+1.402*((m=l[0|u*i.scaleX*P])-128)),E=p(d-.3441363*(f-128)-.71413636*(m-128)),x=p(d+1.772*(f-128))):(b=a[0|u*n.scaleX*P],E=s[0|u*o.scaleX*P],x=l[0|u*i.scaleX*P]),I[M++]=b,I[M++]=E,I[M++]=x;break;case 4:if(!this.adobe)throw new Error("Unsupported color mode (4 components)");for(T=!1,this.adobe&&this.adobe.transformCode?T=!0:void 0!==this.colorTransform&&(T=!!this.colorTransform),n=this.components[0],o=this.components[1],i=this.components[2],r=this.components[3],h=0;h<t;h++)for(a=n.lines[0|h*n.scaleY*k],s=o.lines[0|h*o.scaleY*k],l=i.lines[0|h*i.scaleY*k],c=r.lines[0|h*r.scaleY*k],u=0;u<e;u++)T?(d=a[0|u*n.scaleX*P],f=s[0|u*o.scaleX*P],m=l[0|u*i.scaleX*P],v=c[0|u*r.scaleX*P],g=255-p(d+1.402*(m-128)),y=255-p(d-.3441363*(f-128)-.71413636*(m-128)),w=255-p(d+1.772*(f-128))):(g=a[0|u*n.scaleX*P],y=s[0|u*o.scaleX*P],w=l[0|u*i.scaleX*P],v=c[0|u*r.scaleX*P]),I[M++]=255-g,I[M++]=255-y,I[M++]=255-w,I[M++]=255-v;break;default:throw new Error("Unsupported color mode")}return I},copyToImageData:function(e,t){var n,o,i,r,a,s,l,c,u,h=e.width,d=e.height,f=e.data,m=this.getData(h,d),v=0,g=0;switch(this.components.length){case 1:for(o=0;o<d;o++)for(n=0;n<h;n++)i=m[v++],f[g++]=i,f[g++]=i,f[g++]=i,t&&(f[g++]=255);break;case 3:for(o=0;o<d;o++)for(n=0;n<h;n++)l=m[v++],c=m[v++],u=m[v++],f[g++]=l,f[g++]=c,f[g++]=u,t&&(f[g++]=255);break;case 4:for(o=0;o<d;o++)for(n=0;n<h;n++)a=m[v++],s=m[v++],i=m[v++],l=255-p(a*(1-(r=m[v++])/255)+r),c=255-p(s*(1-r/255)+r),u=255-p(i*(1-r/255)+r),f[g++]=l,f[g++]=c,f[g++]=u,t&&(f[g++]=255);break;default:throw new Error("Unsupported color mode")}}},c}();var xs={encode:function(e,t){return void 0===t&&(t=50),{data:new bs(t).encode(e,t),width:e.width,height:e.height}},decode:function(e,t){var n={useTArray:!1,colorTransform:void 0,formatAsRGBA:!0};t?"object"==typeof t?t={useTArray:void 0===t.useTArray?n.useTArray:t.useTArray,colorTransform:void 0===t.colorTransform?n.colorTransform:t.colorTransform,formatAsRGBA:void 0===t.formatAsRGBA?n.formatAsRGBA:t.formatAsRGBA}:(t=n).useTArray=!0:t=n;var o=new Uint8Array(e),i=new Es;i.parse(o),i.colorTransform=t.colorTransform;var r=t.formatAsRGBA?4:3,a=i.width*i.height*r;try{var s={width:i.width,height:i.height,data:t.useTArray?new Uint8Array(a):new Buffer(a)}}catch(e){throw e instanceof RangeError?new Error("Could not allocate enough memory for the image. Required: "+a):e}return i.copyToImageData(s,t.formatAsRGBA),s}};function Ts(e,t,n){e&&(e=e.toLowerCase().trim());var o=new I.UP.clone,i=Math.PI/3,r=Math.PI/2;switch(e){case"left":n.copy(t),n.applyAxisAngle(o,r);break;case"right":n.copy(t),n.applyAxisAngle(o,-r);break;case"forwardleft":n.copy(t),n.applyAxisAngle(o,i);break;case"forwardright":n.copy(t),n.applyAxisAngle(o,-i);break;case"forward":default:n.copy(t)}return n}function Ps(e,t){if(e){var n={pano:e,lookAtPoint:null,duration:null,maxDistanceOverride:null,skipWarpingCheck:!1};this.player.flyToPano(n,(function(){t&&t({success:!0,message:"Transition complete."})}))}else R.warn("Showcase -> clickPanoObject: Unable to find pano."),t&&t({success:!1,error:"Unable to find pano."})}function ks(e,t){var n=this.findRankedPano(e,t);return n>=0?this.handleToObject[n]:(R.warn("Showcase -> findRankedPanoObject: Unable to find nearby pano."),null)}function Ms(e,t){var n=this.findRankedtag(e,t);return n>=0?this.handleToObject[n]:(R.warn("Showcase -> findRankedtagObject: Unable to find nearby tag."),null)}function Rs(e,t){t.copy(I.FORWARD),e.getDirection(t)}var Is,Ss,Cs={director:null,player:null,controls:null,sceneRenderer:null,model:null,init:function(e,t,n,o){this.director=e,this.player=n,this.controls=t,this.sceneRenderer=o},handleToObject:{},objectToHandle:{},handleCount:0,onMessageReceive:function(e){if(e){var t=e.targetFunction,n=e.params,o=e.onDone;t&&this[t]&&this[t](n,o)}},waitForInit:function(e,t){F.then(t.bind({success:!0,message:"Init complete."}))},moveToPano:function(e,t){var n=new THREE.Euler(0,0,0,"YXZ"),o=new THREE.Quaternion;return function(e,t){var i=e.pano,r=e.rotation,a=e.transition;if(!this.model)return t({success:!1,error:"The model has not been loaded yet"});var s=this.model.panos.get(i);if(!s)return t({success:!1,error:i+" does not exist in this model"});if(!r)return t({sucess:!1,erorr:r+" is not a valid rotation"});n.set(c.Math.degToRad(r.x||0),c.Math.degToRad(r.y||0),c.Math.degToRad(r.z||0),"YXZ"),ke.info(r.z);var l={success:!0,message:i};if(a===A.FADEOUT)o.setFromEuler(n),this.player.warpToPano(s,o,null,null,b.BLACK,null,null,t.bind(this,l));else{var u,h;a===A.INSTANT&&(u=0,h=0);var d=I.FORWARD.clone().applyEuler(n).add(s.position);this.player.flyToPano({pano:s,lookAtPoint:d,duration:u,aimDuration:h},t.bind(this,l))}}}(),moveInDirection:function(e,t){var n=e.direction;return void 0===v[n]?(R.warn("Showcase -> moveInDirection: Cannot move in invalid direction."),void(t&&t({success:!1,error:"Invalid direction."}))):void this.player.flyLocalDirection(I[n].clone()).then((function(e){t(e?{success:!0,message:"moved "+n}:{success:!1,error:"Cannot move in direction: "+n})}))},getPose:function(e,t){return this.player.camera.position,(new THREE.Euler).setFromQuaternion(this.player.camera.quaternion,"YXZ"),t({success:!0,message:B(this.player)})},takeScreenShot:(Is=new THREE.PerspectiveCamera,Ss=new THREE.WebGLRenderTarget,function(e,t){if(!e.resolution)return t({success:!1,error:"An invalid resolution was specified"});if(-1===e.resolution.width||-1===e.resolution.height){var n=this.sceneRenderer.renderer.getSize();e.resolution.width=n.width,e.resolution.height=n.height}Is.layers.set(lt),e.visibleObjects&&(e.visibleObjects.showtags&&Is.layers.enable(ht),e.visibleObjects.showPucks&&Is.layers.enable(ct),e.visibleObjects.showReticule&&Is.layers.enable(ut));var o=e.resolution.width,i=e.resolution.height,r=o/i;Is.position.copy(this.sceneRenderer.camera.position),Is.quaternion.copy(this.sceneRenderer.camera.quaternion),Is.projectionMatrix.copy(this.player.camera.projectionMatrix),Is.projectionMatrix.elements[0]=this.player.camera.projectionMatrix.elements[5]/r,Is.projectionMatrix.elements[5]=-Is.projectionMatrix.elements[5],Ss.setSize(o,i),this.sceneRenderer.renderer.render(this.sceneRenderer.scene,Is,Ss);var a=new Uint8Array(o*i*4);this.sceneRenderer.renderer.readRenderTargetPixels(Ss,0,0,o,i,a);var s=xs.encode({data:a,width:o,height:i,heading:180,pitch:0},e.quality);t({success:!0,message:"data:image/jpg;base64,"+se.uint8ToBase64(s.data),camera:Is})}),findRankedPano:function(e,t){var n=new THREE.Vector3,o=new THREE.Vector3;return function(e,t){Rs(this.player,o),Ts(t,o,n);var i=this.player.rankedPanoInDirection(e,n);if(i){var r=this.objectToHandle[i.id];return r||(this.objectToHandle[i.id]=r=this.handleCount++,this.handleToObject[r]=i),r}return R.warn("Showcase -> findRankedPano: Unable to find nearby pano."),-1}}(),findRankedtag:function(e,t){var n=new THREE.Vector3,o=new THREE.Vector3;return function(e,t){Rs(this.player,o),Ts(t,o,n);var i=this.player.rankedtagInDirection(e,n);if(i){var r=this.objectToHandle[i.sid];return r||(this.objectToHandle[i.sid]=r=this.handleCount++,this.handleToObject[r]=i),r}return R.warn("Showcase -> findRankedtag: Unable to find nearby tag."),-1}}(),clickNearesttag:function(e){this.clickRankedtag(0,e)},clickRankedtag:function(e,t){var n=Ms.call(this,e,t);n&&O.call(this,n)},clickNearestPano:function(e,t){this.clickRankedPano(0,e,t)},clickRankedPano:function(e,t,n){var o=ks.call(this,e,t);o?Ps.call(this,o,n):n(null)},clickPano:function(e,t){var n=this.handleTable[e];n?Ps.call(this,n,t):t(null)},rotateDirection:function(e,t){var n=e.direction,o=e.angle;if(!P.active){var i=0,r=0,a=0,s=0;if(!o||isNaN(o))return R.warn("Showcase -> rotateDirection: Invalid rotation angle."),void(t&&t({success:!1,error:"Invalid rotation angle."}));if(this.player.mode===E.TRANSITIONING)return R.warn("Automation -> rotateDirection: Cannot rotate while transitioning"),void(t&&t({success:!1,error:"Cannot rotate while transitioning"}));if(n===v.RIGHT||n===v.LEFT)n===v.RIGHT&&(o=-o),i=o>0?-1:1,a=o;else{if(n!==v.UP&&n!==v.DOWN)return R.warn("Showcase -> rotateDirection: Invalid direction for rotation: "+n),void(t&&t({success:!1,error:"Invalid direction for rotation."}));if(this.player.mode===E.FLOORPLAN)return R.warn("Showcase -> rotateDirection: Cannot rotate "+n+" in floorplan mode"),void(t&&t({success:!1,error:"Cannot rotate "+n+" in floorplan mode"}));if(n===v.DOWN&&(o=-o),0===(o=N.call(this,o)))return R.warn("Showcase -> rotateDirection: Already at maximum rotation in direction: "+n),void(t&&t({success:!1,error:"Already at maximum rotation in direction: "+n}));r=o>0?1:-1,s=o}var l=o;o=c.Math.degToRad(o),a=c.Math.degToRad(a),s=c.Math.degToRad(s);var u=this.controls.activeControl;u.startRotating(i,r),P.start(a,s,this.player,(function(){u.stopRotating(!0),t&&t({success:!0,message:"Rotated "+l.toFixed(2)+"° in direction: "+e.direction})}))}},rotate:function(){var e=new THREE.Vector3,t=new THREE.Vector3;return function(n,o){var i=n.xAngle,r=n.yAngle;if(!P.active){if(i=i||0,r=r||0,isNaN(i)||isNaN(r))return R.warn("Showcase -> rotate: Invalid rotation angle."),void(o&&o({success:!1,error:"Invalid rotation angle."}));if(this.player.mode===E.TRANSITIONING)return R.warn("Automation -> rotate: Cannot rotate while transitioning"),void(o&&o({success:!1,error:"Cannot rotate while transitioning"}));Math.abs(i)<.01&&(i=0),Math.abs(r)<.01&&(r=0);var a=r;r=N.call(this,r);var s=a>0?"UP":"DOWN";if(!(i=-i)&&a&&!r)return R.warn("Showcase -> rotate: Already at maximum rotation in direction: "+s),void(o&&o({success:!1,error:"Already at maximum rotation in direction: "+s}));a>r&&R.warn("Showcase -> rotate: Reached maximum rotation in direction: "+s);var l=r;r=c.Math.degToRad(r),i=c.Math.degToRad(i),e.copy(this.player.mode===E.FLOORPLAN?I.UP:I.FORWARD),this.player.getDirection(e),t.copy(e).applyAxisAngle(I.UP,i),t.applyAxisAngle(I.RIGHT,r);var u=(e.angleTo(t),i>0?-1:i<0?1:0),h=r>0?1:r<0?-1:0;Math.abs(i)>Math.abs(r)?h*=Math.abs(r/i):Math.abs(r)>Math.abs(i)&&(u*=Math.abs(i/r));var d=this.controls.activeControl;d.startRotating(u,h),P.start(i,r,this.player,(function(){d.stopRotating(!0),o&&o({success:!0,message:"Rotated "+n.xAngle.toFixed(2)+"° horizontally, "+l.toFixed(2)+"° vertically"})}))}}}(),panCamera:function(e,t){function n(e){switch(i.removeAllListeners(T.AutoPanComplete),i.removeAllListeners(T.AutoPanInterrupt),i.removeAllListeners(T.AutoPanClamped),e){case T.AutoPanInterrupt:t({success:!0,message:"Camera panning interrupted."});break;case T.AutoPanClamped:if(i.autoPanPosition.x!==o.x||i.autoPanPosition.z!==o.z){if(Math.abs(this.player.position.x-i.autoPanPosition.x)<.01&&Math.abs(this.player.position.z-i.autoPanPosition.z)<.01)return void t({success:!1,error:"Already at edge of current model bounds."});var n="The view point is outside the bounds for the current model. ";n+="The view point was clamped to "+r(i.target.x,i.target.z),console.warn(n)}case T.AutoPanComplete:t({success:!0,message:"Panned camera to position "+r(i.autoPanPosition.x,i.autoPanPosition.z)})}}if(this.player.mode!==E.DOLLHOUSE&&this.player.mode!==E.FLOORPLAN)return t({success:!1,error:"Camera panning is not available in the current mode: "+this.player.mode});var o=e.position,i=this.player.control;i.setAutoPanPosition(o.x,o.z),i.autoPan=!0;var r=function(e,t){return"("+e.toFixed(2)+", "+t.toFixed(2)+")"};i.on(T.AutoPanComplete,n.bind(this,T.AutoPanComplete)),i.on(T.AutoPanInterrupt,n.bind(this,T.AutoPanInterrupt)),i.on(T.AutoPanClamped,n.bind(this,T.AutoPanClamped))},click:function(e,t){var n=e.x,o=e.y;!0===e.percentage&&(n=n/100*$("#player").width(),o=o/100*$("#player").height()),this.player.handleInputStart(n,o),this.player.updateIntersect(),this.player.handleInputEnd(n,o)},mouseOver:function(e,t){var n=e.x,o=e.y;!0===e.percentage&&(n=n/100*$("#player").width(),o=o/100*$("#player").height()),this.player.handleInputMove(n,o),this.player.updateIntersect()},moveToMode:function(e,t){function n(e){t(e?{success:!1,error:"Failed to load new mode: "+e}:{success:!0,message:"Moved to new mode: "+o})}var o=e.mode;o===E.PANORAMA||o===E.DOLLHOUSE||o===E.FLOORPLAN?this.director.changeMode(o).then((function(){n()}),(function(e){n(e)})):t({success:!1,error:"Invalid mode selection"})}},As=function(e,t,n,o,i){Cs.init(e,t,n,i)},Ds=function(e,t){Cs.takeScreenShot(e,t)};me("Screenshot",(function(){var e,t,n,o;return e=Y("execute"),t=Y("recover"),n=Y("toFish"),o=Y("unFish"),function(){function a(){i(this,a),Object.defineProperty(this,e,{value:r}),Object.defineProperty(this,t,{writable:!0,value:function(e){if(this.player.reticule.visible=!0,this.player.model.floorLogos.firstLogo.visible=e.fL0,this.player.model.floorLogos.secondLogo.visible=e.fL1,this.player.path.currentPanoMarker.mesh.visible=!0,this.player.model.panos.list.forEach((function(e){e.isAligned()&&(e.marker.visible=e.marker.forceHide)})),this.$app.core.get("CameraControls").controls.floorplan.snapshotTopAspect=null,this.player.mode!=Oe.PANORAMA){this.player.model.chunks.forEach((function(e){e.material.side=THREE.FrontSide}));var t=this.$app.core.get("SceneRenderer").scene.skyboxBG;t&&(t.material.side=THREE.BackSide)}this.player.model.skybox.material.side=THREE.BackSide,this.player.OverlayManager.show("all",!0)}}),Object.defineProperty(this,n,{writable:!0,value:function(e){this.player.model.fishSkybox||(this.player.model.fishSkybox=new THREE.Mesh(new THREE.SphereGeometry(Ee.skyRadius,80,50),this.player.model.skybox.material),this.core.get("SceneRenderer").scene.add(this.player.model.fishSkybox)),this.player.model.fishSkybox.position.copy(this.player.position),this.player.model.fishSkybox.visible=!0,this.player.model.skybox.visible=!1;for(var t=0;t<this.player.model.chunks.length;t++)this.player.model.chunks[t].visible=!1;e.cameraPosOld=this.player.camera.position.clone(),this.player.cameraControls.activeControl.fishState=!0,this.player.cameraControls.activeControl.camera.fov=He.fish.insideFOV,this.player.cameraControls.activeControl.target.copy(this.player.position),this.player.updateFromControls()}}),Object.defineProperty(this,o,{writable:!0,value:function(e){if(this.player.mode==Oe.PANORAMA){this.player.cameraControls.activeControl.camera.position.copy(e.cameraPosOld),this.player.cameraControls.activeControl.fishState=!1,this.player.model.fishSkybox.visible=!1,this.player.model.skybox.visible=!0;for(var t=0;t<this.player.model.chunks.length;t++)this.player.model.chunks[t].visible=!0;this.player.cameraControls.activeControl.camera.fov=He.insideFOV}this.player.updateFromControls()}})}return u(a,[{key:"capture",value:function(t){this.player=this.$app.core.get("Player"),(this.player.flying||this.player.isWarping()||this.player.mode==Oe.TRANSITIONING)&&ke.warn("you take a screenshot on flying or transitioning mode!!");var n=this.player.getSize(),o=n.clientWidth,i=n.clientHeight,r=this.player.model.floorLogos.firstLogo.visible,a=this.player.model.floorLogos.secondLogo.visible;this.player.model.panos.list.forEach((function(e){e.isAligned()&&(e.marker.forceHide=e.marker.visible,e.marker.visible=!1)})),this.player.reticule.visible=!1,this.player.model.floorLogos.firstLogo.visible=!1,this.player.model.floorLogos.secondLogo.visible=!1,this.player.path.currentPanoMarker.mesh.visible=!1,this.player.mode!=Oe.PANORAMA&&this.player.model.chunks.forEach((function(e){e.material.side=THREE.BackSide})),this.player.model.skybox.material.side=THREE.DoubleSide,this.player.OverlayManager.hide("all"),t.snapshotTopview&&this.player.mode==Oe.FLOORPLAN&&(this.$app.core.get("CameraControls").controls.floorplan.snapshotTopAspect=o/i),t.changeBefore={fL0:r,fL1:a,notHideTags:t.notHideTags},Q(this,e)[e](t)}}]),a}();function r(i,r){var a,s,l=this;i.tasks.unFish&&i.tasks.unFish.length?(a=i.tasks.unFish.splice(0,1)[0],s="unFish"):i.tasks.fish&&i.tasks.fish.length?(a=i.tasks.fish.splice(0,1)[0],s="fish"):s="finish","unFish"==r&&"fish"==s?Q(this,n)[n](i.changeBefore):"fish"==r&&"finish"==s?(Q(this,o)[o](i.changeBefore),Q(this,t)[t](i.changeBefore)):"finish"==s?Q(this,t)[t](i.changeBefore):ke.info("other state:"+r+"|"+s),"finish"!=s&&Ds({resolution:{width:a.width,height:a.height},quality:He.isSafari?45:60},(function(t){i.done&&i.done(t.message,a.name,t),Q(l,e)[e](i,s)}))}}));var Ls=Object.freeze({Show:0,Hide:1,Retain:2}),zs=Object.freeze({Standard:0,Slow:1,Retain:2});function Vs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}me("Director",(function(){return function(e){f(n,EventEmitter);var t=Vs(n);function n(){var e;return i(this,n),(e=t.call(this)).endlessLoop=He.warp.loop,e.clock=new THREE.Clock(!0),e.currentItem=null,e.destinationItem=null,e.tourIsPlaying=!1,e.nextFunc=null,e.onTheBus=!1,e.reachSource=null,e.interrupted=!1,e.nItems=0,e.currentScript=0,e.walkingSectionPaused=!1,e.C=Object.freeze({None:0,Moving:1,Aiming:2,Interlude:3}),e.I=Object.freeze({Forward:1,NoChange:0,Backwards:-1}),e.transitionStage=e.C.None,e.player=e.$app.core.get("Player"),e}return u(n,[{key:"init",value:function(){this.updateModel(),this.resetAll(),this.bindEvents()}},{key:"resetAll",value:function(){if(this.currentItem=null,this.destinationItem=null,this.tourIsPlaying=!1,this.transitionStage=this.C.None,this.nextFunc=null,this.onTheBus=!1,this.reachSource=null,this.interrupted=!1,this.player.model)switch(this.player.model.switch_scene_type){case 1:this.defaultWarpStyle=De;break;case 2:this.defaultWarpStyle=ze;break;case 3:this.defaultWarpStyle=Le;break;default:this.defaultWarpStyle=De}else this.defaultWarpStyle=De,ke.warn('No model yet, choosing "'+this.defaultWarpStyle+'" transitions');this.resetSpecialTransition()}},{key:"updateModel",value:function(){this.player.model=this.modelManager.getActiveModel(),this.nItems=0}},{key:"bindEvents",value:function(){this.modelManager.on(Oi,this.updateModel.bind(this)),this.player.on(li,this.handleFlyToWarpInterruption.bind(this)),this.player.on(Qo,this.handlePlayerMove.bind(this)),this.player.on(Ko,this.handlePlayerPanoChosen.bind(this)),this.player.on(Xo,this.handlePlayerModeChanged.bind(this)),this.player.on(ci,this.handlePlayerInputStart.bind(this)),this.player.on(ni,this.handlePlayerFlyingStarted.bind(this))}},{key:"handleFlyToWarpInterruption",value:function(e,t){e===ze?(this.interrupt(BlackoutStyle.NONE),this.pauseWalkingSection(),this.player.fastForwardActivePanoFlight()):this.transitionStage===this.C.Interlude&&(this.interrupt(BlackoutStyle.NONE),t&&t())}},{key:"handlePlayerMove",value:function(e){this.transitionStage===this.C.Interlude&&this.interrupt(BlackoutStyle.NONE)}},{key:"handlePlayerPanoChosen",value:function(e,t){this.intermediateState()||e.id===t.id||(this.onTheBus=!1,this.emit("update.controls"))}},{key:"handlePlayerModeChanged",value:function(e,t){this.intermediateState()||e===t||(this.onTheBus=!1,this.emit("update.controls"))}},{key:"handlePlayerInputStart",value:function(e){this.transitionStage===this.C.Interlude&&this.interrupt(BlackoutStyle.NONE)}},{key:"handlePlayerFlyingStarted",value:function(){this.clearWalkingSectionPaused()}},{key:"describe",value:function(){return{nItems:this.nItems,currentItem:this.currentItem,destinationItem:this.destinationItem,tourIsPlaying:this.tourIsPlaying,onTheBus:this.onTheBus,endlessLoop:this.endlessLoop,viewMode:this.player.mode,inTransition:this._inTransition(),transitionStage:this.transitionStage,tourInProgress:this.tourInProgress}}},{key:"_inTransition",value:function(){return this.player.flying||this.player.isWarping()||this.player.isWaitingToWarp()||this.player.mode===Viewmode.TRANSITIONING||this.tourIsPlaying}},{key:"bounceable",value:function(){var e=this.clock.getDelta();return this.isInterrupted()||e<.9&&e>.01||this.player.flying&&!this.player.isWarping()}},{key:"currentMoveDirection",value:function(){return null===this.currentItem||void 0===this.currentItem?this.I.Forward:this.destinationItem===this.currentItem?this.I.NoChange:this.destinationItem>this.currentItem?this.I.Forward:I.Backwards}},{key:"clearPath",value:function(){this._inTransition()||this.player.path.discardPathObject()}},{key:"allFloors",value:function(){this.player.model.toggleAllFloors()}},{key:"actionComplete",value:function(e){var t=this.transitionStage;if(this.interrupted=!1,this.transitionStage=this.C.None,this.resetSpecialTransition(),null!==this.destinationItem&&this.setCurrentItem(this.destinationItem),this.tourIsPlaying||this.player.mode===Oe.PANORAMA&&this.player.currentPano.isAligned()&&this.player.model.fadePanoMarkers(),this.emit("update.controls"),this.currentScript&&(this.player.model.enableTagMovie&&t===this.C.Interlude||this.player.model.enableTagMovie&&t===this.C.Aiming&&null===this.nextFunc))this.openTag();else if(this.nextFunc){var n=this.nextFunc;this.nextFunc=null,n()}}},{key:"awaitCompletion",value:function(e,t){this.nextFunc=t,e()}},{key:"updateSuccessFunction",value:function(e){this.nextFunc=e}},{key:"interrupt",value:function(e,t){return!!this.wouldInterrupt()&&(this.tourIsPlaying&&(this.player.zoomEnabled=this.wasZoomEnabled),this.tourIsPlaying=!1,this.interrupted=!0,this.nextFunc=null,this.emit(DirectorEvents.ActionInterrupted),null!=e||(e=BlackoutStyle.BEGINNING),this.player.interruptAndFastForward(e,t),!0)}},{key:"wouldInterrupt",value:function(){return this.transitionStage!==this.C.None}},{key:"intermediateState",value:function(){return this.transitionStage!==this.C.None}},{key:"isInterrupted",value:function(){return this.interrupted}},{key:"pauseWalkingSection",value:function(){this.walkingSectionPaused=!0}},{key:"clearWalkingSectionPaused",value:function(){this.walkingSectionPaused=!1}},{key:"autoTour",value:function(){He.nestscenes&&He.nestscenes.scenes&&He.nestscenes.scenes.length&&!He.nestscenes.scenes[0].script&&(He.basic.menu.scene_autoplay&&(He.warp.auto=0,$("#play").removeClass("play").addClass("pause"),G.playing=!0,$(".gui-floor").hide(),$(".rightbar").hide(),$("#userlogo").hide(),$("#page-view").hide(),$("#back-url").hide(),$(".indoordir, .indoorscale").hide(),$("#virgule, #barrageShow, #barrageCon").hide()),He.warp.auto>=0&&transitions.trigger({duration:1e3*Math.min(300,He.warp.auto),done:function(){this.playTour()}.bind(this),name:"_atr"}))}},{key:"atDestinationPano",value:function(){if(!this.player.currentPano||null===this.destinationItem)return!1;var e=this.player.currentPano.id;if(void 0===e)return!1;var t=this.player.model.heroLocations;return null!==this.destinationItem&&void 0!==t[this.destinationItem]&&e==t[this.destinationItem].panoId}},{key:"redirectToItem",value:function(e,t){if(null!=e)if(this.wouldInterrupt())if(this.player.mode!==Oe.TRANSITIONING){ke.debug("Director.redirectToItem() -> Redirecting to "+e+" via "+t);var n=function(){transitions.setTimeout(function(){this.setDestinationItem(e),ke.info("from redirectToItem"),this.goToDestination(!0,BlackoutStyle.BEGINNING,He.warp.warpInterruptionRedirectTime,!1)}.bind(this),0)}.bind(this);this.interrupt(BlackoutStyle.END,0),this.updateSuccessFunction(n)}else ke.debug("Director.redirectToItem() -> Cannot redirect while transitioning.");else ke.warn("Director.redirectToItem() -> Director cannot redirect if there is nothing to interrupt.");else ke.warn("Director.redirectToItem() -> Redirecting to null item.")}},{key:"useSpecialTransition",value:function(e){void 0!==e&&this.defaultWarpStyle!==De&&ke.debug("useSpecialTransition(): "+e),this.nextWarpStyle=this.defaultWarpStyle}},{key:"resetSpecialTransition",value:function(){this.nextWarpStyle=this.defaultWarpStyle}},{key:"arrivedAtDestination",value:function(e){if(this.player.flying||this.player.isWarping())ke.warn("Cannot advance to interlude or aiming while player is flying or warping.");else{this.transitionStage=this.C.Aiming;var t=this.tourIsPlaying?this.tourInterlude.bind(this,this.nextItem(this.currentItem)):null;this.player.model.fadePanoMarkers(0),this.awaitCompletion(function(){this.resetSpecialTransition(),e?this.player.aimTourCamera(this.destinationItem,Ls.Retain,Ls.Slow,this.actionComplete.bind(this)):this.actionComplete()}.bind(this),t)}this.play.control.canPlay||(this.play.control.canPlay=!0),this.play.control.wait&&this.play.control.isPlaying&&(this.record.updateFragmentUI(this.play.control.currentIndex),this.play.control.wait=!1)}},{key:"toast",value:function(e){setTimeout((function(){document.getElementsByClassName("toast-wrap")[0].getElementsByClassName("toast-msg")[0].innerHTML=e;var t=document.getElementsByClassName("toast-wrap")[0];t.className=t.className.replace("toastAnimate",""),setTimeout((function(){t.className=t.className+" toastAnimate"}),10)}),10)}},{key:"tour360view",value:function(){if(this.player.currentPano&&2===this.player.currentPano.alignmentType){var e=this.player.model.language;this.toast(e.watchPr)}else $("#play").hasClass("play")}},{key:"goToDestination",value:function(e,t,n,o){if(this.destinationItem=objects.play.control.currentIndex,this.onTheBus=!0,this.emit("update.controls"),o||!this.atDestinationPano())if(this.player.flying||this.player.isWarping())ke.warn("Cannot go to new destination while player is flying or warping.");else{var i=this.player.model.getHeroDescriptorByIndex(this.destinationItem),r=null,a=null;if(null!=i.pano&&void 0!==i.pano){var s=0===this.destinationItem||e?De:this.nextWarpStyle;a=this.player.warpToPanoByHeroIndex.bind(this.player,this.destinationItem,Ls.Show,zs.Slow,s,t,n,this.actionComplete.bind(this)),r=this.arrivedAtDestination.bind(this,!0)}else a=this.player.warpToNonPanoByHeroIndex.bind(this.player,this.destinationItem,this.actionComplete.bind(this)),r=this.arrivedAtDestination.bind(this,!1);this.transitionStage=this.C.Moving,this.player.model.fadePanoMarkers(0,null,{hideVideoFlag:!0}),this.awaitCompletion(function(){a()}.bind(this),r),this.emit("update.controls")}else this.arrivedAtDestination(!0)}},{key:"tourInterlude",value:function(){if(this.player.model.fadePanoMarkers(0),this.emit("update.controls"),this.tourIsPlaying)return this.atEndOfTour()&&!this.endlessLoop?(this.tourInProgress=!1,this.stopTour(),this.emit(DirectorEvents.TourEnd),void(this.player.mode===Viewmode.PANORAMA&&this.player.model.fadePanoMarkers(He.panorama.markerOpacity))):void this.awaitCompletion(function(){this.transitionStage=this.C.Interlude,this.player.tourInterlude(this.nextItem(this.currentItem),this.actionComplete.bind(this))}.bind(this),this.goNext.bind(this))}},{key:"playTour",value:function(){if(!this.bounceable())return this.tourIsPlaying?void ke.info("tour is already playing"):void(this.wouldInterrupt()||(this.player.emit("tour_auto",this.defaultWarpStyle),this.tourInProgress=!0,this.reachSource="play",this.tourIsPlaying=!0,this.wasZoomEnabled=this.player.zoomEnabled,this.player.zoomEnabled=!1,this.resetSpecialTransition(),this.emit("update.controls"),this.emit(DirectorEvents.TourStart),this.player.enablePreRendering(),this.walkingSectionPaused?(this.clearWalkingSectionPaused(),this.goToDestination()):this.goNext()))}},{key:"hideTourBar",value:function(){browser.isMobile()?$(".btn-cat-play").removeClass("cat-mob-pause").addClass("cat-mob-play"):$(".btn-cat-play").removeClass("cat-pc-pause").addClass("cat-pc-play"),$("#gui").show()}},{key:"stopTour",value:function(){this.isInterrupted()||this.transitionStage===this.C.Moving&&this.checkAndHandleWalkingtourInterruption(this.nextWarpStyle)||(this.tourIsPlaying&&(this.player.zoomEnabled=this.wasZoomEnabled),this.tourIsPlaying=!1,this.interrupt(),this.clearWalkingSectionPaused(),this.resetSpecialTransition(),this.emit("update.controls"))}},{key:"endTourProgress",value:function(){this.tourInProgress=!1,this.emit("update.controls"),this.emit(DirectorEvents.TourEnd)}},{key:"goToHighlight",value:function(e){this.clearWalkingSectionPaused(),this.destinationItem=e,this.useSpecialTransition("Hilight"),this.goToDestination()}},{key:"goToHighlightByLocation",value:function(e){var t=this.player.model.heroLocations.findIndex((function(t){return!(!t.panoId||t.panoId!=e)}));if(!this.wouldInterrupt()){if(ke.debug("<tour.goto "+t+">"),this.wouldInterrupt()&&(t===this.destinationItem?this.interrupt():this.redirectToItem(t,"goToHighlight")),this.isInterrupted())return;this.clearWalkingSectionPaused(),this.setDestinationItem(t),this.useSpecialTransition("Hilight"),this.goToDestination()}}},{key:"prevHighlight",value:function(){this.bounceable()||(this.player.emit("tour_manual","prev"),this.interrupt(BlackoutStyle.BEGINNING)||this.isInterrupted()||(this.clearWalkingSectionPaused(),this.reachSource="prev",this.goPrev()))}},{key:"nextHighlight",value:function(){this.bounceable()||(this.player.emit("tour_manual","next"),this.interrupt(BlackoutStyle.BEGINNING)||this.isInterrupted()||(this.clearWalkingSectionPaused(),this.reachSource="next",this.goNext()))}},{key:"changeMode",value:function(e,t){var n=t||"gui";switch(this.wouldInterrupt()&&this.interrupt(),this.player.controls[e].emit("interaction."+n),this.clearWalkingSectionPaused(),e){case Oe.PANORAMA:this.player.insideMode();break;case Oe.DOLLHOUSE:case Oe.FLOORPLAN:this.player.flyToNewMode({mode:e})}}},{key:"atEndOfTour",value:function(){return this.currentItem>=this.nItems-1}},{key:"firstDestination",value:function(){if(this.nItems<=0)return null;for(var e=0;e<this.nItems;e++)if(this.player.model.images.list[e].script===this.currentScript)return e;return 0}},{key:"finalDestination",value:function(){if(this.nItems<=0)return null;for(var e=this.nItems-1;e>=0;e--)if(this.player.model.images.list[e].script===this.currentScript)return e;return 0}},{key:"goPrev",value:function(){this.tourAdvance(-1)}},{key:"goNext",value:function(){this.tourAdvance(1)}},{key:"setDestinationItem",value:function(e){e>this.nItems&&(e=this.firstDestination()),this.destinationItem=e,this.emit("update.controls")}},{key:"setCurrentItem",value:function(e){this.currentItem=e,this.emit("update.controls")}},{key:"nextItem",value:function(e){return null===e?this.firstDestination():e>=this.nItems-1?this.endlessLoop?this.firstDestination():null:e+1}},{key:"prevItem",value:function(e){return null===e?this.firstDestination():e<0?this.endlessLoop?this.lastDestination():null:e-1}},{key:"tourAdvance",value:function(e){ke.debug("tourAdvance("+e+")"),null===this.currentItem||void 0===this.currentItem?this.setDestinationItem(this.firstDestination()):this.setDestinationItem(this.currentItem+e),this.destinationItem<0?(this.setDestinationItem(this.finalDestination()),this.useSpecialTransition("reverse-looping to end")):this.destinationItem>=this.nItems&&(this.setDestinationItem(this.firstDestination()),this.useSpecialTransition("looping back to start")),this.goToDestination()}}]),n}()}));var Hs=function(e){this.elem=e.elem,this.domParent=e.domParent,this.elem.addEventListener("mousedown",this.beginMove.bind(this)),this.elem.addEventListener("touchstart",this.beginMove.bind(this)),this.elem.addEventListener("pointerdown",this.beginMove.bind(this)),document.addEventListener("mousedown",this.move.bind(this)),document.addEventListener("touchmove",this.move.bind(this)),document.addEventListener("pointermove",this.move.bind(this)),e.cameraControls?e.cameraControls.on("pointerUp",this.moveDone.bind(this)):(document.addEventListener("pointerup",this.moveDone.bind(this)),document.addEventListener("mouseup",this.moveDone.bind(this)),document.addEventListener("touchend",this.moveDone.bind(this)),document.addEventListener("touchcancel",this.moveDone.bind(this))),this.beginMoveFuc=e.beginMoveFuc,this.moveDoneFuc=e.moveDoneFuc,this.hasBound=e.hasBound,this.useTransform=e.useTransform,e.hasBound&&(this.needGetBound=1,window.addEventListener("resize",function(){this.needGetBound=1}.bind(this))),this.recover()};function Os(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}Hs.prototype.beginMove=function(e){if(e.preventDefault(),e.stopPropagation(),this.hasBound&&this.getMoveBound(),!this.moving){var t=(e=e.originalEvent||e).type.indexOf("touch")>-1;if(this.moving=!0,this.useTransform){var n,o,i=this.elem.style.transform;if(i){var r=i.indexOf("("),a=i.indexOf(")");i=i.slice(r+1,a).split(","),n=parseFloat(i[0]),o=parseFloat(i[1])}else n=o=0;this.dragInfo={startElem:{x:n,y:o},endElem:{x:n,y:o}}}else this.dragInfo={startElem:{x:parseFloat(this.elem[0].style.left),y:parseFloat(this.elem[0].style.top)}};this.dragInfo.startMouse={x:t?e.changedTouches[0].clientX:e.clientX,y:t?e.changedTouches[0].clientY:e.clientY},this.beginMoveFuc&&this.beginMoveFuc()}},Hs.prototype.move=function(e){if(this.moving){var t=(e=e.originalEvent||e).type.indexOf("touch")>-1,n=t?e.changedTouches[0].clientX:e.clientX,o=t?e.changedTouches[0].clientY:e.clientY;this.dragInfo.vector={x:n-this.dragInfo.startMouse.x,y:o-this.dragInfo.startMouse.y},this.dragInfo.endElem={x:this.dragInfo.startElem.x+this.dragInfo.vector.x,y:this.dragInfo.startElem.y+this.dragInfo.vector.y},this.hasBound&&(this.dragInfo.endElem.x=Math.max(this.bound.left,this.dragInfo.endElem.x),this.dragInfo.endElem.x=Math.min(this.bound.right,this.dragInfo.endElem.x),this.dragInfo.endElem.y=Math.max(this.bound.top,this.dragInfo.endElem.y),this.dragInfo.endElem.y=Math.min(this.bound.bottom,this.dragInfo.endElem.y)),this.useTransform?this.elem.style.transform="translate("+this.dragInfo.endElem.x+"px,"+this.dragInfo.endElem.y+"px)":(this.elem.style.left=this.dragInfo.endElem.x+"px",this.elem.style.top=this.dragInfo.endElem.y+"px")}},Hs.prototype.moveDone=function(e){this.moving&&(this.getMoveBound(),this.moving=!1,this.move(e),this.moveDoneFuc&&this.moveDoneFuc(this.reportPos()),this.dragInfo.startElem=this.dragInfo.endElem,this.dragInfo.vector={x:0,y:0})},Hs.prototype.getMoveBound=function(){if(this.needGetBound){var e=isMobile?68:100,t=isMobile?32:60,n=($("#player").width()-e)/2;isMobile?this.bound={left:-n,right:n,top:-($("#player").height()/2-$("header")[0].offsetTop-$("header").height()-t/2),bottom:$("#player").height()/2-$("footer").height()-t/2}:this.bound={left:-n,right:n,top:-($("#player").height()/2-50-t/2),bottom:$("#player").height()/2-t/2},console.log(this.bound),this.needGetBound=0}},Hs.prototype.reportPos=function(){return{x:this.dragInfo.endElem.x+this.domParent.clientWidth/2,y:this.dragInfo.endElem.y+this.domParent.clientHeight/2}},Hs.prototype.recover=function(){this.dragInfo={startElem:{x:0,y:0},endElem:{x:0,y:0}},this.useTransform?this.elem.style.transform="":(this.elem.style.left=0,this.elem.style.top=0)};var Fs,Ns=function(e){f(n,EventEmitter);var t=Os(n);function n(){var e,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;return i(this,n),e=t.call(this),o.pos3d&&(e.pos3d=(new THREE.Vector3).copy(o.pos3d)),o.pos2d&&(e.pos2d=(new THREE.Vector2).copy(o.pos2d),e.setElemPos()),e.name=o.name,e.elem=o.elem,e.camera=o.camera,e.domParent=o.domParent,e.player=r,e.useTransform=o.useTransform,e.mayShelter=o.mayShelter,e}return u(n,[{key:"update",value:function(){if(this.pos3d&&!this.dragging){var e=Pe.getPos2d(this.pos3d,this.player,this.camera,this.domParent);if(e.trueSide)if(this.mayShelter&&Pe.ifShelter(this.pos3d,this.player,{x:e.vector.x,y:e.vector.y},this.camera))this.elem.style.display="none";else{if(this.elem.style.display="block",this.driftDir){var t=Pe.getPos2d(this.pos3d.clone().add(this.driftDir)),n=this.elem[0].children[0].getBoundingClientRect(),o=be.getCrossPointAtRect(t.pos,e.pos,n.width,n.height,e.pos.x-n.width/2,e.pos.y-n.height/2).sub(e.pos.clone()),i=100/this.pos3d.distanceTo(this.camera.position);this.pos2d=e.pos.clone().add(o.multiplyScalar((i+o.length())/o.length()))}else this.pos2d=(new THREE.Vector2).copy(e.vector);this.setElemPos()}else this.elem.style.display="none"}}},{key:"setElemPos",value:function(){if(this.useTransform){var e=this.pos2d.x/2*this.domParent.clientWidth,t=-this.pos2d.y/2*this.domParent.clientHeight;this.elem.style.transform="translate("+parseInt(e)+"px,"+parseInt(t)+"px)"}else this.elem.style.left=this.pos2d.x+"px",this.elem.style.top=this.pos2d.y+"px"}}]),n}();function Bs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var js,Us,_s=new THREE.Vector2,Ws={},Zs={};function Qs(e){_s=Gs(e)}function Gs(e){var t=(e=e.originalEvent||e).type.indexOf("touch")>-1;return{x:t?e.changedTouches[0].clientX:e.offsetX,y:t?config.isMobile?e.changedTouches[0].clientY-Fs.domElement.clientHeight():e.changedTouches[0].clientY:e.offsetY}}me("TagEditManager",(function(){return function(e){f(n,e);var t=Bs(n);function n(e){var o,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return i(this,n),(o=t.call(this)).splitView=e,o.panoA,o.paonB,o.markTagPos,o.init(r),e.on("leave",(function(){Fs.unableChangePano=!1})),o}return u(n,[{key:"init",value:function(e){var t=this;if(!this.inited){js=this.$app.dom.querySelector('.player[name="copy"]'),Fs=this.$app.core.get("Player"),this.$app.core.get("TagManager");var n=document.createElement("div");n.className="widgets-rulers",Fs.domElement.append(n),this.markSpotA=new Ns({name:"markSpotA",elem:e.spotA,domParent:Fs.domElement,camera:Fs.camera,useTransform:!0},Fs),this.markSpotB=new Ns({name:"markSpotB",elem:e.spotB,domParent:js,camera:this.splitView.panoramaCam,useTransform:!0},Fs),this.markSpotA.name="markSpotA",this.markSpotB.name="markSpotB",new Hs({elem:this.markSpotA.elem,domParent:Fs.domElement,useTransform:!0,cameraControls:Fs.cameraControls,beginMoveFuc:function(){t.editing&&(t.markSpotA.dragging=!0,Fs.cameraControls.controls.panorama.locked=!0,t.splitView.panoramaCtl.locked=!0)},moveDoneFuc:function(e){t.editing&&(t.markSpotA.dragging=!1,Fs.cameraControls.controls.panorama.locked=!1,t.splitView.panoramaCtl.locked=!1,e&&t.moveToReGetA(e),Fs.mouseCouldBeClickToMove=!1)}}),Us=new Hs({elem:this.markSpotB.elem,domParent:js,useTransform:!0,beginMoveFuc:function(){t.markSpotB.dragging=!0,t.splitView.panoramaCtl.locked=!0,Fs.cameraControls.controls.panorama.locked=!0},moveDoneFuc:function(e){t.markSpotB.dragging=!1,t.splitView.panoramaCtl.locked=!1,Fs.cameraControls.controls.panorama.locked=!1,e&&t.moveToReGetB(e)}}),js.addEventListener("pointerdown",Qs),js.addEventListener("touchstart",Qs),js.addEventListener("pointerup",this.clickToReGetB.bind(this)),js.addEventListener("touchend",this.clickToReGetB.bind(this)),Fs.on("update",(function(e){t.editing&&(e.hasChanged.cameraChanged2&&t.markSpotA.update(),t.splitView.changed()&&t.markSpotB.update())})),Fs.on("pano.chosen",(function(e,n){t.changePano(n)})),Fs.on("pointerDown",(function(e){t.editing&&!t.clickA&&(e.intersect&&t.getA(e.intersect),e.consume())})),Fs.on("ifFocusPoint",(function(e){if(t.editing&&t.markTagPos){e.importance<3&&(e.importance=3,e.aim=t.markTagPos.clone())}})),this.inited=!0}}},{key:"enter",value:function(){var e=this;if(Fs.flying||Fs.flyingToTag)return Fs.flyingToTag,void Fs.once(oi,(function(){e.enter()}));Fs.flyToMode("panorama",(function(){!function t(){Fs.currentPano?(e.editing=!0,e.setSpotPos||Fs.flying||(e.splitView.enter(),e.panoB=e.splitView.panoB,1==He.visions&&(Fs.unableChangePano=!0),e.markSpotA.elem.style.display="none",e.markSpotB.elem.style.display="none",Fs.reticule.visible=!1)):setTimeout(t,50)}()}))}},{key:"reSetPos",value:function(e){var t=this;return this.markTagPos=(new THREE.Vector3).copy(e),Fs.flying||Fs.flyingToTag?(Fs.flyingToTag,void Fs.once(oi,(function(){t.reSetPos()}))):(this.editing=!0,this.hotRePos=!0,this.markSpotA.pos3d=this.clickA=this.markTagPos.clone(),this.markSpotA.enable=!0,this.markSpotB.pos3d=this.clickB=this.markTagPos.clone(),this.markSpotA.elem.style.display="block",this.markSpotB.elem.style.display="block",this.markSpotB.enable=!0,setTimeout((function(){t.markSpotA.update(),t.markSpotB.update()}),300),this.splitView.enter(),this.panoA=this.splitView.panoA,this.panoB=this.splitView.panoB,Fs.flyToPano({pano:Fs.currentPano,aimDuration:500,lookAtPoint:this.markTagPos}),!0)}},{key:"confirmPos",value:function(e){if(this.editing){var t=se.getRandomSid(),n=this.computeHotPos();return e&&Fs.model.add(new e(t,{position:n})),{sid:t,position:n}}}},{key:"exit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.cancel,this.clickA=this.clickB=null,this.markSpotA.pos3d=this.markSpotB.pos3d=null,this.splitView.leave(),this.markSpotA.elem.style.display="none",this.markSpotB.elem.style.display="none",this.markSpotA.pos2d=new THREE.Vector2,this.markSpotB.pos2d=new THREE.Vector2,this.markSpotA.setElemPos(),this.markSpotB.setElemPos(),Fs.reticule.visible=!0,this.hideMarker&&(editSpot.hideMarker.visible=!0,editSpot.hideMarker=null),this.hotRePos=!1,this.editing=!1}},{key:"changePano",value:function(e){this.editing&&this.markTagPos&&(this.splitView.changePano(e),e.assistPano==this.splitView.panoB?this.markSpotA.pos3d.copy(this.clickA):this.markSpotA.pos3d=this.markTagPos.clone(),this.splitView.pauseCameraBind=!0)}},{key:"getA",value:function(e){var t=this;if(!Fs.flying&&this.editing){if(this.panoA=Fs.currentPano,2!=He.visions&&this.panoA==this.panoB){var n=(new THREE.Matrix4).getInverse(Fs.model.matrixWorld.clone()),o=e.point.clone().applyMatrix4(n);if(!this.clickA){this.clickA=this.clickB=o;var i=Fs.model.panos.find([function(e){return Fs.currentPano.neighbourPanos[e.id]&&Fs.currentPano!=e}],[ro.sortFunctions.distanceToPoint(Fs.currentPano.position)]);Fs.unableChangePano=!1,i?Fs.flyToPano({pano:i,lookAtPoint:o.clone()}):console.log("当前场景只有一个pano，所以不走到下一个点")}this.clickA=this.clickB=o}else{if(Fs.currentPano.assistPano!=this.splitView.panoB){if(this.clickA){this.panoA=Fs.currentPano;n=(new THREE.Matrix4).getInverse(Fs.model.matrixWorld.clone());return this.clickA=e.point.clone().applyMatrix4(n),this.markSpotA.pos3d=this.clickA,this.markSpotA.update(),void this.computeHotPos()}this.splitView.setSceneB(),this.splitView.pauseCameraBind=!1}if(!this.getMatchData()){var r=this.panoA.id+"_"+this.panoB.id;if(Ws[r]=(Ws[r]||0)+1,!(Ws[r]>5))return void setTimeout((function(){t.getA(e)}),200);console.error("获取不到matchdata 放弃使用: "+r)}n=(new THREE.Matrix4).getInverse(Fs.model.matrixWorld.clone());if(this.clickA=e.point.clone().applyMatrix4(n),this.dirA=be.getNormalDir(this.clickA,Fs.model.supportsTiles,Fs.currentPano),this.UVa=be.getUVfromDir(this.dirA),this.UVb=this.searchPointAtLeft(this.UVa),this.UVb)this.UVb.x=this.UVb.x.toFixed(3)-0,this.UVb.y=this.UVb.y.toFixed(3)-0;else{console.log("找不到UVb，假设一个");this.UVb={x:this.UVa.x,y:this.UVa.y+-.02}}this.dirB=be.getDirFromUV(this.UVb),this.clickB=function(e,t){e=e.clone();var n=t.skyboxMesh.matrixWorld.clone();return n.getInverse(n),e=be.crossRight(e,n),t.position.clone().add(e)}(this.dirB,this.splitView.panoB)}this.markSpotA.pos3d=this.clickA,this.markSpotB.pos3d=this.clickB,this.markSpotA.elem.style.display="block",this.markSpotB.elem.style.display="block",this.markSpotA.enable=!0,this.markSpotB.enable=!0,this.markSpotA.update(),this.markSpotB.update(),2!=He.visions&&this.panoA==this.panoB?this.markTagPos=this.markSpotA.pos3d.clone():this.computeHotPos()}}},{key:"getB",value:function(e){var t=Pe.getMouseIntersect(this.splitView.panoramaCam,[this.splitView.cube],e),n=(new THREE.Matrix4).getInverse(Fs.model.matrixWorld.clone());this.clickB=t.point.clone().applyMatrix4(n),this.markSpotB.pos3d=this.clickB,this.markSpotB.update(),this.computeHotPos()}},{key:"moveToReGetA",value:function(e){Fs.handleInputStart(e.x,e.y,!0,!0),Fs.updateIntersect({}),Fs.intersect?this.getA(Fs.intersect):this.markSpotA.update(),Fs.mouseDown=!1}},{key:"moveToReGetB",value:function(e){var t=new THREE.Vector2;be.convertScreenPositionToNDC(e.x,e.y,t,js),this.getB(t)}},{key:"clickToReGetB",value:function(e){if(!Us.moving){var t=Gs(e);if(!(Math.abs(_s.x-t.x)>3||Math.abs(_s.y-t.y)>3))if(this.clickA||this.hotRePos){var n=new THREE.Vector2;be.convertScreenPositionToNDC(t.x,t.y,n,js),this.getB(n)}else console.log("..？..")}}},{key:"restricPosAtRoom",value:function(e){var t=Fs.currentPano.position,n=e,o=n.clone().sub(t).normalize(),i=new THREE.Raycaster(t,o,0,t.distanceTo(n)).intersectObjects(Fs.model.colliders);return i&&i.length&&(console.log("热点飘出模型外，矫正："+e.toArray()+" --\x3e "+i[0].point.toArray()),e.copy(i[0].point).sub(o.clone().multiplyScalar(.001))),e}},{key:"computeHotPos",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.panoA||!this.clickA)return null;var t=this.panoA.position.clone(),n=this.panoB.position.clone(),o=this.clickA,i=this.clickB,r=be.getLineIntersect({A:t,B:n,p1:o,p2:i});return e.dontRestric||this.restricPosAtRoom(r),this.markTagPos=r,console.log("markTagPos： ",r.toArray()),r}},{key:"getMatchData",value:function(){var e=this.panoA.id+"_"+this.panoB.id;if(Zs[e])return Zs[e];Mn.get(this.$app.resource.getEditDataURL("mapping/".concat(e,".json"))).then((function(t){Zs[e]=t}))}},{key:"searchPointAtLeft",value:function(e){var t=this.getMatchData();if(e||console.log("!!!"),!t||!t["view pair"]||!t["view pair"].uv)return null;var n,o=e.x,i=e.y,r={},a={},s={},l={},c={leftTop:r,rightTop:a,leftBot:s,rightBot:l};function u(e,t){var n=t[0],r=t[1],a=(n-o)*(n-o)+(r-i)*(r-i);(null==e.dis||e.dis>a)&&(e.dis=a,e.pair=t)}t["view pair"].uv.forEach((function(e){e[0]<o&&e[1]<=i?u(r,e):e[0]>=o&&e[1]<=i?u(a,e):e[0]<o&&e[1]>=i?u(s,e):u(l,e)}));var h=0;for(var d in c)c[d].pair&&h++;var p={};function f(e,t){return e.pair?t.pair?e.dis<t.dis?e:t:e:t}function m(){var e=f(r,s),t=f(a,l),n=f(r,a),c=f(s,l);return p.x=(o-e.pair[0])/(t.pair[0]-e.pair[0]),p.y=(i-n.pair[1])/(c.pair[1]-n.pair[1]),{x:e.pair[2]+(t.pair[2]-e.pair[2])*p.x,y:n.pair[3]+(c.pair[3]-n.pair[3])*p.y}}return(h>=3||2==h&&(r.pair&&l.pair||s.pair&&a.pair))&&(n=m()),n}}]),n}(vo)}));var qs,Ys,$s,Xs=function(){function e(t,n){i(this,e),this.model=t,this.panos=t.panos,this.player=n,this.imagePanos=this.listImagePanos(),this.retryMinimumTime=1e4}return u(e,[{key:"start",value:function(){this.loadNextPano(function(e){e?this.start():(ke.debug("No suitable pano loaded, waiting a little while before looking again"),setTimeout(function(){this.start()}.bind(this),1e3))}.bind(this))}},{key:"validLoadTarget",value:function(e){return e&&!e.isLoaded("high")&&Date.now()-e.failedLoadingAt>this.retryMinimumTime}},{key:"listImagePanos",value:function(){var e=[],t=this;return this.model.images.forEach((function(n){if(n.metadata&&n.metadata.scan_id){var o=t.model.panos.get(n.metadata.scan_id);o&&!o.isLoaded("high")&&e.push(o)}})),e}},{key:"nextNotLoadedImage",value:function(){for(;this.imagePanos.length>0;){var e=this.imagePanos[0];if(!e.isLoaded("high"))return e;this.imagePanos.shift()}return null}},{key:"loadNextPano",value:function(e){var t,n,o=this.model.waitQueue.filter((function(e){return e.object instanceof Panorama}));o.length>0?(t=o[0].object,ke.debug("Overrode pano selection: Flying to an unloaded pano "+t.id)):this.validLoadTarget(this.player.currentPano)?(t=this.player.currentPano,ke.debug("Overrode pano selection: Currently at an unloaded pano "+t.id)):this.validLoadTarget(this.player.closestPano)?(t=this.player.closestPano,ke.debug("Overrode pano selection: Hovering over an unloaded pano "+t.id)):this.validLoadTarget(this.nextNotLoadedImage())?(n="high",t=this.imagePanos[0],ke.debug("Overrode pano selection: Highlight image "+t.id)):this.player.mode===Viewmode.PANORAMA&&(t=this.panos.lowestByScore([this.validLoadTarget.bind(this),Panorama.filters.isNeighbourPanoTo(this.player.currentPano)],[Panorama.scoreFunctions.distance(this.player.currentPano),Panorama.scoreFunctions.direction(this.player.position,this.player.getDirection()),Panorama.scoreFunctions.inFieldOfView(this.player.position,this.player.getDirection())]))&&ke.debug("Normal pano selection: neighbor "+t.id),t?(n=n||t.isLoaded("low")?"high":"low",ke.debug("Preloading "+n+"-res pano "+t.id),t.loadCube(n).done(e).fail((function(){ke.warn("Failed preloading pano",t.id,", marking it as failed and forgetting it for a while"),e()}))):e&&e(null)}}]),e}(),Js=function(){function e(t,n){i(this,e),this.quickstart=!0,this.mode=Oe.PANORAMA,this.zoom=-1,this.fov=Ce.urlHasValue("fov")?Number(Ce.urlQueryValue("fov")):He.insideFOV,this.pano=null,this.position=new THREE.Vector3,this.quaternion=new THREE.Quaternion,this.init(t,n)}return u(e,[{key:"init",value:function(e,t){var n=Ce.urlHasValue("pose",!0);if(n)try{n=se.replaceAll(n,"pano",'"pano"'),n="{"+(n=se.replaceAll(n,"qua:",'"qua":['))+"]}";var o=JSON.parse(n);this.pano=t.get(o.pano),this.pano?(this.quaternion=(new THREE.Quaternion).fromArray(o.qua),this.zoom=-1,this.setByUrl=!0):(n=!1,console.error("检测到firstView但是 找不到该pano"))}catch(e){n=!1,console.error("检测到firstView但是解析出错"+e)}else if(e&&e.entry){var i=e.entry;this.updateByEntry(i,t)}else this.pano=t.list[0],this.quaternion.copy(this.pano.quaternion);this.position.copy(this.pano.position),this.quaternion.equals(new THREE.Quaternion(-.5,.5,.5,.5))&&(this.quaternion.set(0,0,0,1),console.log("检测到初始画面quaternion为-0.5,0.5,0.5,0.5，强制更改为0,0,0,1"))}},{key:"updateByEntry",value:function(e,t){"string"==typeof e&&(e=JSON.parse(e)),e.pano&&(this.pano=t.get(e.pano)),null==this.pano&&(this.pano=t.list[0]),this.quaternion.copy(this.pano.quaternion),e.camera&&(this.quaternion=(new THREE.Quaternion).fromArray(e.camera.quaternion),this.zoom=e.camera.zoom)}},{key:"fromGuideView",value:function(e,t){this.mode=e.value.mode,this.zoom=e.value.zoom,this.position.copy(e.value.pos),this.quaternion.set(e.value.qua._x,e.value.qua._y,e.value.qua._z,e.value.qua._w),this.pano=t.get(e.value.pano)}}]),e}();function Ks(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var el,tl={},nl=function(e){f(n,EventEmitter);var t=Ks(n);function n(e,o){var r,a;return i(this,n),(r=t.call(this)).changed=function(){var e,t=this.panoramaCam.position.clone(),n=this.panoramaCam.quaternion.clone();return a&&xe.closeTo(a.position,t,5)&&xe.closeTo(a.quaternion,n,5)||(e=!0),e&&(a={position:t,quaternion:n}),e},r.$app=e,r.init(),r.editType=o,r.pauseCameraBind,r}return u(n,[{key:"init",value:function(){var e=this;$s=this.$app.core.get("Player"),Ys=this.$app.dom.querySelector('.player[name="copy"]'),(qs=new THREE.WebGLRenderer({antialias:!0})).setPixelRatio(window.devicePixelRatio),qs.setSize(300,300,!1),Ys.appendChild(qs.domElement);var t=this.$app.withNewComponent("CameraControls");if(t.init(Ys,["panorama"]),t.activateControls("panorama"),this.panoramaCtl=t.activeControl,this.panoramaCam=t.activeControl.camera,this.panoramaCam.fov=60,this.panoramaCam.name="splitViewCam",this.panoramaCam.layers.toggle(lt),this.panoramaCam.layers.enable(ct),this.panoramaCam.layers.enable(ht),this.panoramaCam.layers.enable(dt),this.panoramaCam.layers.enable(pt),2!=He.visions||$s.model.panos.list[0].assistPano||(He.visions=1,console.warn("自动更改 visions = 1")),2!=He.visions&&$s.model.supportsTiles){var n=this.$app.withNewComponent("SceneRenderer",1),o=this.$app.withNewComponent("PanoRenderer",1),i=this.$app.withNewComponent("TileDownloader",1);i.index=1,n.renderer=qs,i.processPriorityQueue=!0,o.init(n,i),(el=new so).extend($s.model.panos.list.map((function(t){var n=new ro(e.$app,t.id,t);return n.attachToPanoRenderer(o),n.tileDownloader=i,n.qualityManager=e.$app.core.get("QualityManager"),n}))),i.setPanoData(el,[],this.$app.core.get("ModelManager").projectNum),i.setUrls($s.model.urls),i.start()}this.cube=new THREE.Mesh(new THREE.BoxGeometry(10,10,10),new ho({side:THREE.BackSide,transparent:!1,name:"splitViewCubeMat",not_Cube:2==He.visions},"skybox")),this.cube.name="splitView-cube",this.cube.layers.set(pt),this.$app.core.get("SceneRenderer").scene.add(this.cube),$s.on("updateFromControls",(function(t,n){e.editing&&(e.pauseCameraBind?e.panoramaCtl.update(n):(e.panoramaCtl.lon=t.cameraControls.controls.panorama.lon,e.panoramaCtl.lat=t.cameraControls.controls.panorama.lat,e.panoramaCtl.update(n),t.cameraControls.controls.panorama.lon=e.panoramaCtl.lon,t.cameraControls.controls.panorama.lat=e.panoramaCtl.lat))}))}},{key:"enter",value:function(){if(!this.editing){this.editing=!0,this.$app.core.get("SceneRenderer").addComponent(this);var e=$s.cameraControls.cameras.panorama;e.fov=e.staticFov=60,this.zoomEnabled=He.zoom.enabled,He.zoom.enabled=!1,this.pauseCameraBind=!1,this.panoA=$s.currentPano,this.setSize(),this.setSceneB(),this.emit("enter"),$s.OverlayManager.hide("all")}}},{key:"leave",value:function(){this.editing&&(this.$app.core.get("SceneRenderer").removeComponent(this),this.emit("leave"),this.editing=!1,He.zoom.enabled=this.zoomEnabled,$s.OverlayManager.show("all",!0))}},{key:"setSceneB",value:function(){var e=this.panoB;2!=He.visions?(this.panoB=this.panoA,this.cube.position.copy(this.panoB.position),this.panoramaCam.position.copy(this.panoB.position)):this.panoB!=this.panoA.assistPano&&(this.panoB=this.panoA.assistPano,this.cube.position.copy(this.panoB.position),this.panoramaCam.position.copy(this.panoB.position),this.hideMarker&&(this.hideMarker.visible=!0),this.hideMarker=this.panoA.marker,this.hideMarker.visible=!1),this.getTextureForCube(this.panoB),e&&e!=this.panoB&&e.exit()}},{key:"getTextureForCube",value:function(e){var t=this;e=e||this.panoB;2!=He.visions&&$s.model.supportsTiles&&(e=el.index[e.id]);var n=function(){if(tl[t.panoB.id]&&(clearTimeout(tl[t.panoB.id]),delete tl[t.panoB.id]),e&&t.panoB.id!=e.id)console.log("getTextureForCube退出");else{console.log("texGetted "),e.ensureSkyboxReadyForRender();var n=e.getSkyboxTexture();t.cube.material.uniforms.pano1Map.value=n,t.cube.material.uniforms.pano1Matrix.value.copy(t.panoB.skyboxMesh.matrixWorld)}};if(e.tiled){var o=zi.getHFOVForCamera($s.camera,$s.domElement.clientWidth/2,$s.domElement.clientHeight),i=$s.zoomFov,r=$s.getDirection();e.loadTiledPano(2048,r,{hFov:o,vFov:i},!1,!1,!0).then((function(){n()})),$s.checkAndWaitForPanoLoad(e,"high","high",2048,(function(){}))}else $s.checkAndWaitForPanoLoad(e,"high","high",2048,(function(){n()}))}},{key:"update",value:function(){this.editing&&qs.render(this.$app.core.get("SceneRenderer").scene,this.panoramaCam)}},{key:"setSize",value:function(){this.editing&&(qs.setSize(Ys.clientWidth,Ys.clientHeight,!0,Math.min(window.devicePixelRatio,2)),this.panoramaCam.updateAspect(Ys.clientWidth/Ys.clientHeight))}},{key:"changePano",value:function(e){this.panoA=e}}]),n}();me("Scene",(function(){return function(){function e(){var t=this;i(this,e),this.ready=!1,this.loaded=!1,this.tilegen=!0,this.quickstart=!1,this.position=new THREE.Vector3(15,10,15),this.splitViews=[],!1===this.$app.config.view&&(this.locked=_e(),this.$app.store.on("auth",(function(e){t.locked.resolve()})))}var t,n,o,r,a;return u(e,[{key:"beforeLoad",value:function(){this.$app.withComponent("Screenshot"),this.$app.withComponent("SceneRenderer"),this.$app.withComponent("PanoRenderer"),this.$app.withComponent("PanoVideoRenderer"),this.$app.withComponent("QualityManager"),this.$app.withComponent("ModelManager"),this.$app.withComponent("CameraControls"),this.$app.withComponent("DisplayController"),this.$app.withComponent("TileDownloader",{concurrentDownloads:this.tilegen?6:2}),this.$app.withComponent("Player"),this.$app.withComponent("Director"),this.$app.core.get("SceneRenderer").createScene(),this.$app.core.get("CameraControls").init(this.$app.dom.querySelector(".player")),this.$app.core.get("QualityManager").init(),this.$app.core.get("TileDownloader").init(),this.$app.core.get("PanoRenderer").init()}},{key:"start",value:(a=S(C.mark((function e(){var t,n;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!1!==this.$app.config.view){e.next=14;break}return e.prev=1,e.next=4,this.$app.resource.auth();case 4:if(0!=e.sent.success){e.next=8;break}return e.next=8,this.locked;case 8:e.next=14;break;case 10:return e.prev=10,e.t0=e.catch(1),e.next=14,this.locked;case 14:return e.next=16,this.$app.resource.metadata();case 16:if(t=e.sent,this.beforeLoad(),!this.$app.Scene.locked){e.next=21;break}return e.next=21,this.$app.Scene.locked;case 21:return this.$app.core.get("TileDownloader").start(),n=JSON.parse(JSON.stringify(t)),e.next=25,es.handle(n,this.$app);case 25:return this.$app.core.get("PanoVideoRenderer").init(n.videos),e.next=28,this.$app.resource.visions();case 28:return this.initPanos(t),e.next=31,this.isQuick(t);case 31:return e.next=33,this.$app.resource.modelmesh();case 33:return e.next=35,this.$app.resource.textures();case 35:return this.$app.Scene.emit("ready"),this.ready=!0,e.next=39,this.$app.resource.floorcad();case 39:return e.next=41,this.$app.resource.flooruser();case 41:return this.$app.core.get("SceneRenderer").addComponent(Se),this.$app.core.get("Player").model.build(),this.afterLoad(),this.$app.core.get("Player").model.supportsTiles||new Xs(this.$app.core.get("Player").model,this.$app.core.get("Player")).start(),e.next=47,this.loadPanos();case 47:case"end":return e.stop()}}),e,this,[[1,10]])}))),function(){return a.apply(this,arguments)})},{key:"isQuick",value:(r=S(C.mark((function e(t){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.firstView.quickstart){e.next=3;break}return e.next=3,this.quickEnter(this.firstView,t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"loadPanos",value:(o=S(C.mark((function e(){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.$app.core.get("Player").start(this.firstView);case 2:this.firstView.quickstart&&(this.$app.core.get("SceneRenderer").removeComponent(this.$app.core.get("QuickstartManager")),this.$app.core.get("QuickstartManager").destroy()),this.loaded=!0,this.$app.Scene.emit("loaded",this.$app.core.get("Player").currentPano),this.$app.store.get("tags"),this.$app.store.get("tour");case 7:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"initPanos",value:function(e){this.startSceneRenderer();var t=this.$app.core.get("Player").model;this.$app.core.get("ModelManager").init(),this.$app.core.get("ModelManager").addModel(t),this.firstView=new Js(e,t.panos),this.firstView.quickstart=!0}},{key:"afterLoad",value:function(){this.$app.core.get("SceneRenderer").scene.add(this.$app.core.get("Player").model),this.$app.core.get("Player").init(),this.$app.core.get("Player").setScene(),this.$app.core.get("DisplayController").init(),rs.bindEvents(this.$app.core.get("Player")),this.$app.core.get("SceneRenderer").addComponent(this.$app.core.get("Player")),As(this.$app.core.get("Director"),this.$app.core.get("CameraControls"),this.$app.core.get("Player"),this.$app.core.get("ModelManager"),this.$app.core.get("SceneRenderer"))}},{key:"startSceneRenderer",value:function(){if(!this.$app.core.get("SceneRenderer").started){try{this.$app.core.get("SceneRenderer").start(this.$app.dom.querySelector(".player"))}catch(e){ke.error(e.message)}1==this.$app.uid&&hs.Init(this.$app.core.get("SceneRenderer"),this.$app.core.get("Player"))}}},{key:"quickEnter",value:(n=S(C.mark((function e(t,n){var o,i,r=this;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.$app.core.get("CameraControls").activateControls(Oe.PANORAMA),o=this.$app.core.get("CameraControls").controls[Oe.PANORAMA],this.$app.withComponent("QuickstartManager",this.$app.core.get("QualityManager"),this.$app.core.get("SceneRenderer").scene,this.$app.core.get("SceneRenderer").camera,o),i=this.$app.core.get("QuickstartManager"),e.next=6,i.load(t);case 6:this.$app.core.get("SceneRenderer").addComponent(i),this.$app.core.get("SceneRenderer").once(jr,(function(){ke.info("".concat(r.$app.config.num,"First render after quickstart load finished."))}));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"split",value:(t=S(C.mark((function e(t){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.$app.dom.classList.add("kankan-app__split"),e.prev=1,e.next=4,this.$app.resource.visions2();case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1),ke.warn("".concat(this.$app.config.num,"[load visions2] fail"));case 9:return this.splitViews[t]||(this.splitViews[t]=new nl(this.$app,t)),this.splitViews[t].enter(),e.abrupt("return",this.splitViews[t]);case 12:case"end":return e.stop()}}),e,this,[[1,6]])}))),function(e){return t.apply(this,arguments)})},{key:"restore",value:function(e){this.$app.dom.classList.remove("kankan-app__split"),this.splitViews[e].leave()}}]),e}()}));var ol={damPro:Base64.decode("bWVzc2FnZSBiaW5hcnlfbWVzaCB7CglyZXBlYXRlZCBjaHVua19zaW1wbGUgY2h1bmsgPSAxOwoJcmVwZWF0ZWQgY2h1bmtfcXVhbnRpemVkIHF1YW50aXplZF9jaHVuayA9IDI7Cn0KCi8vIERlZmluaXRpb24gb2YgdmVydGljZXM6IDNEIGNvb3JkaW5hdGVzLCBhbmQgMkQgdGV4dHVyZSBjb29yZGluYXRlcy4KbWVzc2FnZSB2ZXJ0aWNlc19zaW1wbGUgewoJcmVwZWF0ZWQgZmxvYXQgeHl6ID0gMSBbcGFja2VkPXRydWVdOyAgLy8geF8wLHlfMCx6XzAsIHhfMSx5XzEsel8xLCAuLi4KCXJlcGVhdGVkIGZsb2F0IHV2ID0gMiBbcGFja2VkPXRydWVdOyAgLy8gdV8wLHZfMCwgdV8xLHZfMSwgLi4uCn0KCi8vIEluZGV4ZXMgb2YgdmVydGljZXMgb2YgZmFjZXMKbWVzc2FnZSBmYWNlc19zaW1wbGUgewoJcmVwZWF0ZWQgdWludDMyIGZhY2VzID0gMSBbcGFja2VkPXRydWVdOyAvLyBpMDAsaTAxLGkwMiwgaTEwLGkxMSxpMTIsIC4uLgp9CgovLyBBIHNpbXBseSBlbmNvZGVkIGNodW5rLgovLyBUT0RPOiBhZGQgY2h1bmsgcHJvcGVyaXRlcyAoc3VjaCBhcyAicmVmbGVjdGl2ZSIpCm1lc3NhZ2UgY2h1bmtfc2ltcGxlIHsKCW9wdGlvbmFsIHZlcnRpY2VzX3NpbXBsZSB2ZXJ0aWNlcyA9IDE7CglvcHRpb25hbCBmYWNlc19zaW1wbGUgZmFjZXMgPSAyOwoJb3B0aW9uYWwgc3RyaW5nIGNodW5rX25hbWUgPSAzOwoJb3B0aW9uYWwgc3RyaW5nIG1hdGVyaWFsX25hbWUgPSA0Owp9CgovLyBRdWFudGl6ZWQgdmVyc2lvbnMgZm9sbG93OgptZXNzYWdlIHZlcnRpY2VzX3F1YW50aXplZCB7CglvcHRpb25hbCBmbG9hdCBxdWFudGl6YXRpb24gPSAxOwoJcmVwZWF0ZWQgZmxvYXQgdHJhbnNsYXRpb24gPSAyOwoJcmVwZWF0ZWQgc2ludDMyIHggPSAzIFtwYWNrZWQ9dHJ1ZV07CglyZXBlYXRlZCBzaW50MzIgeSA9IDQgW3BhY2tlZD10cnVlXTsKCXJlcGVhdGVkIHNpbnQzMiB6ID0gNSBbcGFja2VkPXRydWVdOwp9CgptZXNzYWdlIHV2X3F1YW50aXplZCB7CglvcHRpb25hbCBzdHJpbmcgbmFtZSA9IDE7CglvcHRpb25hbCBmbG9hdCBxdWFudGl6YXRpb24gPSAyOwoJcmVwZWF0ZWQgc2ludDMyIHUgPSAzIFtwYWNrZWQ9dHJ1ZV07CglyZXBlYXRlZCBzaW50MzIgdiA9IDQgW3BhY2tlZD10cnVlXTsKfQoKLy8gSW5kZXhlcyBvZiB2ZXJ0aWNlcyBvZiBmYWNlcwptZXNzYWdlIGZhY2VzX2NvbXByZXNzZWQgewoJcmVwZWF0ZWQgc2ludDMyIGZhY2VzID0gMSBbcGFja2VkPXRydWVdOyAvLyBpMDAsaTAxLGkwMiwgaTEwLGkxMSxpMTIsIC4uLgp9CgptZXNzYWdlIGNodW5rX3F1YW50aXplZCB7CglvcHRpb25hbCBzdHJpbmcgY2h1bmtfbmFtZSA9IDE7CglvcHRpb25hbCBzdHJpbmcgbWF0ZXJpYWxfbmFtZSA9IDI7CglvcHRpb25hbCB2ZXJ0aWNlc19xdWFudGl6ZWQgdmVydGljZXMgPSAzOwoJcmVwZWF0ZWQgdXZfcXVhbnRpemVkIHV2cyA9IDQ7CglvcHRpb25hbCBmYWNlc19zaW1wbGUgZmFjZXMgPSA1Owp9Cg=="),visionmodeldataPro:Base64.decode("Ly8KLy8gUHJvdG9jb2wgQnVmZmVyIGZvciBwdWNrIHZpc2liaWxpdHkgYW5kIHJlbGF0ZWQgZGF0YQovLwovL3BhY2thZ2UgZW9zLnN0b3JhZ2U7CgovLyBpbXBvcnQgImVvcy9pbmZyYS9jb21tb24ucHJvdG8iOwovLyBUaGUgZm9sbG93aW5nIHdlcmUgbWFudWFsbHkgZXh0cmFjdGVkIGhlcmUsIEpTIGRvZXMgbm90IGxpa2UgcHJvdG9idWYgaW1wb3J0cwoKbWVzc2FnZSBBZmZpbmUzZiB7CglvcHRpb25hbCBRdWF0ZXJuaW9uZiByb3RhdGlvbiA9IDE7CglvcHRpb25hbCBWZWN0b3IzZiB0cmFuc2xhdGlvbiA9IDI7Cn0KCm1lc3NhZ2UgUXVhdGVybmlvbmYgewoJb3B0aW9uYWwgZmxvYXQgdyA9IDE7CglvcHRpb25hbCBmbG9hdCB4ID0gMjsKCW9wdGlvbmFsIGZsb2F0IHkgPSAzOwoJb3B0aW9uYWwgZmxvYXQgeiA9IDQ7Cn0KCm1lc3NhZ2UgVmVjdG9yM2YgewoJb3B0aW9uYWwgZmxvYXQgeCA9IDE7CglvcHRpb25hbCBmbG9hdCB5ID0gMjsKCW9wdGlvbmFsIGZsb2F0IHogPSAzOwp9CgovLwovLyBPbmUgc3dlZXAgLyBwYW5vCi8vCm1lc3NhZ2UgU3dlZXBMb2NhdGlvbiB7CglvcHRpb25hbCBieXRlcyB1dWlkID0gMTsgIC8qIHV1aWQgKi8KCW9wdGlvbmFsIEFmZmluZTNmIHBvc2UgPSAyOyAgLyogY2FtZXJhIHBvc2UgKHgsIHkseikgaW4gbWV0ZXIgYW5kIGEgcXVhdGVybmlvbiovCglvcHRpb25hbCBWZWN0b3IzZiBwdWNrID0gMzsgIC8qIHB1Y2sgbG9jYXRpb24gLSB4IGFueSBpcyBnZW5lcmFsbHkgdGhlIHNhbWUgYXMgcG9zZSwgeiBpcyB0aGUgaGVpZ2h0IG9mIHRoZSBjbG9zZXN0IGZsb29yIHVuZGVyIHRoZSBjYW1lcmEgKi8KCW9wdGlvbmFsIGludDMyIGdyb3VwID0gNDsgIC8qIGZsb29yIGluZGV4ICovCglvcHRpb25hbCBpbnQzMiBzdWJncm91cCA9IDU7ICAvKiByb29tIGluZGV4ICovCglyZXBlYXRlZCBpbnQzMiB2aXNpYmxlcyA9IDY7ICAvKiBsaXN0IG9mIGluZGljZXMgdG8gYWxsIHB1Y2tzIHZpc2libGUgZnJvbSB0aGlzIHB1Y2sgKi8KCXJlcGVhdGVkIGludDMyIHZpc2libGVzMiA9IDc7IAoJcmVwZWF0ZWQgaW50MzIgdmlzaWJsZXMzID0gODsKfQoKLy8KLy8gQWxsIHB1Y2tzIGluIGEgbW9kZWwuIFB1Y2tzIGFyZSBzdG9yZWQgaW4gc2Nhbm5pbmcgb3JkZXIuCi8vCm1lc3NhZ2UgTmF2aWdhdGlvbkluZm8gewoJcmVwZWF0ZWQgU3dlZXBMb2NhdGlvbiBzd2VlcExvY2F0aW9ucyA9IDE7Cn0="),decoderMesh(){return dcodeIO.ProtoBuf.loadProto(this.damPro).build("binary_mesh")},decoderModeldata(){return dcodeIO.ProtoBuf.loadProto(this.visionmodeldataPro).build("NavigationInfo")},decompressMesh(e){var t=null;try{t=this.decoderMesh().decode(e)}catch(e){return ke.error("failed parsing proto for .dam"),null}return t},decompressModeldata(e){var t=null;try{t=this.decoderModeldata().decode(e)}catch(e){return ke.error("failed parsing proto for .modeldata"),null}return t}};function il(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var rl=function(e){f(n,THREE.Mesh);var t=il(n);function n(e){var o;i(this,n);var r=new ho({side:THREE.DoubleSide});(o=t.call(this,e.geometry,r)).materialInside=r;var a=THREE.UniformsUtils.clone(Ht.modelOutside.uniforms);return o.materialOutside=new THREE.RawShaderMaterial({fragmentShader:Ht.modelOutside.fragmentShader,vertexShader:Ht.modelOutside.vertexShader,uniforms:a,side:THREE.FrontSide,name:"chunkOut"}),o.name=e.name||"",o.textureName=e.textureName,o.meshUrl=e.meshUrl,o}return u(n,[{key:"setTextureMap",value:function(e){this.materialInside.uniforms.map.value=e,this.materialOutside.uniforms.map.value=e}},{key:"setMode",value:function(e){var t=this.materialInside;e!==Oe.DOLLHOUSE&&e!==Oe.FLOORPLAN||(t=this.materialOutside),e===Oe.PANORAMA?t.side=THREE.BackSide:t.side=THREE.FrontSide,t.transparent=this.material.transparent,t.uniforms.opacity.value=this.material.uniforms.opacity.value,this.material=t}}]),n}(),al={convertProtobufToSceneObject:function(e,t,n){if(0==t.chunk.length)return ke.warn("No chunks in damfile..."),null;var o=new THREE.Matrix4;return o.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),t.chunk.map((function(t){var n=new THREE.BufferGeometry;return n.addAttribute("position",new THREE.BufferAttribute(new Float32Array(t.vertices.xyz,0,3),3)),t.vertices.uv.length>0&&n.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(t.vertices.uv,0,2),2)),n.setIndex(new THREE.BufferAttribute(new Uint32Array(t.faces.faces,0,1),1)),n.applyMatrix(o),n.computeBoundingBox(),new rl({geometry:n,textureName:t.material_name,name:t.chunk_name,meshUrl:e.resource.getViewImagesURL(He.job+He.format)})}))},visionModeldata:function(e){var t;e.sweepLocations.forEach((function(e){e.visibles3=e.visibles3||[],e.visibles.forEach((function(t){-1==e.visibles3.indexOf(t)&&e.visibles3.push(t)}))}));for(var n=e.sweepLocations.length,o=0;o<n;o++){if((e.sweepLocations[o].visibles2&&e.sweepLocations[o].visibles2.length||0)>0){t=!0;break}}t||(e.sweepLocations.forEach((function(e){e.visibles2=null})),ke.info("检测到疑似没有noblock数据，应该是手动上传，block置空"));var i=e.sweepLocations.map(function(e){return{uuid:e.uuid.toUTF8().replace(/-/g,""),position:{x:e.pose.translation.x,y:e.pose.translation.y,z:e.pose.translation.z},quaternion:{x:e.pose.rotation.x,y:e.pose.rotation.y,z:e.pose.rotation.z,w:e.pose.rotation.w},puck:{x:e.puck.x,y:e.puck.y,z:e.puck.z},alignmentType:e.alignment_type,neighbours:e.visibles3||e.visibles,noBlocks:e.visibles2,seeMarkers:e.visibles,group:e.group,subgroup:e.subgroup}}.bind(this)).map(function(e){return e.position=this.convertVisionVector(e.position),e.quaternion=this.convertVisionQuaternion(e.quaternion),e.puck=this.convertVisionVector(e.puck),e}.bind(this));return i.forEach((function(e){e.neighbours=e.neighbours.map((function(e){return i[e].uuid}))})),i.forEach((function(e){e.noBlocks&&(e.noBlocks=e.noBlocks.map((function(e){return i[e].uuid})))})),i.forEach((function(e){e.seeMarkers&&(e.seeMarkers=e.seeMarkers.map((function(e){return i[e].uuid})))})),i},panos:function(e,t,n){var o=e.core.get("Player").model.panos;return o.extend(t.map(function(t){return new ro(e,t.uuid,t,e.core.get("PanoVideoRenderer").videosInfo.videos.get(t.uuid))}.bind(this)),"id"),o.forEach((function(e){e.neighbourUUIDs&&(e.neighbourUUIDs.forEach((function(t){var n=o.get(t);n&&o.setNeighbour(e,n,!0)})),e.neighbourPanos=o.getNeighbours(e)||[])})),0===o.length&&ke.warn("Model has no panos, turning off inside mode"),o},panosAssist(e,t){return e.map(function(e){return e.isAssist=!0,new ro(t,e.uuid,e)}.bind(this))},convertVisionVector:function(e){return new THREE.Vector3(e.x,e.z,-e.y)},convertVisionQuaternion:function(e){return new THREE.Quaternion(e.x,e.z,-e.y,e.w).multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),THREE.Math.degToRad(90)))},convertWorkshopVector:function(e){return new THREE.Vector3(-e.x,e.y,e.z)},convertWorkshopQuaternion:function(e){return new THREE.Quaternion(-e.x,e.y,e.z,-e.w).multiply(new THREE.Quaternion(Math.sqrt(2)/2,Math.sqrt(2)/2,0,0))}},sl={parseIdsFromChunkName(e,t){t.floorId=this.parseFloor(e),t.roomId=this.parseRoom(e)},parseFloor(e){var t=e.match(/_group([0-9]+)/);if(!t)return 0;try{return parseInt(t[1],10)}catch(e){return logger.warn('Non-int value "'+t[1]+'" for mesh group, defaulting to floor 0'),0}},parseRoom(e){var t=e.match(/_sub([0-9]+)/);if(!t)return-1;try{return parseInt(t[1],10)}catch(e){return logger.warn('Non-int value "'+t[1]+'" for mesh subgroup, defaulting to subgroup 0'),0}}},ll={load:(e,t,n)=>new Promise((function(n){function o(e,o){e||(t.push(o),++a===i&&n())}if(!e.chunks[0]||!e.chunks[0].meshUrl)return n();var i=se.countUnique(e.chunks.map((function(e){return e.textureName})));e.chunks[0].meshUrl.indexOf("_50k");var r="low";He.minimalMemoryMode&&"high"===r&&(Ce.detectSamsungS6()?(ke.warn("Galaxy S6 cannot handle large textures, turning down quality."),r="low"):i>He.maxMobileTextures&&(ke.warn("Model probably too large for mobile, turning down quality."),r="low"));var a=0,s=e.data.job.uuid+"_50k_texture_jpg_high1/";e.chunks.forEach((function(t){if(!t.material.map&&t.textureName){var n=e.urls.get(s+t.textureName);t.setTextureMap(In.load(n,o.bind(this,In.isLoaded(n))))}}))}))},cl=oe(),ul=function(e){return e.floors||(e={floors:[e]}),e.floors.map((function(e){return e.column=e.column||[],e.window=e.window||[],e.door=e.door||[],e.groundCase=e.groundCase||[],e.bayCase=e.bayCase||[],e.slideDoor=e.slideDoor||[],e.tagging=e.tagging||[],e.furnColumn=e.furnColumn||[],e.furnFlue=e.furnFlue||[],(e.rooms||e.room||e.points)&&(e.room=e.rooms||e.room||e.points,e.room.forEach((function(t){isNumber(t.top)||(t.top=isNumber(e.top)?e.top:1),isNumber(t.bottom)||(t.bottom=isNumber(e.bottom)?e.bottom:1),!t.ground&&t.points&&(t.ground=t.points),t.hole||(t.hole=[]),t.close=!0}))),e})),e};me("resource",(function(){return function(){function e(){i(this,e),this.reload=!1,this.version=Date.now()}var t,n,o,r,a,s,l,c,h,d,p,f,m,v,g;return u(e,[{key:"num",get:function(){return this.$app.config.num}},{key:"mode",get:function(){return this.$app.config.view?"view":"edit"}},{key:"time",get:function(){return this.reload||this.refresh?(this.reload&&(this.reload=!1,this.refresh=Date.now()),this.refresh):this.version}},{key:"base",value:function(e){return cl+e}},{key:"auth",value:(g=S(C.mark((function e(){var t;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("edit"==this.mode){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.$app.remote_editor.getAuth({num:this.num});case 5:return(t=e.sent).success&&this.$app.store.set("auth",t.data),e.abrupt("return",t);case 10:throw e.prev=10,e.t0=e.catch(2),e.t0;case 13:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(){return g.apply(this,arguments)})},{key:"metadata",value:(v=S(C.mark((function e(){var t,n;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(ke.time("".concat(this.$app.config.num,"[load metadata]").concat(this.$app.uid)),t=window.__KANKAN_DATA,n=null,null!=t){e.next=24;break}if(!this.$app.config.view){e.next=10;break}return e.next=7,Mn.get("/service/scene/getInfo?num=".concat(this.$app.config.num,"&_=").concat(this.time));case 7:n=e.sent,e.next=13;break;case 10:return e.next=12,Mn.get("/service/scene/edit/getInfo?num=".concat(this.$app.config.num,"&_=").concat(this.time));case 12:n=e.sent;case 13:if(!n.success){e.next=22;break}(t=n.data).entry&&"string"==typeof t.entry&&(t.entry=JSON.parse(t.entry)),t.boxVideos&&"string"==typeof t.boxVideos&&(t.boxVideos=JSON.parse(t.boxVideos)),t.boxPhotos&&"string"==typeof t.boxPhotos&&(t.boxPhotos=JSON.parse(t.boxPhotos)),t.videos&&"string"==typeof t.videos&&(t.videos=JSON.parse(t.videos)),t.version&&(this.version=t.version),e.next=24;break;case 22:return this.$app.Scene.emit("error",{type:"network",code:n.code,message:n.message}),e.abrupt("return");case 24:return ke.timeEnd("".concat(this.$app.config.num,"[load metadata]").concat(this.$app.uid)),this.$app.store.set("metadata",t),e.abrupt("return",t);case 27:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"modeldata",value:(m=S(C.mark((function e(){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.visions();case 2:return e.next=4,this.modelmesh();case 4:return e.next=6,this.textures();case 6:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"visions",value:(f=S(C.mark((function e(){var t,n,o=this;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ke.time("".concat(this.$app.config.num,"[load visions]").concat(this.$app.uid)),e.next=3,Mn.getBueffer(this.getResourceURL("scene_view_data/{num}/images/vision.modeldata?_=".concat(this.version)));case 3:return t=e.sent,e.next=6,this.$app.store.get("metadata");case 6:n=e.sent,ke.timeEnd("".concat(this.$app.config.num,"[load visions]").concat(this.$app.uid)),function(e){ke.time("".concat(o.$app.config.num,"[parse modeldata]").concat(o.$app.uid));var t=ol.decompressModeldata(e);"ajk"==n.dataSync&&o.$app.DataSYNC.use("DataAJK",{sweepLocations:t});var i=al.visionModeldata(t);ke.timeEnd("".concat(o.$app.config.num,"[parse modeldata]").concat(o.$app.uid)),o.$app.core.get("Player").model.panos=al.panos(o.$app,i,n)}(t);case 10:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"visions2",value:(p=S(C.mark((function e(){var t,n,o=this;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.$app.core.get("Player").model,ke.time("".concat(this.$app.config.num,"[load visions2]").concat(this.$app.uid)),e.next=4,Mn.getBueffer(this.getResourceURL("scene_view_data/{num}/images/vision2.modeldata?_=".concat(this.version)));case 4:n=e.sent,ke.timeEnd("".concat(this.$app.config.num,"[load visions2]").concat(this.$app.uid)),function(e){ke.time("".concat(o.$app.config.num,"[parse modeldata2]").concat(o.$app.uid));var n=ol.decompressModeldata(e),i=al.visionModeldata(n);ke.timeEnd("".concat(o.$app.config.num,"[parse modeldata2]").concat(o.$app.uid)),al.panosAssist(i,o.$app).forEach((function(e){t.panos.index[e.id-1].assistPano=e}))}(n);case 8:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"modelmesh",value:(d=S(C.mark((function e(){var t,n,o=this;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=function(e,t){if(0===e.length){ke.warn("No geometry found for model, loading faux geometry, disabling outside mode"),t.model.supportedModes[Oe.DOLLHOUSE]=!1,t.model.supportedModes[Oe.FLOORPLAN]=!1;var n=new rl({geometry:new THREE.PlaneBufferGeometry(5,5,1,1)});n.material.visible=!1,n.rotateX(-Math.PI/2),n.geometry.computeBoundingBox(),e=[n]}e.forEach((function(e){var n=0;t.model.floorsEnabled&&(n=sl.parseFloor(e.name)),t.model.addChunk(n,e)})),t.model.floors.sort()},ke.time("".concat(this.$app.config.num,"[load modelmesh]").concat(this.$app.uid)),e.next=4,Mn.getBueffer(this.getResourceURL("scene_view_data/{num}/images/dacf7dfa24ae47fab8fcebfe4dc41ab9_50k.dam?_=".concat(this.version)));case 4:t=e.sent,ke.timeEnd("".concat(this.$app.config.num,"[load modelmesh]").concat(this.$app.uid)),function(e){ke.time("".concat(o.$app.config.num,"[parse dam]").concat(o.$app.uid));var t=ol.decompressMesh(e),i=al.convertProtobufToSceneObject(o.$app,t);ke.timeEnd("".concat(o.$app.config.num,"[parse dam]").concat(o.$app.uid)),n(i,o.$app.core.get("Player"))}(t);case 8:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"textures",value:(h=S(C.mark((function e(){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ke.time("".concat(this.$app.config.num,"[load textures]").concat(this.$app.uid)),e.next=3,ll.load(this.$app.core.get("Player").model,this.$app.core.get("Player").model.meshTextures,this);case 3:ke.timeEnd("".concat(this.$app.config.num,"[load textures]").concat(this.$app.uid)),this.$app.core.get("Player").model.meshTexturesLoaded=!0;case 5:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"floor",value:(c=S(C.mark((function e(){var t;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=null,e.prev=1,ke.time("".concat(this.$app.config.num,"[load floor]").concat(this.$app.uid)),e.next=5,Mn.get(this.getResourceURL("scene_view_data/{num}/data/floor.json?_=".concat(this.time)));case 5:t=e.sent,ke.timeEnd("".concat(this.$app.config.num,"[load floor]").concat(this.$app.uid)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),ke.warn("loaded [floor] error");case 12:return e.abrupt("return",t);case 13:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(){return c.apply(this,arguments)})},{key:"floorcad",value:(l=S(C.mark((function e(){var t;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=null,e.prev=1,ke.time("".concat(this.$app.config.num,"[load floorcad]").concat(this.$app.uid)),e.next=5,Mn.get(this.getResourceURL("scene_view_data/{num}/data/floorplan_cad.json?_=".concat(this.time)));case 5:(t=e.sent).floors||(t=ul(t)),t&&t.floors&&(t.floors=t.floors.filter((function(e){return e.segment&&e.segment.length>0}))),ke.timeEnd("".concat(this.$app.config.num,"[load floorcad]").concat(this.$app.uid)),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(1),ke.warn("loaded [floorcad] error"),t={floors:[{id:0,subgroup:0,name:"1楼","vertex-xy":[{id:0,x:5.531,y:-6.046},{id:1,x:5.531,y:5.777},{id:2,x:-2.663,y:5.777},{id:3,x:-2.663,y:-6.046}],segment:[{id:0,a:0,b:1,border:!0,exterior:!1},{id:1,a:1,b:2,border:!0,exterior:!1},{id:2,a:2,b:3,border:!0,exterior:!1},{id:3,a:3,b:0,border:!0,exterior:!1}],tagging:[{pos:[.0647071629502,.4580562219187],title:"",content:"",showTitle:!0,showContent:!0}],cadInfo:{cadBoundingBox:{x_min:-2.663,x_max:5.531,y_min:-6.046,y_max:5.777,z_min:0,z_max:0},res:56.38726775494,currentScale:1.702512}}]};case 15:return this.$app.store.set("floorcad",t),e.abrupt("return",t);case 17:case"end":return e.stop()}}),e,this,[[1,11]])}))),function(){return l.apply(this,arguments)})},{key:"flooruser",value:(s=S(C.mark((function e(){var t,n;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,n=this.$app.store.getValue("metadata"),e.prev=2,ke.time("".concat(this.$app.config.num,"[load flooruser]").concat(this.$app.uid)),!n.floorPlanUser){e.next=10;break}return e.next=7,Mn.get(this.getUserResourceURL("floorplan_user.json",this.reload));case 7:t=e.sent,e.next=11;break;case 10:t=JSON.parse(JSON.stringify(this.$app.store.getValue("floorcad")));case 11:ke.timeEnd("".concat(this.$app.config.num,"[load flooruser]").concat(this.$app.uid)),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),ke.warn("loaded [flooruser] error");case 17:return this.$app.store.set("flooruser",t),e.abrupt("return",t);case 19:case"end":return e.stop()}}),e,this,[[2,14]])}))),function(){return s.apply(this,arguments)})},{key:"tags",value:(a=S(C.mark((function e(t){var n,o,i,r=this;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.$app.config.isLoadTags||t){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.$app.store.get("metadata");case 5:if(e.sent.tags){e.next=8;break}return e.abrupt("return",[]);case 8:if(ke.time("".concat(this.num,"[load tags]").concat(this.$app.uid)),n={},"view"!=this.mode){e.next=26;break}if(n.success=!0,e.t0=[],!t){e.next=19;break}return e.next=16,Mn.get(t);case 16:e.t1=e.sent,e.next=22;break;case 19:return e.next=21,Mn.get(this.getUserResourceURL("hot.json"));case 21:e.t1=e.sent;case 22:e.t2=e.t1,n.data={icons:e.t0,tags:e.t2},e.next=29;break;case 26:return e.next=28,this.$app.remote_editor.tag_list({num:this.num});case 28:n=e.sent;case 29:return o=[],n.success&&n.data&&n.data.tags&&n.data.tags&&(i=n.data.tags.map((function(e){return e.position&&(e.position=new THREE.Vector3(e.position.x,e.position.y,e.position.z),e.visiblePanos?e.visiblePanos=e.visiblePanos.map((function(e){return r.$app.core.get("Player").model.panos.index[e]})):e.visiblePanos=r.$app.TagManager.getVisiblePano(e.position)),e.icon&&-1==o.indexOf(e.icon)&&o.push(e.icon),e}))),this.$app.store.set("tags",n.data),ke.timeEnd("".concat(this.num,"[load tags]").concat(this.$app.uid)),e.abrupt("return",i||[]);case 36:e.prev=36,e.t3=e.catch(2),ke.error("loaded [tags] error",e.t3);case 39:case"end":return e.stop()}}),e,this,[[2,36]])}))),function(e){return a.apply(this,arguments)})},{key:"tour",value:(r=S(C.mark((function e(){var t;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$app.store.get("metadata");case 3:if(e.sent.tours){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,Mn.get(this.getUserResourceURL("tour.json"));case 8:t=e.sent,this.$app.store.set("tour",t),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),ke.error("loaded [tour] error",e.t0);case 15:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(){return r.apply(this,arguments)})},{key:"getImage",value:(o=S(C.mark((function e(t){var n;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn.getImage("".concat(this.$app.config.resource).concat(t));case 2:return n=e.sent,this.$app.store.set(t,n),e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getUserImage",value:(n=S(C.mark((function e(t){var n;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Mn.getImage(this.getUserResourceURL(t)),this.$app.store.set(t,n),e.abrupt("return",n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getAppImage",value:(t=S(C.mark((function e(t){var n;return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Mn.getImage(this.base(t));case 2:return n=e.sent,this.$app.store.set(t,n),e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getAppURL",value:function(e){return this.base(e)}},{key:"getServerURL",value:function(e){return this.$app.config.server+e}},{key:"getResourceURL",value:function(e){return this.$app.config.resource+e.replace(/\{num\}/g,this.num)}},{key:"getUserResourceURL",value:function(e,t){return e&&e.trim()?0===e.indexOf("blob:")?e:(t&&(this.reload=!0),this.$app.config.resource+"scene_".concat(this.mode,"_data/").concat(this.num,"/user/").concat(e,"?_=").concat(this.time)):(console.warn("url is empty"),e)}},{key:"getViewResourceURL",value:function(e){return this.$app.config.resource+"scene_view_data/".concat(this.num,"/").concat(e)}},{key:"getViewDataURL",value:function(e){return this.$app.config.resource+"scene_view_data/".concat(this.num,"/data/").concat(e,"?_=").concat(this.version)}},{key:"getEditDataURL",value:function(e){return this.$app.config.resource+"scene_edit_data/".concat(this.num,"/data/").concat(e,"?_=").concat(this.version)}},{key:"getViewImagesURL",value:function(e){return-1!==e.indexOf("&_=")?e:-1!==e.indexOf("?")?this.$app.config.resource+"scene_view_data/".concat(this.num,"/images/").concat(e,"&_=").concat(this.version):this.$app.config.resource+"scene_view_data/".concat(this.num,"/images/").concat(e,"?_=").concat(this.version)}}]),e}()}));var hl=function(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]),i=o.length,r=new Uint8Array(i);i--;)r[i]=o.charCodeAt(i);return new Blob([r],{type:n})};function dl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var pl=function(e){f(n,e);var t=dl(n);function n(e){var o;return i(this,n),(o=t.call(this)).adjustControlAngel=function(e,t){var n=this.app.core.get("Player");if("panorama"==n.mode){var o=new THREE.Vector3(0,0,-1).applyQuaternion(t||n.quaternion).add(n.position);this.cameraControls.activeControl.lookAt(o)}else{if(!e)return;this.cameraControls.activeControl&&n.cameraControls.activeControl.target.copy(e)}},o.app=e,o.app.Scene.on("loaded",(function(){o.app.core.get("Player").on(Ko,(function(e){o.emit(Ko,e)})),o.app.core.get("Player").on(ni,(function(e){o.emit(ni,e)})),o.app.core.get("Player").on(oi,(function(e){o.emit(oi,e)})),o.app.core.get("Player").on(Go,(function(e){o.emit(Go,e)})),o.app.core.get("Player").on(Yo,(function(e){o.emit(Yo,e)})),o.app.core.get("Player").on(qo,(function(e){o.emit(qo,e)})),o.app.core.get("Player").on($o,(function(e){o.emit($o,e)})),o.app.core.get("Player").model.on("floor.changed",(function(e,t,n){o.emit("floor.changed",{toMode:t,floorIndex:e.floorIndex})}))})),o}return u(n,[{key:"mode",get:function(){return this.app.core.get("Player").mode}},{key:"isCurrentPanoHasVideo",get:function(){return this.app.core.get("Player").currentPano.hasVideo}},{key:"panorama",value:function(){return this.app.Scene.ready?this.app.core.get("Player").insideMode():Promise.resolve()}},{key:"floorplan",value:function(){var e=_e();return this.app.core.get("Player").flyToNewMode({mode:Oe.FLOORPLAN},e),e}},{key:"dollhouse",value:function(){var e=_e();return this.app.core.get("Player").flyToNewMode({mode:Oe.DOLLHOUSE},e)}},{key:"vr",value:function(){var e=this;return this.app.core.get("Player").flyToMode("panorama",(function(){return e.app.core.get("Player").vrModeChange()}))}},{key:"zoom",value:function(e){this.app.core.get("Player").zoomTo(e)}},{key:"rotate",value:function(){}},{key:"getPose",value:function(){var e=this.app.core.get("Player");return{mode:e.mode,position:e.position,quaternion:e.quaternion,zoomLevel:e.zoomLevel,panoId:e.currentPano&&e.currentPano.id,currentScale:e.cameraControls.controls.floorplan.currentScale,modeTran:e.modeTran,flying:e.flying,nextPano:e.nextPano}}},{key:"getPoseUrlParams",value:function(){var e;return e=this.app.core.get("Player").getSnapAngleInfo(),"pose=pano:".concat(e.metadata.scan_id,",qua:").concat(be.toPrecision(e.metadata.camera_quaternion.toArray(),4))}},{key:"setPose",value:function(e){var t=this.app.core.get("Player");if(!t.flying&&!e.flying){var n=t.model.panos.index[e.panoId],o={mode:e.mode,pano:n,quaternion:e.quaternion,zoomLevel:e.zoomLevel,position:e.position,currentScale:e.currentScale,duration:e.duration,aimDuration:e.duration};if(t.mode!=e.mode)t.flyToNewMode(o);else if("panorama"==e.mode)n&&t.flyToPano(o);else{var i=t.cameraControls.controls[e.mode],r=i.camera;e.target&&i.target.copy(e.target),e.position&&r.position.copy(e.position),i.offset.copy(r.position).sub(i.target),"floorplan"==e.mode&&(e.zoom&&(e.currentScale=xe.convertWorkshopOrthoZoom(e.zoom)),e.currentScale&&(i.currentScale=i.absoluteScale=e.currentScale,i.updateZoom()))}}}},{key:"flyToMode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.mode=t,this.mode==t?e&&e():("panorama"!=t||n.pano||(n.pano=this.currentPano),"transitioning"==this.mode&&this.modeTran.split("-")[1]!=t?this.afterCModeFuc.unique=function(){this.afterCModeFuc.unique=e,this.flyToNewMode(n)}.bind(this):(this.afterCModeFuc.unique=e,this.flyToNewMode(n)))}},{key:"flyToPano",value:function(e,t,n){var o=this.app.core.get("Player").model.panos.index[e];o&&this.app.core.get("Player").flyToPano({mode:"panorama",pano:o,lookAtPoint:t,duration:n,aimDuration:n})}},{key:"flyToTag",value:function(e,t){objects.tagManager.activeTag&&objects.tagManager.activeTag!=e&&this.tagManager.dismissActiveTag(),objects.tagManager.navigatingViaTag=!0,objects.tagManager.activateTag(e,"examine"),e.updateBoardOrient=!0,e.examine(this,t,function(){this.following&&(this.play.control.noFly=!0)}.bind(this))}},{key:"flyToPoint",value:function(e,t){var n=this.app.core.get("Player").model.panos.closestPanoTowardPoint({point:e,require:t&&t.require,rank:t&&t.rank})||this.currentPano||this.app.core.get("Player").currentPano;this.app.core.get("Player").flyToPano({pano:n,lookAtPoint:e,duration:t&&t.dur,aimDuration:t&&t.aimDur},t&&t.done)}},{key:"setCompassDisplay",value:function(e){this.app.core.get("Player").compass.setDisplay(e)}},{key:"getScreenshotInfo",value:function(){var e;return e=this.app.core.get("Player").getSnapAngleInfo(),{camera:{quaternion:be.toPrecision(e.metadata.camera_quaternion.toArray(),4),zoom:e.metadata.ortho_zoom||-1},mode:e.metadata.camera_mode||0,pano:e.metadata.scan_id||"",lon:e.metadata.lon,lat:e.metadata.lat}}},{key:"lock",value:function(){this.app.core.get("Player").locked=!0}},{key:"unlock",value:function(){this.app.core.get("Player").locked=!1}},{key:"screenshot",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return t.length||(t=[{width:2048,height:1024,name:"2k"},{width:1024,height:512,name:"1k"},{width:128,height:128,name:"128"}]),new Promise((function(o){var i=t.length,r=[];e.app.core.get("Screenshot").capture({tasks:{unFish:t},snapshotTopview:!0,notHideTags:!0,done:function(e,t){n?r.push({data:hl(e),name:t,type:"blob"}):r.push({data:e,name:t,type:"base64"}),r.length==i&&o(r)}})}))}}]),n}(vo);function fl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}pl.MODE=Oe;var ml=function(e){f(n,e);var t=fl(n);function n(e){var o;return i(this,n),(o=t.call(this)).app=e,o.ready=!1,o.loaded=!1,o.locked=null,o.on("ready",(function(){return o.ready=!0})),o.on("loaded",(function(){o.loaded=!0;var e=o.app.core.get("PanoVideoRenderer");e.on(st.CanPlayVideo,(function(){return o.emit(st.CanPlayVideo)})),e.on(st.StartPlay,(function(){return o.emit(st.StartPlay)})),e.on(st.SuspendRender,(function(){return o.emit(st.SuspendRender)})),e.on(st.ResumeRender,(function(){return o.emit(st.ResumeRender)}))})),o}return u(n,[{key:"panos",get:function(){return this.app.core.get("Player").model.panos}},{key:"panoId",get:function(){return this.app.core.get("Player").currentPano.id}},{key:"floorId",get:function(){return this.app.core.get("Player").currentPano.floorIndex}},{key:"panoCount",get:function(){return this.app.core.get("Player").model.panos.list.length}},{key:"videoCount",get:function(){var e=this.app.store.getValue("metadata").videos;return e&&e.data&&e.data.length?e.data.length:0}},{key:"videoList",get:function(){var e=this.app.store.getValue("metadata").videos;return e&&e.data&&e.data.length?e.data.map((function(e){return e.id})):[]}},{key:"isCurrentPanoHasVideo",get:function(){return this.app.core.get("Player").currentPano.hasVideo}},{key:"showFloorCadImage",value:function(){this.app.core.get("Player").model.floorplanCadImg.displayCad(!0)}},{key:"hideFloorCadImage",value:function(){var e=this;this.app.core.get("Player")?this.app.core.get("Player").model.floorplanCadImg.displayCad(!1):setTimeout((function(){e.hideFloorCadImage()}),100)}},{key:"setFloorLogo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.ready&&this.app.core.get("Player").model.floorLogos.changeFloorLogo(e)}},{key:"gotoFloor",value:function(e){if("all"==e)this.app.core.get("Player").model.toggleAllFloors();else{var t=parseInt(e)-this.app.core.get("Player").model.currentFloor.floorIndex;this.app.core.get("Player").changeFloor(t)}this.app.core.get("Player").model.currentFloorId=e}},{key:"lock",value:function(){this.locked=_e()}},{key:"unlock",value:function(){this.locked&&(this.locked.resolve(),this.locked=null)}}]),n}(vo),vl=function(){function e(t){i(this,e),this.app=t,this.plugin=null,this.display=null,this.hidden=!1,this.deferred=_e()}return u(e,[{key:"install",value:function(e){this.plugin=e,this.deferred.resolve(this.plugin)}},{key:"use",value:function(){return this.plugin?Promise.resolve(this.plugin):this.deferred}},{key:"show",value:function(e){var t=this;return this.display=!0,e&&(this.hidden=!1),this.hidden?Promise.resolve():this.use().then((function(){return t.plugin.show()}))}},{key:"hide",value:function(e){var t=this;return this.display=!1,e&&(this.hidden=!0),this.use().then((function(){return t.plugin.hide()}))}},{key:"reload",value:function(){var e=this;return this.use().then((function(){return e.plugin.data(!0)}))}}]),e}(),gl=function(){function e(t){i(this,e),this.app=t}var t;return u(e,[{key:"use",value:(t=S(C.mark((function e(t,n){return C.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.app.CadManager.use();case 2:e.sent.sync.use(t,n);case 4:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}]),e}();U('.widgets-rulers {\r\n    position: absolute;\r\n    pointer-events: none;\r\n    top: 0;\r\n    left: 0;\r\n    bottom: 0;\r\n    right: 0;\r\n}\r\n\r\n.widgets-rulers .ruler-line {\r\n    position: absolute;\r\n    -webkit-transform-origin: left 0.875px;\r\n    transform-origin: left 0.875px;\r\n    width: 0;\r\n    height: 1.75px;\r\n}\r\n\r\n.widgets-rulers .ruler-line em {\r\n    background: linear-gradient(90deg, hsla(0, 0%, 100%, 0.5), hsla(0, 0%, 100%, 0.3));\r\n    display: block;\r\n    height: 100%;\r\n    -webkit-animation: ruler-line 0.5s ease 1s;\r\n    animation: ruler-line 0.5s ease 1s;\r\n    -webkit-animation-fill-mode: both;\r\n    animation-fill-mode: both;\r\n    -webkit-box-shadow: 0 0 3.5px rgba(0, 0, 0, 0.6);\r\n    box-shadow: 0 0 3.5px rgba(0, 0, 0, 0.6);\r\n}\r\n\r\n.widgets-rulers .ruler-label {\r\n    position: absolute;\r\n    /* width: 0; */\r\n    height: 0;\r\n    top: 0.875px;\r\n    left: 38%;\r\n}\r\n\r\n.widgets-rulers .ruler-label .ruler-label-point {\r\n    position: absolute;\r\n    width: 28px;\r\n    height: 11.375px;\r\n    right: 0;\r\n    bottom: 0;\r\n    background-position: bottom;\r\n    background-repeat: no-repeat;\r\n    background-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgd2lkdGg9IjM0cHgiIGhlaWdodD0iMTVweCIgdmlld0JveD0iMCAwIDM0IDE1IiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPg0KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggNDguMiAoNDczMjcpIC0gaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoIC0tPg0KICAgIDx0aXRsZT5Hcm91cCA3PC90aXRsZT4NCiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4NCiAgICA8ZGVmcz4NCiAgICAgICAgPGNpcmNsZSBpZD0icGF0aC0xIiBjeD0iMS41IiBjeT0iMS41IiByPSIxLjUiPjwvY2lyY2xlPg0KICAgICAgICA8ZmlsdGVyIHg9Ii0xMDAuMCUiIHk9Ii0xMDAuMCUiIHdpZHRoPSIzMDAuMCUiIGhlaWdodD0iMzAwLjAlIiBmaWx0ZXJVbml0cz0ib2JqZWN0Qm91bmRpbmdCb3giIGlkPSJmaWx0ZXItMiI+DQogICAgICAgICAgICA8ZmVPZmZzZXQgZHg9IjAiIGR5PSIwIiBpbj0iU291cmNlQWxwaGEiIHJlc3VsdD0ic2hhZG93T2Zmc2V0T3V0ZXIxIj48L2ZlT2Zmc2V0Pg0KICAgICAgICAgICAgPGZlR2F1c3NpYW5CbHVyIHN0ZERldmlhdGlvbj0iMSIgaW49InNoYWRvd09mZnNldE91dGVyMSIgcmVzdWx0PSJzaGFkb3dCbHVyT3V0ZXIxIj48L2ZlR2F1c3NpYW5CbHVyPg0KICAgICAgICAgICAgPGZlQ29sb3JNYXRyaXggdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuMjk5MzY1OTQyIDAiIHR5cGU9Im1hdHJpeCIgaW49InNoYWRvd0JsdXJPdXRlcjEiPjwvZmVDb2xvck1hdHJpeD4NCiAgICAgICAgPC9maWx0ZXI+DQogICAgPC9kZWZzPg0KICAgIDxnIGlkPSLlm7rlrprnirbmgIEt5Yqg6L29IiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNDI3LjAwMDAwMCwgLTI2Ny4wMDAwMDApIj4NCiAgICAgICAgPGcgaWQ9Ikdyb3VwLTciIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQyOS4wMDAwMDAsIDI2OS4wMDAwMDApIj4NCiAgICAgICAgICAgIDxwYXRoIGQ9Ik0zMS41LDEyLjUgTDIxLjUsMS41IiBpZD0iTGluZS1Db3B5LTExIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMC41IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjwvcGF0aD4NCiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yMS41LDEuNSBMMi41LDEuNSIgaWQ9IkxpbmUtQ29weS0xMiIgc3Ryb2tlPSIjRkZGRkZGIiBzdHJva2Utd2lkdGg9IjAuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48L3BhdGg+DQogICAgICAgICAgICA8ZyBpZD0iT3ZhbC02LUNvcHktNiI+DQogICAgICAgICAgICAgICAgPHVzZSBmaWxsPSJibGFjayIgZmlsbC1vcGFjaXR5PSIxIiBmaWx0ZXI9InVybCgjZmlsdGVyLTIpIiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4NCiAgICAgICAgICAgICAgICA8dXNlIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+DQogICAgICAgICAgICA8L2c+DQogICAgICAgIDwvZz4NCiAgICA8L2c+DQo8L3N2Zz4=");\r\n    background-size: 28px 11.375px;\r\n    -webkit-transform: translateZ(0);\r\n    transform: translateZ(0);\r\n    transform-origin: right center;\r\n    -webkit-animation: ruler-point 0.3s ease 1.3s;\r\n    animation: ruler-point 0.3s ease 1.3s;\r\n    -webkit-animation-fill-mode: both;\r\n    animation-fill-mode: both;\r\n}\r\n\r\n.widgets-rulers .ruler-label .ruler-label-name {\r\n    position: absolute;\r\n    height: 15.75px;\r\n    font-size: 12px;\r\n    line-height: 15.75px;\r\n    right: 28px;\r\n    bottom: 0.875px;\r\n    white-space: nowrap;\r\n    /* max-width: 0; */\r\n    overflow: hidden;\r\n    -webkit-animation: ruler-label 1s ease 1.6s;\r\n    animation: ruler-label 1s ease 1.6s;\r\n    -webkit-animation-fill-mode: both;\r\n    animation-fill-mode: both;\r\n    text-shadow: 0 0 3.5px rgba(0, 0, 0, 0.6);\r\n}\r\n\r\n.widgets-rulers .ruler-label.reverse .ruler-label-point {\r\n    -webkit-transform: rotateY(180deg);\r\n    transform: rotateY(180deg);\r\n}\r\n\r\n.widgets-rulers .ruler-label.reverse .ruler-label-name {\r\n    /* -webkit-transform: rotateY(-180deg); */\r\n    /* transform: rotateY(-180deg); */\r\n    right: auto;\r\n    left: 28px;\r\n}\r\n\r\n.widgets-rulers .measure .ruler-label .ruler-label-name {\r\n    color: #f0ff00;\r\n}\r\n\r\n.widgets-rulers .ruler-intersection {\r\n    position: absolute;\r\n    width: 0;\r\n    height: 0;\r\n}\r\n\r\n.widgets-rulers .ruler-intersection .ruler-intersection-point {\r\n    position: absolute;\r\n    left: 0;\r\n    bottom: 0;\r\n    width: 18.375px;\r\n    height: 7px;\r\n    background-repeat: no-repeat;\r\n    background-size: 18.375px 7px;\r\n    background-position: 50%;\r\n}\r\n\r\n.widgets-rulers .ruler-intersection .ruler-intersection-text {\r\n    position: absolute;\r\n    left: 18.375px;\r\n    bottom: 0;\r\n    font-size: 12px;\r\n    line-height: 12px;\r\n    white-space: nowrap;\r\n    color: #12fffb;\r\n    text-shadow: 0 0 3.5px rgba(0, 0, 0, 0.3);\r\n    -webkit-transform-origin: left center;\r\n    transform-origin: left center;\r\n    -webkit-transform: scale(0.85);\r\n    transform: scale(0.85);\r\n}\r\n\r\n.measure .ruler-label .ruler-label-name {\r\n    font-size: 14px;\r\n    line-height: 14px;\r\n}\r\n\r\n.measure .ruler-label {\r\n    position: absolute;\r\n}\r\n\r\n.measure .ruler-label .ruler-label-point {\r\n    background-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAyMS4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0i5Zu+5bGCXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgMzQgMTUiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDM0IDE1OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KCS5zdDB7ZmlsbDpub25lO3N0cm9rZTojRjBGRjAwO3N0cm9rZS13aWR0aDowLjU7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO30NCgkuc3Qxe2ZpbHRlcjp1cmwoI2ZpbHRlci0yKTt9DQoJLnN0MntmaWxsOiNGMEZGMDA7fQ0KPC9zdHlsZT4NCjxmaWx0ZXIgIGZpbHRlclVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgaGVpZ2h0PSIzMDAuMCUiIGlkPSJmaWx0ZXItMiIgd2lkdGg9IjMwMC4wJSIgeD0iLTEwMC4wJSIgeT0iLTEwMC4wJSI+DQoJPGZlT2Zmc2V0ICBkeD0iMCIgZHk9IjAiIGluPSJTb3VyY2VBbHBoYSIgcmVzdWx0PSJzaGFkb3dPZmZzZXRPdXRlcjEiPjwvZmVPZmZzZXQ+DQoJPGZlR2F1c3NpYW5CbHVyICBpbj0ic2hhZG93T2Zmc2V0T3V0ZXIxIiByZXN1bHQ9InNoYWRvd0JsdXJPdXRlcjEiIHN0ZERldmlhdGlvbj0iMSI+PC9mZUdhdXNzaWFuQmx1cj4NCgk8ZmVDb2xvck1hdHJpeCAgaW49InNoYWRvd0JsdXJPdXRlcjEiIHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIwIDAgMCAwIDAgICAwIDAgMCAwIDAgICAwIDAgMCAwIDAgIDAgMCAwIDAuMjk5MzY1OTQyIDAiPg0KCQk8L2ZlQ29sb3JNYXRyaXg+DQo8L2ZpbHRlcj4NCjx0aXRsZT5Hcm91cCA3PC90aXRsZT4NCjxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPg0KPHBhdGggaWQ9IkxpbmUtQ29weS0xMSIgY2xhc3M9InN0MCIgZD0iTTMzLjUsMTQuNWwtMTAtMTEiLz4NCjxwYXRoIGlkPSJMaW5lLUNvcHktMTIiIGNsYXNzPSJzdDAiIGQ9Ik0yMy41LDMuNWgtMTkiLz4NCjxnIGlkPSJPdmFsLTYtQ29weS02Ij4NCgk8ZyBjbGFzcz0ic3QxIj4NCgkJPGNpcmNsZSBpZD0icGF0aC0xXzJfIiBjbGFzcz0ic3QyIiBjeD0iMy41IiBjeT0iMy41IiByPSIxLjUiLz4NCgk8L2c+DQoJPGc+DQoJCTxjaXJjbGUgaWQ9InBhdGgtMV8xXyIgY2xhc3M9InN0MiIgY3g9IjMuNSIgY3k9IjMuNSIgcj0iMS41Ii8+DQoJPC9nPg0KPC9nPg0KPC9zdmc+DQo=");\r\n    animation-delay: 0.3s;\r\n}\r\n\r\n.measure .ruler-label .ruler-label-name {\r\n    animation-delay: 0.6s;\r\n}\r\n',{});var yl="#f0ff00",wl=new THREE.Mesh(new THREE.SphereBufferGeometry(.01,10,10),new THREE.MeshBasicMaterial({color:yl,depthTest:!1,transparent:!0})),bl=An.createFatLineMat({width:3,color:yl,alwaysShow:!0});function El(e,t){this.player=t,this.setPoints(e.points),this.state=e.state||"active",this.visiblePanos=e.visiblePanos,this.initVisiblePanos(),this.elem=document.createElement("div"),this.elem.className="ruler measure",this.elem.setAttribute("data-name",""),this.elem.style.display="none",document.querySelector(".widgets-rulers").append(this.elem),this.text=e.text||"",this.length=Math.round(100*this.points[0].distanceTo(this.points[1]))/100,this.text="约"+this.length+"米",this.elem.innerHTML='\n\t\t<div class="ruler-label">\n\t\t\t<div class="ruler-label-point"></div>\n\t\t\t<span class="ruler-label-name">'.concat(this.text,"</span>\n\t\t</div>\n\t"),this.player.measureRulers.push(this);var n=new THREE.Object3D;n.name="measure",this.balls=[wl.clone(),wl.clone()],this.balls[0].position.copy(this.points[0]),this.balls[1].position.copy(this.points[1]),this.balls[0].renderOrder=this.balls[1].renderOrder=2,n.add(this.balls[0]),n.add(this.balls[1]),this.line=An.createFatLine([this.points[0].x,this.points[0].y,this.points[0].z,this.points[1].x,this.points[1].y,this.points[1].z],{material:bl}),n.add(this.line),this.boldLine=An.createBoldLine(this.points,{mat:new THREE.MeshBasicMaterial({wireframe:!0,opacity:0,transparent:!0,depthTest:!1,color:"#991111"}),type:"init"},this.player),this.boldLine.parentRuler=this,n.add(this.boldLine),this.player.model.add(n),this.group=n,this.player.$app.config.vrFishTemp&&(this.getPosAtSphere(this.player.currentPano.position),this.updateBoldLine())}El.prototype.setPoints=function(e){this.points=e},El.prototype.initVisiblePanos=function(){var e=this,t=this.player.model.wallManager.roomInfo;if(t)if(this.player.model.wallManager.version=2)for(var n=this.points[0].clone().setY(0),o=this.points[1].clone().setY(0),i=new THREE.Raycaster(n.clone(),o.clone().sub(n).normalize(),0,n.distanceTo(o)).intersectObjects(this.player.model.chunks),r=0;r<i.length;r++){var a=i[r].point.clone(),s=Pe.getVisiblePano(a,this.player.model);this.visiblePanos=this.visiblePanos.concat(s.filter((function(t){return-1==e.visiblePanos.indexOf(t)})))}else for(var l=[new THREE.Vector2(this.points[0].x,this.points[0].z),new THREE.Vector2(this.points[1].x,this.points[1].z)],c=0;c<t.length;c++)for(var u=0,h=t[c].points.length;u<h;u++){var d=[{x:t[c].points[u].x,y:t[c].points[u].y},{x:t[c].points[(u+1)%h].x,y:t[c].points[(u+1)%h].y}];if(be.isLineIntersect(l,d)){t[c].panos.forEach((function(t){-1==e.visiblePanos.indexOf(t.id)&&e.visiblePanos.push(t.id)})),console.log("加入房间 "+c);break}}},El.prototype.remove=function(){var e=objects.player.measureRulers.indexOf(this);objects.player.measureRulers.splice(e,1),this.group.parent.remove(this.group),this.elem.remove()},El.prototype.updateBoldLine=function(){this.player.$app.config.vrFishTemp?An.updateBoldLine(this.boldLine,this.fishPoints,"moveAndRotate"):An.updateBoldLine(this.boldLine,this.points,"update")},El.prototype.showOptionLabel=function(e,t){if(e){objects.tagManager.editSpot.chosenMeasureRuler=this;t=be.getFootPoint(t,this.points[0],this.points[1]);this.optionLabelPos=t,$(".widgets-design-option").css("display",""),this.updateOptionPos()}else objects.tagManager.editSpot.chosenMeasureRuler=null,$(".widgets-design-option").css("display","none"),this.optionLabelPos=null},El.prototype.updateOptionPos=function(){var e=Pe.getPos2d(this.optionLabelPos,this.player);e.trueSide?($(".widgets-design-option div").removeClass("hide"),$(".widgets-design-option div").css({left:e.pos.x+"px",top:e.pos.y+"px"}),e.vector.x>0?$(".widgets-design-option").removeClass("right"):$(".widgets-design-option").addClass("right")):$(".widgets-design-option div").addClass("hide")},El.prototype.getCrossPoint=function(e,t){var n,o,i,r=this.player.domElement.clientWidth,a=this.player.domElement.clientHeight,s=(t.x-e.x)/(t.y-e.y),l=function(t){return s*(t-e.y)+e.x},c=function(t){return 1/s*(t-e.x)+e.y};return t.x>r||t.x<0?(i=t.x>r?r:0,t.y<0||t.y>a?((n=l(o=t.y<0?0:a))>r||n<0)&&(o=c(n=i)):o=c(n=i)):n=l(o=t.y<0?0:a),new THREE.Vector2(n,o)},El.prototype.getPosInCrossPoint=function(e,t){var n=objects.player.domElement.clientWidth,o=objects.player.domElement.clientHeight;return be.getCrossPointAtRect(e,t,n,o,0,0)},El.prototype.getPosAtSphere=function(e,t){this.fishPoints=[];var n=[];this.points.forEach(function(t,o){var i=Pe.getPosAtSphere(t.clone(),e);this.fishPoints.push(i),n.push(i.x,i.y,i.z),this.balls[o].position.copy(i);var r=Constants.skyRadius/e.distanceTo(t);this.balls[o].scale.set(r,r,r)}.bind(this)),An.moveFatLine(this.line,n)};El.prototype.getPosInScreen=function(e,t,n){var o=e.point.clone().add(t.point).multiplyScalar(.5),i=Pe.getPos2d(o,this.player);if(i.trueSide){var r=e.pos2d.trueSide?e.pos2d:t.pos2d;return i.inSight&&(i.pos=this.getPosInCrossPoint(r.pos,i.pos),i.vector=null),{result:"p1p2",p1:r,p2:i}}if(!(n+1>1)){var a=e.pos2d.trueSide?e:t;return this.getPosInScreen(a,{point:o,pos2d:i},++n)}},El.prototype.updateVisible=function(){this.visiblePanos.indexOf(this.player.currentPano.id)>-1?this.state="active":this.state="unable"},El.prototype.update=function(){if("panorama"!=this.player.mode||"active"!=this.state)return this.elem.style.display="none",void(this.group.visible=!1);var e,t,n=Pe.getPos2d(this.points[0],this.player),o=Pe.getPos2d(this.points[1],this.player),i=this.player.domElement.clientWidth,r=this.player.domElement.clientHeight;if(!n.trueSide||!o.trueSide){if(!n.trueSide&&!o.trueSide)return void(this.elem.style.display="none");var a=this.getPosInScreen({point:this.points[0],pos2d:n},{point:this.points[1],pos2d:o},0);if(!a)return void(this.elem.style.display="none");n=a.p1,o=a.p2}var s=n.pos,l=o.pos;if(0!=s.distanceTo(l)){if(n.inSight&&o.inSight)e=(s.x+l.x)/2,t=(s.y+l.y)/2;else{var c,u;c=n.inSight?s.clone():this.getCrossPoint(l,s),u=o.inSight?l.clone():this.getCrossPoint(s,l);var h,d=c.clone().add(u).multiplyScalar(.5);if(e=d.x,t=d.y,d.x>i||d.x<0||d.y>r||d.y<0)return this.elem.style.display="none",void(this.group.visible=!1);if(l.x==s.x){if(l.y==s.y)return void console.warn("pos1和2一样？？？");h=l.y<s.y?(t-l.y)/(s.y-l.y):(l.y-t)/(l.y-s.y)}else h=l.x<s.x?(e-l.x)/(s.x-l.x):(l.x-e)/(l.x-s.x);if(h<0||h>1)return void(this.elem.style.display="none")}this.elem.style.display="",this.group.visible=!0;var p=this.elem.querySelector(".ruler-label");"left"!=this.dir&&e<i/2||"right"==this.dir?p.className.indexOf("reverse")<0&&(p.className+=" reverse"):p.className.replaceAll("reverse",""),p.style.left=e+"px",p.style.top=t+"px"}else console.warn("ruler间距为0！")};var xl=Object.freeze({__proto__:null,tour_save:function(e){return Mn.post("/service/scene/edit/tour/save",e)},tour_delete:function(e){return Mn.post("/service/scene/edit/tour/delete",e)},locales:function(e){return Mn.post("/service/scene/edit/locales",e)},upload_content:function(e){return Mn.post("/service/scene/edit/upload/content",e)},getAuth:function(e){return Mn.postFile("/service/scene/edit/getAuth",e)},saveInitialPage:function(e){return Mn.post("/service/scene/edit/saveInitialPage",e)},base_save:function(e){return Mn.post("/service/scene/edit/base/save",e)},cad_rename:function(e){return Mn.post("/service/scene/edit/cad/rename",e)},icons_delete:function(e){return Mn.post("/service/scene/edit/icons/delete",e)},photo_box_save:function(e){return Mn.post("/service/scene/edit/photo/box/save",e)},photo_box_delete:function(e){return Mn.post("/service/scene/edit/photo/box/delete",e)},mosaics_add:function(e){return Mn.post("/service/scene/edit/mosaics/add",e)},publicScene:function(e){return Mn.post("/service/scene/edit/publicScene",e)},upload_files:function(e){return Mn.postFile("/service/scene/edit/upload/files",e)},delete_file:function(e){return Mn.post("/service/scene/edit/delete/file",e)},saveUpload:function(e){return Mn.post("/service/scene/edit/saveUpload",e)},getInfo:function(e){return Mn.get("/service/scene/edit/getInfo",e)},tagSave:function(e){return Mn.post("/service/scene/edit/tagSave",e)},saveRoam:function(e){return Mn.post("/service/scene/edit/saveRoam",e)},saveTagsVisible:function(e){return Mn.post("/service/scene/edit/saveTagsVisible",e)},cad_save:function(e){return Mn.post("/service/scene/edit/cad/save",e)},tag_save:function(e){return Mn.post("/service/scene/edit/tag/save",e)},tag_delete:function(e){return Mn.post("/service/scene/edit/tag/delete",e)},uploadPanorama:function(e){return Mn.postFile("/service/scene/edit/uploadPanorama",e)},uploadModel:function(e){return Mn.postFile("/service/scene/edit/uploadModel",e)},downloadModel:function(e){return Mn.postFile("/service/scene/edit/downloadModel",e)},tag_list:function(e){return Mn.postFile("/service/scene/edit/tag/list",e)},cad_reset:function(e){return Mn.postFile("/service/scene/edit/cad/reset",e)},downloadPanorama:function(e){return Mn.post("/service/scene/edit/downloadPanorama",e)},video_box_save:function(e){return Mn.post("/service/scene/edit/video/box/save",e)},video_box_delete:function(e){return Mn.post("/service/scene/edit/video/box/delete",e)},uploadBallScreenVideo:function(e){return Mn.postFile("/service/scene/edit/uploadBallScreenVideo",e)},downloadBallScreenVideo:function(e){return Mn.post("/service/scene/edit/downloadBallScreenVideo",e)},sceneSync:function(e){return Mn.postFile("/service/scene/edit/sceneSync",e)}});function Tl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Pl=function(e){f(n,e);var t=Tl(n);function n(e){var o;return i(this,n),(o=t.call(this)).focusBeforeModify=function(e){var t=o.app.core.get("Player");o.editTag=o.tags.find((function(t){return t.sid==e}));var n=t.model.panos.closestPanoTowardPoint({point:o.editTag.position,getAll:!0}).map((function(e){return e.pano})).filter((function(e){return o.editTag.visiblePanos.indexOf(e)>-1&&e.position.clone().setY(o.editTag.position.y).sub(o.editTag.position).length()>1.5})),i=n[0],r=n.filter((function(e){return e.floorIndex==t.model.currentFloor.floorIndex}));r.length>0&&(i=r[0]),i||(i=t.currentPano),t.flyToPano({pano:i,lookAtPoint:o.editTag.position,aimDuration:0,duration:1},(function(){o.edit.enter((function(){o.editHandle.markTagPos=o.editTag.position,o.editHandle.markSpotA.elem.style.display="block",o.editHandle.markSpotB.elem.style.display="block"}),o.editTag.position)}))},o.focus=function(e,t,n){var i=o.app.core.get("Player"),r=new THREE.Vector3,a=o.tags.find((function(t){return t.sid==e.sid}))||e.tag,s=i.model.panos.closestPanoTowardPoint({point:a.position,getAll:!0}).map((function(e){return e.pano})).filter((function(e){return a.visiblePanos.indexOf(e)>-1&&e.position.clone().setY(a.position.y).sub(a.position).length()>1.5})),l=s[0],c=s.filter((function(e){return e.floorIndex==i.model.currentFloor.floorIndex}));c.length>0&&(l=c[0]),l||(console.warn("该热点无可视点位"),l=i.currentPano);var u=function(){a.x=o.convertPositionTo2D(a.position).pos.x,a.y=o.convertPositionTo2D(a.position).pos.y,r.set(0,0,0);var t=a.x-("left"==n?e.arrowBox.width+e.tagBox.width/2:0),s=a.y-("top"==n?e.arrowBox.height+e.tagBox.height/2:0);be.convertScreenPositionToNDC(t,s,r,o.app.dom),r.unproject(i.camera)};if("board"==t)if(l.id==i.currentPano.id&&"panorama"==i.mode){u();var h=new THREE.Vector3(0,0,1).applyQuaternion(i.camera.quaternion).normalize(),d=i.camera.position.clone().sub(a.position).normalize();if(h.dot(d)<0){var p=i.camera.position.clone().sub(r).multiplyScalar(-1);r=i.camera.position.clone().sub(p)}var f=a.x;i.flyToPano({pano:l,lookAtPoint:r},(function(){f>window.innerWidth/4&&f<window.innerWidth/4*3||(u(),o.app.Camera.flyToPoint(r,{aimDur:400}))}))}else i.flyToPano({pano:l,lookAtPoint:a.position,duration:700},(function(){return setTimeout((function(){u(),o.app.Camera.flyToPoint(r,{aimDur:400})}),10)}));else i.flyToPano({pano:l,lookAtPoint:a.position})},o.app=e,o.view=_e(),o.plugin=_e(),o.editTag=null,o.showAllTags=!1,o.tags=null,o._tags=null,o.app.store.on("tags",(function(e){o._tags=e,o.view.then((function(e){!1===e.isLoad&&e.load(o._tags)}))})),o.edit={},o.edit.enter=function(t,n){e.core.get("Scene").split("TAG").then((function(i){null==o.editHandle&&(o.editHandle=e.withNewComponent("TagEditManager",i,{spotA:e.dom.querySelector('.player[name="main"] .player-mark'),spotB:e.dom.querySelector('.player[name="copy"] .player-mark')})),n?o.editHandle.reSetPos(n):o.editHandle.enter(),t&&t()}))},o.edit.exit=function(){o.editHandle&&(e.core.get("Scene").restore("TAG"),o.editHandle.exit({cancel:!0}),o.editTag=null,setTimeout((function(){var e=o.app.core.get("Player");e.cameraControls.activeControl.camera.fov=70,e.camera.fov=e.baseFov*(1/e.zoomLevel)}),50))},o.edit.confirm=function(){if(o.editHandle){var t=o.editHandle.confirmPos(),n=t.position,i=t.sid;if(!n)return o.edit.exit(),null;var r=o.getVisiblePano(n),a=o.editTag;return null==a?a={position:n,visiblePanos:r,sid:i,icon:e.resource.base("images/tag_icon_default.svg")}:a.position=n,o.edit.exit(),a}},o.edit.confirmMeasure=function(e){if(o.editHandle){var t=o.app.core.get("Player");if(1==e){var n=o.editHandle.confirmPos(),i=n.position;n.sid,o.lastPosition=i,o.editHandle.splitView.enter(),o.measureStep=1}else if(2==e){var r=o.editHandle.confirmPos(),a=r.position;r.sid;var s=o.getVisiblePano(o.lastPosition).concat(o.getVisiblePano(a).filter((function(e){return-1==o.getVisiblePano(o.lastPosition).indexOf(e)}))),l=new El({points:[o.lastPosition,a],visiblePanos:s,state:"active"},t);-1==l.visiblePanos.indexOf(t.currentPano.id)&&l.visiblePanos.push(t.currentPano.id),o.edit.exit(),t.measureRulers.forEach((function(e){e.updateVisible(),"active"==e.state&&e.updateBoldLine()}))}}},o.edit.beginTagVisiSetting=function(){var e=o.app.core.get("Player");e&&e.linkEditor&&(e.linkEditor.enterSet("tagVisible"),e.linkEditor.beginSetTagVisible())},o.edit.setTagVisi=function(e){var t=o.tags.find((function(t){return t.sid==e}));o.app.core.get("Player").linkEditor.SetOneTagVisible(t)},o.edit.resetTagVisi=function(){var e=o.app.core.get("Player").linkEditor,t=e.tagVsetting;e.tagVsetting=null,e.SetOneTagVisible(t)},o.edit.checkNeedSaveTagVisi=function(){return o.app.core.get("Player").linkEditor.checkTagVisiChange()},o.edit.saveTagVisi=function(){var e=o.app.core.get("Player"),t=e.linkEditor.saveTagVisibles(),n=o.app.store.getValue("tags");return t.forEach((function(t){o.tags.find((function(e){return e.sid==t.sid})).visiblePanos=t.value.map((function(t){return e.model.panos.index[t]}))})),n.tags=o.tags,o.app.store.set("tags",n),{data:t,func:e.linkEditor.afterSaveTagVisibles.bind(e.linkEditor)}},o.edit.cancelTagVisiSetting=function(){o.app.core.get("Player").linkEditor.finishSetTagVisible()},o.edit.hideAllTagVisi=function(){var e=o.app.core.get("Player").linkEditor,t=e.tagVsetting;e.setTagHideAll(t)},o.edit.showAllTagVisi=function(){var e=o.app.core.get("Player").linkEditor,t=e.tagVsetting;e.setTagShowAll(t)},o.app.Scene.on("loaded",(function(){var t=e.core.get("Player"),n=[];t.model.floors.list.map((function(e){return n.push.apply(n,L(e.children))}));var i=new THREE.Vector3(0,-1,0),r=new THREE.Raycaster(new THREE.Vector3(0,0,0),i,.001,9999);t.on("update",(function(a){o.emit("update",a),o.tags&&o.tags.length&&o.tags.forEach((function(a){if(!o.showAllTags&&(o.editTag||t.mode!=Oe.PANORAMA||!a.visiblePanos.includes(t.currentPano)))return a.visible=!1;var s=e.TagManager.convertPositionTo2D(a.position);if(a.x=s.pos.x,a.y=s.pos.y,!s.trueSide||!s.inSight)return a.visible=!1;if(t.linkEditor.setTagVisible){r.set(a.position,i);var l=r.intersectObjects(n);if(l.length&&l[0].object.parent.floorIndex!=t.model.currentFloor.floorIndex)return a.visible=!1}a.visible=!0}))}))})),o}return u(n,[{key:"tag",value:function(){return this.ready?Promise.resolve(this):this.plugin.promise()}},{key:"install",value:function(e,t){var n=this;this.ready=!0,this.plugin.resolve(this),this[e]&&(this._tags&&this[e].then((function(e){!1===e.isLoad&&e.load(n._tags)})),this[e].resolve(t))}},{key:"convertPositionTo2D",value:function(e){return Pe.getPos2d(e,this.app.core.get("Player"))}},{key:"ifShelter",value:function(e,t){var n=this.app.core.get("Player"),o=n.model.allFloorsVisible?null:n.model.currentFloor.floorIndex;return Pe.ifShelter(e,n,t,null,o)}},{key:"getVisiblePano",value:function(e){return Pe.getVisiblePano(e,this.app.core.get("Player").model)}},{key:"updatePosition",value:function(e){this.tags=e}},{key:"showAll",value:function(){this.showAllTags=!0}},{key:"hideAll",value:function(){this.showAllTags=!1}},{key:"convertScreenPositionToNDC",value:function(e,t,n){return be.convertScreenPositionToNDC(e,t,n,this.app.dom)}},{key:"convertDBTagDataToSDK",value:function(e){var t=this;return e.map((function(e){return e.position&&(e.position=new THREE.Vector3(e.position.x,e.position.y,e.position.z),e.visiblePanos?e.visiblePanos=e.visiblePanos.map((function(e){return t.app.core.get("Player").model.panos.index[e]})):e.visiblePanos=t.app.TagManager.getVisiblePano(e.position)),e}))}}]),n}(vo),kl=function(){function e(t){var n=this;i(this,e),this.app=t,this.edit={},this.labels=[{key:"porch",text:"玄关",type:"hall"},{key:"masterGuard",text:"主卫",type:"hall"},{key:"aisle",text:"过道",type:"hall"},{key:"guestGuard",text:"客卫",type:"hall"},{key:"kitchen",text:"厨房",type:"hall"},{key:"garage",text:"车库",type:"hall"},{key:"garden",text:"花园",type:"hall"},{key:"balcony",text:"阳台",type:"hall"},{key:"masterBedroom",text:"主卧",type:"room"},{key:"guestBedroom",text:"次卧",type:"room"},{key:"study",text:"书房",type:"room"},{key:"lockerRoom",text:"储物间",type:"room"},{key:"cloakroom",text:"衣帽间",type:"room"},{key:"elderlyRoom",text:"老人房",type:"room"},{key:"childrenRoom",text:"儿童房",type:"room"},{key:"petRoom",text:"宠物房",type:"room"},{key:"livingRoom",text:"客厅",type:"other"},{key:"restaurant",text:"餐厅",type:"other"}],this.plugin=_e();var o=_e(),r=null;this.app.Scene.on("BoxVideo.loaded",(function(){r=n.app.core.get("Player"),o.resolve()})),this.edit.enter=function(){r&&r.OverlayManager?n.app.VideoManager.BoxVideo.hideAll():o.then((function(){return n.edit.enter()}))},this.edit.exit=function(){r&&n.app.VideoManager.BoxVideo.showAll()}}return u(e,[{key:"install",value:function(e){this.target=e,this.plugin.resolve(e)}},{key:"use",value:function(){return this.target?Promise.resolve(this.target):this.plugin.promise()}},{key:"cad",value:function(){return this.target}}]),e}();function Ml(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Rl=function(){function e(t){var n=this;i(this,e),this.getOverlayBySid=function(e){var t=n.app.core.get("Player"),o=t.OverlayManager.group.children.find((function(t){return t.sid==e}));return o||(o=t.OverlayManager.group.children[0],console.warn("无效sid：",e,o)),o},this.app=t,this.edit={};var o=_e(),r=null;this.app.Scene.on("loaded",(function(){(r=n.app.core.get("Player")).EditOverlay=new rr(r),r.OverlayManager=new or(r),r.model.createTranControl(r),o.resolve(),n.app.Scene.emit("BoxVideo.loaded")})),this.edit.enter=function(){if(r&&r.EditOverlay){r.EditOverlay.transformControls?r.EditOverlay.enter():r.EditOverlay.init();var e="panorama"!=r.model.mode?1100:0;setTimeout((function(){var e=r.OverlayManager.group.children.filter((function(e){return"video"==e.overlayType}))[0];e&&r.OverlayManager.clickOverlay(e,!0)}),e)}else o.then((function(){return n.edit.enter()}))},this.edit.exit=function(){r&&r.EditOverlay.leave()},this.edit.save=function(){return r.EditOverlay.getOverlaySavingInfo()},this.edit.undoEdit=function(){r.EditOverlay.undoEdit()},this.edit.add=function(){r.EditOverlay.beginToAddPlane()},this.edit.upload=function(e,t){t.videoWidth||t.width?r.EditOverlay.overlayUploaded(e,t):t.oncanplay=function(){r.EditOverlay.overlayUploaded(e,t)}},this.edit.delete=function(e,t){var o=n.getOverlayBySid(e);r.EditOverlay.DeleteOverlay(o,t)},this.edit.lookAt=function(e){var t=n.getOverlayBySid(e);r.OverlayManager.clickOverlay(t,!0)},this.edit.select=function(e){var t=n.getOverlayBySid(e);r.OverlayManager.clickOverlay(t)},this.edit.unselect=function(){var e=r.EditOverlay.editPlane;e&&(e.raycastToFindFloor(),e.updateVisibleOnFloor(),r.EditOverlay.controlSelectOverlay(null),r.EditOverlay.editPlane=null)},this.edit.setVisible=function(e,t){var o=n.getOverlayBySid(e);o.visible=!!t,r.EditOverlay.editPlane&&r.EditOverlay.controlSelectOverlay(o.visible?o:null)},this.edit.transfrom=function(e){r.EditOverlay.editing&&(r.EditOverlay.transformControls.mode=0==e?"translate":1==e?"scale":"rotate")},this.edit.setPlaneWH=function(e,t){return t.value=THREE.Math.clamp(t.value,t.min,t.max),"W"==e&&(r.EditOverlay.editPlane.scale.x*=t.value/r.EditOverlay.editPlane.width,r.EditOverlay.editPlane.width=t.value),"H"==e&&(r.EditOverlay.editPlane.scale.y*=t.value/r.EditOverlay.editPlane.height,r.EditOverlay.editPlane.height=t.value),t.value},this.edit.setThinkness=function(e){var t=r.EditOverlay;return e.value=THREE.Math.clamp(e.value,e.min,e.max),0==e.value?(t.editPlane.addBox(!1),t.editPlane.depth=.001,t.editPlane.scale.z=.001):(t.editPlane.addBox(!0),t.editPlane.depth=e.value/100,t.editPlane.scale.z=e.value/100/He.overlay.depth),e.value},this.edit.resetRatio=function(){r.EditOverlay.editPlane.overlayType&&(r.EditOverlay.editPlane.width/=r.EditOverlay.editPlane.scale.x,r.EditOverlay.editPlane.height/=r.EditOverlay.editPlane.scale.y,r.EditOverlay.editPlane.scale.setX(1),r.EditOverlay.editPlane.scale.setY(1),r.EditOverlay.updateOverlayScaleDisplay(),r.EditOverlay.useImgRatio())}}return u(e,[{key:"showAll",value:function(){var e=this.app.core.get("Player");e&&(e.OverlayManager.group.visible=!0)}},{key:"hideAll",value:function(){var e=this.app.core.get("Player");e&&(e.OverlayManager.group.visible=!1)}}]),e}(),Il=function(e){f(n,e);var t=Ml(n);function n(e){var o;return i(this,n),(o=t.call(this)).BoxVideo=new Rl(e),o}return n}(ml);function Sl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Cl=function(e){f(n,e);var t=Sl(n);function n(e){var o,r;i(this,n),(o=t.call(this)).app=e,o.edit={};var a=_e();return o.app.Scene.on("loaded",(function(){(r=o.app.core.get("Player")).linkEditor=new yr(r),a.resolve()})),o.edit.enter=function(){r&&r.linkEditor?setTimeout((function(){r.linkEditor.enterSet("panoVisible"),r.labelManager.updateEntryVisi(!1)}),0):a.then((function(){return o.edit.enter()}))},o.edit.exit=function(){r&&r.linkEditor.finishSetPanoVisible()},o.edit.undoEdit=function(){var e=r.linkEditor.startEditPano;r.linkEditor.pauseSetPanoVisible(!1,r.model.currentFloor),e&&e.floorIndex==r.model.currentFloor.floorIndex&&(r.linkEditor.SetOnePanoVisible(e),o.emit("walkManager.active",r.linkEditor.checkLinkStatus()))},o.edit.checkNeedSave=function(){return r.linkEditor.checkPanoVisiChange()},o.edit.save=function(e){e(r.linkEditor.savePanoVisibles(),r.linkEditor.afterSavePanoVisibles.bind(r.linkEditor))},o.edit.toggle=function(e){return r.linkEditor.toggle(e)},o.edit.linkToUpperFloor=function(){var e=r.linkEditor;e.startEditPano||(e.startEditPano=e.activePano);var t=e.getUpperFloor(e.activePano.floorIndex);o.edit.unlinkToOtherFloor(),o.app.Scene.gotoFloor(t),e.setMultiFloorPanoVisible="upper",setTimeout((function(){e.actionIcons.forEach((function(e){return e.visible=!1}));var t=e.lastFloorActivePano;t.footIcon.visible=!0,e.changeIconLinkState(t.footIcon,"floorLinked")}),10)},o.edit.linkToLowerFloor=function(){var e=r.linkEditor;e.startEditPano||(e.startEditPano=e.activePano);var t=e.getLowerFloor(e.activePano.floorIndex);o.edit.unlinkToOtherFloor(),o.app.Scene.gotoFloor(t),e.setMultiFloorPanoVisible="lower",setTimeout((function(){e.actionIcons.forEach((function(e){return e.visible=!1}));var t=e.lastFloorActivePano;t.footIcon.visible=!0,e.changeIconLinkState(t.footIcon,"floorLinked")}),10)},o.edit.floorLinkConfirm=function(){var e=r.linkEditor,t=e.lastFloorActivePano,n=e.linkToFloorPano;o.edit.unlinkToOtherFloor(n),n&&(e.savePanoVisiChange(t.id,[{type:"add",id:n.id}]),e.changeIconVisiState(t.footIcon,e.checkHasNeighbor(t)))},o.edit.unlinkToOtherFloor=function(e){var t=r.linkEditor;t.startEditPano||(t.startEditPano=t.activePano);var n=e||t.activePano,o=t.panoVTemp[n.id]&&t.panoVTemp[n.id].neighbourPanos||r.model.panos.index[n.id].neighbourPanos,i=Object.keys(o).map((function(e){return r.model.panos.index[e]})),a=[];i.forEach((function(e){e.floorIndex!=n.floorIndex&&a.push({type:"sub",id:e.id})})),a.length&&(t.savePanoVisiChange(n.id,a),t.changeIconVisiState(n.footIcon,t.checkHasNeighbor(n)),t.delVisibleLines(),t.showFootIcons(n,!0),t.createPanoVisiLines(n))},o.edit.cancelFloorLink=function(){var e=r.linkEditor;o.app.Scene.gotoFloor(e.lastFloorActivePano.floorIndex),e.actionIcons.forEach((function(e){return e.visible=!0})),e.linkToFloorPano=null,e.setMultiFloorPanoVisible=!1},o}return n}(ml),Al=function(){function e(t,n){i(this,e),this.PanoMosaicManager=n,this.setFromInfo(t),this.getInfo()}return u(e,[{key:"setFromInfo",value:function(e){e.pano?this.pano=e.pano:this.pano=this.PanoMosaicManager.player.model.panos.index[e.panoId],this.dir=e.dir.normalize(),this.rect0=e.rect,this.hfov=parseFloat(e.hfov),this.vfov=parseFloat(e.vfov),this.computeParam(),e.needUpdate&&this.show()}},{key:"getClipRect",value:function(){var e=(new THREE.Matrix4).getInverse(this.PanoMosaicManager.player.model.matrixWorld.clone()),t=this.pano.position.clone().add(this.dir);t.applyMatrix4(e);var n=be.getNormalDir(t,!0,this.pano),o=be.getUVfromDir(n),i=this.hfov/360,r=this.vfov/180,a=function(e){return e-Math.floor(e)},s=this.PanoMosaicManager.player.$app.store.getValue("metadata"),l=8;3!=s.sceneSource&&4!=s.sceneSource||(l=16);var c={x:Math.floor(a(o.x-i/2)*l*1024),y:Math.floor(a(o.y-r/2)*l/2*1024),width:Math.floor(i*l*1024),height:Math.floor(r*l/2*1024)};if(c.x+c.width>=1024*l){var u=1024*l-1-c.x;return[{x:c.x,y:c.y,width:u,height:c.height},{x:0,y:c.y,width:c.width-u,height:c.height}]}return[c]}},{key:"computeParam",value:function(){var e=this.hfov/360,t=this.vfov/180,n=this.getAbsoluteAngleByDir(this.dir),o=be.getUVfromDir(n.dir2),i=function(e){return e-Math.floor(e)};this.rect={leftBottom:new THREE.Vector2(i(o.x-e/2),i(o.y-t/2)),rightTop:new THREE.Vector2(i(o.x+e/2),i(o.y+t/2))},this.lon=n.lon,this.lat=n.lat}},{key:"getAbsoluteAngleByDir",value:function(e){var t=(new THREE.Matrix4).getInverse(this.PanoMosaicManager.player.model.matrixWorld.clone()),n=this.pano.position.clone().add(e);n.applyMatrix4(t);var o=be.getNormalDir(n,!1,this.pano),i={dir2:o},r=o.clone().negate(),a=Math.atan(r.z/r.x);a+=r.x<0?Math.PI:0,a+=r.x>0&&r.z<0?2*Math.PI:0,i.lon=THREE.Math.radToDeg(a)+180;var s=Math.sqrt(r.x*r.x+r.z*r.z),l=Math.atan(r.y/s);return i.lat=-THREE.Math.radToDeg(l),i.lon%=360,i}},{key:"show",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.PanoMosaicManager.showMosaic(this,e)}},{key:"getDirAtAbsoluteAngle",value:function(e,t){var n=be.getDirByLonLat(e,t),o=(new THREE.Matrix4).getInverse(this.pano.skyboxMesh.matrixWorld);return be.crossRight(n,o)}},{key:"getDirAtAngle",value:function(e,t){return this.getDirAtAbsoluteAngle(this.lon+e,this.lat+t)}},{key:"getAngleByDir",value:function(e){var t=this.getAbsoluteAngleByDir(e),n=(t.lon-this.lon)%360;return Math.abs(n)>180&&(n+=n>0?-360:360),{lon:n,lat:t.lat-this.lat}}},{key:"checkIfHover",value:function(){if(!this.PanoMosaicManager.player.flying){var e=Pe.getMouseIntersect(this.PanoMosaicManager.player.camera,[this.PanoMosaicManager.player.model.skybox],this.PanoMosaicManager.player.mouse);if(e){var t=e.point.clone().sub(this.pano.position.clone()),n=this.getAngleByDir(t.clone()),o=n.lon,i=n.lat,r=Math.abs(o);if(r<=this.hfov/2||r>=360-this.hfov/2)if(Math.abs(i)<=this.vfov/2)return e}}}},{key:"getInfo",value:function(){this.info={dir:this.dir,hfov:this.hfov,vfov:this.vfov,pano:this.pano,video:this.video,needUpdate:!0}}}]),e}(),Dl=function(){function e(t){i(this,e),this.editing=!1,this.editVideo=null,this.meshGroup=new THREE.Object3D,this.scaleBtn=null,this.hoveredVideo=!1,this.player=t,this.PanoMosaicManager,this.init()}return u(e,[{key:"checkIfCanInit",value:function(){return this.player.model&&this.player.PanoMosaicManager&&this.player.currentPano&&this.player.model.transformControls}},{key:"waitToInit",value:function(e){var t=this;console.log("waitToInit");var n=setInterval((function(){t.checkIfCanInit()&&(e&&e(),clearInterval(n))}),50)}},{key:"init",value:function(){var e=this;this.checkIfCanInit()?(this.PanoMosaicManager=this.player.PanoMosaicManager,this.meshGroup.name="panoMosaic-group",this.player.model.add(this.meshGroup),this.meshGroup.visible=!1,this.scaleBtn=new THREE.Mesh(new THREE.PlaneBufferGeometry(.05,.05),new THREE.MeshBasicMaterial({map:In.load(In.getImageURL("images/zoom.png")),transparent:!0,opacity:.75,depthTest:!1,depthWrite:!1})),this.scaleBtn.renderOrder=100,this.meshGroup.add(this.scaleBtn),this.scaleBtn.visible=!1,this.player.on(Jo,(function(t,n,o){"panorama"==t&&e.editing&&(e.meshGroup.visible=!1)})),this.player.on("ModeChanged",(function(t,n,o){"panorama"==n&&e.editing&&(e.meshGroup.visible=!0)}))):this.waitToInit((function(){e.init()}))}},{key:"moveScaleBtn",value:function(){var e=1,t=1,n=this.editVideo.getDirAtAngle(this.editVideo.hfov/2+e,this.editVideo.vfov/2+t).normalize();this.scaleBtn.position.copy(this.player.position.clone().add(n)),this.scaleBtn.lookAt(this.player.position)}},{key:"addMosaic",value:function(){if(this.player.flying)this.player.waitFlytoItemFuc=this.addMosaic.bind(this);else{var e=this.player.currentPano,t=this.player.getDirection();this.editVideo=new Al({pano:e,dir:t,hfov:30,vfov:40,isNew:!0},this.PanoMosaicManager),this.editVideo.isNew=!0,this.beginEditVideo()}}},{key:"lookAtMosaic",value:function(e){var t=this.player.model.panos.index[e.panoId];this.player.flying?this.player.waitFlytoItemFuc=function(){}:this.player.currentPano.id==e.panoId&&"panorama"==this.player.mode?this.player.flyToPano({pano:t,lookAtPoint:t.position.clone().add(e.dir)}):this.player.flyToPano({pano:t,lookAtPoint:t.position.clone().add(e.dir)},(function(){}))}},{key:"beginEditVideo",value:function(){this.player.reticule.visible=!1,this.editVideo.show({isEdit:!0}),this.scaleBtn.visible=!0,this.moveScaleBtn()}},{key:"endEditVideo",value:function(e){delete this.PanoMosaicManager.material.defines.isEdit,this.player.PanoMosaicManager.material.needsUpdate=!0,!e&&this.editVideo&&this.editVideo.setFromInfo(this.editVideo.info),this.PanoMosaicManager.hide(),this.dealPointerUp(),this.editVideo=null,this.hoveredVideo=null,this.hoveredScale=!1,document.querySelector(".player").style.cursor="",this.scaleBtn.visible=!1,this.player.reticule.visible=!0,console.log("endEditVideo")}},{key:"confirmVideo",value:function(e){var t=this.editVideo;t.isNew&&this.PanoMosaicManager.addMosaic(this.editVideo),t.isNew=!1,t.getInfo(),this.endEditVideo(!0)}},{key:"deleteVideo",value:function(e){}},{key:"enter",value:function(){this.editing||(this.editing=!0,this.meshGroup.visible="panorama"==this.player.mode)}},{key:"leave",value:function(){this.editing&&(this.editing=!1,this.endEditVideo(),this.meshGroup.visible=!1,this.player.cameraControls.controls.panorama.insideLookLimitDown=null)}},{key:"scaleVideo",value:function(){if(this.scaling){var e=Pe.getMouseIntersect(this.player.camera,[this.player.model.skybox],this.player.mouse).point.clone().sub(this.player.position),t=this.editVideo.getAngleByDir(e);if(this.scaleOffset){var n=t.lon<0?this.editVideo.hfov>90?179:1:t.lon;if(this.editVideo.hfov=THREE.Math.clamp(2*n-this.scaleOffset.lon,1,359),this.editVideo.vfov=Math.min(Math.abs((2*t.lat-this.scaleOffset.lat)%360),179,2*(89+this.editVideo.lat),2*(89-this.editVideo.lat)),this.editVideo.video){var o=this.editVideo.video.videoWidth/this.editVideo.video.videoHeight;this.editVideo.hfov/this.editVideo.vfov>o?this.editVideo.hfov=this.editVideo.vfov*o:this.editVideo.vfov=this.editVideo.hfov/o}this.editVideo.computeParam();var i=this.editVideo.rect;this.PanoMosaicManager.material.uniforms.clipRect.value.set(i.leftBottom.x,i.leftBottom.y,i.rightTop.x,i.rightTop.y),this.moveScaleBtn(),console.log("scaling")}else this.scaleOffset={lon:t.lon-this.editVideo.hfov/2,lat:t.lat-this.editVideo.vfov/2}}}},{key:"dragVideo",value:function(){if(this.reposing){var e=Pe.getMouseIntersect(this.player.camera,[this.player.model.skybox],this.player.mouse).point.clone().sub(this.player.position),t=(new THREE.Matrix4).lookAt(new THREE.Vector3,e,this.player.camera.up);if(this.dragLastDirMat){var n=(new THREE.Matrix4).getInverse(this.dragLastDirMat),o=t.clone().multiply(n),i=this.editVideo.dir.clone().applyMatrix4(o),r=this.editVideo.getAbsoluteAngleByDir(i);r.lat-this.editVideo.vfov/2<-89?i=this.editVideo.getDirAtAbsoluteAngle(r.lon,this.editVideo.vfov/2-89):r.lat+this.editVideo.vfov/2>89&&(i=this.editVideo.getDirAtAbsoluteAngle(r.lon,89-this.editVideo.vfov/2)),this.editVideo.dir=i,this.editVideo.computeParam();var a=this.editVideo.rect;this.PanoMosaicManager.material.uniforms.clipRect.value.set(a.leftBottom.x,a.leftBottom.y,a.rightTop.x,a.rightTop.y),this.moveScaleBtn()}this.dragLastDirMat=t}}},{key:"dealPointerDown",value:function(){this.hoveredVideo?(this.reposing=!0,this.player.cameraControls.activeControl.enabled=!1,this.dragVideo()):this.hoveredScale&&(this.scaling=!0,this.player.cameraControls.activeControl.enabled=!1,this.scaleVideo())}},{key:"dealPointerMove",value:function(){this.editVideo&&(this.dragVideo(),this.scaleVideo())}},{key:"dealPointerUp",value:function(){this.editVideo&&(this.reposing=this.scaling=!1,this.player.cameraControls.activeControl.enabled=!0,this.player.cameraControls.activeControl.pointerDragOn=!1,this.dragLastDirMat=null,this.scaleOffset=null)}},{key:"getSavingInfo",value:function(){var e=this.editVideo;return{data:{dir:e.dir,hfov:e.hfov,vfov:e.vfov,pano:e.pano.id,rect:e.getClipRect()},type:this.editVideo.isNew?1:0,needSaveMedia:!e.info||e.file!=e.info.file,done:function(){e.isNew=!1,e.getInfo()}}}},{key:"setSize",value:function(e,t){}},{key:"checkIfHover",value:function(){if("panorama"==this.player.mode){var e=this.editVideo||this.player.currentPano.panoVideo;if(e){this.hoveredVideo=null;var t=Pe.getMouseIntersect(this.player.camera,[this.scaleBtn],this.player.mouse);return t?(this.hoveredScale=!0,console.log("hover scale"),document.querySelector(".player").style.cursor="move"):(this.hoveredScale=!1,(t=e.checkIfHover())&&this.editVideo&&(this.hoveredVideo=this.editVideo)),this.intersect=t,document.querySelector(".player").style.cursor=t?"move":"",t}}}}]),e}();function Ll(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var zl=new THREE.SphereBufferGeometry(10,30,30),Vl=function(e){f(n,THREE.Mesh);var t=Ll(n);function n(e){var o;i(this,n);var r=new THREE.ShaderMaterial({side:THREE.DoubleSide,depthTest:!1,transparent:!0,defines:{NoVideo:"",PrepareVideo:""},uniforms:{map:{value:null},clipRect:{value:new THREE.Vector4(.1,.4,.2,.7)},panoPosition:{value:new THREE.Vector3(0,0,0)},panoMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                uniform mat4 panoMatrix;\n                //uniform mat4 videoDirMatrix;\n                uniform vec3 panoPosition; \n                varying vec3 vSamplerDirection;\n\n                void main()\n                {\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); \n                    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n \n                    vec3 positionLocalToPanoCenter = worldPosition.xyz - panoPosition;\n                    \n                    vSamplerDirection  =    (vec4(positionLocalToPanoCenter, 1.0) * panoMatrix).xyz;\n                    //vSamplerDirection =    (vec4(positionLocalToPanoCenter, 1.0) * videoDirMatrix).xyz;\n                    \n                    //vSamplerDirection = positionLocalToPanoCenter;\n                    \n\n                    vSamplerDirection.x *= -1.0;\n\n                }\n\n            ",fragmentShader:"\n\n                #define PI 3.141592653\n\n                uniform vec4 clipRect; \n                \n                uniform vec3 panoPosition; \n                uniform sampler2D map;\n\n                varying vec3 vSamplerDirection;\n\n                vec2 getSamplerCoord( vec3 direction ) \n                {\n                    direction = normalize(direction);\n                    float tx=atan(direction.x,direction.z)/(PI*2.0)+0.5;\n                    float ty=acos(direction.y)/PI;\n\n                    return vec2(tx,ty);\n                }\n\n                float linearStep( float start, float end, float value ) {\n                    if(start<=end){\n                        return clamp( (value - start) / (end - start), 0.0, 1.0 );\n                    }else{\n                        float width = 1.0 - (start - end) ;\n                        if(value >= start ){\n                            return clamp( (value - start) / width, 0.0, 1.0 );\n                        }else{\n                            return clamp( (value + 1.0 - start ) / width, 0.0, 1.0 );\n                        }\n                    }\n                }\n\n                void main() \n                {\n\n                    vec2 uv = getSamplerCoord( vSamplerDirection );\n\n                    \n                    vec4 videoColor = vec4(0, 1.0,0.8,0.3);;\n                    #ifdef NoVideo \n                        videoColor = vec4(0, 1.0,0.8,0.3);      //(0, 0.78125,0.68359375,0.4); //greenblue \n                    #elif defined(PrepareVideo)   \n                        videoColor = vec4(1.0, 1.0, 1.0, 0.05); \n                     \n                    #else \n                        vec2 videoUV = vec2( 0.0, 0.0 );         \n                        videoUV.x = linearStep( clipRect.x, clipRect.z, uv.x );\n                        videoUV.y = linearStep( clipRect.y, clipRect.w, uv.y ); \n                        vec4 mapColor = texture2D( map, videoUV );\n                        #ifdef isEdit \n                            videoColor = mix(videoColor, mapColor, mapColor.a );\n                        #else \n                            videoColor = mapColor;\n                        #endif   \n                    #endif\n \n                    /* float rect = (step( clipRect.x, uv.x ) - step( clipRect.z, uv.x )) //x\n                                *(step( clipRect.y, uv.y ) - step( clipRect.w, uv.y )); //y \n                    */             \n                    float rect;\n                    if(clipRect.x <= clipRect.z){//识别是否在区域内\n                        rect = uv.x >= clipRect.x && uv.x <= clipRect.z ? 1.0 : 0.0;\n                    }else{\n                        rect = (uv.x >= clipRect.x || uv.x <= clipRect.z) ? 1.0 : 0.0;\n                    }\n                    if(rect>0.0){\n                        if(clipRect.y <= clipRect.w){\n                            rect = uv.y >= clipRect.y && uv.y <= clipRect.w ? 1.0 : 0.0;\n                        }else{\n                            rect = (uv.y >= clipRect.y || uv.y <= clipRect.w) ? 1.0 : 0.0;\n                        }\n                    } \n\n                    rect *= videoColor.a;\n                    \n                    vec3 color = videoColor.rgb * rect;\n                      \n                    gl_FragColor = vec4( color, rect ); \n                } \n            "});(o=t.call(this,zl,r)).player=e,o.list=[],o.visible=!1;var a=e.$app.store.getValue("metadata");a.mosaics&&JSON.parse(a.mosaics).forEach((function(e){e.dir&&(e.dir=(new THREE.Vector3).copy(e.dir),o.addMosaic(new Al(e,h(o))))})),e.model.add(h(o)),e.on(ni,(function(){o.hide()}));var s=function(){e.currentPano.panoMosaics&&e.currentPano.panoMosaics.length?o.showMosaic(e.currentPano.panoMosaics[0]):e.EditPanoMosaic&&e.EditPanoMosaic.editVideo&&o.showMosaic(e.EditPanoMosaic.editVideo)};return e.on(oi,s),e.on(ri,s),o}return u(n,[{key:"showMosaic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("panorama"==this.player.mode){this.currentpanoMosaic=e,t.isEdit&&(this.material.defines.isEdit="");var n=e.rect;this.material.uniforms.clipRect.value.set(n.leftBottom.x,n.leftBottom.y,n.rightTop.x,n.rightTop.y),this.material.uniforms.panoPosition.value.copy(e.pano.position),this.material.uniforms.panoMatrix.value.copy(e.pano.skyboxMesh.matrixWorld),this.position.copy(e.pano.position),this.visible=!0}}},{key:"hide",value:function(){this.currentPanoVideo&&(this.material.uniforms.map.value&&(this.material.uniforms.map.value.dispose(),this.material.uniforms.map.value=null),this.currentPanoVideo=null,this.material.defines.NoVideo="",this.material.needsUpdate=!0),this.visible=!1}},{key:"addMosaic",value:function(e){this.list.push(e),e.pano.panoMosaics||(e.pano.panoMosaics=[]),e.pano.panoMosaics.push(e),e.pano.updateMakerStyle()}}]),n}();function Hl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Ol,Fl=function(e){f(n,e);var t=Hl(n);function n(e){var o,r;i(this,n),(o=t.call(this)).app=e,o.edit={};var a=_e();return o.app.Scene.on("loaded",(function(){(r=o.app.core.get("Player")).PanoMosaicManager=new Vl(r),r.EditPanoMosaic=new Dl(r),a.resolve()})),o.edit.focusVideo=function(e){var t=r.model.panos.index[e];r.flying?r.once("flying.ended",(function(){o.edit.focusVideo(e)})):r.flyToPano({pano:t},(function(){}))},o.edit.mosicEnter=function(){r&&r.EditPanoMosaic?r.EditPanoMosaic.enter():a.then((function(){return r.EditPanoMosaic.enter()}))},o.edit.mosicLeave=function(){r.EditPanoMosaic.leave()},o.edit.addMosaic=function(){r.EditPanoMosaic.addMosaic()},o.edit.findMosic=function(e){r.EditPanoMosaic.lookAtMosaic(e)},o.edit.exitMosicEditing=function(){r.EditPanoMosaic.endEditVideo()},o.edit.getMosaicSavingInfo=function(){return r.EditPanoMosaic.getSavingInfo().data},o}return n}(ml),Nl=function(){function e(t){i(this,e),this.app=t}return u(e,[{key:"add",value:function(e){e.audio&&this.remove(e),e.music&&(e.audio=new Howl({preload:!0,src:[this.app.resource.getUserResourceURL(e.music,!0)],loop:!1,html5:!0,onloaderror(e,t){console.log(e,t)},onplayerror:function(e){console.log(e)},onload(){}}))}},{key:"remove",value:function(e){e.audio&&(e.audio.unload(),e.audio=null,delete e.audio)}},{key:"play",value:function(){}}]),e}(),Bl=function(){function e(t){i(this,e),this.tours=[],this.player=_e(),this.recorder=_e(),this.audioPlayer=new Nl(t)}return u(e,[{key:"uuid",value:function(){return se.getRandomSid()}},{key:"load",value:function(e){var t=this,n=null;this.tours=e||[],this.tours.forEach((function(e){t.audioPlayer.add(e),e.list.forEach((function(e){delete e._trans,null==n||"panorama"==n.enter.mode&&"panorama"==e.enter.mode&&n.enter.panoId!=e.enter.panoId||(n._notrans=!0),n=e}))})),this.player.then((function(e){e.tours=t.tours})),this.recorder.then((function(e){e.tours=t.tours}))}},{key:"install",value:function(e,t){this[e]&&this[e].resolve(t)}}]),e}();function jl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var Ul=.7,_l=3,Wl=function(e){f(n,e);var t=jl(n);function n(e){var o;return i(this,n),(o=t.call(this)).app=e,o.editing=!1,o.temp={onRangeChange:0},o}return u(n,[{key:"enter",value:function(e){var t=this;if(this.editing=!0,Ol=this.app.core.get("Player"),window.player=Ol,!Ol)return this.app.Scene.on("loaded",(function(){t.editing&&t.enter(e)}));this.oldStates={zoomMax:He.zoom.max,zoomMin:He.zoom.min,zoomEnabled:He.zoom.enabled,zoomToDefaultWhenToPano:He.zoom.zoomToDefaultWhenToPano},He.zoom.max=3,He.zoom.min=.7,He.zoom.enabled=!0,He.zoom.zoomToDefaultWhenToPano=!1,this.eventList={zoomTo:e.bind(this)},Ol.on("zoomTo",this.eventList.zoomTo),this.eventList.zoomTo(Ol.zoomLevel),He.highestQualityTile=!0}},{key:"leave",value:function(){this.editing=!1,console.log("退出，恢复"),Ol&&(Ol.zoomTo(1),He.zoom.enabled=this.oldStates.zoomEnabled,He.zoom.max=this.oldStates.zoomMax,He.zoom.min=this.oldStates.zoomMin,He.zoom.zoomToDefaultWhenToPano=this.oldStates.zoomToDefaultWhenToPano,Ol.off("zoomTo",this.eventList.zoomTo),He.highestQualityTile=!1)}},{key:"waitTexLoaded",value:function(e){var t=this;if("panorama"==Ol.mode){if(!Ol.currentPano||Ol.flying)return console.log("延迟"),e||(e=_e()),setTimeout((function(){t.waitTexLoaded(e)}),100),e.promise();var n=this.getTileSize(),o=new THREE.Vector3(0,0,-1).applyQuaternion(Ol.quaternion),i=Ol.cameraControls.activeControl.camera,r=i.fov,a=zi.getHFOVForCamera(i,i.aspect,1),s=Ol.currentPano.loadTiledPano(n,o,{hFov:a,vFov:r},!1,!1,!0);return s.done((function(){console.log("加载完成"),e&&e.resolve()})),s}return _e().resolve().promise()}},{key:"getMaxHeight",value:function(){return"2k"==this.app.core.get("QualityManager").tileClass?4096:"4k"==this.app.core.get("QualityManager").tileClass?8192:1024}},{key:"getTileSize",value:function(){return"2k"==this.app.core.get("QualityManager").tileClass?2048:"4k"==this.app.core.get("QualityManager").tileClass?4096:512}},{key:"getPicSize",value:function(){if("panorama"!=Ol.mode)return{width:1780,height:1e3};var e=this.getMaxHeight(),t=Ol.cameraControls.activeControl.camera.fov/180*e,n=1.78*t;return{width:Math.round(n),height:Math.round(t)}}},{key:"listenZoomLevel",value:function(e){}},{key:"onResetCamera",value:function(){"panorama"==Ol.mode&&(Ol.cameraControls.activeControl.lat=0)}},{key:"onResumeSize",value:function(){var e=this;if(Ol){var t=Ol.cameraControls.activeControl;if("transitioning"==Ol.mode)return Ol.once("mode.changed",(function(t,n){e.editing&&e.onResumeSize()}));"panorama"==Ol.mode?Ol.zoomTo(1):"dollhouse"==Ol.mode?(t.target.copy(Ol.model.center),this.onRangeChange({value:100})):"floorplan"==Ol.mode&&(t.target.setX(Ol.model.center.x),t.target.setZ(Ol.model.center.z),t.camera.position.setX(Ol.model.center.x),t.camera.position.setZ(Ol.model.center.z),t.rotateToView(Ol.model.size,Ol.getDirection()),t.zoomToContain(Ol.model.size))}}},{key:"onRangeChange",value:function(e){var t=this;this.temp.onRangeChange=e;var n=Ol.cameraControls.activeControl,o=parseInt(e.value)/100;if("transitioning"==Ol.mode)return Ol.once("mode.changed",(function(e,n){t.editing&&t.onRangeChange(t.temp.onRangeChange)}));if("panorama"==Ol.mode)He.zoom.enabled=!0,Ol.zoomTo(o);else if("dollhouse"==Ol.mode){var i=(o-Ul)/(_l-Ul),r=n.minDistance+(n.maxDistance-n.minDistance)*i;n.camera.position.copy(n.target).add(Ol.getDirection().multiplyScalar(-r))}else if("floorplan"==Ol.mode){var a=n.getDefaultAbsoluteScale(Ol.model.size);n.absoluteScale=a*o}}}]),n}(ml);function Zl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ql(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function Gl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var ql="rotate",Yl="zoom",$l="endRotation",Xl="moveModel",Jl="flying.started",Kl=function(e){f(n,e);var t=Gl(n);function n(e){var o;return i(this,n),(o=t.call(this)).app=e,o.inited=!1,o.started=!1,o}return u(n,[{key:"init",value:function(){var e=this;this.app.Camera.on(Jl,(function(t){return e.emitData(t)})),this.app.Camera.on(ql,(function(t){return e.emitData(t)})),this.app.Camera.on($l,(function(t){return e.emitData(t)})),this.app.Camera.on(Yl,(function(t){return e.emitData(t)})),this.app.Camera.on(Xl,(function(t){return e.emitData(t)}))}},{key:"start",value:function(){this.started=!0,this.inited||(this.init(),this.app.core.get("Model").supportsTiles=!1)}},{key:"exit",value:function(){this.started=!1,this.app.core.get("Model").supportsTiles=!0}},{key:"emitData",value:function(e){if(this.started&&"follow"!=this.role){if(e)for(var t in e){var n=e[t];n instanceof THREE.Vector2?e[t]=new THREE.Vector2(n.x,n.y):n instanceof THREE.Vector3&&(e[t]=new THREE.Vector3(n.x,n.y,n.z))}this.emit("data",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ql(Object(n),!0).forEach((function(t){Zl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ql(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e))}}},{key:"transform",value:function(e){e.target&&e.target instanceof THREE.Vector3==!1&&(e.target=new THREE.Vector3(e.target.x,e.target.y,e.target.z)),e.position&&e.position instanceof THREE.Vector3==!1&&(e.target=new THREE.Vector3(e.position.x,e.position.y,e.position.z)),e.quaternion&&e.quaternion instanceof THREE.Quaternion==!1&&(e.quaternion.hasOwnProperty("_x")?e.quaternion=new THREE.Quaternion(e.quaternion._x,e.quaternion._y,e.quaternion._z,e.quaternion._w):e.quaternion=new THREE.Quaternion(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w)),e.rotationSpeed&&e.rotationSpeed instanceof THREE.Vector2==!1&&(e.rotationSpeed=new THREE.Vector2(e.rotationSpeed.x,e.rotationSpeed.y)),e.info&&this.transform(e.info),e.modelInfo&&this.transform(e.modelInfo)}}]),n}(vo);function ec(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var tc=function(e){f(n,e);var t=ec(n);function n(e){var o;return i(this,n),(o=t.call(this,e)).toSame=function(e,t,n){if(e.mode==t.mode){if(e.mode==Oe.PANORAMA){if(e.currentPanoId==t.currentPano.id)return!0;var o=t.model.panos.index[parseInt(e.currentPanoId)];return t.flyToPano({pano:o},n),!1}return!0}return console.log("mode:"+t.mode),t.mode==Oe.TRANSITIONING?null:e.mode==Oe.FLOORPLAN?(t.flyToNewMode({mode:Oe.FLOORPLAN,callback:n}),!1):e.mode!=Oe.DOLLHOUSE||(t.flyToNewMode({mode:Oe.DOLLHOUSE,target:e.info.target,position:e.info.position,quaternion:e.info.quaternion?(new THREE.Quaternion).set(e.info.quaternion._x,e.info.quaternion._y,e.info.quaternion._z,e.info.quaternion._w):null,panoId:null,callback:n}),!1)},o.syncRotate=function(e,t){t.cameraControls.activeControl.locked=!0,t.cameraControls.activeControl.camera.quaternion.set(e.quaternion._x,e.quaternion._y,e.quaternion._z,e.quaternion._w);var n=new THREE.Vector3(0,0,-1).applyQuaternion(t.cameraControls.activeControl.camera.quaternion).add(t.cameraControls.activeControl.camera.position);t.cameraControls.activeControl.lookAt(n)},o.copyCameraProp=function(e,t){var n=e.cameraControls.activeControl,o=n.camera;t.position&&o.position.copy(t.position),t.quaternion&&o.quaternion.set(t.quaternion._x,t.quaternion._y,t.quaternion._z,t.quaternion._w),t.target&&n.target.copy(t.target),t.scale&&(n.absoluteScale=t.scale,n.updateZoom())},o}return u(n,[{key:"receive",value:function(e){console.log("接受");var t=this.app.core.get("Player"),n=!0;switch(this.transform(e),e.type){case"flyToPano":console.log("漫游");var o=t.model.panos.index[parseInt(e.panoId)];t.flyToPano({pano:o});break;case"flyToNewMode":console.log("飞入飞出"),e.modelInfo&&e.modelInfo.panoId&&(e.modelInfo.pano=t.model.panos.index[parseInt(e.modelInfo.panoId)]),t.flyToNewMode(e.modelInfo);break;case"rotate":console.log("旋转"),t.model.mode==Oe.PANORAMA&&(n=this.toSame(e,t,function(){this.syncRotate(e,t)}.bind(this)))&&this.syncRotate(e,t);break;case"endRotation":console.log("停止旋转"),t.cameraControls.activeControl.locked=!1,t.cameraControls.activeControl.rotationSpeed=e.rotationSpeed;break;case"zoom":console.log("缩放"),null==(n=this.toSame(e,t,function(){t.handleControlScroll(e.zoom)}.bind(this)))||n&&t.handleControlScroll(e.zoom);break;case"moveModel":console.log("移动模型"),null==(n=this.toSame(e,t,function(){this.copyCameraProp(t,e.info)}.bind(this)))||n&&this.copyCameraProp(t,e.info)}}}]),n}(Kl);function nc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var oc=function(e){f(n,e);var t=nc(n);function n(e){var o;return i(this,n),(o=t.call(this,e)).toSame=function(e,t,n){if(e.mode==t.mode){if(e.mode==Oe.PANORAMA){if(e.currentPanoId==t.currentPano.id)return!0;var o=t.model.panos.index[parseInt(e.currentPanoId)];return t.flyToPano({pano:o},n),!1}return!0}return console.log("mode:"+t.mode),t.mode==Oe.TRANSITIONING?null:e.mode==Oe.FLOORPLAN?(t.flyToNewMode({mode:Oe.FLOORPLAN,callback:n}),!1):e.mode!=Oe.DOLLHOUSE||(t.flyToNewMode({mode:Oe.DOLLHOUSE,target:e.info.target,position:e.info.position,quaternion:e.info.quaternion?(new THREE.Quaternion).set(e.info.quaternion._x,e.info.quaternion._y,e.info.quaternion._z,e.info.quaternion._w):null,panoId:null,callback:n}),!1)},o.syncRotate=function(e,t){t.cameraControls.activeControl.locked=!0,t.cameraControls.activeControl.camera.quaternion.set(e.quaternion._x,e.quaternion._y,e.quaternion._z,e.quaternion._w);var n=new THREE.Vector3(0,0,-1).applyQuaternion(t.cameraControls.activeControl.camera.quaternion).add(t.cameraControls.activeControl.camera.position);t.cameraControls.activeControl.lookAt(n)},o.copyCameraProp=function(e,t){var n=e.cameraControls.activeControl,o=n.camera;t.position&&o.position.copy(t.position),t.quaternion&&o.quaternion.set(t.quaternion._x,t.quaternion._y,t.quaternion._z,t.quaternion._w),t.target&&n.target.copy(t.target),t.scale&&(n.absoluteScale=t.scale,n.updateZoom())},o.role="leader",o}return u(n,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(Ze(w(n.prototype),"start",this).call(this),e.follow){this.role="follow";var t=this.app.core.get("Player");t.locked=!0}}},{key:"receive",value:function(e){console.log("接受");var t=this.app.core.get("Player"),n=!0;switch(this.transform(e),e.type){case"flyToPano":console.log("漫游");var o=t.model.panos.index[parseInt(e.panoId)];t.locked=!1,t.flyToPano({pano:o},(function(){t.locked=!0}));break;case"flyToNewMode":console.log("飞入飞出"),e.modelInfo.panoId&&(e.modelInfo.pano=t.model.panos.index[parseInt(e.modelInfo.panoId)]),t.locked=!1,e.modelInfo.callback=function(){t.locked=!0},t.flyToNewMode(e.modelInfo);break;case"rotate":console.log("旋转"),t.model.mode==Oe.PANORAMA&&(n=this.toSame(e,t,function(){this.syncRotate(e,t)}.bind(this)))&&this.syncRotate(e,t);break;case"endRotation":console.log("停止旋转"),t.cameraControls.activeControl.locked=!1,t.cameraControls.activeControl.rotationSpeed=e.rotationSpeed;break;case"zoom":console.log("缩放"),null==(n=this.toSame(e,t,function(){t.handleControlScroll(e.zoom)}.bind(this)))||n&&t.handleControlScroll(e.zoom);break;case"moveModel":console.log("移动模型"),null==(n=this.toSame(e,t,function(){this.copyCameraProp(t,e.info)}.bind(this)))||n&&this.copyCameraProp(t,e.info)}}}]),n}(Kl),ic=function e(t){i(this,e),this.sync=new tc(t),this.follow=new oc(t)};var rc=Object.freeze({__proto__:null,downLoadZSData:function(e){return Mn.postFile("/service/scene/downLoadZSData",e)},check_key:function(e){return Mn.post("/service/scene/check/key",e)},getInfo:function(e){return Mn.get("/service/scene/getInfo",e)}});function ac(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,o=w(e);if(t){var i=w(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return y(this,n)}}var sc=function(e){f(n,e);var t=ac(n);function n(e){var o;return i(this,n),(o=t.call(this,e)).withComponent("store"),o.withComponent("resource"),o.withComponent("Scene"),o.withDom(),o.remote_editor=xl,o.remote_viewer=rc,function(e){e.Scene=new ml(e),e.Camera=new pl(e),e.MinMap=new vl(e),e.DataSYNC=new gl(e),e.TagManager=new Pl(e),e.CadManager=new kl(e),e.VideoManager=new Il(e),e.WalkManager=new Cl(e),e.RepairManager=new Fl(e),e.TourManager=new Bl(e),e.Connect=new ic(e),e.Screenshot=new Wl(e)}(h(o)),function(e){null===Pn&&(Pn=e)}(h(o)),o}return u(n,[{key:"use",value:function(e,t){var n,o,i=this;if("string"==typeof e)return(n=e,o=this.config.version+"-"+Date.now(),ie(oe()+"plugins/"+n+".js",n,o)).then((function(e){return i.Plugins.add(window[e],t)}))}},{key:"render",value:function(){this.core.get("Scene").start()}},{key:"metadata",value:function(e){return void 0===e?(this.store.set("metadata"),this):this.store.get("metadata")}}]),n}(we);return sc.MITT={Emiter:vo},sc.Utils={MathLight:xe},sc.Animate={transitions:Se,easing:Ie,lerp:nt},sc.Viewmode=Oe,sc.Deferred=_e,sc}));
