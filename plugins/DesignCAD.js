var DesignCAD=function(){"use strict";var t=KanKan.config(),o={zh:{cad:{floor:"楼层",remove:"删除部件",attribute:"属性",split:"拆分",toolbar:{recall:"撤销",recover:"恢复",clear:"清空",default:"恢复默认",rotate:"旋转",download:"下载",flex:"适应视图",panos:"漫游点",texture:"底图",unit:"测量单位"},classify:{wall:"墙类",door:"门",window:"窗",structure:"构建",tag:"标注"},items:{Wall:"内墙",OutWall:"外墙",SingleDoor:"门",DoubleDoor:"双开门",SlideDoor:"移门",Pass:"垭口",SingleWindow:"窗",BayWindow:"飘窗",FrenchWindow:"落地窗",Beam:"柱子",Flue:"烟道",Corridor:"楼道",Tag:"标注",WallCorner:"点",compass:"指南针"}}}},i=t.lang||"zh";"zh"!=i&&"object"!=typeof t[o]&&(o[i]=t[i]);var s=function(t){if(!t||!o[i])return t;if(-1===t.indexOf("."))return o[i]||t;for(var e=t.split("."),n=null,s=0;s<e.length;s++)if("object"!=typeof(n=null===n?o[i][e[s]]:n[e[s]])&&s===e.length-1)return void 0===n?t:n;return void 0===n?t:n},r=function(){this.version="v4.0",this.floors=[]};r.prototype.initFloor=function(t){this.floors[t]={},this.floors[t].points={},this.floors[t].walls={},this.floors[t].symbols={},this.floors[t].components={},this.floors[t].tags={},this.floors[t].boundingBox={},this.floors[t].rooms=[]};var l=new r;window.floorplanData=l;var a=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.rotate=0,this.initRes=null,this.initWidth=null,this.initHeight=null};a.prototype.init=function(t){var e=b.getBoundingBox();this.setCenter(e),this.updateForCanvas(t)},a.prototype.setInitInfo=function(t,e,o){null==this.initRes&&(this.initRes=t),null==this.initWidth&&(this.initWidth=e),null==this.initHeight&&(this.initHeight=o)},a.prototype.updateResForReSize=function(t,e,o){Math.abs(o)<.01||Math.abs(o-2*Math.PI)<.01?this.res=this.initRes*t/this.initWidth:this.res=this.initRes*e/this.initHeight},a.prototype.setCenter=function(t){this.cadBoundingbox=JSON.parse(JSON.stringify(t)),null!=this.cadBoundingbox&&(this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2},this.defaultCenter={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2})},a.prototype._setRes=function(t){this.res=t},a.prototype.setRes=function(t,e){this.res=this.width/Math.abs(e-t)},a.prototype.getScreenXY=function(t){if(null==this.width||null==this.height)return null;var e=t.x,o=t.y,n=this.width/2+(e-this.center.x)*this.res*this.zoom/100,i=this.height/2-(o-this.center.y)*this.res*this.zoom/100;return n=.5+n<<0,i=.5+i<<0,{x:Math.floor(n)*this.ratio,y:Math.floor(i)*this.ratio}},a.prototype.getXYFromScreen=function(t){var e={};return e.x=(t.x-this.width/2)/this.res*100/this.zoom+this.center.x,e.y=(this.height/2-t.y)/this.res*100/this.zoom+this.center.y,e},a.prototype.getPointForRotate=function(t){return 0==this.rotate||360==this.rotate?t:{x:(t.x-this.center.x)*Math.cos(this.rotate/180*Math.PI)-(t.y-this.center.y)*Math.sin(this.rotate/180*Math.PI)+this.center.x,y:(t.y-this.center.y)*Math.cos(this.rotate/180*Math.PI)+(t.x-this.center.x)*Math.sin(this.rotate/180*Math.PI)+this.center.y}},a.prototype.getPointForRevRotate=function(t,e){if(Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.defaultCenter.x)*Math.cos(e)-(t.y-this.defaultCenter.y)*Math.sin(e)+this.defaultCenter.x,n=(t.y-this.defaultCenter.y)*Math.cos(e)+(t.x-this.defaultCenter.x)*Math.sin(e)+this.defaultCenter.y;return t.x=o,t.y=n,t},a.prototype.getVectorForRotate=function(t,e){if(e=-e,Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.defaultCenter.x)*Math.cos(e)-(t.y-this.defaultCenter.y)*Math.sin(e)+this.defaultCenter.x,n=(t.y-this.defaultCenter.y)*Math.cos(e)+(t.x-this.defaultCenter.x)*Math.sin(e)+this.defaultCenter.y;return t.x=o,t.y=n,t},a.prototype.updateCenterForRotate=function(t){if(!(Math.abs(t)<.01||Math.abs(t-2*Math.PI)<.01)){var e=this.center.x*Math.cos(t)-this.center.y*Math.sin(t),o=this.center.y*Math.cos(t)+this.center.x*Math.sin(t);return this.center.x=e,this.center.y=o,this.center}},a.prototype.updateForCanvas=function(t){t&&(this.width=t.clientWidth,this.height=t.clientHeight,t.width=t.clientWidth,t.height=t.clientHeight)},a.prototype.updateZoom=function(t){this.zoom=t},a.prototype.moveTo=function(t,e){var o=this.getXYFromScreen(e);this.zoom=t;var n=(100*e.x/this.zoom-this.width/2)/this.res,i=(this.height/2-100*e.y/this.zoom)/this.res;this.center.x=o.x-n,this.center.y=o.y-i},a.prototype.getXYFromScreenForDefaultZoom=function(t){var e={};return e.x=(t.x-this.width/2)/this.res+this.center.x,e.y=(this.height/2-t.y)/this.res+this.center.y,e},a.prototype.getScreenInfoForCAD=function(){var t=this.getXYFromScreen({x:this.width,y:this.height}),e=this.getXYFromScreen({x:0,y:0}),o={x:this.center.x,y:this.center.y};return{width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y),center:{x:o.x,y:-1*o.y},defaultCenter:this.defaultCenter}},a.prototype.getPixelRatio=function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},a.prototype.reSet=function(){this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2},this.zoom=100},a.prototype.updateForRotate=function(t){void 0===t&&(t=Math.PI/2);for(var e=0;e<l.floors.length;++e){var o=l.floors[e].points;for(var n in o)o[n]=this.getVectorForRotate(o[n],t);var i=l.floors[e].symbols;for(var s in i)i[s].startPoint=this.getVectorForRotate(i[s].startPoint,t),i[s].endPoint=this.getVectorForRotate(i[s].endPoint,t),i[s].setPoints2d();var r=l.floors[e].components;for(var a in r){var h=r[a];h.center=this.getVectorForRotate(h.center,t),h.angle=h.angle+t/Math.PI*180,h.setPoints2d()}var c=l.floors[e].tags;for(var d in c)c[d].center=this.getVectorForRotate(c[d].center,t),c[d].setPoints2d()}},a.prototype.clear=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.rotate=0};var h=new a,c=2,d=.1,p=.1,y=10,u=170,g=100,x=.2,f=3,m=5760,v=3240,P=1200,I=1200,S=function(){this.currentId=0,this.currentFloor=0,this.angle=0};S.prototype.setCurrentId=function(t){this.currentId=t},S.prototype.getCurrentId=function(){return this.currentId},S.prototype.updateCurrentId=function(){++this.currentId},S.prototype.setCurrentFloor=function(t){this.currentFloor=t},S.prototype.getCurrentFloor=function(){return this.currentFloor},S.prototype.getCompass=function(){return l.compass},S.prototype.setCompass=function(t){l.compass=t},S.prototype.getFloorNum=function(){return l.floors.length},S.prototype.initFloor=function(t){l.initFloor(t)},S.prototype.getFloors=function(){return l.floors},S.prototype.getPoint=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].points[t]},S.prototype.deletePoint=function(t,e,o){null!=o&&void 0!==o||(o=this.currentFloor);var n=this.getPoint(t);if(n)if(0==Object.keys(n.parent).length)n=null,delete l.floors[o].points[t];else if(1!=Object.keys(n.parent).length||e)if(1==Object.keys(n.parent).length&&n.parent[e])delete l.floors[o].points[t];else{if(1==Object.keys(n.parent).length&&!n.parent[e])return;delete n.parent[e]}else delete l.floors[o].points[t]},S.prototype.getWall=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].walls[t]},S.prototype.deleteWall=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor);for(var o=this.getWall(t,e),n=0;n<o.children.length;++n)this.deleteSymbol(o.children[n],e);this.deletePoint(o.start,t,e),this.deletePoint(o.end,t,e),delete l.floors[e].walls[t]},S.prototype.deleteWallNoSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor);var o=this.getWall(t,e);this.deletePoint(o.start,t,e),this.deletePoint(o.end,t,e),delete l.floors[e].walls[t]},S.prototype.getAngle=function(){return this.angle},S.prototype.setAngle=function(t){this.angle=t},S.prototype.setBoundingBox=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].boundingBox=JSON.parse(JSON.stringify(t))},S.prototype.getBoundingBox=function(t){if(null==t||void 0===t){for(var e=null,o=null,n=null,i=null,s=0;s<l.floors.length;++s)l.floors[s].boundingBox.hasOwnProperty("maxX")&&l.floors[s].boundingBox.hasOwnProperty("minX")&&l.floors[s].boundingBox.hasOwnProperty("maxY")&&l.floors[s].boundingBox.hasOwnProperty("minY")||this.updateBoundingBox(s),(null==e||e>l.floors[s].boundingBox.minX)&&(e=l.floors[s].boundingBox.minX),(null==o||o<l.floors[s].boundingBox.maxX)&&(o=l.floors[s].boundingBox.maxX),(null==n||n>l.floors[s].boundingBox.minY)&&(n=l.floors[s].boundingBox.minY),(null==i||i<l.floors[s].boundingBox.maxY)&&(i=l.floors[s].boundingBox.maxY);return{minX:e,maxX:o,minY:n,maxY:i}}return l.floors[t].boundingBox},S.prototype.updateBoundingBox=function(t){var e=this.getPoints(t),o=null,n=null,i=null,s=null;for(var r in e){var l=e[r];(null==o||o>l.x)&&(o=l.x),(null==n||n<l.x)&&(n=l.x),(null==i||i>l.y)&&(i=l.y),(null==s||s<l.y)&&(s=l.y)}this.setBoundingBox({minX:o,maxX:n,minY:i,maxY:s},t)},S.prototype.getFloorData=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t]},S.prototype.getWalls=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t].walls},S.prototype.getPoints=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t].points},S.prototype.getSymbol=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].symbols[t]},S.prototype.addWall=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].walls[t.vectorId]=t},S.prototype.addPoint=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].points[t.vectorId]=t},S.prototype.addSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].symbols[t.vectorId]=t},S.prototype.addComponent=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].components[t.vectorId]=t},S.prototype.deleteSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getSymbol(t,e),delete l.floors[e].symbols[t]},S.prototype.getComponent=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].components[t]},S.prototype.deleteComponent=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getComponent(t,e),delete l.floors[e].components[t]},S.prototype.addTag=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].tags[t.vectorId]=t},S.prototype.getTag=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),l.floors[e].tags[t]},S.prototype.deleteTag=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getTag(t,e),delete l.floors[e].tags[t]},S.prototype.getSymbols=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t].symbols},S.prototype.getComponents=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t].components},S.prototype.getTags=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t].tags},S.prototype.getAllBoundingBox=function(){for(var t=[],e=0;e<l.floors.length;++e){var o=void 0,n=void 0,i=void 0,s=void 0,r={};for(var a in l.floors[e].points){var h=l.floors[e].points[a].x,c=l.floors[e].points[a].y;(void 0===o||o>h)&&(o=h),(void 0===i||i<h)&&(i=h),(void 0===n||n>c)&&(n=c),(void 0===s||s<c)&&(s=c)}r.left=o,r.top=s,r.right=i,r.bottom=n,t.push(r)}return t},S.prototype.getCadInfo=function(t){for(var e=[],o=this.getAllBoundingBox(),n=0;n<o.length;++n){var i={},s=h.getScreenXY({x:o[n].left,y:o[n].top}),r=h.getScreenXY({x:o[n].right,y:o[n].bottom}),l=s.x,a=s.y,c=t.width-r.x,d=t.height-r.y;i.left=l,i.top=a,i.right=c,i.bottom=d,i.bound=o[n],i.bound.top=-1*i.bound.top,i.bound.bottom=-1*i.bound.bottom,e.push(i)}return e},S.prototype.getRooms=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),l.floors[t].rooms},S.prototype.clear=function(){l.floors[this.currentFloor].points={},l.floors[this.currentFloor].walls={},l.floors[this.currentFloor].symbols={},l.floors[this.currentFloor].components={},l.floors[this.currentFloor].tags={},l.floors[this.currentFloor].boundingBox={},l.floors[this.currentFloor].rooms=[]};var b=new S,k="Point",w="WallCorner",W="Wall",F="SingleDoor",C="DoubleDoor",T="SlideDoor",D="SingleWindow",M="BayWindow",L="FrenchWindow",O="Pass",A="Beam",R="Flue",E="Corridor",_="Line",N="Tag",B=function(){};B.prototype.getFixed=function(t,e){return e||(e=5),parseFloat(t.toFixed(e))},B.prototype.getDistance=function(t,e){var o=t.x,n=t.y,i=e.x,s=e.y,r=Math.sqrt(Math.pow(o-i,2)+Math.pow(n-s,2));return this.getFixed(r)},B.prototype.createLine1=function(t,e){if(t.x==e.x&&t.y==e.y)return null;if(0==this.getFixed(Math.abs(t.x-e.x)))return{x:t.x};if(0==this.getFixed(Math.abs(t.y-e.y)))return{y:t.y};var o=(t.y-e.y)/(t.x-e.x),n=(t.x*e.y-e.x*t.y)/(t.x-e.x);return 0==this.getFixed(o)?{y:this.getFixed(n)}:{a:this.getFixed(o),b:this.getFixed(n)}},B.prototype.createLine2=function(t,e){if(e==Math.PI/2||e==1.5*Math.PI)return{x:t.x};var o=Math.tan(e),n=t.y-o*t.x;return 0!=o?{a:o,b:n}:{y:t.y}},B.prototype.createLine3=function(t,e){var o={};return void 0===t.a?void 0!==t.x?o.x=e.x:void 0!==t.y&&(o.y=e.y):(o.a=t.a,o.b=e.y-e.x*t.a),o},B.prototype.create2AngleLine=function(t,e,o){return{line1:this.createLine2(t,e-o/2),line2:this.createLine2(t,e+o/2)}},B.prototype.distanceForPoints=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},B.prototype.getParallelLineForDistance=function(t,e){var o={};o.a=t.a,o.b=t.b;var n={};if(n.a=t.a,n.b=t.b,void 0===t.a){if(t.hasOwnProperty("x")){var i=t.x;o.x=i+e,n.x=i-e}else if(t.hasOwnProperty("y")){var s=t.y;o.y=s+e,n.y=s-e}}else{var r=Math.atan(t.a),l=Math.abs(e/Math.cos(r)),a=t.b;o.b=a+l,n.b=a-l}return{line1:o,line2:n}},B.prototype.getEndpoint=function(t,e,o){var n=this.create2AngleLine(t,e,o),i=this.createLine2(t,e);i=this.getLineForPoint(i,t);var s=this.getParallelLineForDistance(i,15),r=this.getIntersectionPoint(n.line1,s.line1),l=this.getIntersectionPoint(n.line1,s.line2),a=this.getIntersectionPoint(n.line2,s.line1),h=this.getIntersectionPoint(n.line2,s.line2),c=this.Angle(t,r,{x:t.x+1,y:t.y}),d=this.Angle(t,l,{x:t.x+1,y:t.y}),p=this.Angle(t,a,{x:t.x+1,y:t.y}),y=this.Angle(t,h,{x:t.x+1,y:t.y});return e>Math.PI&&(e=2*Math.PI-e),Math.abs((c+p)/2-e)<Math.abs((d+y)/2-e)?{p1:r,p2:a}:{p1:l,p2:h}},B.prototype.isClockwise=function(t){for(var e=0,o=0;o<t.length;o++){var n=(o+1)%t.length;e+=t[o].x*t[n].y,e-=t[n].x*t[o].y}return e/2>0},B.prototype.reverse=function(t){for(var e=[],o=t.length-1;o>-1;--o)e.push(t[o]);return e},B.prototype.getIntersectionPoint=function(t,e){if(this.isParallel(t,e))return null;if(void 0===t.a&&void 0!==e.a){if(t.x)return{x:t.x,y:e.a*t.x+e.b};if(t.y)return{x:(t.y-e.b)/e.a,y:t.y}}else if(void 0===e.a&&void 0!==t.a){if(e.x)return{x:e.x,y:t.a*e.x+t.b};if(e.y)return{x:(e.y-t.b)/t.a,y:e.y}}else if(void 0===e.a&&void 0===t.a)return t.hasOwnProperty("x")&&e.hasOwnProperty("y")?{x:t.x,y:e.y}:t.hasOwnProperty("y")&&e.hasOwnProperty("x")?{x:e.x,y:t.y}:null;return t.a==e.a?null:{x:(e.b-t.b)/(t.a-e.a),y:(t.a*e.b-e.a*t.b)/(t.a-e.a)}},B.prototype.getIntersectionPoint2=function(t,e,o,n){var i=(e.y-t.y)*(n.x-o.x)-(t.x-e.x)*(o.y-n.y);return 0==i?null:{x:((e.x-t.x)*(n.x-o.x)*(o.y-t.y)+(e.y-t.y)*(n.x-o.x)*t.x-(n.y-o.y)*(e.x-t.x)*o.x)/i,y:-((e.y-t.y)*(n.y-o.y)*(o.x-t.x)+(e.x-t.x)*(n.y-o.y)*t.y-(n.x-o.x)*(e.y-t.y)*o.y)/i}},B.prototype.getIntersectionPoint3=function(t,e,o,n){var i=this.getIntersectionPoint2(t,e,o,n);if(i){var s=i.x,r=i.y;return(s-t.x)*(s-e.x)<=.001&&(r-t.y)*(r-e.y)<=.001&&(s-o.x)*(s-n.x)<=.001&&(r-o.y)*(r-n.y)<=.001?{x:s,y:r}:null}return null},B.prototype.getIntersectionPoint4=function(t,e,o){var n=this.createLine1(t,e),i=this.getIntersectionPoint(n,o);return null==i?null:this.PointInSegment(i,t,e)?i:null},B.prototype.isParallel=function(t,e){return void 0===t.a&&void 0===e.a?!(!t.hasOwnProperty("x")||!e.hasOwnProperty("x"))||!(!t.hasOwnProperty("y")||!e.hasOwnProperty("y")):void 0!==t.a&&void 0!==e.a&&this.getFixed(t.a)==this.getFixed(e.a)},B.prototype.Angle=function(t,e,o){var n,i,s=0,r=e.x-t.x,l=e.y-t.y,a=o.x-t.x,h=o.y-t.y;return s=r*a+l*h,i=(r*r+l*l)*(a*a+h*h),(s/=Math.sqrt(i))>=1?0:s<=-1?Math.PI:180*(n=Math.acos(s))/Math.PI<180?n:2*Math.PI-n},B.prototype.getLineForPoint=function(t,e){var o={};return 0==t.a||void 0===t.a?t.hasOwnProperty("x")?o.y=e.y:t.hasOwnProperty("y")&&(o.x=e.x):(o.a=-1/t.a,o.b=e.y-e.x*o.a),o},B.prototype.getJoinLinePoint=function(t,e){var o=this.getVerticalLine(e,t);return this.getIntersectionPoint(e,o)},B.prototype.getDisForPoinLine=function(t,e){var o=this.getJoinLinePoint(t,e);return this.getDistance(t,o)},B.prototype.getVerticalLine=function(t,e){if(void 0===t.a)return t.hasOwnProperty("x")?{y:e.y}:t.hasOwnProperty("y")?{x:e.x}:null;if(0==t.a)return{x:e.x};var o={};return o.a=-1/t.a,this.createLine3(o,e)},B.prototype.isContainForSegment=function(t,e,o,n){n||(n=d);var i=this.getDistance(e,t)+this.getDistance(o,t),s=this.getDistance(e,o);return Math.abs(i-s)<n},B.prototype.isPointInPoly=function(t,e){for(var o=t.x,n=t.y,i=!1,s=0,r=e.length-1;s<e.length;r=s++){var l=e[s],a=e[r],h=l.x,c=l.y,d=a.x,p=a.y;c>n!=p>n&&o<(d-h)*(n-c)/(p-c)+h&&(i=!i)}return i},B.prototype.getDisForPoinSegment=function(t,e,o,n){var i=this.createLine1(e,o),s=this.getJoinLinePoint(t,i),r=this.getDistance(e,o),l=this.getDistance(s,e),a=this.getDistance(s,o);return this.getDistance(s,e)>r||this.getDistance(s,o)>r?l<a&&l<n?{type:1,join:e}:a<l&&a<n?{type:2,join:o}:null:l<n?{type:1,join:e}:a<n?{type:2,join:o}:this.getDistance(t,s)<n?{type:0,join:s}:void 0},B.prototype.PointInSegment=function(t,e,o,n){if(this.getDistance(t,e)<d||this.getDistance(t,o)<d)return!0;n||(n=.1),n/=2;var i=(t.x-e.x)*(o.y-e.y)-(o.x-e.x)*(t.y-e.y),s=Math.min(e.x,o.x)-t.x,r=t.x-Math.max(e.x,o.x),l=Math.min(e.y,o.y)-t.y,a=t.y-Math.max(e.y,o.y);return Math.abs(i)<n&&(s<=0||Math.abs(s)<n)&&(r<=0||Math.abs(r)<n)&&(l<=0||Math.abs(l)<n)&&(a<=0||Math.abs(a)<n)},B.prototype.clonePoint=function(t,e){t.x=e.x,t.y=e.y},B.prototype.equalPoint=function(t,e){return t.x==e.x&&t.y==e.y},B.prototype.crossTwoLines=function(t,e,o,n,i){void 0===i&&(i=d);var s=this.getIntersectionPoint2(t,e,o,n);if(null!=s){if(this.getDistance(t,s)>i&&this.getDistance(e,s)>i&&this.getDistance(o,s)>i&&this.getDistance(n,s)>i)return this.getDistance(t,s)<this.getDistance(t,e)&&this.getDistance(e,s)<this.getDistance(t,e)&&this.getDistance(o,s)<this.getDistance(o,n)&&this.getDistance(n,s)<this.getDistance(o,n)}else if(this.PointInSegment(t,o,n)||this.PointInSegment(e,o,n))return!0;return!1},B.prototype.getDisPointsLine=function(t,e,o,n){var i={},s={},r={};if(t.hasOwnProperty("x"))i.x=t.x,i.y=e.y-o,s.x=t.x,s.y=e.y+n;else if(t.hasOwnProperty("y"))i.y=t.y,i.x=e.x-o,s.y=t.y,s.x=e.x+n;else{var l=Math.atan(t.a),a={a:-1/t.a},h=this.createLine3(a,e),c=this.getIntersectionPoint(t,h);i.x=c.x-o*Math.cos(l),i.y=c.y-o*Math.sin(l),s.x=c.x+n*Math.cos(l),s.y=c.y+n*Math.sin(l)}return r.newpoint1=i,r.newpoint2=s,r},B.prototype.getBoundingBox=function(t){for(var e=t[0].x,o=t[0].x,n=t[0].y,i=t[0].y,s=1;s<t.length;++s){var r=t[s];e>r.x&&(e=r.x),n>r.y&&(n=r.y),o<r.x&&(o=r.x),i<r.y&&(i=r.y)}var l={};return l.minX=e,l.minY=n,l.maxX=o,l.maxY=i,l},B.prototype.ComputePolygonArea=function(t){var e=t.length;if(e<3)return 0;for(var o=t[0].y*(t[e-1].x-t[1].x),n=1;n<e;++n)o+=t[n].y*(t[n-1].x-t[(n+1)%e].x);return Math.abs(o/2)},B.prototype.getPolygonCore=function(t){function e(t,e,o){return(t.x*e.y+e.x*o.y+o.x*t.y-e.x*t.y-o.x*e.y-t.x*o.y)/2}for(var o=0,n=0,i=0,s=t[1],r=2;r<t.length;r++){var l=t[r],a=e(t[0],s,l);i+=a,o+=(t[0].x+s.x+l.x)*a,n+=(t[0].y+s.y+l.y)*a,s=l}return{x:o/i/3,y:n/i/3}},B.prototype.isPolyInPoly=function(t,e,o){for(var n=0;n<t.length;++n){for(var i=!1,s=0;s<e.length;++s)if(this.equalPoint(t[n],e[s])){i=!0;break}if(i){var r=n==t.length-1?0:n+1,l={x:(t[n].x+t[r].x)/2,y:(t[n].y+t[r].y)/2};if(!this.isPointInPoly(l,e,o))return!1}else if(!this.isPointInPoly(t[n],e,o))return!1}return!0},B.prototype.dotPoints=function(t,e,o,n){var i={},s={};return i.start={},i.end={},i.start.x=0,i.start.y=0,i.end.x=e.x-t.x,i.end.y=e.y-t.y,s.start={},s.end={},s.start.x=0,s.start.y=0,s.end.x=n.x-o.x,s.end.y=n.y-o.y,i.end.x*s.end.x+i.end.y*s.end.y};var Y=new B,j="LEFT",X="RIGHT",J=function(){this.len=null};J.prototype.setId=function(t){null==t||void 0===t?(t=b.getCurrentId(),b.updateCurrentId(),this.vectorId=this.geoType+t):this.vectorId=t},J.prototype.setSymbolPosition=function(t,e){"start"==e?Y.clonePoint(this.startPoint,t):"end"==e&&Y.clonePoint(this.endPoint,t)},J.prototype.setSymbolParent=function(t){this.parent=t},J.prototype.setPointParent=function(t,e){null==this.parent&&(this.parent={}),this.parent[t]=e},J.prototype.setOpenSide=function(t){var e=[];e.push(this.startPoint),e.push(this.endPoint),e.push(t);var o=null;o=Y.isClockwise(e)?j:X,this.openSide=o},J.prototype.rotatePoint=function(t,e,o){var n=e.x,i=e.y,s=t.x,r=t.y;return{x:n+(s-n)*Math.cos(o*Math.PI/180)-(r-i)*Math.sin(o*Math.PI/180),y:i+(s-n)*Math.sin(o*Math.PI/180)+(r-i)*Math.cos(o*Math.PI/180)}};var U=function(t){function e(e,o,n,i){t.call(this),this.x=e,this.y=o,this.display=!1,this.floor=i,this.name=null,this.parent={},this.geoType=k,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e}(J),V=function(t){function e(e,o,n,i){t.call(this),this.start=e,this.end=o,this.floor=i,this.children=[],this.out=!1,this.important=!1,this.geoType=W,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getOtherPointId=function(t){return this.start==t?this.end:this.end==t?this.start:null},e.prototype.getPointId=function(t){return"start"==t?this.start:this.end},e.prototype.clearChildren=function(){this.children=[]},e.prototype.setImportant=function(t){this.important=t},e.prototype.setOut=function(t){this.out=t},e.prototype.setChildren=function(t){this.children=t},e}(J),$=function(){};$.prototype.getLine=function(t){var e=b.getPoint(t.start),o=b.getPoint(t.end);return Y.createLine1(e,o)},$.prototype.isContain=function(t,e,o){var n=b.getPoint(t.start),i=b.getPoint(t.end);return Y.isContainForSegment(e,n,i,o)},$.prototype.addChildren=function(t,e){t.children.indexOf(e)<0&&t.children.push(e)},$.prototype.createWall=function(t,e,o,n){var i=new V(t,e,o,n);return null!=n&&void 0!==n||(n=b.currentFloor),b.addWall(i,n),this.setPointParent(i.vectorId,t,"start",n),this.setPointParent(i.vectorId,e,"end",n),i},$.prototype.createPoint=function(t,e,o,n){var i=new U(t,e,o,n);return null!=n&&void 0!==n||(n=b.currentFloor),b.addPoint(i,n),i},$.prototype.setPointParent=function(t,e,o,n){var i=b.getPoint(e,n),s=b.getWall(t,n);i.setPointParent(t,o),"start"==o?s.start=e:"end"==o&&(s.end=e)},$.prototype.splitWall=function(t,e,o){var n,i=b.getWall(t),s=b.getPoint(i.start),r=b.getPoint(i.end),l=b.getPoint(e);return Y.getDistance(s,l)<p||Y.getDistance(r,l),"start"==o?(delete r.parent[t],(n=this.createWall(e,i.end)).setOut(i.out),n.setImportant(i.important),this.setPointParent(t,e,"end"),r.setPointParent(n.vectorId,o)):"end"==o&&(delete s.parent[t],(n=this.createWall(i.start,e)).setOut(i.out),n.setImportant(i.important),this.setPointParent(t,e,"start"),s.setPointParent(n.vectorId,o)),n.vectorId},$.prototype.getWallId=function(t,e){var o=b.getPoint(t),n=b.getPoint(e);if(!o||!n)return console.log("pointId1或者pointId2不存在"),null;if(t==e)return console.log("给的是同一个point"),null;var i=o.parent,s=n.parent;for(var r in i)if(s.hasOwnProperty(r))return r;return null},$.prototype.isWallLink=function(t,e){var o=b.getWall(t),n=b.getWall(e);return o.start==n.start||o.start==n.end||o.end==n.start||o.end==n.end},$.prototype.AngleForWall=function(t,e){var o=b.getWall(t),n=b.getWall(e);if(null==o||null==n||void 0===o||void 0===n)return null;var i=b.getPoint(o.start),s=b.getPoint(o.end),r=b.getPoint(n.start),l=b.getPoint(n.end),a=Y.getDistance(i,r),h=Y.getDistance(i,l),c=Y.getDistance(s,r),d=Y.getDistance(s,l),p=Math.min(a,h,c,d);return null==Y.getIntersectionPoint2(i,s,r,l)?Math.PI:a==p?(s.x+=r.x-i.x,s.y+=r.y-i.y,Y.Angle(r,s,l)):h==p?(s.x+=l.x-i.x,s.y+=l.y-i.y,Y.Angle(l,s,r)):c==p?(i.x+=r.x-s.x,i.y+=r.y-s.y,Y.Angle(r,i,l)):d==p?(i.x+=l.x-s.x,i.y+=l.y-s.y,Y.Angle(l,i,r)):(console.error("AngleForWall**************************1"),null)},$.prototype.AngleForWall2=function(t,e){var o=b.getWall(t),n=b.getWall(e);if(null==o||null==n||void 0===o||void 0===n)return null;var i=b.getPoint(o.start),s=b.getPoint(o.end),r=b.getPoint(n.start),l=b.getPoint(n.end),a=null,h=[];return h.push(i),h.push(s),o.start==n.start?(a=Y.Angle(i,s,l),h.push(l)):o.start==n.end?(a=Y.Angle(i,s,r),h.push(r)):o.end==n.start?(a=Y.Angle(s,i,l),h[0]=s,h[1]=i,h.push(l)):o.end==n.end&&(a=Y.Angle(s,i,r),h[0]=s,h[1]=i,h.push(r)),null==a?null:Y.isClockwise(h)?{angle:a,clockwise:1}:{angle:a,clockwise:0}},$.prototype.AngleForWall3=function(t,e){var o=b.getWall(t),n=b.getWall(e);if(null==o||null==n||void 0===o||void 0===n)return null;var i=b.getPoint(o.start),s=b.getPoint(o.end),r=b.getPoint(n.start),l=b.getPoint(n.end),a=Y.getDistance(i,r),h=Y.getDistance(i,l),c=Y.getDistance(s,r),d=Y.getDistance(s,l),p=Math.min(a,h,c,d),y={},u={};return a==p?(u.x=s.x+r.x-i.x,u.y=s.y+r.y-i.y,Y.Angle(r,u,l)):h==p?(u.x=s.x+l.x-i.x,u.y=s.y+l.y-i.y,Y.Angle(l,u,r)):c==p?(y.x=i.x+r.x-s.x,y.y=i.y+r.y-s.y,Y.Angle(r,y,l)):d==p?(y.x=i.x+l.x-s.x,y.y=i.y+l.y-s.y,Y.Angle(l,y,r)):(console.error("WallService.AngleForWall3************************************1"),null)},$.prototype.wallIdForMinAngle=function(t,e){var o,n,i,s,r=b.getPoint(t).parent,l=null,a=null,h=null,c=null;if(Object.keys(r).length>2){for(var d in r)if(d!=e){var p=this.AngleForWall2(e,d);null==h&&1==p.clockwise?((n=p).wallId=d,h=p.angle,(s=p).wallId=d,c=p.angle):h>p.angle&&1==p.clockwise?((n=p).wallId=d,h=p.angle):c<p.angle&&1==p.clockwise?((s=p).wallId=d,c=p.angle):null==l&&0==p.clockwise?((o=p).wallId=d,l=p.angle,(i=p).wallId=d,a=p.angle):l>p.angle&&0==p.clockwise?((o=p).wallId=d,l=p.angle):a<p.angle&&0==p.clockwise&&((i=p).wallId=d,a=p.angle)}var y={min0:o,min1:n};return y.min0||(y.min0=s,y.min0.angle=360-s.angle),y.min1||(y.min1=i,y.min1.angle=360-i.angle),y}return console.error("wallIdForMinAngle*********************************************************"),null},$.prototype.mergeWall=function(t,e){var o=this.getLinkPointId(t,e),n=b.getWall(e).getOtherPointId(o),i=b.getPoint(n);if(this.changeSymbolsWallToWall(e,t),Object.keys(i.parent).length>1)this.moveTo(o,n);else{var s=b.getPoint(o);Y.clonePoint(s,i)}return n},$.prototype.changeSymbolsWallToWall=function(t,e,o){for(var n=b.getWall(t,o),i=b.getWall(e,o),s=0;s<n.children.length;++s){var r=n.children[s];b.getSymbol(r,o).setSymbolParent(e),this.addChildren(i,r)}n.clearChildren()},$.prototype.mergeWallForPoint=function(t){var e=b.getPoint(t);if(null!=e&&2==Object.keys(e.parent).length&&this.AngleForWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1])>u/180*Math.PI)return this.mergeWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1]);return null},$.prototype.getLinkPointId=function(t,e){var o=b.getWall(t),n=b.getWall(e);return o.start==n.start||o.start==n.end?o.start:o.end==n.start||o.end==n.end?o.end:o.start==n.start?null:void 0},$.prototype.moveTo=function(t,e){var o=this.getWallId(t,e),n=b.getPoint(t),i=b.getPoint(e);n.x,i.x,n.y,i.y;var s=n.parent,r=i.parent;for(var l in s)if(l!=o){var a=b.getWall(l).getOtherPointId(t),h=b.getPoint(a);for(var c in r)if(c!=o){var d=b.getWall(c).getOtherPointId(e),p=b.getPoint(d),u=Y.Angle(i,h,p);if(Math.abs(u)<y/180*Math.PI)return!1}}if(null!=o&&b.deleteWall(o),n=b.getPoint(t),i=b.getPoint(e),!n||!i)return!1;for(var g in s){var x=b.getWall(g),f=x.getOtherPointId(t);if(null!=this.getWallId(f,e))return!1;x.start==t?(b.deletePoint(x.start,g),x.start=e,i.setPointParent(g,"start")):x.end==t?(b.deletePoint(x.end,g),x.end=e,i.setPointParent(g,"end")):console.error("wallService.moveTo****************************************************")}return!0},$.prototype.getDirction=function(t,e){var o=b.getWall(e);return o.start==t?"start":o.end==t?"end":(console.error("WallService.getDirction*******************************************************************************************"),null)},$.prototype.isOverlapForMergePoint=function(t,e){var o=this.getWallId(t,e),n=b.getPoint(t),i=b.getPoint(e),s=n.x-i.x,r=n.y-i.y,l=n.parent,a=i.parent;for(var h in l)if(h!=o){var c=b.getWall(h).getOtherPointId(t),d=b.getPoint(c),p={x:d.x-s,y:d.y-r};for(var u in a)if(u!=o){var g=b.getWall(u).getOtherPointId(e),x=b.getPoint(g),f=Y.Angle(i,p,x);if(Math.abs(f)<y/180*Math.PI)return!0}}return!1},$.prototype.subtraWallFromIntersect=function(t,e){var o=b.getPoint(t),n=o.parent,i=this.getDirction(t,e);if(1!=Object.keys(n).length){delete n[e];var s=this.createPoint(o.x,o.y);s.setPointParent(e,i);var r=b.getWall(e);"start"==i?r.start=s.vectorId:"end"==i&&(r.end=s.vectorId)}},$.prototype.setWallInfo=function(t){var e=b.getWall(t.vectorId);return e.start=t.start,e.end=t.end,e.children=t.children,e.out=t.out,e.important=t.important,e},$.prototype.setPointInfo=function(t){var e=b.getPoint(t.vectorId);return Y.clonePoint(e,t.position),e.parent=JSON.parse(JSON.stringify(t.parent)),e},$.prototype.getNeighPoints=function(t,e){var o=[],n=b.getPoint(t);for(var i in n.parent){var s=b.getWall(i).getOtherPointId(t);if(!e||e!=s){var r=b.getPoint(s);o.push(r)}}return o},$.prototype.deleteWallCorner=function(t){var e=b.getPoint(t);if(1==Object.keys(e.parent).length)b.deleteWall(Object.keys(e.parent)[0]);else if(Object.keys(e.parent).length>2)for(var o in e.parent)b.deleteWall(o);else if(2==Object.keys(e.parent).length){this.AngleForWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1])>u/180*Math.PI?this.mergeWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1]):(b.deleteWall(Object.keys(e.parent)[0]),b.deleteWall(Object.keys(e.parent)[0]))}};var H=new $,z="all",G="start",K="end",q="select",Q=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.openSide=null,this.parent=null,this.enter=null,this.points2d=[],this.name="单开门",this.geoType=F,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=Y.createLine1(this.startPoint,this.endPoint),e=Y.getDistance(this.startPoint,this.endPoint),o=Y.getParallelLineForDistance(t,e),n=Y.getVerticalLine(t,this.startPoint),i=Y.getVerticalLine(t,this.endPoint),s=Y.getIntersectionPoint(o.line1,n),r=Y.getIntersectionPoint(o.line2,n),l=Y.getIntersectionPoint(o.line1,i),a=Y.getIntersectionPoint(o.line2,i);if(this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint),this.points2d.push(l),this.points2d.push(s),this.openSide==j){if(Y.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint),this.points2d.push(a),this.points2d.push(r)}else if(this.openSide==X){if(!Y.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint),this.points2d.push(a),this.points2d.push(r)}},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);if(e<p)return G;if(o<p)return K;if(Y.isContainForSegment(t,this.startPoint,this.endPoint))return q;var n=Y.getDistance(this.points2d[0],this.points2d[1]);if(Y.getDistance(t,this.points2d[0])>n)return null;var i=Y.Angle(this.points2d[0],t,this.points2d[1]),s=Y.Angle(this.points2d[0],t,this.points2d[3]);return i<Math.PI/2&&s<Math.PI/2?q:null},e}(J),Z=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.openSide=null,this.parent=null,this.enter=null,this.points2d=[],this.name="双开门",this.geoType=C,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=Y.createLine1(this.startPoint,this.endPoint),e=Y.getDistance(this.startPoint,this.endPoint),o=Y.getParallelLineForDistance(t,e/2),n=Y.getVerticalLine(t,this.startPoint),i=Y.getVerticalLine(t,this.endPoint),s={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2},r=Y.getVerticalLine(t,s),l=Y.getIntersectionPoint(o.line1,n),a=Y.getIntersectionPoint(o.line2,n),h=Y.getIntersectionPoint(o.line1,i),c=Y.getIntersectionPoint(o.line2,i),d=Y.getIntersectionPoint(o.line1,r),p=Y.getIntersectionPoint(o.line2,r);if(this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(h),this.points2d.push(d),this.points2d.push(l),this.openSide==j){if(Y.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(c),this.points2d.push(p),this.points2d.push(a)}else if(this.openSide==X){if(!Y.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(c),this.points2d.push(p),this.points2d.push(a)}},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);if(e<p)return G;if(o<p)return K;if(Y.isContainForSegment(t,this.startPoint,this.endPoint))return q;var n=[];if(n.push(this.startPoint),n.push(this.endPoint),n.push(t),this.openSide==j){if(!Y.isClockwise(n))return null}else if(this.openSide==X&&Y.isClockwise(n))return null;var i={x:(this.points2d[0].x+this.points2d[1].x)/2,y:(this.points2d[0].y+this.points2d[1].y)/2},s=Y.getDistance(this.points2d[1],this.points2d[2]),r=Y.getDistance(t,this.points2d[0]);if(r<s){var l=Y.Angle(this.points2d[0],t,this.points2d[5]),a=Y.Angle(this.points2d[0],t,i);if(l<Math.PI/2&&a<Math.PI/2)return q}if((r=Y.getDistance(t,this.points2d[2]))<s){var h=Y.Angle(this.points2d[2],t,this.points2d[3]),c=Y.Angle(this.points2d[2],t,i);if(h<Math.PI/2&&c<Math.PI/2)return q}return null},e}(J),tt=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.enter=null,this.points2d=[],this.name="滑动门",this.geoType=T,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=Y.createLine1(this.startPoint,this.endPoint),e=2/h.res,o=Y.getParallelLineForDistance(t,e),n=Y.getVerticalLine(t,this.startPoint),i=Y.getVerticalLine(t,this.endPoint),s=Y.getIntersectionPoint(o.line1,n),r=Y.getIntersectionPoint(o.line2,i),l={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2};this.points2d=[],this.points2d.push(this.startPoint);var a=4/h.res,c=Y.getVerticalLine(t,l),d=Y.getParallelLineForDistance(c,a),p=Y.getIntersectionPoint(o.line1,d.line1),y=Y.getIntersectionPoint(o.line1,d.line2),u=Y.getIntersectionPoint(o.line2,d.line1),g=Y.getIntersectionPoint(o.line2,d.line2),x=Y.getIntersectionPoint(t,d.line1),f=Y.getIntersectionPoint(t,d.line2);Y.getDistance(this.startPoint,x)<Y.getDistance(this.startPoint,f)?(this.points2d.push(f),this.points2d.push(y),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(x),this.points2d.push(u),this.points2d.push(r)):(this.points2d.push(x),this.points2d.push(p),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(f),this.points2d.push(g),this.points2d.push(r))},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);return e<p?G:o<p?K:Y.isContainForSegment(t,this.startPoint,this.endPoint)?q:null},e}(J),et=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.points2d=[],this.name="单开窗",this.geoType=D,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint);var t=4/h.res,e=Y.createLine1(this.startPoint,this.endPoint),o=Y.getParallelLineForDistance(e,t),n=Y.getVerticalLine(e,this.startPoint),i=Y.getVerticalLine(e,this.endPoint),s=Y.getIntersectionPoint(n,o.line1),r=Y.getIntersectionPoint(i,o.line1),l=Y.getIntersectionPoint(i,o.line2),a=Y.getIntersectionPoint(n,o.line2);this.points2d.push(s),this.points2d.push(r),this.points2d.push(l),this.points2d.push(a)},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);return e<p?G:o<p?K:Y.isContainForSegment(t,this.startPoint,this.endPoint)?q:null},e}(J),ot=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.points2d=[],this.name="落地窗",this.geoType=L,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=4/h.res,e=Y.createLine1(this.startPoint,this.endPoint),o=Y.getParallelLineForDistance(e,t),n=Y.getVerticalLine(e,this.startPoint),i=Y.getVerticalLine(e,this.endPoint);this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint);var s={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2},r=Y.getVerticalLine(e,s),l=Y.getIntersectionPoint(n,o.line1),a=Y.getIntersectionPoint(i,o.line1);this.points2d.push(l),this.points2d.push(a);var c=Y.getIntersectionPoint(n,o.line2),d=Y.getIntersectionPoint(i,o.line2);this.points2d.push(c),this.points2d.push(d);var p=Y.getIntersectionPoint(r,o.line1),y=Y.getIntersectionPoint(r,o.line2);this.points2d.push(p),this.points2d.push(y)},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);return e<p?G:o<p?K:Y.isContainForSegment(t,this.startPoint,this.endPoint)?q:null},e}(J),nt=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.openSide="LEFT",this.parent=null,this.points2d=[],this.name="飘窗",this.geoType=M,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t,e,o,n,i=Y.createLine1(this.startPoint,this.endPoint),s=Y.getDistance(this.startPoint,this.endPoint)/2,r=4/h.res+s,l={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2},a=Y.getVerticalLine(i,l),c=Y.getParallelLineForDistance(a,s),d=Y.getParallelLineForDistance(a,r);Y.getDisForPoinLine(this.startPoint,c.line1)>Y.getDisForPoinLine(this.startPoint,c.line2)?(t=c.line2,e=d.line2,o=c.line1,n=d.line1):(t=c.line1,e=d.line1,o=c.line2,n=d.line2);var p=Y.getParallelLineForDistance(i,2/h.res),y=Y.getParallelLineForDistance(i,24/h.res),u=Y.getParallelLineForDistance(i,28/h.res),g=p.line1,x=p.line2,f=y.line2,m=u.line2,v=p.line2,P=p.line1,I=y.line1,S=u.line1,b=Y.getIntersectionPoint(t,g),k=Y.getIntersectionPoint(o,g),w=Y.getIntersectionPoint(o,f),W=Y.getIntersectionPoint(t,f),F=Y.getIntersectionPoint(e,x),C=Y.getIntersectionPoint(n,x),T=Y.getIntersectionPoint(n,m),D=Y.getIntersectionPoint(e,m),M=Y.getIntersectionPoint(t,v),L=Y.getIntersectionPoint(o,v),O=Y.getIntersectionPoint(o,I),A=Y.getIntersectionPoint(t,I),R=Y.getIntersectionPoint(e,P),E=Y.getIntersectionPoint(n,P),_=Y.getIntersectionPoint(n,S),N=Y.getIntersectionPoint(e,S);this.points2d=[],this.points2d.push(b),this.points2d.push(k),this.points2d.push(w),this.points2d.push(W),"LEFT"==this.openSide?Y.isClockwise(this.points2d)?(this.points2d.push(F),this.points2d.push(C),this.points2d.push(T),this.points2d.push(D)):(this.points2d=[],this.points2d.push(M),this.points2d.push(L),this.points2d.push(O),this.points2d.push(A),this.points2d.push(R),this.points2d.push(E),this.points2d.push(_),this.points2d.push(N)):"RIGHT"==this.openSide&&(Y.isClockwise(this.points2d)?(this.points2d=[],this.points2d.push(M),this.points2d.push(L),this.points2d.push(O),this.points2d.push(A),this.points2d.push(R),this.points2d.push(E),this.points2d.push(_),this.points2d.push(N)):(this.points2d.push(F),this.points2d.push(C),this.points2d.push(T),this.points2d.push(D)))},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);if(e<p)return G;if(o<p)return K;var n=Y.isContainForSegment(t,this.startPoint,this.endPoint);if(n)return q;var i=[];return i[0]=this.points2d[4],i[1]=this.points2d[5],i[2]=this.points2d[6],i[3]=this.points2d[7],(n=Y.isPointInPoly(t,i))?q:null},e}(J),it=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.points2d=[],this.name="垭口",this.geoType=O,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){this.points2d=[];var t=5/h.res,e=Y.createLine1(this.startPoint,this.endPoint),o=Y.getParallelLineForDistance(e,t),n=Y.getVerticalLine(e,this.startPoint),i=Y.getVerticalLine(e,this.endPoint),s=Y.getIntersectionPoint(n,o.line1),r=Y.getIntersectionPoint(i,o.line1),l=Y.getIntersectionPoint(i,o.line2),a=Y.getIntersectionPoint(n,o.line2);this.points2d.push(s),this.points2d.push(r),this.points2d.push(l),this.points2d.push(a),t=2/h.res,o=Y.getParallelLineForDistance(e,t);var c=Y.getIntersectionPoint(n,o.line1),d=Y.getIntersectionPoint(i,o.line1),p=Y.getIntersectionPoint(i,o.line2),y=Y.getIntersectionPoint(n,o.line2);this.points2d.push(c),this.points2d.push(d),this.points2d.push(p),this.points2d.push(y)},e.prototype.isContain=function(t){var e=Y.getDistance(t,this.startPoint),o=Y.getDistance(t,this.endPoint);return e<p?G:o<p?K:Y.isContainForSegment(t,this.startPoint,this.endPoint)?q:null},e}(J),st=function(){this.enterImg=null};st.prototype.createSymbol=function(t,e,o,n,i){var s=null;switch(o){case M:s=new nt(t,e,i);break;case L:s=new ot(t,e,i);break;case F:s=new Q(t,e,i);break;case C:s=new Z(t,e,i);break;case T:s=new tt(t,e,i);break;case D:s=new et(t,e,i);break;case O:s=new it(t,e,i)}if(null!=s&&(s.setSymbolParent(n),s.setPoints2d(),b.addSymbol(s)),n){var r=b.getWall(n);H.addChildren(r,s.vectorId)}return s},st.prototype.addSymbol=function(t,e,o){var n=this.getDefaultSymbolLen(e),i=b.getWall(o),s=H.getLine(i);t=Y.getJoinLinePoint(t,s);var r=this.getNewPosForSymbol(t,o,null,n);return r.state?this.createSymbol(r.position1,r.position2,e,o).vectorId:null},st.prototype.isSymbol=function(t){switch(t){case"BayWindow":case"FrenchWindow":case"SingleDoor":case"DoubleDoor":case"SlideDoor":case"SingleWindow":case"Pass":return!0}return!1},st.prototype.getDefaultSymbolLen=function(t){var e=0;switch(t){case"BayWindow":case"FrenchWindow":e=1.5;break;case"SingleDoor":e=.8;break;case"DoubleDoor":case"SlideDoor":e=1.5;break;case"SingleWindow":case"Pass":e=.8}return e},st.prototype.deleteSymbolForWall=function(t,e){if(t){var o=t.children.indexOf(e);o>-1&&t.children.splice(o,1),b.getSymbol(e).parent=null}},st.prototype.deleteSymbol=function(t){var e=b.getSymbol(t);if(e.parent){var o=b.getWall(e.parent);this.deleteSymbolForWall(o,t)}b.deleteSymbol(t)},st.prototype.changeSymbolForBelong=function(t,e){var o=b.getSymbol(t),n=o.parent,i=b.getWall(n);this.deleteSymbolForWall(i,t),o.setSymbolParent(e);var s=b.getWall(e);H.addChildren(s,t)},st.prototype.reBelongForSplitWall=function(t,e,o){for(var n=b.getWall(t),i=0;i<n.children.length;++i){var s=n.children[i];t!=e&&this.isContainSymbolForWall(s,e)?this.changeSymbolForBelong(s,e):t!=o&&this.isContainSymbolForWall(s,o)&&this.changeSymbolForBelong(s,o)}},st.prototype.isContainSymbolForWall=function(t,e){var o=b.getWall(e),n=b.getSymbol(t),i={x:(n.startPoint.x+n.endPoint.x)/2,y:(n.startPoint.y+n.endPoint.y)/2};if(H.isContain(o,i))return!0},st.prototype.changeSymbolForBelong=function(t,e){var o=b.getSymbol(t),n=o.parent,i=b.getWall(n);this.deleteSymbolForWall(i,t),o.setSymbolParent(e);var s=b.getWall(e);H.addChildren(s,t)},st.prototype.updateSymbolsPositionsForWallCorner=function(t){var e=b.getPoint(t).parent;for(var o in e)this.updateSymbolsPositionsForWall(o)},st.prototype.updateSymbolsPositionsForWall=function(t){for(var e=b.getWall(t).children,o=0;o<e.length;++o){var n=b.getSymbol(e[o]);this.updateSEForChangeWall(n)}},st.prototype.updateSEForChangeWall=function(t){var e=t.vectorId,o=b.getWall(t.parent),n=b.getPoint(o.start),i=b.getPoint(o.end),s=Y.createLine1(n,i),r=Y.getJoinLinePoint(t.startPoint,s),l=Y.getJoinLinePoint(t.endPoint,s),a={x:0,y:0},h=!0;H.isContain(o,r)?H.isContain(o,l)||(Y.getDistance(l,n)<Y.getDistance(l,i)?(a.x=n.x-l.x,a.y=n.y-l.y):(a.x=i.x-l.x,a.y=i.y-l.y),l.x+=a.x,l.y+=a.y,H.isContain(o,{x:r.x+a.x,y:r.y+a.y})&&(r.x+=a.x,r.y+=a.y),h=!1):(Y.getDistance(r,n)<Y.getDistance(r,i)?(a.x=n.x-r.x,a.y=n.y-r.y):(a.x=i.x-r.x,a.y=i.y-r.y),r.x+=a.x,r.y+=a.y,H.isContain(o,{x:l.x+a.x,y:l.y+a.y})&&(l.x+=a.x,l.y+=a.y),h=!1),h?(this.setPosition(t,r,"start"),this.setPosition(t,l,"end"),t.setPoints2d()):this.updateSEForCollideSymbols(e,r,l)},st.prototype.updateSEForCollideSymbols=function(t,e,o){var n=b.getSymbol(t),i=this.getNewForContainSymbols(e,o,n.parent,t);null!=i&&(Y.getDistance(i.position1,i.position2)<x?this.deleteSymbol(t):(this.setPosition(n,i.position1,"start"),this.setPosition(n,i.position2,"end"),n.setPoints2d()))},st.prototype.getNewForContainSymbols=function(t,e,o,n){for(var i=b.getWall(o),s=[],r=0;r<i.children.length;++r){var l=i.children[r];if(l!=n){var a=b.getSymbol(l);s.push({x:a.startPoint.x,y:a.startPoint.y,index:1,vectorId:l}),s.push({x:a.endPoint.x,y:a.endPoint.y,index:2,vectorId:l})}}s.push({x:t.x,y:t.y,index:1,vectorId:n}),s.push({x:e.x,y:e.y,index:2,vectorId:n});var h=b.getPoint(i.start);s=s.sort(function(t,e){return Y.getDistance(h,t)-Y.getDistance(h,e)}.bind(this));for(var c=0;c<s.length-1;++c)if(s[c].vectorId==n)if(0==c||c==s.length-2){if(Y.getDistance(s[c],s[c+1])<x)return null;if(s[c+1].vectorId==n)return{position1:t,position2:{x:s[c+1].x,y:s[c+1].y}};if(s[c+1].vectorId!=n)return{position1:t,position2:{x:s[c+1].x,y:s[c+1].y},collision:!0}}else if(s[c+1].vectorId==n&&s[c-1].vectorId!=s[c+2].vectorId)return Y.getDistance({x:s[c-1].x,y:s[c-1].y},{x:s[c+2].x,y:s[c+2].y})<x?null:{position1:{x:s[c-1].x,y:s[c-1].y},position2:{x:s[c+2].x,y:s[c+2].y}};return null},st.prototype.getNewPosForSymbol=function(t,e,o,n){var i=b.getWall(e),s=b.getPoint(i.start),r=b.getPoint(i.end),l=H.getLine(i),a=Y.getVerticalLine(l,t),h=n;o&&(h=b.getSymbol(o).len);var c=Y.getParallelLineForDistance(a,h/2),p=Y.getIntersectionPoint(c.line1,l),y=Y.getIntersectionPoint(c.line2,l);if(Y.getDistance(s,r)<h)Y.clonePoint(p,s),Y.clonePoint(y,r);else{var u,g,f={},m={};H.isContain(i,p)?H.isContain(i,y)||(u=s.x-y.x,g=s.y-y.y,f.x=p.x+u,f.y=p.y+g,H.isContain(i,f)?(p.x+=u,p.y+=g,Y.clonePoint(y,s)):(u=r.x-y.x,g=r.y-y.y,p.x+=u,p.y+=g,Y.clonePoint(y,r))):(u=s.x-p.x,g=s.y-p.y,m.x=y.x+u,m.y=y.y+g,H.isContain(i,m)?(y.x+=u,y.y+=g,Y.clonePoint(p,s)):(u=r.x-p.x,g=r.y-p.y,y.x+=u,y.y+=g,Y.clonePoint(p,r)))}for(var v=[],P=0;P<i.children.length;++P){var I=i.children[P];if(I!=o){var S=b.getSymbol(I);v.push({x:S.startPoint.x,y:S.startPoint.y,index:1,vectorId:I}),v.push({x:S.endPoint.x,y:S.endPoint.y,index:2,vectorId:I})}}v.push({x:s.x,y:s.y,index:1,vectorId:e,type:W}),v.push({x:r.x,y:r.y,index:2,vectorId:e,type:W}),v=v.sort(function(t,e){return Y.getDistance(s,t)-Y.getDistance(s,e)}.bind(this));for(var k=0;k<v.length-1;++k)if(Y.isContainForSegment(t,v[k],v[k+1])){if(Y.getDistance(v[k],v[k+1])>h){if(v[k].vectorId==v[k+1].vectorId&&v[k].type!=W)return{position1:p,position2:y,collision:!0,state:!1};if(v[k].vectorId==v[k+1].vectorId&&v[k].type==W)return{position1:p,position2:y,collision:!0,state:!0};if(!Y.isContainForSegment(p,v[k],v[k+1])||!Y.isContainForSegment(y,v[k],v[k+1]))return{position1:p,position2:y,collision:!0,state:!1}}else{if(Y.getDistance(v[k],v[k+1])<x)return{position1:p,position2:y,collision:!0,state:!1};if(v[k].vectorId!=v[k+1].vectorId)return{position1:{x:v[k].x,y:v[k].y},position2:{x:v[k+1].x,y:v[k+1].y},collision:!0,state:!0};if(v[k].vectorId==v[k+1].vectorId&&v[k].type!=W)return{position1:p,position2:y,collision:!0,state:!1};if(v[k].vectorId==v[k+1].vectorId&&v[k].type==W)return{position1:{x:v[k].x,y:v[k].y},position2:{x:v[k+1].x,y:v[k+1].y},collision:!0,state:!0}}!1}else if(Y.getDistance(t,v[k])<d)return{position1:p,position2:y,collision:!0,state:!1};return{position1:p,position2:y,collision:!1,state:!0}},st.prototype.setPosition=function(t,e,o){"start"==o?Y.clonePoint(t.startPoint,e):"end"==o&&Y.clonePoint(t.endPoint,e)},st.prototype.updateSymbolsPositionsForNeighWall=function(t){for(var e=b.getWall(t).children,o=0;o<e.length;++o)this.updateSEForWallSize(e[o])},st.prototype.updateSEForWallSize=function(t){var e=b.getSymbol(t),o=b.getWall(e.parent),n=b.getPoint(o.start),i=b.getPoint(o.end),s={x:e.startPoint.x,y:e.startPoint.y},r={x:e.endPoint.x,y:e.endPoint.y},l={x:0,y:0};if(H.isContain(o,s)){if(H.isContain(o,r))return null;Y.getDistance(r,n)<Y.getDistance(r,i)?(l.x=n.x-r.x,l.y=n.y-r.y):(l.x=i.x-r.x,l.y=i.y-r.y),r.x+=l.x,r.y+=l.y}else Y.getDistance(s,n)<Y.getDistance(s,i)?(l.x=n.x-s.x,l.y=n.y-s.y):(l.x=i.x-s.x,l.y=i.y-s.y),s.x+=l.x,s.y+=l.y;this.updateSEForCollideSymbols(t,s,r)},st.prototype.updateSymbolForLen=function(t,e){var o=b.getSymbol(t),n=o.startPoint,i=o.endPoint,s=Y.createLine1(n,i),r={x:(n.x+i.x)/2,y:(n.y+i.y)/2},l=Y.getVerticalLine(s,r),a=b.getWall(o.parent),h=b.getPoint(a.start),c=b.getPoint(a.end);if(null==e||void 0===e){e=Y.getDistance(n,i);var d=Y.getDistance(h,c);e>d&&(e=d)}var p=Y.getParallelLineForDistance(l,e/2),y=Y.getIntersectionPoint(p.line1,s),u=Y.getIntersectionPoint(p.line2,s),g={};Y.getDistance(n,y)<Y.getDistance(n,u)?(g.start=y,g.end=u):(g.start=u,g.end=y);var x,f,m=!1,v=!1,P=this.getNearestPosition(o.parent,t,!0);return null!=P.startPosition&&Y.PointInSegment(P.startPosition,g.start,g.end)&&(x=g.start.x-P.startPosition.x,f=g.start.y-P.startPosition.y,Y.clonePoint(g.start,P.startPosition),g.end.x-=x,g.end.y-=f,m=!0),null!=P.endPosition&&Y.PointInSegment(P.endPosition,g.start,g.end)&&(x=g.end.x-P.endPosition.x,f=g.end.y-P.endPosition.y,Y.clonePoint(g.end,P.endPosition),m||(g.start.x-=x,g.start.y-=f,Y.PointInSegment(P.startPosition,g.start,g.end)&&(Y.clonePoint(g.start,P.startPosition),m=!0)),v=!0),g.vectorId=t,Y.clonePoint(o.startPoint,g.start),Y.clonePoint(o.endPoint,g.end),o.setPoints2d(),{block:m&v,start:g.start,end:g.end}},st.prototype.getNearestPosition=function(t,e,o,n,i){var s=b.getWall(t),r=b.getPoint(s.start),l=b.getPoint(s.end),a=s.children,h=b.getSymbol(e);h||e||(h={},(h={struct:{}}).startPoint=n,h.endPoint=i);for(var c=1e4,d=1e4,p=null,y=null,u=null,g=null,x=0;x<a.length;++x)if(a[x]!=e){var f=b.getSymbol(a[x]),m=Y.getDistance(h.startPoint,f.startPoint),v=Y.getDistance(h.startPoint,f.endPoint);c>Math.min(m,v)&&(m<v?(p=f.startPoint,u=f.endPoint):(p=f.endPoint,u=f.startPoint),Y.getDistance(h.startPoint,p)>Y.getDistance(h.endPoint,p)?(p=null,u=null):c=Math.min(m,v));var P=Y.getDistance(h.endPoint,f.startPoint),I=Y.getDistance(h.endPoint,f.endPoint);d>Math.min(P,I)&&(P<I?(y=f.startPoint,g=f.endPoint):(y=f.endPoint,g=f.startPoint),Y.getDistance(h.endPoint,y)>Y.getDistance(h.startPoint,y)?(y=null,g=null):d=Math.min(P,I))}return o&&(null==p&&(Y.getDistance(r,h.startPoint)>Y.getDistance(r,h.endPoint)?(p=l,u=l):(p=r,u=r)),null==y&&(Y.getDistance(r,h.startPoint)>Y.getDistance(r,h.endPoint)?(y=r,g=r):(y=l,g=l))),{startPosition:p,startPosition2:u,endPosition:y,endPosition2:g}},st.prototype.moveSymbolSinglePoint=function(t,e,o){var n=b.getSymbol(e),i=Y.createLine1(n.startPoint,n.endPoint),s=Y.getVerticalLine(i,t);t=Y.getIntersectionPoint(s,i);var r={x:(n.startPoint.x+n.endPoint.x)/2,y:(n.startPoint.y+n.endPoint.y)/2},l=b.getWall(n.parent),a=b.getPoint(l.start),h=b.getPoint(l.end);if("start"==o){if(!Y.PointInSegment(r,t,n.endPoint))return null;Y.getDistance(n.startPoint,a)<Y.getDistance(n.endPoint,a)?Y.getDistance(t,r)>Y.getDistance(a,r)&&Y.clonePoint(t,a):Y.getDistance(t,r)>Y.getDistance(h,r)&&Y.clonePoint(t,h)}else if("end"==o){if(!Y.PointInSegment(r,t,n.startPoint))return null;Y.getDistance(n.endPoint,h)<Y.getDistance(n.startPoint,h)?Y.getDistance(t,r)>Y.getDistance(h,r)&&Y.clonePoint(t,h):Y.getDistance(t,r)>Y.getDistance(a,r)&&Y.clonePoint(t,a)}return{dir:o,position:t}},st.prototype.setSymbolInfo=function(t){var e=b.getSymbol(t.vectorId);return e.openSide=t.openSide,e.startPoint=t.start,e.endPoint=t.end,e.points2d=JSON.parse(JSON.stringify(t.points2d)),e.enter=t.enter,e.parent=t.parent,e},st.prototype.setEnterImg=function(t){this.enterImg=t},st.prototype.getEnterImg=function(){return this.enterImg};var rt=new st,lt=function(t){function e(e,o){t.call(this),this.center=e,this.angle=0,this.points2d=[],this.sideWidth=.65,this.sideThickness=.65,this.name="柱子",this.geoType=A,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){return Y.isPointInPoly(t,this.points2d)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/2,e=this.center.y-this.sideThickness/2,o=this.center.x+this.sideWidth/2,n=this.center.y+this.sideThickness/2,i=this.rotatePoint({x:t,y:n},this.center,this.angle),s=this.rotatePoint({x:o,y:n},this.center,this.angle),r=this.rotatePoint({x:o,y:e},this.center,this.angle),l=this.rotatePoint({x:t,y:e},this.center,this.angle);this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l)},e}(J),at=function(t){function e(e,o){t.call(this),this.center=e,this.angle=0,this.points2d=[],this.sideWidth=.65,this.sideThickness=.65,this.name="烟道",this.geoType=R,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),Y.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/2,e=this.center.y-this.sideThickness/2,o=this.center.x+this.sideWidth/2,n=this.center.y+this.sideThickness/2,i=this.rotatePoint({x:t,y:n},this.center,this.angle),s=this.rotatePoint({x:o,y:n},this.center,this.angle),r=this.rotatePoint({x:o,y:e},this.center,this.angle),l=this.rotatePoint({x:t,y:e},this.center,this.angle);this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l),t=this.center.x-(this.sideWidth-.1)/2,e=this.center.y-(this.sideThickness-.1)/2,o=this.center.x+(this.sideWidth-.1)/2,n=this.center.y+(this.sideThickness-.1)/2;var a=this.rotatePoint({x:t,y:n},this.center,this.angle),h=this.rotatePoint({x:o,y:n},this.center,this.angle),c=this.rotatePoint({x:o,y:e},this.center,this.angle),d=this.rotatePoint({x:t,y:e},this.center,this.angle),p={x:(this.center.x+h.x)/2,y:(this.center.y+h.y)/2};this.points2d.push(a),this.points2d.push(h),this.points2d.push(c),this.points2d.push(d),this.points2d.push(p)},e}(J),ht=function(t){function e(e,o){t.call(this),this.center=e,this.angle=0,this.points2d=[],this.sideWidth=.65,this.sideThickness=.65,this.name="楼道",this.geoType=E,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),Y.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/2,e=this.center.y-this.sideThickness/2,o=this.center.x+this.sideWidth/2,n=this.center.y+this.sideThickness/2,i=this.rotatePoint({x:t,y:n},this.center,this.angle),s=this.rotatePoint({x:o,y:n},this.center,this.angle),r=this.rotatePoint({x:o,y:e},this.center,this.angle),l=this.rotatePoint({x:t,y:e},this.center,this.angle);this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l);var a=this.center.x-2/h.res,c=this.center.x+2/h.res,d=3/h.res,p=this.rotatePoint({x:a,y:n},this.center,this.angle),y=this.rotatePoint({x:a,y:e},this.center,this.angle);this.points2d.push(p),this.points2d.push(y);var u=this.rotatePoint({x:c,y:n},this.center,this.angle),g=this.rotatePoint({x:c,y:e},this.center,this.angle);this.points2d.push(u),this.points2d.push(g);for(var x=this.sideThickness*h.res/3,f=0;f<x-2;++f){var m=this.rotatePoint({x:t,y:n-(f+2)*d},this.center,this.angle),v=this.rotatePoint({x:a,y:n-(f+2)*d},this.center,this.angle);this.points2d.push(m),this.points2d.push(v);var P=this.rotatePoint({x:c,y:n-(f+1)*d},this.center,this.angle),I=this.rotatePoint({x:o,y:n-(f+1)*d},this.center,this.angle);this.points2d.push(P),this.points2d.push(I)}},e}(J),ct=function(){this.sideWidth=.65,this.sideThickness=.65};ct.prototype.createComponent=function(t,e,o){var n=null;switch(e){case A:n=new lt(t,o);break;case R:n=new at(t,o);break;case E:n=new ht(t,o)}return n.setPoints2d(),b.addComponent(n),n},ct.prototype.isComponent=function(t){switch(t){case A:case R:case E:return!0}return!1},ct.prototype.setComponentInfo=function(t){var e=b.getComponent(t.vectorId);e.vectorId=t.vectorId,e.angle=t.angle,e.center=JSON.parse(JSON.stringify(t.center)),e.points2d=JSON.parse(JSON.stringify(t.points2d))};var dt=new ct,pt=function(){this.eventName=null,this.selectItem=null,this.focusItem=null,this.draggingItem=null};pt.prototype.getEventName=function(){return this.eventName},pt.prototype.setEventName=function(t){this.eventName=t},pt.prototype.clearEventName=function(){this.eventName=null},pt.prototype.setSelectItem=function(t,e,o){this.selectItem={},this.selectItem.vectorId=t,this.selectItem.type=e,(rt.isSymbol(e)||dt.isComponent(e)||e==N)&&(this.selectItem.selectIndex=o==q?z:o)},pt.prototype.getSelectItem=function(){return this.selectItem},pt.prototype.clearSelectItem=function(){this.selectItem=null},pt.prototype.getDraggingItem=function(){return this.draggingItem},pt.prototype.setDraggingItem=function(t){this.draggingItem=t},pt.prototype.clearDraggingItem=function(){this.draggingItem=null},pt.prototype.getFocusItem=function(){return this.focusItem},pt.prototype.setFocusItem=function(t){this.focusItem=t},pt.prototype.clearFocusItem=function(){this.focusItem=null},pt.prototype.clearItems=function(){this.selectItem=null,this.focusItem=null,this.draggingItem=null};var yt=new pt,ut=function(t){function e(e,o){t.call(this),this.center=e,this.points2d=[],this.title="请输入名称",this.des=null,this.unit="m",this.name="标注",this.adding=!0,this.sideWidth=30,this.sideThickness=30,this.geoType=N,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),Y.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/h.res*g/h.zoom/2,e=this.center.y-this.sideThickness/h.res*g/h.zoom/2,o=this.center.x+this.sideWidth/h.res*g/h.zoom/2,n=this.center.y+this.sideThickness/h.res*g/h.zoom/2,i={x:t,y:n},s={x:o,y:n},r={x:o,y:e},l={x:t,y:e};this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l);var a=(i.x-this.center.x)/2,c=(i.y-this.center.y)/2;this.points2d.push({x:i.x-a,y:i.y-c}),this.points2d.push({x:s.x+a,y:i.y-c}),this.points2d.push({x:this.center.x,y:i.y-c}),this.points2d.push({x:this.center.x,y:r.y+c})},e.prototype.setTitle=function(t){this.title=t},e.prototype.setDes=function(t){this.des=t},e.prototype.setUnit=function(t){this.unit=t},e.prototype.setAdding=function(t){this.adding=t},e}(J),gt=function(){this.pad={top:60,bottom:60,left:265,right:265},this.region={},this.measureLines={top:[],bottom:[],left:[],right:[]},this.minDis=100/h.res,this.unit="m",this.defalutMeasurePad={bottom:60,right:265}};gt.prototype.padding=function(t){void 0===t&&(t={}),Object.assign(this.pad,t),Object.assign(this.defalutMeasurePad,t)},gt.prototype.updatePad=function(t){Object.assign(this.pad,t)},gt.prototype.updateRegion=function(t){this.region.top=this.pad.top,this.region.bottom=h.height-this.pad.bottom,this.region.left=this.pad.left,this.region.right=h.width-this.pad.right},gt.prototype.update=function(){var t=[],e=[],o=[],n=[],i=[],s=b.getPoints();for(var r in s){var l=s[r];i.push({x:l.x,y:l.y})}function a(t,e){return e.y-t.y}function h(t,e){return t.x-e.x}t=[].concat(i).sort(a.bind(this)),(e=[].concat(t)).reverse(),o=[].concat(i).sort(h.bind(this)),(n=[].concat(o)).reverse();var c=null,d=null;this.measureLines.top=[];for(var p=0;p<t.length;++p)if(0==p)c=t[0].x,d=t[0].x,this.measureLines.top.push({x:t[0].x,y:this.region.top});else{if(t[p].x>=c&&t[p].x<=d)continue;(c=Math.min(c,t[p].x))!=(d=Math.max(d,t[p].x))&&this.measureLines.top.push({x:t[p].x,y:this.region.top})}t=this.measureLines.top.sort(h.bind(this)),this.measureLines.top=[],this.measureLines.top.push(t[0]);for(var y=0;y<t.length-1;++y){c=t[y],d=null;for(var u=y+1;u<t.length&&(d=t[u],Math.abs(c.x-d.x)<xt.minDis);++u)d=null,++y;if(null!=d)this.measureLines.top.push(d);else if(y==t.length-1){var g=this.measureLines.top.length;this.measureLines.top[g-1]=t[y];break}}this.measureLines.bottom=[];for(var x=0;x<e.length;++x)if(0==x)c=e[0].x,d=e[0].x,this.measureLines.bottom.push({x:e[0].x,y:this.region.bottom});else{if(e[x].x>=c&&e[x].x<=d)continue;(c=Math.min(c,e[x].x))!=(d=Math.max(d,e[x].x))&&this.measureLines.bottom.push({x:e[x].x,y:this.region.bottom})}e=this.measureLines.bottom.sort(h.bind(this)),this.measureLines.bottom=[],this.measureLines.bottom.push(e[0]);for(var f=0;f<e.length-1;++f){c=e[f],d=null;for(var m=f+1;m<e.length&&(d=e[m],Math.abs(c.x-d.x)<xt.minDis);++m)d=null,++f;if(null!=d)this.measureLines.bottom.push(d);else if(f==e.length-1){var v=this.measureLines.bottom.length;this.measureLines.bottom[v-1]=e[f];break}}this.measureLines.left=[];for(var P=0;P<o.length;++P)if(0==P)c=o[0].y,d=o[0].y,this.measureLines.left.push({x:this.region.left,y:o[0].y});else{if(o[P].y>=c&&o[P].y<=d)continue;(c=Math.min(c,o[P].y))!=(d=Math.max(d,o[P].y))&&this.measureLines.left.push({x:this.region.left,y:o[P].y})}o=this.measureLines.left.sort(a.bind(this)),this.measureLines.left=[],this.measureLines.left.push(o[0]);for(var I=0;I<o.length-1;++I){c=o[I],d=null;for(var S=I+1;S<o.length&&(d=o[S],Math.abs(c.y-d.y)<xt.minDis);++S)d=null,++I;if(null!=d)this.measureLines.left.push(d);else if(I==o.length-1){var k=this.measureLines.left.length;this.measureLines.left[k-1]=o[I];break}}this.measureLines.right=[];for(var w=0;w<n.length;++w)if(0==w)c=n[0].y,d=n[0].y,this.measureLines.right.push({x:this.region.right,y:n[0].y});else{if(n[w].y>=c&&n[w].y<=d)continue;(c=Math.min(c,n[w].y))!=(d=Math.max(d,n[w].y))&&this.measureLines.right.push({x:this.region.right,y:n[w].y})}n=this.measureLines.right.sort(a.bind(this)),this.measureLines.right=[],this.measureLines.right.push(n[0]);for(var W=0;W<n.length-1;++W){c=n[W],d=null;for(var F=W+1;F<n.length&&(d=n[F],Math.abs(c.y-d.y)<xt.minDis);++F)d=null,++W;if(null!=d)this.measureLines.right.push(d);else if(W==n.length-1){var C=this.measureLines.right.length;this.measureLines.right[C-1]=n[W];break}}};var xt=new gt,ft=function(){};ft.prototype.createTag=function(t,e,o){var n=new ut(t,e);return n.setPoints2d(),b.addTag(n,o),n},ft.prototype.setTagInfo=function(t){var e=b.getTag(t.vectorId);e.vectorId=t.vectorId,e.center=JSON.parse(JSON.stringify(t.center)),e.points2d=JSON.parse(JSON.stringify(t.points2d)),e.title=t.title,e.des=t.des,e.unit=t.unit,e.adding=t.adding},ft.prototype.deleteTag=function(t){b.deleteTag(t)},ft.prototype.convertUnit=function(t){for(var e=0;e<l.floors.length;++e){var o=l.floors[e].tags;for(var n in o){var i=o[n];i.unit!=t&&(i.unit=t)}}},ft.prototype.getTags=function(t){return l.floors[t].tags};var mt=new ft,vt=function(){this.aspect=m/v,this.top=null,this.bottom=null,this.left=null,this.right=null};vt.prototype.getCurrentScale=function(t){var e=b.getAngle();t=t.clone().applyEuler(new THREE.Euler(0,e,0));var o=Math.max(Math.abs(t.x),Math.abs(t.z)*this.aspect),n=Math.min(m/f,v/f);return o/2/10*Math.max(1.2*n/800,1.2)},vt.prototype.setCamera=function(t){var e=-10*t,o=10*t,n=10*t/this.aspect,i=-10*t/this.aspect;this.top=n,this.bottom=i,this.left=e,this.right=o};var Pt=new vt,It=function(t){this.layer=t,this.version="v1.1",this.vectorsJson=null,this.saveFloors=[],this.newVectorId=null,this.boundingBox=null,this.uploadData={}};It.prototype.loadFloorJson=function(t){var e=this;return!t&&l.floors.length?Promise.resolve():this.layer.app.store.get("flooruser",t).then((function(t){t.version?t.version==l.version&&(isNaN(t.angle)||void 0===t.angle||null==t.angle?b.setAngle(0):b.setAngle(t.angle),isNaN(t.compass)||void 0===t.compass||null==t.compass?b.setCompass(0):b.setCompass(t.compass),b.setCurrentId(t.currentId),e.load(t.floors)):(e.layer.analyService.initVectors(t),b.setAngle(0),e.layer.reRender())})).catch((function(t){return console.error(t)}))},It.prototype.exportFloorJson=function(){},It.prototype.load=function(t){for(var e=0;e<t.length;++e){var o=t[e];for(var n in b.initFloor(e),b.setCurrentFloor(e),o.points)H.createPoint(o.points[n].x,o.points[n].y,o.points[n].vectorId,e);for(var i in o.walls){var s=H.createWall(o.walls[i].start,o.walls[i].end,o.walls[i].vectorId,e);s.setImportant(o.walls[i].important),s.setOut(o.walls[i].out),s.setChildren(o.walls[i].children)}for(var r in o.symbols){var l=rt.createSymbol(o.symbols[r].startPoint,o.symbols[r].endPoint,o.symbols[r].geoType,o.symbols[r].parent,o.symbols[r].vectorId);l.openSide=o.symbols[r].openSide,l.enter=o.symbols[r].enter,l.points2d=JSON.parse(JSON.stringify(o.symbols[r].points2d))}for(var a in o.components){var h=dt.createComponent(o.components[a].center,o.components[a].geoType,o.components[a].vectorId);h.angle=o.components[a].angle,h.points2d=JSON.parse(JSON.stringify(o.components[a].points2d))}for(var c in b.setBoundingBox(o.boundingBox,e),o.tags){var d=mt.createTag(o.tags[c].center,o.tags[c].vectorId,e);d.setPoints2d(),d.setTitle(o.tags[c].title),d.setDes(o.tags[c].des),d.setUnit(o.tags[c].unit),d.setAdding(!1)}}var p=this.layer.app.core.get("Player").model.currentFloor.floorIndex;b.setCurrentFloor(p)},It.prototype.uploadCad=function(){var t=this.layer.app.core.get("Player").model.size,e=Pt.getCurrentScale(t);return Pt.setCamera(e),this.uploadData.cadInfo=[],this.exportCadImgs()},It.prototype.base64ToBlob=function(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],n=atob(e[1]),i=n.length,s=new Uint8Array(i);i--;)s[i]=n.charCodeAt(i);return new Blob([s],{type:o})},It.prototype.exportImg=function(t){var e=t.toDataURL("png",3);return this.base64ToBlob(e)},It.prototype.exportCadImgs=function(){var t=this;this.layer.uiControl.menu_flex(),yt.clearItems(),xt.updateRegion(!0),xt.update();var e=this.layer.canvas;e.width=m,e.height=v,h.width=m/f,h.height=v/f,h.ratio=f,h.res=Math.min(m/f/Math.abs(Pt.right-Pt.left),v/f/Math.abs(Pt.top-Pt.bottom)),this.layer.renderer.autoRedrawForImg();var o=window.KanKan.Deferred();return setTimeout((function(){var n=b.getFloorNum();if(t.uploadData.files=[],1==n){var i=t.exportImg(e);t.uploadData.files.push(i),historyService.clearHistoryRecord(),t.layer.$xui.toolbar.recall=!1,t.layer.$xui.toolbar.recover=!1}else{for(var s=t.exportImg(e),r=b.getCurrentFloor(),l=0;l<n;++l)if(l!=r){t.layer.uiControl.currentFloor=l,t.layer.renderer.autoRedrawForImg();var a=t.exportImg(e);t.uploadData.files.push(a)}else t.uploadData.files.push(s);t.layer.uiControl.currentFloor=r}t.uploadData.cadInfo=b.getCadInfo(e),h.updateForCanvas(e),h.setRes(Pt.left,Pt.right),h.ratio=1,t.layer.renderer.autoRedraw(),t.exportMiniMap(o)}),100),o},It.prototype.exportMiniMap=function(t){var e=this;t=t||window.KanKan.Deferred(),yt.clearItems();var o=this.layer.canvas;return o.width=P,o.height=I,h.width=P/f,h.height=I/f,h.ratio=f,h.res=Math.min(P/f/Math.abs(Pt.right-Pt.left),I/f/Math.abs(Pt.top-Pt.bottom)),this.layer.renderer.redrawCore(),setTimeout((function(){var n=b.getFloorNum();if(e.uploadData.miniMaps=[],1==n){var i=e.exportImg(o);e.uploadData.miniMaps.push(i)}else{for(var s=e.exportImg(o),r=b.getCurrentFloor(),l=0;l<n;++l)if(l!=r){e.layer.uiControl.currentFloor=l;var a=e.exportImg(o);e.layer.renderer.redrawCore(),e.uploadData.miniMaps.push(a)}else e.uploadData.miniMaps.push(s);e.layer.uiControl.currentFloor=r}o.width=window.innerWidth,o.height=window.innerHeight,h.updateForCanvas(o);var c=e.layer.app.core.get("CameraControls").activeControl.camera;h.setRes(c.left,c.right),h.ratio=1,e.layer.renderer.autoRedraw(),t.resolve(e.uploadData)}),100),t};var St=function(t){function e(e,o,n){t.call(this),this.start=e,this.end=o,this.name=null,this.display=!1,this.geoType=_,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPositions=function(t,e){this.start.x=t.x,this.start.y=t.y,this.end.x=e.x,this.end.y=e.y},e}(J),bt="StartAddWall",kt="NewWall",wt="StartSymbolPoints",Wt="EndSymbolPoints",Ft="CheckLinesX",Ct="CheckLinesY",Tt="vCheckLinesX",Dt="vCheckLinesY",Mt=function(){this.wallInfo={wallId:null,state:null},this.pointInfo={pointId:null,state:null},this.symbolInfo={symbolId:null,state:null},this.componentInfo={componentId:null,state:null},this.tagInfo={tagId:null,state:null},this.modifyPoint=null};Mt.prototype.start=function(t,e,o){var n=this.getNearForVectors(t,e,o);n.modifyPoint&&(n.modifyPoint.hasOwnProperty("linkedPointId")||n.modifyPoint.hasOwnProperty("linkedPointIdX")||n.modifyPoint.hasOwnProperty("linkedPointIdY")||n.modifyPoint.hasOwnProperty("linkedWallId"))?(this.modifyPoint={x:n.modifyPoint.x,y:n.modifyPoint.y},n.modifyPoint.hasOwnProperty("linkedPointId")&&null!=n.modifyPoint.linkedPointId?this.modifyPoint.linkedPointId=n.modifyPoint.linkedPointId:n.modifyPoint.hasOwnProperty("linkedWallId")&&null!=n.modifyPoint.linkedWallId?this.modifyPoint.linkedWallId=n.modifyPoint.linkedWallId:(n.modifyPoint.hasOwnProperty("linkedPointIdX")&&null!=n.modifyPoint.linkedPointIdX&&(this.modifyPoint.linkedPointIdX=n.modifyPoint.linkedPointIdX),n.modifyPoint.hasOwnProperty("linkedPointIdY")&&null!=n.modifyPoint.linkedPointIdY&&(this.modifyPoint.linkedPointIdY=n.modifyPoint.linkedPointIdY))):this.modifyPoint=null;var i=this.updateSelectInfos(n,p);return this.updateSelectItem(),i},Mt.prototype.getNearForVectors=function(t,e,o){var n=null,i=null,s={},r=null,l=[];e&&l.push(e);var a=b.getWalls();for(var h in a)if(!o||!o.hasOwnProperty(h)){var c=b.getWall(h),d=b.getPoint(c.start),y=b.getPoint(c.end),u=null,g=H.getLine(c);g||console.error("getNearForVectors************************************");var x=Y.getJoinLinePoint(t,g);if(-1==l.indexOf(c.start)){if(l.push(c.start),u=Y.getDistance(t,d),(null==n||n.distance>u)&&(n={distance:u,pointId:c.start},Y.getDistance(x,t)<p&&Y.getDistance(x,d)<p||n.distance<p)){s.linkedPointId=c.start,s.x=d.x,s.y=d.y,delete s.linkedPointIdX,delete s.linkedPointIdY;break}if(Math.abs(t.x-d.x)<p)if(s.linkedPointIdX){var f=b.getPoint(s.linkedPointIdX);Y.getDistance(t,f)>Y.getDistance(t,d)&&(s.x=d.x,s.linkedPointIdX=c.start)}else s.x=d.x,s.linkedPointIdX=c.start;if(Math.abs(t.y-d.y)<p)if(s.linkedPointIdY){var m=b.getPoint(s.linkedPointIdY);Y.getDistance(t,m)>Y.getDistance(t,d)&&(s.y=d.y,s.linkedPointIdY=c.start)}else s.y=d.y,s.linkedPointIdY=c.start}if(-1==l.indexOf(c.end)){if(l.push(c.end),u=Y.getDistance(t,y),(null==n||n.distance>u)&&(n={distance:u,pointId:c.end},Y.getDistance(x,t)<p&&Y.getDistance(x,y)<p||n.distance<p)){s.linkedPointId=c.end,s.x=y.x,s.y=y.y,delete s.linkedPointIdX,delete s.linkedPointIdY;break}if(Math.abs(t.x-y.x)<p)if(s.linkedPointIdX){var v=b.getPoint(s.linkedPointIdX);Y.getDistance(t,v)>Y.getDistance(t,y)&&(s.x=y.x,s.linkedPointIdX=c.end)}else s.x=y.x,s.linkedPointIdX=c.end;if(Math.abs(t.y-y.y)<p)if(s.linkedPointIdY){var P=b.getPoint(s.linkedPointIdY);Y.getDistance(t,P)>Y.getDistance(t,y)&&(s.y=y.y,s.linkedPointIdY=c.end)}else s.y=y.y,s.linkedPointIdY=c.end}u=Y.getDistance(t,x);var I=H.isContain(c,x);I&&(null==i||i.distance>u)&&(i={distance:u,wallId:h}),I&&Y.getDistance(t,x)<p&&((r=x).linkedWallId=h)}var S={minPoint:n,minWall:i,symbolInfo:{},componentInfo:{},tagInfo:{}};null!=r?S.modifyPoint=JSON.parse(JSON.stringify(r)):s.hasOwnProperty("x")&&s.hasOwnProperty("y")?S.modifyPoint=JSON.parse(JSON.stringify(s)):s.hasOwnProperty("x")?(S.modifyPoint=JSON.parse(JSON.stringify(s)),S.modifyPoint.x=s.x,S.modifyPoint.y=t.y):s.hasOwnProperty("y")&&(S.modifyPoint=JSON.parse(JSON.stringify(s)),S.modifyPoint.x=t.x,S.modifyPoint.y=s.y);var k=b.getSymbols();for(var w in k){var W=b.getSymbol(w).isContain(t);if(null!=W){S.symbolInfo={symbolId:w,state:W};break}}var F=b.getComponents();for(var C in F){if(b.getComponent(C).isContain(t)){S.componentInfo={componentId:C,state:"all"};break}}var T=b.getTags();for(var D in T){if(b.getTag(D).isContain(t)){S.tagInfo={tagId:D,state:"all"};break}}return S},Mt.prototype.updateSelectInfos=function(t,e){var o=!1;null!=t.minPoint?t.minPoint.distance<e?(o=this.isChanged(t.minPoint.pointId,q,1),this.pointInfo={pointId:t.minPoint.pointId,state:q}):(o=this.isChanged(t.minPoint.pointId,null,1),this.pointInfo={pointId:t.minPoint.pointId,state:null}):(o=this.isChanged(null,null,1),this.pointInfo={pointId:null,state:null});var n=!1;null!=t.minWall?t.minWall.distance<e?(n=this.isChanged(t.minWall.wallId,q,2),this.wallInfo={wallId:t.minWall.wallId,state:q}):(n=this.isChanged(t.minWall.wallId,null,2),this.wallInfo={wallId:t.minWall.wallId,state:null}):(n=this.isChanged(null,null,2),this.wallInfo={wallId:null,state:null});var i=this.isChanged(t.symbolInfo.symbolId,t.symbolInfo.state,3);this.symbolInfo={symbolId:t.symbolInfo.symbolId,state:t.symbolInfo.state};var s=this.isChanged(t.componentInfo.componentId,t.componentInfo.state,4);this.componentInfo={componentId:t.componentInfo.componentId,state:t.componentInfo.state};var r=this.isChanged(t.tagInfo.tagId,t.tagInfo.state,5);return this.tagInfo={tagId:t.tagInfo.tagId,state:t.tagInfo.state},o||n||i||s||r},Mt.prototype.isChanged=function(t,e,o){var n=!1;return 1==o?n=(null!=e||e!=this.pointInfo.state)&&(this.pointInfo.pointId!=t||e!=this.pointInfo.state):2==o?n=(null!=e||e!=this.wallInfo.state)&&(this.wallInfo.wallId!=t||e!=this.wallInfo.state):3==o?n=(null!=e||e!=this.symbolInfo.state)&&(this.symbolInfo.symbolId!=t||e!=this.symbolInfo.state):4==o?n=(null!=e||e!=this.componentInfo.state)&&(this.componentInfo.componentId!=t||e!=this.componentInfo.state):5==o&&(n=(null!=e||e!=this.tagInfo.state)&&(this.tagInfo.tagId!=t||e!=this.tagInfo.state)),n},Mt.prototype.updateSelectItem=function(){if(null!=this.tagInfo.tagId&&null!=this.tagInfo.state){var t=b.getTag(this.tagInfo.tagId);yt.setSelectItem(this.tagInfo.tagId,t.geoType,this.tagInfo.state)}else if(null!=this.componentInfo.componentId&&null!=this.componentInfo.state){var e=b.getComponent(this.componentInfo.componentId);yt.setSelectItem(this.componentInfo.componentId,e.geoType,this.componentInfo.state)}else if(null!=this.symbolInfo.symbolId&&null!=this.symbolInfo.state){var o=b.getSymbol(this.symbolInfo.symbolId);yt.setSelectItem(this.symbolInfo.symbolId,o.geoType,this.symbolInfo.state)}else null!=this.pointInfo.pointId&&null!=this.pointInfo.state?yt.setSelectItem(this.pointInfo.pointId,w,q):null!=this.wallInfo.wallId&&null!=this.wallInfo.state?yt.setSelectItem(this.wallInfo.wallId,W,q):yt.clearSelectItem()},Mt.prototype.clear=function(){this.wallInfo={wallId:null,state:null},this.pointInfo={pointId:null,state:null},this.symbolInfo={symbolId:null,state:null},this.componentInfo={componentId:null,state:null},this.modifyPoint=null};var Lt=new Mt,Ot=function(){this.startAddWall=null,this.newWall=null,this.symbolPoints={Start:null,End:null},this.checkLines={X:null,Y:null},this.vCheckLines={X:null,Y:null},this.init()};Ot.prototype.init=function(){this.startAddWall=new U(0,0),this.startAddWall.name=bt,this.newWall=new St({x:0,y:0},{x:1,y:1}),this.newWall.name=kt,this.symbolPoints.Start=new U(0,0),this.symbolPoints.Start.name=wt,this.symbolPoints.End=new U(0,0),this.symbolPoints.End.name=Wt,this.checkLines.X=new St({x:0,y:0},{x:1,y:1}),this.checkLines.X.name=Ft,this.checkLines.Y=new St({x:0,y:0},{x:1,y:1}),this.checkLines.Y.name=Ct,this.vCheckLines.X=new St({x:0,y:0},{x:1,y:1}),this.vCheckLines.X.name=Tt,this.vCheckLines.Y=new St({x:0,y:0},{x:1,y:1}),this.vCheckLines.Y.name=Dt},Ot.prototype.showStartAddWall=function(){this.startAddWall.display=!0},Ot.prototype.hideStartAddWall=function(){this.startAddWall.display=!1},Ot.prototype.setStartAddWall=function(t){this.startAddWall.setPosition(t)},Ot.prototype.showSymbolPoints=function(){this.symbolPoints.Start.display=!0,this.symbolPoints.End.display=!0},Ot.prototype.hideSymbolPoints=function(){this.symbolPoints.Start.display=!1,this.symbolPoints.End.display=!1},Ot.prototype.setSymbolPoints=function(t,e){this.symbolPoints.Start.setPosition(t),this.symbolPoints.End.setPosition(e)},Ot.prototype.showNewWall=function(){this.newWall.display=!0},Ot.prototype.hideNewWall=function(){this.newWall.display=!1},Ot.prototype.setNewWall=function(t,e){this.newWall.setPositions(t,e)},Ot.prototype.setNewWallStartPosition=function(t){this.newWall.start.x=t.x,this.newWall.start.y=t.y},Ot.prototype.setNewWallEndPosition=function(t){this.newWall.end.x=t.x,this.newWall.end.y=t.y},Ot.prototype.setNewWallState=function(t){this.newWall.state=t},Ot.prototype.showCheckLinesX=function(){this.checkLines.X.display=!0},Ot.prototype.hideCheckLinesX=function(){this.checkLines.X.display=!1},Ot.prototype.setCheckLinesX=function(t,e){this.checkLines.X.setPositions(t,e)},Ot.prototype.showCheckLinesY=function(){this.checkLines.Y.display=!0},Ot.prototype.hideCheckLinesY=function(){this.checkLines.Y.display=!1},Ot.prototype.setCheckLinesY=function(t,e){this.checkLines.Y.setPositions(t,e)},Ot.prototype.showVCheckLinesX=function(){this.vCheckLines.X.display=!0},Ot.prototype.hideVCheckLinesX=function(){this.vCheckLines.X.display=!1},Ot.prototype.setVCheckLinesX=function(t,e){this.vCheckLines.X.setPositions(t,e)},Ot.prototype.showVCheckLinesY=function(){this.vCheckLines.Y.display=!0},Ot.prototype.hideVCheckLinesY=function(){this.vCheckLines.Y.display=!1},Ot.prototype.setVCheckLinesY=function(t,e){this.vCheckLines.Y.setPositions(t,e)},Ot.prototype.hideAll=function(){this.hideCheckLinesX(),this.hideCheckLinesY(),this.hideStartAddWall(),this.hideNewWall(),this.hideSymbolPoints(),this.hideVCheckLinesX(),this.hideVCheckLinesY()},Ot.prototype.execute=function(t,e){if(this.hideVCheckLinesX(),this.hideVCheckLinesY(),this.hideCheckLinesX(),this.hideCheckLinesY(),Lt.modifyPoint){if(Lt.modifyPoint.linkedPointIdX){var o=b.getPoint(Lt.modifyPoint.linkedPointIdX);this.setCheckLinesX(o,e),this.showCheckLinesX()}if(Lt.modifyPoint.linkedPointIdY){var n=b.getPoint(Lt.modifyPoint.linkedPointIdY);this.setCheckLinesY(n,e),this.showCheckLinesY()}}t&&(Math.abs(e.x-t.x)<p&&(e.x=t.x,this.setVCheckLinesX(t,e),this.showVCheckLinesX()),Math.abs(e.y-t.y)<p&&(e.y=t.y,this.setVCheckLinesY(t,e),this.showVCheckLinesY()),Y.equalPoint(e,t)&&(this.hideVCheckLinesX(),this.hideVCheckLinesY()))},Ot.prototype.checkAngle=function(t,e,o){function n(t,e,o,n){var i=Y.createLine1(e,o),s=null;if(1==n){var r=Y.getVerticalLine(i,e);s=Y.getJoinLinePoint(t,r)}else 2==n&&(s=Y.getJoinLinePoint(t,i));return s}for(var i=H.getNeighPoints(e,o),s=b.getPoint(e),r=null,l=0;l<i.length;++l){var a=Y.Angle(s,t,i[l]);if(Math.abs(a/Math.PI*180-90)<5?r=n(t,s,i[l],1):(Math.abs(a/Math.PI*180)<5||Math.abs(a/Math.PI*180-180)<5)&&(r=n(t,s,i[l],2)),null!=r)return r}return r};var At=new Ot,Rt=function(){this.history={records:[],currentRecordIndex:-1,state:{pre:0,next:0}}};Rt.prototype.getCurrentRecordIndex=function(){return this.history.currentRecordIndex},Rt.prototype.getHistoryRecord=function(){return null==this.history.currentRecordIndex||0==this.history.records.length?null:this.history.records[this.history.currentRecordIndex]},Rt.prototype.getHistoryRecords=function(){return this.history.records},Rt.prototype.getHistoryState=function(){return this.history.state},Rt.prototype.addHistoryRecord=function(t){var e=this.history.records.length;if(0==e)this.history.records.push(t),this.history.currentRecordIndex=0;else if(this.history.currentRecordIndex+1==e)this.history.records.push(t),++this.history.currentRecordIndex;else{var o=this.history.records.slice(0,this.history.currentRecordIndex+1);o.push(t),this.history.records=o,++this.history.currentRecordIndex}},Rt.prototype.setHistoryState=function(t,e){this.history.state.pre=t,this.history.state.next=e},Rt.prototype.undoHistoryRecord=function(){--this.history.currentRecordIndex},Rt.prototype.redoHistoryRecord=function(){++this.history.currentRecordIndex},Rt.prototype.clearHistoryRecord=function(){this.history.records=[],this.setHistoryState(0,0)},Rt.prototype.hasRecords=function(){return this.history.records.length>0};var Et=new Rt;window.historyService=Et;var _t=function(t){this.layer=t};_t.prototype.initVectors=function(t){for(var e=t.floors,o=-1,n=0,i=0,s=0;s<e.length;++s){var r=e[s];l.floors[s]={},l.floors[s].points={},l.floors[s].walls={},l.floors[s].symbols={},l.floors[s].components={},l.floors[s].tags={},l.floors[s].boundingBox={},l.floors[s].rooms=[];for(var a=null,h=null,c=null,d=null,p=0;p<r["vertex-xy"].length;++p){var y=r["vertex-xy"][p].id+i;o<y&&(o=y),y=k+y;var u={x:r["vertex-xy"][p].x,y:r["vertex-xy"][p].y};H.createPoint(u.x,u.y,y,s),(null==a||a>u.x)&&(a=u.x),(null==h||h>u.y)&&(h=u.y),(null==c||c<u.x)&&(c=u.x),(null==d||d<u.y)&&(d=u.y)}n=o+1,l.floors[s].boundingBox.minX=a,l.floors[s].boundingBox.minY=h,l.floors[s].boundingBox.maxX=c,l.floors[s].boundingBox.maxY=d;for(var g=0;g<r.segment.length;++g){var x=r.segment[g].id+n;o<x&&(o=x),x=W+x;var f=k+(r.segment[g].a+i),m=k+(r.segment[g].b+i);H.createWall(f,m,x,s)}n=o+1,i=o+1}b.setCurrentId(o+1)};var Nt="panBackGround",Bt="addWall",Yt="addingWall",jt="moveWall",Xt="moveWallPoint",Jt="addSymbol",Ut="moveSymbol",Vt="moveSymbolPoint",$t="addComponent",Ht="moveComponent",zt="addTag",Gt="moveTag",Kt="Wall",qt="OutWall",Qt="SingleDoor",Zt="DoubleDoor",te="SlideDoor",ee="SingleWindow",oe="BayWindow",ne="FrenchWindow",ie="Pass",se="Beam",re="Flue",le="Corridor",ae="Tag",he=function(t,e,o){this.name=o||"未命名",this.floor=e,this.roomId=t,this.center=null,this.area=null,this.wallIds=[],this.wallPointIDs=[],this.childrenRooms=[],this.childrenWalls=[],this.parent=null,this.tagName=null,this.backgroundImg_src="default",this.boundingBox={}};he.prototype.setInfo=function(t){this.wallIds=t.wallIds,this.wallPointIDs=t.wallPointIDs,this.area=t.area,this.center=t.center,this.boundingBox=t.boundingBox,this.parent=t.parent,this.childrenWalls=t.childrenWalls,this.childrenRooms=t.childrenRooms},he.prototype.containPoint=function(t){for(var e=[],o=0;o<this.wallPointIDs.length;++o){var n=b.getPoint(this.wallPointIDs[o],this.floor);e.push({x:n.x,y:n.y})}return Y.isPointInPoly(t,e)};var ce=function(t,e,o){this.pointIds=e,this.segmentIds=t,this.childrenPolygonIds=[],this.childrenSegmentIds=[],this.id=o,this.parent=null,this.center=null,this.boundingBox=null,this.area=0,this.floor=1,this.geoType="Polygon"},de=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[],this.pre="",this.currentId=1};de.prototype.init=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[]},de.prototype.start=function(t,e,o){this.pre=o||"",this.init(),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.createPolygon(null,this.segments,this.points),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.getIncludePolygonInfos(),this.updateChildrenSegmentIds(this.segments,this.points,this.polygons)},de.prototype.getStartPoint=function(t,e){var o=null,n=null;for(var i in t)if(i!==e){var s=t[i];(null===o||o.x>s.x||o.x===s.x&&o.y>s.y)&&(o={x:s.x,y:s.y},n=i)}return n},de.prototype.createPolygon=function(t,e,o){if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.matrix={};var n=[];this.preHandle(o,e);var i=Object.keys(e).length;if(0!==Object.keys(o).length&&0!==Object.keys(e).length){null!==t&&o[t]||(t=this.getStartPoint(o)),n.push(t);var s=this.getNextForMinAngleX(t,o,e);if(null!==s){n.push(s);var r=this.getMaxPolygon(n,o,e);this.checkPolygonSegmentIds(r,o,e);var l=this.splitPolygon(r);if(l){var a=this.getPolygonData(l,o,e),h=Object.keys(a.points),c=Object.keys(a.segments);if(a.segments=this.getChildSegments(a.points,a.segments,e),this.createPolygon(l[0],a.segments,a.points),this.updateMartix2(h,c,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.maxPolygons.push(r),this.updateMartix(r,o,e),o[t]||(t=this.getStartPoint(o),s=this.getNextForMinAngleX(t,o,e));var d=[];d.push(t),d.push(s);var p=this.getMinPolygon(d,o,e);if(this.checkPolygonSegmentIds(p,o,e),l=this.splitPolygon(p)){var y=this.getPolygonData(l,o,e),u=Object.keys(y.points),g=Object.keys(y.segments);if(this.createPolygon(l[0],y.segments,y.points),this.updateMartix2(u,g,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==r.length&&0!==p.length){if(this.addPolygon(p,o,e)){var x=p.slice(0);if(x.push(p[0]),this.updateMartix(x,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}if(i===Object.keys(e).length){this.addPolygon(r,o,e);var f=r.slice(0);if(f.push(r[0]),this.updateMartix(f,o,e),this.updateMartix(f,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}var m=this.getStartPoint(o,t);this.createPolygon(m,e,o)}else console.error("createPolygon——————————————————————————————————————————————————————————————出错！")}}}}},de.prototype.splitPolygon=function(t){for(var e=[],o=0;o<t.length-1;++o){if(-1!==e.indexOf(t[o])){var n=t.slice(0,o+1),i=t.indexOf(t[o]);return n=n.splice(i)}e.push(t[o])}return null},de.prototype.getPolygonData=function(t,e,o){for(var n={},i={},s=[],r=0;r<t.length;++r)n[t[r]]=e[t[r]],s.push(e[t[r]]);for(var l=this.checkPolygonSegmentIds(t,e,o),a=0;a<l.length;++a)i[l[a]]=o[l[a]];var h=[],c=[];for(var d in e)if(!(t.indexOf(d)>-1||h.indexOf(d)>-1)){var p=e[d];if(Y.isPointInPoly(p,s)){h.push(d);var y=p.parent;for(var u in y)if(o[u]&&!i[u]&&-1===c.indexOf(u)){var g=null;o[u].start===d?g=o[u].end:o[u].end===d&&(g=o[u].start);var x=e[g];t.indexOf(g)>-1||h.indexOf(g)>-1?c.push(u):Y.isPointInPoly(x,s)&&(c.push(u),h.push(g))}}}for(var f=0;f<h.length;++f)n[h[f]]||(n[h[f]]=e[h[f]]);for(var m=0;m<c.length;++m)i[c[m]]||(i[c[m]]=o[c[m]]);return{points:n,segments:i}},de.prototype.getChildSegments=function(t,e,o){var n=[];for(var i in t)n.push(i);for(var s=0;s<n.length-1;++s)for(var r=s+1;r<n.length;++r){var l=this.getSegmentId2(t[n[s]],t[n[r]]);null==l||e[l]||(e[l]=o[l])}return e},de.prototype.updateMartix2=function(t,e,o,n){for(var i=0;i<e.length;++i){var s=e[i];delete this.matrix[s],delete n[s],this.deleteSegment(s,n,o)}for(var r=0;r<t.length;++r){var l=t[r],a=o[l];a&&0!==Object.keys(a.parent).length||delete o[l]}},de.prototype.addPolygon=function(t,e,o){var n=[],i=[];n[0]=this.getPoint(t[0],e);for(var s=0;s<t.length-1;++s){var r=t[s],l=t[s+1],a=this.getSegmentId(r,l,e,o);i.push(a);var h=this.getPoint(l,e);n.push(h)}var c=this.getId();t.pop();var d=new ce(i,t,c);return d.area=this.getArea(d),d.center=this.getCenter(d),d.boundingBox=Y.getBoundingBox(n),this.polygons.push(d),!0},de.prototype.getMaxPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],s=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===s.min?(t.push(s.min),t):(t.push(s.min),this.getMaxPolygon(t,e,o))},de.prototype.getMinPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],s=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===s.max?(t.push(s.max),t):(t.push(s.max),this.getMinPolygon(t,e,o))},de.prototype.getNextForMinAngleX=function(t,e,o){for(var n=e[t],i=this.getAllLinkedPoint(t,e,o),s=null,r=null,l=0;l<i.length;++l){var a=e[i[l]];if(a){var h=Y.Angle(n,{x:n.x+1,y:n.y},a);a.y-n.y<0&&(h*=-1),(null===s||s>h)&&(s=h,r=i[l])}}return r},de.prototype.getNextForMaxMinAngle=function(t,e,o,n){var i=o[t],s=o[e];i&&s||console.error("getNextForMaxMinAngle******************************************");for(var r=s.x-i.x,l=s.y-i.y,a={x:s.x+r,y:s.y+l},h=this.getAllLinkedPoint(e,o,n),c=null,d=null,p=null,y=null,u=0;u<h.length;++u)if(h[u]!==t){var g=o[h[u]];if(g){var x=Y.Angle(s,a,g);r*(g.y-s.y)-(g.x-s.x)*l<0&&(x*=-1),(null===c||c<x)&&(c=x,d=h[u]),(null===p||p>x)&&(p=x,y=h[u])}}return{max:d,min:y}},de.prototype.updateMartix=function(t,e,o){for(var n=0;n<t.length-1;++n){var i=n===t.length-1?0:n+1,s=this.getSegmentId(t[n],t[i],e,o);this.matrix[s]?(delete this.matrix[s],this.deleteSegment(s,o,e)):this.matrix[s]=1}},de.prototype.getSegmentId=function(t,e,o,n){var i=o[t];if(!i)return null;var s=i.parent;for(var r in s){var l=n[r];if(l&&(l.start===e||l.end===e))return r}return null},de.prototype.getSegmentId2=function(t,e){var o=t.parent,n=e.parent;for(var i in o)if(n[i])return i;return null},de.prototype.getAllLinkedPoint=function(t,e,o){var n=[],i=e[t];i||console.error("getAllLinkedPoint");var s=i.parent;for(var r in s){var l=o[r];l&&(l.start===t?n.push(l.end):l.end===t&&n.push(l.start))}return n},de.prototype.deleteLinksSegment=function(t,e,o){var n=e[t];if(n&&0!==Object.keys(n.parent).length&&o[Object.keys(n.parent)[0]]){var i=this.getOtherPointId(Object.keys(n.parent)[0],t,o);this.deleteSegment(Object.keys(n.parent)[0],o,e);var s=e[i];s&&Object.keys(s.parent).length<2&&this.deleteLinksSegment(i,e,o)}},de.prototype.deleteSegment=function(t,e,o){if(t&&e[t]){var n=e[t];this.deletePoint(n.start,t,o),this.deletePoint(n.end,t,o),delete e[t]}},de.prototype.deletePoint=function(t,e,o){if(t&&o[t]){var n=this.getPoint(t,o);delete n.parent[e],0===Object.keys(n.parent).length&&delete o[t]}},de.prototype.getOtherPointId=function(t,e,o){var n=o[t];return n||console.error("getOtherPointId**********************************************************************"),n.start===e?n.end:n.end===e?n.start:void console.error("getOtherPointId**********************************************************************")},de.prototype.preHandle=function(t,e){var o=!1;for(var n in t){var i=t[n];if(Object.keys(i.parent).length<2)this.deleteLinksSegment(n,t,e),o=!0;else{var s=0;for(var r in i.parent)e[r]&&++s;if(s>1)continue;delete t[n]}}return o},de.prototype.getPoint=function(t,e){return e[t]},de.prototype.isClockwise=function(t,e){for(var o=[],n=0;n<t.length;++n){var i=e[t[n]];o.push({x:i.x,y:i.y})}return Y.isClockwise(o)},de.prototype.getId=function(){var t=this.currentId;return++this.currentId,"Polygon"+t},de.prototype.getArea=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return Y.ComputePolygonArea(e)},de.prototype.getCenter=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return Y.getPolygonCore(e)},de.prototype.getIncludePolygonInfos=function(){this.polygons=this.polygons.sort((function(t,e){return t.area-e.area}));for(var t=0;t<this.polygons.length-1;++t){for(var e=null,o=t+1;o<this.polygons.length;++o)if(o!==t&&this.isContain(this.polygons[t],this.polygons[o])){e=this.polygons[o];break}null!=e&&(this.polygons[t].parent=e.id,e.childrenPolygonIds.push(this.polygons[t].id),e=null)}},de.prototype.updateChildrenSegmentIds=function(t,e,o){for(var n=[],i=0;i<o.length;++i){var s=o[i];n=n.concat(s.segmentIds)}for(var r in t)if(!(n.indexOf(r)>-1))for(var l=t[r],a=e[l.start],h=e[l.end],c=0;c<o.length;++c){var d=!1,p=!1,y=o[c];(y.pointIds.indexOf(l.start)>-1||this.containPoint(y,a))&&(d=!0),(y.pointIds.indexOf(l.end)>-1||this.containPoint(y,h))&&(p=!0),d&&p&&y.childrenSegmentIds.push(r)}},de.prototype.isContain=function(t,e){for(var o=[],n=[],i=0;i<t.pointIds.length;++i){var s=this.points[t.pointIds[i]];o.push(s)}for(var r=0;r<e.pointIds.length;++r){var l=this.points[e.pointIds[r]];n.push(l)}return Y.isPolyInPoly(o,n,.01)},de.prototype.containPoint=function(t,e){for(var o=[],n=0;n<t.pointIds.length;++n){var i=this.points[t.pointIds[n]];o.push(i)}return Y.isPointInPoly(e,o)},de.prototype.checkPolygonSegmentIds=function(t,e,o){for(var n=[],i=0;i<t.length;++i){var s=i===t.length-1?0:i+1;if(t[i]!==t[s]){if(!t[i]||!t[s])return;var r=this.getSegmentId(t[i],t[s],e,o);if(!r)return;n.push(r)}}return n},de.prototype.setCaves=function(){for(var t=0;t<this.polygons.length;++t){var e=this.polygons[t],o=e.childrenPolygonIds.slice(0);this.getChildMaxPolygons(e,o)}},de.prototype.getChildPolygonInfo=function(t){if(t.length<2)return null;for(var e=[],o=[],n=0;n<this.polygons.length;++n){var i=this.polygons[n];t.indexOf(i.id)>-1&&(e=e.concat(i.pointIds),o=o.concat(i.segmentIds))}for(var s={},r={},l=0;l<e.length;++l)s[e[l]]=this.points[e[l]];for(var a=0;a<o.length;++a)r[o[a]]=this.segments[o[a]];return{points:s,segments:r}},de.prototype.getChildMaxPolygons=function(t,e){var o=this.getChildPolygonInfo(e);if(null!=o){var n=this.getStartPoint(o.points),i=[];i.push(n);var s=this.getNextForMinAngleX(n,o.points,o.segments);i.push(s);var r=this.getMaxPolygon(i,o.points,o.segments);r.pop(),t.caves.push(r);for(var l=0;l<e.length;++l)for(var a=this.getPolygon(e[l]),h=0;h<a.pointIds.length;++h)if(r.indexOf(a.pointIds[h])>-1){e.splice(l,1),--l;break}this.getChildMaxPolygons(t,e)}else if(1===e.length){var c=this.getPolygon(e[0]);t.caves.push(c.pointIds)}},de.prototype.getPolygon=function(t){for(var e=0;e<this.polygons.length;++e){var o=this.polygons[e];if(o.id===t)return o}return console.error("找不到多边形！"),null};var pe=new de,ye=function(){this.room_hallImg=null,this.room_defaultImg=null,this.room_otherImg=null};ye.prototype.addRoom=function(t,e){l.floors[e].rooms.push(t)},ye.prototype.getRoom=function(t,e){return l.floors[e].rooms[t]},ye.prototype.getRooms=function(t){return l.floors[t].rooms},ye.prototype.clearRooms=function(t){l.floors[t].rooms=[]},ye.prototype.setHallImg=function(t){this.room_hallImg=t},ye.prototype.getHallImg=function(){return this.room_hallImg},ye.prototype.setDefaultImg=function(t){this.room_defaultImg=t},ye.prototype.getDefaultImg=function(){return this.room_defaultImg},ye.prototype.setOtherImg=function(t){this.room_otherImg=t},ye.prototype.getOtherImg=function(){return this.room_otherImg};var ue=new ye,ge=function(){this.points={},this.segments={},this.polygons=[],this.tempRooms=[]};ge.prototype.start=function(){var t=l.floors;console.log("从头开始分房间！");for(var e=0;e<t.length;++e){var o=t[e].walls,n=t[e].points;ue.clearRooms(e),this.getRoomForSingleFloor(o,n,e)}this.updateRoomsTagName()},ge.prototype.getRoomForSingleFloor=function(t,e,o){this.getRooms(t,e,o);for(var n=0;n<this.tempRooms.length;++n){var i=this.tempRooms[n];i.floor=o;var s=new he(i.roomId,i.floor);s.setInfo({wallIds:i.wallIds,wallPointIDs:i.wallPointIDs,area:i.area,center:i.center,boundingBox:i.boundingBox,parent:i.parent,childrenWalls:i.childrenWalls,childrenRooms:i.childrenRooms}),ue.addRoom(s,o)}this.tempRooms=[]},ge.prototype.getRooms=function(t,e,o){this.convertToSegments(t,o),this.convertToPoints(e,o),pe.start(this.segments,this.points),this.convertToRoomForPolygon(o),this.points={},this.segments={},this.polygons=[]},ge.prototype.convertToPoints=function(t,e){for(var o in t){var n=b.getPoint(o,e),i={pointId:n.vectorId,x:n.x,y:n.y,parent:JSON.parse(JSON.stringify(n.parent))};this.points[n.vectorId]=i}},ge.prototype.convertToSegments=function(t,e){for(var o in t){var n=b.getWall(o,e),i={segmentId:n.vectorId,start:n.start,end:n.end};this.segments[n.vectorId]=i}},ge.prototype.convertToRoomForPolygon=function(){for(var t=0;t<pe.polygons.length;++t){var e=pe.polygons[t],o={};o.roomId=e.id.replace("Polygon","Room"),console.log("房间："+o.roomId),o.wallIds=e.segmentIds,o.wallPointIDs=e.pointIds,o.area=e.area,o.center=e.center,o.boundingBox=e.boundingBox,null!=e.parent?o.parent=e.parent.replace("Polygon","Room"):o.parent=null,o.childrenRooms=[];for(var n=0;n<e.childrenPolygonIds.length;++n)o.childrenRooms.push(e.childrenPolygonIds[n].replace("Polygon","Room"));o.childrenWalls=[];for(var i=0;i<e.childrenSegmentIds.length;++i)o.childrenWalls.push(e.childrenSegmentIds[i]);this.tempRooms.push(o)}pe.polygons=[]},ge.prototype.updateRoomsName=function(){for(var t=0;t<l.floors.length;++t){var e=ue.getRooms(t),o=mt.getTags(t);o=JSON.parse(JSON.stringify(o));for(var n=0;n<e.length;++n)e[n]}},ge.prototype.updateRoomsTagName=function(){function t(t,e){return t.area-e.area}for(var e=0;e<l.floors.length;++e){var o=ue.getRooms(e),n=mt.getTags(e);n=JSON.parse(JSON.stringify(n)),o=o.sort(t);for(var i=0;i<o.length;++i){for(var s=o[i],r=[],a=0;a<s.wallPointIDs.length;++a){var h=b.getPoint(s.wallPointIDs[a],e);r.push(h)}for(var c in n)if(Y.isPointInPoly(n[c].center,r)){s.tagName=n[c].title,delete n[c];break}}}};var xe=new ge,fe=["","⅛","¼","⅜","½","⅝","¾","⅞"],me=function(t,e,o,n){this.name=t,this.symbol=e,this.base=o,this.factor=n};me.prototype.toBase=function(t){return t*this.factor},me.prototype.fromBase=function(t){return t/this.factor};var ve={MILLIMETER:["Millimeter","mm"],CENTIMETER:["Centimeter","cm"],METER:["Meter","m"],KILOMETER:["Kilometer","km"],INCH:["Inch","in"],FOOT:["Foot","ft"],MILE:["Mile","mi"],SQUAREMETER:["SquareMeter","m²"],SQUAREFOOT:["SquareFoot","ft²"],CUBICMETER:["CubicMeter","m³"],CUBICFOOT:["CubicFoot","ft³"],BYTE:["Byte","B"],KILOBYTE:["Kilobyte","kB"],MEGABYTE:["Megabyte","MB"],GIGABYTE:["Gigabyte","GB"],TERABYTE:["Terabyte","TB"],PETABYTE:["Petabyte","PB"],init:function(){var t,e,o,n,i,s,r,l,a,h,c,d=new me(ve.METER[0],ve.METER[1],void 0,1),p=new me(ve.SQUAREMETER[0],ve.SQUAREMETER[1],void 0,1),y=new me(ve.CUBICMETER[0],ve.CUBICMETER[1],void 0,1),u=new me(ve.BYTE[0],ve.BYTE[1],void 0,1);ve.DISTANCE=((t={}).metric=((e={})[ve.MILLIMETER[0]]=new me(ve.MILLIMETER[0],ve.MILLIMETER[1],d,.001),e[ve.CENTIMETER[0]]=new me(ve.CENTIMETER[0],ve.CENTIMETER[1],d,.01),e[ve.METER[0]]=d,e[ve.KILOMETER[0]]=new me(ve.KILOMETER[0],ve.KILOMETER[1],d,1e3),e),t.imperial=((o={})[ve.INCH[0]]=new me(ve.INCH[0],ve.INCH[1],d,.0254),o[ve.FOOT[0]]=new me(ve.FOOT[0],ve.FOOT[1],d,.3048),o[ve.MILE[0]]=new me(ve.MILE[0],ve.MILE[1],d,1609.344),o),t),ve.AREA=((n={}).metric=((i={})[ve.SQUAREMETER[0]]=p,i),n.imperial=((s={})[ve.SQUAREFOOT[0]]=new me(ve.SQUAREFOOT[0],ve.SQUAREFOOT[1],p,.092903),s),n),ve.VOLUME=((r={}).metric=((l={})[ve.CUBICMETER[0]]=y,l),r.imperial=((a={})[ve.CUBICFOOT[0]]=new me(ve.CUBICFOOT[0],ve.CUBICFOOT[1],y,.0283168),a),r);var g=((h={})[ve.BYTE[0]]=u,h[ve.KILOBYTE[0]]=new me(ve.KILOBYTE[0],ve.KILOBYTE[1],u,1e3),h[ve.MEGABYTE[0]]=new me(ve.MEGABYTE[0],ve.MEGABYTE[1],u,1e6),h[ve.GIGABYTE[0]]=new me(ve.GIGABYTE[0],ve.GIGABYTE[1],u,1e9),h[ve.TERABYTE[0]]=new me(ve.TERABYTE[0],ve.TERABYTE[1],u,1e12),h[ve.PETABYTE[0]]=new me(ve.PETABYTE[0],ve.PETABYTE[1],u,1e15),h);ve.DATA=((c={}).metric=g,c.imperial=g,c)},getUnitsOfMeasurementByDomain:function(t){return this[t.toUpperCase()]},getUnitsOfMeasurementByDomainAndSystem:function(t,e){var o=this.getUnitsOfMeasurementByDomain(t);if(o.hasOwnProperty(e.toLowerCase()))return o[e.toLowerCase()];console.error(n+" measurement system is not supported.")},getDefaultUnitByDomainAndSystem:function(t,e){switch(t.toUpperCase()){case"DISTANCE":switch(e.toLowerCase()){case"metric":return this.DISTANCE.metric[this.METER[0]];case"imperial":return this.DISTANCE.imperial[this.FOOT[0]];default:console.error(e+" measurement system is not supported.")}case"AREA":switch(e.toLowerCase()){case"metric":return this.AREA.metric[this.SQUAREMETER[0]];case"imperial":return this.AREA.imperial[this.SQUAREFOOT[0]];default:console.error(e+" measurement system is not supported.")}case"VOLUME":switch(e.toLowerCase()){case"metric":return this.VOLUME.metric[this.CUBICMETER[0]];case"imperial":return this.VOLUME.imperial[this.CUBICFOOT[0]];default:console.error(e+" measurement system is not supported.")}case"DATA":switch(e.toLowerCase()){case"metric":return this.DATA.metric[this.BYTE[0]];case"imperial":return this.DATA.imperial[this.BYTE[0]];default:console.error(e+" measurement system is not supported.")}default:console.error(t+" measurement domain is not supported.")}}},Pe=function(){this.LOCAL_STORAGE_KEY="iv_unit_key",ve.init(),this.unitSystems=["metric","imperial"],this.defaultSystem="metric"},Ie=function(){this.UnitService=new Pe};Ie.prototype.scopedConvert=function(t,o,n,i,s){return void 0===n&&(n=2),e.convert(t,o,n,i,s)},Ie.prototype.convert=function(t,e,o,n,i,s){if(void 0===o&&(o=2),void 0===s&&(s=!1),!t)return"";var r=this.getMostRelevantMeasurement(e,n||this.UnitService.currentSystem,t,i);return this.getFormattedMeasurementString(r[0],r[1],o,s)},Ie.prototype.getFormattedMeasurementString=function(t,e,o,n){return n&&e.name===ve.FOOT[0]?this.formatImperialDistance(12*t):n&&e.name===ve.INCH[0]?this.formatImperialDistance(t):t.toLocaleString(void 0,{minimumFractionDigits:o,maximumFractionDigits:o})+" "+e.symbol},Ie.prototype.formatImperialDistance=function(t){var e=Math.round(8*t),o=Math.floor(e/8),n=Math.floor(o/12),i=o-12*n,s=fe[e%8],r=0===i&&""!==s?"":i;return""!==r&&""!==s&&(s=" "+s),0!==n?n+"' "+r+s+'"':""+r+s+'"'},Ie.prototype.getMostRelevantMeasurement=function(t,e,o,n){void 0===n&&(n=0);var i=[],s=ve.getUnitsOfMeasurementByDomainAndSystem(t,e);for(var r in s)i.push(s[r]);var l=i.filter((function(t){return t.factor>=n})).reduce((function(t,e){return e.fromBase(o)<t.fromBase(o)&&e.fromBase(o)>=1?e:t}));return l?[l.fromBase(o),l]:void 0};var Se=new Ie,be=function(t){this.layer=t,this.showTexture=!0},ke={selectUI:{configurable:!0},currentUI:{configurable:!0},currentFloor:{configurable:!0},currentUnit:{configurable:!0}};ke.selectUI.get=function(){return this.layer.$xui.selectName},ke.selectUI.set=function(t){this.layer.$xui.selectName=t,this.layer.updateEventNameForSelectUI()},ke.currentUI.get=function(){return this.layer.$xui.currentName},ke.currentUI.set=function(t){null===t?this.layer.$xui.hideProps():this.layer.$xui.showProps(t)},ke.currentFloor.get=function(){return this.layer.$xui.currentFloor},ke.currentFloor.set=function(t){if(this.layer.display){b.setCurrentFloor(t);for(var e=this.layer.panos[b.currentFloor],o=0;o<e.length;++o){var n=e[o];n.floorIndex==b.currentFloor&&this.layer.panos.push({vectorId:n.id,x:n.position.x,y:-1*n.position.z,name:"pano"})}xt.update(),Et.clearHistoryRecord(),this.layer.$xui.toolbar.recall=!1,this.layer.$xui.toolbar.recover=!1,this.layer.renderer.autoRedraw()}},ke.currentUnit.get=function(){return this.layer.$xui.currentUnit},ke.currentUnit.set=function(t){this.layer.$xui.hideProps(),xt.unit=t,mt.convertUnit(t),this.layer.history.save(),this.layer.renderer.autoRedraw()},be.prototype.setAttributes=function(t,e,o){var n=yt.getFocusItem();switch(e){case"remove":t==W||"OutWall"==t?b.deleteWall(n.vectorId):rt.isSymbol(t)?rt.deleteSymbol(n.vectorId):dt.isComponent(t)?b.deleteComponent(n.vectorId):t==N?b.deleteTag(n.vectorId):t==w&&H.deleteWallCorner(n.vectorId),yt.clearItems(),this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"rotate":if(rt.isSymbol(t)){var i=b.getSymbol(n.vectorId);if(t==F){if(i.openSide==j)if(Y.isClockwise(i.points2d))i.openSide=X;else{var s=i.endPoint;i.endPoint=i.startPoint,i.startPoint=s,i.openSide=X}else if(i.openSide==X)if(Y.isClockwise(i.points2d))i.openSide=j;else{var r=i.endPoint;i.endPoint=i.startPoint,i.startPoint=r,i.openSide=j}}else if(t==C||t==M)i.openSide==j?i.openSide=X:i.openSide==X&&(i.openSide=j);else{var l=i.endPoint;i.endPoint=i.startPoint,i.startPoint=l}i.setPoints2d(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"angle":if(dt.isComponent(t)){var a=b.getComponent(n.vectorId);a.angle=o,a.setPoints2d(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"width":if(rt.isSymbol(t)){if(rt.updateSymbolForLen(n.vectorId,o).block){var h=b.getSymbol(n.vectorId);console.log("长度阻止："+Y.getDistance(h.startPoint,h.endPoint)),this.layer.$xui.currentAttributes={limit:Y.getDistance(h.startPoint,h.endPoint),type:n.type,name:"width",width:Y.getDistance(h.startPoint,h.endPoint)}}}else if(dt.isComponent(t)){var c=b.getComponent(n.vectorId);c.sideWidth=o,c.setPoints2d()}this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"thickness":if(dt.isComponent(t)){var d=b.getComponent(n.vectorId);d.sideThickness=o,d.setPoints2d(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"split":if(t==W||"OutWall"==t){var p=b.getWall(n.vectorId),y=b.getPoint(p.start),u=b.getPoint(p.end),g={x:(y.x+u.x)/2,y:(y.y+u.y)/2},x=H.createPoint(g.x,g.y);H.splitWall(n.vectorId,x.vectorId,"start"),yt.clearFocusItem(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"tag":if(t==N){var f=b.getTag(n.vectorId);null!=o&&""!=o.trim()?f.setTitle(o):f.setTitle("请输入名称"),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"area":if(t==N){var m=b.getTag(n.vectorId);m.setDes(o),m.setUnit(xt.unit),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"default":if("compass"==t)return void b.setCompass(0);if(rt.isSymbol(t)){var v=rt.getDefaultSymbolLen(t),P=rt.updateSymbolForLen(n.vectorId,v);P.block||(this.layer.$xui.currentAttributes={type:n.type,name:"width",width:Y.getFixed(Y.getDistance(P.start,P.end),2)})}else if(dt.isComponent(t)){var I=b.getComponent(n.vectorId);I.sideWidth=dt.sideWidth,I.sideThickness=dt.sideThickness,I.angle=0,I.setPoints2d(),this.layer.$xui.currentAttributes={name:n.type,width:Y.getFixed(I.sideWidth,2),thickness:Y.getFixed(I.sideThickness,2),angle:0}}this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"enter":if(t==F||t==C||t==T){var S=b.getSymbol(n.vectorId);S.enter=o?"default":null,this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"enterRotate":if(t==F||t==C||t==T){var k=b.getSymbol(n.vectorId);null==k.enter?k.enter="default":"default"==k.enter?k.enter="reverse":"reverse"==k.enter&&(k.enter="default")}this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"important":if(t==W)b.getWall(n.vectorId).setImportant(o),this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"compass":b.setCompass(parseFloat(o))}},be.prototype.showAttributes=function(t){if("compass"!=t){var e=yt.getFocusItem();if(rt.isSymbol(e.type)){var o=b.getSymbol(e.vectorId),n=Y.getDistance(o.startPoint,o.endPoint);n=Y.getFixed(n,2),e.type==F||e.type==C||e.type==T?this.layer.$xui.currentAttributes={name:e.type,width:n,enter:o.enter?o.enter:null}:this.layer.$xui.currentAttributes={name:e.type,width:n}}else if(dt.isComponent(e.type)){var i=b.getComponent(e.vectorId),s=i.sideWidth,r=i.sideThickness;this.layer.$xui.currentAttributes={name:e.type,width:Y.getFixed(s,2),thickness:Y.getFixed(r,2),angle:i.angle}}else if(e.type==N){var l=b.getTag(e.vectorId);this.layer.$xui.currentAttributes={name:e.type,tag:l.title,area:l.des}}else if(e.type==W){var a=b.getWall(e.vectorId);this.layer.$xui.currentAttributes={name:e.type,important:a.important||a.out}}}else this.layer.$xui.currentAttributes={name:"compass",compass:b.getCompass()}},be.prototype.clearUI=function(){this.selectUI=null},be.prototype.getSymbolTypeForUI=function(){return this.selectUI==Qt?F:this.selectUI==Zt?C:this.selectUI==te?T:this.selectUI==ee?D:this.selectUI==oe?M:this.selectUI==ne?L:this.selectUI==ie?O:void 0},be.prototype.getComponentTypeForUI=function(){return this.selectUI==se?A:this.selectUI==re?R:this.selectUI==le?E:void 0},be.prototype.screenShot=function(t){var e=this;return new Promise((function(o){e.menu_flex(),yt.clearItems(),xe.start(),xt.updateRegion(!0),xt.update();var n=e.layer.canvas;n.width=window.innerWidth*f,n.height=window.innerHeight*f,h.width=window.innerWidth,h.height=window.innerHeight,h.ratio=f;var i=e.layer.app.core.get("CameraControls").activeControl.camera;h.res=Math.min(window.innerWidth/Math.abs(i.right-i.left),window.innerHeight/Math.abs(i.top-i.bottom)),e.layer.renderer.autoRedrawForDownLoadImg(t),setTimeout(function(){var e=this;1==b.getFloorNum()?this.downloadCadImg(n,"floorPlan.jpg"):this.layer.app.store.getValue("floorcad").floors.forEach((function(o,i){e.currentFloor=i,e.layer.renderer.autoRedrawForDownLoadImg(t),e.downloadCadImg(n,o.name+".jpg")})),h.updateForCanvas(n),h.setRes(i.left,i.right),h.ratio=1,this.layer.renderer.autoRedraw(),o()}.bind(e),100)}))},be.prototype.downloadCadImg=function(t,e){var o=t.toDataURL("jpg",3);o=o.replace(this._fixType("jpg"),"image/octet-stream"),this.saveFile(o,e)},be.prototype.saveFile=function(t,e){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=t,o.download=e;var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},be.prototype._fixType=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]},be.prototype.execute=function(t,e){var o=this;switch(yt.clearFocusItem(),yt.clearSelectItem(),this.layer.$xui.hideProps(),t){case"recall":this.menu_revoke();break;case"recover":this.menu_recovery();break;case"default":this.menu_default();break;case"download":this.layer.div.style.visibility="hidden",this.menu_screenShot(e).then((function(){o.layer.div.style.visibility="visible"}));break;case"texture":this.showTexture=e,this.layer.app.dom.querySelector('.player[name="main"]').style.visibility=this.showTexture?"visible":"hidden";break;case"clear":this.menu_clear();break;case"panos":this.menu_panos(e);break;case"rotate":this.menu_rotate();break;case"flex":this.menu_flex()}},be.prototype.menu_revoke=function(){this.layer.revokeHistory()},be.prototype.menu_recovery=function(){this.layer.recoveryHistory()},be.prototype.menu_default=function(){var t=this;Et.clearHistoryRecord(),b.setAngle(0),this.layer.app.store.getValue("metadata").floorPlanUser=0,this.layer.app.store.getValue("metadata").floorPlanAngle=0,this.menu_flex(!0),this.layer.app.core.get("Player").model.floorplanCadImg.updatePlanes(),this.layer.load.loadFloorJson(!0).then((function(){return t.layer.render()})),this.layer.app.MinMap.reload(),this.layer.app.core.get("Player").labelManager.reset()},be.prototype.menu_screenShot=function(t){return this.layer.stopAddVector(),this.screenShot(t)},be.prototype.menu_clear=function(){b.clear(),this.layer.history.save(),this.layer.renderer.autoRedraw()},be.prototype.menu_panos=function(t){this.layer.renderer.displayPanos=t,this.layer.renderer.autoRedraw()},be.prototype.menu_rotate=function(){h.reSet();var t=b.getAngle();t=parseFloat(t)+Math.PI/2,Math.abs(t-2*Math.PI)<.1&&(t=0),b.setAngle(t);var e=h.getScreenInfoForCAD();e.floorPlanAngle=t,this.layer.app.store.getValue("metadata").floorPlanAngle=t,this.layer.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",e);var o=this.layer.app.core.get("CameraControls").activeControl.camera;h.setRes(o.left,o.right),this.layer.history.save(),h.updateForRotate(),xt.update(),this.layer.renderer.autoRedraw()},be.prototype.menu_flex=function(t){h.reSet(),this.layer.renderer.autoRedraw();var e=h.getScreenInfoForCAD();if(e.floorPlanAngle=b.getAngle(),this.layer.app.core.get("CameraControls").emit("syncCadAnd3D",e),t){var o=this.layer.app.core.get("CameraControls").activeControl.camera;h.setRes(o.left,o.right)}},Object.defineProperties(be.prototype,ke);var we=function(){this.symbol=null};we.prototype.moveFullSymbol=function(t,e,o){var n=b.getSymbol(e),i=b.getWall(o);if(!i)return null;var s=H.getLine(i),r=Y.getVerticalLine(s,t),l=n.len;null==l&&(l=Y.getDistance(n.startPoint,n.endPoint));var a=Y.getIntersectionPoint(r,s),h=rt.getNewPosForSymbol(a,o,e);null!=h&&h.state&&(Y.dotPoints(n.startPoint,n.endPoint,h.position1,h.position2)>0?(Y.clonePoint(n.startPoint,h.position1),Y.clonePoint(n.endPoint,h.position2)):(Y.clonePoint(n.endPoint,h.position1),Y.clonePoint(n.startPoint,h.position2)),n.parent!=o&&rt.changeSymbolForBelong(e,o),n.setOpenSide(t),n.setPoints2d())},we.prototype.moveSymbolPoint=function(t,e,o){var n=rt.moveSymbolSinglePoint(t,e,o);if(null==n)return null;var i=b.getSymbol(e),s={x:(i.startPoint.x+i.endPoint.x)/2,y:(i.startPoint.y+i.endPoint.y)/2};if(Y.getDistance(s,n.position)<x)return null;var r=b.getWall(i.parent),l=b.getPoint(r.start),a=b.getPoint(r.end);if(o==G){var h=rt.getNewForContainSymbols(i.endPoint,n.position,i.parent,e);if(null==h||h.collision)return null;H.isContain(r,n.position)?rt.setPosition(i,n.position,"start"):Y.getDistance(i.startPoint,l)<Y.getDistance(i.startPoint,a)?rt.setPosition(i,l,"start"):rt.setPosition(i,a,"start")}else{var c=rt.getNewForContainSymbols(i.startPoint,n.position,i.parent,e);if(null==c||c.collision)return null;H.isContain(r,n.position)?rt.setPosition(i,n.position,"end"):Y.getDistance(i.endPoint,l)<Y.getDistance(i.endPoint,a)?rt.setPosition(i,l,"end"):rt.setPosition(i,a,"end")}i.setPoints2d()};var We=new we,Fe=function(){};Fe.prototype.moveFullComponent=function(t,e){var o=b.getComponent(e);Y.clonePoint(o.center,t);var n=this.getAdsorbInfo(o);return n||o.setPoints2d(),n},Fe.prototype.getAdsorbInfo=function(t){var e=this.getMidPointsEdge(t),o=this.getNearestPoints(e,t.center),n=this.isAdsorb(o.min0,e[0],t.center);return(null!=n||null!=(n=this.isAdsorb(o.min1,e[1],t.center))||null!=(n=this.isAdsorb(o.min2,e[2],t.center))||null!=(n=this.isAdsorb(o.min3,e[3],t.center)))&&(t.center.x+=n.dx,t.center.y+=n.dy,t.setPoints2d(),!0)},Fe.prototype.getMidPointsEdge=function(t){var e=[];return e.push({x:(t.points2d[0].x+t.points2d[1].x)/2,y:(t.points2d[0].y+t.points2d[1].y)/2}),e.push({x:(t.points2d[1].x+t.points2d[2].x)/2,y:(t.points2d[1].y+t.points2d[2].y)/2}),e.push({x:(t.points2d[2].x+t.points2d[3].x)/2,y:(t.points2d[2].y+t.points2d[3].y)/2}),e.push({x:(t.points2d[3].x+t.points2d[0].x)/2,y:(t.points2d[3].y+t.points2d[0].y)/2}),e},Fe.prototype.getNearestPoints=function(t,e){var o=b.getWalls(),n=Y.createLine1(t[0],t[2]),i=Y.createLine1(t[1],t[3]),s=null,r=null,l=null,a=null;for(var h in o){var c=o[h],d=b.getPoint(c.start),p=b.getPoint(c.end),y=Y.getIntersectionPoint4(d,p,n);null!=y&&(Y.isContainForSegment(t[0],y,e)?(null==s||Y.getDistance(t[0],s.position)>Y.getDistance(t[0],y))&&(s={position:y,wallId:h}):Y.isContainForSegment(t[2],y,e)&&(null==l||Y.getDistance(t[2],l.position)>Y.getDistance(t[2],y))&&(l={position:y,wallId:h}));var u=Y.getIntersectionPoint4(d,p,i);null!=u&&(Y.isContainForSegment(t[1],u,e)?(null==r||Y.getDistance(t[1],r.position)>Y.getDistance(t[1],u))&&(r={position:u,wallId:h}):Y.isContainForSegment(t[3],u,e)&&(null==a||Y.getDistance(t[3],a.position)>Y.getDistance(t[3],u))&&(a={position:u,wallId:h}))}return{min0:s,min1:r,min2:l,min3:a}},Fe.prototype.isAdsorb=function(t,e,o){if(null==t)return null;var n=b.getWall(t.wallId),i=b.getPoint(n.start);b.getPoint(n.end);var s=Y.Angle(t.position,o,i);return Math.abs(s-Math.PI/2)<.1&&Y.getDistance(t.position,e)<p?{dx:t.position.x-e.x,dy:t.position.y-e.y}:null};var Ce=new Fe,Te=function(){};Te.prototype.moveFullTag=function(t,e){var o=b.getTag(e);Y.clonePoint(o.center,t),o.setPoints2d()};var De=new Te,Me=function(){this.startInfo={},this.endInfo={},this.canAdd=!1};Me.prototype.setPointInfo=function(t,e){"start"==t?this.startInfo={position:{x:e.x,y:e.y},linkedPointId:e.linkedPointId,linkedWallId:e.linkedWallId}:"end"==t&&(this.endInfo={position:{x:e.x,y:e.y},linkedPointId:e.linkedPointId,linkedWallId:e.linkedWallId})},Me.prototype.buildWall=function(t){console.log("添加新墙！");var e=this.getJoinsForWalls(),o=this.splitAllJoins(e);this.creatNewWalls(o,t),this.canAdd=!1,this.updateStart(this.endInfo.position,o[o.length-1]),Lt.clear()},Me.prototype.creatNewWalls=function(t,e){for(var o=0;o<t.length-1;++o){var n=t[o],i=t[o+1];if(!H.getWallId(n,i))H.createWall(n,i).setOut(e)}},Me.prototype.canAddWallForEnd=function(t){if(Lt.modifyPoint){if(Y.getDistance(this.startInfo.position,Lt.modifyPoint)<p)return!1}else if(Y.getDistance(this.startInfo.position,t)<p)return!1;if(Lt.symbolInfo.symbolId)return!1;var e=b.getSymbols();for(var o in e){var n=e[o];if(n.geoType!=O)if(null!=Y.getIntersectionPoint3(n.startPoint,n.endPoint,this.startInfo.position,t))return!1}return!0},Me.prototype.getJoinsForWalls=function(){var t=[],e=b.getWalls(),o=[],n=[];this.startInfo.linkedPointId?(o.push(this.startInfo.linkedPointId),n.push(this.startInfo.linkedPointId),t.push({join:{x:this.startInfo.position.x,y:this.startInfo.position.y},pointId:this.startInfo.linkedPointId})):this.startInfo.linkedWallId?t.push({join:{x:this.startInfo.position.x,y:this.startInfo.position.y},wallId:this.startInfo.linkedWallId}):t.push({join:{x:this.startInfo.position.x,y:this.startInfo.position.y}}),this.endInfo.linkedPointId?(o.push(this.endInfo.linkedPointId),n.push(this.endInfo.linkedPointId),t.push({join:{x:this.endInfo.position.x,y:this.endInfo.position.y},pointId:this.endInfo.linkedPointId})):this.endInfo.linkedWallId?t.push({join:{x:this.endInfo.position.x,y:this.endInfo.position.y},wallId:this.endInfo.linkedWallId}):t.push({join:{x:this.endInfo.position.x,y:this.endInfo.position.y}});var i=Y.createLine1(this.startInfo.position,this.endInfo.position);for(var s in e)if(!(this.startInfo.linkedWallId&&this.startInfo.linkedWallId==s||this.endInfo.linkedWallId&&this.endInfo.linkedWallId==s)){var r=e[s];if(!(n.indexOf(r.start)>-1||n.indexOf(r.end)>-1)){var l=b.getPoint(r.start),a=b.getPoint(r.end),h=!1;if(o.indexOf(r.start)<0){o.push(r.start);var c=Y.getJoinLinePoint(l,i);Y.PointInSegment(c,this.startInfo.position,this.endInfo.position,p)&&Y.getDistance(l,c)<p&&(t.push({join:{x:c.x,y:c.y},pointId:r.start}),h=!0,n.push(r.start))}if(o.indexOf(r.end)<0){o.push(r.end);var d=Y.getJoinLinePoint(a,i);Y.PointInSegment(d,this.startInfo.position,this.endInfo.position,p)&&Y.getDistance(a,d)<p&&(t.push({join:{x:d.x,y:d.y},pointId:r.end}),h=!0,n.push(r.end))}if(!h&&n.indexOf(r.start)<0&&n.indexOf(r.end)<0){var y=Y.getIntersectionPoint3(l,a,this.startInfo.position,this.endInfo.position);y&&t.push({join:{x:y.x,y:y.y},wallId:s})}}}return t},Me.prototype.splitAllJoins=function(t){t=t.sort(function(t,e){return Y.getDistance(this.startInfo.position,t.join)-Y.getDistance(this.startInfo.position,e.join)}.bind(this));for(var e=[],o=0;o<t.length;++o){var n=t[o],i=n.join,s=n.wallId,r=n.pointId;if(r)e.push(r);else if(s){var l=H.createPoint(i.x,i.y).vectorId,a=null;if(t[o+1]&&t[o].wallId==t[o+1].wallId){var h=b.getWall(s),c=b.getPoint(h.start);a=Y.getDistance(c,t[o].join)<Y.getDistance(c,t[o+1].join)?H.splitWall(s,l,"end"):H.splitWall(s,l,"start")}else a=H.splitWall(s,l,"start");if(null==a){b.deletePoint(l);continue}rt.reBelongForSplitWall(s,s,a),e.push(l)}else{var d=H.createPoint(i.x,i.y);e.push(d.vectorId)}}return e},Me.prototype.updateStart=function(t,e){Y.clonePoint(this.startInfo.position,t),this.startInfo.linkedPointId=e,At.setNewWallStartPosition(this.startInfo.position)},Me.prototype.clear=function(){this.startInfo={},this.endInfo={},this.canAdd=!1,At.hideNewWall(),At.hideStartAddWall()};var Le=new Me,Oe=function(){this.needUpdateRoom=!1,this.startMoving=!1,this.moveFlag=!1};Oe.prototype.movePoint=function(t,e,o){var n=b.getPoint(t),i=null,s=null;null!=o&&(e={x:o.x,y:o.y},i=o.linkedPointId,s=o.linkedWallId),this.needUpdateRoom=!1;var r=this.canMoveForPoint(t,e,i,s);if(!r)return!1;var l=null;if(null==o){var a=H.getNeighPoints(t);if(1==a.length?l=At.checkAngle(e,a[0].vectorId,t):2==a.length&&((l=At.checkAngle(e,a[0].vectorId,t))||(l=At.checkAngle(e,a[1].vectorId,t))),l){if(!(r=this.canMoveForPoint(t,l,i,s)))return!1;Y.clonePoint(e,l)}n.setPosition(e)}else if(o.hasOwnProperty("linkedPointId")&&null!=o.linkedPointId){if(null!=H.getWallId(t,o.linkedPointId))return!1;n.setPosition(o),this.needUpdateRoom=!0}else if(o.hasOwnProperty("linkedWallId")){var h=b.getWall(o.linkedWallId),c=b.getPoint(h.start),d=b.getPoint(h.end);if(Y.getDistance(c,e)<p||Y.getDistance(d,e)<p)return!1;n.setPosition(o),this.needUpdateRoom=!0}else o.hasOwnProperty("linkedPointIdX")&&o.linkedPointIdX&&n.setPosition(e),o.hasOwnProperty("linkedPointIdY")&&o.linkedPointIdY&&n.setPosition(e);return rt.updateSymbolsPositionsForWallCorner(t),!0},Oe.prototype.moveWallPlane=function(t,e,o){var n=1,i=b.getWall(t),s=i.start,r=i.end,l=b.getPoint(i.start),a=b.getPoint(i.end),h=this.getNewPointsForMoveWall(t,e,o),c=Y.createLine1(h.point1,h.point2),d=this.getTwoLimitInfos(t,c);this.needUpdateRoom=!1;var y=Y.getIntersectionPoint(c,d.startLimitLine),u=Y.getIntersectionPoint(c,d.endLimitLine);if(!this.startMoving&&(Y.getDistance(l,y)<p||Y.getDistance(a,u)<p))return this.moveFlag=!1,n=2;this.startMoving=!0;var g=this.updateVirtualPosition(i.start,y,d.startWallId,d.newStartWallId),x=this.updateVirtualPosition(i.end,u,d.endWallId,d.newEndWallId);if(null==g||null==x)return this.moveFlag=!1,n=2,this.startMoving=!1,n;var f=!1,m=null;if(g.adsorb&&!x.adsorb){if(c=Y.createLine3(c,g.virtualPosition),!this.isOKForTwoSegmentsAngle(g.adsorbPointId,i.start,i.end))return this.moveFlag=!1,n=5;u=Y.getIntersectionPoint(c,d.endLimitLine),null==(x=this.updateVirtualPosition(i.end,u,d.endWallId,d.newEndWallId))&&(x={adsorb:!1,adsorbPointId:null,virtualPosition:u}),f=this.isCoincideForAdsorbOne(i.start,g.adsorbPointId,t),m=Y.getDistance(g.virtualPosition,u),n=4,this.needUpdateRoom=!0,this.startMoving=!1}else if(!g.adsorb&&x.adsorb){if(c=Y.createLine3(c,x.virtualPosition),!this.isOKForTwoSegmentsAngle(x.adsorbPointId,i.end,i.start))return this.moveFlag=!1,n=5;y=Y.getIntersectionPoint(c,d.startLimitLine),null==(g=this.updateVirtualPosition(i.start,y,d.startWallId,d.newStartWallId))&&(g={adsorb:!1,adsorbPointId:null,virtualPosition:y}),f=this.isCoincideForAdsorbOne(i.end,x.adsorbPointId,t),m=Y.getDistance(x.virtualPosition,y),n=4,this.needUpdateRoom=!0,this.startMoving=!1}if(g&&x&&g.adsorb&&x.adsorb){if(f=this.isCoincideForAdsorbOne2(t,g.adsorbPointId,x.adsorbPointId),m=Y.getDistance(g.virtualPosition,x.virtualPosition),this.startMoving=!1,f)return this.moveFlag=!1,n=5;n=4,this.needUpdateRoom=!0}else if((m=Y.getDistance(y,u))<p)return this.deleteWallForLinked(t),l=b.getPoint(s),a=b.getPoint(r),l&&a?(Object.keys(l.parent).length>1&&1==Object.keys(a.parent).length||1==Object.keys(l.parent).length&&1==Object.keys(a.parent).length?H.moveTo(r,s):1==Object.keys(l.parent).length&&Object.keys(a.parent).length>1&&H.moveTo(s,r),this.moveFlag=!1,n=3,this.needUpdateRoom=!0,n):(this.moveFlag=!1,n=3,this.needUpdateRoom=!0,n);if(s=i.start,r=i.end,!this.isOKForCrossForMoveWall(y,u,t,s,r,g.adsorbPointId,x.adsorbPointId))return n=2,this.moveFlag=!1,this.startMoving=!1,n;if(f||null!=m&&m<p)return this.deleteWallForLinked(t),n=3,H.mergeWallForPoint(s),H.mergeWallForPoint(r),this.moveFlag=!1,this.needUpdateRoom=!0,n;var v=Y.getIntersectionPoint3(l,y,a,u);if(null!=v)return l.setPosition(v),a.setPosition(v),H.moveTo(s,r),n=3,this.moveFlag=!1,this.needUpdateRoom=!0,n;var P=!1;if(!d.newStartWallId&&g.adsorbPointId?P=H.isOverlapForMergePoint(s,g.adsorbPointId):!d.newEndWallId&&x.adsorbPointId&&(P=H.isOverlapForMergePoint(r,x.adsorbPointId)),P)return this.moveFlag=!1,n=5;if(this.updatePointForMoveWall(t,s,g,d.startWallId,d.newStartWallId),this.updatePointForMoveWall(t,r,x,d.endWallId,d.newEndWallId),null==(i=b.getWall(t)))return n=3,this.moveFlag=!1,this.needUpdateRoom=!0,n;for(var I in rt.updateSymbolsPositionsForWall(t),l=b.getPoint(i.start),a=b.getPoint(i.end),l.parent)rt.updateSymbolsPositionsForNeighWall(I);for(var S in a.parent)rt.updateSymbolsPositionsForNeighWall(S);return this.moveFlag=1==n,n},Oe.prototype.getNewPointsForMoveWall=function(t,e,o){e/=h.res,o=-o/h.res;var n=b.getWall(t),i=b.getPoint(n.start),s=b.getPoint(n.end);return{point1:{x:i.x+e,y:i.y+o},point2:{x:s.x+e,y:s.y+o}}},Oe.prototype.getTwoLimitInfos=function(t,e){var o,n,i,s=b.getWall(t),r=b.getPoint(s.start),l=b.getPoint(s.end),a=Y.createLine1(r,l),h={newStartWallId:!1,newEndWallId:!1};if(1==Object.keys(r.parent).length)o=Y.getVerticalLine(a,r),h.startWallId=null;else if(2==Object.keys(r.parent).length){var c;Object.keys(r.parent)[0]==t?c=b.getWall(Object.keys(r.parent)[1]):Object.keys(r.parent)[1]==t&&(c=b.getWall(Object.keys(r.parent)[0])),c||console.error(352);var d=H.AngleForWall(c.vectorId,t);o=H.getLine(c),h.startWallId=c.vectorId,d>u/180*Math.PI&&(o=Y.getVerticalLine(a,r),h.startWallId=null,h.newStartWallId=!0)}else{var p,y;i=H.wallIdForMinAngle(s.start,t);var g=b.getWall(i.min0.wallId),x=b.getPoint(g.start),f=b.getPoint(g.end),m=b.getWall(i.min1.wallId),v=b.getPoint(m.start),P=b.getPoint(m.end),I=Y.getIntersectionPoint4(x,f,e),S=Y.getIntersectionPoint4(v,P,e);if(null==I&&null==S){var k=H.AngleForWall(t,i.min0.wallId),w=H.AngleForWall(t,i.min1.wallId);k>Math.PI&&(k=Math.PI-k),w>Math.PI&&(w=Math.PI-w),y=k<w?i.min0.wallId:i.min1.wallId,h.newStartWallId=!0}else null!=I&&null!=S?y=i.min0.angle<i.min1.angle?i.min0.wallId:i.min1.wallId:null==I&&null!=S?y=i.min1.wallId:null!=I&&null==S&&(y=i.min0.wallId);h.startWallId=y,p=b.getWall(y);var W=H.AngleForWall(y,t);o=H.getLine(p),W>u/180*Math.PI&&(o=Y.getVerticalLine(a,r),h.startWallId=null,h.newStartWallId=!0)}if(1==Object.keys(l.parent).length)n=Y.getVerticalLine(a,l),h.endWallId=null;else if(2==Object.keys(l.parent).length){var F;Object.keys(l.parent)[0]==t?F=b.getWall(Object.keys(l.parent)[1]):Object.keys(l.parent)[1]==t&&(F=b.getWall(Object.keys(l.parent)[0]));var C=H.AngleForWall(F.vectorId,t);n=H.getLine(F),h.endWallId=F.vectorId,C>u/180*Math.PI&&(n=Y.getVerticalLine(a,l),h.endWallId=null,h.newEndWallId=!0)}else{var T,D;i=H.wallIdForMinAngle(s.end,t);var M=b.getWall(i.min0.wallId),L=b.getPoint(M.start),O=b.getPoint(M.end),A=b.getWall(i.min1.wallId),R=b.getPoint(A.start),E=b.getPoint(A.end),_=Y.getIntersectionPoint4(L,O,e),N=Y.getIntersectionPoint4(R,E,e);if(null==_&&null==N){var B=H.AngleForWall(t,i.min0.wallId),j=H.AngleForWall(t,i.min1.wallId);B>Math.PI&&(B=Math.PI-B),j>Math.PI&&(j=Math.PI-j),D=B<j?i.min0.wallId:i.min1.wallId,h.newEndWallId=!0}else null!=_&&null!=N?D=i.min0.angle<i.min1.angle?i.min0.wallId:i.min1.wallId:null==_&&null!=N?D=i.min1.wallId:null!=_&&null==N&&(D=i.min0.wallId);h.endWallId=D,T=b.getWall(D);var X=H.AngleForWall(D,t);n=H.getLine(T),X>u/180*Math.PI&&(n=Y.getVerticalLine(a,l),h.endWallId=null,h.newEndWallId=!0)}return h.startLimitLine=o,h.endLimitLine=n,h},Oe.prototype.canMoveForPoint=function(t,e,o,n){var i=b.getPoint(t),s=this.isOKForMinAngleWall(t,e);return s&&(s=this.isOKForCross(t,e,i.parent,o,n)),s},Oe.prototype.isOKForMinAngleWall=function(t,e){var o=b.getPoint(t).parent,n=this.getMinAngle(t,e);if(Math.abs(n)<y/180*Math.PI)return!1;for(var i in o){var s=b.getWall(i).getOtherPointId(t),r=this.getNeighMinAngle(s,i,e);if(r&&Math.abs(r.angle)<y/180*Math.PI)return!1;var l=b.getPoint(s);if(Y.getDistance(e,l)<p)return!1}return!0},Oe.prototype.getMinAngle=function(t,e){var o=b.getPoint(t).parent;if(1==Object.keys(o).length)return 2*Math.PI;if(2==Object.keys(o).length){var n=b.getWall(Object.keys(o)[0]),i=b.getWall(Object.keys(o)[1]),s=n.getOtherPointId(t),r=b.getPoint(s),l=i.getOtherPointId(t),a=b.getPoint(l);return Y.Angle(e,r,a)}var h={x:e.x+1,y:e.y},c=[];for(var d in o){var p=b.getWall(d).getOtherPointId(t),y=b.getPoint(p);if(Y.equalPoint(h,y))c.push(0);else{var u=Y.Angle(e,h,y);y.y<e.y&&(u=2*Math.PI-u),c.push(u)}}c=c.sort((function(t,e){return t-e}));for(var g=2*Math.PI,x=0;x<c.length-1;++x)for(var f=x+1;f<c.length;++f){var m=c[f]-c[x];m<g&&(g=m)}var v=c[0],P=c[c.length-1];if(v<Math.PI&&P>Math.PI){var I=2*Math.PI+v-P;I<g&&(g=I)}return g},Oe.prototype.getNeighMinAngle=function(t,e,o){var n=b.getPoint(t),i={x:o.x,y:o.y},s=null,r=null,l=null,a=null;for(var h in n.parent)if(h!=e){s=b.getWall(h).getOtherPointId(t),r=b.getPoint(s);var c=Y.Angle(n,i,r);(null==l||l>c)&&(a={angle:l=c,pointId:s})}return a},Oe.prototype.isOKForCross=function(t,e,o,n,i){var s=b.getWalls();for(var r in s)if(!o.hasOwnProperty(r))for(var l in o)if(!H.isWallLink(r,l)){var a=b.getWall(l).getOtherPointId(t),h=b.getPoint(a);if(!this.isOKForCrossTwoWall(e,h,r,n,i))return!1}return!0},Oe.prototype.isOKForCrossTwoWall=function(t,e,o,n,i){var s=b.getWall(o),r=b.getPoint(s.start),l=b.getPoint(s.end);if(Y.getIntersectionPoint3(t,e,r,l)&&s.start!=n&&s.end!=n)return!1;if(Y.equalPoint(t,e))return!0;var a=Y.createLine1(t,e),h=Y.getJoinLinePoint(r,a),c=Y.getJoinLinePoint(l,a);if(Y.getDistance(h,r)<p&&Y.PointInSegment(h,t,e)){if(s.start!=n)return!1}else if(Y.getDistance(c,l)<p&&Y.PointInSegment(c,t,e)&&s.end!=n)return!1;if(a=Y.createLine1(r,l),h=Y.getJoinLinePoint(t,a),c=Y.getJoinLinePoint(e,a),Y.getDistance(h,t)<p&&Y.PointInSegment(h,r,l)){if(s.start!=n&&s.end!=n&&o!=i)return!1}else if(Y.getDistance(c,e)<p&&Y.PointInSegment(c,r,l)&&s.start!=n&&s.end!=n&&o!=i)return!1;return!0},Oe.prototype.isOKForCrossTwoWall2=function(t,e,o){var n=b.getWall(o),i=b.getPoint(n.start),s=b.getPoint(n.end),r=Y.crossTwoLines(t,e,i,s,.01);return!r&&(!!Y.equalPoint(t,e)||!!(r=this.isCoincide(t,e,o)))},Oe.prototype.isOKForCrossTwoWall3=function(t,e,o){var n=b.getWall(o),i=b.getPoint(n.start),s=b.getPoint(n.end);if(Y.crossTwoLines(t,e,i,s,.01))return!1;if(Y.equalPoint(t,e))return!0;var r=Y.createLine1(t,e),l=Y.getJoinLinePoint(i,r),a=Y.getJoinLinePoint(s,r);return!(Y.getDistance(l,i)<p&&Y.PointInSegment(l,t,e))&&(!(Y.getDistance(a,s)<p&&Y.PointInSegment(a,t,e))&&(r=Y.createLine1(i,s),l=Y.getJoinLinePoint(t,r),!(Y.getDistance(l,t)<p&&H.isContain(n,l))))},Oe.prototype.isCoincide=function(t,e,o){var n=b.getWall(o),i=b.getPoint(n.start),s=b.getPoint(n.end),r=Y.createLine1(t,e),l=Y.getJoinLinePoint(i,r),a=Y.getJoinLinePoint(s,r);return!(Y.getDistance(l,i)<p&&Y.PointInSegment(l,t,e))&&(!(Y.getDistance(a,s)<p&&Y.PointInSegment(a,t,e))&&(r=Y.createLine1(i,s),l=Y.getJoinLinePoint(t,r),a=Y.getJoinLinePoint(e,r),!(Y.getDistance(l,t)<p&&H.isContain(n,l))&&!(Y.getDistance(a,e)<p&&H.isContain(n,a))))},Oe.prototype.updateVirtualPosition=function(t,e,o,n){var i,s,r=b.getWall(o),l=b.getPoint(t),a=!1;if(n){if(Y.getDistance(l,e)<p)return null}else null!=r&&(i=r.getOtherPointId(t),s=b.getPoint(i),(Y.getDistance(e,s)<p||!H.isContain(r,e)&&Y.getDistance(e,s)<Y.getDistance(e,l))&&(Y.clonePoint(e,s),a=!0));return{adsorb:a,adsorbPointId:a?i:null,virtualPosition:e}},Oe.prototype.isOKForTwoSegmentsAngle=function(t,e,o){var n=b.getPoint(t),i=b.getPoint(e),s=b.getPoint(o),r=n.x-i.x,l=n.y-i.y,a={x:r+s.x,y:l+s.y};for(var h in n.parent){var c=b.getWall(h).getOtherPointId(t),d=b.getPoint(c),p=Y.Angle(n,d,a);if(Math.abs(p)<y/180*Math.PI)return!1}return!0},Oe.prototype.isCoincideForAdsorbOne=function(t,e,o){if(t&&e){var n=b.getWall(o).getOtherPointId(t);if(null!=H.getWallId(n,e))return!0}return!1},Oe.prototype.isCoincideForAdsorbOne2=function(t,e,o){if(e&&o){if(null!=H.getWallId(e,o))return!0;var n=b.getPoint(e),i=n.parent;for(var s in i){var r=H.AngleForWall3(t,s);if(Math.abs(r)<y/180*Math.PI)return!0}for(var l in i=(n=b.getPoint(o)).parent){var a=H.AngleForWall3(t,l);if(Math.abs(a)<y/180*Math.PI)return!0}}return!1},Oe.prototype.isOKForCrossForMoveWall=function(t,e,o,n,i,s,r){var l=b.getPoint(n),a=b.getPoint(i),h=!0,c=b.getWalls();for(var d in c)if(d!=o){var p=!0,y=!0,u=b.getWall(d);if(!s||s!=u.start&&s!=u.end||(p=!1),!r||r!=u.start&&r!=u.end||(y=!1),u.start!=n&&u.end!=n||(p=!1),u.start!=i&&u.end!=i||(y=!1),p&&y&&(h=this.isOKForCrossTwoWall2(t,e,d)),!h)return!1;if(p&&u.start!=n&&u.end!=n&&(h=this.isOKForCrossTwoWall3(t,l,d)),!h)return!1;if(y&&u.start!=i&&u.end!=i&&(h=this.isOKForCrossTwoWall3(e,a,d)),!h)return!1}return h},Oe.prototype.updatePointForMoveWall=function(t,e,o,n,i){var s=b.getPoint(e),r=b.getWall(t);if(null==n)i?(this.createWallForMoveWall(e,t,o.virtualPosition),this.needUpdateRoom=!0):s.setPosition(o.virtualPosition);else if(i)this.createWallForMoveWall(e,t,o.virtualPosition),this.needUpdateRoom=!0;else if(o.adsorb)H.moveTo(e,o.adsorbPointId),this.needUpdateRoom=!0;else if(2==Object.keys(s.parent).length)s.setPosition(o.virtualPosition);else{var l=H.wallIdForMinAngle(e,t),a=H.AngleForWall(l.min0.wallId,l.min1.wallId);if(3==Object.keys(s.parent).length&&a>u/180*Math.PI)s.setPosition(o.virtualPosition);else{var h=H.getDirction(e,t);H.subtraWallFromIntersect(e,t);var c=r.getPointId(h);b.getPoint(c).setPosition(o.virtualPosition),H.splitWall(n,c,h),this.needUpdateRoom=!0}}},Oe.prototype.createWallForMoveWall=function(t,e,o){var n=b.getWall(e),i=H.getDirction(t,e);H.subtraWallFromIntersect(t,e);var s=n.getPointId(i);b.getPoint(s).setPosition(o),H.createWall(t,s)},Oe.prototype.deleteWallForLinked=function(t){var e=b.getWall(t);H.subtraWallFromIntersect(e.start,t),H.subtraWallFromIntersect(e.end,t),b.deleteWall(t)};var Ae=new Oe,Re={strokeStyle:"#FFFFFF",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#FFFFFF",lineWidth:6},error:{strokeStyle:"rgba(255,0,0,0.5)",fillStyle:"rgba(255,0,0,0.8)"}},Ee={strokeStyle:"green",fillStyle:"rgb(0, 200, 175)",radius:4},_e={strokeStyle:"rgba(255,255,255,1)",fillStyle:"rgba(255,255,255,0)",lineWidth:2,Pass:{}},Ne={strokeStyle:"rgba(255,255,255,1)",fillStyle:"rgba(255,255,255,0)",lineWidth:1},Be={strokeStyle:"rgb(255,255,255,1)",fillStyle:"rgb(255,255,255,1)",strokeStyle_adding:"rgba(243, 255, 0, 0.8)",fillStyle_adding:"rgba(243, 255, 0, 0.8)",lineWidth:1},Ye={Wall:{strokeStyle:"rgba(243, 255, 0, 0.8)"},Wall_out:{strokeStyle:"rgba(243, 255, 0, 0.8)"},Symbol:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)",lineWidth:2},Component:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)"},Tag:{strokeStyle:"#00C8AF",fillStyle:"#00C8AF"},Point:{radius:4,lineWidth:2,fillStyle:"rgba(245, 255, 0, 0.7)",strokeStyle:"rgba(245, 255, 255, 0.3)"}},je={Wall:{strokeStyle:"rgba(243, 255, 0, 0.8)"},Wall_out:{strokeStyle:"rgba(162, 164, 124, 0.8)"},Symbol:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)"},Component:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)"},Tag:{strokeStyle:"#00C8AF",fillStyle:"#00C8AF"},Point:{radius:4,lineWidth:2,fillStyle:"rgba(245, 255, 0, 0.7)",strokeStyle:"rgba(245, 255, 255, 0.3)"}},Xe={StartAddWall:{radius:4,fillStyle:"yellow",strokeStyle:"green"},NewWall:{lineWidth:4,lineWidth_out:6,strokeStyle:"rgba(255,255,255,0.3)",strokeStyle_out:"rgba(102,102,102,0.3)",errorStrokeStyle:"rgb(250,63,72,0.3)"},StartSymbolPoints:{radius:4,fillStyle:"yellow",strokeStyle:"green"},EndSymbolPoints:{radius:4,fillStyle:"yellow",strokeStyle:"green"},CheckLinesX:{lineWidth:2,strokeStyle:"#CED806"},CheckLinesY:{lineWidth:2,strokeStyle:"#CED806"},VCheckLinesX:{lineWidth:2,strokeStyle:"#CED806"},VCheckLinesY:{lineWidth:2,strokeStyle:"#CED806"}},Je={font:"12px Microsoft YaHei",fillStyle:"#FFFFFF",strokeStyle:"#FFFFFF",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Ue={radius:10,lineWidth:2,strokeStyle:"rgba(255,255,255,0.4)",fillStyle:"rgba(255,255,255,0.1)"},Ve={txt:"rgba(255,255,255,1)",strokeStyle:"rgba(255,255,255,1)",lineWidth:1},$e={style1:{Wall:{strokeStyle:"#666666",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#666666",lineWidth:6}},Symbol:{strokeStyle:"#666666",lineWidth:1},Component:{strokeStyle:"#666666",fillStyle:"#666666",lineWidth:1},Tag:{strokeStyle:"#000000",fillStyle:"#000000",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#000000",strokeStyle:"#000000",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#CCCCCC",lineWidth:1}},style2:{Wall:{strokeStyle:"#FFFFFF",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#FFFFFF",lineWidth:6}},Symbol:{strokeStyle:"#FFFFFF",lineWidth:1},Component:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Tag:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#FFFFFF",strokeStyle:"#FFFFFF",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#FFFFFF",lineWidth:1}},style3:{Wall:{strokeStyle:"#666666",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#666666",lineWidth:6}},Symbol:{strokeStyle:"#666666",lineWidth:1},Component:{strokeStyle:"#666666",fillStyle:"#666666",lineWidth:1},Tag:{strokeStyle:"#000000",fillStyle:"#000000",strokeStyle_adding:"rgba(243, 255, 0, 0.8)",fillStyle_adding:"rgba(243, 255, 0, 0.8)",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#000000",strokeStyle:"#000000",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#CCCCCC",lineWidth:2}},style4:{Wall:{strokeStyle:"#FFFFFF",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#FFFFFF",lineWidth:6}},Symbol:{strokeStyle:"#FFFFFF",lineWidth:1},Component:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Tag:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#FFFFFF",strokeStyle:"#FFFFFF",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#FFFFFF",lineWidth:1}}},He=function(){this.whiteImg=null,this.blackImg=null};He.prototype.setWhiteImg=function(t){this.whiteImg=t},He.prototype.setBlackImg=function(t){this.blackImg=t},He.prototype.getWhiteImg=function(){return this.whiteImg},He.prototype.getBlackImg=function(){return this.blackImg};var ze=new He,Ge=function(){this.context=null};Ge.prototype.initContext=function(t){this.context=t?t.getContext("2d"):null},Ge.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},Ge.prototype.drawBackGround=function(t){this.context.save(),this.context.fillStyle=t,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore()},Ge.prototype.drawWall=function(t,e){var o=b.getPoint(t.start),n=b.getPoint(t.end),i=[];i.push(o);for(var s=0;s<t.children.length;++s){var r=b.getSymbol(t.children[s]);i.push(r.startPoint),i.push(r.endPoint)}i.push(n),i=i.sort(function(t,e){return Y.getDistance(o,t)-Y.getDistance(o,e)}.bind(this)),this.context.save(),this.context.beginPath(),this.context.lineCap="round",this.context.strokeStyle=Re.strokeStyle,t.out||t.important?(this.context.lineWidth=Re.important.lineWidth*h.ratio,this.context.strokeStyle=Re.important.strokeStyle):(this.context.lineWidth=Re.lineWidth*h.ratio,this.context.strokeStyle=Re.strokeStyle);var l=yt.getSelectItem(),a=yt.getDraggingItem(),c=yt.getFocusItem();e?"style-1"==e?t.out||t.important?(this.context.lineWidth=$e.style1.Wall.important.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Wall.important.strokeStyle):(this.context.lineWidth=$e.style1.Wall.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Wall.strokeStyle):"style-2"==e?t.out||t.important?(this.context.lineWidth=$e.style2.Wall.important.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Wall.important.strokeStyle):(this.context.lineWidth=$e.style2.Wall.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Wall.strokeStyle):"style-3"==e?t.out||t.important?(this.context.lineWidth=$e.style3.Wall.important.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Wall.important.strokeStyle):(this.context.lineWidth=$e.style3.Wall.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Wall.strokeStyle):"style-4"==e&&(t.out||t.important?(this.context.lineWidth=$e.style4.Wall.important.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Wall.important.strokeStyle):(this.context.lineWidth=$e.style4.Wall.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Wall.strokeStyle)):(l&&l.type==W?t.vectorId==l.vectorId&&(t.out||t.important?this.context.strokeStyle=Ye.Wall_out.strokeStyle:this.context.strokeStyle=Ye.Wall.strokeStyle):a&&a.type==W&&t.vectorId==a.vectorId&&(t.out||t.important?this.context.strokeStyle=Ye.Wall_out.strokeStyle:this.context.strokeStyle=Ye.Wall.strokeStyle),c&&c.type==W&&t.vectorId==c.vectorId&&(this.context.strokeStyle=je.Wall.strokeStyle));for(var d=0;d<i.length-1;d+=2){var p=h.getScreenXY(i[d]),y=h.getScreenXY(i[d+1]);this.context.moveTo(p.x,p.y),this.context.lineTo(y.x,y.y)}this.context.stroke(),this.context.restore(),(l&&l.type==W&&t.vectorId==l.vectorId||a&&a.type==W&&t.vectorId==a.vectorId||c&&c.type==W&&t.vectorId==c.vectorId)&&this.drawMeasureTxt(o,n)},Ge.prototype.drawSpecialPoint=function(){var t=yt.getSelectItem(),e=yt.getDraggingItem(),o=yt.getFocusItem(),n=null;if(this.context.save(),t&&(n=b.getPoint(t.vectorId),this.context.lineWidth=Ye.Point.lineWidth*h.ratio,this.context.strokeStyle=Ye.Point.strokeStyle,this.context.fillStyle=Ye.Point.fillStyle),e&&(n=b.getPoint(e.vectorId),this.context.lineWidth=Ye.Point.lineWidth*h.ratio,this.context.strokeStyle=Ye.Point.strokeStyle,this.context.fillStyle=Ye.Point.fillStyle),o&&(n=b.getPoint(o.vectorId),this.context.lineWidth=je.Point.lineWidth*h.ratio,this.context.strokeStyle=je.Point.strokeStyle,this.context.fillStyle=je.Point.fillStyle),null!=n){var i=h.getScreenXY({x:n.x,y:n.y}),s=Ee.radius;this.context.beginPath(),this.context.arc(i.x,i.y,s*h.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()}else this.context.restore()},Ge.prototype.drawPoint=function(t){var e=h.getScreenXY({x:t.x,y:t.y}),o=yt.getSelectItem(),n=yt.getDraggingItem(),i=yt.getFocusItem();this.context.save(),this.context.lineWidth=Ee.lineWidth*h.ratio,this.context.strokeStyle=Ee.strokeStyle,this.context.fillStyle=Ee.fillStyle;var s=Ee.radius;n&&n.type==w&&t.vectorId==n.vectorId||o&&o.type==w&&t.vectorId==o.vectorId?(this.context.lineWidth=Ye.Point.lineWidth*h.ratio,this.context.strokeStyle=Ye.Point.strokeStyle,this.context.fillStyle=Ye.Point.fillStyle,s=Ye.Point.radius):i&&i.type==w&&t.vectorId==i.vectorId&&(this.context.lineWidth=je.Point.lineWidth*h.ratio,this.context.strokeStyle=je.Point.strokeStyle,this.context.fillStyle=je.Point.fillStyle,s=je.Point.radius),this.context.beginPath(),this.context.arc(e.x,e.y,s*h.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ge.prototype.drawSelectSymbolPoint=function(){var t=yt.getSelectItem(),e=yt.getDraggingItem(),o=yt.getFocusItem(),n=null,i=null,s=null;this.context.save(),t&&t.selectIndex&&t.selectIndex!=z&&rt.isSymbol(t.type)?(n=b.getSymbol(t.vectorId),t.selectIndex==G?i=h.getScreenXY({x:n.startPoint.x,y:n.startPoint.y}):t.selectIndex==K&&(i=h.getScreenXY({x:n.endPoint.x,y:n.endPoint.y})),this.context.lineWidth=Ye.Point.lineWidth*h.ratio,this.context.strokeStyle=Ye.Point.strokeStyle,this.context.fillStyle=Ye.Point.fillStyle,s=Ye.Point.radius):e&&e.selectIndex&&e.selectIndex!=z&&rt.isSymbol(e.type)&&(n=b.getSymbol(e.vectorId),e.selectIndex==G?i=h.getScreenXY({x:n.startPoint.x,y:n.startPoint.y}):e.selectIndex==K&&(i=h.getScreenXY({x:n.endPoint.x,y:n.endPoint.y})),this.context.lineWidth=Ye.Point.lineWidth*h.ratio,this.context.strokeStyle=Ye.Point.strokeStyle,this.context.fillStyle=Ye.Point.fillStyle,s=Ye.Point.radius),o&&o.selectIndex&&o.selectIndex!=z&&rt.isSymbol(o.type)&&(n=b.getSymbol(o.vectorId),o.selectIndex==G?i=h.getScreenXY({x:n.startPoint.x,y:n.startPoint.y}):o.selectIndex==K&&(i=h.getScreenXY({x:n.endPoint.x,y:n.endPoint.y})),this.context.lineWidth=je.Point.lineWidth*h.ratio,this.context.strokeStyle=je.Point.strokeStyle,this.context.fillStyle=je.Point.fillStyle,s=je.Point.radius),null!=i&&null!=s&&(this.context.beginPath(),this.context.arc(i.x,i.y,s*h.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill()),this.context.restore()},Ge.prototype.drawSymbolPoint=function(t){var e=h.getScreenXY({x:t.startPoint.x,y:t.startPoint.y}),o=h.getScreenXY({x:t.endPoint.x,y:t.endPoint.y}),n=Ee.radius;this.context.save(),this.context.lineWidth=Ee.lineWidth*h.ratio,this.context.strokeStyle=Ee.strokeStyle,this.context.fillStyle=Ee.fillStyle,this.context.beginPath(),this.context.arc(e.x,e.y,n*h.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.beginPath(),this.context.arc(o.x,o.y,n*h.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ge.prototype.drawText=function(t,e,o,n){this.context.save(),this.setCanvasStyle(Je),h.ratio==f?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei";var i={x:t.x,y:t.y};o||(i=h.getScreenXY({x:t.x,y:t.y})),n?(this.context.translate(i.x,i.y),this.context.rotate(n),this.context.fillText(e,0,0)):this.context.fillText(e,i.x,i.y),this.context.restore()},Ge.prototype.drawSingleDoor=function(t,e,o){for(var n=t.points2d,i=[],s=0;s<n.length;++s)i[s]=h.getScreenXY({x:n[s].x,y:n[s].y});var r=Y.getDistance(i[0],i[1]);this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.lineCap="square",this.context.strokeStyle=_e.strokeStyle;var l=!1;if(e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var a=yt.getSelectItem(),c=yt.getDraggingItem(),d=yt.getFocusItem();a&&a.type==F&&a.selectIndex==z?t.vectorId==a.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle,this.context.fillStyle=Ye.Symbol.fillStyle,l=!0):c&&c.type==F&&c.selectIndex==z&&t.vectorId==c.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle,this.context.fillStyle=Ye.Symbol.fillStyle,l=!0),d&&d.type==F&&t.vectorId==d.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle,this.context.fillStyle=je.Symbol.fillStyle,l=!0)}this.context.beginPath(),this.context.moveTo(i[0].x,i[0].y),this.context.lineTo(i[1].x,i[1].y),this.context.arcTo(i[2].x,i[2].y,i[3].x,i[3].y,r),this.context.closePath(),this.context.stroke(),l&&this.context.fill(),this.context.restore(),o||null==t.enter||this.drawEntranceDoor(t)},Ge.prototype.drawDoubleDoor=function(t,e,o){for(var n=t.points2d,i=[],s=0;s<n.length;++s)i[s]=h.getScreenXY({x:n[s].x,y:n[s].y});var r=Y.getDistance(i[0],i[1]);this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.lineCap="square",this.context.strokeStyle=_e.strokeStyle;var l=!1;if(e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var a=yt.getSelectItem(),c=yt.getDraggingItem(),d=yt.getFocusItem();a&&a.type==C&&a.selectIndex==z?t.vectorId==a.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle,this.context.fillStyle=Ye.Symbol.fillStyle,l=!0):c&&c.type==C&&c.selectIndex==z&&t.vectorId==c.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle,this.context.fillStyle=Ye.Symbol.fillStyle,l=!0),d&&d.type==C&&t.vectorId==d.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle,this.context.fillStyle=je.Symbol.fillStyle,l=!0)}this.context.beginPath(),this.context.moveTo(i[0].x,i[0].y),this.context.lineTo(i[1].x,i[1].y),this.context.arcTo(i[4].x,i[4].y,i[5].x,i[5].y,r),this.context.closePath(),this.context.stroke(),l&&this.context.fill(),this.context.beginPath(),this.context.moveTo(i[2].x,i[2].y),this.context.lineTo(i[1].x,i[1].y),this.context.arcTo(i[4].x,i[4].y,i[3].x,i[3].y,r),this.context.closePath(),this.context.stroke(),l&&this.context.fill(),this.context.restore(),o||null==t.enter||this.drawEntranceDoor(t)},Ge.prototype.drawSlideDoor=function(t,e,o){for(var n=t.points2d,i=[],s=0;s<n.length;++s)i[s]=h.getScreenXY({x:n[s].x,y:n[s].y});if(this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.strokeStyle=_e.strokeStyle,e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var r=yt.getSelectItem(),l=yt.getDraggingItem(),a=yt.getFocusItem();r&&r.type==T&&r.selectIndex==z?t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle):l&&l.type==T&&l.selectIndex==z&&t.vectorId==l.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle),a&&a.type==T&&t.vectorId==a.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(i[0].x,i[0].y),this.context.lineTo(i[1].x,i[1].y),this.context.lineTo(i[2].x,i[2].y),this.context.lineTo(i[3].x,i[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(i[4].x,i[4].y),this.context.lineTo(i[5].x,i[5].y),this.context.lineTo(i[6].x,i[6].y),this.context.lineTo(i[7].x,i[7].y),this.context.closePath(),this.context.stroke(),this.context.restore(),o||null==t.enter||this.drawEntranceDoor(t)},Ge.prototype.drawSingleWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.strokeStyle=_e.strokeStyle,e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var s=yt.getSelectItem(),r=yt.getDraggingItem(),l=yt.getFocusItem();s&&s.type==D&&s.selectIndex==z?t.vectorId==s.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle):r&&r.type==D&&r.selectIndex==z&&t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle),l&&l.type==D&&t.vectorId==l.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.lineTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.closePath(),this.context.stroke(),this.context.restore()},Ge.prototype.drawBayWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.strokeStyle=_e.strokeStyle;var s=!1;if(e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var r=yt.getSelectItem(),l=yt.getDraggingItem(),a=yt.getFocusItem();r&&r.type==M&&r.selectIndex==z?t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle,this.context.fillStyle=Ye.Symbol.fillStyle,s=!0):l&&l.type==M&&l.selectIndex==z&&t.vectorId==l.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle,this.context.fillStyle=Ye.Symbol.fillStyle,s=!0),a&&a.type==M&&t.vectorId==a.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle,this.context.fillStyle=je.Symbol.fillStyle,s=!0)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),s&&this.context.fill(),this.context.beginPath(),this.context.moveTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.lineTo(n[4].x,n[4].y),this.context.stroke(),this.context.restore()},Ge.prototype.drawFrenchWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.strokeStyle=_e.strokeStyle,e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var s=yt.getSelectItem(),r=yt.getDraggingItem(),l=yt.getFocusItem();s&&s.type==L&&s.selectIndex==z?t.vectorId==s.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle):r&&r.type==L&&r.selectIndex==z&&t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle),l&&l.type==L&&t.vectorId==l.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[4].x,n[4].y),this.context.moveTo(n[3].x,n[3].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.stroke(),this.context.restore()},Ge.prototype.drawPass=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=_e.lineWidth*h.ratio,this.context.strokeStyle=_e.strokeStyle,e)"style-1"==e?(this.context.lineWidth=$e.style1.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Symbol.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Symbol.strokeStyle);else{var s=yt.getSelectItem(),r=yt.getDraggingItem(),l=yt.getFocusItem();s&&s.type==O&&s.selectIndex==z?t.vectorId==s.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle):r&&r.type==O&&r.selectIndex==z&&t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Symbol.strokeStyle),l&&l.type==O&&t.vectorId==l.vectorId&&(this.context.strokeStyle=je.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.setLineDash([3,2,2]),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.setLineDash([3,2,2]),this.context.stroke(),this.context.restore()},Ge.prototype.drawBeam=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=Ne.lineWidth*h.ratio,this.context.strokeStyle=Ne.strokeStyle;var s=!1;if(e)"style-1"==e?(this.context.lineWidth=$e.style1.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Component.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Component.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Component.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Component.strokeStyle);else{var r=yt.getSelectItem(),l=yt.getDraggingItem(),a=yt.getFocusItem();r&&r.type==A?t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Component.strokeStyle,this.context.fillStyle=Ye.Component.fillStyle,s=!0):l&&l.type==A&&t.vectorId==l.vectorId&&(this.context.strokeStyle=Ye.Component.strokeStyle,this.context.fillStyle=Ye.Component.fillStyle,s=!0),a&&a.type==A&&t.vectorId==a.vectorId&&(this.context.strokeStyle=je.Component.strokeStyle,this.context.fillStyle=je.Component.fillStyle,s=!0)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),s&&this.context.fill(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[2].x,n[2].y),this.context.moveTo(n[1].x,n[1].y),this.context.lineTo(n[3].x,n[3].y),this.context.stroke(),this.context.restore()},Ge.prototype.drawFlue=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=Ne.lineWidth*h.ratio,this.context.strokeStyle=Ne.strokeStyle;var s=!1;if(e)"style-1"==e?(this.context.lineWidth=$e.style1.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Component.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Component.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Component.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Component.strokeStyle);else{var r=yt.getSelectItem(),l=yt.getDraggingItem(),a=yt.getFocusItem();r&&r.type==R?t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Component.strokeStyle,this.context.fillStyle=Ye.Component.fillStyle,s=!0):l&&l.type==R&&t.vectorId==l.vectorId&&(this.context.strokeStyle=Ye.Component.strokeStyle,this.context.fillStyle=Ye.Component.fillStyle,s=!0),a&&a.type==R&&t.vectorId==a.vectorId&&(this.context.strokeStyle=je.Component.strokeStyle,this.context.fillStyle=je.Component.fillStyle,s=!0)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),s&&this.context.fill(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.closePath(),this.context.stroke(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[8].x,n[8].y),this.context.lineTo(n[6].x,n[6].y),this.context.stroke(),this.context.restore()},Ge.prototype.drawCorridor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=Ne.lineWidth*h.ratio,this.context.strokeStyle=Ne.strokeStyle,e)"style-1"==e?(this.context.lineWidth=$e.style1.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Component.strokeStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Component.strokeStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Component.strokeStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Component.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Component.strokeStyle);else{var s=yt.getSelectItem(),r=yt.getDraggingItem(),l=yt.getFocusItem();s&&s.type==E?t.vectorId==s.vectorId&&(this.context.strokeStyle=Ye.Component.strokeStyle):r&&r.type==E&&t.vectorId==r.vectorId&&(this.context.strokeStyle=Ye.Component.strokeStyle),l&&l.type==E&&t.vectorId==l.vectorId&&(this.context.strokeStyle=je.Component.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke();for(var a=4;a<n.length-1;a+=2)this.context.moveTo(n[a].x,n[a].y),this.context.lineTo(n[a+1].x,n[a+1].y);this.context.stroke(),this.context.restore()},Ge.prototype.drawTag=function(t,e){if(this.context.save(),this.context.lineWidth=Be.lineWidth*h.ratio,this.context.strokeStyle=Be.strokeStyle,this.context.fillStyle=Be.fillStyle,e)"style-1"==e?(this.context.lineWidth=$e.style1.Tag.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Tag.strokeStyle,this.context.fillStyle=$e.style1.Tag.fillStyle):"style-2"==e?(this.context.lineWidth=$e.style2.Tag.lineWidth*h.ratio,this.context.strokeStyle=$e.style2.Tag.strokeStyle,this.context.fillStyle=$e.style2.Tag.fillStyle):"style-3"==e?(this.context.lineWidth=$e.style3.Tag.lineWidth*h.ratio,this.context.strokeStyle=$e.style3.Tag.strokeStyle,this.context.fillStyle=$e.style3.Tag.fillStyle):"style-4"==e&&(this.context.lineWidth=$e.style4.Tag.lineWidth*h.ratio,this.context.strokeStyle=$e.style4.Tag.strokeStyle,this.context.fillStyle=$e.style4.Tag.fillStyle);else{var o=yt.getSelectItem(),n=yt.getDraggingItem(),i=yt.getFocusItem();o&&o.type==N?t.vectorId==o.vectorId&&(this.context.strokeStyle=Ye.Tag.strokeStyle,this.context.fillStyle=Ye.Tag.fillStyle):n&&n.type==N&&t.vectorId==n.vectorId&&(this.context.strokeStyle=Ye.Tag.strokeStyle,this.context.fillStyle=Ye.Tag.fillStyle),i&&i.type==N&&t.vectorId==i.vectorId&&(this.context.strokeStyle=je.Tag.strokeStyle,this.context.fillStyle=je.Tag.fillStyle)}for(var s=t.points2d,r=[],l=0;l<s.length;++l)r[l]=h.getScreenXY({x:s[l].x,y:s[l].y});if(t.adding){this.context.strokeStyle=Be.strokeStyle_adding,this.context.fillStyle=Be.fillStyle_adding,this.context.beginPath(),this.context.moveTo(r[0].x,r[0].y),this.context.lineTo(r[1].x,r[1].y),this.context.lineTo(r[2].x,r[2].y),this.context.lineTo(r[3].x,r[3].y),this.context.closePath(),this.context.stroke();for(var a=4;a<r.length-1;a+=2)this.context.moveTo(r[a].x,r[a].y),this.context.lineTo(r[a+1].x,r[a+1].y);this.context.stroke()}else{h.ratio==f?this.context.font="400 36px Microsoft YaHei":this.context.font="400 12px Microsoft YaHei",t.sideWidth=Math.max(this.context.measureText(t.title).width,this.context.measureText(t.des).width),t.setPoints2d();var c=(t.center.x,t.center.y);c=h.getScreenXY({x:t.center.x,y:t.center.y});var d=this.context.measureText(t.title).width,p=Y.createLine1({x:(r[0].x+r[3].x)/2,y:(r[0].y+r[3].y)/2},{x:(r[2].x+r[1].x)/2,y:(r[2].y+r[1].y)/2}),y=this.context.measureText(t.des+"m²").width,u=Y.createLine1(r[2],r[3]),g=Y.getDisPointsLine(p,c,d/2,d/2),x=Y.getDisPointsLine(u,{x:(r[2].x+r[3].x)/2,y:(r[2].y+r[3].y)/2},y/2,y/2);if(g.newpoint1.x<g.newpoint2.x){if(this.context.fillText(t.title,g.newpoint1.x,g.newpoint1.y),t.des)if("ft"==xt.unit){var m=Se.convert(t.des,"area",void 0,"imperial",.01,!1);this.context.fillText(m,x.newpoint1.x,x.newpoint1.y)}else this.context.fillText(t.des+"m²",x.newpoint1.x,x.newpoint1.y)}else if(this.context.fillText(t.title,g.newpoint2.x,g.newpoint2.y),t.des)if("ft"==xt.unit){var v=Se.convert(t.des,"area",void 0,"imperial",.01,!1);this.context.fillText(v,x.newpoint2.x,x.newpoint2.y)}else this.context.fillText(t.des+"m²",x.newpoint2.x,x.newpoint2.y)}this.context.restore()},Ge.prototype.drawCircle=function(t){var e=null,o=2*Math.PI,n=h.getScreenXY(t);this.context.save(),t.name==bt?(e=Xe.StartAddWall.radius*h.ratio,this.context.strokeStyle=Xe.StartAddWall.strokeStyle,this.context.fillStyle=Xe.StartAddWall.fillStyle):t.name==wt?(e=Xe.StartSymbolPoints.radius*h.ratio,this.context.strokeStyle=Xe.StartSymbolPoints.strokeStyle,this.context.fillStyle=Xe.StartSymbolPoints.fillStyle):t.name==Wt?(e=Xe.EndSymbolPoints.radius*h.ratio,this.context.strokeStyle=Xe.EndSymbolPoints.strokeStyle,this.context.fillStyle=Xe.EndSymbolPoints.fillStyle):"pano"==t.name&&(e=Ue.radius*h.ratio,this.context.strokeStyle=Ue.strokeStyle,this.context.fillStyle=Ue.fillStyle,this.context.lineWidth=Ue.lineWidth),this.context.beginPath(),this.context.arc(n.x,n.y,e,0,o,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ge.prototype.drawLine=function(t){var e=h.getScreenXY(t.start),o=h.getScreenXY(t.end);this.context.save(),t.name==Tt?(this.context.lineWidth=Xe.VCheckLinesX.lineWidth*h.ratio,this.context.strokeStyle=Xe.VCheckLinesX.strokeStyle,this.context.setLineDash([3,2,2]),e.y=0,o.y=this.context.canvas.clientHeight):t.name==Dt?(this.context.lineWidth=Xe.VCheckLinesY.lineWidth*h.ratio,this.context.strokeStyle=Xe.VCheckLinesY.strokeStyle,this.context.setLineDash([3,2,2]),e.x=0,o.x=this.context.canvas.clientWidth):t.name==kt?(this.context.lineWidth=Xe.NewWall.lineWidth*h.ratio,this.context.strokeStyle=Xe.NewWall.strokeStyle,"error"==t.state?this.context.strokeStyle=Xe.NewWall.errorStrokeStyle:"normal-out"==t.state&&(this.context.strokeStyle=Xe.NewWall.strokeStyle_out,this.context.lineWidth=Xe.NewWall.lineWidth_out*h.ratio)):t.name==Ft?(this.context.lineWidth=Xe.CheckLinesX.lineWidth*h.ratio,this.context.strokeStyle=Xe.CheckLinesX.strokeStyle,this.context.setLineDash([3,2,2])):t.name==Ct&&(this.context.lineWidth=Xe.CheckLinesY.lineWidth*h.ratio,this.context.strokeStyle=Xe.CheckLinesY.strokeStyle,this.context.setLineDash([3,2,2])),this.context.beginPath(),this.context.moveTo(e.x,e.y),this.context.lineTo(o.x,o.y),this.context.stroke(),this.context.restore(),t.name==kt&&this.drawMeasureTxt(t.start,t.end),this.context.save(),this.context.lineWidth=Ee.lineWidth*h.ratio,this.context.strokeStyle=Ee.strokeStyle,this.context.fillStyle=Ee.fillStyle;var n=Ee.radius;this.context.beginPath(),this.context.arc(e.x,e.y,n*h.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ge.prototype.drawMeasure=function(t,e,o){this.context.save(),this.context.strokeStyle=Ve.strokeStyle,this.context.lineWidth=Ve.lineWidth*h.ratio,o&&("style-1"==o||"style-2"==o||"style-3"==o||"style-4"==o)&&(this.context.lineWidth=$e.style1.Measure.lineWidth*h.ratio,this.context.strokeStyle=$e.style1.Measure.strokeStyle);for(var n=0;n<t.length-1;++n){var i=h.getScreenXY(t[n]),s=h.getScreenXY(t[n+1]),r=0;"top"==e?(i.y=xt.region.top*h.ratio,s.y=xt.region.top*h.ratio):"bottom"==e?(i.y=xt.region.bottom*h.ratio,s.y=xt.region.bottom*h.ratio):"left"==e?(i.x=xt.region.left*h.ratio,s.x=xt.region.left*h.ratio,r=-.5*Math.PI):"right"==e&&(i.x=xt.region.right*h.ratio,s.x=xt.region.right*h.ratio,r=.5*Math.PI);var l=Y.createLine1(i,s);if(null!=l){var a=Y.getParallelLineForDistance(l,6*h.ratio),c=Y.getJoinLinePoint(i,a.line1),d=Y.getJoinLinePoint(s,a.line1),p=Y.getJoinLinePoint(i,a.line2),y=Y.getJoinLinePoint(s,a.line2);this.context.beginPath(),this.context.moveTo(c.x,c.y),this.context.lineTo(p.x,p.y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(d.x,d.y),this.context.lineTo(y.x,y.y),this.context.stroke();var u={x:(i.x+s.x)/2,y:(i.y+s.y)/2},g=Y.getVerticalLine(l,u);a=Y.getParallelLineForDistance(g,22*h.ratio);var x=Y.getIntersectionPoint(l,a.line1),m=Y.getIntersectionPoint(l,a.line2);if(Y.getDistance(i,x)<Y.getDistance(i,u)){var v=Y.getDistance(t[n],t[n+1]);v="ft"==xt.unit?" "+Se.convert(v,"distance",void 0,"imperial",.01,!0)+" ":Y.getFixed(v,2)+"m",Y.getDistance(i,s)>this.context.measureText(v).width?(this.context.beginPath(),this.context.moveTo(i.x,i.y),this.context.lineTo(x.x,x.y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(m.x,m.y),this.context.lineTo(s.x,s.y),this.context.stroke(),this.context.save(),h.ratio==f?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei","style-1"==o||"style-3"==o?(this.context.fillStyle="#000000",this.context.strokeStyle="#000000"):(this.context.fillStyle="#FFFFFF",this.context.strokeStyle="#FFFFFF"),this.context.textAlign="center",this.context.textBaseline="middle",this.context.miterLimit=10,this.context.direction="ltr",r?(this.context.translate(u.x,u.y),this.context.rotate(r),this.context.fillText(v,0,0)):this.context.fillText(v,u.x,u.y),this.context.restore()):(this.context.beginPath(),this.context.moveTo(i.x,i.y),this.context.lineTo(s.x,s.y),this.context.stroke())}else{var P=Y.getDistance(t[n],t[n+1]);P="ft"==xt.unit?" "+Se.convert(P,"distance",void 0,"imperial",.01,!0)+" ":Y.getFixed(P,2)+"m",Y.getDistance(i,s)>this.context.measureText(P).width?(this.context.beginPath(),this.context.moveTo(i.x,i.y),this.context.lineTo(m.x,m.y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(x.x,x.y),this.context.lineTo(s.x,s.y),this.context.stroke(),this.context.save(),h.ratio==f?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei","style-1"==o||"style-3"==o?(this.context.fillStyle="#000000",this.context.strokeStyle="#000000"):(this.context.fillStyle="#FFFFFF",this.context.strokeStyle="#FFFFFF"),this.context.textAlign="center",this.context.textBaseline="middle",this.context.miterLimit=10,this.context.direction="ltr",r?(this.context.translate(u.x,u.y),this.context.rotate(r),this.context.fillText(P,0,0)):this.context.fillText(P,u.x,u.y),this.context.restore()):(this.context.beginPath(),this.context.moveTo(i.x,i.y),this.context.lineTo(s.x,s.y),this.context.stroke())}}}this.context.restore()},Ge.prototype.drawMeasureTxt=function(t,e){var o=h.getScreenXY(t),n=h.getScreenXY(e),i=Y.createLine1(o,n);if(null!=i){var s={x:(o.x+n.x)/2,y:(o.y+n.y)/2},r=Y.getParallelLineForDistance(i,10),l=null,a=Y.getJoinLinePoint(s,r.line1),c=Y.getJoinLinePoint(s,r.line2);s.y<a.y?(Y.clonePoint(s,c),l=r.line2):(Y.clonePoint(s,a),l=r.line1);var d=Y.getDistance(t,e);d="ft"==xt.unit?" "+Se.convert(d,"distance",void 0,"imperial",.01,!0)+" ":Y.getFixed(d,2)+"m";var p=this.context.measureText(d).width,y=Y.getLineForPoint(i,s),u=Y.getParallelLineForDistance(y,p/2),g=Y.getIntersectionPoint(u.line1,l);g={x:Math.round(g.x),y:Math.round(g.y)};var x=Y.getIntersectionPoint(u.line2,l);x={x:Math.round(x.x),y:Math.round(x.y)},g.x<x.x?Y.clonePoint(s,g):g.x>x.x?Y.clonePoint(s,x):g.y<x.y?Y.clonePoint(s,g):Y.clonePoint(s,x);var f=null;f=void 0!==i.a?Math.atan(i.a):i.hasOwnProperty("x")?Math.PI/2:0,this.context.save(),this.context.fillStyle=Ve.txt,this.context.translate(s.x,s.y),this.context.rotate(f),this.context.fillText(d,0,0),this.context.restore()}},Ge.prototype.drawEntranceDoor=function(t){this.context.save();var e,o,n=rt.getEnterImg(),i={x:(t.startPoint.x+t.endPoint.x)/2,y:(t.startPoint.y+t.endPoint.y)/2},s=Y.createLine1(t.startPoint,t.endPoint),r=Y.getLineForPoint(s,i),l=null,a=null;"default"==t.enter?l=Y.getParallelLineForDistance(s,n.height/2/h.res):"reverse"==t.enter&&(l=Y.getParallelLineForDistance(s,n.height/2/h.res+Y.getDistance(t.startPoint,t.endPoint))),e=Y.getIntersectionPoint(l.line1,r),o=Y.getIntersectionPoint(l.line2,r);var c=Y.Angle(t.startPoint,{x:t.startPoint.x+1,y:t.startPoint.y},t.endPoint);Y.isClockwise([t.startPoint,t.endPoint,o])?a="LEFT"==t.openSide?"default"==t.enter?e:o:"default"==t.enter?o:e:Y.isClockwise([t.startPoint,t.endPoint,e])&&(a="LEFT"==t.openSide?"default"==t.enter?o:e:"default"==t.enter?e:o),Y.isClockwise([t.startPoint,t.endPoint,a])||(c=Math.PI+c),a=h.getScreenXY(i),this.context.translate(a.x,a.y),console.log("截图："+JSON.stringify(a)),t.startPoint.y<=t.endPoint.y?this.context.rotate(-c):this.context.rotate(c);var d=Y.getDistance(t.startPoint,t.endPoint)*h.res*1.5;this.context.scale(h.zoom/g*h.ratio*d/n.height,h.zoom/g*h.ratio*d/n.height),this.context.drawImage(n,-n.width/2,-n.height-10),this.context.restore()},Ge.prototype.drawRoomBackGround=function(t,e){this.context.save();var o=!1;if(e){this.context.fillStyle=this.context.createPattern(e,"repeat"),o=!0;for(var n=[],i=0;i<t.wallPointIDs.length;++i){var s=b.getPoint(t.wallPointIDs[i]);s=h.getScreenXY(s),n.push(s)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y);for(var r=0;r<n.length;++r)this.context.lineTo(n[r].x,n[r].y);this.context.closePath(),o&&this.context.fill(),this.context.restore()}},Ge.prototype.drawCompass=function(t){var e=null;e="style-1"==t||"style-3"==t?ze.getWhiteImg():ze.getBlackImg();var o=b.getCompass();this.context.save(),this.context.translate((h.width-310)*h.ratio,160*h.ratio),this.context.rotate(o/180*Math.PI),this.context.scale(h.ratio/2,h.ratio/2),this.context.drawImage(e,-e.width/2,-e.height/2),this.context.restore()},Ge.prototype.setCanvasStyle=function(t){for(var e in t)"isFill"!=e&&"isStroke"!=e&&(this.context[e]=t[e])};var Ke=new Ge,qe=function(t){this.layer=t,this.displayPanos=!1};qe.prototype.drawGeometry=function(t,e,o){if(null!=Ke.context)switch(t.geoType){case W:Ke.drawWall(t,e);break;case k:Ke.drawPoint(t);break;case F:Ke.drawSingleDoor(t,e,o);break;case C:Ke.drawDoubleDoor(t,e,o);break;case T:Ke.drawSlideDoor(t,e,o);break;case D:Ke.drawSingleWindow(t,e);break;case L:Ke.drawFrenchWindow(t,e);break;case M:Ke.drawBayWindow(t,e);break;case O:Ke.drawPass(t);break;case A:Ke.drawBeam(t);break;case R:Ke.drawFlue(t);break;case E:Ke.drawCorridor(t);break;case N:Ke.drawTag(t,e)}},qe.prototype.drawElement=function(t){if(null!=Ke.context)switch(t.geoType){case k:Ke.drawCircle(t);break;case _:Ke.drawLine(t)}},qe.prototype.drawPanos=function(t){for(var e=b.getAngle(),o=0;o<t.length;++o){var n=JSON.parse(JSON.stringify(t[o]));n=h.getVectorForRotate(n,e),Ke.drawCircle(n),Ke.drawText(n,n.vectorId)}},qe.prototype.redrawElements=function(){At.vCheckLines.X&&At.vCheckLines.X.display&&this.drawElement(At.vCheckLines.X),At.vCheckLines.Y&&At.vCheckLines.Y.display&&this.drawElement(At.vCheckLines.Y),At.startAddWall&&At.startAddWall.display&&this.drawElement(At.startAddWall),At.newWall&&At.newWall.display&&this.drawElement(At.newWall),At.symbolPoints.Start&&At.symbolPoints.Start.display&&this.drawElement(At.symbolPoints.Start),At.symbolPoints.End&&At.symbolPoints.End.display&&this.drawElement(At.symbolPoints.End),At.checkLines.X&&At.checkLines.X.display&&this.drawElement(At.checkLines.X),At.checkLines.Y&&At.checkLines.Y.display&&this.drawElement(At.checkLines.Y)},qe.prototype.redrawMeasures=function(t){Ke.drawMeasure(xt.measureLines.top,"top",t),Ke.drawMeasure(xt.measureLines.bottom,"bottom",t),Ke.drawMeasure(xt.measureLines.left,"left",t),Ke.drawMeasure(xt.measureLines.right,"right",t)},qe.prototype.redrawRooms=function(t){for(var e=ue.getRooms(t),o=0;o<e.length;++o){for(var n=null,i=0;i<this.layer.app.CadManager.labels.length;++i)if(null!=e[o].tagName&&e[o].tagName.trim()==this.layer.app.CadManager.labels[i].text){"hall"==this.layer.app.CadManager.labels[i].type?(n=ue.getHallImg(),Ke.drawRoomBackGround(e[o],n)):"room"==this.layer.app.CadManager.labels[i].type?(n=ue.getDefaultImg(),Ke.drawRoomBackGround(e[o],n)):"other"==this.layer.app.CadManager.labels[i].type&&(n=ue.getOtherImg(),Ke.drawRoomBackGround(e[o],n));break}null==n&&(n=ue.getDefaultImg(),Ke.drawRoomBackGround(e[o],n))}},qe.prototype.autoRedraw=function(){Ke.clear(),this.displayPanos&&this.drawPanos(this.layer.panos[b.currentFloor]);var t=b.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);Ke.drawSpecialPoint();var n=t.symbols;for(var i in n)this.drawGeometry(n[i]),Ke.drawSymbolPoint(n[i]);Ke.drawSelectSymbolPoint();var s=t.components;for(var r in s)this.drawGeometry(s[r]);var l=t.tags;for(var a in l)this.drawGeometry(l[a]);this.redrawElements(),this.redrawMeasures()},qe.prototype.autoRedrawForImg=function(){Ke.clear();var t=b.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);var n=t.symbols;for(var i in n)this.drawGeometry(n[i],null,true);var s=t.components;for(var r in s)this.drawGeometry(s[r]);var l=t.tags;for(var a in l)this.drawGeometry(l[a])},qe.prototype.autoRedrawForDownLoadImg=function(t){Ke.clear(),"style-1"==t?(Ke.drawBackGround("#FFFFFF"),this.redrawRooms(b.getCurrentFloor())):"style-2"==t?(Ke.drawBackGround("#000000"),this.redrawRooms(b.getCurrentFloor())):"style-3"==t?Ke.drawBackGround("#FFFFFF"):"style-4"==t&&Ke.drawBackGround("#000000");var e=b.getFloorData(),o=e.walls;for(var n in o)this.drawGeometry(o[n],t);var i=e.symbols;for(var s in i)this.drawGeometry(i[s],t,false);var r=e.components;for(var l in r)this.drawGeometry(r[l]);var a=e.tags;for(var h in a)this.drawGeometry(a[h],t);this.redrawMeasures(t),Ke.drawCompass(t)},qe.prototype.redrawCore=function(){console.log("重绘！"),Ke.clear();var t=b.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);var n=t.points;for(var i in n)this.drawGeometry(n[i]);var s=t.symbols;for(var r in s)this.drawGeometry(s[r]);var l=t.components;for(var a in l)this.drawGeometry(l[a])},qe.prototype.clear=function(){Ke.clear()},qe.prototype.getContext=function(){return Ke.context};var Qe=function(){};Qe.prototype.isDifferentForWalls=function(t,e){return t.start!=e.start||t.end!=e.end||t.out!=e.out||t.important!=e.important},Qe.prototype.isDifferentForSymbols=function(t,e){return!Y.equalPoint(t.startPoint,e.startPoint)||!Y.equalPoint(t.endPoint,e.endPoint)||t.openSide!=e.openSide||t.parent!=e.parent||t.enter!=e.enter},Qe.prototype.isDifferentForComponents=function(t,e){return JSON.stringify(t.points2d)!=JSON.stringify(e.points)||t.angle!=e.angle},Qe.prototype.isDifferentForTags=function(t,e){return!Y.equalPoint(t.center,e.center)||t.title!=e.title||t.des!=e.des||t.unit!=e.unit},Qe.prototype.isDifferentForAngle=function(t,e){return t!=e},Qe.prototype.assignWallFromWall=function(t,e){var o={};o.vectorId=t.vectorId,o.children=JSON.parse(JSON.stringify(e.children)),o.out=e.out,o.important=e.important,o.start=e.start,o.end=e.end,H.setWallInfo(o)},Qe.prototype.assignPointFromPoint=function(t,e){var o={};o.vectorId=t.vectorId,o.position={x:e.x,y:e.y},o.parent=JSON.parse(JSON.stringify(e.parent)),H.setPointInfo(o)},Qe.prototype.assignSymbolFromSymbol=function(t,e){var o={};o.vectorId=t.vectorId,o.openSide=e.openSide,o.start=JSON.parse(JSON.stringify(e.start)),o.end=JSON.parse(JSON.stringify(e.end)),o.points2d=JSON.parse(JSON.stringify(e.points)),o.enter=e.enter,o.parent=e.parent,rt.setSymbolInfo(o)},Qe.prototype.assignComponentFromComponent=function(t,e){var o={};o.vectorId=t.vectorId,o.angle=e.angle,o.center=JSON.parse(JSON.stringify(e.center)),o.points2d=JSON.parse(JSON.stringify(e.points)),dt.setComponentInfo(o)},Qe.prototype.assignTagFromTag=function(t,e){var o={};o.vectorId=t.vectorId,o.title=e.title,o.des=e.des,o.unit=e.unit,o.center=JSON.parse(JSON.stringify(e.center)),o.points2d=JSON.parse(JSON.stringify(e.points)),o.adding=!1,mt.setTagInfo(o)},Qe.prototype.deletePoint=function(t){var e=b.getPoint(t).parent;for(var o in e)b.deletePoint(t,o)},Qe.prototype.getDataForPoint=function(t){var e={};return e.id=t.vectorId,Y.clonePoint(e,t),e.parent=JSON.parse(JSON.stringify(t.parent)),e.type=t.geoType,e},Qe.prototype.getDataForWall=function(t){var e={};return e.id=t.vectorId,e.start=t.start,e.end=t.end,e.out=t.out,e.important=t.important,e.children=JSON.parse(JSON.stringify(t.children)),e.type=t.geoType,e},Qe.prototype.getDataForSymbol=function(t){var e={};return e.id=t.vectorId,e.start=JSON.parse(JSON.stringify(t.startPoint)),e.end=JSON.parse(JSON.stringify(t.endPoint)),e.openSide=t.openSide,e.enter=t.enter,e.points=JSON.parse(JSON.stringify(t.points2d)),e.parent=t.parent,e.type=t.geoType,e},Qe.prototype.getDataForComponent=function(t){var e={};return e.id=t.vectorId,e.type=t.geoType,e.center=JSON.parse(JSON.stringify(t.center)),e.angle=t.angle,e.points=[].concat(t.points2d),e},Qe.prototype.getDataForTag=function(t){var e={};return e.id=t.vectorId,e.type=t.geoType,e.center={},Y.clonePoint(e.center,t.center),e.points=[].concat(t.points2d),e.title=t.title,e.des=t.des,e.unit=t.unit,e},Qe.prototype.getDataForAngle=function(t){return t},Qe.prototype.getDataForRes=function(t){return t};var Ze=new Qe,to="addPoint",eo="deletePoint",oo="modifyPoint",no="addWall",io="deleteWall",so="modifyWall",ro="addSymbol",lo="deleteSymbol",ao="modifySymbol",ho="addComponent",co="deleteComponent",po="modifyComponent",yo="addTag",uo="deleteTag",go="modifyTag",xo="modifyAngle",fo=function(){this.lastData={},this.elements={}};fo.prototype.saveCurrentInfo=function(){this.lastData.currentFloor=b.getCurrentFloor(),this.lastData.points=JSON.parse(JSON.stringify(b.getPoints())),this.lastData.walls=JSON.parse(JSON.stringify(b.getWalls())),this.lastData.symbols=JSON.parse(JSON.stringify(b.getSymbols())),this.lastData.components=JSON.parse(JSON.stringify(b.getComponents())),this.lastData.tags=JSON.parse(JSON.stringify(b.getTags())),this.lastData.angle=b.getAngle(),this.lastData.res=h.res},fo.prototype.operate=function(){return this.elements={},this.compareAngle()?(this.lastData={},!0):(this.comparePoints(),this.compareSymbols(),this.compareWalls(),this.compareComponents(),this.compareTags(),0==this.elements.points.length&&0==this.elements.walls.length&&0==this.elements.symbols.length&&0==this.elements.components.length&&0==this.elements.tags.length?(this.saveCurrentInfo(),!1):(this.lastData={},!0))},fo.prototype.comparePoints=function(){var t=b.getPoints();for(var e in this.elements.points=[],t){var o=t[e];if(this.lastData.points[e]){var n=this.lastData.points[e];if(o.x==n.x&&o.y==n.y&&JSON.stringify(o.parent)==JSON.stringify(n.parent)){delete this.lastData.points[e];continue}var i={handle:oo,prePoint:Ze.getDataForPoint(n),curPoint:Ze.getDataForPoint(o)};this.elements.points.push(i)}else{var s={handle:to,point:Ze.getDataForPoint(o)};this.elements.points.push(s)}delete this.lastData.points[e]}for(var r in this.lastData.points){var l={handle:eo,point:Ze.getDataForPoint(this.lastData.points[r])};this.elements.points.push(l)}},fo.prototype.compareWalls=function(){this.elements.walls=[];var t=b.getWalls();for(var e in t){var o=t[e],n=this.lastData.walls[e];if(n){if(!Ze.isDifferentForWalls(o,n)){delete this.lastData.walls[e];continue}var i={handle:so,preWall:Ze.getDataForWall(n),curWall:Ze.getDataForWall(o)};this.elements.walls.push(i)}else{var s={handle:no,wall:Ze.getDataForWall(o)};this.elements.walls.push(s)}delete this.lastData.walls[e]}for(var r in this.lastData.walls){var l={handle:io,wall:Ze.getDataForWall(this.lastData.walls[r])};this.elements.walls.push(l)}},fo.prototype.compareSymbols=function(){this.elements.symbols=[];var t=b.getSymbols();for(var e in t){var o=t[e],n=this.lastData.symbols[e];if(n){if(!Ze.isDifferentForSymbols(o,n)){delete this.lastData.symbols[e];continue}var i={handle:ao,preSymbol:Ze.getDataForSymbol(n),curSymbol:Ze.getDataForSymbol(o)};this.elements.symbols.push(i)}else{var s={handle:ro,symbol:Ze.getDataForSymbol(o)};this.elements.symbols.push(s)}delete this.lastData.symbols[e]}for(var r in this.lastData.symbols){var l={handle:lo,symbol:Ze.getDataForSymbol(this.lastData.symbols[r])};this.elements.symbols.push(l)}},fo.prototype.compareComponents=function(){this.elements.components=[];var t=b.getComponents();for(var e in t){var o=t[e],n=this.lastData.components[e];if(n){if(!Ze.isDifferentForComponents(o,n)){delete this.lastData.components[e];continue}var i={handle:po,preComponent:Ze.getDataForComponent(n),curComponent:Ze.getDataForComponent(o)};this.elements.components.push(i)}else{var s={handle:ho,component:Ze.getDataForComponent(o)};this.elements.components.push(s)}delete this.lastData.components[e]}for(var r in this.lastData.components){var l={handle:co,component:Ze.getDataForComponent(this.lastData.components[r])};this.elements.components.push(l)}},fo.prototype.compareTags=function(){this.elements.tags=[];var t=b.getTags();for(var e in t){var o=t[e],n=this.lastData.tags[e];if(n){if(!Ze.isDifferentForTags(o,n)){delete this.lastData.tags[e];continue}var i={handle:go,preTag:Ze.getDataForTag(n),curTag:Ze.getDataForTag(o)};this.elements.tags.push(i)}else{var s={handle:yo,tag:Ze.getDataForTag(o)};this.elements.tags.push(s)}delete this.lastData.tags[e]}for(var r in this.lastData.tags){var l={handle:uo,tag:Ze.getDataForTag(this.lastData.tags[r])};this.elements.tags.push(l)}},fo.prototype.compareAngle=function(){var t=b.getAngle(),e=this.lastData.angle,o=this.lastData.res;if(Ze.isDifferentForAngle(t,e)){var n={handle:xo,preState:{angle:Ze.getDataForAngle(e),res:Ze.getDataForRes(o)},curState:{angle:Ze.getDataForAngle(t),res:Ze.getDataForRes(h.res)}};return this.elements.rotate=n,!0}return!1};var mo=new fo,vo=function(t){this.layer=t};vo.prototype.init=function(){mo.saveCurrentInfo();var t=b.getPoints();Object.keys(t).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1)},vo.prototype.save=function(){if(mo.operate()){xt.update(),Et.addHistoryRecord(mo.elements),mo.saveCurrentInfo(),this.setState(),Et.getHistoryState().pre&&(this.layer.$xui.toolbar.recall=!0),this.layer.$xui.toolbar.recover=!1;var t=b.getPoints();return Object.keys(t).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1),this.layer.emit("change"),mo.elements}},vo.prototype.setState=function(){var t={pre:0,next:0},e=Et.getCurrentRecordIndex(),o=Et.getHistoryRecords();e>-1&&(t.pre=1),e<o.length-1&&(t.next=1);var n=Et.getHistoryState();n.pre==t.pre&&n.next==t.next||Et.setHistoryState(t.pre,t.next)},vo.prototype.canUndo=function(){return 0!=this.setState().pre},vo.prototype.canRedo=function(){return 0!=this.setState().next},vo.prototype.handleUndo=function(){this.goPreState()},vo.prototype.handleRedo=function(){this.goNextState()},vo.prototype.goPreState=function(){var t=Et.getHistoryRecord();if(t){yt.clearFocusItem(),this.layer.$xui.hideProps(),t.type="pre";null!=t.rotate&&this.goPreForAngle(t.rotate)||(this.goPreForPoints(t.points),this.goPreForWalls(t.walls),this.goPreForSymbols(t.symbols),this.goPreForComponents(t.components),this.goPreForTags(t.tags)),xt.update(),Et.undoHistoryRecord(),mo.saveCurrentInfo(),this.setState();var e=b.getPoints();Object.keys(e).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1)}else console.error("goPreState超出范围！")},vo.prototype.goPreForPoints=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==to)Ze.deletePoint(o.point.id);else if(o.handle==eo){H.createPoint(o.point.x,o.point.y,o.point.id).parent=JSON.parse(JSON.stringify(o.point.parent))}else if(o.handle==oo){var n=o.prePoint,i=b.getPoint(o.curPoint.id);Ze.assignPointFromPoint(i,n)}}},vo.prototype.goPreForWalls=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==no)b.deleteWallNoSymbol(o.wall.id);else if(o.handle==io){var n=o.wall,i=H.createWall(n.start,n.end,n.id);Ze.assignWallFromWall(i,n)}else if(o.handle==so){var s=o.preWall,r=b.getWall(o.curWall.id);Ze.assignWallFromWall(r,s)}}},vo.prototype.goPreForSymbols=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==ro)rt.deleteSymbol(o.symbol.id);else if(o.handle==lo){var n=rt.createSymbol(o.symbol.start,o.symbol.end,o.symbol.type,o.symbol.parent,o.symbol.id);Ze.assignSymbolFromSymbol(n,o.symbol)}else if(o.handle==ao){var i=o.preSymbol,s=b.getSymbol(o.curSymbol.id);Ze.assignSymbolFromSymbol(s,i)}}},vo.prototype.goPreForComponents=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==ho)b.deleteComponent(o.component.id);else if(o.handle==co){var n=dt.createComponent(o.component.center,o.component.type,o.component.id);Ze.assignComponentFromComponent(n,o.component)}else if(o.handle==po){var i=o.preComponent,s=b.getComponent(o.curComponent.id);Ze.assignComponentFromComponent(s,i)}}},vo.prototype.goPreForTags=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==yo)mt.deleteTag(o.tag.id);else if(o.handle==uo){var n=mt.createTag(o.tag.center,o.tag.id);Ze.assignTagFromTag(n,o.tag)}else if(o.handle==go){var i=o.preTag,s=b.getTag(o.curTag.id);Ze.assignTagFromTag(s,i)}}},vo.prototype.goPreForAngle=function(t){if(t.handle==xo){b.setAngle(t.preState.angle),h.updateForRotate(t.preState.angle-t.curState.angle);var e=h.getScreenInfoForCAD();return e.floorPlanAngle=t.preState.angle,h._setRes(t.preState.res),this.layer.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",e),!0}return!1},vo.prototype.goNextForPoints=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==to){var n=H.createPoint(o.point.x,o.point.y,o.point.id);Ze.assignPointFromPoint(n,o.point)}else if(o.handle==eo)Ze.deletePoint(o.point.id);else if(o.handle==oo){var i=o.curPoint,s=b.getPoint(o.curPoint.id);Ze.assignPointFromPoint(s,i)}}},vo.prototype.goNextForWalls=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==no){var n=o.wall,i=H.createWall(n.start,n.end,n.id);Ze.assignWallFromWall(i,n)}else if(o.handle==io)b.deleteWallNoSymbol(o.wall.id);else if(o.handle==so){var s=o.curWall,r=b.getWall(o.preWall.id);Ze.assignWallFromWall(r,s)}}},vo.prototype.goNextForSymbols=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==ro){var n=rt.createSymbol(o.symbol.start,o.symbol.end,o.symbol.type,o.symbol.parent,o.symbol.id);Ze.assignSymbolFromSymbol(n,o.symbol)}else if(o.handle==lo)rt.deleteSymbol(o.symbol.id);else if(o.handle==ao){var i=o.curSymbol,s=b.getSymbol(o.curSymbol.id);Ze.assignSymbolFromSymbol(s,i)}}},vo.prototype.goNextForComponents=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==ho){var n=dt.createComponent(o.component.center,o.component.type,o.component.id);Ze.assignComponentFromComponent(n,o.component)}else if(o.handle==co)b.deleteComponent(o.component.id);else if(o.handle==po){var i=o.curComponent,s=b.getComponent(o.curComponent.id);Ze.assignComponentFromComponent(s,i)}}},vo.prototype.goNextForTags=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==yo){var n=mt.createTag(o.tag.center,o.tag.id);Ze.assignTagFromTag(n,o.tag)}else if(o.handle==uo)b.deleteTag(o.tag.id);else if(o.handle==go){var i=o.curTag,s=b.getTag(o.curTag.id);Ze.assignTagFromTag(s,i)}}},vo.prototype.goNextForAngle=function(t){if(t.handle==xo){b.setAngle(t.curState.angle),h.updateForRotate(t.curState.angle-t.preState.angle);var e=h.getScreenInfoForCAD();return e.floorPlanAngle=t.curState.angle,h._setRes(t.curState.res),this.layer.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",e),!0}return!1},vo.prototype.goNextState=function(){Et.redoHistoryRecord();var t=Et.getHistoryRecord();if(t){yt.clearFocusItem(),this.layer.$xui.hideProps();null!=t.rotate&&this.goNextForAngle(t.rotate)||(this.goNextForPoints(t.points),this.goNextForWalls(t.walls),this.goNextForSymbols(t.symbols),this.goNextForComponents(t.components),this.goNextForTags(t.tags)),xt.update(),mo.saveCurrentInfo(),this.setState();var e=b.getPoints();Object.keys(e).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1)}else Et.undoHistoryRecord(),console.error("goNextState超出范围！")};var Po={export:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a",lineWidth:7,lineWidth_out:10},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Font:[{font:"bold 14px Microsoft YaHei",fillStyle:"rgb(65,65,65)",screen:{x:520,y:856},text:"© "},{font:"bold 14px Microsoft YaHei",fillStyle:"#70707a",screen:{x:538,y:855},text:"版权归58同城、赶集网、安居客、四维时代、正顺所有"},{font:"bold 14px Microsoft YaHei",fillStyle:"rgb(65,65,65)",screen:{x:30,y:840},text:["单位：毫米(mm)","提示：户型图中所有室内装饰、设计、摆设、间隔、尺寸、设备仅供参考。","具体房源标准以室内查勘和测量为准。"]}],compass:{screen:{x:66,y:88}},BackGround:{fillStyle:"#FFFFFF"}},cover:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},default:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},Font:{font:"12px Microsoft YaHei",fillStyle:"rgba(0,0,0,1)",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#70707a"}},Io=function(){this.context=null};Io.prototype.initContext=function(t){this.context=t},Io.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},Io.prototype.drawWall=function(t,e){var o=b.getPoint(t.start),n=b.getPoint(t.end),i=[];i.push(o);for(var s=0;s<t.children.length;++s){var r=b.getSymbol(t.children[s]);i.push(r.startPoint),i.push(r.endPoint)}i.push(n),i=i.sort(function(t,e){return Y.getDistance(o,t)-Y.getDistance(o,e)}.bind(this)),this.context.save(),this.context.beginPath(),"export"==e?(t.out||t.important?this.context.lineWidth=Po.export.Wall.lineWidth_out:this.context.lineWidth=Po.export.Wall.lineWidth,this.context.strokeStyle=Po.export.Wall.strokeStyle,this.context.fillStyle=Po.export.Wall.fillStyle):"cover"==e?(t.out||t.important?this.context.lineWidth=Po.cover.Wall.lineWidth_out:this.context.lineWidth=Po.cover.Wall.lineWidth,this.context.strokeStyle=Po.cover.Wall.strokeStyle,this.context.fillStyle=Po.cover.Wall.fillStyle):"default"==e&&(t.out||t.important?this.context.lineWidth=Po.default.Wall.lineWidth_out:this.context.lineWidth=Po.default.Wall.lineWidth,this.context.strokeStyle=Po.default.Wall.strokeStyle,this.context.fillStyle=Po.default.Wall.fillStyle),this.context.lineCap="butt";for(var l=0;l<i.length-1;l+=2){var a=h.getScreenXY(i[l]),c=h.getScreenXY(i[l+1]);this.context.moveTo(a.x,a.y),this.context.lineTo(c.x,c.y)}this.context.stroke(),this.context.restore(),o.x,n.x,o.y,n.y},Io.prototype.drawPoint=function(t,e){this.context.save(),this.context.beginPath();var o="thin";for(var n in t.parent){var i=b.getWall(n);if(i.out&&i.important){o="fat";break}}var s=null;"export"==e?(s="thin"==o?Po.export.Wall.lineWidth:Po.export.Wall.lineWidth_out,this.context.strokeStyle=Po.export.Wall.strokeStyle,this.context.fillStyle=Po.export.Wall.fillStyle):"cover"==e?(s="thin"==o?Po.cover.Wall.lineWidth:Po.cover.Wall.lineWidth_out,this.context.strokeStyle=Po.cover.Wall.strokeStyle,this.context.fillStyle=Po.cover.Wall.fillStyle):"default"==e&&(s="thin"==o?Po.default.Wall.lineWidth:Po.default.Wall.lineWidth_out,this.context.strokeStyle=Po.default.Wall.strokeStyle,this.context.fillStyle=Po.default.Wall.fillStyle),this.context.lineCap="butt";var r=h.getScreenXY(t);this.context.rect(r.x-s/2,r.y-s/2,s,s),this.context.fill(),this.context.restore()},Io.prototype.drawText=function(t,e,o,n){this.context.save(),this.setCanvasStyle(Po.Font),h.ratio==f?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei";var i={x:t.x,y:t.y};o||(i=h.getScreenXY({x:t.x,y:t.y})),n?(this.context.translate(i.x,i.y),this.context.rotate(n),this.context.strokeText(e,0,0),this.context.fillText(e,0,0)):(this.context.strokeText(e,i.x,i.y),this.context.fillText(e,i.x,i.y)),this.context.restore()},Io.prototype.drawSingleDoor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});var s=Y.getDistance(n[0],n[1]);this.context.save(),this.context.lineCap="butt",this.context.lineWidth=1,"export"==e?(this.context.strokeStyle=Po.export.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"cover"==e?(this.context.strokeStyle=Po.cover.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"default"==e&&(this.context.strokeStyle=Po.default.strokeStyle,this.context.fillStyle=Po.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.arcTo(n[2].x,n[2].y,n[3].x,n[3].y,s),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawEntranceDoor(t)},Io.prototype.drawDoubleDoor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});var s=Y.getDistance(n[0],n[1]);this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=Po.export.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"cover"==e?(this.context.strokeStyle=Po.cover.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"default"==e&&(this.context.strokeStyle=Po.default.strokeStyle,this.context.fillStyle=Po.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.arcTo(n[4].x,n[4].y,n[5].x,n[5].y,s),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[1].x,n[1].y),this.context.arcTo(n[4].x,n[4].y,n[3].x,n[3].y,s),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawEntranceDoor(t)},Io.prototype.drawSlideDoor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=Po.export.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"cover"==e?(this.context.strokeStyle=Po.cover.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"default"==e&&(this.context.strokeStyle=Po.default.strokeStyle,this.context.fillStyle=Po.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawEntranceDoor(t)},Io.prototype.drawSingleWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=Po.export.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"cover"==e?(this.context.strokeStyle=Po.cover.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"default"==e&&(this.context.strokeStyle=Po.default.strokeStyle,this.context.fillStyle=Po.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.lineTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.closePath(),this.context.stroke(),this.context.restore()},Io.prototype.drawBayWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=Po.export.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"cover"==e?(this.context.strokeStyle=Po.cover.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"default"==e&&(this.context.strokeStyle=Po.default.strokeStyle,this.context.fillStyle=Po.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.closePath(),this.context.stroke(),this.context.restore()},Io.prototype.drawFrenchWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=h.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=Po.export.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"cover"==e?(this.context.strokeStyle=Po.cover.strokeStyle,this.context.fillStyle=Po.export.fillStyle):"default"==e&&(this.context.strokeStyle=Po.default.strokeStyle,this.context.fillStyle=Po.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[4].x,n[4].y),this.context.moveTo(n[3].x,n[3].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.stroke(),this.context.restore()},Io.prototype.drawMeasure=function(t,e){this.context.save(),this.context.strokeStyle=Po.Measure.strokeStyle,this.context.beginPath();for(var o=0;o<t.length-1;++o){var n=h.getScreenXY(t[o]),i=h.getScreenXY(t[o+1]),s=0;"top"==e?(n.y=xt.region.top*h.ratio,i.y=xt.region.top*h.ratio):"bottom"==e?(n.y=xt.region.bottom*h.ratio,i.y=xt.region.bottom*h.ratio):"left"==e?(n.x=xt.region.left*h.ratio,i.x=xt.region.left*h.ratio,s=-.5*Math.PI):"right"==e&&(n.x=xt.region.right*h.ratio,i.x=xt.region.right*h.ratio,s=.5*Math.PI);var r=Y.createLine1(n,i),l=Y.getParallelLineForDistance(r,6),a=Y.getJoinLinePoint(n,l.line1),c=Y.getJoinLinePoint(i,l.line1),d=Y.getJoinLinePoint(n,l.line2),p=Y.getJoinLinePoint(i,l.line2);this.context.moveTo(a.x,a.y),this.context.lineTo(d.x,d.y),this.context.moveTo(c.x,c.y),this.context.lineTo(p.x,p.y),this.context.stroke();var y={x:(n.x+i.x)/2,y:(n.y+i.y)/2},u=Y.getVerticalLine(r,y);l=Y.getParallelLineForDistance(u,20);var g=Y.getIntersectionPoint(r,l.line1),x=Y.getIntersectionPoint(r,l.line2);if(Y.getDistance(n,g)<Y.getDistance(n,y)){this.context.moveTo(n.x,n.y),this.context.lineTo(g.x,g.y),this.context.moveTo(x.x,x.y),this.context.lineTo(i.x,i.y),this.context.stroke();var f=Y.getDistance(t[o],t[o+1]);"ft"==xt.unit&&(f=" "+Se.convert(f,"distance",void 0,"imperial",.01,!0)+" "),this.drawText(y,Y.getFixed(f,2),!0,s)}else{this.context.moveTo(n.x,n.y),this.context.lineTo(x.x,x.y),this.context.moveTo(g.x,g.y),this.context.lineTo(i.x,i.y),this.context.stroke();var m=Y.getDistance(t[o],t[o+1]);"ft"==xt.unit&&(m=" "+Se.convert(m,"distance",void 0,"imperial",.01,!0)+" "),this.drawText(y,Y.getFixed(m,2),!0,s)}}this.context.restore()},Io.prototype.drawExportTxt=function(){this.context.save(),this.context.font=Po.export.Font[0].font,this.context.fillStyle=Po.export.Font[0].fillStyle,this.context.fillText(Po.export.Font[0].text,Po.export.Font[0].screen.x,Po.export.Font[0].screen.y),this.context.restore(),this.context.save(),this.context.font=Po.export.Font[1].font,this.context.fillStyle=Po.export.Font[1].fillStyle,this.context.fillText(Po.export.Font[1].text,Po.export.Font[1].screen.x,Po.export.Font[1].screen.y),this.context.restore(),this.context.save(),this.context.font=Po.export.Font[2].font,this.context.fillStyle=Po.export.Font[2].fillStyle,this.context.fillText(Po.export.Font[2].text[0],Po.export.Font[2].screen.x,Po.export.Font[2].screen.y),this.context.fillText(Po.export.Font[2].text[1],Po.export.Font[2].screen.x,Po.export.Font[2].screen.y+14),this.context.fillText(Po.export.Font[2].text[2],Po.export.Font[2].screen.x,Po.export.Font[2].screen.y+28),this.context.restore()},Io.prototype.drawExportCompass=function(t,e){this.drawImg(t,e,!0)},Io.prototype.drawRoomBackGround=function(t,e){this.context.save(),this.context.fillStyle=e?this.context.createPattern(e,"repeat"):"#FFFFFF";for(var o=[],n=0;n<t.length;++n){var i=b.getPoint(t[n]);i=h.getScreenXY(i),o.push(i)}this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y);for(var s=0;s<o.length;++s)this.context.lineTo(o[s].x,o[s].y);this.context.closePath(),e&&this.context.fill(),this.context.restore()},Io.prototype.drawImg=function(t,e,o){this.context.save(),o||(e=h.getScreenXY(e)),this.context.translate(e.x,e.y),this.context.drawImage(t,-t.width/2,-t.height/2),this.context.restore()},Io.prototype.drawBackGround=function(t,e,o){this.context.save(),this.context.fillStyle=o,this.context.fillRect(0,0,t,e),this.context.restore()},Io.prototype.drawEntranceDoor=function(t){this.context.save();var e,o,n=rt.getEnterImg(),i={x:(t.startPoint.x+t.endPoint.x)/2,y:(t.startPoint.y+t.endPoint.y)/2},s=Y.createLine1(t.startPoint,t.endPoint),r=Y.getLineForPoint(s,i),l=null,a=null;"default"==t.enter?l=Y.getParallelLineForDistance(s,n.height/2/h.res):"reverse"==t.enter&&(l=Y.getParallelLineForDistance(s,n.height/2/h.res+Y.getDistance(t.startPoint,t.endPoint))),e=Y.getIntersectionPoint(l.line1,r),o=Y.getIntersectionPoint(l.line2,r);var c=Y.Angle(t.startPoint,{x:t.startPoint.x+1,y:t.startPoint.y},t.endPoint);Y.isClockwise([t.startPoint,t.endPoint,o])?a="LEFT"==t.openSide?"default"==t.enter?e:o:"default"==t.enter?o:e:Y.isClockwise([t.startPoint,t.endPoint,e])&&(a="LEFT"==t.openSide?"default"==t.enter?o:e:"default"==t.enter?e:o),Y.isClockwise([t.startPoint,t.endPoint,a])||(c=Math.PI+c),a=h.getScreenXY(i),this.context.translate(a.x,a.y),console.log("截图："+JSON.stringify(a)),t.startPoint.y<=t.endPoint.y?this.context.rotate(-c):this.context.rotate(c);var d=Y.getDistance(t.startPoint,t.endPoint)*h.res*1.5;this.context.scale(h.ratio*d/n.height,h.ratio*d/n.height),this.context.drawImage(n,-n.width/2,-n.height-10),this.context.restore()},Io.prototype.setCanvasStyle=function(t){for(var e in t)"isFill"!=e&&"isStroke"!=e&&(this.context[e]=t[e])};var So=new Io,bo=function(){this.cadBoundingBox=null,this.padding={export:165,cover:35,default:102},this.type=null,this.roomInfo1=null,this.roomInfo2=null,this.roomInfo3=null,this.rooms=[],this.imgCache={},this.anjuke_export=null,this.anjuke=null,this.anjuke_cover=null};bo.prototype.init=function(){this.cadBoundingBox=b.getBoundingBox()},bo.prototype.start=function(){this.layer.uiControl.menu_flex(),So.context=this.layer.renderer.getContext(),this.setType("export"),this.screenshot(),this.setType("cover"),this.screenshot(),this.setType("default"),this.screenshot(),this.recovery()},bo.prototype.setType=function(t){this.type=t},bo.prototype.autoDraw=function(){for(var t=0;t<this.rooms.length;++t){null!=this.rooms[t].pointIds&&this.drawRoom(this.rooms[t])}var e=b.getFloorData(),o=e.walls;for(var n in o)this.drawGeometry(o[n]);var i=e.points;for(var s in i)this.drawGeometry(i[s]);var r=e.symbols;for(var l in r)this.drawGeometry(r[l])},bo.prototype.getSize=function(){if("export"==this.type)h.width=900,h.height=900,Po.export.Wall.lineWidth=Math.ceil(1*Po.export.Wall.lineWidth),Po.export.Wall.lineWidth_out=Math.ceil(1*Po.export.Wall.lineWidth_out);else if("cover"==this.type){var t=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*1.42+2*this.padding.cover,e=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*1.42+2*this.padding.cover;Po.cover.Wall.lineWidth=Math.ceil(.0055*Math.max(t,e)*2*1),Po.cover.Wall.lineWidth_out=Math.ceil(.0055*Math.max(t,e)*1.5*2*1),t=Math.ceil(t+Po.cover.Wall.lineWidth_out),e=Math.ceil(e+Po.cover.Wall.lineWidth_out),h.width=t,h.height=e}else if("default"==this.type){var o=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*2+2*this.padding.default,n=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*2+2*this.padding.default;Po.default.Wall.lineWidth=Math.ceil(.0055*Math.max(o,n)*2*1),Po.default.Wall.lineWidth_out=Math.ceil(.0055*Math.max(o,n)*1.5*2*1),o=Math.ceil(o+Po.default.Wall.lineWidth_out),n=Math.ceil(n+Po.default.Wall.lineWidth_out),h.width=o,h.height=n}},bo.prototype.screenshot=function(){var t,e,o=this.layer.canvas;if(this.getSize(),"export"==this.type){t=(h.width-this.padding.export-this.padding.export-Po.export.Wall.lineWidth_out)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(h.height-this.padding.export-this.padding.export-Po.export.Wall.lineWidth_out)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),h.res=Math.min(t,e),o.width=h.width,o.height=h.height;var n=h.getScreenXY({x:this.cadBoundingBox.minX,y:this.cadBoundingBox.minY}),i=h.getScreenXY({x:this.cadBoundingBox.maxX,y:this.cadBoundingBox.maxY});xt.updatePad({top:i.y-22,bottom:o.height-n.y-22,left:n.x-22,right:o.width-i.x-22}),xt.updateRegion(!1),xt.update(),So.drawBackGround(h.width,h.height,Po.export.BackGround.fillStyle),So.drawMeasure(xt.measureLines.top,"top"),So.drawMeasure(xt.measureLines.bottom,"bottom"),So.drawMeasure(xt.measureLines.left,"left"),So.drawMeasure(xt.measureLines.right,"right"),So.drawExportCompass(this.imgCache.compass,Po.export.compass.screen),So.drawExportTxt(),this.autoDraw(),this.anjuke_export=this.exportImg(o,"image/jpeg")}else"cover"==this.type?(t=(h.width-this.padding.cover-this.padding.cover)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(h.height-this.padding.cover-this.padding.cover)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),h.res=Math.min(t,e),o.width=h.width,o.height=h.height,this.autoDraw(),this.anjuke_cover=this.exportImg(o,"png")):"default"==this.type&&(t=(h.width-this.padding.default-this.padding.default)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(h.height-this.padding.default-this.padding.default)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),h.res=Math.min(t,e),o.width=h.width,o.height=h.height,xt.updatePad({top:50,bottom:50,left:50,right:50}),xt.updateRegion(!1),xt.update(),So.drawMeasure(xt.measureLines.top,"top"),So.drawMeasure(xt.measureLines.bottom,"bottom"),So.drawMeasure(xt.measureLines.left,"left"),So.drawMeasure(xt.measureLines.right,"right"),this.autoDraw(),this.anjuke=this.exportImg(o,"png"))},bo.prototype.recovery=function(){var t=this.layer.app.core.get("CameraControls").activeControl.camera;h.updateForCanvas(this.layer.canvas),h.setRes(t.left,t.right),xt.updatePad(xt.defalutMeasurePad),xt.updateRegion(),this.layer.renderer.autoRedraw()},bo.prototype.exportImg=function(t,e){var o=t.toDataURL(e,3);return this.base64ToBlob(o)},bo.prototype.base64ToBlob=function(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],n=atob(e[1]),i=n.length,s=new Uint8Array(i);i--;)s[i]=n.charCodeAt(i);return new Blob([s],{type:o})},bo.prototype.downloadCadImg=function(t,e){var o=e.substring(e.indexOf(".")+1),n=t.toDataURL(o,3);n=n.replace(this._fixType(o),"image/octet-stream"),this.saveFile(n,e)},bo.prototype.saveFile=function(t,e){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=t,o.download=e;var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},bo.prototype._fixType=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]},bo.prototype.drawGeometry=function(t){switch(t.geoType){case W:So.drawWall(t,this.type);break;case k:So.drawPoint(t,this.type);break;case F:So.drawSingleDoor(t,this.type);break;case C:So.drawDoubleDoor(t,this.type);break;case T:So.drawSlideDoor(t,this.type);break;case D:So.drawSingleWindow(t,this.type);break;case L:So.drawFrenchWindow(t,this.type);break;case M:So.drawBayWindow(t,this.type);break;case A:So.drawBeam(t,this.type);break;case R:So.drawFlue(t,this.type);break;case E:So.drawCorridor(t,this.type);break;case N:So.drawTag(t,this.type)}},bo.prototype.drawRoom=function(t){this.roomInfo1.indexOf(t.name)>-1?So.drawRoomBackGround(t.pointIds,this.imgCache.room1):this.roomInfo2.indexOf(t.name)>-1?So.drawRoomBackGround(t.pointIds,this.imgCache.room2):(this.roomInfo3.indexOf(t.name),So.drawRoomBackGround(t.pointIds,this.imgCache.room3)),"export"==this.type&&t.name&&(So.drawText(t.center,t.name,!1,0),null!=t.area&&""!=t.area.trim()&&So.drawText({x:t.center.x,y:t.center.y-16/h.res},t.area+"m²",!1,0))};var ko=new bo,wo=function(t,e){this.app=t.app,this.layer=t,ko.layer=t,this.ajkJson={},this.cameraJson={},this.floorPlanJson={},this.getCameraJson(e),this.loadImg()};wo.prototype.loadImg=function(){this.app.store.getAppImage("images/ajk/cad_compass_ajk.png").then((function(t){ko.imgCache.compass=t})),this.app.store.getAppImage("images/ajk/room1_ajk.png").then((function(t){ko.imgCache.room1=t})),this.app.store.getAppImage("images/ajk/room2_ajk.png").then((function(t){ko.imgCache.room2=t})),this.app.store.getAppImage("images/ajk/room3_ajk.png").then((function(t){ko.imgCache.room3=t})),ko.roomInfo1=["书房","厨房","卫生间","多功能室","阳台","储物间","步入式衣柜","外景","露台（无顶）","影视间","入房花园"],ko.roomInfo2=["主卧","儿童房","次卧","客卧","老人房","卧室"],ko.roomInfo3=["整套","客厅","走廊","餐厅","起居室","客餐厅","玄关","门厅"]},wo.prototype.start=function(){var t=this;return new Promise((function(e,o){xe.start(),t.getFloorPlanJson().then((function(n){t.floor=n,b.updateBoundingBox(),ko.init();var i=b.getTags();if(0!=Object.keys(i).length)if(s=t.getAJKRooms(i)){var s=t.getEntrance();s?(t.getSceneName(),t.getPictureRotate(),t.getImgInfo(),t.layer.renderer.clear(),ko.start(),e({ajkJson:t.ajkJson,cameraJson:t.cameraJson,floorPlanJson:{floors:[t.floor.floors[0]]},files:{bgmgdCZp_anjuke:ko.anjuke,bgmgdCZp_anjuke_cover:ko.anjuke_cover,bgmgdCZp_anjuke_export:ko.anjuke_export}})):o({type:"toast",msg:"平面图至少包含要给入户门，且入户门应为单开门"})}else o({type:"toast",msg:"标注应包含房间名称、面积"});else o({type:"toast",msg:"平面图应至少包含一个标注"})}))}))},wo.prototype.getAJKRooms=function(t){ko.rooms=[];var e=b.getRooms();this.ajkJson.rooms=this.createAjkRoomForTag(t);for(var o=[],n=0;n<this.ajkJson.rooms.length;++n){if(null==this.ajkJson.rooms[n].area||void 0===this.ajkJson.rooms[n].area)return!1;for(var i=ko.rooms.length,s=0;s<e.length;++s){if(!(o.indexOf(s)>-1))if(e[s].containPoint(this.ajkJson.rooms[n].labelPos)){o.push(s),console.log("匹配："+this.ajkJson.rooms[n].name+"&"+e[s].tagName),ko.rooms.push({center:JSON.parse(JSON.stringify(this.ajkJson.rooms[n].labelPos)),pointIds:JSON.parse(JSON.stringify(e[s].wallPointIDs)),name:this.ajkJson.rooms[n].name,area:this.ajkJson.rooms[n].area});break}}i==ko.rooms.length&&(this.ajkJson.rooms.splice(n,1),--n)}return this.setRoomsGroup(),!0},wo.prototype.getCameraJson=function(t){this.cameraJson={},this.cameraJson.sweepLocations=[];for(var e=0;e<t.sweepLocations.sweepLocations.length;++e){var o=t.sweepLocations.sweepLocations[e];o.uuid=o.uuid.toUTF8().replace(/-/g,""),this.cameraJson.sweepLocations.push(o)}},wo.prototype.getFloorPlanJson=function(){return this.app.store.get("floor",(function(t){return t}))},wo.prototype.getEntrance=function(t){null!=t&&void 0!==t||(t=b.getCurrentFloor());var e=b.getSymbols(t),o=null;for(var n in e)if((o=e[n]).enter)break;if(null!=o&&o.enter){var i=this.layer.app.core.get("Player").model.floors.list[t].boundingBox.min.y+.1,s=new THREE.Vector3(o.startPoint.x,i+.4*.2,-o.startPoint.y),r=new THREE.Vector3(o.endPoint.x,i+.4*.2,-o.endPoint.y),l=s.clone().add(r).multiplyScalar(.5),a=new THREE.Vector3(o.points2d[3].x,i+.4*.2,o.points2d[3].y);a.z*=-1;var h=this.getFootPoint(a,s,r),c=a.clone().sub(h).normalize();l.clone().negate().angleTo(c)>Math.PI/2&&(l.add(c.clone().multiplyScalar(s.distanceTo(r))),c.multiplyScalar(-1)),l.add(c.clone().multiplyScalar(-.5));var d={Position:new THREE.Vector3(l.x,-l.z,l.y),Direction:new THREE.Vector3(c.x,-c.z,c.y)};return this.ajkJson.Entrance=d,!0}return!1},wo.prototype.getSceneName=function(){var t=this.app.store.getValue("metadata");this.ajkJson.scene_name=t.title},wo.prototype.getPictureRotate=function(){var t=b.getAngle(),e=new THREE.Euler(0,t,0),o=new THREE.Vector3(0,0,-1);o.applyEuler(e),o=new THREE.Vector3(o.x,-o.z,o.y),this.ajkJson.picture_rotate=o},wo.prototype.getFootPoint=function(t,e,o,n){var i=t.clone().sub(e),s=e.clone().sub(o),r=s.length(),l=i.dot(s)/r,a=e.clone().add(s.multiplyScalar(l/r));return n&&a.clone().sub(e).dot(a.clone().sub(o))>0&&(a=a.distanceTo(e)<a.distanceTo(o)?e.clone():o.clone()),a},wo.prototype.getImgInfo=function(){var t=b.getCurrentFloor(),e=b.getCadInfo(this.layer.canvas)[t],o={};o.bound=e.bound,o.margin=51,o.marginReal=o.margin/h.res,o.width=Math.abs(e.bound.left-e.bound.right),o.center={x:(e.bound.left+e.bound.right)/2,y:(e.bound.top+e.bound.bottom)/2},this.ajkJson.img_info=o},wo.prototype.createAjkRoomForTag=function(t){var e=[];for(var o in t){var n={},i={},s=t[o];i.area=s.des,i.name=s.title,i.tagId=s.vectorId,i.floor=b.getCurrentFloor(),n.x=s.center.x,n.y=s.center.y,n.z=0,i.labelPos=n,i.group=-1,e.push(i)}return e},wo.prototype.setRoomsGroup=function(){for(var t=[],e=b.getAngle(),o=0;o<this.ajkJson.rooms.length;++o){t=[];for(var n=[],i=0;i<ko.rooms[o].pointIds.length;++i){var s=b.getPoint(ko.rooms[o].pointIds[i]);n.push({x:s.x,y:s.y})}for(var r=0;r<this.cameraJson.sweepLocations.length;++r){var l=h.getVectorForRotate(this.cameraJson.sweepLocations[r].puck,e);Y.isPointInPoly(l,n)&&(this.ajkJson.rooms[o].group=parseInt(this.ajkJson.rooms[o].tagId.replace("Tag","")),t.push(r))}if(void 0!==this.ajkJson.rooms[o].group&&0!=t.length){for(var a=null,c=0;c<t.length;++c){a=t[c]}this.cameraJson.sweepLocations[a].group=this.ajkJson.rooms[o].group,console.log("安居客图片生成成功："+this.ajkJson.rooms[o].name)}else this.ajkJson.rooms.splice(o,1),ko.rooms.splice(o,1),--o}};var Wo=function(){};Wo.prototype.init=function(t){return this.layer=t,this},Wo.prototype.use=function(t,e){if(!this[t])return"DataAJK"==t&&(this[t]=new wo(this.layer,e)),this},Wo.prototype.start=function(t){return this[t]?this[t].start():Promise.reject()};var Fo=new Wo,Co=function(t){function e(e,o){t.call(this),this.app=e,this.load=new It(this),this.analyService=new _t(this),this.uiControl=new be(this),this.renderer=new qe(this),this.history=new vo(this),this.sync=Fo.init(this),this.panos=[],this.startX=null,this.startY=null,this.player=this.app.core.get("Player"),this.display=!1,o&&o.padding&&xt.padding(o.padding),this.app.store.getAppImage("images/cad/cad_enter_dark.png").then((function(t){rt.setEnterImg(t)})),this.app.store.getAppImage("images/cad/compass-white.png").then((function(t){ze.setWhiteImg(t)})),this.app.store.getAppImage("images/cad/compass-black.png").then((function(t){ze.setBlackImg(t)})),Promise.all([this.app.store.getAppImage("images/cad/hall.png"),this.app.store.getAppImage("images/cad/room.png"),this.app.store.getAppImage("images/cad/other.png")]).then((function(t){ue.setHallImg(t[0]),ue.setDefaultImg(t[1]),ue.setOtherImg(t[2])}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var o={isChanged:{configurable:!0},isCurrentFloorEmpty:{configurable:!0}};return e.prototype.init=function(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.initPanos(),Ke.initContext(this.canvas),this.bindEvents()},e.prototype.initPanos=function(){for(var t=this.app.core.get("Player").model.panos.list,e=0;e<t.length;++e){var o=t[e];this.panos[o.floorIndex]||(this.panos[o.floorIndex]=[]),this.panos[o.floorIndex].push({vectorId:o.id,x:o.position.x,y:-1*o.position.z,name:"pano"})}},e.prototype.render=function(){var t=this;null==h.center&&h.init(this.canvas);var e=this.app.core.get("CameraControls").activeControl.camera;h.setRes(e.left,e.right),h.setInitInfo(h.res,h.width,h.height);var o=b.getAngle();o=parseFloat(o);var n=h.getScreenInfoForCAD();n.floorPlanAngle=o,xt.updateRegion(),xt.update(),this.app.core.get("CameraControls").emit("syncCadAnd3D",n),this.app.core.get("SceneRenderer").resizeListeners.push({setSize:function(e,n){if(t.display){h.updateForCanvas(t.canvas),h.updateResForReSize(e,n,o),xt.updateRegion(),xt.update(),t.renderer.autoRedraw();var i=h.getScreenInfoForCAD();i.floorPlanAngle=b.getAngle(),t.app.core.get("CameraControls").emit("syncCadAnd3D",i)}}}),this.history.init(),this.renderer.autoRedraw();var i=this.app.store.getValue("flooruser");i.unit&&(this.$xui.currentUnit=i.unit,xt.unit=i.unit,mt.convertUnit(i.unit),this.renderer.autoRedraw())},e.prototype.reRender=function(){h.init(this.canvas);var t=h.getScreenInfoForCAD();t.floorPlanAngle=b.getAngle(),this.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",t);var e=this.app.core.get("CameraControls").activeControl.camera;h.setRes(e.left,e.right),h.setInitInfo(h.res,h.width,h.height),xt.updateRegion(),xt.update(),this.history.init(),this.renderer.autoRedraw()},e.prototype.show=function(){var t=this;return new Promise((function(e){t.display=!0,t.app.MinMap.hide(),t.app.Camera.floorplan().then((function(){t.player.model.floorplanCadImg.displayCad(!1),t.player.labelManager.hide(),t.app.Camera.setCompassDisplay(!1),t.app.dom.querySelector("[xui_edit_cad]").style.display="block",t.div?(t.canvas.width=t.canvas.clientWidth,t.canvas.height=t.canvas.clientHeight):(t.div=t.app.dom.querySelector("[xui_edit_cad]"),t.canvas=t.app.dom.querySelector("[xui_edit_cad] canvas"),t.init());var o=t.app.core.get("Player").model.currentFloor.floorIndex;b.setCurrentFloor(o),t.load.loadFloorJson().then((function(){t.app.core.get("Player").gotoFloor(b.currentFloor),t.render(),t.uiControl.showTexture||(t.app.dom.querySelector('.player[name="main"]').style.visibility="hidden"),e(),t.emit("show")}))})),t.div||document.addEventListener("keydown",t.onKeydown.bind(t))}))},e.prototype.hide=function(){this.uiControl.showTexture||(this.app.dom.querySelector('.player[name="main"]').style.visibility="visible"),this.display=!1,this.$xui.selectName=null,this.$xui.currentName=null,this.$xui.currentAttributes={},this.app.Camera.setCompassDisplay(!0),this.app.dom.querySelector("[xui_edit_cad]").style.display="none";var t=this.app.core.get("CameraControls").controls.floorplan;t.camera.position.copy(t.target),t.recoverToUpdate(),this.player.model.floorplanCadImg.displayCad(!0),this.player.labelManager.hide(),this.app.MinMap.display=null,this.emit("hide")},e.prototype.padding=function(t){xt.padding(t)},e.prototype.bindEvents=function(){this.div.addEventListener("contextmenu",(function(t){t.preventDefault()})),this.div.addEventListener("mousedown",this.onMouseDown.bind(this)),this.div.addEventListener("mousemove",this.onMouseMove.bind(this)),this.div.addEventListener("mouseup",this.onMouseUp.bind(this)),this.div.addEventListener("mousewheel",this.onWheel.bind(this)),this.div.addEventListener("DOMMouseScroll",this.onWheel.bind(this))},e.prototype.onMouseDown=function(t){if(null!=h.defaultCenter){if(this.app.core.get("CameraControls").onMouseDown(t),this.startX=t.offsetX||t.layerX,this.startY=t.offsetY||t.layerY,this.lastX=t.offsetX||t.layerX,this.lastY=t.offsetY||t.layerY,2==t.button)return this.stopAddVector(),void this.renderer.autoRedraw();var e=yt.getEventName();if(e==Bt){if(!this.setNewWallPoint("start",{x:this.startX,y:this.startY}))return}else if(e==Yt){if(!this.setNewWallPoint("end",{x:this.startX,y:this.startY}))return;if(!Le.canAdd)return;Le.buildWall(this.uiControl.selectUI==qt),this.history.save()}else{var o=yt.getSelectItem();o&&yt.setDraggingItem(o),this.$xui.hideProps()}this.setEventName("mouseDown"),t.preventDefault(),t.stopPropagation()}},e.prototype.onMouseMove=function(t){if(null!=h.defaultCenter){var e=t.offsetX||t.layerX,o=t.offsetY||t.layerY,n=e-this.lastX,i=o-this.lastY,s=h.getXYFromScreen({x:e,y:o}),r=yt.getEventName();if(null!=r&&!this.dragging){if(!(Math.abs(e-this.startX)>c||Math.abs(o-this.startY)>c))return;this.dragging=!0}var l=!1,a=yt.getDraggingItem();switch(r){case null:l=Lt.start(s);break;case Nt:yt.clearItems(),h.center.x=h.center.x-n*g/h.zoom/h.res,h.center.y=h.center.y+i*g/h.zoom/h.res,this.lastX=e,this.lastY=o,l=!0;var d=b.getAngle(),p=h.getScreenInfoForCAD();p.floorPlanAngle=d,this.app.core.get("CameraControls").emit("syncCadAnd3D",p);break;case Bt:yt.clearDraggingItem(),yt.clearFocusItem(),l=!0,Lt.start(s),Lt.modifyPoint&&(s={x:Lt.modifyPoint.x,y:Lt.modifyPoint.y}),At.execute(null,s),At.setStartAddWall(s),At.showStartAddWall();break;case Yt:yt.clearDraggingItem(),yt.clearFocusItem(),l=!0,Lt.start(s);var y={x:Le.startInfo.position.x,y:Le.startInfo.position.y};if(Lt.modifyPoint&&(s={x:Lt.modifyPoint.x,y:Lt.modifyPoint.y}),At.execute(y,s),At.setStartAddWall(s),At.newWall.display){if(!Lt.modifyPoint&&Le.startInfo.linkedPointId){var u=At.checkAngle(s,Le.startInfo.linkedPointId,null);u&&Y.clonePoint(s,u)}At.setNewWallEndPosition(s)}else At.setNewWall(y,s),At.showNewWall();Le.canAdd=Le.canAddWallForEnd(s),Le.canAdd?this.uiControl.selectUI==qt?At.setNewWallState("normal-out"):At.setNewWallState("normal"):At.setNewWallState("error");break;case jt:yt.clearFocusItem(),n=n*g/h.zoom,i=i*g/h.zoom;var x=Ae.moveWallPlane(a.vectorId,n,i);1==x?(this.lastX=e,this.lastY=o,l=!0):2==x||(3==x?(this.history.save(),yt.clearSelectItem(),yt.clearDraggingItem(),yt.clearEventName(),Lt.clear(),l=!0):4==x?(this.lastX=e,this.lastY=o,this.startX=e,this.startY=o,l=!0):5==x&&(this.lastX=e,this.lastY=o)),Ae.needUpdateRoom;break;case Xt:yt.clearFocusItem();var f=b.getPoint(a.vectorId);Lt.start(s,a.vectorId,f.parent),Lt.modifyPoint&&(s={x:Lt.modifyPoint.x,y:Lt.modifyPoint.y}),At.execute(null,s),Ae.movePoint(a.vectorId,s,Lt.modifyPoint)||At.hideAll(),l=!0;break;case Jt:if(yt.clearFocusItem(),Lt.start(s),Lt.wallInfo.wallId)if(l=!0,null==a){var m=this.uiControl.getSymbolTypeForUI(),v=rt.addSymbol(s,m,Lt.wallInfo.wallId);if(v){yt.setSelectItem(v,m,z),yt.setDraggingItem(yt.selectItem);var P=b.getSymbol(v);P.len=Y.getDistance(P.startPoint,P.endPoint)}}else We.moveFullSymbol(s,a.vectorId,Lt.wallInfo.wallId);else l=!1;break;case Ut:yt.clearFocusItem(),Lt.start(s),l=!0,null!=a&&rt.isSymbol(a.type)&&We.moveFullSymbol(s,a.vectorId,Lt.wallInfo.wallId);break;case Vt:yt.clearFocusItem(),l=!0,null!=a&&rt.isSymbol(a.type)&&We.moveSymbolPoint(s,a.vectorId,a.selectIndex);break;case $t:if(l=!0,null==a){var I=this.uiControl.getComponentTypeForUI(),S=dt.createComponent(s,I);S.vectorId&&(yt.setSelectItem(S.vectorId,I,z),yt.setDraggingItem(yt.selectItem))}else{Ce.moveFullComponent(s,a.vectorId)&&(this.lastX=e,this.lastY=o,this.startX=e,this.startY=o,this.dragging=!1)}break;case Ht:if(yt.clearFocusItem(),l=!0,null!=a&&dt.isComponent(a.type))Ce.moveFullComponent(s,a.vectorId)&&(this.lastX=e,this.lastY=o,this.startX=e,this.startY=o,this.dragging=!1);break;case zt:if(l=!0,null==a){var k=mt.createTag(s);k.vectorId&&(yt.setSelectItem(k.vectorId,N,z),yt.setDraggingItem(yt.selectItem))}else De.moveFullTag(s,a.vectorId);break;case Gt:yt.clearFocusItem(),l=!0,null!=a&&De.moveFullTag(s,a.vectorId)}l&&this.renderer.autoRedraw()}},e.prototype.onMouseUp=function(t){if(null!=h.defaultCenter){var e=t.offsetX||t.layerX,o=t.offsetY||t.layerY;this.app.core.get("CameraControls").onMouseUp(t);var n=yt.getEventName(),i=yt.getDraggingItem(),s=null;this.dragging||i&&i.vectorId&&(s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},yt.setFocusItem(s),this.uiControl.showAttributes()),h.getXYFromScreen({x:e,y:o});var r=null;switch(n){case Nt:yt.clearFocusItem(),this.uiControl.currentUI=null;break;case Xt:At.hideAll();var l=b.getPoint(i.vectorId);l&&(null==s?(Lt.start(l,i.vectorId,l.parent),Lt.modifyPoint&&Lt.modifyPoint.hasOwnProperty("linkedPointId")?H.moveTo(i.vectorId,Lt.modifyPoint.linkedPointId):Lt.modifyPoint&&(Lt.modifyPoint.linkedPointIdX||Lt.modifyPoint.linkedPointIdY)?(Y.clonePoint(l,Lt.modifyPoint),rt.updateSymbolsPositionsForWallCorner(i.vectorId)):Lt.modifyPoint&&Lt.modifyPoint.hasOwnProperty("linkedWallId")&&(l=H.createPoint(Lt.modifyPoint.x,Lt.modifyPoint.y),H.splitWall(Lt.modifyPoint.linkedWallId,l.vectorId,"start"),H.moveTo(i.vectorId,l.vectorId)),this.history.save()):this.uiControl.currentUI=s.type);break;case Yt:if(Le.startInfo&&Le.startInfo.linkedPointId){var a=b.getPoint(Le.startInfo.linkedPointId);Le.endInfo.position&&Object.keys(a.parent).length>1&&(yt.clearEventName(),Le.clear(),At.hideAll())}break;case jt:if(null!=s&&s.type==W){var c=b.getWall(s.vectorId);c.import||c.out?this.uiControl.currentUI="OutWall":this.uiControl.currentUI=s.type}else this.history.save();break;case Jt:s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},yt.setFocusItem(s),this.uiControl.showAttributes(),this.uiControl.currentUI=s.type,this.history.save();break;case Ut:r=b.getSymbol(i.vectorId),null!=s&&rt.isSymbol(s.type)?this.uiControl.currentUI=s.type:r&&(r.len=null,this.history.save());break;case Vt:null!=s&&rt.isSymbol(s.type)?this.uiControl.currentUI=s.type:this.history.save();break;case $t:s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},yt.setFocusItem(s),this.uiControl.showAttributes(),this.uiControl.currentUI=s.type,this.history.save();break;case Ht:null!=s&&dt.isComponent(s.type)?this.uiControl.currentUI=s.type:this.history.save();break;case Gt:null!=s&&s.type==N?this.uiControl.currentUI=s.type:this.history.save();break;case zt:if(null==s)b.getTag(i.vectorId).setAdding(!1),s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},yt.setFocusItem(s),this.history.save();this.uiControl.currentUI=s.type}this.setEventName("mouseUp"),yt.clearDraggingItem(),this.renderer.autoRedraw(),this.dragging=!1}},e.prototype.onWheel=function(t){if(null!=h.defaultCenter){t.preventDefault();var e=t.type;if("DOMMouseScroll"==e||"mousewheel"==e){var o=t.wheelDelta?t.wheelDelta/120*2:-(t.detail||0)/3*2,n=h.zoom+o;if(n<14)return;h.updateZoom(n);var i=h.getScreenInfoForCAD();i.floorPlanAngle=b.getAngle(),this.app.core.get("CameraControls").emit("syncCadAnd3D",i),this.renderer.autoRedraw()}}},e.prototype.onKeydown=function(t){if(this.display)if(t.ctrlKey&&"KeyZ"==t.code){if(!this.$xui.toolbar.recall)return;this.revokeHistory(),console.log("ctrl+z")}else if(t.ctrlKey&&"KeyY"==t.code){if(!this.$xui.toolbar.recover)return;this.recoveryHistory(),console.log("ctrl+y")}else"Delete"==t.code?(this.deleteItem(),this.$xui.hideProps(),this.history.save(),this.renderer.autoRedraw(),console.log("Delete")):"Escape"==t.code&&(this.stopAddVector(),this.renderer.autoRedraw(),console.log("Esc"))},e.prototype.updateEventNameForSelectUI=function(){At.hideAll(),yt.clearItems(),this.uiControl.selectUI==Kt||this.uiControl.selectUI==qt?yt.setEventName(Bt):this.uiControl.selectUI==Qt||this.uiControl.selectUI==Zt||this.uiControl.selectUI==te||this.uiControl.selectUI==ee||this.uiControl.selectUI==oe||this.uiControl.selectUI==ne||this.uiControl.selectUI==ie?yt.setEventName(Jt):this.uiControl.selectUI==se||this.uiControl.selectUI==re||this.uiControl.selectUI==le?yt.setEventName($t):this.uiControl.selectUI==ae&&yt.setEventName(zt)},e.prototype.setEventName=function(t){var e=yt.getEventName();if("mouseDown"==t)if(null==e){var o=yt.getSelectItem();if(null==o)yt.setEventName(Nt);else if(o.type==W)yt.setEventName(jt);else if(o.type==w)yt.setEventName(Xt);else if(rt.isSymbol(o.type))if(o.selectIndex==z||o.selectIndex==q){yt.setEventName(Ut);var n=b.getSymbol(o.vectorId);n.len=Y.getDistance(n.startPoint,n.endPoint)}else o.selectIndex!=G&&o.selectIndex!=K||yt.setEventName(Vt);else dt.isComponent(o.type)?yt.setEventName(Ht):o.type==N&&yt.setEventName(Gt)}else e==Bt&&yt.setEventName(Yt);else"mouseUp"==t&&(e==zt?yt.clearEventName():e!=Bt&&e!=Yt&&(yt.clearEventName(),null!=this.uiControl.selectUI&&this.uiControl.clearUI()))},e.prototype.exit=function(){yt.clearItems(),yt.clearEventName(),this.uiControl.clearUI()},e.prototype.stopAddVector=function(){var t=yt.getEventName();if(t!=Yt){yt.clearEventName();var e=yt.getDraggingItem();t==Jt?e&&e.vectorId&&rt.deleteSymbol(e.vectorId):t==$t&&e&&e.vectorId&&b.deleteComponent(e.vectorId)}else yt.setEventName(Bt);this.uiControl.clearUI(),At.hideAll()},e.prototype.setNewWallPoint=function(t,e){return"select"!=Lt.symbolInfo.state&&(("start"==t||"end"==t)&&(Lt.modifyPoint?Le.setPointInfo(t,Lt.modifyPoint):Le.setPointInfo(t,h.getXYFromScreen(e)),!0))},e.prototype.reload=function(){var t=this;return Et.clearHistoryRecord(),this.$xui.toolbar.recall=!1,this.$xui.toolbar.recover=!1,b.clear(),h.clear(),this.load.loadFloorJson(!0).then((function(){t.reRender()}))},e.prototype.update=function(){this.app.store.getValue("metadata").floorPlanUser=1,this.app.core.get("Player").model.floorplanCadImg.updatePlanes(),this.app.MinMap.reload(),this.renderer.autoRedraw(),this.div.style.visibility="visible"},e.prototype.exportImages=function(){this.div.style.visibility="hidden",this.stopAddVector();var t=b.getFloorData();return 0==Object.keys(t.points).length&&0==Object.keys(t.components).length&&0==Object.keys(t.tags).length?(this.div.style.visibility="visible",null):this.load.uploadCad()},e.prototype.exportJSON=function(t){return xe.start(),this.app.store.getValue("flooruser").cadInfo=t,console.log(t,"----before"),{cadInfo:t,version:l.version,floors:l.floors,unit:xt.unit,angle:b.getAngle(),currentId:b.getCurrentId(),compass:b.getCompass()}},e.prototype.importJSON=function(){},o.isChanged.get=function(){return Et.hasRecords()},o.isCurrentFloorEmpty.get=function(){var t=b.getFloorData();return 0==Object.keys(t.points).length&&0==Object.keys(t.components).length&&0==Object.keys(t.tags).length},e.prototype.revokeHistory=function(){this.history.goPreState(),this.renderer.autoRedraw(),Et.getHistoryState().pre?this.$xui.toolbar.recall=!0:this.$xui.toolbar.recall=!1,this.$xui.toolbar.recover=!0},e.prototype.recoveryHistory=function(){this.history.goNextState(),this.renderer.autoRedraw(),Et.getHistoryState().next?this.$xui.toolbar.recover=!0:this.$xui.toolbar.recover=!1,this.$xui.toolbar.recall=!0},e.prototype.deleteItem=function(){var t=yt.getFocusItem();t&&(t.type==W?b.deleteWall(t.vectorId):rt.isSymbol(t.type)?rt.deleteSymbol(t.vectorId):dt.isComponent(t.type)?b.deleteComponent(t.vectorId):t.type==N?b.deleteTag(t.vectorId):t.type==w&&H.deleteWallCorner(t.vectorId),this.history.save(),this.renderer.autoRedraw())},Object.defineProperties(e.prototype,o),e}(KanKan.MITT.Emiter);function To(t){return{$template:"#kankan-xui-combox",expanded:!1,index:t.index||0,list:t.list||[],style:t.style||{},dropdown:function(){this.expanded=!this.expanded},selected:function(e){this.index!=e&&(this.index=e,t.change&&t.change(this.list[this.index]))}}}return document.querySelector("#kankan-xui-combox")||document.body.insertAdjacentHTML("beforeend",'<template id="kankan-xui-combox"> <div class="kankan-app_combox" :style="style" @click="dropdown"> <i class="inner-icon iconfont" :class="[expanded?\'sdk-pull-up\':\'sdk-pull-down\']"></i> <div class="inner-text"> {{(list[index] || {}).text}} </div> <div class="inner-list" v-show="expanded"> <div v-for="(item,index) in list" @click="selected(index)">{{item.text}}</div> </div> </div> </template> '),function(t){var e=KanKan.Deferred();return t.Scene.on("loaded",(function(){var o=new Co(t);o.$load=function(){PetiteVue.createApp({compassURL:t.resource.getAppURL("images/cad_compass.png"),show:!1,props:{},floors:t.store.getValue("floorcad").floors.map((function(t){return{value:t.subgroup,text:t.name}})),selectName:null,currentName:null,currentAttributes:{},currentFloor:0,currentUnit:"m",compassRate:0,type:"draw",toolbar:{recall:!1,recover:!1,clear:!1,default:!0,rotate:!0,download:!0,flex:!0,panos:!0,texture:!0,unit:!0},values:{panos:!0,texture:!0},list:[{name:"wall",list:[{icon:"sdk-neiqiang",name:"Wall",text:"内墙"},{icon:"sdk-waiqiang",name:"OutWall",text:"外墙"}]},{name:"door",list:[{icon:"sdk-men",name:"SingleDoor",text:"门"},{icon:"sdk-shuangkaimen",name:"DoubleDoor",text:"双开门"},{icon:"sdk-yimen",name:"SlideDoor",text:"移门"},{icon:"sdk-yakou",name:"Pass",text:"垭口"}]},{name:"window",list:[{icon:"sdk-chuang",name:"SingleWindow",text:"窗"},{icon:"sdk-piaochuang",name:"BayWindow",text:"飘窗"},{icon:"sdk-luodichuang",name:"FrenchWindow",text:"落地窗"}]},{name:"structure",list:[{icon:"sdk-zhuzi",name:"Beam",text:"柱子"},{icon:"sdk-yandao",name:"Flue",text:"烟道"},{icon:"sdk-loudao",name:"Corridor",text:"楼道"}]},{name:"tag",list:[{icon:"sdk-dange",name:"Tag",text:"标注"}]}],create:function(){o.$xui=this},hide:function(){o.hide()},showProps:function(t){"compass"==t&&(o.uiControl.showAttributes("compass"),this.compassRate=this.currentAttributes.compass),this.currentName=t;for(var e=null,n=0;n<this.list.length;n++){var i=this.list[n].list.find((function(e){return e.name==t}));if(i){e=i;break}}this.props=null==e?{name:t}:e},hideProps:function(){this.currentName=null,this.selectName=null,this.props={},this.currentAttributes={}},menu:function(t){void 0!==this.values[t]?(this.values[t]=!this.values[t],o.uiControl.execute(t,this.values[t])):o.uiControl.execute(t)},selected:function(t){o.uiControl.selectUI=t},setType:function(t){this.type=t},setFloor:function(e){o.uiControl.currentFloor=this.currentFloor=e.value,t.Scene.gotoFloor(e.value)},setUnit:function(t){o.uiControl.currentUnit=this.currentUnit=t.value},setProps:function(t,e){void 0!==e&&(this.currentAttributes[t]=e,this.compassRate=e),"compass"==t&&(console.log(e),e>=360&&(console.log("超过了"),e=360,this.compassRate=0,this.currentAttributes.compass=360)),o.uiControl.setAttributes(this.props.name,t,e),-1!="split,default,remove".indexOf(t)&&this.hideProps()},$t:s,Combox:To}).mount(t.dom.querySelector("[xui_design_cad]")),t.CadManager.install(o)},o.$html='<div v-cloak v-scope xui_edit_cad @vue:mounted="create"> <canvas></canvas> <div class="compass" :style="`background-image:url(${compassURL});transform:rotate(${compassRate}deg);`" @click="showProps(\'compass\')"></div> <div class="tool" @click.stop @mouseup.stop @mousemove.stop @mousedown.stop @mouseenter.stop> <ul> <li> <div class="title">{{$t(\'cad.floor\')}}<i class="iconfont sdk-close" @click="hide"></i></div> <div v-scope="Combox({index:0,list:floors,change:setFloor})"></div> </li> <li> \x3c!-- <div class="tabs">\r\n                    <div class="left" :class="{active:type == \'draw\'}" @click="setType(\'draw\')">绘制结构</div>\r\n                    <div class="right" :class="{active:type == \'gear\'}" @click="setType(\'gear\')">{{$t(\'cad.wall.s\')}}</div>\r\n                </div> --\x3e <div class="cate" v-for="cate in list"> <span>{{$t(\'cad.classify.\'+cate.name)}}</span> <div class="item"> <div v-for="item in cate.list" :class="{active: item.name == selectName}" @click="selected(item.name,item.text)"> <i class="iconfont" :class="[item.icon]"></i> </div> </div> </div> </li> </ul> </div> <div class="prop kankan-app__slide-right" :class="[props.name?\'kankan-app__slide-right-enter\':\'kankan-app__slide-right-leave\']" @click.stop @mouseup.stop @mousemove.stop @mousedown.stop @mouseenter.stop> <ul> <li> <div class="title">{{$t(\'cad.items.\'+props.name)}}{{$t(\'cad.attribute\')}}<i class="iconfont sdk-close" @click="hideProps"></i></div> </li> <li v-show="[\'SingleDoor\',\'DoubleDoor\',\'SlideDoor\',\'Pass\'].indexOf(props.name)!=-1"> <div class="between" v-show="props.name!=\'Pass\'"> <span>翻转</span> <i class="iconfont sdk-fanzhuan" @click="setProps(\'rotate\')"></i> </div> <div class="between"> <span>宽度</span> <span><input type="text" :value="currentAttributes.width || 1.94" style="width: 40px; height: 24px; text-align: center" @change="setProps(\'width\',$event.target.value)">&nbsp;{{currentUnit}}</span> </div> <div class="between" v-show="props.name == \'SingleDoor\'"> <span>入户门</span> <i class="iconfont" :class="[currentAttributes.enter?\'sdk-checked\':\'sdk-uncheck\']" style="color: #00c8af" @click="setProps(\'enter\',!currentAttributes.enter)"></i> </div> <div class="between" v-show="props.name == \'SingleDoor\'"> <span>进入方向</span> <i class="iconfont sdk-fanzhuan" :class="{disable:!currentAttributes.enter}" @click="setProps(\'direction\')"></i> </div> </li> <li v-show="[\'SingleWindow\',\'BayWindow\',\'FrenchWindow\'].indexOf(props.name)!=-1"> <div class="between" v-show="props.name == \'BayWindow\'"> <span>翻转</span> <i class="iconfont sdk-fanzhuan" @click="setProps(\'rotate\')"></i> </div> <div class="between"> <span>宽度</span> <span><input type="text" :value="currentAttributes.width || 0.8" style="width: 40px; height: 24px; text-align: center" @change="setProps(\'width\',$event.target.value)">&nbsp;{{currentUnit}}</span> </div> </li> <li v-show="[\'Beam\',\'Flue\',\'Corridor\'].indexOf(props.name)!=-1"> <div class="between" v-show="[\'Beam\',\'Flue\'].indexOf(props.name)!=-1"> <span>翻转角度</span> <span> <i class="iconfont sdk-cad-turn" style="color: #00c8af" @click="setProps(\'rotate\')"></i>&nbsp; <input type="text" :value="currentAttributes.rotate || 0" style="width: 40px; height: 24px; text-align: center" @change="setProps(\'rotate\',$event.target.value)">&nbsp;° </span> </div> <div class="between"> <span>宽度</span> <span><input type="text" :value="currentAttributes.width || 0.65" style="width: 40px; height: 24px; text-align: center" @change="setProps(\'width\',$event.target.value)">&nbsp;{{currentUnit}}</span> </div> <div class="between" v-show="[\'Beam\',\'Flue\'].indexOf(props.name)!=-1"> <span>厚度</span> <span><input type="text" :value="currentAttributes.thickness || 0.65" style="width: 40px; height: 24px; text-align: center" @change="setProps(\'thickness\',$event.target.value)">&nbsp;{{currentUnit}}</span> </div> <div class="between" v-show="props.name == \'Corridor\'"> <span>高度</span> <span><input type="text" :value="currentAttributes.height || 0.65" style="width: 40px; height: 24px; text-align: center" @change="setProps(\'height\',$event.target.value)">&nbsp;{{currentUnit}}</span> </div> </li> <li v-show="props.name==\'Tag\'"> <div> <input type="text" :value="currentAttributes.tag || \'\'" @input="setProps(\'tag\',$event.target.value)" placeholder="请输入名称"> </div> <div> <input type="text" :value="currentAttributes.area || \'\'" @input="setProps(\'area\',$event.target.value)" placeholder="输入面积，支持小数点后面两位"> <span style="position: absolute; right: 4px; top: 8px; font-size: 12px">{{currentUnit == \'ft\'?\'ft²&nbsp;\':\'m²\'}}</span> </div> </li> <li v-show="props.name==\'compass\'"> <div class="between"> <span>旋转角度</span> <div> <i class="iconfont sdk-cad-turn" style="color: #00c8af" @click="setProps(\'compass\',compassRate+=90)"></i>&nbsp; <span><input type="text" :value="currentAttributes.compass || 0" style="width: 40px; height: 24px; text-align: center" @input="setProps(\'compass\',$event.target.value)">°</span> </div> </div> </li> \x3c!-- <li v-show="props.name!=\'compass\'"> --\x3e <li> <div class="between"> <button @click="setProps(\'split\')" v-if="[\'Wall\',\'OutWall\'].indexOf(props.name)!=-1">{{$t(\'cad.split\')}}</button> <button @click="setProps(\'default\')" v-if="[\'Wall\',\'OutWall\',\'Tag\',\'WallCorner\'].indexOf(props.name)==-1">{{$t(\'cad.toolbar.default\')}}</button> <button v-if="[\'compass\'].indexOf(props.name)==-1" @click="setProps(\'remove\')">{{$t(\'cad.remove\')}}</button> </div> </li> </ul> </div> <div class="menu" @click.stop @mouseup.stop @mousemove.stop @mousedown.stop @mouseenter.stop> <ul> <li> <div @click="menu(\'recall\')" :class="{disable:!toolbar.recall}"><i class="iconfont sdk-repeal"></i>{{$t(\'cad.toolbar.recall\')}}</div> <div @click="menu(\'recover\')" :class="{disable:!toolbar.recover}"><i class="iconfont sdk-recover"></i>{{$t(\'cad.toolbar.recover\')}}</div> <div @click="menu(\'clear\')" :class="{disable:!toolbar.clear}"><i class="iconfont sdk-clear"></i>{{$t(\'cad.toolbar.clear\')}}</div> </li> <li> <div @click="menu(\'default\')" :class="{disable:!toolbar.default}"><i class="iconfont sdk-reset"></i>{{$t(\'cad.toolbar.default\')}}</div> <div @click="menu(\'rotate\')" :class="{disable:!toolbar.rotate}"><i class="iconfont sdk-rotate"></i>{{$t(\'cad.toolbar.rotate\')}}</div> </li> <li> <div @click="menu(\'download\')" :class="{disable:!toolbar.download}"><i class="iconfont sdk-download"></i>{{$t(\'cad.toolbar.download\')}}</div> </li> <li> <div @click="menu(\'flex\')" :class="{disable:!toolbar.flex}"><i class="iconfont sdk-adapt"></i>{{$t(\'cad.toolbar.flex\')}}</div> <div @click="menu(\'panos\')" :class="{disable:!toolbar.panos}"> <i class="iconfont" :class="[values.panos?\'sdk-checked\':\'sdk-uncheck\']" style="color: #00c8af"></i>{{$t(\'cad.toolbar.panos\')}} </div> <div @click="menu(\'texture\')" :class="{disable:!toolbar.texture}"> <i class="iconfont" :class="[values.texture?\'sdk-checked\':\'sdk-uncheck\']" style="color: #00c8af"></i>{{$t(\'cad.toolbar.texture\')}} </div> </li> <li> <div> <span>{{$t(\'cad.toolbar.unit\')}}:</span> <div style="margin-left: 10px" v-scope="Combox({change:setUnit,index:0,list:[{text:\'m\',value:\'m\'},{text:\'ft\',value:\'ft\'}],style:{height:\'24px\',width:\'60px\'}})"></div> </div> </li> </ul> </div> </div> <style> [xui_edit_cad] {\r\n        display: none;\r\n        position: absolute;\r\n        pointer-events: all;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n    [xui_edit_cad] .compass {\r\n        width: 64px;\r\n        height: 64px;\r\n        position: absolute;\r\n        background-size: cover;\r\n        background-repeat: no-repeat;\r\n        right: 280px;\r\n        top: 130px;\r\n        cursor: pointer;\r\n    }\r\n    [xui_edit_cad] ul,\r\n    [xui_edit_cad] li {\r\n        margin: 0;\r\n        padding: 0;\r\n        list-style: none;\r\n    }\r\n    [xui_edit_cad] canvas {\r\n        position: absolute;\r\n        width: 100%;\r\n        height: 100%;\r\n        top: 0;\r\n        left: 0;\r\n    }\r\n    [xui_edit_cad] .prop,\r\n    [xui_edit_cad] .tool {\r\n        position: absolute;\r\n        width: 240px;\r\n        height: 100%;\r\n        top: 0;\r\n        right: 0;\r\n        padding: 10px;\r\n        background: rgba(27, 27, 28);\r\n        z-index: 2;\r\n    }\r\n    [xui_edit_cad] .prop::after,\r\n    [xui_edit_cad] .tool::after {\r\n        position: absolute;\r\n        content: \'\';\r\n        top: 0;\r\n        bottom: 0;\r\n        left: 0;\r\n        border-right: solid 1px rgba(255, 255, 255, 0.16);\r\n        border-left: solid 1px #000;\r\n    }\r\n    [xui_edit_cad] .prop .sdk-close,\r\n    [xui_edit_cad] .tool .sdk-close {\r\n        /* position: absolute;\r\n        right: 10px;\r\n        top: 10px; */\r\n        color: #999;\r\n        cursor: pointer;\r\n    }\r\n    [xui_edit_cad] .prop .sdk-close:hover,\r\n    [xui_edit_cad] .tool .sdk-close:hover {\r\n        color: #fff;\r\n    }\r\n    [xui_edit_cad] .prop .title,\r\n    [xui_edit_cad] .tool .title {\r\n        font-size: 16px;\r\n        font-weight: bold;\r\n        margin-top: 10px;\r\n        color: #999;\r\n        display: flex;\r\n        justify-content: space-between;\r\n    }\r\n\r\n    [xui_edit_cad] .tool .outline {\r\n        height: 34px;\r\n        border-radius: 4px;\r\n        border: 1px solid rgba(255, 255, 255, 0.4);\r\n        display: flex;\r\n        justify-content: center;\r\n        align-items: center;\r\n    }\r\n\r\n    [xui_edit_cad] .tool .tabs {\r\n        margin-top: 30px;\r\n        display: flex;\r\n        width: 100%;\r\n    }\r\n\r\n    [xui_edit_cad] .tool .tabs > div {\r\n        cursor: pointer;\r\n        width: 100%;\r\n        display: flex;\r\n        height: 34px;\r\n        border-radius: 4px;\r\n        border: 1px solid rgba(255, 255, 255, 0.4);\r\n        align-items: center;\r\n        justify-content: center;\r\n    }\r\n    [xui_edit_cad] .tool .tabs .left {\r\n        border-top-right-radius: 0;\r\n        border-bottom-right-radius: 0;\r\n        border-right: none;\r\n    }\r\n    [xui_edit_cad] .tool .tabs .right {\r\n        border-top-left-radius: 0;\r\n        border-bottom-left-radius: 0;\r\n        border-left: none;\r\n    }\r\n    [xui_edit_cad] .tool .tabs .active {\r\n        border: 1px solid #00c8af;\r\n        color: #00c8af;\r\n    }\r\n    [xui_edit_cad] .tool .cate {\r\n        color: #fff;\r\n        margin-top: 20px;\r\n    }\r\n    [xui_edit_cad] .tool .item {\r\n        display: flex;\r\n        flex-wrap: wrap;\r\n        color: #999;\r\n    }\r\n    [xui_edit_cad] .tool .item i {\r\n        font-size: 32px;\r\n    }\r\n    [xui_edit_cad] .tool .item > div {\r\n        cursor: pointer;\r\n        width: 48px;\r\n        height: 48px;\r\n        background: rgba(255, 255, 255, 0.05);\r\n        margin-right: 7px;\r\n        margin-top: 10px;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        border: solid 1px transparent;\r\n    }\r\n    [xui_edit_cad] .tool .item .active {\r\n        color: #00c8af;\r\n        border: solid 1px #00c8af;\r\n    }\r\n\r\n    [xui_edit_cad] .prop li,\r\n    [xui_edit_cad] .tool li {\r\n        color: #999;\r\n        font-size: 14px;\r\n        margin-bottom: 20px;\r\n        padding-bottom: 20px;\r\n        border-bottom: solid 1px rgba(255, 255, 255, 0.16);\r\n    }\r\n\r\n    [xui_edit_cad] .prop li:last-child,\r\n    [xui_edit_cad] .tool li:last-child {\r\n        border-bottom: none;\r\n    }\r\n\r\n    [xui_edit_cad] .tool input:focus {\r\n        border: 1px solid #00c8af;\r\n    }\r\n    [xui_edit_cad] .tool li > div {\r\n        margin-top: 10px;\r\n    }\r\n\r\n    [xui_edit_cad] .prop {\r\n        position: absolute;\r\n        width: 240px;\r\n        height: 100%;\r\n        top: 0;\r\n        right: 0;\r\n        padding: 10px;\r\n        background: rgba(27, 27, 28);\r\n        z-index: 2;\r\n    }\r\n    [xui_edit_cad] .prop i {\r\n        cursor: pointer;\r\n    }\r\n    [xui_edit_cad] .prop .sdk-fanzhuan {\r\n        color: var(--main-color);\r\n    }\r\n    [xui_edit_cad] .prop li > div {\r\n        position: relative;\r\n        color: #fff;\r\n        margin-bottom: 15px;\r\n    }\r\n    [xui_edit_cad] .prop li > div:last-child {\r\n        margin-bottom: 0px;\r\n    }\r\n    [xui_edit_cad] .prop li .between {\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: space-between;\r\n    }\r\n    [xui_edit_cad] .prop li .between button:nth-of-type {\r\n        margin-right: 10px;\r\n    }\r\n    [xui_edit_cad] .prop li .between button:last-of-type {\r\n        margin-right: 0px;\r\n    }\r\n    [xui_edit_cad] .menu {\r\n        position: absolute;\r\n        left: 0;\r\n        top: 0;\r\n        width: calc(100% - 240px);\r\n        height: 40px;\r\n        background: rgba(27, 27, 28);\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        z-index: 1;\r\n    }\r\n    [xui_edit_cad] .menu::after {\r\n        position: absolute;\r\n        content: \'\';\r\n        bottom: 0;\r\n        left: 0;\r\n        right: 0;\r\n        border-top: solid 1px rgba(255, 255, 255, 0.16);\r\n        border-bottom: solid 1px #000;\r\n    }\r\n    [xui_edit_cad] .menu ul {\r\n        color: #999;\r\n        font-size: 14px;\r\n        display: flex;\r\n    }\r\n    [xui_edit_cad] .menu li {\r\n        display: flex;\r\n        margin-left: 30px;\r\n        border-right: solid 1px rgba(255, 255, 255, 0.16);\r\n    }\r\n    [xui_edit_cad] .menu li:last-child {\r\n        border-right: none;\r\n    }\r\n    [xui_edit_cad] .menu li > div {\r\n        cursor: pointer;\r\n        margin-right: 30px;\r\n        white-space: nowrap;\r\n        display: flex;\r\n        align-items: center;\r\n        flex-wrap: nowrap;\r\n    }\r\n    [xui_edit_cad] .menu li > div > i {\r\n        margin-right: 3px;\r\n        font-size: 14px;\r\n    }\r\n    [xui_edit_cad] .disable {\r\n        pointer-events: none;\r\n        opacity: 0.5;\r\n    } </style> ',o.$name="DesignCAD",e.resolve(o)})),e}}();
