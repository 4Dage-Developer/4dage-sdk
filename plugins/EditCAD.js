var EditCAD=function(){"use strict";var t=function(){this.version="v4.0",this.floors=[]};t.prototype.initFloor=function(t){this.floors[t]={},this.floors[t].points={},this.floors[t].walls={},this.floors[t].symbols={},this.floors[t].components={},this.floors[t].tags={},this.floors[t].boundingBox={},this.floors[t].rooms=[],this.floors[t].panos=[]};var o=new t;window.floorplanData=o;var i={minPixLen:3,minScreenDis:2,minRealDis:.1,minAdsorb:.1,minAngle:10,maxAngle:170,defaultZoom:100,minSymbolLen:.2,ratio:3,cadImg_Width:5760,cadImg_Height:3240,miniMap_Width:1200,miniMap_Height:1200},s=function(){};s.prototype.getFixed=function(t,e){return e||(e=5),parseFloat(t.toFixed(e))},s.prototype.getDistance=function(t,e){var o=t.x,n=t.y,i=e.x,s=e.y,r=Math.sqrt(Math.pow(o-i,2)+Math.pow(n-s,2));return this.getFixed(r)},s.prototype.createLine1=function(t,e){if(t.x==e.x&&t.y==e.y)return null;if(0==this.getFixed(Math.abs(t.x-e.x)))return{x:t.x};if(0==this.getFixed(Math.abs(t.y-e.y)))return{y:t.y};var o=(t.y-e.y)/(t.x-e.x),n=(t.x*e.y-e.x*t.y)/(t.x-e.x);return 0==this.getFixed(o)?{y:this.getFixed(n)}:{a:this.getFixed(o),b:this.getFixed(n)}},s.prototype.createLine2=function(t,e){if(e==Math.PI/2||e==1.5*Math.PI)return{x:t.x};var o=Math.tan(e),n=t.y-o*t.x;return 0!=o?{a:o,b:n}:{y:t.y}},s.prototype.createLine3=function(t,e){var o={};return void 0===t.a?void 0!==t.x?o.x=e.x:void 0!==t.y&&(o.y=e.y):(o.a=t.a,o.b=e.y-e.x*t.a),o},s.prototype.create2AngleLine=function(t,e,o){return{line1:this.createLine2(t,e-o/2),line2:this.createLine2(t,e+o/2)}},s.prototype.distanceForPoints=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},s.prototype.getParallelLineForDistance=function(t,e){var o={};o.a=t.a,o.b=t.b;var n={};if(n.a=t.a,n.b=t.b,void 0===t.a){if(t.hasOwnProperty("x")){var i=t.x;o.x=i+e,n.x=i-e}else if(t.hasOwnProperty("y")){var s=t.y;o.y=s+e,n.y=s-e}}else{var r=Math.atan(t.a),l=Math.abs(e/Math.cos(r)),a=t.b;o.b=a+l,n.b=a-l}return{line1:o,line2:n}},s.prototype.getEndpoint=function(t,e,o){var n=this.create2AngleLine(t,e,o),i=this.createLine2(t,e);i=this.getLineForPoint(i,t);var s=this.getParallelLineForDistance(i,15),r=this.getIntersectionPoint(n.line1,s.line1),l=this.getIntersectionPoint(n.line1,s.line2),a=this.getIntersectionPoint(n.line2,s.line1),h=this.getIntersectionPoint(n.line2,s.line2),c=this.Angle(t,r,{x:t.x+1,y:t.y}),d=this.Angle(t,l,{x:t.x+1,y:t.y}),p=this.Angle(t,a,{x:t.x+1,y:t.y}),y=this.Angle(t,h,{x:t.x+1,y:t.y});return e>Math.PI&&(e=2*Math.PI-e),Math.abs((c+p)/2-e)<Math.abs((d+y)/2-e)?{p1:r,p2:a}:{p1:l,p2:h}},s.prototype.isClockwise=function(t){for(var e=0,o=0;o<t.length;o++){var n=(o+1)%t.length;e+=t[o].x*t[n].y,e-=t[n].x*t[o].y}return e/2>0},s.prototype.reverse=function(t){for(var e=[],o=t.length-1;o>-1;--o)e.push(t[o]);return e},s.prototype.getIntersectionPoint=function(t,e){if(this.isParallel(t,e))return null;if(void 0===t.a&&void 0!==e.a){if(t.x)return{x:t.x,y:e.a*t.x+e.b};if(t.y)return{x:(t.y-e.b)/e.a,y:t.y}}else if(void 0===e.a&&void 0!==t.a){if(e.x)return{x:e.x,y:t.a*e.x+t.b};if(e.y)return{x:(e.y-t.b)/t.a,y:e.y}}else if(void 0===e.a&&void 0===t.a)return t.hasOwnProperty("x")&&e.hasOwnProperty("y")?{x:t.x,y:e.y}:t.hasOwnProperty("y")&&e.hasOwnProperty("x")?{x:e.x,y:t.y}:null;return t.a==e.a?null:{x:(e.b-t.b)/(t.a-e.a),y:(t.a*e.b-e.a*t.b)/(t.a-e.a)}},s.prototype.getIntersectionPoint2=function(t,e,o,n){var i=(e.y-t.y)*(n.x-o.x)-(t.x-e.x)*(o.y-n.y);return 0==i?null:{x:((e.x-t.x)*(n.x-o.x)*(o.y-t.y)+(e.y-t.y)*(n.x-o.x)*t.x-(n.y-o.y)*(e.x-t.x)*o.x)/i,y:-((e.y-t.y)*(n.y-o.y)*(o.x-t.x)+(e.x-t.x)*(n.y-o.y)*t.y-(n.x-o.x)*(e.y-t.y)*o.y)/i}},s.prototype.getIntersectionPoint3=function(t,e,o,n){var i=this.getIntersectionPoint2(t,e,o,n);if(i){var s=i.x,r=i.y;return(s-t.x)*(s-e.x)<=.001&&(r-t.y)*(r-e.y)<=.001&&(s-o.x)*(s-n.x)<=.001&&(r-o.y)*(r-n.y)<=.001?{x:s,y:r}:null}return null},s.prototype.getIntersectionPoint4=function(t,e,o){var n=this.createLine1(t,e),i=this.getIntersectionPoint(n,o);return null==i?null:this.PointInSegment(i,t,e)?i:null},s.prototype.isParallel=function(t,e){return void 0===t.a&&void 0===e.a?!(!t.hasOwnProperty("x")||!e.hasOwnProperty("x"))||!(!t.hasOwnProperty("y")||!e.hasOwnProperty("y")):void 0!==t.a&&void 0!==e.a&&this.getFixed(t.a)==this.getFixed(e.a)},s.prototype.Angle=function(t,e,o){var n,i,s=0,r=e.x-t.x,l=e.y-t.y,a=o.x-t.x,h=o.y-t.y;return s=r*a+l*h,i=(r*r+l*l)*(a*a+h*h),(s/=Math.sqrt(i))>=1?0:s<=-1?Math.PI:180*(n=Math.acos(s))/Math.PI<180?n:2*Math.PI-n},s.prototype.getLineForPoint=function(t,e){var o={};return 0==t.a||void 0===t.a?t.hasOwnProperty("x")?o.y=e.y:t.hasOwnProperty("y")&&(o.x=e.x):(o.a=-1/t.a,o.b=e.y-e.x*o.a),o},s.prototype.getJoinLinePoint=function(t,e){var o=this.getVerticalLine(e,t);return this.getIntersectionPoint(e,o)},s.prototype.getDisForPoinLine=function(t,e){var o=this.getJoinLinePoint(t,e);return this.getDistance(t,o)},s.prototype.getVerticalLine=function(t,e){if(void 0===t.a)return t.hasOwnProperty("x")?{y:e.y}:t.hasOwnProperty("y")?{x:e.x}:null;if(0==t.a)return{x:e.x};var o={};return o.a=-1/t.a,this.createLine3(o,e)},s.prototype.isContainForSegment=function(t,e,o,n){n||(n=i.minRealDis);var s=this.getDistance(e,t)+this.getDistance(o,t),r=this.getDistance(e,o);return Math.abs(s-r)<n},s.prototype.isPointInPoly=function(t,e){for(var o=t.x,n=t.y,i=!1,s=0,r=e.length-1;s<e.length;r=s++){var l=e[s],a=e[r],h=l.x,c=l.y,d=a.x,p=a.y;c>n!=p>n&&o<(d-h)*(n-c)/(p-c)+h&&(i=!i)}return i},s.prototype.getDisForPoinSegment=function(t,e,o,n){var i=this.createLine1(e,o),s=this.getJoinLinePoint(t,i),r=this.getDistance(e,o),l=this.getDistance(s,e),a=this.getDistance(s,o);return this.getDistance(s,e)>r||this.getDistance(s,o)>r?l<a&&l<n?{type:1,join:e}:a<l&&a<n?{type:2,join:o}:null:l<n?{type:1,join:e}:a<n?{type:2,join:o}:this.getDistance(t,s)<n?{type:0,join:s}:void 0},s.prototype.PointInSegment=function(t,e,o,n){if(this.getDistance(t,e)<i.minRealDis||this.getDistance(t,o)<i.minRealDis)return!0;n||(n=.1),n/=2;var s=(t.x-e.x)*(o.y-e.y)-(o.x-e.x)*(t.y-e.y),r=Math.min(e.x,o.x)-t.x,l=t.x-Math.max(e.x,o.x),a=Math.min(e.y,o.y)-t.y,h=t.y-Math.max(e.y,o.y);return Math.abs(s)<n&&(r<=0||Math.abs(r)<n)&&(l<=0||Math.abs(l)<n)&&(a<=0||Math.abs(a)<n)&&(h<=0||Math.abs(h)<n)},s.prototype.clonePoint=function(t,e){t.x=e.x,t.y=e.y},s.prototype.equalPoint=function(t,e){return t.x==e.x&&t.y==e.y},s.prototype.crossTwoLines=function(t,e,o,n,s){void 0===s&&(s=i.minRealDis);var r=this.getIntersectionPoint2(t,e,o,n);if(null!=r){if(this.getDistance(t,r)>s&&this.getDistance(e,r)>s&&this.getDistance(o,r)>s&&this.getDistance(n,r)>s)return this.getDistance(t,r)<this.getDistance(t,e)&&this.getDistance(e,r)<this.getDistance(t,e)&&this.getDistance(o,r)<this.getDistance(o,n)&&this.getDistance(n,r)<this.getDistance(o,n)}else if(this.PointInSegment(t,o,n)||this.PointInSegment(e,o,n))return!0;return!1},s.prototype.getDisPointsLine=function(t,e,o,n){var i={},s={},r={};if(t.hasOwnProperty("x"))i.x=t.x,i.y=e.y-o,s.x=t.x,s.y=e.y+n;else if(t.hasOwnProperty("y"))i.y=t.y,i.x=e.x-o,s.y=t.y,s.x=e.x+n;else{var l=Math.atan(t.a),a={a:-1/t.a},h=this.createLine3(a,e),c=this.getIntersectionPoint(t,h);i.x=c.x-o*Math.cos(l),i.y=c.y-o*Math.sin(l),s.x=c.x+n*Math.cos(l),s.y=c.y+n*Math.sin(l)}return r.newpoint1=i,r.newpoint2=s,r},s.prototype.getBoundingBox=function(t){for(var e=t[0].x,o=t[0].x,n=t[0].y,i=t[0].y,s=1;s<t.length;++s){var r=t[s];e>r.x&&(e=r.x),n>r.y&&(n=r.y),o<r.x&&(o=r.x),i<r.y&&(i=r.y)}var l={};return l.minX=e,l.minY=n,l.maxX=o,l.maxY=i,l},s.prototype.ComputePolygonArea=function(t){var e=t.length;if(e<3)return 0;for(var o=t[0].y*(t[e-1].x-t[1].x),n=1;n<e;++n)o+=t[n].y*(t[n-1].x-t[(n+1)%e].x);return Math.abs(o/2)},s.prototype.getPolygonCore=function(t){function e(t,e,o){return(t.x*e.y+e.x*o.y+o.x*t.y-e.x*t.y-o.x*e.y-t.x*o.y)/2}for(var o=0,n=0,i=0,s=t[1],r=2;r<t.length;r++){var l=t[r],a=e(t[0],s,l);i+=a,o+=(t[0].x+s.x+l.x)*a,n+=(t[0].y+s.y+l.y)*a,s=l}return{x:o/i/3,y:n/i/3}},s.prototype.isPolyInPoly=function(t,e,o){for(var n=0;n<t.length;++n){for(var i=!1,s=0;s<e.length;++s)if(this.equalPoint(t[n],e[s])){i=!0;break}if(i){var r=n==t.length-1?0:n+1,l={x:(t[n].x+t[r].x)/2,y:(t[n].y+t[r].y)/2};if(!this.isPointInPoly(l,e,o))return!1}else if(!this.isPointInPoly(t[n],e,o))return!1}return!0},s.prototype.dotPoints=function(t,e,o,n){var i={},s={};return i.start={},i.end={},i.start.x=0,i.start.y=0,i.end.x=e.x-t.x,i.end.y=e.y-t.y,s.start={},s.end={},s.start.x=0,s.start.y=0,s.end.x=n.x-o.x,s.end.y=n.y-o.y,i.end.x*s.end.x+i.end.y*s.end.y};var r=new s,l=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.initRes=null,this.initWidth=null,this.initHeight=null};l.prototype.init=function(t){var e=c.getBoundingBox();this.setCenter(e),this.updateForCanvas(t)},l.prototype.setInitInfo=function(t,e,o){null==this.initRes&&(this.initRes=t),null==this.initWidth&&(this.initWidth=e),null==this.initHeight&&(this.initHeight=o)},l.prototype.updateResForReSize=function(t,e,o){Math.abs(o)<.01||Math.abs(o-2*Math.PI)<.01?this.res=this.initRes*t/this.initWidth:this.res=this.initRes*e/this.initHeight,i.minRealDis=i.minPixLen/this.res,i.minAdsorb=i.minPixLen/this.res},l.prototype.setCenter=function(t){this.defaultCenter?this.center={x:this.defaultCenter.x,y:this.defaultCenter.y}:(this.cadBoundingbox=JSON.parse(JSON.stringify(t)),null!=this.cadBoundingbox&&(this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2}))},l.prototype.setDefaultCenter=function(t){this.defaultCenter={x:t.x,y:-t.z}},l.prototype._setRes=function(t){this.res=t,i.minRealDis=i.minPixLen/this.res,i.minAdsorb=i.minPixLen/this.res},l.prototype.setRes=function(t,e){this.res=this.width/Math.abs(e-t),i.minRealDis=i.minPixLen/this.res,i.minAdsorb=i.minPixLen/this.res},l.prototype.getScreenXY=function(t){if(null==this.width||null==this.height)return null;var e=t.x,o=t.y,n=this.width/2+(e-this.center.x)*this.res*this.zoom/100,i=this.height/2-(o-this.center.y)*this.res*this.zoom/100;return n=.5+n<<0,i=.5+i<<0,{x:Math.floor(n)*this.ratio,y:Math.floor(i)*this.ratio}},l.prototype.getXYFromScreen=function(t){var e={};return e.x=(t.x-this.width/2)/this.res*100/this.zoom+this.center.x,e.y=(this.height/2-t.y)/this.res*100/this.zoom+this.center.y,e},l.prototype.getPointForRevRotate=function(t,e){if(Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.center.x)*Math.cos(e)-(t.y-this.center.y)*Math.sin(e)+this.center.x,n=(t.y-this.center.y)*Math.cos(e)+(t.x-this.center.x)*Math.sin(e)+this.center.y;return t.x=o,t.y=n,t},l.prototype.getVectorForRotate=function(t,e){if(e=-e,Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.center.x)*Math.cos(e)-(t.y-this.center.y)*Math.sin(e)+this.center.x,n=(t.y-this.center.y)*Math.cos(e)+(t.x-this.center.x)*Math.sin(e)+this.center.y;return t.x=o,t.y=n,t},l.prototype.updateCenterForRotate=function(t){if(!(Math.abs(t)<.01||Math.abs(t-2*Math.PI)<.01)){var e=this.center.x*Math.cos(t)-this.center.y*Math.sin(t),o=this.center.y*Math.cos(t)+this.center.x*Math.sin(t);return this.center.x=e,this.center.y=o,this.center}},l.prototype.updateForCanvas=function(t){t&&(this.width=t.clientWidth,this.height=t.clientHeight,t.width=t.clientWidth,t.height=t.clientHeight)},l.prototype.updateZoom=function(t){this.zoom=t},l.prototype.moveTo=function(t,e){var o=this.getXYFromScreen(e);this.zoom=t;var n=(100*e.x/this.zoom-this.width/2)/this.res,i=(this.height/2-100*e.y/this.zoom)/this.res;this.center.x=o.x-n,this.center.y=o.y-i},l.prototype.getXYFromScreenForDefaultZoom=function(t){var e={};return e.x=(t.x-this.width/2)/this.res+this.center.x,e.y=(this.height/2-t.y)/this.res+this.center.y,e},l.prototype.getScreenInfoForCAD=function(){var t=this.getXYFromScreen({x:this.width,y:this.height}),e=this.getXYFromScreen({x:0,y:0}),o={x:this.center.x,y:this.center.y};return{width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y),center:{x:o.x,y:o.y},defaultCenter:this.defaultCenter}},l.prototype.getPixelRatio=function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},l.prototype.reSet=function(){this.center={x:this.defaultCenter.x,y:this.defaultCenter.y},this.zoom=100},l.prototype.updateForRotate=function(t){void 0===t&&(t=Math.PI/2);for(var e=0;e<o.floors.length;++e){var n=o.floors[e].points;for(var i in n)n[i]=this.getVectorForRotate(n[i],t);var s=o.floors[e].symbols;for(var l in s)s[l].startPoint=this.getVectorForRotate(s[l].startPoint,t),s[l].endPoint=this.getVectorForRotate(s[l].endPoint,t),s[l].setPoints2d();var a=o.floors[e].components;for(var h in a){var c=a[h];c.sideWidth=r.getDistance(c.points2d[0],c.points2d[1]),c.sideThickness=r.getDistance(c.points2d[1],c.points2d[2]),c.center=this.getVectorForRotate(c.center,t),c.angle=(c.angle+t/Math.PI*180)%360,c.setPoints2d()}var d=o.floors[e].tags;for(var p in d)d[p].center=this.getVectorForRotate(d[p].center,t),d[p].setPoints2d()}},l.prototype.updatePanosForRotate=function(t){for(var e=o.panos,n=0;n<e.length;++n){var i=JSON.parse(JSON.stringify(e[n]));i=this.getVectorForRotate(i,t),e[n].x=i.x,e[n].y=i.y}},l.prototype.clear=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1};var a=new l,h=function(){this.currentId=0,this.currentFloor=0,this.angle=0,this.$app=null};h.prototype.setCurrentId=function(t){this.currentId=t},h.prototype.getCurrentId=function(){return this.currentId},h.prototype.updateCurrentId=function(){++this.currentId},h.prototype.setCurrentFloor=function(t){1==o.floors.length?this.currentFloor=0:this.currentFloor=t},h.prototype.getCurrentFloor=function(){return this.currentFloor},h.prototype.getCompass=function(){return o.compass},h.prototype.setCompass=function(t){o.compass=t},h.prototype.getFloorNum=function(){return o.floors.length},h.prototype.initFloor=function(t){o.initFloor(t)},h.prototype.getFloors=function(){return o.floors},h.prototype.getPoint=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].points[t]},h.prototype.deletePoint=function(t,e,n){null!=n&&void 0!==n||(n=this.currentFloor);var i=this.getPoint(t);if(i)if(0==Object.keys(i.parent).length)i=null,delete o.floors[n].points[t];else if(1!=Object.keys(i.parent).length||e)if(1==Object.keys(i.parent).length&&i.parent[e])delete o.floors[n].points[t];else{if(1==Object.keys(i.parent).length&&!i.parent[e])return;delete i.parent[e]}else delete o.floors[n].points[t]},h.prototype.getWall=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].walls[t]},h.prototype.deleteWall=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor);for(var n=this.getWall(t,e),i=0;i<n.children.length;++i)this.deleteSymbol(n.children[i],e);this.deletePoint(n.start,t,e),this.deletePoint(n.end,t,e),delete o.floors[e].walls[t]},h.prototype.deleteWallNoSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor);var n=this.getWall(t,e);this.deletePoint(n.start,t,e),this.deletePoint(n.end,t,e),delete o.floors[e].walls[t]},h.prototype.getAngle=function(){return this.angle},h.prototype.setAngle=function(t){this.angle=t},h.prototype.setBoundingBox=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].boundingBox=JSON.parse(JSON.stringify(t))},h.prototype.getBoundingBox=function(t){if(null==t||void 0===t){for(var e=null,n=null,i=null,s=null,r=0;r<o.floors.length;++r)o.floors[r].boundingBox.hasOwnProperty("maxX")&&o.floors[r].boundingBox.hasOwnProperty("minX")&&o.floors[r].boundingBox.hasOwnProperty("maxY")&&o.floors[r].boundingBox.hasOwnProperty("minY")||this.updateBoundingBox(r),(null==e||e>o.floors[r].boundingBox.minX)&&(e=o.floors[r].boundingBox.minX),(null==n||n<o.floors[r].boundingBox.maxX)&&(n=o.floors[r].boundingBox.maxX),(null==i||i>o.floors[r].boundingBox.minY)&&(i=o.floors[r].boundingBox.minY),(null==s||s<o.floors[r].boundingBox.maxY)&&(s=o.floors[r].boundingBox.maxY);return{minX:e,maxX:n,minY:i,maxY:s}}return o.floors[t].boundingBox},h.prototype.updateBoundingBox=function(t){var e=this.getPoints(t),o=null,n=null,i=null,s=null;for(var r in e){var l=e[r];(null==o||o>l.x)&&(o=l.x),(null==n||n<l.x)&&(n=l.x),(null==i||i>l.y)&&(i=l.y),(null==s||s<l.y)&&(s=l.y)}this.setBoundingBox({minX:o,maxX:n,minY:i,maxY:s},t)},h.prototype.getFloorData=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t]},h.prototype.getWalls=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].walls},h.prototype.getPoints=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].points},h.prototype.getSymbol=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].symbols[t]},h.prototype.addWall=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].walls[t.vectorId]=t},h.prototype.addPoint=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].points[t.vectorId]=t},h.prototype.addSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].symbols[t.vectorId]=t},h.prototype.addComponent=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].components[t.vectorId]=t},h.prototype.deleteSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getSymbol(t,e),delete o.floors[e].symbols[t]},h.prototype.getComponent=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].components[t]},h.prototype.deleteComponent=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getComponent(t,e),delete o.floors[e].components[t]},h.prototype.addTag=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].tags[t.vectorId]=t},h.prototype.getTag=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].tags[t]},h.prototype.deleteTag=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getTag(t,e),delete o.floors[e].tags[t]},h.prototype.getSymbols=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].symbols},h.prototype.getComponents=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].components},h.prototype.getTags=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].tags},h.prototype.getAllBoundingBox=function(){for(var t=[],e=0;e<o.floors.length;++e){var n=void 0,i=void 0,s=void 0,r=void 0,l={};for(var a in o.floors[e].points){var h=o.floors[e].points[a].x,c=o.floors[e].points[a].y;(void 0===n||n>h)&&(n=h),(void 0===s||s<h)&&(s=h),(void 0===i||i>c)&&(i=c),(void 0===r||r<c)&&(r=c)}l.left=n,l.top=r,l.right=s,l.bottom=i,t.push(l)}return t},h.prototype.getCadInfo=function(t){for(var e=[],o=this.getAllBoundingBox(),n=0;n<o.length;++n){var i={},s=a.getScreenXY({x:o[n].left,y:o[n].top}),r=a.getScreenXY({x:o[n].right,y:o[n].bottom}),l=s.x,h=s.y,c=t.width-r.x,d=t.height-r.y;i.left=l,i.top=h,i.right=c,i.bottom=d,i.bound=o[n],i.bound.top=-1*i.bound.top,i.bound.bottom=-1*i.bound.bottom,e.push(i)}return e},h.prototype.getRooms=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].rooms},h.prototype.clear=function(){o.floors[this.currentFloor].points={},o.floors[this.currentFloor].walls={},o.floors[this.currentFloor].symbols={},o.floors[this.currentFloor].components={},o.floors[this.currentFloor].tags={},o.floors[this.currentFloor].boundingBox={},o.floors[this.currentFloor].rooms=[]};var c=new h,d="Point",p="WallCorner",y="Wall",u="SingleDoor",g="DoubleDoor",f="SlideDoor",x="SingleWindow",m="BayWindow",v="FrenchWindow",P="Pass",I="Beam",S="Flue",b="Corridor",k="Line",w="Tag",W="LEFT",F="RIGHT",C=function(){this.len=null};C.prototype.setId=function(t){null==t||void 0===t?(t=c.getCurrentId(),c.updateCurrentId(),this.vectorId=this.geoType+t):this.vectorId=t},C.prototype.setSymbolPosition=function(t,e){"start"==e?r.clonePoint(this.startPoint,t):"end"==e&&r.clonePoint(this.endPoint,t)},C.prototype.setSymbolParent=function(t){this.parent=t},C.prototype.setPointParent=function(t,e){null==this.parent&&(this.parent={}),this.parent[t]=e},C.prototype.setOpenSide=function(t){var e=[];e.push(this.startPoint),e.push(this.endPoint),e.push(t);var o=null;o=r.isClockwise(e)?W:F,this.openSide=o},C.prototype.rotatePoint=function(t,e,o){o*=-1;var n=e.x,i=e.y,s=t.x,r=t.y;return{x:n+(s-n)*Math.cos(o*Math.PI/180)-(r-i)*Math.sin(o*Math.PI/180),y:i+(s-n)*Math.sin(o*Math.PI/180)+(r-i)*Math.cos(o*Math.PI/180)}};var T=function(t){function e(e,o,n,i){t.call(this),this.x=e,this.y=o,this.display=!1,this.floor=i,this.name=null,this.parent={},this.geoType=d,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPosition=function(t){this.x=t.x,this.y=t.y},e}(C),D=function(t){function e(e,o,n,i){t.call(this),this.start=e,this.end=o,this.floor=i,this.children=[],this.out=!1,this.important=!1,this.geoType=y,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getOtherPointId=function(t){return this.start==t?this.end:this.end==t?this.start:null},e.prototype.getPointId=function(t){return"start"==t?this.start:this.end},e.prototype.clearChildren=function(){this.children=[]},e.prototype.setImportant=function(t){this.important=t},e.prototype.setOut=function(t){this.out=t},e.prototype.setChildren=function(t){this.children=t},e}(C),M=function(){};M.prototype.getLine=function(t){var e=c.getPoint(t.start),o=c.getPoint(t.end);return r.createLine1(e,o)},M.prototype.isContain=function(t,e,o){var n=c.getPoint(t.start),i=c.getPoint(t.end);return r.isContainForSegment(e,n,i,o)},M.prototype.addChildren=function(t,e){t.children.indexOf(e)<0&&t.children.push(e)},M.prototype.createWall=function(t,e,o,n){var i=new D(t,e,o,n);return null!=n&&void 0!==n||(n=c.currentFloor),c.addWall(i,n),this.setPointParent(i.vectorId,t,"start",n),this.setPointParent(i.vectorId,e,"end",n),i},M.prototype.createPoint=function(t,e,o,n){var i=new T(t,e,o,n);return null!=n&&void 0!==n||(n=c.currentFloor),c.addPoint(i,n),i},M.prototype.setPointParent=function(t,e,o,n){var i=c.getPoint(e,n),s=c.getWall(t,n);i.setPointParent(t,o),"start"==o?s.start=e:"end"==o&&(s.end=e)},M.prototype.splitWall=function(t,e,o){var n=c.getWall(t),s=c.getPoint(n.start),l=c.getPoint(n.end),a=c.getPoint(e);r.getDistance(s,a)<i.minAdsorb||(r.getDistance(l,a),i.minAdsorb);var h=null;"start"==o?(delete l.parent[t],(h=this.createWall(e,n.end)).setOut(n.out),h.setImportant(n.important),this.setPointParent(t,e,"end"),l.setPointParent(h.vectorId,o)):"end"==o&&(delete s.parent[t],(h=this.createWall(n.start,e)).setOut(n.out),h.setImportant(n.important),this.setPointParent(t,e,"start"),s.setPointParent(h.vectorId,o));for(var d=0;d<n.children.length;++d){var p=n.children[d],y=c.getSymbol(p),u={x:(y.startPoint.x+y.endPoint.x)/2,y:(y.startPoint.y+y.endPoint.y)/2};this.isContain(h,u)&&(y.setSymbolParent(h.vectorId),n.children.splice(d,1),--d,h.children.push(p))}return h.vectorId},M.prototype.getWallId=function(t,e){var o=c.getPoint(t),n=c.getPoint(e);if(!o||!n)return console.log("pointId1或者pointId2不存在"),null;if(t==e)return console.log("给的是同一个point"),null;var i=o.parent,s=n.parent;for(var r in i)if(s.hasOwnProperty(r))return r;return null},M.prototype.isWallLink=function(t,e){var o=c.getWall(t),n=c.getWall(e);return o.start==n.start||o.start==n.end||o.end==n.start||o.end==n.end},M.prototype.AngleForWall=function(t,e){var o=c.getWall(t),n=c.getWall(e);if(null==o||null==n||void 0===o||void 0===n)return null;var i=c.getPoint(o.start),s=c.getPoint(o.end),l=c.getPoint(n.start),a=c.getPoint(n.end),h=r.getDistance(i,l),d=r.getDistance(i,a),p=r.getDistance(s,l),y=r.getDistance(s,a),u=Math.min(h,d,p,y);return null==r.getIntersectionPoint2(i,s,l,a)?Math.PI:h==u?(s.x+=l.x-i.x,s.y+=l.y-i.y,r.Angle(l,s,a)):d==u?(s.x+=a.x-i.x,s.y+=a.y-i.y,r.Angle(a,s,l)):p==u?(i.x+=l.x-s.x,i.y+=l.y-s.y,r.Angle(l,i,a)):y==u?(i.x+=a.x-s.x,i.y+=a.y-s.y,r.Angle(a,i,l)):(console.error("AngleForWall**************************1"),null)},M.prototype.AngleForWall2=function(t,e){var o=c.getWall(t),n=c.getWall(e);if(null==o||null==n||void 0===o||void 0===n)return null;var i=c.getPoint(o.start),s=c.getPoint(o.end),l=c.getPoint(n.start),a=c.getPoint(n.end),h=null,d=[];return d.push(i),d.push(s),o.start==n.start?(h=r.Angle(i,s,a),d.push(a)):o.start==n.end?(h=r.Angle(i,s,l),d.push(l)):o.end==n.start?(h=r.Angle(s,i,a),d[0]=s,d[1]=i,d.push(a)):o.end==n.end&&(h=r.Angle(s,i,l),d[0]=s,d[1]=i,d.push(l)),null==h?null:r.isClockwise(d)?{angle:h,clockwise:1}:{angle:h,clockwise:0}},M.prototype.AngleForWall3=function(t,e){var o=c.getWall(t),n=c.getWall(e);if(null==o||null==n||void 0===o||void 0===n)return null;var i=c.getPoint(o.start),s=c.getPoint(o.end),l=c.getPoint(n.start),a=c.getPoint(n.end),h=r.getDistance(i,l),d=r.getDistance(i,a),p=r.getDistance(s,l),y=r.getDistance(s,a),u=Math.min(h,d,p,y),g={},f={};return h==u?(f.x=s.x+l.x-i.x,f.y=s.y+l.y-i.y,r.Angle(l,f,a)):d==u?(f.x=s.x+a.x-i.x,f.y=s.y+a.y-i.y,r.Angle(a,f,l)):p==u?(g.x=i.x+l.x-s.x,g.y=i.y+l.y-s.y,r.Angle(l,g,a)):y==u?(g.x=i.x+a.x-s.x,g.y=i.y+a.y-s.y,r.Angle(a,g,l)):(console.error("WallService.AngleForWall3************************************1"),null)},M.prototype.wallIdForMinAngle=function(t,e){var o,n,i,s,r=c.getPoint(t).parent,l=null,a=null,h=null,d=null;if(Object.keys(r).length>2){for(var p in r)if(p!=e){var y=this.AngleForWall2(e,p);null==h&&1==y.clockwise?((n=y).wallId=p,h=y.angle,(s=y).wallId=p,d=y.angle):h>y.angle&&1==y.clockwise?((n=y).wallId=p,h=y.angle):d<y.angle&&1==y.clockwise?((s=y).wallId=p,d=y.angle):null==l&&0==y.clockwise?((o=y).wallId=p,l=y.angle,(i=y).wallId=p,a=y.angle):l>y.angle&&0==y.clockwise?((o=y).wallId=p,l=y.angle):a<y.angle&&0==y.clockwise&&((i=y).wallId=p,a=y.angle)}var u={min0:o,min1:n};return u.min0||(u.min0=s,u.min0.angle=360-s.angle),u.min1||(u.min1=i,u.min1.angle=360-i.angle),u}return console.error("wallIdForMinAngle*********************************************************"),null},M.prototype.mergeWall=function(t,e){var o=this.getLinkPointId(t,e),n=c.getWall(e).getOtherPointId(o),i=c.getPoint(n);if(this.changeSymbolsWallToWall(e,t),Object.keys(i.parent).length>1)this.moveTo(o,n);else{c.deleteWall(e);var s=c.getPoint(o);r.clonePoint(s,i)}return n},M.prototype.changeSymbolsWallToWall=function(t,e,o){for(var n=c.getWall(t,o),i=c.getWall(e,o),s=0;s<n.children.length;++s){var r=n.children[s];c.getSymbol(r,o).setSymbolParent(e),this.addChildren(i,r)}n.clearChildren()},M.prototype.mergeWallForPoint=function(t){var e=c.getPoint(t);if(null!=e&&2==Object.keys(e.parent).length&&this.AngleForWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1])>i.maxAngle/180*Math.PI)return this.mergeWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1]);return null},M.prototype.getLinkPointId=function(t,e){var o=c.getWall(t),n=c.getWall(e);return o.start==n.start||o.start==n.end?o.start:o.end==n.start||o.end==n.end?o.end:o.start==n.start?null:void 0},M.prototype.moveTo=function(t,e){var o=this.getWallId(t,e),n=c.getPoint(t),s=c.getPoint(e);n.x,s.x,n.y,s.y;var l=n.parent,a=s.parent;for(var h in l)if(h!=o){var d=c.getWall(h).getOtherPointId(t),p=c.getPoint(d);for(var y in a)if(y!=o){var u=c.getWall(y).getOtherPointId(e),g=c.getPoint(u),f=r.Angle(s,p,g);if(Math.abs(f)<i.minAngle/180*Math.PI)return!1}}if(null!=o&&c.deleteWall(o),n=c.getPoint(t),s=c.getPoint(e),!n||!s)return!1;for(var x in l){var m=c.getWall(x),v=m.getOtherPointId(t);if(null!=this.getWallId(v,e))return!1;m.start==t?(c.deletePoint(m.start,x),m.start=e,s.setPointParent(x,"start")):m.end==t?(c.deletePoint(m.end,x),m.end=e,s.setPointParent(x,"end")):console.error("wallService.moveTo****************************************************")}return!0},M.prototype.getDirction=function(t,e){var o=c.getWall(e);return o.start==t?"start":o.end==t?"end":(console.error("WallService.getDirction*******************************************************************************************"),null)},M.prototype.isOverlapForMergePoint=function(t,e){var o=this.getWallId(t,e),n=c.getPoint(t),s=c.getPoint(e),l=n.x-s.x,a=n.y-s.y,h=n.parent,d=s.parent;for(var p in h)if(p!=o){var y=c.getWall(p).getOtherPointId(t),u=c.getPoint(y),g={x:u.x-l,y:u.y-a};for(var f in d)if(f!=o){var x=c.getWall(f).getOtherPointId(e),m=c.getPoint(x),v=r.Angle(s,g,m);if(Math.abs(v)<i.minAngle/180*Math.PI)return!0}}return!1},M.prototype.subtraWallFromIntersect=function(t,e){var o=c.getPoint(t),n=o.parent,i=this.getDirction(t,e);if(1!=Object.keys(n).length){delete n[e];var s=this.createPoint(o.x,o.y);s.setPointParent(e,i);var r=c.getWall(e);"start"==i?r.start=s.vectorId:"end"==i&&(r.end=s.vectorId)}},M.prototype.setWallInfo=function(t){var e=c.getWall(t.vectorId);return e.start=t.start,e.end=t.end,e.children=t.children,e.out=t.out,e.important=t.important,e},M.prototype.setPointInfo=function(t){var e=c.getPoint(t.vectorId);return r.clonePoint(e,t.position),e.parent=JSON.parse(JSON.stringify(t.parent)),e},M.prototype.getNeighPoints=function(t,e){var o=[],n=c.getPoint(t);for(var i in n.parent){var s=c.getWall(i).getOtherPointId(t);if(!e||e!=s){var r=c.getPoint(s);o.push(r)}}return o},M.prototype.deleteWallCorner=function(t){var e=c.getPoint(t);if(1==Object.keys(e.parent).length)c.deleteWall(Object.keys(e.parent)[0]);else if(Object.keys(e.parent).length>2)for(var o in e.parent)c.deleteWall(o);else if(2==Object.keys(e.parent).length){this.AngleForWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1])>i.maxAngle/180*Math.PI?this.mergeWall(Object.keys(e.parent)[0],Object.keys(e.parent)[1]):(c.deleteWall(Object.keys(e.parent)[0]),c.deleteWall(Object.keys(e.parent)[0]))}};var L=new M,O="all",A="start",R="end",E="select",N=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.openSide=null,this.parent=null,this.enter=null,this.points2d=[],this.name="单开门",this.geoType=u,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=r.createLine1(this.startPoint,this.endPoint),e=r.getDistance(this.startPoint,this.endPoint),o=r.getParallelLineForDistance(t,e),n=r.getVerticalLine(t,this.startPoint),i=r.getVerticalLine(t,this.endPoint),s=r.getIntersectionPoint(o.line1,n),l=r.getIntersectionPoint(o.line2,n),a=r.getIntersectionPoint(o.line1,i),h=r.getIntersectionPoint(o.line2,i);if(this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint),this.points2d.push(a),this.points2d.push(s),this.openSide==W){if(r.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint),this.points2d.push(h),this.points2d.push(l)}else if(this.openSide==F){if(!r.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint),this.points2d.push(h),this.points2d.push(l)}},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);if(e<i.minAdsorb)return A;if(o<i.minAdsorb)return R;if(r.isContainForSegment(t,this.startPoint,this.endPoint))return E;var n=r.getDistance(this.points2d[0],this.points2d[1]);if(r.getDistance(t,this.points2d[0])>n)return null;var s=r.Angle(this.points2d[0],t,this.points2d[1]),l=r.Angle(this.points2d[0],t,this.points2d[3]);return s<Math.PI/2&&l<Math.PI/2?E:null},e}(C),B=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.openSide=null,this.parent=null,this.enter=null,this.points2d=[],this.name="双开门",this.geoType=g,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=r.createLine1(this.startPoint,this.endPoint),e=r.getDistance(this.startPoint,this.endPoint),o=r.getParallelLineForDistance(t,e/2),n=r.getVerticalLine(t,this.startPoint),i=r.getVerticalLine(t,this.endPoint),s={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2},l=r.getVerticalLine(t,s),a=r.getIntersectionPoint(o.line1,n),h=r.getIntersectionPoint(o.line2,n),c=r.getIntersectionPoint(o.line1,i),d=r.getIntersectionPoint(o.line2,i),p=r.getIntersectionPoint(o.line1,l),y=r.getIntersectionPoint(o.line2,l);if(this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(c),this.points2d.push(p),this.points2d.push(a),this.openSide==W){if(r.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(d),this.points2d.push(y),this.points2d.push(h)}else if(this.openSide==F){if(!r.isClockwise(this.points2d))return;this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(s),this.points2d.push(this.endPoint),this.points2d.push(d),this.points2d.push(y),this.points2d.push(h)}},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);if(e<i.minAdsorb)return A;if(o<i.minAdsorb)return R;if(r.isContainForSegment(t,this.startPoint,this.endPoint))return E;var n=[];if(n.push(this.startPoint),n.push(this.endPoint),n.push(t),this.openSide==W){if(!r.isClockwise(n))return null}else if(this.openSide==F&&r.isClockwise(n))return null;var s={x:(this.points2d[0].x+this.points2d[1].x)/2,y:(this.points2d[0].y+this.points2d[1].y)/2},l=r.getDistance(this.points2d[1],this.points2d[2]),a=r.getDistance(t,this.points2d[0]);if(a<l){var h=r.Angle(this.points2d[0],t,this.points2d[5]),c=r.Angle(this.points2d[0],t,s);if(h<Math.PI/2&&c<Math.PI/2)return E}if((a=r.getDistance(t,this.points2d[2]))<l){var d=r.Angle(this.points2d[2],t,this.points2d[3]),p=r.Angle(this.points2d[2],t,s);if(d<Math.PI/2&&p<Math.PI/2)return E}return null},e}(C),Y=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.enter=null,this.points2d=[],this.name="滑动门",this.geoType=f,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=r.createLine1(this.startPoint,this.endPoint),e=2/a.res,o=r.getParallelLineForDistance(t,e);if(this.startPoint.x>this.endPoint.x){var n=o.line1;o.line1=o.line2,o.line2=n}var i=r.getVerticalLine(t,this.startPoint),s=r.getVerticalLine(t,this.endPoint),l=r.getIntersectionPoint(o.line1,i),h=r.getIntersectionPoint(o.line2,s),c={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2};this.points2d=[],this.points2d.push(this.startPoint);var d=4/a.res,p=r.getVerticalLine(t,c),y=r.getParallelLineForDistance(p,d),u=r.getIntersectionPoint(o.line1,y.line1),g=r.getIntersectionPoint(o.line1,y.line2),f=r.getIntersectionPoint(o.line2,y.line1),x=r.getIntersectionPoint(o.line2,y.line2),m=r.getIntersectionPoint(t,y.line1),v=r.getIntersectionPoint(t,y.line2);r.getDistance(this.startPoint,m)<r.getDistance(this.startPoint,v)?(this.points2d.push(v),this.points2d.push(g),this.points2d.push(l),this.points2d.push(this.endPoint),this.points2d.push(m),this.points2d.push(f),this.points2d.push(h)):(this.points2d.push(m),this.points2d.push(u),this.points2d.push(l),this.points2d.push(this.endPoint),this.points2d.push(v),this.points2d.push(x),this.points2d.push(h))},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);return e<i.minAdsorb?A:o<i.minAdsorb?R:r.isContainForSegment(t,this.startPoint,this.endPoint)?E:null},e}(C),j=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.points2d=[],this.name="单开窗",this.geoType=x,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint);var t=4/a.res,e=r.createLine1(this.startPoint,this.endPoint),o=r.getParallelLineForDistance(e,t),n=r.getVerticalLine(e,this.startPoint),i=r.getVerticalLine(e,this.endPoint),s=r.getIntersectionPoint(n,o.line1),l=r.getIntersectionPoint(i,o.line1),h=r.getIntersectionPoint(i,o.line2),c=r.getIntersectionPoint(n,o.line2);this.points2d.push(s),this.points2d.push(l),this.points2d.push(h),this.points2d.push(c)},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);return e<i.minAdsorb?A:o<i.minAdsorb?R:r.isContainForSegment(t,this.startPoint,this.endPoint)?E:null},e}(C),_=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.points2d=[],this.name="落地窗",this.geoType=v,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t=4/a.res,e=r.createLine1(this.startPoint,this.endPoint),o=r.getParallelLineForDistance(e,t),n=r.getVerticalLine(e,this.startPoint),i=r.getVerticalLine(e,this.endPoint);this.points2d=[],this.points2d.push(this.startPoint),this.points2d.push(this.endPoint);var s={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2},l=r.getVerticalLine(e,s),h=r.getIntersectionPoint(n,o.line1),c=r.getIntersectionPoint(i,o.line1);this.points2d.push(h),this.points2d.push(c);var d=r.getIntersectionPoint(n,o.line2),p=r.getIntersectionPoint(i,o.line2);this.points2d.push(d),this.points2d.push(p);var y=r.getIntersectionPoint(l,o.line1),u=r.getIntersectionPoint(l,o.line2);this.points2d.push(y),this.points2d.push(u)},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);return e<i.minAdsorb?A:o<i.minAdsorb?R:r.isContainForSegment(t,this.startPoint,this.endPoint)?E:null},e}(C),J=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.openSide="LEFT",this.parent=null,this.points2d=[],this.name="飘窗",this.geoType=m,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){var t,e,o,n,i=r.createLine1(this.startPoint,this.endPoint),s=r.getDistance(this.startPoint,this.endPoint)/2,l=4/a.res+s,h={x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2},c=r.getVerticalLine(i,h),d=r.getParallelLineForDistance(c,s),p=r.getParallelLineForDistance(c,l);r.getDisForPoinLine(this.startPoint,d.line1)>r.getDisForPoinLine(this.startPoint,d.line2)?(t=d.line2,e=p.line2,o=d.line1,n=p.line1):(t=d.line1,e=p.line1,o=d.line2,n=p.line2);var y=r.getParallelLineForDistance(i,2/a.res),u=r.getParallelLineForDistance(i,24/a.res),g=r.getParallelLineForDistance(i,28/a.res),f=y.line1,x=y.line2,m=u.line2,v=g.line2,P=y.line2,I=y.line1,S=u.line1,b=g.line1,k=r.getIntersectionPoint(t,f),w=r.getIntersectionPoint(o,f),W=r.getIntersectionPoint(o,m),F=r.getIntersectionPoint(t,m),C=r.getIntersectionPoint(e,x),T=r.getIntersectionPoint(n,x),D=r.getIntersectionPoint(n,v),M=r.getIntersectionPoint(e,v),L=r.getIntersectionPoint(t,P),O=r.getIntersectionPoint(o,P),A=r.getIntersectionPoint(o,S),R=r.getIntersectionPoint(t,S),E=r.getIntersectionPoint(e,I),N=r.getIntersectionPoint(n,I),B=r.getIntersectionPoint(n,b),Y=r.getIntersectionPoint(e,b);this.points2d=[],this.points2d.push(k),this.points2d.push(w),this.points2d.push(W),this.points2d.push(F),"LEFT"==this.openSide?r.isClockwise(this.points2d)?(this.points2d.push(C),this.points2d.push(T),this.points2d.push(D),this.points2d.push(M)):(this.points2d=[],this.points2d.push(L),this.points2d.push(O),this.points2d.push(A),this.points2d.push(R),this.points2d.push(E),this.points2d.push(N),this.points2d.push(B),this.points2d.push(Y)):"RIGHT"==this.openSide&&(r.isClockwise(this.points2d)?(this.points2d=[],this.points2d.push(L),this.points2d.push(O),this.points2d.push(A),this.points2d.push(R),this.points2d.push(E),this.points2d.push(N),this.points2d.push(B),this.points2d.push(Y)):(this.points2d.push(C),this.points2d.push(T),this.points2d.push(D),this.points2d.push(M)))},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);if(e<i.minAdsorb)return A;if(o<i.minAdsorb)return R;var n=r.isContainForSegment(t,this.startPoint,this.endPoint);if(n)return E;var s=[];return s[0]=this.points2d[4],s[1]=this.points2d[5],s[2]=this.points2d[6],s[3]=this.points2d[7],(n=r.isPointInPoly(t,s))?E:null},e}(C),X=function(t){function e(e,o,n,i){t.call(this),this.startPoint=e,this.endPoint=o,this.floor=i,this.parent=null,this.points2d=[],this.name="垭口",this.geoType=P,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPoints2d=function(){this.points2d=[];var t=5/a.res,e=r.createLine1(this.startPoint,this.endPoint),o=r.getParallelLineForDistance(e,t),n=r.getVerticalLine(e,this.startPoint),i=r.getVerticalLine(e,this.endPoint),s=r.getIntersectionPoint(n,o.line1),l=r.getIntersectionPoint(i,o.line1),h=r.getIntersectionPoint(i,o.line2),c=r.getIntersectionPoint(n,o.line2);this.points2d.push(s),this.points2d.push(l),this.points2d.push(h),this.points2d.push(c),t=2/a.res,o=r.getParallelLineForDistance(e,t);var d=r.getIntersectionPoint(n,o.line1),p=r.getIntersectionPoint(i,o.line1),y=r.getIntersectionPoint(i,o.line2),u=r.getIntersectionPoint(n,o.line2);this.points2d.push(d),this.points2d.push(p),this.points2d.push(y),this.points2d.push(u)},e.prototype.isContain=function(t){var e=r.getDistance(t,this.startPoint),o=r.getDistance(t,this.endPoint);return e<i.minAdsorb?A:o<i.minAdsorb?R:r.isContainForSegment(t,this.startPoint,this.endPoint)?E:null},e}(C),U=function(){this.enterImg=null};U.prototype.createSymbol=function(t,e,o,n,i){var s=null;switch(o){case m:s=new J(t,e,i);break;case v:s=new _(t,e,i);break;case u:s=new N(t,e,i);break;case g:s=new B(t,e,i);break;case f:s=new Y(t,e,i);break;case x:s=new j(t,e,i);break;case P:s=new X(t,e,i)}if(null!=s&&(s.setSymbolParent(n),s.setPoints2d(),c.addSymbol(s)),n){var r=c.getWall(n);L.addChildren(r,s.vectorId)}return s},U.prototype.addSymbol=function(t,e,o){var n=this.getDefaultSymbolLen(e),i=c.getWall(o),s=L.getLine(i);t=r.getJoinLinePoint(t,s);var l=this.getNewPosForSymbol(t,o,null,n);return l.state?this.createSymbol(l.position1,l.position2,e,o).vectorId:null},U.prototype.isSymbol=function(t){switch(t){case"BayWindow":case"FrenchWindow":case"SingleDoor":case"DoubleDoor":case"SlideDoor":case"SingleWindow":case"Pass":return!0}return!1},U.prototype.getDefaultSymbolLen=function(t){var e=0;switch(t){case"BayWindow":case"FrenchWindow":e=1.5;break;case"SingleDoor":e=.8;break;case"DoubleDoor":case"SlideDoor":e=1.5;break;case"SingleWindow":case"Pass":e=.8}return e},U.prototype.deleteSymbolForWall=function(t,e){if(t){var o=t.children.indexOf(e);o>-1&&t.children.splice(o,1),c.getSymbol(e).parent=null}},U.prototype.deleteSymbol=function(t){var e=c.getSymbol(t);if(e.parent){var o=c.getWall(e.parent);this.deleteSymbolForWall(o,t)}c.deleteSymbol(t)},U.prototype.changeSymbolForBelong=function(t,e){var o=c.getSymbol(t),n=o.parent,i=c.getWall(n);this.deleteSymbolForWall(i,t),o.setSymbolParent(e);var s=c.getWall(e);L.addChildren(s,t)},U.prototype.reBelongForSplitWall=function(t,e,o){for(var n=c.getWall(t),i=0;i<n.children.length;++i){var s=n.children[i];t!=e&&this.isContainSymbolForWall(s,e)?this.changeSymbolForBelong(s,e):t!=o&&this.isContainSymbolForWall(s,o)&&this.changeSymbolForBelong(s,o)}},U.prototype.isContainSymbolForWall=function(t,e){var o=c.getWall(e),n=c.getSymbol(t),i={x:(n.startPoint.x+n.endPoint.x)/2,y:(n.startPoint.y+n.endPoint.y)/2};if(L.isContain(o,i))return!0},U.prototype.changeSymbolForBelong=function(t,e){var o=c.getSymbol(t),n=o.parent,i=c.getWall(n);this.deleteSymbolForWall(i,t),o.setSymbolParent(e);var s=c.getWall(e);L.addChildren(s,t)},U.prototype.updateSymbolsPositionsForWallCorner=function(t){var e=c.getPoint(t).parent;for(var o in e)this.updateSymbolsPositionsForWall(o)},U.prototype.updateSymbolsPositionsForWall=function(t){for(var e=c.getWall(t).children,o=0;o<e.length;++o){var n=c.getSymbol(e[o]);this.updateSEForChangeWall(n)}},U.prototype.updateSEForChangeWall=function(t){var e=t.vectorId,o=c.getWall(t.parent),n=c.getPoint(o.start),i=c.getPoint(o.end),s=r.createLine1(n,i),l=r.getJoinLinePoint(t.startPoint,s),a=r.getJoinLinePoint(t.endPoint,s),h={x:0,y:0},d=!0;L.isContain(o,l)?L.isContain(o,a)||(r.getDistance(a,n)<r.getDistance(a,i)?(h.x=n.x-a.x,h.y=n.y-a.y):(h.x=i.x-a.x,h.y=i.y-a.y),a.x+=h.x,a.y+=h.y,L.isContain(o,{x:l.x+h.x,y:l.y+h.y})&&(l.x+=h.x,l.y+=h.y),d=!1):(r.getDistance(l,n)<r.getDistance(l,i)?(h.x=n.x-l.x,h.y=n.y-l.y):(h.x=i.x-l.x,h.y=i.y-l.y),l.x+=h.x,l.y+=h.y,L.isContain(o,{x:a.x+h.x,y:a.y+h.y})&&(a.x+=h.x,a.y+=h.y),d=!1),d?(this.setPosition(t,l,"start"),this.setPosition(t,a,"end"),t.setPoints2d()):this.updateSEForCollideSymbols(e,l,a)},U.prototype.updateSEForCollideSymbols=function(t,e,o){var n=c.getSymbol(t),s=this.getNewForContainSymbols(e,o,n.parent,t);null!=s&&(r.getDistance(s.position1,s.position2)<i.minSymbolLen?this.deleteSymbol(t):(this.setPosition(n,s.position1,"start"),this.setPosition(n,s.position2,"end"),n.setPoints2d()))},U.prototype.getNewForContainSymbols=function(t,e,o,n){for(var s=c.getWall(o),l=[],a=0;a<s.children.length;++a){var h=s.children[a];if(h!=n){var d=c.getSymbol(h);l.push({x:d.startPoint.x,y:d.startPoint.y,index:1,vectorId:h}),l.push({x:d.endPoint.x,y:d.endPoint.y,index:2,vectorId:h})}}l.push({x:t.x,y:t.y,index:1,vectorId:n}),l.push({x:e.x,y:e.y,index:2,vectorId:n});var p=c.getPoint(s.start);l=l.sort(function(t,e){return r.getDistance(p,t)-r.getDistance(p,e)}.bind(this));for(var y=0;y<l.length-1;++y)if(l[y].vectorId==n)if(0==y||y==l.length-2){if(r.getDistance(l[y],l[y+1])<i.minSymbolLen)return null;if(l[y+1].vectorId==n)return{position1:t,position2:{x:l[y+1].x,y:l[y+1].y}};if(l[y+1].vectorId!=n)return{position1:t,position2:{x:l[y+1].x,y:l[y+1].y},collision:!0}}else if(l[y+1].vectorId==n&&l[y-1].vectorId!=l[y+2].vectorId)return r.getDistance({x:l[y-1].x,y:l[y-1].y},{x:l[y+2].x,y:l[y+2].y})<i.minSymbolLen?null:{position1:{x:l[y-1].x,y:l[y-1].y},position2:{x:l[y+2].x,y:l[y+2].y}};return null},U.prototype.getNewPosForSymbol=function(t,e,o,n){var s=c.getWall(e),l=c.getPoint(s.start),a=c.getPoint(s.end),h=L.getLine(s),d=r.getVerticalLine(h,t),p=n;o&&(p=c.getSymbol(o).len);var u=r.getParallelLineForDistance(d,p/2),g=r.getIntersectionPoint(u.line1,h),f=r.getIntersectionPoint(u.line2,h);if(r.getDistance(l,a)<p)r.clonePoint(g,l),r.clonePoint(f,a);else{var x,m,v={},P={};L.isContain(s,g)?L.isContain(s,f)||(x=l.x-f.x,m=l.y-f.y,v.x=g.x+x,v.y=g.y+m,L.isContain(s,v)?(g.x+=x,g.y+=m,r.clonePoint(f,l)):(x=a.x-f.x,m=a.y-f.y,g.x+=x,g.y+=m,r.clonePoint(f,a))):(x=l.x-g.x,m=l.y-g.y,P.x=f.x+x,P.y=f.y+m,L.isContain(s,P)?(f.x+=x,f.y+=m,r.clonePoint(g,l)):(x=a.x-g.x,m=a.y-g.y,f.x+=x,f.y+=m,r.clonePoint(g,a)))}for(var I=[],S=0;S<s.children.length;++S){var b=s.children[S];if(b!=o){var k=c.getSymbol(b);I.push({x:k.startPoint.x,y:k.startPoint.y,index:1,vectorId:b}),I.push({x:k.endPoint.x,y:k.endPoint.y,index:2,vectorId:b})}}I.push({x:l.x,y:l.y,index:1,vectorId:e,type:y}),I.push({x:a.x,y:a.y,index:2,vectorId:e,type:y}),I=I.sort(function(t,e){return r.getDistance(l,t)-r.getDistance(l,e)}.bind(this));for(var w=0;w<I.length-1;++w)if(r.isContainForSegment(t,I[w],I[w+1])){if(r.getDistance(I[w],I[w+1])>p){if(I[w].vectorId==I[w+1].vectorId&&I[w].type!=y)return{position1:g,position2:f,collision:!0,state:!1};if(I[w].vectorId==I[w+1].vectorId&&I[w].type==y)return{position1:g,position2:f,collision:!0,state:!0};if(!r.isContainForSegment(g,I[w],I[w+1])||!r.isContainForSegment(f,I[w],I[w+1]))return{position1:g,position2:f,collision:!0,state:!1}}else{if(r.getDistance(I[w],I[w+1])<i.minSymbolLen)return{position1:g,position2:f,collision:!0,state:!1};if(I[w].vectorId!=I[w+1].vectorId)return{position1:{x:I[w].x,y:I[w].y},position2:{x:I[w+1].x,y:I[w+1].y},collision:!0,state:!0};if(I[w].vectorId==I[w+1].vectorId&&I[w].type!=y)return{position1:g,position2:f,collision:!0,state:!1};if(I[w].vectorId==I[w+1].vectorId&&I[w].type==y)return{position1:{x:I[w].x,y:I[w].y},position2:{x:I[w+1].x,y:I[w+1].y},collision:!0,state:!0}}!1}else if(r.getDistance(t,I[w])<i.minRealDis)return{position1:g,position2:f,collision:!0,state:!1};return{position1:g,position2:f,collision:!1,state:!0}},U.prototype.setPosition=function(t,e,o){"start"==o?r.clonePoint(t.startPoint,e):"end"==o&&r.clonePoint(t.endPoint,e)},U.prototype.updateSymbolsPositionsForNeighWall=function(t){for(var e=c.getWall(t).children,o=0;o<e.length;++o)this.updateSEForWallSize(e[o])},U.prototype.updateSEForWallSize=function(t){var e=c.getSymbol(t),o=c.getWall(e.parent),n=c.getPoint(o.start),i=c.getPoint(o.end),s={x:e.startPoint.x,y:e.startPoint.y},l={x:e.endPoint.x,y:e.endPoint.y},a={x:0,y:0};if(L.isContain(o,s)){if(L.isContain(o,l))return null;r.getDistance(l,n)<r.getDistance(l,i)?(a.x=n.x-l.x,a.y=n.y-l.y):(a.x=i.x-l.x,a.y=i.y-l.y),l.x+=a.x,l.y+=a.y}else r.getDistance(s,n)<r.getDistance(s,i)?(a.x=n.x-s.x,a.y=n.y-s.y):(a.x=i.x-s.x,a.y=i.y-s.y),s.x+=a.x,s.y+=a.y;this.updateSEForCollideSymbols(t,s,l)},U.prototype.updateSymbolForLen=function(t,e){var o=c.getSymbol(t),n=o.startPoint,i=o.endPoint,s=r.createLine1(n,i),l={x:(n.x+i.x)/2,y:(n.y+i.y)/2},a=r.getVerticalLine(s,l),h=c.getWall(o.parent),d=c.getPoint(h.start),p=c.getPoint(h.end);if(null==e||void 0===e){e=r.getDistance(n,i);var y=r.getDistance(d,p);e>y&&(e=y)}var u=r.getParallelLineForDistance(a,e/2),g=r.getIntersectionPoint(u.line1,s),f=r.getIntersectionPoint(u.line2,s),x={};r.getDistance(n,g)<r.getDistance(n,f)?(x.start=g,x.end=f):(x.start=f,x.end=g);var m,v,P=!1,I=!1,S=this.getNearestPosition(o.parent,t,!0);return null!=S.startPosition&&r.PointInSegment(S.startPosition,x.start,x.end)&&(m=x.start.x-S.startPosition.x,v=x.start.y-S.startPosition.y,r.clonePoint(x.start,S.startPosition),x.end.x-=m,x.end.y-=v,P=!0),null!=S.endPosition&&r.PointInSegment(S.endPosition,x.start,x.end)&&(m=x.end.x-S.endPosition.x,v=x.end.y-S.endPosition.y,r.clonePoint(x.end,S.endPosition),P||(x.start.x-=m,x.start.y-=v,r.PointInSegment(S.startPosition,x.start,x.end)&&(r.clonePoint(x.start,S.startPosition),P=!0)),I=!0),x.vectorId=t,r.clonePoint(o.startPoint,x.start),r.clonePoint(o.endPoint,x.end),o.setPoints2d(),{block:P&I,start:x.start,end:x.end}},U.prototype.getNearestPosition=function(t,e,o,n,i){var s=c.getWall(t),l=c.getPoint(s.start),a=c.getPoint(s.end),h=s.children,d=c.getSymbol(e);d||e||(d={},(d={struct:{}}).startPoint=n,d.endPoint=i);for(var p=1e4,y=1e4,u=null,g=null,f=null,x=null,m=0;m<h.length;++m)if(h[m]!=e){var v=c.getSymbol(h[m]),P=r.getDistance(d.startPoint,v.startPoint),I=r.getDistance(d.startPoint,v.endPoint);p>Math.min(P,I)&&(P<I?(u=v.startPoint,f=v.endPoint):(u=v.endPoint,f=v.startPoint),r.getDistance(d.startPoint,u)>r.getDistance(d.endPoint,u)?(u=null,f=null):p=Math.min(P,I));var S=r.getDistance(d.endPoint,v.startPoint),b=r.getDistance(d.endPoint,v.endPoint);y>Math.min(S,b)&&(S<b?(g=v.startPoint,x=v.endPoint):(g=v.endPoint,x=v.startPoint),r.getDistance(d.endPoint,g)>r.getDistance(d.startPoint,g)?(g=null,x=null):y=Math.min(S,b))}return o&&(null==u&&(r.getDistance(l,d.startPoint)>r.getDistance(l,d.endPoint)?(u=a,f=a):(u=l,f=l)),null==g&&(r.getDistance(l,d.startPoint)>r.getDistance(l,d.endPoint)?(g=l,x=l):(g=a,x=a))),{startPosition:u,startPosition2:f,endPosition:g,endPosition2:x}},U.prototype.moveSymbolSinglePoint=function(t,e,o){var n=c.getSymbol(e),i=r.createLine1(n.startPoint,n.endPoint),s=r.getVerticalLine(i,t);t=r.getIntersectionPoint(s,i);var l={x:(n.startPoint.x+n.endPoint.x)/2,y:(n.startPoint.y+n.endPoint.y)/2},a=c.getWall(n.parent),h=c.getPoint(a.start),d=c.getPoint(a.end);if("start"==o){if(!r.PointInSegment(l,t,n.endPoint))return null;r.getDistance(n.startPoint,h)<r.getDistance(n.endPoint,h)?r.getDistance(t,l)>r.getDistance(h,l)&&r.clonePoint(t,h):r.getDistance(t,l)>r.getDistance(d,l)&&r.clonePoint(t,d)}else if("end"==o){if(!r.PointInSegment(l,t,n.startPoint))return null;r.getDistance(n.endPoint,d)<r.getDistance(n.startPoint,d)?r.getDistance(t,l)>r.getDistance(d,l)&&r.clonePoint(t,d):r.getDistance(t,l)>r.getDistance(h,l)&&r.clonePoint(t,h)}return{dir:o,position:t}},U.prototype.setSymbolInfo=function(t){var e=c.getSymbol(t.vectorId);return e.openSide=t.openSide,e.startPoint=t.start,e.endPoint=t.end,e.points2d=JSON.parse(JSON.stringify(t.points2d)),e.enter=t.enter,e.parent=t.parent,e},U.prototype.setEnterImg=function(t){this.enterImg=t},U.prototype.getEnterImg=function(){return this.enterImg};var H=new U,V=function(t){function e(e,o){t.call(this),this.center=e,this.angle=0,this.points2d=[],this.sideWidth=.65,this.sideThickness=.65,this.name="柱子",this.geoType=I,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){return r.isPointInPoly(t,this.points2d)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/2,e=this.center.y-this.sideThickness/2,o=this.center.x+this.sideWidth/2,n=this.center.y+this.sideThickness/2,i=this.rotatePoint({x:t,y:n},this.center,this.angle),s=this.rotatePoint({x:o,y:n},this.center,this.angle),r=this.rotatePoint({x:o,y:e},this.center,this.angle),l=this.rotatePoint({x:t,y:e},this.center,this.angle);this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l)},e}(C),G=function(t){function e(e,o){t.call(this),this.center=e,this.angle=0,this.points2d=[],this.sideWidth=.65,this.sideThickness=.65,this.name="烟道",this.geoType=S,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),r.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/2,e=this.center.y-this.sideThickness/2,o=this.center.x+this.sideWidth/2,n=this.center.y+this.sideThickness/2,i=this.rotatePoint({x:t,y:n},this.center,this.angle),s=this.rotatePoint({x:o,y:n},this.center,this.angle),r=this.rotatePoint({x:o,y:e},this.center,this.angle),l=this.rotatePoint({x:t,y:e},this.center,this.angle);this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l),t=this.center.x-(this.sideWidth-.1)/2,e=this.center.y-(this.sideThickness-.1)/2,o=this.center.x+(this.sideWidth-.1)/2,n=this.center.y+(this.sideThickness-.1)/2;var a=this.rotatePoint({x:t,y:n},this.center,this.angle),h=this.rotatePoint({x:o,y:n},this.center,this.angle),c=this.rotatePoint({x:o,y:e},this.center,this.angle),d=this.rotatePoint({x:t,y:e},this.center,this.angle),p={x:(this.center.x+h.x)/2,y:(this.center.y+h.y)/2};this.points2d.push(a),this.points2d.push(h),this.points2d.push(c),this.points2d.push(d),this.points2d.push(p)},e}(C),$=function(t){function e(e,o){t.call(this),this.center=e,this.angle=0,this.points2d=[],this.sideWidth=.65,this.sideThickness=.65,this.name="楼道",this.geoType=b,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),r.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/2,e=this.center.y-this.sideThickness/2,o=this.center.x+this.sideWidth/2,n=this.center.y+this.sideThickness/2,i=this.rotatePoint({x:t,y:n},this.center,this.angle),s=this.rotatePoint({x:o,y:n},this.center,this.angle),r=this.rotatePoint({x:o,y:e},this.center,this.angle),l=this.rotatePoint({x:t,y:e},this.center,this.angle);this.points2d.push(i),this.points2d.push(s),this.points2d.push(r),this.points2d.push(l);var h=this.center.x-2/a.res,c=this.center.x+2/a.res,d=3/a.res,p=this.rotatePoint({x:h,y:n},this.center,this.angle),y=this.rotatePoint({x:h,y:e},this.center,this.angle);this.points2d.push(p),this.points2d.push(y);var u=this.rotatePoint({x:c,y:n},this.center,this.angle),g=this.rotatePoint({x:c,y:e},this.center,this.angle);this.points2d.push(u),this.points2d.push(g);for(var f=Math.floor(this.sideThickness*a.res/3),x=0;x<f-2;++x){var m=this.rotatePoint({x:t,y:n-(x+2)*d},this.center,this.angle),v=this.rotatePoint({x:h,y:n-(x+2)*d},this.center,this.angle);this.points2d.push(m),this.points2d.push(v);var P=this.rotatePoint({x:c,y:n-(x+1)*d},this.center,this.angle),I=this.rotatePoint({x:o,y:n-(x+1)*d},this.center,this.angle);this.points2d.push(P),this.points2d.push(I)}},e}(C),K=function(){this.sideWidth=.65,this.sideThickness=.65};K.prototype.createComponent=function(t,e,o){var n=null;switch(e){case I:n=new V(t,o);break;case S:n=new G(t,o);break;case b:n=new $(t,o)}return n.setPoints2d(),c.addComponent(n),n},K.prototype.isComponent=function(t){switch(t){case I:case S:case b:return!0}return!1},K.prototype.setComponentInfo=function(t){var e=c.getComponent(t.vectorId);e.vectorId=t.vectorId,e.angle=t.angle,e.center=JSON.parse(JSON.stringify(t.center)),e.points2d=JSON.parse(JSON.stringify(t.points2d))};var z=new K,q=function(){this.eventName=null,this.selectItem=null,this.focusItem=null,this.draggingItem=null};q.prototype.getEventName=function(){return this.eventName},q.prototype.setEventName=function(t){this.eventName=t},q.prototype.clearEventName=function(){this.eventName=null},q.prototype.setSelectItem=function(t,e,o){this.selectItem={},this.selectItem.vectorId=t,this.selectItem.type=e,(H.isSymbol(e)||z.isComponent(e)||e==w)&&(this.selectItem.selectIndex=o==E?O:o)},q.prototype.getSelectItem=function(){return this.selectItem},q.prototype.clearSelectItem=function(){this.selectItem=null},q.prototype.getDraggingItem=function(){return this.draggingItem},q.prototype.setDraggingItem=function(t){this.draggingItem=t},q.prototype.clearDraggingItem=function(){this.draggingItem=null},q.prototype.getFocusItem=function(){return this.focusItem},q.prototype.setFocusItem=function(t){this.focusItem=t},q.prototype.clearFocusItem=function(){this.focusItem=null},q.prototype.clearItems=function(){this.selectItem=null,this.focusItem=null,this.draggingItem=null};var Z=new q,Q=function(t){function e(e,o){t.call(this),this.center=e,this.points2d=[],this.title="",this.des="",this.unit="m",this.name="标注",this.adding=!0,this.sideWidth=30,this.sideThickness=30,this.geoType=w,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),r.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/a.res*i.defaultZoom/a.zoom/2,e=this.center.y-this.sideThickness/a.res*i.defaultZoom/a.zoom/2,o=this.center.x+this.sideWidth/a.res*i.defaultZoom/a.zoom/2,n=this.center.y+this.sideThickness/a.res*i.defaultZoom/a.zoom/2,s={x:t,y:n},r={x:o,y:n},l={x:o,y:e},h={x:t,y:e};this.points2d.push(s),this.points2d.push(r),this.points2d.push(l),this.points2d.push(h);var c=(s.x-this.center.x)/2,d=(s.y-this.center.y)/2;this.points2d.push({x:s.x-c,y:s.y-d}),this.points2d.push({x:r.x+c,y:s.y-d}),this.points2d.push({x:this.center.x,y:s.y-d}),this.points2d.push({x:this.center.x,y:l.y+d})},e.prototype.setTitle=function(t){this.title=t},e.prototype.setDes=function(t){this.des=t},e.prototype.setUnit=function(t){this.unit=t},e.prototype.setAdding=function(t){this.adding=t},e}(C),tt=function(){this.pad={top:60,bottom:60,left:265,right:265},this.region={},this.measureLines={top:[],bottom:[],left:[],right:[]},this.minDis=null,this.unit="m",this.defalutMeasurePad={bottom:60,right:265}};tt.prototype.padding=function(t){void 0===t&&(t={}),Object.assign(this.pad,t),Object.assign(this.defalutMeasurePad,t)},tt.prototype.updatePad=function(t){Object.assign(this.pad,t)},tt.prototype.updateRegion=function(t){this.region.top=this.pad.top,this.region.bottom=a.height-this.pad.bottom,this.region.left=this.pad.left,this.region.right=a.width-this.pad.right},tt.prototype.update=function(){null==this.minDis&&(this.minDis=100/a.res);var t=[],e=[],o=[],n=[],i=[],s=c.getPoints();for(var r in s){var l=s[r];i.push({x:l.x,y:l.y})}function h(t,e){return e.y-t.y}function d(t,e){return t.x-e.x}t=[].concat(i).sort(h.bind(this)),(e=[].concat(t)).reverse(),o=[].concat(i).sort(d.bind(this)),(n=[].concat(o)).reverse();var p=null,y=null;this.measureLines.top=[];for(var u=0;u<t.length;++u)if(0==u)p=t[0].x,y=t[0].x,this.measureLines.top.push({x:t[0].x,y:this.region.top});else{if(t[u].x>=p&&t[u].x<=y)continue;(p=Math.min(p,t[u].x))!=(y=Math.max(y,t[u].x))&&this.measureLines.top.push({x:t[u].x,y:this.region.top})}t=this.measureLines.top.sort(d.bind(this)),this.measureLines.top=[],this.measureLines.top.push(t[0]);for(var g=0;g<t.length-1;++g){p=t[g],y=null;for(var f=g+1;f<t.length&&(y=t[f],Math.abs(p.x-y.x)<this.minDis);++f)y=null,++g;if(null!=y)this.measureLines.top.push(y);else if(g==t.length-1){var x=this.measureLines.top.length;this.measureLines.top[x-1]=t[g];break}}this.measureLines.bottom=[];for(var m=0;m<e.length;++m)if(0==m)p=e[0].x,y=e[0].x,this.measureLines.bottom.push({x:e[0].x,y:this.region.bottom});else{if(e[m].x>=p&&e[m].x<=y)continue;(p=Math.min(p,e[m].x))!=(y=Math.max(y,e[m].x))&&this.measureLines.bottom.push({x:e[m].x,y:this.region.bottom})}e=this.measureLines.bottom.sort(d.bind(this)),this.measureLines.bottom=[],this.measureLines.bottom.push(e[0]);for(var v=0;v<e.length-1;++v){p=e[v],y=null;for(var P=v+1;P<e.length&&(y=e[P],Math.abs(p.x-y.x)<this.minDis);++P)y=null,++v;if(null!=y)this.measureLines.bottom.push(y);else if(v==e.length-1){var I=this.measureLines.bottom.length;this.measureLines.bottom[I-1]=e[v];break}}this.measureLines.left=[];for(var S=0;S<o.length;++S)if(0==S)p=o[0].y,y=o[0].y,this.measureLines.left.push({x:this.region.left,y:o[0].y});else{if(o[S].y>=p&&o[S].y<=y)continue;(p=Math.min(p,o[S].y))!=(y=Math.max(y,o[S].y))&&this.measureLines.left.push({x:this.region.left,y:o[S].y})}o=this.measureLines.left.sort(h.bind(this)),this.measureLines.left=[],this.measureLines.left.push(o[0]);for(var b=0;b<o.length-1;++b){p=o[b],y=null;for(var k=b+1;k<o.length&&(y=o[k],Math.abs(p.y-y.y)<this.minDis);++k)y=null,++b;if(null!=y)this.measureLines.left.push(y);else if(b==o.length-1){var w=this.measureLines.left.length;this.measureLines.left[w-1]=o[b];break}}this.measureLines.right=[];for(var W=0;W<n.length;++W)if(0==W)p=n[0].y,y=n[0].y,this.measureLines.right.push({x:this.region.right,y:n[0].y});else{if(n[W].y>=p&&n[W].y<=y)continue;(p=Math.min(p,n[W].y))!=(y=Math.max(y,n[W].y))&&this.measureLines.right.push({x:this.region.right,y:n[W].y})}n=this.measureLines.right.sort(h.bind(this)),this.measureLines.right=[],this.measureLines.right.push(n[0]);for(var F=0;F<n.length-1;++F){p=n[F],y=null;for(var C=F+1;C<n.length&&(y=n[C],Math.abs(p.y-y.y)<this.minDis);++C)y=null,++F;if(null!=y)this.measureLines.right.push(y);else if(F==n.length-1){var T=this.measureLines.right.length;this.measureLines.right[T-1]=n[F];break}}};var et=new tt,ot=["","⅛","¼","⅜","½","⅝","¾","⅞"],nt=function(t,e,o,n){this.name=t,this.symbol=e,this.base=o,this.factor=n};nt.prototype.toBase=function(t){return t*this.factor},nt.prototype.fromBase=function(t){return t/this.factor};var it={MILLIMETER:["Millimeter","mm"],CENTIMETER:["Centimeter","cm"],METER:["Meter","m"],KILOMETER:["Kilometer","km"],INCH:["Inch","in"],FOOT:["Foot","ft"],MILE:["Mile","mi"],SQUAREMETER:["SquareMeter","m²"],SQUAREFOOT:["SquareFoot","ft²"],CUBICMETER:["CubicMeter","m³"],CUBICFOOT:["CubicFoot","ft³"],BYTE:["Byte","B"],KILOBYTE:["Kilobyte","kB"],MEGABYTE:["Megabyte","MB"],GIGABYTE:["Gigabyte","GB"],TERABYTE:["Terabyte","TB"],PETABYTE:["Petabyte","PB"],init:function(){var t,e,o,n,i,s,r,l,a,h,c,d=new nt(it.METER[0],it.METER[1],void 0,1),p=new nt(it.SQUAREMETER[0],it.SQUAREMETER[1],void 0,1),y=new nt(it.CUBICMETER[0],it.CUBICMETER[1],void 0,1),u=new nt(it.BYTE[0],it.BYTE[1],void 0,1);it.DISTANCE=((t={}).metric=((e={})[it.MILLIMETER[0]]=new nt(it.MILLIMETER[0],it.MILLIMETER[1],d,.001),e[it.CENTIMETER[0]]=new nt(it.CENTIMETER[0],it.CENTIMETER[1],d,.01),e[it.METER[0]]=d,e[it.KILOMETER[0]]=new nt(it.KILOMETER[0],it.KILOMETER[1],d,1e3),e),t.imperial=((o={})[it.INCH[0]]=new nt(it.INCH[0],it.INCH[1],d,.0254),o[it.FOOT[0]]=new nt(it.FOOT[0],it.FOOT[1],d,.3048),o[it.MILE[0]]=new nt(it.MILE[0],it.MILE[1],d,1609.344),o),t),it.AREA=((n={}).metric=((i={})[it.SQUAREMETER[0]]=p,i),n.imperial=((s={})[it.SQUAREFOOT[0]]=new nt(it.SQUAREFOOT[0],it.SQUAREFOOT[1],p,.092903),s),n),it.VOLUME=((r={}).metric=((l={})[it.CUBICMETER[0]]=y,l),r.imperial=((a={})[it.CUBICFOOT[0]]=new nt(it.CUBICFOOT[0],it.CUBICFOOT[1],y,.0283168),a),r);var g=((h={})[it.BYTE[0]]=u,h[it.KILOBYTE[0]]=new nt(it.KILOBYTE[0],it.KILOBYTE[1],u,1e3),h[it.MEGABYTE[0]]=new nt(it.MEGABYTE[0],it.MEGABYTE[1],u,1e6),h[it.GIGABYTE[0]]=new nt(it.GIGABYTE[0],it.GIGABYTE[1],u,1e9),h[it.TERABYTE[0]]=new nt(it.TERABYTE[0],it.TERABYTE[1],u,1e12),h[it.PETABYTE[0]]=new nt(it.PETABYTE[0],it.PETABYTE[1],u,1e15),h);it.DATA=((c={}).metric=g,c.imperial=g,c)},getUnitsOfMeasurementByDomain:function(t){return this[t.toUpperCase()]},getUnitsOfMeasurementByDomainAndSystem:function(t,e){var o=this.getUnitsOfMeasurementByDomain(t);if(o.hasOwnProperty(e.toLowerCase()))return o[e.toLowerCase()];console.error(n+" measurement system is not supported.")},getDefaultUnitByDomainAndSystem:function(t,e){switch(t.toUpperCase()){case"DISTANCE":switch(e.toLowerCase()){case"metric":return this.DISTANCE.metric[this.METER[0]];case"imperial":return this.DISTANCE.imperial[this.FOOT[0]];default:console.error(e+" measurement system is not supported.")}case"AREA":switch(e.toLowerCase()){case"metric":return this.AREA.metric[this.SQUAREMETER[0]];case"imperial":return this.AREA.imperial[this.SQUAREFOOT[0]];default:console.error(e+" measurement system is not supported.")}case"VOLUME":switch(e.toLowerCase()){case"metric":return this.VOLUME.metric[this.CUBICMETER[0]];case"imperial":return this.VOLUME.imperial[this.CUBICFOOT[0]];default:console.error(e+" measurement system is not supported.")}case"DATA":switch(e.toLowerCase()){case"metric":return this.DATA.metric[this.BYTE[0]];case"imperial":return this.DATA.imperial[this.BYTE[0]];default:console.error(e+" measurement system is not supported.")}default:console.error(t+" measurement domain is not supported.")}}},st=function(){this.LOCAL_STORAGE_KEY="iv_unit_key",it.init(),this.unitSystems=["metric","imperial"],this.defaultSystem="metric"},rt=function(){this.UnitService=new st};rt.prototype.scopedConvert=function(t,o,n,i,s){return void 0===n&&(n=2),e.convert(t,o,n,i,s)},rt.prototype.convert=function(t,e,o,n,i,s){if(void 0===o&&(o=2),void 0===s&&(s=!1),!t)return"";var r=this.getMostRelevantMeasurement(e,n||this.UnitService.currentSystem,t,i);return this.getFormattedMeasurementString(r[0],r[1],o,s)},rt.prototype.getFormattedMeasurementString=function(t,e,o,n){return n&&e.name===it.FOOT[0]?this.formatImperialDistance(12*t):n&&e.name===it.INCH[0]?this.formatImperialDistance(t):t.toLocaleString(void 0,{minimumFractionDigits:o,maximumFractionDigits:o})+" "+e.symbol},rt.prototype.formatImperialDistance=function(t){var e=Math.round(8*t),o=Math.floor(e/8),n=Math.floor(o/12),i=o-12*n,s=ot[e%8],r=0===i&&""!==s?"":i;return""!==r&&""!==s&&(s=" "+s),0!==n?n+"' "+r+s+'"':""+r+s+'"'},rt.prototype.getMostRelevantMeasurement=function(t,e,o,n){void 0===n&&(n=0);var i=[],s=it.getUnitsOfMeasurementByDomainAndSystem(t,e);for(var r in s)i.push(s[r]);var l=i.filter((function(t){return t.factor>=n})).reduce((function(t,e){return e.fromBase(o)<t.fromBase(o)&&e.fromBase(o)>=1?e:t}));return l?[l.fromBase(o),l]:void 0},rt.prototype.getMostRelevantMeasurement2=function(t,e,o,n){void 0===n&&(n=0);var i=[],s=it.getUnitsOfMeasurementByDomainAndSystem(t,e);for(var r in s)i.push(s[r]);var l=i.filter((function(t){return t.factor>=n})).reduce((function(t,e){return e.toBase(o)<t.toBase(o)&&e.toBase(o)>=1?e:t}));return l?[l.toBase(o),l]:void 0},rt.prototype.convertBack=function(t,e,o,n,i){if(void 0===o&&(o=2),!t)return"";t=t.trim().replace(",","");var s=it.getDefaultUnitByDomainAndSystem(e,"metric"),r=this.getMostRelevantMeasurement2(e,n,t,i);return this.getFormattedMeasurementString(r[0],s,o)};var lt=new rt,at=function(){};at.prototype.createTag=function(t,e,o){var n=new Q(t,e);return n.setPoints2d(),c.addTag(n,o),n},at.prototype.setTagInfo=function(t){var e=c.getTag(t.vectorId);e.vectorId=t.vectorId,e.center=JSON.parse(JSON.stringify(t.center)),e.points2d=JSON.parse(JSON.stringify(t.points2d)),e.title=t.title,e.des=t.des,e.unit=t.unit,e.adding=t.adding},at.prototype.deleteTag=function(t,e){c.deleteTag(t,e)},at.prototype.clearDefaultTags=function(){for(var t=0;t<o.floors.length;++t){var e=o.floors[t].tags;for(var n in e){var i=e[n];null!=i.title&&""!=i.title.trim()||null!=i.des&&""!=i.des||this.deleteTag(i.vectorId,t)}}},at.prototype.convertUnit=function(t){for(var e=0;e<o.floors.length;++e){var n=o.floors[e].tags;for(var i in n){var s=n[i];s.unit!=t&&(s.des&&(s.unit=t,"m"==t?(s.des=lt.convertBack(s.des,"area",7,"imperial",.01,!1),s.des=parseFloat(s.des)):(s.des=lt.convert(s.des,"area",7,"imperial",.01,!1),s.des=s.des.replace("ft²",""))))}}},at.prototype.getTags=function(t){return o.floors[t].tags};var ht=new at,ct=function(){this.aspect=i.cadImg_Width/i.cadImg_Height,this.top=null,this.bottom=null,this.left=null,this.right=null};ct.prototype.getCurrentScale=function(t){var e=c.getAngle();t=t.clone().applyEuler(new THREE.Euler(0,e,0));var o=Math.max(Math.abs(t.x),Math.abs(t.z)*this.aspect),n=Math.min(i.cadImg_Width/i.ratio,i.cadImg_Height/i.ratio);return o/2/10*Math.max(1.2*n/800,1.2)},ct.prototype.setCamera=function(t){var e=-10*t,o=10*t,n=10*t/this.aspect,i=-10*t/this.aspect;this.top=n,this.bottom=i,this.left=e,this.right=o};var dt=new ct,pt=function(t){this.layer=t,this.version="v1.1",this.vectorsJson=null,this.saveFloors=[],this.newVectorId=null,this.boundingBox=null,this.uploadData={}};pt.prototype.loadFloorJson=function(t){var e=this;return!t&&o.floors.length?Promise.resolve():this.layer.app.store.get("flooruser",t).then((function(t){return t.version?t.version==o.version&&(isNaN(t.angle)||void 0===t.angle||null==t.angle?c.setAngle(0):c.setAngle(t.angle),isNaN(t.compass)||void 0===t.compass||null==t.compass?c.setCompass(0):c.setCompass(t.compass),c.setCurrentId(t.currentId),e.load(t.floors)):(e.layer.analyService.initVectors(t),c.setAngle(0),e.layer.reRender()),t})).catch((function(t){return console.error(t)}))},pt.prototype.load=function(t){for(var e=0;e<t.length;++e){var o=t[e];for(var n in c.initFloor(e),o.points)L.createPoint(o.points[n].x,o.points[n].y,o.points[n].vectorId,e);for(var i in o.walls){var s=L.createWall(o.walls[i].start,o.walls[i].end,o.walls[i].vectorId,e);s.setImportant(o.walls[i].important),s.setOut(o.walls[i].out),s.setChildren(o.walls[i].children)}for(var r in o.symbols){var l=H.createSymbol(o.symbols[r].startPoint,o.symbols[r].endPoint,o.symbols[r].geoType,o.symbols[r].parent,o.symbols[r].vectorId);l.openSide=o.symbols[r].openSide,l.enter=o.symbols[r].enter,l.points2d=JSON.parse(JSON.stringify(o.symbols[r].points2d))}for(var a in o.components){var h=z.createComponent(o.components[a].center,o.components[a].geoType,o.components[a].vectorId);h.angle=o.components[a].angle,h.points2d=JSON.parse(JSON.stringify(o.components[a].points2d))}for(var d in c.setBoundingBox(o.boundingBox,e),o.tags){var p=ht.createTag(o.tags[d].center,o.tags[d].vectorId,e);p.setPoints2d(),p.setTitle(o.tags[d].title),p.setDes(o.tags[d].des),p.setUnit(o.tags[d].unit),p.setAdding(!1)}}},pt.prototype.uploadCad=function(){var t=this.layer.app.core.get("Player").model.size,e=dt.getCurrentScale(t);return dt.setCamera(e),this.uploadData.cadInfo=[],this.exportCadImgs()},pt.prototype.base64ToBlob=function(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],n=atob(e[1]),i=n.length,s=new Uint8Array(i);i--;)s[i]=n.charCodeAt(i);return new Blob([s],{type:o})},pt.prototype.exportImg=function(t){var e=t.toDataURL("png",3);return this.base64ToBlob(e)},pt.prototype.exportCadImgs=function(){var t=this;this.layer.uiControl.menu_flex(),ht.clearDefaultTags(),this.layer.history.save(),Z.clearItems(),et.updateRegion(!0),et.update();var e=this.layer.canvas;e.width=i.cadImg_Width,e.height=i.cadImg_Height,a.width=i.cadImg_Width/i.ratio,a.height=i.cadImg_Height/i.ratio,a.ratio=i.ratio,a.res=Math.min(i.cadImg_Width/i.ratio/Math.abs(dt.right-dt.left),i.cadImg_Height/i.ratio/Math.abs(dt.top-dt.bottom)),this.layer.renderer.autoRedrawForImg();var o=window.KanKan.Deferred();return setTimeout((function(){var n=c.getFloorNum();if(t.uploadData.files=[],1==n){var i=t.exportImg(e);t.uploadData.files.push(i),historyService.clearHistoryRecord(),t.layer.$xui.toolbar.recall=!1,t.layer.$xui.toolbar.recover=!1}else{for(var s=t.exportImg(e),r=c.getCurrentFloor(),l=0;l<n;++l)if(l!=r){t.layer.uiControl.currentFloor=l,t.layer.renderer.autoRedrawForImg();var h=t.exportImg(e);t.uploadData.files.push(h)}else t.uploadData.files.push(s);t.layer.uiControl.currentFloor=r}t.uploadData.cadInfo=c.getCadInfo(e),a.updateForCanvas(e),a.setRes(dt.left,dt.right),a.ratio=1,t.layer.renderer.autoRedraw(),t.exportMiniMap(o)}),100),o},pt.prototype.exportMiniMap=function(t){var e=this;t=t||window.KanKan.Deferred(),Z.clearItems();var o=this.layer.canvas;return o.width=i.miniMap_Width,o.height=i.miniMap_Height,a.width=i.miniMap_Width/i.ratio,a.height=i.miniMap_Height/i.ratio,a.ratio=i.ratio,a.res=Math.min(i.miniMap_Width/i.ratio/Math.abs(dt.right-dt.left),i.miniMap_Height/i.ratio/Math.abs(dt.top-dt.bottom)),this.layer.renderer.redrawCore(),setTimeout((function(){var n=c.getFloorNum();if(e.uploadData.miniMaps=[],1==n){var i=e.exportImg(o);e.uploadData.miniMaps.push(i)}else{for(var s=e.exportImg(o),r=c.getCurrentFloor(),l=0;l<n;++l)if(l!=r){e.layer.uiControl.currentFloor=l;var h=e.exportImg(o);e.layer.renderer.redrawCore(),e.uploadData.miniMaps.push(h)}else e.uploadData.miniMaps.push(s);e.layer.uiControl.currentFloor=r}o.width=window.innerWidth,o.height=window.innerHeight,a.updateForCanvas(o);var d=e.layer.app.core.get("CameraControls").activeControl.camera;a.setRes(d.left,d.right),a.ratio=1,e.layer.renderer.autoRedraw(),t.resolve(e.uploadData)}),100),t};var yt=function(t){function e(e,o,n){t.call(this),this.start=e,this.end=o,this.name=null,this.display=!1,this.geoType=k,this.setId(n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setPositions=function(t,e){this.start.x=t.x,this.start.y=t.y,this.end.x=e.x,this.end.y=e.y},e}(C),ut="StartAddWall",gt="NewWall",ft="StartSymbolPoints",xt="EndSymbolPoints",mt="CheckLinesX",vt="CheckLinesY",Pt="vCheckLinesX",It="vCheckLinesY",St=function(){this.wallInfo={wallId:null,state:null},this.pointInfo={pointId:null,state:null},this.symbolInfo={symbolId:null,state:null},this.componentInfo={componentId:null,state:null},this.tagInfo={tagId:null,state:null},this.modifyPoint=null};St.prototype.start=function(t,e,o){var n=this.getNearForVectors(t,e,o);n.modifyPoint&&(n.modifyPoint.hasOwnProperty("linkedPointId")||n.modifyPoint.hasOwnProperty("linkedPointIdX")||n.modifyPoint.hasOwnProperty("linkedPointIdY")||n.modifyPoint.hasOwnProperty("linkedWallId"))?(this.modifyPoint={x:n.modifyPoint.x,y:n.modifyPoint.y},n.modifyPoint.hasOwnProperty("linkedPointId")&&null!=n.modifyPoint.linkedPointId?this.modifyPoint.linkedPointId=n.modifyPoint.linkedPointId:n.modifyPoint.hasOwnProperty("linkedWallId")&&null!=n.modifyPoint.linkedWallId?this.modifyPoint.linkedWallId=n.modifyPoint.linkedWallId:(n.modifyPoint.hasOwnProperty("linkedPointIdX")&&null!=n.modifyPoint.linkedPointIdX&&(this.modifyPoint.linkedPointIdX=n.modifyPoint.linkedPointIdX),n.modifyPoint.hasOwnProperty("linkedPointIdY")&&null!=n.modifyPoint.linkedPointIdY&&(this.modifyPoint.linkedPointIdY=n.modifyPoint.linkedPointIdY))):this.modifyPoint=null;var s=this.updateSelectInfos(n,i.minAdsorb);return this.updateSelectItem(),s},St.prototype.getNearForVectors=function(t,e,o){var n=null,s=null,l={},a=null,h=[];e&&h.push(e);var d=c.getWalls();for(var p in d)if(!o||!o.hasOwnProperty(p)){var y=c.getWall(p),u=c.getPoint(y.start),g=c.getPoint(y.end),f=null,x=L.getLine(y);if(x){var m=r.getJoinLinePoint(t,x);if(-1==h.indexOf(y.start)){if(h.push(y.start),f=r.getDistance(t,u),(null==n||n.distance>f)&&(n={distance:f,pointId:y.start},r.getDistance(m,t)<i.minAdsorb&&r.getDistance(m,u)<i.minAdsorb||n.distance<i.minAdsorb)){l.linkedPointId=y.start,l.x=u.x,l.y=u.y,delete l.linkedPointIdX,delete l.linkedPointIdY;break}if(Math.abs(t.x-u.x)<i.minAdsorb)if(l.linkedPointIdX){var v=c.getPoint(l.linkedPointIdX);r.getDistance(t,v)>r.getDistance(t,u)&&(l.x=u.x,l.linkedPointIdX=y.start)}else l.x=u.x,l.linkedPointIdX=y.start;if(Math.abs(t.y-u.y)<i.minAdsorb)if(l.linkedPointIdY){var P=c.getPoint(l.linkedPointIdY);r.getDistance(t,P)>r.getDistance(t,u)&&(l.y=u.y,l.linkedPointIdY=y.start)}else l.y=u.y,l.linkedPointIdY=y.start}if(-1==h.indexOf(y.end)){if(h.push(y.end),f=r.getDistance(t,g),(null==n||n.distance>f)&&(n={distance:f,pointId:y.end},r.getDistance(m,t)<i.minAdsorb&&r.getDistance(m,g)<i.minAdsorb||n.distance<i.minAdsorb)){l.linkedPointId=y.end,l.x=g.x,l.y=g.y,delete l.linkedPointIdX,delete l.linkedPointIdY;break}if(Math.abs(t.x-g.x)<i.minAdsorb)if(l.linkedPointIdX){var I=c.getPoint(l.linkedPointIdX);r.getDistance(t,I)>r.getDistance(t,g)&&(l.x=g.x,l.linkedPointIdX=y.end)}else l.x=g.x,l.linkedPointIdX=y.end;if(Math.abs(t.y-g.y)<i.minAdsorb)if(l.linkedPointIdY){var S=c.getPoint(l.linkedPointIdY);r.getDistance(t,S)>r.getDistance(t,g)&&(l.y=g.y,l.linkedPointIdY=y.end)}else l.y=g.y,l.linkedPointIdY=y.end}f=r.getDistance(t,m);var b=L.isContain(y,m);b&&(null==s||s.distance>f)&&(s={distance:f,wallId:p}),b&&r.getDistance(t,m)<i.minAdsorb&&((a=m).linkedWallId=p)}else c.deleteWall(p)}var k={minPoint:n,minWall:s,symbolInfo:{},componentInfo:{},tagInfo:{}};null!=a?k.modifyPoint=JSON.parse(JSON.stringify(a)):l.hasOwnProperty("x")&&l.hasOwnProperty("y")?k.modifyPoint=JSON.parse(JSON.stringify(l)):l.hasOwnProperty("x")?(k.modifyPoint=JSON.parse(JSON.stringify(l)),k.modifyPoint.x=l.x,k.modifyPoint.y=t.y):l.hasOwnProperty("y")&&(k.modifyPoint=JSON.parse(JSON.stringify(l)),k.modifyPoint.x=t.x,k.modifyPoint.y=l.y);var w=c.getSymbols();for(var W in w){var F=c.getSymbol(W).isContain(t);if(null!=F){k.symbolInfo={symbolId:W,state:F};break}}var C=c.getComponents();for(var T in C){if(c.getComponent(T).isContain(t)){k.componentInfo={componentId:T,state:"all"};break}}var D=c.getTags();for(var M in D){if(c.getTag(M).isContain(t)){k.tagInfo={tagId:M,state:"all"};break}}return k},St.prototype.updateSelectInfos=function(t,e){var o=!1;null!=t.minPoint?t.minPoint.distance<e?(o=this.isChanged(t.minPoint.pointId,E,1),this.pointInfo={pointId:t.minPoint.pointId,state:E}):(o=this.isChanged(t.minPoint.pointId,null,1),this.pointInfo={pointId:t.minPoint.pointId,state:null}):(o=this.isChanged(null,null,1),this.pointInfo={pointId:null,state:null});var n=!1;null!=t.minWall?t.minWall.distance<e?(n=this.isChanged(t.minWall.wallId,E,2),this.wallInfo={wallId:t.minWall.wallId,state:E}):(n=this.isChanged(t.minWall.wallId,null,2),this.wallInfo={wallId:t.minWall.wallId,state:null}):(n=this.isChanged(null,null,2),this.wallInfo={wallId:null,state:null});var i=this.isChanged(t.symbolInfo.symbolId,t.symbolInfo.state,3);this.symbolInfo={symbolId:t.symbolInfo.symbolId,state:t.symbolInfo.state};var s=this.isChanged(t.componentInfo.componentId,t.componentInfo.state,4);this.componentInfo={componentId:t.componentInfo.componentId,state:t.componentInfo.state};var r=this.isChanged(t.tagInfo.tagId,t.tagInfo.state,5);return this.tagInfo={tagId:t.tagInfo.tagId,state:t.tagInfo.state},o||n||i||s||r},St.prototype.isChanged=function(t,e,o){var n=!1;return 1==o?n=(null!=e||e!=this.pointInfo.state)&&(this.pointInfo.pointId!=t||e!=this.pointInfo.state):2==o?n=(null!=e||e!=this.wallInfo.state)&&(this.wallInfo.wallId!=t||e!=this.wallInfo.state):3==o?n=(null!=e||e!=this.symbolInfo.state)&&(this.symbolInfo.symbolId!=t||e!=this.symbolInfo.state):4==o?n=(null!=e||e!=this.componentInfo.state)&&(this.componentInfo.componentId!=t||e!=this.componentInfo.state):5==o&&(n=(null!=e||e!=this.tagInfo.state)&&(this.tagInfo.tagId!=t||e!=this.tagInfo.state)),n},St.prototype.updateSelectItem=function(){if(null!=this.tagInfo.tagId&&null!=this.tagInfo.state){var t=c.getTag(this.tagInfo.tagId);Z.setSelectItem(this.tagInfo.tagId,t.geoType,this.tagInfo.state)}else if(null!=this.componentInfo.componentId&&null!=this.componentInfo.state){var e=c.getComponent(this.componentInfo.componentId);Z.setSelectItem(this.componentInfo.componentId,e.geoType,this.componentInfo.state)}else if(null!=this.symbolInfo.symbolId&&null!=this.symbolInfo.state){var o=c.getSymbol(this.symbolInfo.symbolId);Z.setSelectItem(this.symbolInfo.symbolId,o.geoType,this.symbolInfo.state)}else null!=this.pointInfo.pointId&&null!=this.pointInfo.state?Z.setSelectItem(this.pointInfo.pointId,p,E):null!=this.wallInfo.wallId&&null!=this.wallInfo.state?Z.setSelectItem(this.wallInfo.wallId,y,E):Z.clearSelectItem()},St.prototype.clear=function(){this.wallInfo={wallId:null,state:null},this.pointInfo={pointId:null,state:null},this.symbolInfo={symbolId:null,state:null},this.componentInfo={componentId:null,state:null},this.modifyPoint=null};var bt=new St,kt=function(){this.startAddWall=null,this.newWall=null,this.symbolPoints={Start:null,End:null},this.checkLines={X:null,Y:null},this.vCheckLines={X:null,Y:null},this.init()};kt.prototype.init=function(){this.startAddWall=new T(0,0),this.startAddWall.name=ut,this.newWall=new yt({x:0,y:0},{x:1,y:1}),this.newWall.name=gt,this.symbolPoints.Start=new T(0,0),this.symbolPoints.Start.name=ft,this.symbolPoints.End=new T(0,0),this.symbolPoints.End.name=xt,this.checkLines.X=new yt({x:0,y:0},{x:1,y:1}),this.checkLines.X.name=mt,this.checkLines.Y=new yt({x:0,y:0},{x:1,y:1}),this.checkLines.Y.name=vt,this.vCheckLines.X=new yt({x:0,y:0},{x:1,y:1}),this.vCheckLines.X.name=Pt,this.vCheckLines.Y=new yt({x:0,y:0},{x:1,y:1}),this.vCheckLines.Y.name=It},kt.prototype.showStartAddWall=function(){this.startAddWall.display=!0},kt.prototype.hideStartAddWall=function(){this.startAddWall.display=!1},kt.prototype.setStartAddWall=function(t){this.startAddWall.setPosition(t)},kt.prototype.showSymbolPoints=function(){this.symbolPoints.Start.display=!0,this.symbolPoints.End.display=!0},kt.prototype.hideSymbolPoints=function(){this.symbolPoints.Start.display=!1,this.symbolPoints.End.display=!1},kt.prototype.setSymbolPoints=function(t,e){this.symbolPoints.Start.setPosition(t),this.symbolPoints.End.setPosition(e)},kt.prototype.showNewWall=function(){this.newWall.display=!0},kt.prototype.hideNewWall=function(){this.newWall.display=!1},kt.prototype.setNewWall=function(t,e){this.newWall.setPositions(t,e)},kt.prototype.setNewWallStartPosition=function(t){this.newWall.start.x=t.x,this.newWall.start.y=t.y},kt.prototype.setNewWallEndPosition=function(t){this.newWall.end.x=t.x,this.newWall.end.y=t.y},kt.prototype.setNewWallState=function(t){this.newWall.state=t},kt.prototype.showCheckLinesX=function(){this.checkLines.X.display=!0},kt.prototype.hideCheckLinesX=function(){this.checkLines.X.display=!1},kt.prototype.setCheckLinesX=function(t,e){this.checkLines.X.setPositions(t,e)},kt.prototype.showCheckLinesY=function(){this.checkLines.Y.display=!0},kt.prototype.hideCheckLinesY=function(){this.checkLines.Y.display=!1},kt.prototype.setCheckLinesY=function(t,e){this.checkLines.Y.setPositions(t,e)},kt.prototype.showVCheckLinesX=function(){this.vCheckLines.X.display=!0},kt.prototype.hideVCheckLinesX=function(){this.vCheckLines.X.display=!1},kt.prototype.setVCheckLinesX=function(t,e){this.vCheckLines.X.setPositions(t,e)},kt.prototype.showVCheckLinesY=function(){this.vCheckLines.Y.display=!0},kt.prototype.hideVCheckLinesY=function(){this.vCheckLines.Y.display=!1},kt.prototype.setVCheckLinesY=function(t,e){this.vCheckLines.Y.setPositions(t,e)},kt.prototype.hideAll=function(){this.hideCheckLinesX(),this.hideCheckLinesY(),this.hideStartAddWall(),this.hideNewWall(),this.hideSymbolPoints(),this.hideVCheckLinesX(),this.hideVCheckLinesY()},kt.prototype.execute=function(t,e){if(this.hideVCheckLinesX(),this.hideVCheckLinesY(),this.hideCheckLinesX(),this.hideCheckLinesY(),bt.modifyPoint){if(bt.modifyPoint.linkedPointIdX){var o=c.getPoint(bt.modifyPoint.linkedPointIdX);this.setCheckLinesX(o,e),this.showCheckLinesX()}if(bt.modifyPoint.linkedPointIdY){var n=c.getPoint(bt.modifyPoint.linkedPointIdY);this.setCheckLinesY(n,e),this.showCheckLinesY()}}t&&(Math.abs(e.x-t.x)<i.minAdsorb&&(e.x=t.x,this.setVCheckLinesX(t,e),this.showVCheckLinesX()),Math.abs(e.y-t.y)<i.minAdsorb&&(e.y=t.y,this.setVCheckLinesY(t,e),this.showVCheckLinesY()),r.equalPoint(e,t)&&(this.hideVCheckLinesX(),this.hideVCheckLinesY()))},kt.prototype.checkAngle=function(t,e,o){function n(t,e,o,n){var i=r.createLine1(e,o),s=null;if(1==n){var l=r.getVerticalLine(i,e);s=r.getJoinLinePoint(t,l)}else 2==n&&(s=r.getJoinLinePoint(t,i));return s}for(var i=L.getNeighPoints(e,o),s=c.getPoint(e),l=null,a=0;a<i.length;++a){var h=r.Angle(s,t,i[a]);if(Math.abs(h/Math.PI*180-90)<5?l=n(t,s,i[a],1):(Math.abs(h/Math.PI*180)<5||Math.abs(h/Math.PI*180-180)<5)&&(l=n(t,s,i[a],2)),null!=l)return l}return l};var wt=new kt,Wt=function(){this.history={records:[],currentRecordIndex:-1,state:{pre:0,next:0}}};Wt.prototype.getCurrentRecordIndex=function(){return this.history.currentRecordIndex},Wt.prototype.getHistoryRecord=function(){return null==this.history.currentRecordIndex||0==this.history.records.length?null:this.history.records[this.history.currentRecordIndex]},Wt.prototype.getHistoryRecords=function(){return this.history.records},Wt.prototype.getHistoryState=function(){return this.history.state},Wt.prototype.addHistoryRecord=function(t){var e=this.history.records.length;if(0==e)this.history.records.push(t),this.history.currentRecordIndex=0;else if(this.history.currentRecordIndex+1==e)this.history.records.push(t),++this.history.currentRecordIndex;else{var o=this.history.records.slice(0,this.history.currentRecordIndex+1);o.push(t),this.history.records=o,++this.history.currentRecordIndex}},Wt.prototype.setHistoryState=function(t,e){this.history.state.pre=t,this.history.state.next=e},Wt.prototype.undoHistoryRecord=function(){--this.history.currentRecordIndex},Wt.prototype.redoHistoryRecord=function(){++this.history.currentRecordIndex},Wt.prototype.clearHistoryRecord=function(){this.history.records=[],this.setHistoryState(0,0)},Wt.prototype.hasRecords=function(){return this.history.records.length>0};var Ft=new Wt;window.historyService=Ft;var Ct=function(t){this.layer=t,this.app=this.layer.app,this.houseData=null};Ct.prototype.initVectors=function(t){for(var e=t.floors,n=-1,i=0,s=0,r=0;r<e.length;++r){var l=e[r].subgroup,a=e[r];o.floors[l]={},o.floors[l].points={},o.floors[l].walls={},o.floors[l].symbols={},o.floors[l].components={},o.floors[l].tags={},o.floors[l].boundingBox={},o.floors[l].rooms=[];for(var h=null,p=null,u=null,g=null,f=0;f<a["vertex-xy"].length;++f){var x=a["vertex-xy"][f].id+s;n<x&&(n=x),x=d+x;var m={x:a["vertex-xy"][f].x,y:a["vertex-xy"][f].y};L.createPoint(m.x,m.y,x,l),(null==h||h>m.x)&&(h=m.x),(null==p||p>m.y)&&(p=m.y),(null==u||u<m.x)&&(u=m.x),(null==g||g<m.y)&&(g=m.y)}i=n+1,o.floors[l].boundingBox.minX=h,o.floors[l].boundingBox.minY=p,o.floors[l].boundingBox.maxX=u,o.floors[l].boundingBox.maxY=g;for(var v=0;v<a.segment.length;++v){var P=a.segment[v].id+i;n<P&&(n=P),P=y+P;var I=d+(a.segment[v].a+s),S=d+(a.segment[v].b+s);L.createWall(I,S,P,l)}i=n+1,s=n+1}c.setCurrentId(n+1);var b=this.app.core.get("Player").model.currentFloor.floorIndex;c.setCurrentFloor(b)},Ct.prototype.createDecorateData=function(t){for(var e={name:"houseType.json",version:"2.1",floors:[]},o=0;o<t.floors.length;++o){var n={points:[],walls:[]};for(var i in t.floors[o].points){var s={};s.x=t.floors[o].points[i].x,s.y=t.floors[o].points[i].y,s.parent=t.floors[o].points[i].parent,s.vectorId=t.floors[o].points[i].vectorId,n.points.push(s)}for(var r in t.floors[o].walls){var l={};l.start=t.floors[o].walls[r].start,l.end=t.floors[o].walls[r].end,l.children=[],l.vectorId=t.floors[o].walls[r].vectorId,l.width=.2,n.walls.push(l)}e.floors.push(n)}return e};var Tt="panBackGround",Dt="addWall",Mt="addingWall",Lt="moveWall",Ot="moveWallPoint",At="addSymbol",Rt="moveSymbol",Et="moveSymbolPoint",Nt="addComponent",Bt="moveComponent",Yt="addTag",jt="moveTag",_t="Wall",Jt="OutWall",Xt="SingleDoor",Ut="DoubleDoor",Ht="SlideDoor",Vt="SingleWindow",Gt="BayWindow",$t="FrenchWindow",Kt="Pass",zt="Beam",qt="Flue",Zt="Corridor",Qt="Tag",te=function(t,e,o){this.name=o||"未命名",this.floor=e,this.roomId=t,this.center=null,this.area=null,this.wallIds=[],this.wallPointIDs=[],this.childrenRooms=[],this.childrenWalls=[],this.parent=null,this.tagName=null,this.backgroundImg_src="default",this.boundingBox={}};te.prototype.setInfo=function(t){this.wallIds=t.wallIds,this.wallPointIDs=t.wallPointIDs,this.area=t.area,this.center=t.center,this.boundingBox=t.boundingBox,this.parent=t.parent,this.childrenWalls=t.childrenWalls,this.childrenRooms=t.childrenRooms},te.prototype.containPoint=function(t){for(var e=[],o=0;o<this.wallPointIDs.length;++o){var n=c.getPoint(this.wallPointIDs[o],this.floor);e.push({x:n.x,y:n.y})}return r.isPointInPoly(t,e)};var ee=function(t,e,o){this.pointIds=e,this.segmentIds=t,this.childrenPolygonIds=[],this.childrenSegmentIds=[],this.id=o,this.parent=null,this.center=null,this.boundingBox=null,this.area=0,this.floor=1,this.geoType="Polygon"},oe=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[],this.pre="",this.currentId=1};oe.prototype.init=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[]},oe.prototype.start=function(t,e,o){this.pre=o||"",this.init(),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.createPolygon(null,this.segments,this.points),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.getIncludePolygonInfos(),this.updateChildrenSegmentIds(this.segments,this.points,this.polygons)},oe.prototype.getStartPoint=function(t,e){var o=null,n=null;for(var i in t)if(i!==e){var s=t[i];(null===o||o.x>s.x||o.x===s.x&&o.y>s.y)&&(o={x:s.x,y:s.y},n=i)}return n},oe.prototype.createPolygon=function(t,e,o){if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.matrix={};var n=[];this.preHandle(o,e);var i=Object.keys(e).length;if(0!==Object.keys(o).length&&0!==Object.keys(e).length){null!==t&&o[t]||(t=this.getStartPoint(o)),n.push(t);var s=this.getNextForMinAngleX(t,o,e);if(null!==s){n.push(s);var r=this.getMaxPolygon(n,o,e);this.checkPolygonSegmentIds(r,o,e);var l=this.splitPolygon(r);if(l){var a=this.getPolygonData(l,o,e),h=Object.keys(a.points),c=Object.keys(a.segments);if(a.segments=this.getChildSegments(a.points,a.segments,e),this.createPolygon(l[0],a.segments,a.points),this.updateMartix2(h,c,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.maxPolygons.push(r),this.updateMartix(r,o,e),o[t]||(t=this.getStartPoint(o),s=this.getNextForMinAngleX(t,o,e));var d=[];d.push(t),d.push(s);var p=this.getMinPolygon(d,o,e);if(this.checkPolygonSegmentIds(p,o,e),l=this.splitPolygon(p)){var y=this.getPolygonData(l,o,e),u=Object.keys(y.points),g=Object.keys(y.segments);if(this.createPolygon(l[0],y.segments,y.points),this.updateMartix2(u,g,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==r.length&&0!==p.length){if(this.addPolygon(p,o,e)){var f=p.slice(0);if(f.push(p[0]),this.updateMartix(f,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}if(i===Object.keys(e).length){this.addPolygon(r,o,e);var x=r.slice(0);if(x.push(r[0]),this.updateMartix(x,o,e),this.updateMartix(x,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}var m=this.getStartPoint(o,t);this.createPolygon(m,e,o)}else console.error("createPolygon——————————————————————————————————————————————————————————————出错！")}}}}},oe.prototype.splitPolygon=function(t){for(var e=[],o=0;o<t.length-1;++o){if(-1!==e.indexOf(t[o])){var n=t.slice(0,o+1),i=t.indexOf(t[o]);return n=n.splice(i)}e.push(t[o])}return null},oe.prototype.getPolygonData=function(t,e,o){for(var n={},i={},s=[],l=0;l<t.length;++l)n[t[l]]=e[t[l]],s.push(e[t[l]]);for(var a=this.checkPolygonSegmentIds(t,e,o),h=0;h<a.length;++h)i[a[h]]=o[a[h]];var c=[],d=[];for(var p in e)if(!(t.indexOf(p)>-1||c.indexOf(p)>-1)){var y=e[p];if(r.isPointInPoly(y,s)){c.push(p);var u=y.parent;for(var g in u)if(o[g]&&!i[g]&&-1===d.indexOf(g)){var f=null;o[g].start===p?f=o[g].end:o[g].end===p&&(f=o[g].start);var x=e[f];t.indexOf(f)>-1||c.indexOf(f)>-1?d.push(g):r.isPointInPoly(x,s)&&(d.push(g),c.push(f))}}}for(var m=0;m<c.length;++m)n[c[m]]||(n[c[m]]=e[c[m]]);for(var v=0;v<d.length;++v)i[d[v]]||(i[d[v]]=o[d[v]]);return{points:n,segments:i}},oe.prototype.getChildSegments=function(t,e,o){var n=[];for(var i in t)n.push(i);for(var s=0;s<n.length-1;++s)for(var r=s+1;r<n.length;++r){var l=this.getSegmentId2(t[n[s]],t[n[r]]);null==l||e[l]||(e[l]=o[l])}return e},oe.prototype.updateMartix2=function(t,e,o,n){for(var i=0;i<e.length;++i){var s=e[i];delete this.matrix[s],delete n[s],this.deleteSegment(s,n,o)}for(var r=0;r<t.length;++r){var l=t[r],a=o[l];a&&0!==Object.keys(a.parent).length||delete o[l]}},oe.prototype.addPolygon=function(t,e,o){var n=[],i=[];n[0]=this.getPoint(t[0],e);for(var s=0;s<t.length-1;++s){var l=t[s],a=t[s+1],h=this.getSegmentId(l,a,e,o);i.push(h);var c=this.getPoint(a,e);n.push(c)}var d=this.getId();t.pop();var p=new ee(i,t,d);return p.area=this.getArea(p),p.center=this.getCenter(p),p.boundingBox=r.getBoundingBox(n),this.polygons.push(p),!0},oe.prototype.getMaxPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],s=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===s.min?(t.push(s.min),t):(t.push(s.min),this.getMaxPolygon(t,e,o))},oe.prototype.getMinPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],s=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===s.max?(t.push(s.max),t):(t.push(s.max),this.getMinPolygon(t,e,o))},oe.prototype.getNextForMinAngleX=function(t,e,o){for(var n=e[t],i=this.getAllLinkedPoint(t,e,o),s=null,l=null,a=0;a<i.length;++a){var h=e[i[a]];if(h){var c=r.Angle(n,{x:n.x+1,y:n.y},h);h.y-n.y<0&&(c*=-1),(null===s||s>c)&&(s=c,l=i[a])}}return l},oe.prototype.getNextForMaxMinAngle=function(t,e,o,n){var i=o[t],s=o[e];i&&s||console.error("getNextForMaxMinAngle******************************************");for(var l=s.x-i.x,a=s.y-i.y,h={x:s.x+l,y:s.y+a},c=this.getAllLinkedPoint(e,o,n),d=null,p=null,y=null,u=null,g=0;g<c.length;++g)if(c[g]!==t){var f=o[c[g]];if(f){var x=r.Angle(s,h,f);l*(f.y-s.y)-(f.x-s.x)*a<0&&(x*=-1),(null===d||d<x)&&(d=x,p=c[g]),(null===y||y>x)&&(y=x,u=c[g])}}return{max:p,min:u}},oe.prototype.updateMartix=function(t,e,o){for(var n=0;n<t.length-1;++n){var i=n===t.length-1?0:n+1,s=this.getSegmentId(t[n],t[i],e,o);this.matrix[s]?(delete this.matrix[s],this.deleteSegment(s,o,e)):this.matrix[s]=1}},oe.prototype.getSegmentId=function(t,e,o,n){var i=o[t];if(!i)return null;var s=i.parent;for(var r in s){var l=n[r];if(l&&(l.start===e||l.end===e))return r}return null},oe.prototype.getSegmentId2=function(t,e){var o=t.parent,n=e.parent;for(var i in o)if(n[i])return i;return null},oe.prototype.getAllLinkedPoint=function(t,e,o){var n=[],i=e[t];i||console.error("getAllLinkedPoint");var s=i.parent;for(var r in s){var l=o[r];l&&(l.start===t?n.push(l.end):l.end===t&&n.push(l.start))}return n},oe.prototype.deleteLinksSegment=function(t,e,o){var n=e[t];if(n&&0!==Object.keys(n.parent).length&&o[Object.keys(n.parent)[0]]){var i=this.getOtherPointId(Object.keys(n.parent)[0],t,o);this.deleteSegment(Object.keys(n.parent)[0],o,e);var s=e[i];s&&Object.keys(s.parent).length<2&&this.deleteLinksSegment(i,e,o)}},oe.prototype.deleteSegment=function(t,e,o){if(t&&e[t]){var n=e[t];this.deletePoint(n.start,t,o),this.deletePoint(n.end,t,o),delete e[t]}},oe.prototype.deletePoint=function(t,e,o){if(t&&o[t]){var n=this.getPoint(t,o);delete n.parent[e],0===Object.keys(n.parent).length&&delete o[t]}},oe.prototype.getOtherPointId=function(t,e,o){var n=o[t];return n||console.error("getOtherPointId**********************************************************************"),n.start===e?n.end:n.end===e?n.start:void console.error("getOtherPointId**********************************************************************")},oe.prototype.preHandle=function(t,e){var o=!1;for(var n in t){var i=t[n];if(Object.keys(i.parent).length<2)this.deleteLinksSegment(n,t,e),o=!0;else{var s=0;for(var r in i.parent)e[r]&&++s;if(s>1)continue;delete t[n]}}return o},oe.prototype.getPoint=function(t,e){return e[t]},oe.prototype.isClockwise=function(t,e){for(var o=[],n=0;n<t.length;++n){var i=e[t[n]];o.push({x:i.x,y:i.y})}return r.isClockwise(o)},oe.prototype.getId=function(){var t=this.currentId;return++this.currentId,"Polygon"+t},oe.prototype.getArea=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return r.ComputePolygonArea(e)},oe.prototype.getCenter=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return r.getPolygonCore(e)},oe.prototype.getIncludePolygonInfos=function(){this.polygons=this.polygons.sort((function(t,e){return t.area-e.area}));for(var t=0;t<this.polygons.length-1;++t){for(var e=null,o=t+1;o<this.polygons.length;++o)if(o!==t&&this.isContain(this.polygons[t],this.polygons[o])){e=this.polygons[o];break}null!=e&&(this.polygons[t].parent=e.id,e.childrenPolygonIds.push(this.polygons[t].id),e=null)}},oe.prototype.updateChildrenSegmentIds=function(t,e,o){for(var n=[],i=0;i<o.length;++i){var s=o[i];n=n.concat(s.segmentIds)}for(var r in t)if(!(n.indexOf(r)>-1))for(var l=t[r],a=e[l.start],h=e[l.end],c=0;c<o.length;++c){var d=!1,p=!1,y=o[c];(y.pointIds.indexOf(l.start)>-1||this.containPoint(y,a))&&(d=!0),(y.pointIds.indexOf(l.end)>-1||this.containPoint(y,h))&&(p=!0),d&&p&&y.childrenSegmentIds.push(r)}},oe.prototype.isContain=function(t,e){for(var o=[],n=[],i=0;i<t.pointIds.length;++i){var s=this.points[t.pointIds[i]];o.push(s)}for(var l=0;l<e.pointIds.length;++l){var a=this.points[e.pointIds[l]];n.push(a)}return r.isPolyInPoly(o,n,.01)},oe.prototype.containPoint=function(t,e){for(var o=[],n=0;n<t.pointIds.length;++n){var i=this.points[t.pointIds[n]];o.push(i)}return r.isPointInPoly(e,o)},oe.prototype.checkPolygonSegmentIds=function(t,e,o){for(var n=[],i=0;i<t.length;++i){var s=i===t.length-1?0:i+1;if(t[i]!==t[s]){if(!t[i]||!t[s])return;var r=this.getSegmentId(t[i],t[s],e,o);if(!r)return;n.push(r)}}return n},oe.prototype.setCaves=function(){for(var t=0;t<this.polygons.length;++t){var e=this.polygons[t],o=e.childrenPolygonIds.slice(0);this.getChildMaxPolygons(e,o)}},oe.prototype.getChildPolygonInfo=function(t){if(t.length<2)return null;for(var e=[],o=[],n=0;n<this.polygons.length;++n){var i=this.polygons[n];t.indexOf(i.id)>-1&&(e=e.concat(i.pointIds),o=o.concat(i.segmentIds))}for(var s={},r={},l=0;l<e.length;++l)s[e[l]]=this.points[e[l]];for(var a=0;a<o.length;++a)r[o[a]]=this.segments[o[a]];return{points:s,segments:r}},oe.prototype.getChildMaxPolygons=function(t,e){var o=this.getChildPolygonInfo(e);if(null!=o){var n=this.getStartPoint(o.points),i=[];i.push(n);var s=this.getNextForMinAngleX(n,o.points,o.segments);i.push(s);var r=this.getMaxPolygon(i,o.points,o.segments);r.pop(),t.caves.push(r);for(var l=0;l<e.length;++l)for(var a=this.getPolygon(e[l]),h=0;h<a.pointIds.length;++h)if(r.indexOf(a.pointIds[h])>-1){e.splice(l,1),--l;break}this.getChildMaxPolygons(t,e)}else if(1===e.length){var c=this.getPolygon(e[0]);t.caves.push(c.pointIds)}},oe.prototype.getPolygon=function(t){for(var e=0;e<this.polygons.length;++e){var o=this.polygons[e];if(o.id===t)return o}return console.error("找不到多边形！"),null};var ne=new oe,ie=function(){this.room_hallImg=null,this.room_defaultImg=null,this.room_otherImg=null};ie.prototype.addRoom=function(t,e){o.floors[e].rooms.push(t)},ie.prototype.getRoom=function(t,e){return o.floors[e].rooms[t]},ie.prototype.getRooms=function(t){return o.floors[t].rooms},ie.prototype.clearRooms=function(t){o.floors[t].rooms=[]},ie.prototype.setHallImg=function(t){this.room_hallImg=t},ie.prototype.getHallImg=function(){return this.room_hallImg},ie.prototype.setDefaultImg=function(t){this.room_defaultImg=t},ie.prototype.getDefaultImg=function(){return this.room_defaultImg},ie.prototype.setOtherImg=function(t){this.room_otherImg=t},ie.prototype.getOtherImg=function(){return this.room_otherImg};var se=new ie,re=function(){this.points={},this.segments={},this.polygons=[],this.tempRooms=[]};re.prototype.start=function(){var t=o.floors;console.log("从头开始分房间！");for(var e=0;e<t.length;++e){var n=t[e].walls,i=t[e].points;se.clearRooms(e),this.getRoomForSingleFloor(n,i,e)}this.updateRoomsTagName()},re.prototype.getRoomForSingleFloor=function(t,e,o){this.getRooms(t,e,o);for(var n=0;n<this.tempRooms.length;++n){var i=this.tempRooms[n];i.floor=o;var s=new te(i.roomId,i.floor);s.setInfo({wallIds:i.wallIds,wallPointIDs:i.wallPointIDs,area:i.area,center:i.center,boundingBox:i.boundingBox,parent:i.parent,childrenWalls:i.childrenWalls,childrenRooms:i.childrenRooms}),se.addRoom(s,o)}this.tempRooms=[]},re.prototype.getRooms=function(t,e,o){this.convertToSegments(t,o),this.convertToPoints(e,o),ne.start(this.segments,this.points),this.convertToRoomForPolygon(o),this.points={},this.segments={},this.polygons=[]},re.prototype.convertToPoints=function(t,e){for(var o in t){var n=c.getPoint(o,e),i={pointId:n.vectorId,x:n.x,y:n.y,parent:JSON.parse(JSON.stringify(n.parent))};this.points[n.vectorId]=i}},re.prototype.convertToSegments=function(t,e){for(var o in t){var n=c.getWall(o,e),i={segmentId:n.vectorId,start:n.start,end:n.end};this.segments[n.vectorId]=i}},re.prototype.convertToRoomForPolygon=function(){for(var t=0;t<ne.polygons.length;++t){var e=ne.polygons[t],o={};o.roomId=e.id.replace("Polygon","Room"),console.log("房间："+o.roomId),o.wallIds=e.segmentIds,o.wallPointIDs=e.pointIds,o.area=e.area,o.center=e.center,o.boundingBox=e.boundingBox,null!=e.parent?o.parent=e.parent.replace("Polygon","Room"):o.parent=null,o.childrenRooms=[];for(var n=0;n<e.childrenPolygonIds.length;++n)o.childrenRooms.push(e.childrenPolygonIds[n].replace("Polygon","Room"));o.childrenWalls=[];for(var i=0;i<e.childrenSegmentIds.length;++i)o.childrenWalls.push(e.childrenSegmentIds[i]);this.tempRooms.push(o)}ne.polygons=[]},re.prototype.updateRoomsName=function(){for(var t=0;t<o.floors.length;++t){var e=se.getRooms(t),n=ht.getTags(t);n=JSON.parse(JSON.stringify(n));for(var i=0;i<e.length;++i)e[i]}},re.prototype.updateRoomsTagName=function(){function t(t,e){return t.area-e.area}for(var e=0;e<o.floors.length;++e){var n=se.getRooms(e),i=ht.getTags(e);i=JSON.parse(JSON.stringify(i)),n=n.sort(t);for(var s=0;s<n.length;++s){for(var l=n[s],a=[],h=0;h<l.wallPointIDs.length;++h){var d=c.getPoint(l.wallPointIDs[h],e);a.push(d)}for(var p in i)if(r.isPointInPoly(i[p].center,a)){l.tagName=i[p].title,delete i[p];break}}}};var le=new re,ae=function(){this.startInfo={},this.endInfo={},this.canAdd=!1};ae.prototype.setPointInfo=function(t,e){"start"==t?this.startInfo={position:{x:e.x,y:e.y},linkedPointId:e.linkedPointId,linkedWallId:e.linkedWallId}:"end"==t&&(this.endInfo={position:{x:e.x,y:e.y},linkedPointId:e.linkedPointId,linkedWallId:e.linkedWallId})},ae.prototype.buildWall=function(t){console.log("添加新墙！");var e=this.getJoinsForWalls(),o=this.splitAllJoins(e);this.creatNewWalls(o,t),this.canAdd=!1,this.updateStart(this.endInfo.position,o[o.length-1]),bt.clear()},ae.prototype.creatNewWalls=function(t,e){for(var o=0;o<t.length-1;++o){var n=t[o],i=t[o+1];if(!L.getWallId(n,i))L.createWall(n,i).setOut(e)}},ae.prototype.canAddWallForEnd=function(t){if(bt.modifyPoint){if(r.getDistance(this.startInfo.position,bt.modifyPoint)<i.minAdsorb)return!1}else if(r.getDistance(this.startInfo.position,t)<i.minAdsorb)return!1;if(bt.symbolInfo.symbolId)return!1;var e=c.getSymbols();for(var o in e){var n=e[o];if(n.geoType!=P)if(null!=r.getIntersectionPoint3(n.startPoint,n.endPoint,this.startInfo.position,t))return!1}return!0},ae.prototype.getJoinsForWalls=function(){var t=[],e=c.getWalls(),o=[],n=[];this.startInfo.linkedPointId?(o.push(this.startInfo.linkedPointId),n.push(this.startInfo.linkedPointId),t.push({join:{x:this.startInfo.position.x,y:this.startInfo.position.y},pointId:this.startInfo.linkedPointId})):this.startInfo.linkedWallId?t.push({join:{x:this.startInfo.position.x,y:this.startInfo.position.y},wallId:this.startInfo.linkedWallId}):t.push({join:{x:this.startInfo.position.x,y:this.startInfo.position.y}}),this.endInfo.linkedPointId?(o.push(this.endInfo.linkedPointId),n.push(this.endInfo.linkedPointId),t.push({join:{x:this.endInfo.position.x,y:this.endInfo.position.y},pointId:this.endInfo.linkedPointId})):this.endInfo.linkedWallId?t.push({join:{x:this.endInfo.position.x,y:this.endInfo.position.y},wallId:this.endInfo.linkedWallId}):t.push({join:{x:this.endInfo.position.x,y:this.endInfo.position.y}});var s=r.createLine1(this.startInfo.position,this.endInfo.position);for(var l in e)if(!(this.startInfo.linkedWallId&&this.startInfo.linkedWallId==l||this.endInfo.linkedWallId&&this.endInfo.linkedWallId==l)){var a=e[l];if(!(n.indexOf(a.start)>-1||n.indexOf(a.end)>-1)){var h=c.getPoint(a.start),d=c.getPoint(a.end),p=!1;if(o.indexOf(a.start)<0){o.push(a.start);var y=r.getJoinLinePoint(h,s);r.PointInSegment(y,this.startInfo.position,this.endInfo.position,i.minAdsorb)&&r.getDistance(h,y)<i.minAdsorb&&(t.push({join:{x:y.x,y:y.y},pointId:a.start}),p=!0,n.push(a.start))}if(o.indexOf(a.end)<0){o.push(a.end);var u=r.getJoinLinePoint(d,s);r.PointInSegment(u,this.startInfo.position,this.endInfo.position,i.minAdsorb)&&r.getDistance(d,u)<i.minAdsorb&&(t.push({join:{x:u.x,y:u.y},pointId:a.end}),p=!0,n.push(a.end))}if(!p&&n.indexOf(a.start)<0&&n.indexOf(a.end)<0){var g=r.getIntersectionPoint3(h,d,this.startInfo.position,this.endInfo.position);g&&t.push({join:{x:g.x,y:g.y},wallId:l})}}}return t},ae.prototype.splitAllJoins=function(t){t=t.sort(function(t,e){return r.getDistance(this.startInfo.position,t.join)-r.getDistance(this.startInfo.position,e.join)}.bind(this));for(var e=[],o=0;o<t.length;++o){var n=t[o],i=n.join,s=n.wallId,l=n.pointId;if(l)e.push(l);else if(s){var a=L.createPoint(i.x,i.y).vectorId,h=null;if(t[o+1]&&t[o].wallId==t[o+1].wallId){var d=c.getWall(s),p=c.getPoint(d.start);h=r.getDistance(p,t[o].join)<r.getDistance(p,t[o+1].join)?L.splitWall(s,a,"end"):L.splitWall(s,a,"start")}else h=L.splitWall(s,a,"start");if(null==h){c.deletePoint(a);continue}H.reBelongForSplitWall(s,s,h),e.push(a)}else{var y=L.createPoint(i.x,i.y);e.push(y.vectorId)}}return e},ae.prototype.updateStart=function(t,e){r.clonePoint(this.startInfo.position,t),this.startInfo.linkedPointId=e,wt.setNewWallStartPosition(this.startInfo.position)},ae.prototype.clear=function(){this.startInfo={},this.endInfo={},this.canAdd=!1,wt.hideNewWall(),wt.hideStartAddWall()};var he=new ae,ce=function(t){this.layer=t,this.showTexture=!0},de={selectUI:{configurable:!0},currentUI:{configurable:!0},currentFloor:{configurable:!0},currentUnit:{configurable:!0}};de.selectUI.get=function(){return this.layer.$xui.selectName},de.selectUI.set=function(t){this.layer.$xui.selectName=t,this.layer.updateEventNameForSelectUI()},de.currentUI.get=function(){return this.layer.$xui.currentName},de.currentUI.set=function(t){null===t?this.layer.$xui.hideProps():this.layer.$xui.showProps(t)},de.currentFloor.get=function(){return this.layer.$xui.currentFloor},de.currentFloor.set=function(t){this.layer.display&&(c.setCurrentFloor(t),this.layer.initPanos(c.currentFloor),et.update(),Ft.clearHistoryRecord(),this.layer.$xui.toolbar.recall=!1,this.layer.$xui.toolbar.recover=!1,setTimeout(function(){this.layer.renderer.autoRedraw()}.bind(this),50))},de.currentUnit.get=function(){return this.layer.$xui.currentUnit},de.currentUnit.set=function(t){this.layer.uiControl.currentUI=null,et.unit=t,ht.convertUnit(t),this.layer.history.save(),this.layer.renderer.autoRedraw()},ce.prototype.setAttributes=function(t,e,o){var n=Z.getFocusItem();switch(e){case"remove":if(t==y||"OutWall"==t)c.deleteWall(n.vectorId);else if(H.isSymbol(t))H.deleteSymbol(n.vectorId);else if(z.isComponent(t))c.deleteComponent(n.vectorId);else if(t==w){c.deleteTag(n.vectorId);var i=Z.getDraggingItem();i&&i.vectorId!=n.vectorId&&c.deleteTag(i.vectorId)}else t==p&&L.deleteWallCorner(n.vectorId);Z.clearItems(),Z.clearEventName(),this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"rotate":if(H.isSymbol(t)){var s=c.getSymbol(n.vectorId);if(t==u){if(s.openSide==W)if(r.isClockwise(s.points2d))s.openSide=F;else{var l=s.endPoint;s.endPoint=s.startPoint,s.startPoint=l,s.openSide=F}else if(s.openSide==F)if(r.isClockwise(s.points2d))s.openSide=W;else{var a=s.endPoint;s.endPoint=s.startPoint,s.startPoint=a,s.openSide=W}}else if(t==g||t==m)s.openSide==W?s.openSide=F:s.openSide==F&&(s.openSide=W);else{var h=s.endPoint;s.endPoint=s.startPoint,s.startPoint=h}s.setPoints2d(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"angle":if(z.isComponent(t)){var d=c.getComponent(n.vectorId);d.angle=o,d.setPoints2d(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"width":if(H.isSymbol(t)){if(H.updateSymbolForLen(n.vectorId,o).block){var x=c.getSymbol(n.vectorId);console.log("长度阻止："+r.getDistance(x.startPoint,x.endPoint)),this.layer.$xui.currentAttributes={limit:r.getDistance(x.startPoint,x.endPoint),type:n.type,name:"width",width:r.getDistance(x.startPoint,x.endPoint)}}}else if(z.isComponent(t)){var v=c.getComponent(n.vectorId);v.sideWidth=o,v.setPoints2d()}this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"thickness":if(z.isComponent(t)){var P=c.getComponent(n.vectorId);P.sideThickness=o,P.setPoints2d(),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"split":if(t==y||"OutWall"==t){var I=c.getWall(n.vectorId),S=c.getPoint(I.start),b=c.getPoint(I.end),k={x:(S.x+b.x)/2,y:(S.y+b.y)/2},C=L.createPoint(k.x,k.y),T=L.splitWall(n.vectorId,C.vectorId,"start");I=c.getWall(n.vectorId),S=c.getPoint(I.start),b=c.getPoint(I.end);var D={x:(S.x+b.x)/2,y:(S.y+b.y)/2},M={vectorId:T,type:t};(k.x<D.x||k.x==D.x&&k.y>D.y)&&Z.setFocusItem(M),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"tag":if(t==w){var O=c.getTag(n.vectorId);null!=o&&""!=o.trim()?O.setTitle(o):O.setTitle(KanKan.Config.i18n("cad.input")),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"area":if(t==w){var A=c.getTag(n.vectorId);A.setDes(o),A.setUnit(et.unit),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"default":if("compass"==t)return void c.setCompass(0);if(H.isSymbol(t)){var R=H.getDefaultSymbolLen(t),E=H.updateSymbolForLen(n.vectorId,R);E.block||(this.layer.$xui.currentAttributes={type:n.type,name:"width",width:r.getFixed(r.getDistance(E.start,E.end),2)})}else if(z.isComponent(t)){var N=c.getComponent(n.vectorId);N.sideWidth=z.sideWidth,N.sideThickness=z.sideThickness,N.angle=0,N.setPoints2d(),this.layer.$xui.currentAttributes={name:n.type,width:r.getFixed(N.sideWidth,2),thickness:r.getFixed(N.sideThickness,2),angle:0}}this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"enter":if(t==u||t==g||t==f){var B=c.getSymbol(n.vectorId);B.enter=o?"default":null,this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"enterRotate":if(t==u||t==g||t==f){var Y=c.getSymbol(n.vectorId);null==Y.enter?Y.enter="default":"default"==Y.enter?Y.enter="reverse":"reverse"==Y.enter&&(Y.enter="default")}this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"important":if(t==y)c.getWall(n.vectorId).setImportant(o),this.layer.history.save(),this.layer.renderer.autoRedraw();break;case"wallType":if(t==y){var j=c.getWall(n.vectorId);"OutWall"==o?j.setOut(!0):j.setOut(!1),this.layer.history.save(),this.layer.renderer.autoRedraw()}break;case"compass":c.setCompass(parseFloat(o))}},ce.prototype.showAttributes=function(t){if("compass"!=t){var e=Z.getFocusItem();if(null==e&&(e=Z.getDraggingItem()),H.isSymbol(e.type)){var o=c.getSymbol(e.vectorId),n=r.getDistance(o.startPoint,o.endPoint);n=r.getFixed(n,2),e.type==u||e.type==g||e.type==f?this.layer.$xui.currentAttributes={name:e.type,width:n,enter:o.enter?o.enter:null}:this.layer.$xui.currentAttributes={name:e.type,width:n}}else if(z.isComponent(e.type)){var i=c.getComponent(e.vectorId),s=i.sideWidth,l=i.sideThickness;this.layer.$xui.currentAttributes={name:e.type,width:r.getFixed(s,2),thickness:r.getFixed(l,2),angle:i.angle}}else if(e.type==w){var a=c.getTag(e.vectorId);this.layer.$xui.currentAttributes={name:e.type,tag:a.title,area:a.des}}else if(e.type==y){var h=c.getWall(e.vectorId);this.layer.$xui.currentAttributes={name:h.out?"OutWall":e.type,important:h.important||h.out,wallType:h.out?"OutWall":e.type}}}else this.layer.$xui.currentAttributes={name:"compass",compass:c.getCompass()}},ce.prototype.clearUI=function(){this.selectUI=null},ce.prototype.getSymbolTypeForUI=function(){return this.selectUI==Xt?u:this.selectUI==Ut?g:this.selectUI==Ht?f:this.selectUI==Vt?x:this.selectUI==Gt?m:this.selectUI==$t?v:this.selectUI==Kt?P:void 0},ce.prototype.getComponentTypeForUI=function(){return this.selectUI==zt?I:this.selectUI==qt?S:this.selectUI==Zt?b:void 0},ce.prototype.screenShot=function(t){var e=this;return new Promise((function(o){e.menu_flex(),Z.clearItems(),le.start(),et.updateRegion(!0),et.update();var n=e.layer.canvas;n.width=window.innerWidth*i.ratio,n.height=window.innerHeight*i.ratio,a.width=window.innerWidth,a.height=window.innerHeight,a.ratio=i.ratio;var s=e.layer.app.core.get("CameraControls").activeControl.camera;a.res=Math.min(window.innerWidth/Math.abs(s.right-s.left),window.innerHeight/Math.abs(s.top-s.bottom)),e.layer.renderer.autoRedrawForDownLoadImg(t),setTimeout(function(){var e=this;if(1==c.getFloorNum())this.downloadCadImg(n,"floorPlan.jpg");else{var i=c.getCurrentFloor();this.layer.app.store.getValue("floorcad").floors.forEach((function(o,i){e.currentFloor=i,e.layer.renderer.autoRedrawForDownLoadImg(t),e.downloadCadImg(n,o.name+".jpg")})),this.currentFloor=i}a.updateForCanvas(n),a.setRes(s.left,s.right),a.ratio=1,this.layer.renderer.autoRedraw(),o()}.bind(e),100)}))},ce.prototype.downloadCadImg=function(t,e){var o=t.toDataURL("jpg",3);o=o.replace(this._fixType("jpg"),"image/octet-stream"),this.saveFile(o,e)},ce.prototype.saveFile=function(t,e){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=t,o.download=e;var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},ce.prototype._fixType=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]},ce.prototype.execute=function(t,e){var o=this;switch(Z.clearFocusItem(),Z.clearSelectItem(),this.layer.uiControl.currentUI=null,t){case"recall":this.menu_revoke();break;case"recover":this.menu_recovery();break;case"default":this.menu_default();break;case"download":this.layer.div.style.visibility="hidden",this.menu_screenShot(e).then((function(){o.layer.div.style.visibility="visible"}));break;case"texture":this.showTexture=e,this.layer.app.dom.querySelector('.player[name="main"]').style.visibility=this.showTexture?"visible":"hidden";break;case"clear":this.menu_clear();break;case"panos":this.menu_panos(e);break;case"rotate":this.menu_rotate();break;case"flex":this.menu_flex()}},ce.prototype.menu_revoke=function(){this.layer.revokeHistory()},ce.prototype.menu_recovery=function(){this.layer.recoveryHistory()},ce.prototype.menu_default=function(){var t=this;Ft.clearHistoryRecord(),c.setAngle(0),this.layer.app.store.getValue("metadata").floorPlanUser=0,this.layer.app.store.getValue("metadata").floorPlanAngle=0,this.menu_flex(!0),this.layer.app.core.get("Player").model.floorplanCadImg.updatePlanes(),this.layer.load.loadFloorJson(!0).then((function(){return t.layer.render()})),this.layer.app.MinMap.reload(),this.layer.app.core.get("Player").labelManager.reset()},ce.prototype.menu_screenShot=function(t){return this.layer.stopAddVector(),this.screenShot(t)},ce.prototype.menu_clear=function(){c.clear(),Z.clearEventName(),he.clear(),wt.hideAll(),this.layer.history.save(),this.layer.renderer.autoRedraw()},ce.prototype.menu_panos=function(t){this.layer.renderer.displayPanos=t,this.layer.renderer.autoRedraw()},ce.prototype.menu_rotate=function(){a.reSet();var t=c.getAngle();t=parseFloat(t)+Math.PI/2,Math.abs(t-2*Math.PI)<.1&&(t=0),t%=360,c.setAngle(t);var e=a.getScreenInfoForCAD();e.floorPlanAngle=t,this.layer.app.store.getValue("metadata").floorPlanAngle=t,this.layer.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",e);var o=this.layer.app.core.get("CameraControls").activeControl.camera;a.setRes(o.left,o.right),a.updateForRotate(),this.layer.initPanos(c.getCurrentFloor()),et.update(),this.layer.history.save(),this.layer.renderer.autoRedraw()},ce.prototype.menu_flex=function(t){if(a.center){a.reSet(),this.layer.renderer.autoRedraw();var e=a.getScreenInfoForCAD();if(e.floorPlanAngle=c.getAngle(),this.layer.app.core.get("CameraControls").emit("syncCadAnd3D",e),t){var o=this.layer.app.core.get("CameraControls").activeControl.camera;a.setRes(o.left,o.right)}}},Object.defineProperties(ce.prototype,de);var pe=function(){this.symbol=null};pe.prototype.moveFullSymbol=function(t,e,o){var n=c.getSymbol(e),i=c.getWall(o);if(!i)return null;var s=L.getLine(i),l=r.getVerticalLine(s,t),a=n.len;null==a&&(a=r.getDistance(n.startPoint,n.endPoint));var h=r.getIntersectionPoint(l,s),d=H.getNewPosForSymbol(h,o,e);null!=d&&d.state&&(r.dotPoints(n.startPoint,n.endPoint,d.position1,d.position2)>0?(r.clonePoint(n.startPoint,d.position1),r.clonePoint(n.endPoint,d.position2)):(r.clonePoint(n.endPoint,d.position1),r.clonePoint(n.startPoint,d.position2)),n.parent!=o&&H.changeSymbolForBelong(e,o),n.setOpenSide(t),n.setPoints2d())},pe.prototype.moveSymbolPoint=function(t,e,o){var n=H.moveSymbolSinglePoint(t,e,o);if(null==n)return null;var s=c.getSymbol(e),l={x:(s.startPoint.x+s.endPoint.x)/2,y:(s.startPoint.y+s.endPoint.y)/2};if(r.getDistance(l,n.position)<i.minSymbolLen)return null;var a=c.getWall(s.parent),h=c.getPoint(a.start),d=c.getPoint(a.end);if(o==A){var p=H.getNewForContainSymbols(s.endPoint,n.position,s.parent,e);if(null==p||p.collision)return null;L.isContain(a,n.position)?H.setPosition(s,n.position,"start"):r.getDistance(s.startPoint,h)<r.getDistance(s.startPoint,d)?H.setPosition(s,h,"start"):H.setPosition(s,d,"start")}else{var y=H.getNewForContainSymbols(s.startPoint,n.position,s.parent,e);if(null==y||y.collision)return null;L.isContain(a,n.position)?H.setPosition(s,n.position,"end"):r.getDistance(s.endPoint,h)<r.getDistance(s.endPoint,d)?H.setPosition(s,h,"end"):H.setPosition(s,d,"end")}s.setPoints2d()};var ye=new pe,ue=function(){};ue.prototype.moveFullComponent=function(t,e){var o=c.getComponent(e);r.clonePoint(o.center,t);var n=this.getAdsorbInfo(o);return n||o.setPoints2d(),n},ue.prototype.getAdsorbInfo=function(t){var e=this.getMidPointsEdge(t),o=this.getNearestPoints(e,t.center),n=this.isAdsorb(o.min0,e[0],t.center);return(null!=n||null!=(n=this.isAdsorb(o.min1,e[1],t.center))||null!=(n=this.isAdsorb(o.min2,e[2],t.center))||null!=(n=this.isAdsorb(o.min3,e[3],t.center)))&&(t.center.x+=n.dx,t.center.y+=n.dy,t.setPoints2d(),!0)},ue.prototype.getMidPointsEdge=function(t){var e=[];return e.push({x:(t.points2d[0].x+t.points2d[1].x)/2,y:(t.points2d[0].y+t.points2d[1].y)/2}),e.push({x:(t.points2d[1].x+t.points2d[2].x)/2,y:(t.points2d[1].y+t.points2d[2].y)/2}),e.push({x:(t.points2d[2].x+t.points2d[3].x)/2,y:(t.points2d[2].y+t.points2d[3].y)/2}),e.push({x:(t.points2d[3].x+t.points2d[0].x)/2,y:(t.points2d[3].y+t.points2d[0].y)/2}),e},ue.prototype.getNearestPoints=function(t,e){var o=c.getWalls(),n=r.createLine1(t[0],t[2]),i=r.createLine1(t[1],t[3]),s=null,l=null,a=null,h=null;for(var d in o){var p=o[d],y=c.getPoint(p.start),u=c.getPoint(p.end),g=r.getIntersectionPoint4(y,u,n);null!=g&&(r.isContainForSegment(t[0],g,e)?(null==s||r.getDistance(t[0],s.position)>r.getDistance(t[0],g))&&(s={position:g,wallId:d}):r.isContainForSegment(t[2],g,e)&&(null==a||r.getDistance(t[2],a.position)>r.getDistance(t[2],g))&&(a={position:g,wallId:d}));var f=r.getIntersectionPoint4(y,u,i);null!=f&&(r.isContainForSegment(t[1],f,e)?(null==l||r.getDistance(t[1],l.position)>r.getDistance(t[1],f))&&(l={position:f,wallId:d}):r.isContainForSegment(t[3],f,e)&&(null==h||r.getDistance(t[3],h.position)>r.getDistance(t[3],f))&&(h={position:f,wallId:d}))}return{min0:s,min1:l,min2:a,min3:h}},ue.prototype.isAdsorb=function(t,e,o){if(null==t)return null;var n=c.getWall(t.wallId),s=c.getPoint(n.start);c.getPoint(n.end);var l=r.Angle(t.position,o,s);return Math.abs(l-Math.PI/2)<.1&&r.getDistance(t.position,e)<i.minAdsorb?{dx:t.position.x-e.x,dy:t.position.y-e.y}:null};var ge=new ue,fe=function(){};fe.prototype.moveFullTag=function(t,e){var o=c.getTag(e);r.clonePoint(o.center,t),o.setPoints2d()};var xe=new fe,me=function(){this.needUpdateRoom=!1,this.startMoving=!1,this.moveFlag=!1,this.adsorbPointWalls={},this.splitWallId=null};me.prototype.movePoint=function(t,e,o){var n=c.getPoint(t),s=null,l=null;null!=o&&(e={x:o.x,y:o.y},s=o.linkedPointId,l=o.linkedWallId),this.needUpdateRoom=!1,this.adsorbPointWalls={},this.splitWallId=null;var a=this.canMoveForPoint(t,e,s,l);if(!a){if(null==this.splitWallId&&Object.keys(this.adsorbPointWalls).length>0){var h=n.parent,d=c.getWall(Object.keys(h)[0]).getOtherPointId(t),p=c.getPoint(d),y=c.getPoint(Object.keys(this.adsorbPointWalls)[0]),u=r.createLine1(p,y);e=r.getJoinLinePoint(e,u),n.setPosition(e)}return!1}var g=null;if(null==o){var f=L.getNeighPoints(t);if(1==f.length?g=wt.checkAngle(e,f[0].vectorId,t):2==f.length&&((g=wt.checkAngle(e,f[0].vectorId,t))||(g=wt.checkAngle(e,f[1].vectorId,t))),g){if(!(a=this.canMoveForPoint(t,g,s,l)))return!1;r.clonePoint(e,g)}n.setPosition(e)}else if(o.hasOwnProperty("linkedPointId")&&null!=o.linkedPointId){if(null!=L.getWallId(t,o.linkedPointId))return!1;n.setPosition(o),this.needUpdateRoom=!0}else if(o.hasOwnProperty("linkedWallId")){var x=c.getWall(o.linkedWallId),m=c.getPoint(x.start),v=c.getPoint(x.end);if(r.getDistance(m,e)<i.minAdsorb||r.getDistance(v,e)<i.minAdsorb)return!1;n.setPosition(o),this.needUpdateRoom=!0}else o.hasOwnProperty("linkedPointIdX")&&o.linkedPointIdX&&n.setPosition(e),o.hasOwnProperty("linkedPointIdY")&&o.linkedPointIdY&&n.setPosition(e);return H.updateSymbolsPositionsForWallCorner(t),!0},me.prototype.moveWallPlane=function(t,e,o){var n=1,s=c.getWall(t),l=s.start,a=s.end,h=c.getPoint(s.start),d=c.getPoint(s.end),p=this.getNewPointsForMoveWall(t,e,o),y=r.createLine1(p.point1,p.point2),u=this.getTwoLimitInfos(t,y);this.needUpdateRoom=!1;var g=r.getIntersectionPoint(y,u.startLimitLine),f=r.getIntersectionPoint(y,u.endLimitLine);if(!this.startMoving&&(r.getDistance(h,g)<i.minAdsorb||r.getDistance(d,f)<i.minAdsorb))return this.moveFlag=!1,n=2;this.startMoving=!0;var x=this.updateVirtualPosition(s.start,g,u.startWallId,u.newStartWallId),m=this.updateVirtualPosition(s.end,f,u.endWallId,u.newEndWallId);if(null==x||null==m)return this.moveFlag=!1,n=2,this.startMoving=!1,n;var v=!1,P=null;if(x.adsorb&&!m.adsorb){if(y=r.createLine3(y,x.virtualPosition),!this.isOKForTwoSegmentsAngle(x.adsorbPointId,s.start,s.end))return this.moveFlag=!1,n=5;f=r.getIntersectionPoint(y,u.endLimitLine),null==(m=this.updateVirtualPosition(s.end,f,u.endWallId,u.newEndWallId))&&(m={adsorb:!1,adsorbPointId:null,virtualPosition:f}),v=this.isCoincideForAdsorbOne(s.start,x.adsorbPointId,t),P=r.getDistance(x.virtualPosition,f),n=4,this.needUpdateRoom=!0,this.startMoving=!1}else if(!x.adsorb&&m.adsorb){if(y=r.createLine3(y,m.virtualPosition),!this.isOKForTwoSegmentsAngle(m.adsorbPointId,s.end,s.start))return this.moveFlag=!1,n=5;g=r.getIntersectionPoint(y,u.startLimitLine),null==(x=this.updateVirtualPosition(s.start,g,u.startWallId,u.newStartWallId))&&(x={adsorb:!1,adsorbPointId:null,virtualPosition:g}),v=this.isCoincideForAdsorbOne(s.end,m.adsorbPointId,t),P=r.getDistance(m.virtualPosition,g),n=4,this.needUpdateRoom=!0,this.startMoving=!1}if(x&&m&&x.adsorb&&m.adsorb){if(v=this.isCoincideForAdsorbOne2(t,x.adsorbPointId,m.adsorbPointId),P=r.getDistance(x.virtualPosition,m.virtualPosition),this.startMoving=!1,v)return this.moveFlag=!1,n=5;n=4,this.needUpdateRoom=!0}else if((P=r.getDistance(g,f))<i.minAdsorb)return this.deleteWallForLinked(t),h=c.getPoint(l),d=c.getPoint(a),h&&d?(Object.keys(h.parent).length>1&&1==Object.keys(d.parent).length||1==Object.keys(h.parent).length&&1==Object.keys(d.parent).length?L.moveTo(a,l):1==Object.keys(h.parent).length&&Object.keys(d.parent).length>1&&L.moveTo(l,a),this.moveFlag=!1,n=3,this.needUpdateRoom=!0,n):(this.moveFlag=!1,n=3,this.needUpdateRoom=!0,n);if(l=s.start,a=s.end,!this.isOKForCrossForMoveWall(g,f,t,l,a,x.adsorbPointId,m.adsorbPointId))return n=2,this.moveFlag=!1,this.startMoving=!1,n;if(v||null!=P&&P<i.minAdsorb)return this.deleteWallForLinked(t),n=3,L.mergeWallForPoint(l),L.mergeWallForPoint(a),this.moveFlag=!1,this.needUpdateRoom=!0,n;var I=r.getIntersectionPoint3(h,g,d,f);if(null!=I)return h.setPosition(I),d.setPosition(I),L.moveTo(l,a),n=3,this.moveFlag=!1,this.needUpdateRoom=!0,n;var S=!1;if(!u.newStartWallId&&x.adsorbPointId?S=L.isOverlapForMergePoint(l,x.adsorbPointId):!u.newEndWallId&&m.adsorbPointId&&(S=L.isOverlapForMergePoint(a,m.adsorbPointId)),S)return this.moveFlag=!1,n=5;if(this.updatePointForMoveWall(t,l,x,u.startWallId,u.newStartWallId),this.updatePointForMoveWall(t,a,m,u.endWallId,u.newEndWallId),null==(s=c.getWall(t)))return n=3,this.moveFlag=!1,this.needUpdateRoom=!0,n;for(var b in H.updateSymbolsPositionsForWall(t),h=c.getPoint(s.start),d=c.getPoint(s.end),h.parent)H.updateSymbolsPositionsForNeighWall(b);for(var k in d.parent)H.updateSymbolsPositionsForNeighWall(k);return this.moveFlag=1==n,n},me.prototype.updateForAbsorbWallPoints=function(){if(0!=Object.keys(this.adsorbPointWalls).length){Object.keys(this.adsorbPointWalls).length;var t=[],e=null;for(var o in this.adsorbPointWalls){var n=c.getPoint(o);t.push({join:n,pointId:o}),e=this.adsorbPointWalls[o]}var i=c.getWall(e),s=c.getPoint(i.start);t=t.sort(function(t,e){return r.getDistance(s,t.join)-r.getDistance(s,e.join)}.bind(this));for(var l=0;l<t.length;++l){var a=t[l];a.join;var h=a.pointId;L.splitWall(e,h,"end")}}},me.prototype.getNewPointsForMoveWall=function(t,e,o){e/=a.res,o=-o/a.res;var n=c.getWall(t),i=c.getPoint(n.start),s=c.getPoint(n.end);return{point1:{x:i.x+e,y:i.y+o},point2:{x:s.x+e,y:s.y+o}}},me.prototype.getTwoLimitInfos=function(t,e){var o,n,s,l=c.getWall(t),a=c.getPoint(l.start),h=c.getPoint(l.end),d=r.createLine1(a,h),p={newStartWallId:!1,newEndWallId:!1};if(1==Object.keys(a.parent).length)o=r.getVerticalLine(d,a),p.startWallId=null;else if(2==Object.keys(a.parent).length){var y;Object.keys(a.parent)[0]==t?y=c.getWall(Object.keys(a.parent)[1]):Object.keys(a.parent)[1]==t&&(y=c.getWall(Object.keys(a.parent)[0])),y||console.error(352);var u=L.AngleForWall(y.vectorId,t);o=L.getLine(y),p.startWallId=y.vectorId,u>i.maxAngle/180*Math.PI&&(o=r.getVerticalLine(d,a),p.startWallId=null,p.newStartWallId=!0)}else{var g,f;s=L.wallIdForMinAngle(l.start,t);var x=c.getWall(s.min0.wallId),m=c.getPoint(x.start),v=c.getPoint(x.end),P=c.getWall(s.min1.wallId),I=c.getPoint(P.start),S=c.getPoint(P.end),b=r.getIntersectionPoint4(m,v,e),k=r.getIntersectionPoint4(I,S,e);if(null==b&&null==k){var w=L.AngleForWall(t,s.min0.wallId),W=L.AngleForWall(t,s.min1.wallId);w>Math.PI&&(w=Math.PI-w),W>Math.PI&&(W=Math.PI-W),f=w<W?s.min0.wallId:s.min1.wallId,p.newStartWallId=!0}else null!=b&&null!=k?f=s.min0.angle<s.min1.angle?s.min0.wallId:s.min1.wallId:null==b&&null!=k?f=s.min1.wallId:null!=b&&null==k&&(f=s.min0.wallId);p.startWallId=f,g=c.getWall(f);var F=L.AngleForWall(f,t);o=L.getLine(g),F>i.maxAngle/180*Math.PI&&(o=r.getVerticalLine(d,a),p.startWallId=null,p.newStartWallId=!0)}if(1==Object.keys(h.parent).length)n=r.getVerticalLine(d,h),p.endWallId=null;else if(2==Object.keys(h.parent).length){var C;Object.keys(h.parent)[0]==t?C=c.getWall(Object.keys(h.parent)[1]):Object.keys(h.parent)[1]==t&&(C=c.getWall(Object.keys(h.parent)[0]));var T=L.AngleForWall(C.vectorId,t);n=L.getLine(C),p.endWallId=C.vectorId,T>i.maxAngle/180*Math.PI&&(n=r.getVerticalLine(d,h),p.endWallId=null,p.newEndWallId=!0)}else{var D,M;s=L.wallIdForMinAngle(l.end,t);var O=c.getWall(s.min0.wallId),A=c.getPoint(O.start),R=c.getPoint(O.end),E=c.getWall(s.min1.wallId),N=c.getPoint(E.start),B=c.getPoint(E.end),Y=r.getIntersectionPoint4(A,R,e),j=r.getIntersectionPoint4(N,B,e);if(null==Y&&null==j){var _=L.AngleForWall(t,s.min0.wallId),J=L.AngleForWall(t,s.min1.wallId);_>Math.PI&&(_=Math.PI-_),J>Math.PI&&(J=Math.PI-J),M=_<J?s.min0.wallId:s.min1.wallId,p.newEndWallId=!0}else null!=Y&&null!=j?M=s.min0.angle<s.min1.angle?s.min0.wallId:s.min1.wallId:null==Y&&null!=j?M=s.min1.wallId:null!=Y&&null==j&&(M=s.min0.wallId);p.endWallId=M,D=c.getWall(M);var X=L.AngleForWall(M,t);n=L.getLine(D),X>i.maxAngle/180*Math.PI&&(n=r.getVerticalLine(d,h),p.endWallId=null,p.newEndWallId=!0)}return p.startLimitLine=o,p.endLimitLine=n,p},me.prototype.canMoveForPoint=function(t,e,o,n){var i=c.getPoint(t),s=this.isOKForMinAngleWall(t,e);return s&&(s=this.isOKForCross(t,e,i.parent,o,n)),s},me.prototype.isOKForMinAngleWall=function(t,e){var o=c.getPoint(t).parent,n=this.getMinAngle(t,e);if(Math.abs(n)<i.minAngle/180*Math.PI)return!1;for(var s in o){var l=c.getWall(s).getOtherPointId(t),a=this.getNeighMinAngle(l,s,e);if(a&&Math.abs(a.angle)<i.minAngle/180*Math.PI)return!1;var h=c.getPoint(l);if(r.getDistance(e,h)<i.minAdsorb)return!1}return!0},me.prototype.getMinAngle=function(t,e){var o=c.getPoint(t).parent;if(1==Object.keys(o).length)return 2*Math.PI;if(2==Object.keys(o).length){var n=c.getWall(Object.keys(o)[0]),i=c.getWall(Object.keys(o)[1]),s=n.getOtherPointId(t),l=c.getPoint(s),a=i.getOtherPointId(t),h=c.getPoint(a);return r.Angle(e,l,h)}var d={x:e.x+1,y:e.y},p=[];for(var y in o){var u=c.getWall(y).getOtherPointId(t),g=c.getPoint(u);if(r.equalPoint(d,g))p.push(0);else{var f=r.Angle(e,d,g);g.y<e.y&&(f=2*Math.PI-f),p.push(f)}}p=p.sort((function(t,e){return t-e}));for(var x=2*Math.PI,m=0;m<p.length-1;++m)for(var v=m+1;v<p.length;++v){var P=p[v]-p[m];P<x&&(x=P)}var I=p[0],S=p[p.length-1];if(I<Math.PI&&S>Math.PI){var b=2*Math.PI+I-S;b<x&&(x=b)}return x},me.prototype.getNeighMinAngle=function(t,e,o){var n=c.getPoint(t),i={x:o.x,y:o.y},s=null,l=null,a=null,h=null;for(var d in n.parent)if(d!=e){s=c.getWall(d).getOtherPointId(t),l=c.getPoint(s);var p=r.Angle(n,i,l);(null==a||a>p)&&(h={angle:a=p,pointId:s})}return h},me.prototype.isOKForCross=function(t,e,o,n,i){var s=c.getWalls();for(var r in s)if(!o.hasOwnProperty(r)&&i!=r)for(var l in o)if(!L.isWallLink(r,l)){var a=c.getWall(l),h=a.getOtherPointId(t),d=c.getPoint(h);if(!this.isOKForCrossTwoWall(e,d,r,n,i,a.vectorId))return this.adsorbPointWalls={},!1}return!(Object.keys(this.adsorbPointWalls).length>0)&&null==this.splitWallId},me.prototype.isOKForCrossTwoWall=function(t,e,o,n,s,l){var a=c.getWall(o),h=c.getPoint(a.start),d=c.getPoint(a.end);if(r.getIntersectionPoint3(t,e,h,d)&&a.start!=n&&a.end!=n)return this.splitWallId=o,!0;if(r.equalPoint(t,e))return!0;var p=r.createLine1(t,e),y=r.getJoinLinePoint(h,p),u=r.getJoinLinePoint(d,p);if(r.getDistance(y,h)<i.minAdsorb&&r.PointInSegment(y,t,e)){if(a.start!=n)return this.adsorbPointWalls[h.vectorId]=l,!0}else if(r.getDistance(u,d)<i.minAdsorb&&r.PointInSegment(u,t,e)&&a.end!=n)return this.adsorbPointWalls[d.vectorId]=l,!0;if(p=r.createLine1(h,d),y=r.getJoinLinePoint(t,p),u=r.getJoinLinePoint(e,p),r.getDistance(y,t)<i.minAdsorb&&r.PointInSegment(y,h,d)){if(a.start!=n&&a.end!=n&&o!=s)return!0}else if(r.getDistance(u,e)<i.minAdsorb&&r.PointInSegment(u,h,d)&&a.start!=n&&a.end!=n&&o!=s)return!0;return!0},me.prototype.isOKForCrossTwoWall2=function(t,e,o){var n=c.getWall(o),i=c.getPoint(n.start),s=c.getPoint(n.end),l=r.crossTwoLines(t,e,i,s,.01);return!l&&(!!r.equalPoint(t,e)||!!(l=this.isCoincide(t,e,o)))},me.prototype.isOKForCrossTwoWall3=function(t,e,o){var n=c.getWall(o),s=c.getPoint(n.start),l=c.getPoint(n.end);if(r.crossTwoLines(t,e,s,l,.01))return!1;if(r.equalPoint(t,e))return!0;var a=r.createLine1(t,e),h=r.getJoinLinePoint(s,a),d=r.getJoinLinePoint(l,a);return!(r.getDistance(h,s)<i.minAdsorb&&r.PointInSegment(h,t,e))&&(!(r.getDistance(d,l)<i.minAdsorb&&r.PointInSegment(d,t,e))&&(a=r.createLine1(s,l),h=r.getJoinLinePoint(t,a),!(r.getDistance(h,t)<i.minAdsorb&&L.isContain(n,h))))},me.prototype.isCoincide=function(t,e,o){var n=c.getWall(o),s=c.getPoint(n.start),l=c.getPoint(n.end),a=r.createLine1(t,e),h=r.getJoinLinePoint(s,a),d=r.getJoinLinePoint(l,a);return!(r.getDistance(h,s)<i.minAdsorb&&r.PointInSegment(h,t,e))&&(!(r.getDistance(d,l)<i.minAdsorb&&r.PointInSegment(d,t,e))&&(a=r.createLine1(s,l),h=r.getJoinLinePoint(t,a),d=r.getJoinLinePoint(e,a),!(r.getDistance(h,t)<i.minAdsorb&&L.isContain(n,h))&&!(r.getDistance(d,e)<i.minAdsorb&&L.isContain(n,d))))},me.prototype.updateVirtualPosition=function(t,e,o,n){var s,l,a=c.getWall(o),h=c.getPoint(t),d=!1;if(n){if(r.getDistance(h,e)<i.minAdsorb)return null}else null!=a&&(s=a.getOtherPointId(t),l=c.getPoint(s),(r.getDistance(e,l)<i.minAdsorb||!L.isContain(a,e)&&r.getDistance(e,l)<r.getDistance(e,h))&&(r.clonePoint(e,l),d=!0));return{adsorb:d,adsorbPointId:d?s:null,virtualPosition:e}},me.prototype.isOKForTwoSegmentsAngle=function(t,e,o){var n=c.getPoint(t),s=c.getPoint(e),l=c.getPoint(o),a=n.x-s.x,h=n.y-s.y,d={x:a+l.x,y:h+l.y};for(var p in n.parent){var y=c.getWall(p).getOtherPointId(t),u=c.getPoint(y),g=r.Angle(n,u,d);if(Math.abs(g)<i.minAngle/180*Math.PI)return!1}return!0},me.prototype.isCoincideForAdsorbOne=function(t,e,o){if(t&&e){var n=c.getWall(o).getOtherPointId(t);if(null!=L.getWallId(n,e))return!0}return!1},me.prototype.isCoincideForAdsorbOne2=function(t,e,o){if(e&&o){if(null!=L.getWallId(e,o))return!0;var n=c.getPoint(e),s=n.parent;for(var r in s){var l=L.AngleForWall3(t,r);if(Math.abs(l)<i.minAngle/180*Math.PI)return!0}for(var a in s=(n=c.getPoint(o)).parent){var h=L.AngleForWall3(t,a);if(Math.abs(h)<i.minAngle/180*Math.PI)return!0}}return!1},me.prototype.isOKForCrossForMoveWall=function(t,e,o,n,i,s,r){var l=c.getPoint(n),a=c.getPoint(i),h=!0,d=c.getWalls();for(var p in d)if(p!=o){var y=!0,u=!0,g=c.getWall(p);if(!s||s!=g.start&&s!=g.end||(y=!1),!r||r!=g.start&&r!=g.end||(u=!1),g.start!=n&&g.end!=n||(y=!1),g.start!=i&&g.end!=i||(u=!1),y&&u&&(h=this.isOKForCrossTwoWall2(t,e,p)),!h)return!1;if(y&&g.start!=n&&g.end!=n&&(h=this.isOKForCrossTwoWall3(t,l,p)),!h)return!1;if(u&&g.start!=i&&g.end!=i&&(h=this.isOKForCrossTwoWall3(e,a,p)),!h)return!1}return h},me.prototype.updatePointForMoveWall=function(t,e,o,n,s){var r=c.getPoint(e),l=c.getWall(t);if(null==n)s?(this.createWallForMoveWall(e,t,o.virtualPosition),this.needUpdateRoom=!0):r.setPosition(o.virtualPosition);else if(s)this.createWallForMoveWall(e,t,o.virtualPosition),this.needUpdateRoom=!0;else if(o.adsorb)L.moveTo(e,o.adsorbPointId),this.needUpdateRoom=!0;else if(2==Object.keys(r.parent).length)r.setPosition(o.virtualPosition);else{var a=L.wallIdForMinAngle(e,t),h=L.AngleForWall(a.min0.wallId,a.min1.wallId);if(3==Object.keys(r.parent).length&&h>i.maxAngle/180*Math.PI)r.setPosition(o.virtualPosition);else{var d=L.getDirction(e,t);L.subtraWallFromIntersect(e,t);var p=l.getPointId(d);c.getPoint(p).setPosition(o.virtualPosition),L.splitWall(n,p,d),this.needUpdateRoom=!0}}},me.prototype.createWallForMoveWall=function(t,e,o){var n=c.getWall(e),i=L.getDirction(t,e);L.subtraWallFromIntersect(t,e);var s=n.getPointId(i);c.getPoint(s).setPosition(o),L.createWall(t,s)},me.prototype.deleteWallForLinked=function(t){var e=c.getWall(t);L.subtraWallFromIntersect(e.start,t),L.subtraWallFromIntersect(e.end,t),c.deleteWall(t)};var ve=new me,Pe={strokeStyle:"#FFFFFF",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#FFFFFF",lineWidth:6},error:{strokeStyle:"rgba(255,0,0,0.5)",fillStyle:"rgba(255,0,0,0.8)"}},Ie={strokeStyle:"green",fillStyle:"rgb(0, 200, 175)",radius:4},Se={strokeStyle:"rgba(255,255,255,1)",fillStyle:"rgba(255,255,255,0)",lineWidth:2,Pass:{}},be={strokeStyle:"rgba(255,255,255,1)",fillStyle:"rgba(255,255,255,0)",lineWidth:1},ke={strokeStyle:"rgb(255,255,255,1)",fillStyle:"rgb(255,255,255,1)",strokeStyle_adding:"rgba(243, 255, 0, 0.8)",fillStyle_adding:"rgba(243, 255, 0, 0.8)",lineWidth:1},we={Wall:{strokeStyle:"rgba(243, 255, 0, 1)"},Wall_out:{strokeStyle:"rgba(243, 255, 0, 1)"},Symbol:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)",lineWidth:2},Component:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)"},Tag:{strokeStyle:"#00C8AF",fillStyle:"#00C8AF"},Point:{radius:4,lineWidth:2,fillStyle:"rgba(245, 255, 0, 1)",strokeStyle:"rgba(245, 255, 255, 1)"}},We={Wall:{strokeStyle:"rgba(243, 255, 0, 1)"},Wall_out:{strokeStyle:"rgba(162, 164, 124, 1)"},Symbol:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)"},Component:{strokeStyle:"rgba(243, 255, 0, 0.8)",fillStyle:"rgba(243, 255, 0, 0.5)"},Tag:{strokeStyle:"#00C8AF",fillStyle:"#00C8AF"},Point:{radius:4,lineWidth:2,fillStyle:"rgba(245, 255, 0, 1)",strokeStyle:"rgba(245, 255, 255, 1)"}},Fe={StartAddWall:{radius:4,fillStyle:"yellow",strokeStyle:"green"},NewWall:{lineWidth:4,lineWidth_out:6,strokeStyle:"rgba(255,255,255,0.3)",strokeStyle_out:"rgba(102,102,102,0.3)",errorStrokeStyle:"rgb(250,63,72,0.3)"},StartSymbolPoints:{radius:4,fillStyle:"yellow",strokeStyle:"green"},EndSymbolPoints:{radius:4,fillStyle:"yellow",strokeStyle:"green"},CheckLinesX:{lineWidth:2,strokeStyle:"#CED806"},CheckLinesY:{lineWidth:2,strokeStyle:"#CED806"},VCheckLinesX:{lineWidth:2,strokeStyle:"#CED806"},VCheckLinesY:{lineWidth:2,strokeStyle:"#CED806"}},Ce={font:"12px Microsoft YaHei",fillStyle:"#FFFFFF",strokeStyle:"#FFFFFF",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Te={radius:10,lineWidth:2,strokeStyle:"rgba(255,255,255,0.4)",fillStyle:"rgba(255,255,255,0.1)"},De={txt:"rgba(255,255,255,1)",strokeStyle:"rgba(255,255,255,1)",lineWidth:1},Me={style1:{Wall:{strokeStyle:"#666666",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#666666",lineWidth:6}},Symbol:{strokeStyle:"#666666",lineWidth:1},Component:{strokeStyle:"#666666",fillStyle:"#666666",lineWidth:1},Tag:{strokeStyle:"#000000",fillStyle:"#000000",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#000000",strokeStyle:"#000000",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#CCCCCC",lineWidth:1}},style2:{Wall:{strokeStyle:"#FFFFFF",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#FFFFFF",lineWidth:6}},Symbol:{strokeStyle:"#FFFFFF",lineWidth:1},Component:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Tag:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#FFFFFF",strokeStyle:"#FFFFFF",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#FFFFFF",lineWidth:1}},style3:{Wall:{strokeStyle:"#666666",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#666666",lineWidth:6}},Symbol:{strokeStyle:"#666666",lineWidth:1},Component:{strokeStyle:"#666666",fillStyle:"#666666",lineWidth:1},Tag:{strokeStyle:"#000000",fillStyle:"#000000",strokeStyle_adding:"rgba(243, 255, 0, 0.8)",fillStyle_adding:"rgba(243, 255, 0, 0.8)",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#000000",strokeStyle:"#000000",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#CCCCCC",lineWidth:2}},style4:{Wall:{strokeStyle:"#FFFFFF",lineWidth:4,lineWidth_out:6,important:{strokeStyle:"#FFFFFF",lineWidth:6}},Symbol:{strokeStyle:"#FFFFFF",lineWidth:1},Component:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Tag:{strokeStyle:"#FFFFFF",fillStyle:"#FFFFFF",lineWidth:1},Font:{font:"12px Microsoft YaHei",fillStyle:"#FFFFFF",strokeStyle:"#FFFFFF",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#FFFFFF",lineWidth:1}}},Le=function(){this.whiteImg=null,this.blackImg=null};Le.prototype.setWhiteImg=function(t){this.whiteImg=t},Le.prototype.setBlackImg=function(t){this.blackImg=t},Le.prototype.getWhiteImg=function(){return this.whiteImg},Le.prototype.getBlackImg=function(){return this.blackImg};var Oe=new Le,Ae=function(){this.context=null};Ae.prototype.initContext=function(t){this.context=t?t.getContext("2d"):null},Ae.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},Ae.prototype.drawBackGround=function(t){this.context.save(),this.context.fillStyle=t,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore()},Ae.prototype.drawWall=function(t,e){var o=c.getPoint(t.start),n=c.getPoint(t.end),i=[];i.push(o);for(var s=0;s<t.children.length;++s){var l=c.getSymbol(t.children[s]);i.push(l.startPoint),i.push(l.endPoint)}i.push(n),i=i.sort(function(t,e){return r.getDistance(o,t)-r.getDistance(o,e)}.bind(this)),this.context.save(),this.context.beginPath(),this.context.lineCap="round",this.context.strokeStyle=Pe.strokeStyle,t.out||t.important?(this.context.lineWidth=Pe.important.lineWidth*a.ratio,this.context.strokeStyle=Pe.important.strokeStyle):(this.context.lineWidth=Pe.lineWidth*a.ratio,this.context.strokeStyle=Pe.strokeStyle);var h=Z.getSelectItem(),d=Z.getDraggingItem(),p=Z.getFocusItem();e?"style-1"==e?t.out||t.important?(this.context.lineWidth=Me.style1.Wall.important.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Wall.important.strokeStyle):(this.context.lineWidth=Me.style1.Wall.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Wall.strokeStyle):"style-2"==e?t.out||t.important?(this.context.lineWidth=Me.style2.Wall.important.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Wall.important.strokeStyle):(this.context.lineWidth=Me.style2.Wall.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Wall.strokeStyle):"style-3"==e?t.out||t.important?(this.context.lineWidth=Me.style3.Wall.important.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Wall.important.strokeStyle):(this.context.lineWidth=Me.style3.Wall.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Wall.strokeStyle):"style-4"==e&&(t.out||t.important?(this.context.lineWidth=Me.style4.Wall.important.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Wall.important.strokeStyle):(this.context.lineWidth=Me.style4.Wall.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Wall.strokeStyle)):(h&&h.type==y?t.vectorId==h.vectorId&&(t.out||t.important?this.context.strokeStyle=we.Wall_out.strokeStyle:this.context.strokeStyle=we.Wall.strokeStyle):d&&d.type==y&&t.vectorId==d.vectorId&&(t.out||t.important?this.context.strokeStyle=we.Wall_out.strokeStyle:this.context.strokeStyle=we.Wall.strokeStyle),p&&p.type==y&&t.vectorId==p.vectorId&&(this.context.strokeStyle=We.Wall.strokeStyle));for(var u=0;u<i.length-1;u+=2){var g=a.getScreenXY(i[u]),f=a.getScreenXY(i[u+1]);this.context.moveTo(g.x,g.y),this.context.lineTo(f.x,f.y)}this.context.stroke(),this.context.restore(),(h&&h.type==y&&t.vectorId==h.vectorId||d&&d.type==y&&t.vectorId==d.vectorId||p&&p.type==y&&t.vectorId==p.vectorId)&&this.drawMeasureTxt(o,n)},Ae.prototype.drawSpecialPoint=function(){var t=Z.getSelectItem(),e=Z.getDraggingItem(),o=Z.getFocusItem(),n=null;if(this.context.save(),t&&(n=c.getPoint(t.vectorId),this.context.lineWidth=we.Point.lineWidth*a.ratio,this.context.strokeStyle=we.Point.strokeStyle,this.context.fillStyle=we.Point.fillStyle),e&&(n=c.getPoint(e.vectorId),this.context.lineWidth=we.Point.lineWidth*a.ratio,this.context.strokeStyle=we.Point.strokeStyle,this.context.fillStyle=we.Point.fillStyle),o&&(n=c.getPoint(o.vectorId),this.context.lineWidth=We.Point.lineWidth*a.ratio,this.context.strokeStyle=We.Point.strokeStyle,this.context.fillStyle=We.Point.fillStyle),null!=n){var i=a.getScreenXY({x:n.x,y:n.y}),s=Ie.radius;this.context.beginPath(),this.context.arc(i.x,i.y,s*a.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()}else this.context.restore()},Ae.prototype.drawPoint=function(t){var e=a.getScreenXY({x:t.x,y:t.y}),o=Z.getSelectItem(),n=Z.getDraggingItem(),i=Z.getFocusItem(),s=Ie.radius;if(n&&n.type==p&&t.vectorId==n.vectorId||o&&o.type==p&&t.vectorId==o.vectorId)this.context.save(),this.context.lineWidth=we.Point.lineWidth*a.ratio,this.context.strokeStyle=we.Point.strokeStyle,this.context.fillStyle=we.Point.fillStyle,s=we.Point.radius;else{if(!i||i.type!=p||t.vectorId!=i.vectorId)return;this.context.save(),this.context.lineWidth=We.Point.lineWidth*a.ratio,this.context.strokeStyle=We.Point.strokeStyle,this.context.fillStyle=We.Point.fillStyle,s=We.Point.radius}this.context.beginPath(),this.context.arc(e.x,e.y,s*a.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ae.prototype.drawSelectSymbolPoint=function(){var t=Z.getSelectItem(),e=Z.getDraggingItem(),o=Z.getFocusItem(),n=null,i=null,s=null;this.context.save(),t&&t.selectIndex&&t.selectIndex!=O&&H.isSymbol(t.type)?(n=c.getSymbol(t.vectorId),t.selectIndex==A?i=a.getScreenXY({x:n.startPoint.x,y:n.startPoint.y}):t.selectIndex==R&&(i=a.getScreenXY({x:n.endPoint.x,y:n.endPoint.y})),this.context.lineWidth=we.Point.lineWidth*a.ratio,this.context.strokeStyle=we.Point.strokeStyle,this.context.fillStyle=we.Point.fillStyle,s=we.Point.radius):e&&e.selectIndex&&e.selectIndex!=O&&H.isSymbol(e.type)&&(n=c.getSymbol(e.vectorId),e.selectIndex==A?i=a.getScreenXY({x:n.startPoint.x,y:n.startPoint.y}):e.selectIndex==R&&(i=a.getScreenXY({x:n.endPoint.x,y:n.endPoint.y})),this.context.lineWidth=we.Point.lineWidth*a.ratio,this.context.strokeStyle=we.Point.strokeStyle,this.context.fillStyle=we.Point.fillStyle,s=we.Point.radius),o&&o.selectIndex&&o.selectIndex!=O&&H.isSymbol(o.type)&&(n=c.getSymbol(o.vectorId),o.selectIndex==A?i=a.getScreenXY({x:n.startPoint.x,y:n.startPoint.y}):o.selectIndex==R&&(i=a.getScreenXY({x:n.endPoint.x,y:n.endPoint.y})),this.context.lineWidth=We.Point.lineWidth*a.ratio,this.context.strokeStyle=We.Point.strokeStyle,this.context.fillStyle=We.Point.fillStyle,s=We.Point.radius),null!=i&&null!=s&&(this.context.beginPath(),this.context.arc(i.x,i.y,s*a.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill()),this.context.restore()},Ae.prototype.drawSymbolPoint=function(t){var e=a.getScreenXY({x:t.startPoint.x,y:t.startPoint.y}),o=a.getScreenXY({x:t.endPoint.x,y:t.endPoint.y}),n=Ie.radius;this.context.save(),this.context.lineWidth=Ie.lineWidth*a.ratio,this.context.strokeStyle=Ie.strokeStyle,this.context.fillStyle=Ie.fillStyle,this.context.beginPath(),this.context.arc(e.x,e.y,n*a.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.beginPath(),this.context.arc(o.x,o.y,n*a.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ae.prototype.drawText=function(t,e,o,n){this.context.save(),this.setCanvasStyle(Ce),a.ratio==i.ratio?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei";var s={x:t.x,y:t.y};o||(s=a.getScreenXY({x:t.x,y:t.y})),n?(this.context.translate(s.x,s.y),this.context.rotate(n),this.context.fillText(e,0,0)):this.context.fillText(e,s.x,s.y),this.context.restore()},Ae.prototype.drawSingleDoor=function(t,e,o){for(var n=t.points2d,i=[],s=0;s<n.length;++s)i[s]=a.getScreenXY({x:n[s].x,y:n[s].y});var l=r.getDistance(i[0],i[1]);this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.lineCap="square",this.context.strokeStyle=Se.strokeStyle;var h=!1;if(e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var c=Z.getSelectItem(),d=Z.getDraggingItem(),p=Z.getFocusItem();c&&c.type==u&&c.selectIndex==O?t.vectorId==c.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle,this.context.fillStyle=we.Symbol.fillStyle,h=!0):d&&d.type==u&&d.selectIndex==O&&t.vectorId==d.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle,this.context.fillStyle=we.Symbol.fillStyle,h=!0),p&&p.type==u&&t.vectorId==p.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle,this.context.fillStyle=We.Symbol.fillStyle,h=!0)}this.context.beginPath(),this.context.moveTo(i[0].x,i[0].y),this.context.lineTo(i[1].x,i[1].y),this.context.arcTo(i[2].x,i[2].y,i[3].x,i[3].y,l),this.context.closePath(),this.context.stroke(),h&&this.context.fill(),this.context.restore(),o||null==t.enter||this.drawEntranceDoor(t)},Ae.prototype.drawDoubleDoor=function(t,e,o){for(var n=t.points2d,i=[],s=0;s<n.length;++s)i[s]=a.getScreenXY({x:n[s].x,y:n[s].y});var l=r.getDistance(i[0],i[1]);this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.lineCap="square",this.context.strokeStyle=Se.strokeStyle;var h=!1;if(e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var c=Z.getSelectItem(),d=Z.getDraggingItem(),p=Z.getFocusItem();c&&c.type==g&&c.selectIndex==O?t.vectorId==c.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle,this.context.fillStyle=we.Symbol.fillStyle,h=!0):d&&d.type==g&&d.selectIndex==O&&t.vectorId==d.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle,this.context.fillStyle=we.Symbol.fillStyle,h=!0),p&&p.type==g&&t.vectorId==p.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle,this.context.fillStyle=We.Symbol.fillStyle,h=!0)}this.context.beginPath(),this.context.moveTo(i[0].x,i[0].y),this.context.lineTo(i[1].x,i[1].y),this.context.arcTo(i[4].x,i[4].y,i[5].x,i[5].y,l),this.context.closePath(),this.context.stroke(),h&&this.context.fill(),this.context.beginPath(),this.context.moveTo(i[2].x,i[2].y),this.context.lineTo(i[1].x,i[1].y),this.context.arcTo(i[4].x,i[4].y,i[3].x,i[3].y,l),this.context.closePath(),this.context.stroke(),h&&this.context.fill(),this.context.restore(),o||null==t.enter||this.drawEntranceDoor(t)},Ae.prototype.drawSlideDoor=function(t,e,o){for(var n=t.points2d,i=[],s=0;s<n.length;++s)i[s]=a.getScreenXY({x:n[s].x,y:n[s].y});if(this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.strokeStyle=Se.strokeStyle,e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var r=Z.getSelectItem(),l=Z.getDraggingItem(),h=Z.getFocusItem();r&&r.type==f&&r.selectIndex==O?t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle):l&&l.type==f&&l.selectIndex==O&&t.vectorId==l.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle),h&&h.type==f&&t.vectorId==h.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(i[0].x,i[0].y),this.context.lineTo(i[1].x,i[1].y),this.context.lineTo(i[2].x,i[2].y),this.context.lineTo(i[3].x,i[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(i[4].x,i[4].y),this.context.lineTo(i[5].x,i[5].y),this.context.lineTo(i[6].x,i[6].y),this.context.lineTo(i[7].x,i[7].y),this.context.closePath(),this.context.stroke(),this.context.restore(),o||null==t.enter||this.drawEntranceDoor(t)},Ae.prototype.drawSingleWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.strokeStyle=Se.strokeStyle,e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var s=Z.getSelectItem(),r=Z.getDraggingItem(),l=Z.getFocusItem();s&&s.type==x&&s.selectIndex==O?t.vectorId==s.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle):r&&r.type==x&&r.selectIndex==O&&t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle),l&&l.type==x&&t.vectorId==l.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.lineTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.closePath(),this.context.stroke(),this.context.restore()},Ae.prototype.drawBayWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.strokeStyle=Se.strokeStyle;var s=!1;if(e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var r=Z.getSelectItem(),l=Z.getDraggingItem(),h=Z.getFocusItem();r&&r.type==m&&r.selectIndex==O?t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle,this.context.fillStyle=we.Symbol.fillStyle,s=!0):l&&l.type==m&&l.selectIndex==O&&t.vectorId==l.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle,this.context.fillStyle=we.Symbol.fillStyle,s=!0),h&&h.type==m&&t.vectorId==h.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle,this.context.fillStyle=We.Symbol.fillStyle,s=!0)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),s&&this.context.fill(),this.context.beginPath(),this.context.moveTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.lineTo(n[4].x,n[4].y),this.context.stroke(),this.context.restore()},Ae.prototype.drawFrenchWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.strokeStyle=Se.strokeStyle,e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var s=Z.getSelectItem(),r=Z.getDraggingItem(),l=Z.getFocusItem();s&&s.type==v&&s.selectIndex==O?t.vectorId==s.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle):r&&r.type==v&&r.selectIndex==O&&t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle),l&&l.type==v&&t.vectorId==l.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[4].x,n[4].y),this.context.moveTo(n[3].x,n[3].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.stroke(),this.context.restore()},Ae.prototype.drawPass=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=Se.lineWidth*a.ratio,this.context.strokeStyle=Se.strokeStyle,e)"style-1"==e?(this.context.lineWidth=Me.style1.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Symbol.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Symbol.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Symbol.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Symbol.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Symbol.strokeStyle);else{var s=Z.getSelectItem(),r=Z.getDraggingItem(),l=Z.getFocusItem();s&&s.type==P&&s.selectIndex==O?t.vectorId==s.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle):r&&r.type==P&&r.selectIndex==O&&t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Symbol.strokeStyle),l&&l.type==P&&t.vectorId==l.vectorId&&(this.context.strokeStyle=We.Symbol.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.setLineDash([3,2,2]),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.setLineDash([3,2,2]),this.context.stroke(),this.context.restore()},Ae.prototype.drawBeam=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=be.lineWidth*a.ratio,this.context.strokeStyle=be.strokeStyle;var s=!1;if(e)"style-1"==e?(this.context.lineWidth=Me.style1.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Component.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Component.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Component.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Component.strokeStyle);else{var r=Z.getSelectItem(),l=Z.getDraggingItem(),h=Z.getFocusItem();r&&r.type==I?t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Component.strokeStyle,this.context.fillStyle=we.Component.fillStyle,s=!0):l&&l.type==I&&t.vectorId==l.vectorId&&(this.context.strokeStyle=we.Component.strokeStyle,this.context.fillStyle=we.Component.fillStyle,s=!0),h&&h.type==I&&t.vectorId==h.vectorId&&(this.context.strokeStyle=We.Component.strokeStyle,this.context.fillStyle=We.Component.fillStyle,s=!0)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),s&&this.context.fill(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[2].x,n[2].y),this.context.moveTo(n[1].x,n[1].y),this.context.lineTo(n[3].x,n[3].y),this.context.stroke(),this.context.restore()},Ae.prototype.drawFlue=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=be.lineWidth*a.ratio,this.context.strokeStyle=be.strokeStyle;var s=!1;if(e)"style-1"==e?(this.context.lineWidth=Me.style1.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Component.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Component.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Component.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Component.strokeStyle);else{var r=Z.getSelectItem(),l=Z.getDraggingItem(),h=Z.getFocusItem();r&&r.type==S?t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Component.strokeStyle,this.context.fillStyle=we.Component.fillStyle,s=!0):l&&l.type==S&&t.vectorId==l.vectorId&&(this.context.strokeStyle=we.Component.strokeStyle,this.context.fillStyle=we.Component.fillStyle,s=!0),h&&h.type==S&&t.vectorId==h.vectorId&&(this.context.strokeStyle=We.Component.strokeStyle,this.context.fillStyle=We.Component.fillStyle,s=!0)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),s&&this.context.fill(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.closePath(),this.context.stroke(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[8].x,n[8].y),this.context.lineTo(n[6].x,n[6].y),this.context.stroke(),this.context.restore()},Ae.prototype.drawCorridor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});if(this.context.save(),this.context.lineWidth=be.lineWidth*a.ratio,this.context.strokeStyle=be.strokeStyle,e)"style-1"==e?(this.context.lineWidth=Me.style1.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Component.strokeStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Component.strokeStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Component.strokeStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Component.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Component.strokeStyle);else{var s=Z.getSelectItem(),r=Z.getDraggingItem(),l=Z.getFocusItem();s&&s.type==b?t.vectorId==s.vectorId&&(this.context.strokeStyle=we.Component.strokeStyle):r&&r.type==b&&t.vectorId==r.vectorId&&(this.context.strokeStyle=we.Component.strokeStyle),l&&l.type==b&&t.vectorId==l.vectorId&&(this.context.strokeStyle=We.Component.strokeStyle)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke();for(var h=4;h<n.length-1;h+=2)this.context.moveTo(n[h].x,n[h].y),this.context.lineTo(n[h+1].x,n[h+1].y);this.context.stroke(),this.context.restore()},Ae.prototype.drawTag=function(t,e,o){if(this.context.save(),this.context.lineWidth=ke.lineWidth*a.ratio,this.context.strokeStyle=ke.strokeStyle,this.context.fillStyle=ke.fillStyle,e)"style-1"==e?(this.context.lineWidth=Me.style1.Tag.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Tag.strokeStyle,this.context.fillStyle=Me.style1.Tag.fillStyle):"style-2"==e?(this.context.lineWidth=Me.style2.Tag.lineWidth*a.ratio,this.context.strokeStyle=Me.style2.Tag.strokeStyle,this.context.fillStyle=Me.style2.Tag.fillStyle):"style-3"==e?(this.context.lineWidth=Me.style3.Tag.lineWidth*a.ratio,this.context.strokeStyle=Me.style3.Tag.strokeStyle,this.context.fillStyle=Me.style3.Tag.fillStyle):"style-4"==e&&(this.context.lineWidth=Me.style4.Tag.lineWidth*a.ratio,this.context.strokeStyle=Me.style4.Tag.strokeStyle,this.context.fillStyle=Me.style4.Tag.fillStyle);else{var n=Z.getSelectItem(),s=Z.getDraggingItem(),l=Z.getFocusItem();n&&n.type==w?t.vectorId==n.vectorId&&(this.context.strokeStyle=we.Tag.strokeStyle,this.context.fillStyle=we.Tag.fillStyle):s&&s.type==w&&t.vectorId==s.vectorId&&(this.context.strokeStyle=we.Tag.strokeStyle,this.context.fillStyle=we.Tag.fillStyle),l&&l.type==w&&t.vectorId==l.vectorId&&(this.context.strokeStyle=We.Tag.strokeStyle,this.context.fillStyle=We.Tag.fillStyle)}if(t.adding){for(var h=t.points2d,d=[],p=0;p<h.length;++p)d[p]=a.getScreenXY({x:h[p].x,y:h[p].y});this.context.strokeStyle=ke.strokeStyle_adding,this.context.fillStyle=ke.fillStyle_adding,this.context.beginPath(),this.context.moveTo(d[0].x,d[0].y),this.context.lineTo(d[1].x,d[1].y),this.context.lineTo(d[2].x,d[2].y),this.context.lineTo(d[3].x,d[3].y),this.context.closePath(),this.context.stroke();for(var y=4;y<d.length-1;y+=2)this.context.moveTo(d[y].x,d[y].y),this.context.lineTo(d[y+1].x,d[y+1].y);this.context.stroke()}else{var u=a.ratio==i.ratio?36:12;this.context.font="400 "+u+"px Microsoft YaHei";var g=t.title;o||null!=g&&""!=g.trim()||(console.log(c.$app.config),g=c.$app.config.i18n("cad.input")),t.des+="",""!=t.des&&(t.sideWidth=Math.max(this.context.measureText(g).width,this.context.measureText(parseFloat(t.des.replace(",","")).toFixed(2)).width),t.setPoints2d());for(var f=t.points2d,x=[],m=0;m<f.length;++m)x[m]=a.getScreenXY({x:f[m].x,y:f[m].y});var v=(t.center.x,t.center.y);v=a.getScreenXY({x:t.center.x,y:t.center.y});var P=this.context.measureText(g).width,I=r.createLine1({x:(x[0].x+x[3].x)/2,y:(x[0].y+x[3].y)/2},{x:(x[2].x+x[1].x)/2,y:(x[2].y+x[1].y)/2}),S=this.context.measureText(t.des+"m²").width;""!=t.des&&"ft"==t.unit&&(S=this.context.measureText(parseFloat(t.des.replace(",","")).toFixed(2)+"ft²").width);var b=r.createLine1(x[2],x[3]),k=r.getDisPointsLine(I,v,P/2,P/2),W=r.getDisPointsLine(b,{x:(x[2].x+x[3].x)/2,y:(x[2].y+x[3].y)/2},S/2,S/2);if(k.newpoint1.x<k.newpoint2.x){if(this.context.fillText(g,k.newpoint1.x,k.newpoint1.y),t.des)if("ft"==et.unit&&"m"==t.unit){var F=lt.convert(t.des,"area",void 0,"imperial",.01,!1);this.context.fillText(parseFloat(F.replace(",","")).toFixed(2),W.newpoint1.x+u/1.5,W.newpoint1.y)}else if("m"==et.unit&&"ft"==t.unit){var C=lt.convertBack(t.des,"area",7,"imperial",.01,!1);this.context.fillText(parseFloat(C.replace(",","")).toFixed(2),W.newpoint1.x+u/1.5,W.newpoint1.y)}else"m"==t.unit?this.context.fillText(parseFloat(t.des).toFixed(2)+"m²",W.newpoint1.x,W.newpoint1.y):"ft"==t.unit&&this.context.fillText(parseFloat(t.des.replace(",","")).toFixed(2)+"ft²",W.newpoint1.x,W.newpoint1.y)}else if(this.context.fillText(g,k.newpoint2.x,k.newpoint2.y),t.des)if("ft"==et.unit&&"m"==t.unit){var T=lt.convert(t.des,"area",void 0,"imperial",.01,!1);this.context.fillText(parseFloat(T.replace(",","")).toFixed(2),W.newpoint2.x+u/1.5,W.newpoint2.y)}else if("m"==et.unit&&"ft"==t.unit){var D=lt.convertBack(t.des,"area",7,"imperial",.01,!1);this.context.fillText(parseFloat(D.replace(",","")).toFixed(2),W.newpoint2.x+u/1.5,W.newpoint2.y)}else"m"==t.unit?this.context.fillText(parseFloat(t.des).toFixed(2)+"m²",W.newpoint2.x,W.newpoint2.y):"ft"==t.unit&&this.context.fillText(parseFloat(t.des.replace(",","")).toFixed(2)+"ft²",W.newpoint2.x,W.newpoint2.y)}this.context.restore()},Ae.prototype.drawCircle=function(t){var e=null,o=2*Math.PI,n=a.getScreenXY(t);this.context.save(),t.name==ut?(e=Fe.StartAddWall.radius*a.ratio,this.context.strokeStyle=Fe.StartAddWall.strokeStyle,this.context.fillStyle=Fe.StartAddWall.fillStyle):t.name==ft?(e=Fe.StartSymbolPoints.radius*a.ratio,this.context.strokeStyle=Fe.StartSymbolPoints.strokeStyle,this.context.fillStyle=Fe.StartSymbolPoints.fillStyle):t.name==xt?(e=Fe.EndSymbolPoints.radius*a.ratio,this.context.strokeStyle=Fe.EndSymbolPoints.strokeStyle,this.context.fillStyle=Fe.EndSymbolPoints.fillStyle):"pano"==t.name&&(e=Te.radius*a.ratio,this.context.strokeStyle=Te.strokeStyle,this.context.fillStyle=Te.fillStyle,this.context.lineWidth=Te.lineWidth),this.context.beginPath(),this.context.arc(n.x,n.y,e,0,o,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ae.prototype.drawLine=function(t){var e=a.getScreenXY(t.start),o=a.getScreenXY(t.end);this.context.save(),t.name==Pt?(this.context.lineWidth=Fe.VCheckLinesX.lineWidth*a.ratio,this.context.strokeStyle=Fe.VCheckLinesX.strokeStyle,this.context.setLineDash([3,2,2]),e.y=0,o.y=this.context.canvas.clientHeight):t.name==It?(this.context.lineWidth=Fe.VCheckLinesY.lineWidth*a.ratio,this.context.strokeStyle=Fe.VCheckLinesY.strokeStyle,this.context.setLineDash([3,2,2]),e.x=0,o.x=this.context.canvas.clientWidth):t.name==gt?(this.context.lineWidth=Fe.NewWall.lineWidth*a.ratio,this.context.strokeStyle=Fe.NewWall.strokeStyle,"error"==t.state?this.context.strokeStyle=Fe.NewWall.errorStrokeStyle:"normal-out"==t.state&&(this.context.strokeStyle=Fe.NewWall.strokeStyle_out,this.context.lineWidth=Fe.NewWall.lineWidth_out*a.ratio)):t.name==mt?(this.context.lineWidth=Fe.CheckLinesX.lineWidth*a.ratio,this.context.strokeStyle=Fe.CheckLinesX.strokeStyle,this.context.setLineDash([3,2,2])):t.name==vt&&(this.context.lineWidth=Fe.CheckLinesY.lineWidth*a.ratio,this.context.strokeStyle=Fe.CheckLinesY.strokeStyle,this.context.setLineDash([3,2,2])),this.context.beginPath(),this.context.moveTo(e.x,e.y),this.context.lineTo(o.x,o.y),this.context.stroke(),this.context.restore(),t.name==gt&&this.drawMeasureTxt(t.start,t.end),this.context.save(),this.context.lineWidth=Ie.lineWidth*a.ratio,this.context.strokeStyle=Ie.strokeStyle,this.context.fillStyle=Ie.fillStyle;var n=Ie.radius;this.context.beginPath(),this.context.arc(e.x,e.y,n*a.ratio,0,2*Math.PI,!0),this.context.stroke(),this.context.fill(),this.context.restore()},Ae.prototype.drawMeasure=function(t,e,o){this.context.save(),this.context.strokeStyle=De.strokeStyle,this.context.lineWidth=De.lineWidth*a.ratio,o&&("style-1"==o||"style-2"==o||"style-3"==o||"style-4"==o)&&(this.context.lineWidth=Me.style1.Measure.lineWidth*a.ratio,this.context.strokeStyle=Me.style1.Measure.strokeStyle);for(var n=0;n<t.length-1;++n){var s=a.getScreenXY(t[n]),l=a.getScreenXY(t[n+1]),h=0;"top"==e?(s.y=et.region.top*a.ratio,l.y=et.region.top*a.ratio):"bottom"==e?(s.y=et.region.bottom*a.ratio,l.y=et.region.bottom*a.ratio):"left"==e?(s.x=et.region.left*a.ratio,l.x=et.region.left*a.ratio,h=-.5*Math.PI):"right"==e&&(s.x=et.region.right*a.ratio,l.x=et.region.right*a.ratio,h=.5*Math.PI);var c=r.createLine1(s,l);if(null!=c){var d=r.getParallelLineForDistance(c,6*a.ratio),p=r.getJoinLinePoint(s,d.line1),y=r.getJoinLinePoint(l,d.line1),u=r.getJoinLinePoint(s,d.line2),g=r.getJoinLinePoint(l,d.line2);this.context.beginPath(),this.context.moveTo(p.x,p.y),this.context.lineTo(u.x,u.y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(y.x,y.y),this.context.lineTo(g.x,g.y),this.context.stroke();var f={x:(s.x+l.x)/2,y:(s.y+l.y)/2},x=r.getVerticalLine(c,f);d=r.getParallelLineForDistance(x,22*a.ratio);var m=r.getIntersectionPoint(c,d.line1),v=r.getIntersectionPoint(c,d.line2);if(r.getDistance(s,m)<r.getDistance(s,f)){var P=r.getDistance(t[n],t[n+1]);P="ft"==et.unit?" "+lt.convert(P,"distance",void 0,"imperial",.01,!0)+" ":r.getFixed(P,2)+"m",r.getDistance(s,l)>this.context.measureText(P).width?(this.context.beginPath(),this.context.moveTo(s.x,s.y),this.context.lineTo(m.x,m.y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(v.x,v.y),this.context.lineTo(l.x,l.y),this.context.stroke(),this.context.save(),a.ratio==i.ratio?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei","style-1"==o||"style-3"==o?(this.context.fillStyle="#000000",this.context.strokeStyle="#000000"):(this.context.fillStyle="#FFFFFF",this.context.strokeStyle="#FFFFFF"),this.context.textAlign="center",this.context.textBaseline="middle",this.context.miterLimit=10,this.context.direction="ltr",h?(this.context.translate(f.x,f.y),this.context.rotate(h),this.context.fillText(P,0,0)):this.context.fillText(P,f.x,f.y),this.context.restore()):(this.context.beginPath(),this.context.moveTo(s.x,s.y),this.context.lineTo(l.x,l.y),this.context.stroke())}else{var I=r.getDistance(t[n],t[n+1]);I="ft"==et.unit?" "+lt.convert(I,"distance",void 0,"imperial",.01,!0)+" ":r.getFixed(I,2)+"m",r.getDistance(s,l)>this.context.measureText(I).width?(this.context.beginPath(),this.context.moveTo(s.x,s.y),this.context.lineTo(v.x,v.y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(m.x,m.y),this.context.lineTo(l.x,l.y),this.context.stroke(),this.context.save(),a.ratio==i.ratio?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei","style-1"==o||"style-3"==o?(this.context.fillStyle="#000000",this.context.strokeStyle="#000000"):(this.context.fillStyle="#FFFFFF",this.context.strokeStyle="#FFFFFF"),this.context.textAlign="center",this.context.textBaseline="middle",this.context.miterLimit=10,this.context.direction="ltr",h?(this.context.translate(f.x,f.y),this.context.rotate(h),this.context.fillText(I,0,0)):this.context.fillText(I,f.x,f.y),this.context.restore()):(this.context.beginPath(),this.context.moveTo(s.x,s.y),this.context.lineTo(l.x,l.y),this.context.stroke())}}}this.context.restore()},Ae.prototype.drawMeasureTxt=function(t,e){var o=a.getScreenXY(t),n=a.getScreenXY(e),i=r.createLine1(o,n);if(null!=i){var s={x:(o.x+n.x)/2,y:(o.y+n.y)/2},l=r.getParallelLineForDistance(i,10),h=null,c=r.getJoinLinePoint(s,l.line1),d=r.getJoinLinePoint(s,l.line2);s.y<c.y?(r.clonePoint(s,d),h=l.line2):(r.clonePoint(s,c),h=l.line1);var p=r.getDistance(t,e);p="ft"==et.unit?" "+lt.convert(p,"distance",void 0,"imperial",.01,!0)+" ":r.getFixed(p,2)+"m";var y=this.context.measureText(p).width,u=r.getLineForPoint(i,s),g=r.getParallelLineForDistance(u,y/2),f=r.getIntersectionPoint(g.line1,h);f={x:Math.round(f.x),y:Math.round(f.y)};var x=r.getIntersectionPoint(g.line2,h);x={x:Math.round(x.x),y:Math.round(x.y)},f.x<x.x?r.clonePoint(s,f):f.x>x.x?r.clonePoint(s,x):f.y<x.y?r.clonePoint(s,f):r.clonePoint(s,x);var m=null;m=void 0!==i.a?Math.atan(i.a):i.hasOwnProperty("x")?Math.PI/2:0,this.context.save(),this.context.fillStyle=De.txt,this.context.translate(s.x,s.y),this.context.rotate(m),this.context.fillText(p,0,0),this.context.restore()}},Ae.prototype.drawEntranceDoor=function(t){this.context.save();var e,o,n=H.getEnterImg(),s={x:(t.startPoint.x+t.endPoint.x)/2,y:(t.startPoint.y+t.endPoint.y)/2},l=r.createLine1(t.startPoint,t.endPoint),h=r.getLineForPoint(l,s),c=null,d=null;"default"==t.enter?c=r.getParallelLineForDistance(l,.02):"reverse"==t.enter&&(c=r.getParallelLineForDistance(l,.02+r.getDistance(t.startPoint,t.endPoint))),e=r.getIntersectionPoint(c.line1,h),o=r.getIntersectionPoint(c.line2,h);var p=r.Angle(t.startPoint,{x:t.startPoint.x+1,y:t.startPoint.y},t.endPoint);r.isClockwise([t.startPoint,t.endPoint,o])?d="LEFT"==t.openSide?"default"==t.enter?e:o:"default"==t.enter?o:e:r.isClockwise([t.startPoint,t.endPoint,e])&&(d="LEFT"==t.openSide?"default"==t.enter?o:e:"default"==t.enter?e:o),r.isClockwise([t.startPoint,t.endPoint,d])||(p=Math.PI+p),d=a.getScreenXY(d),this.context.translate(d.x,d.y),console.log("截图："+JSON.stringify(d)),t.startPoint.y<=t.endPoint.y?this.context.rotate(-p):this.context.rotate(p);var y=r.getDistance(t.startPoint,t.endPoint)*a.res*1.5;this.context.scale(a.zoom/i.defaultZoom*a.ratio*y/n.height,a.zoom/i.defaultZoom*a.ratio*y/n.height),this.context.drawImage(n,-n.width/2,-n.height-10),this.context.restore()},Ae.prototype.drawRoomBackGround=function(t,e){this.context.save();var o=!1;if(e){this.context.fillStyle=this.context.createPattern(e,"repeat"),o=!0;for(var n=[],i=0;i<t.wallPointIDs.length;++i){var s=c.getPoint(t.wallPointIDs[i]);s=a.getScreenXY(s),n.push(s)}this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y);for(var r=0;r<n.length;++r)this.context.lineTo(n[r].x,n[r].y);this.context.closePath(),o&&this.context.fill(),this.context.restore()}},Ae.prototype.drawCompass=function(t){var e=null;e="style-1"==t||"style-3"==t?Oe.getWhiteImg():Oe.getBlackImg();var o=c.getCompass();this.context.save(),this.context.translate((a.width-310)*a.ratio,160*a.ratio),this.context.rotate(o/180*Math.PI),this.context.scale(a.ratio/2,a.ratio/2),this.context.drawImage(e,-e.width/2,-e.height/2),this.context.restore()},Ae.prototype.setCanvasStyle=function(t){for(var e in t)"isFill"!=e&&"isStroke"!=e&&(this.context[e]=t[e])};var Re=new Ae,Ee=function(t){this.layer=t,this.displayPanos=!1};Ee.prototype.drawGeometry=function(t,e,o){if(null!=Re.context)switch(t.geoType){case y:Re.drawWall(t,e);break;case d:Re.drawPoint(t);break;case u:Re.drawSingleDoor(t,e,o);break;case g:Re.drawDoubleDoor(t,e,o);break;case f:Re.drawSlideDoor(t,e,o);break;case x:Re.drawSingleWindow(t,e);break;case v:Re.drawFrenchWindow(t,e);break;case m:Re.drawBayWindow(t,e);break;case P:Re.drawPass(t);break;case I:Re.drawBeam(t);break;case S:Re.drawFlue(t);break;case b:Re.drawCorridor(t);break;case w:Re.drawTag(t,e,o)}},Ee.prototype.drawElement=function(t){if(null!=Re.context)switch(t.geoType){case d:Re.drawCircle(t);break;case k:Re.drawLine(t)}},Ee.prototype.drawPanos=function(t){for(var e=0;e<t.length;++e)Re.drawCircle(t[e])},Ee.prototype.redrawElements=function(){wt.vCheckLines.X&&wt.vCheckLines.X.display&&this.drawElement(wt.vCheckLines.X),wt.vCheckLines.Y&&wt.vCheckLines.Y.display&&this.drawElement(wt.vCheckLines.Y),wt.startAddWall&&wt.startAddWall.display&&this.drawElement(wt.startAddWall),wt.newWall&&wt.newWall.display&&this.drawElement(wt.newWall),wt.symbolPoints.Start&&wt.symbolPoints.Start.display&&this.drawElement(wt.symbolPoints.Start),wt.symbolPoints.End&&wt.symbolPoints.End.display&&this.drawElement(wt.symbolPoints.End),wt.checkLines.X&&wt.checkLines.X.display&&this.drawElement(wt.checkLines.X),wt.checkLines.Y&&wt.checkLines.Y.display&&this.drawElement(wt.checkLines.Y)},Ee.prototype.redrawMeasures=function(t){Re.drawMeasure(et.measureLines.top,"top",t),Re.drawMeasure(et.measureLines.bottom,"bottom",t),Re.drawMeasure(et.measureLines.left,"left",t),Re.drawMeasure(et.measureLines.right,"right",t)},Ee.prototype.redrawRooms=function(t){for(var e=se.getRooms(t),o=0;o<e.length;++o){for(var n=null,i=0;i<this.layer.app.CadManager.labels.length;++i)if(null!=e[o].tagName&&e[o].tagName.trim()==this.layer.app.CadManager.labels[i].text){"hall"==this.layer.app.CadManager.labels[i].type?(n=se.getHallImg(),Re.drawRoomBackGround(e[o],n)):"room"==this.layer.app.CadManager.labels[i].type?(n=se.getDefaultImg(),Re.drawRoomBackGround(e[o],n)):"other"==this.layer.app.CadManager.labels[i].type&&(n=se.getOtherImg(),Re.drawRoomBackGround(e[o],n));break}null==n&&(n=se.getOtherImg(),Re.drawRoomBackGround(e[o],n))}},Ee.prototype.autoRedraw=function(){Re.clear(),this.displayPanos&&this.drawPanos(o.panos);var t=c.getFloorData(),e=t.walls;for(var n in e)this.drawGeometry(e[n]);var i=t.points;for(var s in i)this.drawGeometry(i[s]);Re.drawSpecialPoint();var r=t.symbols;for(var l in r)this.drawGeometry(r[l]),Re.drawSymbolPoint(r[l]);Re.drawSelectSymbolPoint();var a=t.components;for(var h in a)this.drawGeometry(a[h]);var d=t.tags;for(var p in d)this.drawGeometry(d[p]);this.redrawElements(),this.redrawMeasures()},Ee.prototype.autoRedrawForImg=function(){Re.clear();var t=c.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);var n=t.symbols;for(var i in n)this.drawGeometry(n[i],null,true);var s=t.components;for(var r in s)this.drawGeometry(s[r]);var l=t.tags;for(var a in l)this.drawGeometry(l[a],null,!0)},Ee.prototype.autoRedrawForDownLoadImg=function(t){Re.clear(),"style-1"==t?(Re.drawBackGround("#FFFFFF"),this.redrawRooms(c.getCurrentFloor())):"style-2"==t?(Re.drawBackGround("#000000"),this.redrawRooms(c.getCurrentFloor())):"style-3"==t?Re.drawBackGround("#FFFFFF"):"style-4"==t&&Re.drawBackGround("#000000");var e=c.getFloorData(),o=e.walls;for(var n in o)this.drawGeometry(o[n],t);var i=e.symbols;for(var s in i)this.drawGeometry(i[s],t,false);var r=e.components;for(var l in r)this.drawGeometry(r[l]);var a=e.tags;for(var h in a)this.drawGeometry(a[h],t);this.redrawMeasures(t),Re.drawCompass(t)},Ee.prototype.redrawCore=function(){console.log("重绘！"),Re.clear();var t=c.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);var n=t.points;for(var i in n)this.drawGeometry(n[i]);var s=t.symbols;for(var r in s)this.drawGeometry(s[r]);var l=t.components;for(var a in l)this.drawGeometry(l[a])},Ee.prototype.clear=function(){Re.clear()},Ee.prototype.getContext=function(){return Re.context};var Ne=function(){};Ne.prototype.isDifferentForWalls=function(t,e){return t.start!=e.start||t.end!=e.end||t.out!=e.out||t.important!=e.important},Ne.prototype.isDifferentForSymbols=function(t,e){return!r.equalPoint(t.startPoint,e.startPoint)||!r.equalPoint(t.endPoint,e.endPoint)||t.openSide!=e.openSide||t.parent!=e.parent||t.enter!=e.enter},Ne.prototype.isDifferentForComponents=function(t,e){return JSON.stringify(t.points2d)!=JSON.stringify(e.points)||t.angle!=e.angle},Ne.prototype.isDifferentForTags=function(t,e){return!r.equalPoint(t.center,e.center)||t.title!=e.title||t.des!=e.des||t.unit!=e.unit},Ne.prototype.isDifferentForAngle=function(t,e){return t!=e},Ne.prototype.assignWallFromWall=function(t,e){var o={};o.vectorId=t.vectorId,o.children=JSON.parse(JSON.stringify(e.children)),o.out=e.out,o.important=e.important,o.start=e.start,o.end=e.end,L.setWallInfo(o)},Ne.prototype.assignPointFromPoint=function(t,e){var o={};o.vectorId=t.vectorId,o.position={x:e.x,y:e.y},o.parent=JSON.parse(JSON.stringify(e.parent)),L.setPointInfo(o)},Ne.prototype.assignSymbolFromSymbol=function(t,e){var o={};o.vectorId=t.vectorId,o.openSide=e.openSide,o.start=JSON.parse(JSON.stringify(e.start)),o.end=JSON.parse(JSON.stringify(e.end)),o.points2d=JSON.parse(JSON.stringify(e.points)),o.enter=e.enter,o.parent=e.parent,H.setSymbolInfo(o)},Ne.prototype.assignComponentFromComponent=function(t,e){var o={};o.vectorId=t.vectorId,o.angle=e.angle,o.center=JSON.parse(JSON.stringify(e.center)),o.points2d=JSON.parse(JSON.stringify(e.points)),z.setComponentInfo(o)},Ne.prototype.assignTagFromTag=function(t,e){var o={};o.vectorId=t.vectorId,o.title=e.title,o.des=e.des,o.unit=e.unit,o.center=JSON.parse(JSON.stringify(e.center)),o.points2d=JSON.parse(JSON.stringify(e.points)),o.adding=!1,ht.setTagInfo(o)},Ne.prototype.deletePoint=function(t){var e=c.getPoint(t).parent;for(var o in e)c.deletePoint(t,o)},Ne.prototype.getDataForPoint=function(t){var e={};return e.id=t.vectorId,r.clonePoint(e,t),e.parent=JSON.parse(JSON.stringify(t.parent)),e.type=t.geoType,e},Ne.prototype.getDataForWall=function(t){var e={};return e.id=t.vectorId,e.start=t.start,e.end=t.end,e.out=t.out,e.important=t.important,e.children=JSON.parse(JSON.stringify(t.children)),e.type=t.geoType,e},Ne.prototype.getDataForSymbol=function(t){var e={};return e.id=t.vectorId,e.start=JSON.parse(JSON.stringify(t.startPoint)),e.end=JSON.parse(JSON.stringify(t.endPoint)),e.openSide=t.openSide,e.enter=t.enter,e.points=JSON.parse(JSON.stringify(t.points2d)),e.parent=t.parent,e.type=t.geoType,e},Ne.prototype.getDataForComponent=function(t){var e={};return e.id=t.vectorId,e.type=t.geoType,e.center=JSON.parse(JSON.stringify(t.center)),e.angle=t.angle,e.points=[].concat(t.points2d),e},Ne.prototype.getDataForTag=function(t){var e={};return e.id=t.vectorId,e.type=t.geoType,e.center={},r.clonePoint(e.center,t.center),e.points=[].concat(t.points2d),e.title=t.title,e.des=t.des,e.unit=t.unit,e},Ne.prototype.getDataForAngle=function(t){return t},Ne.prototype.getDataForRes=function(t){return t};var Be=new Ne,Ye="addPoint",je="deletePoint",_e="modifyPoint",Je="addWall",Xe="deleteWall",Ue="modifyWall",He="addSymbol",Ve="deleteSymbol",Ge="modifySymbol",$e="addComponent",Ke="deleteComponent",ze="modifyComponent",qe="addTag",Ze="deleteTag",Qe="modifyTag",to="modifyAngle",eo=function(){this.lastData={},this.elements={}};eo.prototype.saveCurrentInfo=function(){this.lastData.currentFloor=c.getCurrentFloor(),this.lastData.points=JSON.parse(JSON.stringify(c.getPoints())),this.lastData.walls=JSON.parse(JSON.stringify(c.getWalls())),this.lastData.symbols=JSON.parse(JSON.stringify(c.getSymbols())),this.lastData.components=JSON.parse(JSON.stringify(c.getComponents())),this.lastData.tags=JSON.parse(JSON.stringify(c.getTags())),this.lastData.angle=c.getAngle(),this.lastData.res=a.res},eo.prototype.operate=function(){return this.elements={},this.compareAngle()?(this.lastData={},!0):(this.comparePoints(),this.compareSymbols(),this.compareWalls(),this.compareComponents(),this.compareTags(),0==this.elements.points.length&&0==this.elements.walls.length&&0==this.elements.symbols.length&&0==this.elements.components.length&&0==this.elements.tags.length?(this.saveCurrentInfo(),!1):(this.lastData={},!0))},eo.prototype.comparePoints=function(){var t=c.getPoints();for(var e in this.elements.points=[],t){var o=t[e];if(this.lastData.points[e]){var n=this.lastData.points[e];if(o.x==n.x&&o.y==n.y&&JSON.stringify(o.parent)==JSON.stringify(n.parent)){delete this.lastData.points[e];continue}var i={handle:_e,prePoint:Be.getDataForPoint(n),curPoint:Be.getDataForPoint(o)};this.elements.points.push(i)}else{var s={handle:Ye,point:Be.getDataForPoint(o)};this.elements.points.push(s)}delete this.lastData.points[e]}for(var r in this.lastData.points){var l={handle:je,point:Be.getDataForPoint(this.lastData.points[r])};this.elements.points.push(l)}},eo.prototype.compareWalls=function(){this.elements.walls=[];var t=c.getWalls();for(var e in t){var o=t[e],n=this.lastData.walls[e];if(n){if(!Be.isDifferentForWalls(o,n)){delete this.lastData.walls[e];continue}var i={handle:Ue,preWall:Be.getDataForWall(n),curWall:Be.getDataForWall(o)};this.elements.walls.push(i)}else{var s={handle:Je,wall:Be.getDataForWall(o)};this.elements.walls.push(s)}delete this.lastData.walls[e]}for(var r in this.lastData.walls){var l={handle:Xe,wall:Be.getDataForWall(this.lastData.walls[r])};this.elements.walls.push(l)}},eo.prototype.compareSymbols=function(){this.elements.symbols=[];var t=c.getSymbols();for(var e in t){var o=t[e],n=this.lastData.symbols[e];if(n){if(!Be.isDifferentForSymbols(o,n)){delete this.lastData.symbols[e];continue}var i={handle:Ge,preSymbol:Be.getDataForSymbol(n),curSymbol:Be.getDataForSymbol(o)};this.elements.symbols.push(i)}else{var s={handle:He,symbol:Be.getDataForSymbol(o)};this.elements.symbols.push(s)}delete this.lastData.symbols[e]}for(var r in this.lastData.symbols){var l={handle:Ve,symbol:Be.getDataForSymbol(this.lastData.symbols[r])};this.elements.symbols.push(l)}},eo.prototype.compareComponents=function(){this.elements.components=[];var t=c.getComponents();for(var e in t){var o=t[e],n=this.lastData.components[e];if(n){if(!Be.isDifferentForComponents(o,n)){delete this.lastData.components[e];continue}var i={handle:ze,preComponent:Be.getDataForComponent(n),curComponent:Be.getDataForComponent(o)};this.elements.components.push(i)}else{var s={handle:$e,component:Be.getDataForComponent(o)};this.elements.components.push(s)}delete this.lastData.components[e]}for(var r in this.lastData.components){var l={handle:Ke,component:Be.getDataForComponent(this.lastData.components[r])};this.elements.components.push(l)}},eo.prototype.compareTags=function(){this.elements.tags=[];var t=c.getTags();for(var e in t){var o=t[e],n=this.lastData.tags[e];if(n){if(!Be.isDifferentForTags(o,n)){delete this.lastData.tags[e];continue}var i={handle:Qe,preTag:Be.getDataForTag(n),curTag:Be.getDataForTag(o)};this.elements.tags.push(i)}else{var s={handle:qe,tag:Be.getDataForTag(o)};this.elements.tags.push(s)}delete this.lastData.tags[e]}for(var r in this.lastData.tags){var l={handle:Ze,tag:Be.getDataForTag(this.lastData.tags[r])};this.elements.tags.push(l)}},eo.prototype.compareAngle=function(){var t=c.getAngle(),e=this.lastData.angle,o=this.lastData.res;if(Be.isDifferentForAngle(t,e)){var n={handle:to,preState:{angle:Be.getDataForAngle(e),res:Be.getDataForRes(o)},curState:{angle:Be.getDataForAngle(t),res:Be.getDataForRes(a.res)}};return this.elements.rotate=n,!0}return!1};var oo=new eo,no=function(t){this.layer=t};no.prototype.init=function(){oo.saveCurrentInfo();var t=c.getPoints();Object.keys(t).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1)},no.prototype.save=function(){if(oo.operate()){et.update(),Ft.addHistoryRecord(oo.elements),oo.saveCurrentInfo(),this.setState(),Ft.getHistoryState().pre&&(this.layer.$xui.toolbar.recall=!0),this.layer.$xui.toolbar.recover=!1;var t=c.getPoints();return Object.keys(t).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1),this.layer.emit("change"),oo.elements}},no.prototype.setState=function(){var t={pre:0,next:0},e=Ft.getCurrentRecordIndex(),o=Ft.getHistoryRecords();e>-1&&(t.pre=1),e<o.length-1&&(t.next=1);var n=Ft.getHistoryState();n.pre==t.pre&&n.next==t.next||Ft.setHistoryState(t.pre,t.next)},no.prototype.canUndo=function(){return 0!=this.setState().pre},no.prototype.canRedo=function(){return 0!=this.setState().next},no.prototype.handleUndo=function(){this.goPreState()},no.prototype.handleRedo=function(){this.goNextState()},no.prototype.goPreState=function(){var t=Ft.getHistoryRecord();if(t){Z.clearFocusItem(),this.layer.uiControl.currentUI=null,t.type="pre";null!=t.rotate&&this.goPreForAngle(t.rotate)||(this.goPreForPoints(t.points),this.goPreForWalls(t.walls),this.goPreForSymbols(t.symbols),this.goPreForComponents(t.components),this.goPreForTags(t.tags)),et.update(),Ft.undoHistoryRecord(),oo.saveCurrentInfo(),this.setState();var e=c.getPoints();Object.keys(e).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1)}else console.error("goPreState超出范围！")},no.prototype.goPreForPoints=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==Ye)Be.deletePoint(o.point.id);else if(o.handle==je){L.createPoint(o.point.x,o.point.y,o.point.id).parent=JSON.parse(JSON.stringify(o.point.parent))}else if(o.handle==_e){var n=o.prePoint,i=c.getPoint(o.curPoint.id);Be.assignPointFromPoint(i,n)}}},no.prototype.goPreForWalls=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==Je)c.deleteWallNoSymbol(o.wall.id);else if(o.handle==Xe){var n=o.wall,i=L.createWall(n.start,n.end,n.id);Be.assignWallFromWall(i,n)}else if(o.handle==Ue){var s=o.preWall,r=c.getWall(o.curWall.id);Be.assignWallFromWall(r,s)}}},no.prototype.goPreForSymbols=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==He)H.deleteSymbol(o.symbol.id);else if(o.handle==Ve){var n=H.createSymbol(o.symbol.start,o.symbol.end,o.symbol.type,o.symbol.parent,o.symbol.id);Be.assignSymbolFromSymbol(n,o.symbol)}else if(o.handle==Ge){var i=o.preSymbol,s=c.getSymbol(o.curSymbol.id);Be.assignSymbolFromSymbol(s,i)}}},no.prototype.goPreForComponents=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==$e)c.deleteComponent(o.component.id);else if(o.handle==Ke){var n=z.createComponent(o.component.center,o.component.type,o.component.id);Be.assignComponentFromComponent(n,o.component)}else if(o.handle==ze){var i=o.preComponent,s=c.getComponent(o.curComponent.id);Be.assignComponentFromComponent(s,i)}}},no.prototype.goPreForTags=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==qe)ht.deleteTag(o.tag.id);else if(o.handle==Ze){var n=ht.createTag(o.tag.center,o.tag.id);Be.assignTagFromTag(n,o.tag)}else if(o.handle==Qe){var i=o.preTag,s=c.getTag(o.curTag.id);Be.assignTagFromTag(s,i)}}},no.prototype.goPreForAngle=function(t){if(t.handle==to){a.reSet(),a._setRes(t.preState.res),c.setAngle(t.preState.angle),a.updateForRotate(t.preState.angle-t.curState.angle);var e=a.getScreenInfoForCAD();return e.floorPlanAngle=t.preState.angle,this.layer.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",e),this.layer.app.store.getValue("metadata").floorPlanAngle=t.preState.angle,this.layer.initPanos(c.getCurrentFloor()),!0}return!1},no.prototype.goNextForPoints=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==Ye){var n=L.createPoint(o.point.x,o.point.y,o.point.id);Be.assignPointFromPoint(n,o.point)}else if(o.handle==je)Be.deletePoint(o.point.id);else if(o.handle==_e){var i=o.curPoint,s=c.getPoint(o.curPoint.id);Be.assignPointFromPoint(s,i)}}},no.prototype.goNextForWalls=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==Je){var n=o.wall,i=L.createWall(n.start,n.end,n.id);Be.assignWallFromWall(i,n)}else if(o.handle==Xe)c.deleteWallNoSymbol(o.wall.id);else if(o.handle==Ue){var s=o.curWall,r=c.getWall(o.preWall.id);Be.assignWallFromWall(r,s)}}},no.prototype.goNextForSymbols=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==He){var n=H.createSymbol(o.symbol.start,o.symbol.end,o.symbol.type,o.symbol.parent,o.symbol.id);Be.assignSymbolFromSymbol(n,o.symbol)}else if(o.handle==Ve)H.deleteSymbol(o.symbol.id);else if(o.handle==Ge){var i=o.curSymbol,s=c.getSymbol(o.curSymbol.id);Be.assignSymbolFromSymbol(s,i)}}},no.prototype.goNextForComponents=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==$e){var n=z.createComponent(o.component.center,o.component.type,o.component.id);Be.assignComponentFromComponent(n,o.component)}else if(o.handle==Ke)c.deleteComponent(o.component.id);else if(o.handle==ze){var i=o.curComponent,s=c.getComponent(o.curComponent.id);Be.assignComponentFromComponent(s,i)}}},no.prototype.goNextForTags=function(t){for(var e=0;e<t.length;++e){var o=t[e];if(o.handle==qe){var n=ht.createTag(o.tag.center,o.tag.id);Be.assignTagFromTag(n,o.tag)}else if(o.handle==Ze)c.deleteTag(o.tag.id);else if(o.handle==Qe){var i=o.curTag,s=c.getTag(o.curTag.id);Be.assignTagFromTag(s,i)}}},no.prototype.goNextForAngle=function(t){if(t.handle==to){a.reSet(),a._setRes(t.curState.res),c.setAngle(t.curState.angle),a.updateForRotate(t.curState.angle-t.preState.angle);var e=a.getScreenInfoForCAD();return e.floorPlanAngle=t.curState.angle,this.layer.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",e),this.layer.app.store.getValue("metadata").floorPlanAngle=t.curState.angle,this.layer.initPanos(c.getCurrentFloor()),!0}return!1},no.prototype.goNextState=function(){Ft.redoHistoryRecord();var t=Ft.getHistoryRecord();if(t){Z.clearFocusItem(),this.layer.uiControl.currentUI=null;null!=t.rotate&&this.goNextForAngle(t.rotate)||(this.goNextForPoints(t.points),this.goNextForWalls(t.walls),this.goNextForSymbols(t.symbols),this.goNextForComponents(t.components),this.goNextForTags(t.tags)),et.update(),oo.saveCurrentInfo(),this.setState();var e=c.getPoints();Object.keys(e).length>0?(this.layer.$xui.toolbar.clear=!0,this.layer.$xui.toolbar.download=!0):(this.layer.$xui.toolbar.clear=!1,this.layer.$xui.toolbar.download=!1)}else Ft.undoHistoryRecord(),console.error("goNextState超出范围！")};var io={export:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a",lineWidth:7,lineWidth_out:10},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Font:[{font:"bold 14px Microsoft YaHei",fillStyle:"rgb(65,65,65)",screen:{x:520,y:856},text:"© "},{font:"bold 14px Microsoft YaHei",fillStyle:"#70707a",screen:{x:538,y:855},text:"版权归58同城、赶集网、安居客、四维时代、正顺所有"},{font:"bold 14px Microsoft YaHei",fillStyle:"rgb(65,65,65)",screen:{x:30,y:840},text:["单位：毫米(mm)","提示：户型图中所有室内装饰、设计、摆设、间隔、尺寸、设备仅供参考。","具体房源标准以室内查勘和测量为准。"]}],compass:{screen:{x:66,y:88}},BackGround:{fillStyle:"#FFFFFF"}},cover:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},default:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},Font:{font:"12px Microsoft YaHei",fillStyle:"rgba(0,0,0,1)",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#70707a"}},so=function(){this.context=null};so.prototype.initContext=function(t){this.context=t},so.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},so.prototype.drawWall=function(t,e){var o=c.getPoint(t.start),n=c.getPoint(t.end),i=[];i.push(o);for(var s=0;s<t.children.length;++s){var l=c.getSymbol(t.children[s]);i.push(l.startPoint),i.push(l.endPoint)}i.push(n),i=i.sort(function(t,e){return r.getDistance(o,t)-r.getDistance(o,e)}.bind(this)),this.context.save(),this.context.beginPath(),"export"==e?(t.out||t.important?this.context.lineWidth=io.export.Wall.lineWidth_out:this.context.lineWidth=io.export.Wall.lineWidth,this.context.strokeStyle=io.export.Wall.strokeStyle,this.context.fillStyle=io.export.Wall.fillStyle):"cover"==e?(t.out||t.important?this.context.lineWidth=io.cover.Wall.lineWidth_out:this.context.lineWidth=io.cover.Wall.lineWidth,this.context.strokeStyle=io.cover.Wall.strokeStyle,this.context.fillStyle=io.cover.Wall.fillStyle):"default"==e&&(t.out||t.important?this.context.lineWidth=io.default.Wall.lineWidth_out:this.context.lineWidth=io.default.Wall.lineWidth,this.context.strokeStyle=io.default.Wall.strokeStyle,this.context.fillStyle=io.default.Wall.fillStyle),this.context.lineCap="butt";for(var h=0;h<i.length-1;h+=2){var d=a.getScreenXY(i[h]),p=a.getScreenXY(i[h+1]);this.context.moveTo(d.x,d.y),this.context.lineTo(p.x,p.y)}this.context.stroke(),this.context.restore(),o.x,n.x,o.y,n.y},so.prototype.drawPoint=function(t,e){this.context.save(),this.context.beginPath();var o="thin";for(var n in t.parent){var i=c.getWall(n);if(i.out&&i.important){o="fat";break}}var s=null;"export"==e?(s="thin"==o?io.export.Wall.lineWidth:io.export.Wall.lineWidth_out,this.context.strokeStyle=io.export.Wall.strokeStyle,this.context.fillStyle=io.export.Wall.fillStyle):"cover"==e?(s="thin"==o?io.cover.Wall.lineWidth:io.cover.Wall.lineWidth_out,this.context.strokeStyle=io.cover.Wall.strokeStyle,this.context.fillStyle=io.cover.Wall.fillStyle):"default"==e&&(s="thin"==o?io.default.Wall.lineWidth:io.default.Wall.lineWidth_out,this.context.strokeStyle=io.default.Wall.strokeStyle,this.context.fillStyle=io.default.Wall.fillStyle),this.context.lineCap="butt";var r=a.getScreenXY(t);this.context.rect(r.x-s/2,r.y-s/2,s,s),this.context.fill(),this.context.restore()},so.prototype.drawText=function(t,e,o,n){this.context.save(),this.setCanvasStyle(io.Font),a.ratio==i.ratio?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei";var s={x:t.x,y:t.y};o||(s=a.getScreenXY({x:t.x,y:t.y})),n?(this.context.translate(s.x,s.y),this.context.rotate(n),this.context.strokeText(e,0,0),this.context.fillText(e,0,0)):(this.context.strokeText(e,s.x,s.y),this.context.fillText(e,s.x,s.y)),this.context.restore()},so.prototype.drawSingleDoor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});var s=r.getDistance(n[0],n[1]);this.context.save(),this.context.lineCap="butt",this.context.lineWidth=1,"export"==e?(this.context.strokeStyle=io.export.strokeStyle,this.context.fillStyle=io.export.fillStyle):"cover"==e?(this.context.strokeStyle=io.cover.strokeStyle,this.context.fillStyle=io.export.fillStyle):"default"==e&&(this.context.strokeStyle=io.default.strokeStyle,this.context.fillStyle=io.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.arcTo(n[2].x,n[2].y,n[3].x,n[3].y,s),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawEntranceDoor(t)},so.prototype.drawDoubleDoor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});var s=r.getDistance(n[0],n[1]);this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=io.export.strokeStyle,this.context.fillStyle=io.export.fillStyle):"cover"==e?(this.context.strokeStyle=io.cover.strokeStyle,this.context.fillStyle=io.export.fillStyle):"default"==e&&(this.context.strokeStyle=io.default.strokeStyle,this.context.fillStyle=io.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.arcTo(n[4].x,n[4].y,n[5].x,n[5].y,s),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[1].x,n[1].y),this.context.arcTo(n[4].x,n[4].y,n[3].x,n[3].y,s),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawEntranceDoor(t)},so.prototype.drawSlideDoor=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=io.export.strokeStyle,this.context.fillStyle=io.export.fillStyle):"cover"==e?(this.context.strokeStyle=io.cover.strokeStyle,this.context.fillStyle=io.export.fillStyle):"default"==e&&(this.context.strokeStyle=io.default.strokeStyle,this.context.fillStyle=io.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawEntranceDoor(t)},so.prototype.drawSingleWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=io.export.strokeStyle,this.context.fillStyle=io.export.fillStyle):"cover"==e?(this.context.strokeStyle=io.cover.strokeStyle,this.context.fillStyle=io.export.fillStyle):"default"==e&&(this.context.strokeStyle=io.default.strokeStyle,this.context.fillStyle=io.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.lineTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.closePath(),this.context.stroke(),this.context.restore()},so.prototype.drawBayWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=io.export.strokeStyle,this.context.fillStyle=io.export.fillStyle):"cover"==e?(this.context.strokeStyle=io.cover.strokeStyle,this.context.fillStyle=io.export.fillStyle):"default"==e&&(this.context.strokeStyle=io.default.strokeStyle,this.context.fillStyle=io.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.lineTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.lineTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.closePath(),this.context.stroke(),this.context.restore()},so.prototype.drawFrenchWindow=function(t,e){for(var o=t.points2d,n=[],i=0;i<o.length;++i)n[i]=a.getScreenXY({x:o[i].x,y:o[i].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="butt","export"==e?(this.context.strokeStyle=io.export.strokeStyle,this.context.fillStyle=io.export.fillStyle):"cover"==e?(this.context.strokeStyle=io.cover.strokeStyle,this.context.fillStyle=io.export.fillStyle):"default"==e&&(this.context.strokeStyle=io.default.strokeStyle,this.context.fillStyle=io.export.fillStyle),this.context.beginPath(),this.context.moveTo(n[0].x,n[0].y),this.context.lineTo(n[1].x,n[1].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[3].x,n[3].y),this.context.moveTo(n[4].x,n[4].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[2].x,n[2].y),this.context.lineTo(n[4].x,n[4].y),this.context.moveTo(n[3].x,n[3].y),this.context.lineTo(n[5].x,n[5].y),this.context.moveTo(n[6].x,n[6].y),this.context.lineTo(n[7].x,n[7].y),this.context.stroke(),this.context.restore()},so.prototype.drawMeasure=function(t,e){this.context.save(),this.context.strokeStyle=io.Measure.strokeStyle,this.context.beginPath();for(var o=0;o<t.length-1;++o){var n=a.getScreenXY(t[o]),i=a.getScreenXY(t[o+1]),s=0;"top"==e?(n.y=et.region.top*a.ratio,i.y=et.region.top*a.ratio):"bottom"==e?(n.y=et.region.bottom*a.ratio,i.y=et.region.bottom*a.ratio):"left"==e?(n.x=et.region.left*a.ratio,i.x=et.region.left*a.ratio,s=-.5*Math.PI):"right"==e&&(n.x=et.region.right*a.ratio,i.x=et.region.right*a.ratio,s=.5*Math.PI);var l=r.createLine1(n,i),h=r.getParallelLineForDistance(l,6),c=r.getJoinLinePoint(n,h.line1),d=r.getJoinLinePoint(i,h.line1),p=r.getJoinLinePoint(n,h.line2),y=r.getJoinLinePoint(i,h.line2);this.context.moveTo(c.x,c.y),this.context.lineTo(p.x,p.y),this.context.moveTo(d.x,d.y),this.context.lineTo(y.x,y.y),this.context.stroke();var u={x:(n.x+i.x)/2,y:(n.y+i.y)/2},g=r.getVerticalLine(l,u);h=r.getParallelLineForDistance(g,20);var f=r.getIntersectionPoint(l,h.line1),x=r.getIntersectionPoint(l,h.line2);if(r.getDistance(n,f)<r.getDistance(n,u)){this.context.moveTo(n.x,n.y),this.context.lineTo(f.x,f.y),this.context.moveTo(x.x,x.y),this.context.lineTo(i.x,i.y),this.context.stroke();var m=r.getDistance(t[o],t[o+1]);"ft"==et.unit&&(m=" "+lt.convert(m,"distance",void 0,"imperial",.01,!0)+" "),this.drawText(u,r.getFixed(m,2),!0,s)}else{this.context.moveTo(n.x,n.y),this.context.lineTo(x.x,x.y),this.context.moveTo(f.x,f.y),this.context.lineTo(i.x,i.y),this.context.stroke();var v=r.getDistance(t[o],t[o+1]);"ft"==et.unit&&(v=" "+lt.convert(v,"distance",void 0,"imperial",.01,!0)+" "),this.drawText(u,r.getFixed(v,2),!0,s)}}this.context.restore()},so.prototype.drawExportTxt=function(){this.context.save(),this.context.font=io.export.Font[0].font,this.context.fillStyle=io.export.Font[0].fillStyle,this.context.fillText(io.export.Font[0].text,io.export.Font[0].screen.x,io.export.Font[0].screen.y),this.context.restore(),this.context.save(),this.context.font=io.export.Font[1].font,this.context.fillStyle=io.export.Font[1].fillStyle,this.context.fillText(io.export.Font[1].text,io.export.Font[1].screen.x,io.export.Font[1].screen.y),this.context.restore(),this.context.save(),this.context.font=io.export.Font[2].font,this.context.fillStyle=io.export.Font[2].fillStyle,this.context.fillText(io.export.Font[2].text[0],io.export.Font[2].screen.x,io.export.Font[2].screen.y),this.context.fillText(io.export.Font[2].text[1],io.export.Font[2].screen.x,io.export.Font[2].screen.y+14),this.context.fillText(io.export.Font[2].text[2],io.export.Font[2].screen.x,io.export.Font[2].screen.y+28),this.context.restore()},so.prototype.drawExportCompass=function(t,e){this.drawImg(t,e,!0)},so.prototype.drawRoomBackGround=function(t,e){this.context.save(),this.context.fillStyle=e?this.context.createPattern(e,"repeat"):"#FFFFFF";for(var o=[],n=0;n<t.length;++n){var i=c.getPoint(t[n]);i=a.getScreenXY(i),o.push(i)}this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y);for(var s=0;s<o.length;++s)this.context.lineTo(o[s].x,o[s].y);this.context.closePath(),e&&this.context.fill(),this.context.restore()},so.prototype.drawImg=function(t,e,o){this.context.save(),o||(e=a.getScreenXY(e)),this.context.translate(e.x,e.y),this.context.drawImage(t,-t.width/2,-t.height/2),this.context.restore()},so.prototype.drawBackGround=function(t,e,o){this.context.save(),this.context.fillStyle=o,this.context.fillRect(0,0,t,e),this.context.restore()},so.prototype.drawEntranceDoor=function(t){this.context.save();var e,o,n=H.getEnterImg(),i={x:(t.startPoint.x+t.endPoint.x)/2,y:(t.startPoint.y+t.endPoint.y)/2},s=r.createLine1(t.startPoint,t.endPoint),l=r.getLineForPoint(s,i),h=null,c=null;"default"==t.enter?h=r.getParallelLineForDistance(s,n.height/2/a.res):"reverse"==t.enter&&(h=r.getParallelLineForDistance(s,n.height/2/a.res+r.getDistance(t.startPoint,t.endPoint))),e=r.getIntersectionPoint(h.line1,l),o=r.getIntersectionPoint(h.line2,l);var d=r.Angle(t.startPoint,{x:t.startPoint.x+1,y:t.startPoint.y},t.endPoint);r.isClockwise([t.startPoint,t.endPoint,o])?c="LEFT"==t.openSide?"default"==t.enter?e:o:"default"==t.enter?o:e:r.isClockwise([t.startPoint,t.endPoint,e])&&(c="LEFT"==t.openSide?"default"==t.enter?o:e:"default"==t.enter?e:o),r.isClockwise([t.startPoint,t.endPoint,c])||(d=Math.PI+d),c=a.getScreenXY(i),this.context.translate(c.x,c.y),console.log("截图："+JSON.stringify(c)),t.startPoint.y<=t.endPoint.y?this.context.rotate(-d):this.context.rotate(d);var p=r.getDistance(t.startPoint,t.endPoint)*a.res*1.5;this.context.scale(a.ratio*p/n.height,a.ratio*p/n.height),this.context.drawImage(n,-n.width/2,-n.height-10),this.context.restore()},so.prototype.setCanvasStyle=function(t){for(var e in t)"isFill"!=e&&"isStroke"!=e&&(this.context[e]=t[e])};var ro=new so,lo=function(){this.cadBoundingBox=null,this.padding={export:165,cover:35,default:102},this.type=null,this.roomInfo1=null,this.roomInfo2=null,this.roomInfo3=null,this.rooms=[],this.imgCache={},this.anjuke_export=null,this.anjuke=null,this.anjuke_cover=null};lo.prototype.init=function(){this.cadBoundingBox=c.getBoundingBox()},lo.prototype.start=function(){this.layer.uiControl.menu_flex(),ht.clearDefaultTags(),this.layer.history.save(),et.unit="m",ht.convertUnit("m"),ro.context=this.layer.renderer.getContext(),this.setType("export"),this.screenshot(),this.setType("cover"),this.screenshot(),this.setType("default"),this.screenshot(),this.recovery()},lo.prototype.setType=function(t){this.type=t},lo.prototype.autoDraw=function(){for(var t=0;t<this.rooms.length;++t){null!=this.rooms[t].pointIds&&this.drawRoom(this.rooms[t])}var e=c.getFloorData(),o=e.walls;for(var n in o)this.drawGeometry(o[n]);var i=e.points;for(var s in i)this.drawGeometry(i[s]);var r=e.symbols;for(var l in r)this.drawGeometry(r[l])},lo.prototype.getSize=function(){if("export"==this.type)a.width=900,a.height=900,io.export.Wall.lineWidth=Math.ceil(1*io.export.Wall.lineWidth),io.export.Wall.lineWidth_out=Math.ceil(1*io.export.Wall.lineWidth_out);else if("cover"==this.type){var t=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*1.42+2*this.padding.cover,e=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*1.42+2*this.padding.cover;io.cover.Wall.lineWidth=Math.ceil(.0055*Math.max(t,e)*2*1),io.cover.Wall.lineWidth_out=Math.ceil(.0055*Math.max(t,e)*1.5*2*1),t=Math.ceil(t+io.cover.Wall.lineWidth_out),e=Math.ceil(e+io.cover.Wall.lineWidth_out),a.width=t,a.height=e}else if("default"==this.type){var o=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*2+2*this.padding.default,n=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*2+2*this.padding.default;io.default.Wall.lineWidth=Math.ceil(.0055*Math.max(o,n)*2*1),io.default.Wall.lineWidth_out=Math.ceil(.0055*Math.max(o,n)*1.5*2*1),o=Math.ceil(o+io.default.Wall.lineWidth_out),n=Math.ceil(n+io.default.Wall.lineWidth_out),a.width=o,a.height=n}},lo.prototype.screenshot=function(){var t,e,o=this.layer.canvas;if(this.getSize(),"export"==this.type){t=(a.width-this.padding.export-this.padding.export-io.export.Wall.lineWidth_out)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(a.height-this.padding.export-this.padding.export-io.export.Wall.lineWidth_out)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),a.res=Math.min(t,e),o.width=a.width,o.height=a.height;var n=a.getScreenXY({x:this.cadBoundingBox.minX,y:this.cadBoundingBox.minY}),i=a.getScreenXY({x:this.cadBoundingBox.maxX,y:this.cadBoundingBox.maxY});et.updatePad({top:i.y-22,bottom:o.height-n.y-22,left:n.x-22,right:o.width-i.x-22}),et.updateRegion(!1),et.update(),ro.drawBackGround(a.width,a.height,io.export.BackGround.fillStyle),ro.drawMeasure(et.measureLines.top,"top"),ro.drawMeasure(et.measureLines.bottom,"bottom"),ro.drawMeasure(et.measureLines.left,"left"),ro.drawMeasure(et.measureLines.right,"right"),ro.drawExportCompass(this.imgCache.compass,io.export.compass.screen),ro.drawExportTxt(),this.autoDraw(),this.anjuke_export=this.exportImg(o,"image/jpeg")}else"cover"==this.type?(t=(a.width-this.padding.cover-this.padding.cover)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(a.height-this.padding.cover-this.padding.cover)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),a.res=Math.min(t,e),o.width=a.width,o.height=a.height,this.autoDraw(),this.anjuke_cover=this.exportImg(o,"png")):"default"==this.type&&(t=(a.width-this.padding.default-this.padding.default)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(a.height-this.padding.default-this.padding.default)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),a.res=Math.min(t,e),o.width=a.width,o.height=a.height,et.updatePad({top:50,bottom:50,left:50,right:50}),et.updateRegion(!1),et.update(),ro.drawMeasure(et.measureLines.top,"top"),ro.drawMeasure(et.measureLines.bottom,"bottom"),ro.drawMeasure(et.measureLines.left,"left"),ro.drawMeasure(et.measureLines.right,"right"),this.autoDraw(),this.anjuke=this.exportImg(o,"png"))},lo.prototype.recovery=function(){var t=this.layer.app.core.get("CameraControls").activeControl.camera;a.updateForCanvas(this.layer.canvas),a.setRes(t.left,t.right),et.updatePad(et.defalutMeasurePad),et.updateRegion(),this.layer.renderer.autoRedraw()},lo.prototype.exportImg=function(t,e){var o=t.toDataURL(e,3);return this.base64ToBlob(o)},lo.prototype.base64ToBlob=function(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],n=atob(e[1]),i=n.length,s=new Uint8Array(i);i--;)s[i]=n.charCodeAt(i);return new Blob([s],{type:o})},lo.prototype.downloadCadImg=function(t,e){var o=e.substring(e.indexOf(".")+1),n=t.toDataURL(o,3);n=n.replace(this._fixType(o),"image/octet-stream"),this.saveFile(n,e)},lo.prototype.saveFile=function(t,e){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=t,o.download=e;var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},lo.prototype._fixType=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]},lo.prototype.drawGeometry=function(t){switch(t.geoType){case y:ro.drawWall(t,this.type);break;case d:ro.drawPoint(t,this.type);break;case u:ro.drawSingleDoor(t,this.type);break;case g:ro.drawDoubleDoor(t,this.type);break;case f:ro.drawSlideDoor(t,this.type);break;case x:ro.drawSingleWindow(t,this.type);break;case v:ro.drawFrenchWindow(t,this.type);break;case m:ro.drawBayWindow(t,this.type);break;case I:ro.drawBeam(t,this.type);break;case S:ro.drawFlue(t,this.type);break;case b:ro.drawCorridor(t,this.type);break;case w:ro.drawTag(t,this.type)}},lo.prototype.drawRoom=function(t){this.roomInfo1.indexOf(t.name)>-1?ro.drawRoomBackGround(t.pointIds,this.imgCache.room1):this.roomInfo2.indexOf(t.name)>-1?ro.drawRoomBackGround(t.pointIds,this.imgCache.room2):(this.roomInfo3.indexOf(t.name),ro.drawRoomBackGround(t.pointIds,this.imgCache.room3)),"export"==this.type&&t.name&&(ro.drawText(t.center,t.name,!1,0),null!=t.area&&""!=t.area.trim()&&ro.drawText({x:t.center.x,y:t.center.y-16/a.res},t.area+"m²",!1,0))};var ao=new lo,ho=function(t,e){this.app=t.app,this.layer=t,ao.layer=t,this.ajkJson={},this.cameraJson={},this.floorPlanJson={},this.getCameraJson(e),this.loadImg()};ho.prototype.loadImg=function(){this.app.store.getAppImage("images/ajk/cad_compass_ajk.png").then((function(t){ao.imgCache.compass=t})),this.app.store.getAppImage("images/ajk/room1_ajk.png").then((function(t){ao.imgCache.room1=t})),this.app.store.getAppImage("images/ajk/room2_ajk.png").then((function(t){ao.imgCache.room2=t})),this.app.store.getAppImage("images/ajk/room3_ajk.png").then((function(t){ao.imgCache.room3=t})),ao.roomInfo1=["书房","厨房","卫生间","多功能室","阳台","储物间","步入式衣柜","外景","露台（无顶）","影视间","入房花园"],ao.roomInfo2=["主卧","儿童房","次卧","客卧","老人房","卧室"],ao.roomInfo3=["整套","客厅","走廊","餐厅","起居室","客餐厅","玄关","门厅"]},ho.prototype.start=function(){var t=this;return new Promise((function(e,o){le.start(),t.getFloorPlanJson().then((function(n){t.floor=n,c.updateBoundingBox(),ao.init();var i=c.getTags();if(0!=Object.keys(i).length)if(s=t.getAJKRooms(i)){var s=t.getEntrance();s?(t.getSceneName(),t.getPictureRotate(),t.getImgInfo(),t.layer.renderer.clear(),ao.start(),e({ajkJson:t.ajkJson,cameraJson:t.cameraJson,floorPlanJson:{floors:[t.floor.floors[0]]},files:{bgmgdCZp_anjuke:ao.anjuke,bgmgdCZp_anjuke_cover:ao.anjuke_cover,bgmgdCZp_anjuke_export:ao.anjuke_export}})):o({type:"toast",msg:"平面图至少包含要给入户门，且入户门应为单开门"})}else o({type:"toast",msg:"标注应包含房间名称、面积"});else o({type:"toast",msg:"平面图应至少包含一个标注"})}))}))},ho.prototype.getAJKRooms=function(t){ao.rooms=[];var e=c.getRooms();this.ajkJson.rooms=this.createAjkRoomForTag(t);for(var o=[],n=0;n<this.ajkJson.rooms.length;++n){if(null==this.ajkJson.rooms[n].area||void 0===this.ajkJson.rooms[n].area)return!1;for(var i=ao.rooms.length,s=0;s<e.length;++s){if(!(o.indexOf(s)>-1))if(e[s].containPoint(this.ajkJson.rooms[n].labelPos)){o.push(s),console.log("匹配："+this.ajkJson.rooms[n].name+"&"+e[s].tagName),ao.rooms.push({center:JSON.parse(JSON.stringify(this.ajkJson.rooms[n].labelPos)),pointIds:JSON.parse(JSON.stringify(e[s].wallPointIDs)),name:this.ajkJson.rooms[n].name,area:this.ajkJson.rooms[n].area});break}}i==ao.rooms.length&&(this.ajkJson.rooms.splice(n,1),--n)}return this.setRoomsGroup(),!0},ho.prototype.getCameraJson=function(t){this.cameraJson={},this.cameraJson.sweepLocations=[];for(var e=0;e<t.sweepLocations.sweepLocations.length;++e){var o=t.sweepLocations.sweepLocations[e];o.uuid=o.uuid.toUTF8().replace(/-/g,""),this.cameraJson.sweepLocations.push(o)}},ho.prototype.getFloorPlanJson=function(){return this.app.store.get("floor",(function(t){return t}))},ho.prototype.getEntrance=function(t){null!=t&&void 0!==t||(t=c.getCurrentFloor());var e=c.getSymbols(t),o=null;for(var n in e)if((o=e[n]).enter)break;if(null!=o&&o.enter){var i=this.layer.app.core.get("Player").model.floors.list[t].boundingBox.min.y+.1,s=new THREE.Vector3(o.startPoint.x,i+.4*.2,-o.startPoint.y),r=new THREE.Vector3(o.endPoint.x,i+.4*.2,-o.endPoint.y),l=s.clone().add(r).multiplyScalar(.5),a=new THREE.Vector3(o.points2d[3].x,i+.4*.2,o.points2d[3].y);a.z*=-1;var h=this.getFootPoint(a,s,r),d=a.clone().sub(h).normalize();l.clone().negate().angleTo(d)>Math.PI/2&&(l.add(d.clone().multiplyScalar(s.distanceTo(r))),d.multiplyScalar(-1)),l.add(d.clone().multiplyScalar(-.5));var p={Position:new THREE.Vector3(l.x,-l.z,l.y),Direction:new THREE.Vector3(d.x,-d.z,d.y)};return this.ajkJson.Entrance=p,!0}return!1},ho.prototype.getSceneName=function(){var t=this.app.store.getValue("metadata");this.ajkJson.scene_name=t.title},ho.prototype.getPictureRotate=function(){var t=c.getAngle(),e=new THREE.Euler(0,t,0),o=new THREE.Vector3(0,0,-1);o.applyEuler(e),o=new THREE.Vector3(o.x,-o.z,o.y),this.ajkJson.picture_rotate=o},ho.prototype.getFootPoint=function(t,e,o,n){var i=t.clone().sub(e),s=e.clone().sub(o),r=s.length(),l=i.dot(s)/r,a=e.clone().add(s.multiplyScalar(l/r));return n&&a.clone().sub(e).dot(a.clone().sub(o))>0&&(a=a.distanceTo(e)<a.distanceTo(o)?e.clone():o.clone()),a},ho.prototype.getImgInfo=function(){var t=c.getCurrentFloor(),e=c.getCadInfo(this.layer.canvas)[t],o={};o.bound=e.bound,o.margin=51,o.marginReal=o.margin/a.res,o.width=Math.abs(e.bound.left-e.bound.right),o.center={x:(e.bound.left+e.bound.right)/2,y:(e.bound.top+e.bound.bottom)/2},this.ajkJson.img_info=o},ho.prototype.createAjkRoomForTag=function(t){var e=[];for(var o in t){var n={},i={},s=t[o];i.area=s.des,i.name=s.title,i.tagId=s.vectorId,i.floor=c.getCurrentFloor(),n.x=s.center.x,n.y=s.center.y,n.z=0,i.labelPos=n,i.group=-1,e.push(i)}return e},ho.prototype.setRoomsGroup=function(){for(var t=JSON.parse(JSON.stringify(ao.rooms)),e=[],o=c.getAngle(),n=0;n<this.ajkJson.rooms.length;++n){e=[];for(var i=[],s=0;s<t[n].pointIds.length;++s){var l=c.getPoint(t[n].pointIds[s]);i.push({x:l.x,y:l.y})}for(var h=0;h<this.cameraJson.sweepLocations.length;++h){var d=a.getVectorForRotate(this.cameraJson.sweepLocations[h].puck,o);r.isPointInPoly(d,i)&&(this.ajkJson.rooms[n].group=parseInt(this.ajkJson.rooms[n].tagId.replace("Tag","")),e.push(h))}if(void 0!==this.ajkJson.rooms[n].group&&0!=e.length){for(var p=null,y=0;y<e.length;++y){p=e[y]}this.cameraJson.sweepLocations[p].group=this.ajkJson.rooms[n].group,console.log("安居客图片生成成功："+this.ajkJson.rooms[n].name)}else this.ajkJson.rooms.splice(n,1),t.splice(n,1),--n}};var co=function(){};co.prototype.init=function(t){return this.layer=t,this},co.prototype.use=function(t,e){if(!this[t])return"DataAJK"==t&&(this[t]=new ho(this.layer,e)),this},co.prototype.start=function(t){return this[t]?this[t].start():Promise.reject()};var po=new co,yo=function(t){function e(e,o){t.call(this),this.app=e,this.load=new pt(this),this.analyService=new Ct(this),this.uiControl=new ce(this),this.renderer=new Ee(this),this.history=new no(this),this.sync=po.init(this),this.startX=null,this.startY=null,this.player=this.app.core.get("Player"),this.display=!1,c.$app=this.app,o&&o.padding&&et.padding(o.padding),this.app.store.getAppImage("images/cad/cad_enter_dark.png").then((function(t){H.setEnterImg(t)})),this.app.store.getAppImage("images/cad/compass-white.png").then((function(t){Oe.setWhiteImg(t)})),this.app.store.getAppImage("images/cad/compass-black.png").then((function(t){Oe.setBlackImg(t)})),Promise.all([this.app.store.getAppImage("images/cad/hall.png"),this.app.store.getAppImage("images/cad/room.png"),this.app.store.getAppImage("images/cad/other.png")]).then((function(t){se.setHallImg(t[0]),se.setDefaultImg(t[1]),se.setOtherImg(t[2])}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={isChanged:{configurable:!0},isCurrentFloorEmpty:{configurable:!0}};return e.prototype.init=function(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,Re.initContext(this.canvas),this.bindEvents()},e.prototype.initPanos=function(t){var e=this.app.core.get("Player").model.panos.list;o.panos=[];for(var n=0;n<e.length;++n){var i=e[n];i.floorIndex==t&&o.panos.push({vectorId:i.id,x:i.position.x,y:-1*i.position.z,name:"pano"})}var s=c.getAngle();a.updatePanosForRotate(s)},e.prototype.render=function(){var t=this;null==a.center&&(a.init(this.canvas),a.setDefaultCenter(this.app.core.get("Player").model.center)),this.initPanos(c.currentFloor);var e=this.app.core.get("CameraControls").activeControl.camera;a.setRes(e.left,e.right),a.setInitInfo(a.res,a.width,a.height);var o=c.getAngle();o=parseFloat(o);var n=a.getScreenInfoForCAD();n.floorPlanAngle=o,et.updateRegion(),et.update(),this.app.core.get("CameraControls").emit("syncCadAnd3D",n),this.app.core.get("SceneRenderer").resizeListeners.push({setSize:function(e,n){if(t.display){a.updateForCanvas(t.canvas),a.updateResForReSize(e,n,o),et.updateRegion(),et.update(),t.renderer.autoRedraw();var i=a.getScreenInfoForCAD();i.floorPlanAngle=c.getAngle(),t.app.core.get("CameraControls").emit("syncCadAnd3D",i)}}}),this.history.init(),this.renderer.autoRedraw();var i=this.app.store.getValue("flooruser");i.unit&&(this.$xui.currentUnit=i.unit,et.unit=i.unit,ht.convertUnit(i.unit),this.renderer.autoRedraw())},e.prototype.reRender=function(){a.setDefaultCenter(this.app.core.get("Player").model.center),a.init(this.canvas);var t=a.getScreenInfoForCAD();t.floorPlanAngle=c.getAngle(),this.app.core.get("CameraControls").emit("syncCadAnd3DForRotate",t);var e=this.app.core.get("CameraControls").activeControl.camera;a.setRes(e.left,e.right),a.setInitInfo(a.res,a.width,a.height),this.initPanos(c.getCurrentFloor()),et.updateRegion(),et.update(),this.history.init(),this.renderer.autoRedraw()},e.prototype.show=function(){var t=this;return new Promise((function(e){t.display=!0,t.app.MinMap.hide(),t.app.Camera.floorplan().then((function(){t.player.model.floorplanCadImg.displayCad(!1),t.player.labelManager.hide(),t.app.Camera.setCompassDisplay(!1,!0),t.app.dom.querySelector("[xui_edit_cad]").style.display="block",t.div?(t.canvas.width=t.canvas.clientWidth,t.canvas.height=t.canvas.clientHeight):(t.div=t.app.dom.querySelector("[xui_edit_cad]"),t.canvas=t.app.dom.querySelector("[xui_edit_cad] canvas"),t.init());var o=t.app.core.get("Player").model.currentFloor.floorIndex;c.setCurrentFloor(o),t.load.loadFloorJson().then((function(){t.uiControl.menu_flex(),t.app.core.get("Player").gotoFloor(c.currentFloor),t.render(),t.uiControl.showTexture||(t.app.dom.querySelector('.player[name="main"]').style.visibility="hidden"),e(),t.emit("show")}))})),t.div||document.addEventListener("keydown",t.onKeydown.bind(t))}))},e.prototype.hide=function(){this.uiControl.showTexture||(this.app.dom.querySelector('.player[name="main"]').style.visibility="visible"),this.display=!1,this.$xui&&(this.$xui.selectName=null,this.$xui.currentName=null,this.$xui.currentAttributes={}),this.app.Camera.setCompassDisplay(!0,!1),this.app.dom.querySelector("[xui_edit_cad]").style.display="none";var t=this.app.core.get("CameraControls").controls.floorplan;t.camera.position.copy(t.target),t.recoverToUpdate(),this.player.model.floorplanCadImg.displayCad(!0),this.player.labelManager.hide(),this.app.MinMap.display=null,this.emit("hide")},e.prototype.padding=function(t){et.padding(t)},e.prototype.bindEvents=function(){this.div.addEventListener("contextmenu",(function(t){t.preventDefault()})),this.div.addEventListener("mousedown",this.onMouseDown.bind(this)),this.div.addEventListener("mousemove",this.onMouseMove.bind(this)),this.div.addEventListener("mouseup",this.onMouseUp.bind(this)),this.div.addEventListener("mousewheel",this.onWheel.bind(this)),this.div.addEventListener("DOMMouseScroll",this.onWheel.bind(this))},e.prototype.onMouseDown=function(t){if(null!=a.defaultCenter){if(this.app.core.get("CameraControls").onMouseDown(t),this.startX=t.offsetX||t.layerX,this.startY=t.offsetY||t.layerY,this.lastX=t.offsetX||t.layerX,this.lastY=t.offsetY||t.layerY,2==t.button)return this.stopAddVector(),this.uiControl.currentUI=null,void this.renderer.autoRedraw();var e=Z.getEventName();if(e==Dt){if(!this.setNewWallPoint("start",{x:this.startX,y:this.startY}))return}else if(e==Mt){if(!this.setNewWallPoint("end",{x:this.startX,y:this.startY}))return;if(!he.canAdd)return;he.buildWall(this.uiControl.selectUI==Jt),this.history.save()}else{var o=Z.getSelectItem();null==e&&o?(Z.setDraggingItem(o),Z.setFocusItem(o),this.uiControl.showAttributes(),this.uiControl.currentUI=o.type):null==e&&(this.uiControl.currentUI=null)}this.setEventName("mouseDown"),t.preventDefault(),t.stopPropagation()}},e.prototype.onMouseMove=function(t){if(null!=a.defaultCenter){var e=t.offsetX||t.layerX,o=t.offsetY||t.layerY,n=e-this.lastX,s=o-this.lastY,l=a.getXYFromScreen({x:e,y:o}),h=Z.getEventName(),d=!1,p=Z.getDraggingItem();switch(h){case null:d=bt.start(l);break;case Tt:Z.clearItems(),a.center.x=a.center.x-n*i.defaultZoom/a.zoom/a.res,a.center.y=a.center.y+s*i.defaultZoom/a.zoom/a.res,this.lastX=e,this.lastY=o,d=!0;var y=c.getAngle(),u=a.getScreenInfoForCAD();u.floorPlanAngle=y,this.app.core.get("CameraControls").emit("syncCadAnd3D",u);break;case Dt:Z.clearDraggingItem(),Z.clearFocusItem(),d=!0,bt.start(l),bt.modifyPoint&&(l={x:bt.modifyPoint.x,y:bt.modifyPoint.y}),wt.execute(null,l),wt.setStartAddWall(l),wt.showStartAddWall();break;case Mt:Z.clearDraggingItem(),Z.clearFocusItem(),d=!0,bt.start(l);var g={x:he.startInfo.position.x,y:he.startInfo.position.y};if(bt.modifyPoint&&(l={x:bt.modifyPoint.x,y:bt.modifyPoint.y}),wt.execute(g,l),wt.setStartAddWall(l),wt.newWall.display){if(!bt.modifyPoint&&he.startInfo.linkedPointId){var f=wt.checkAngle(l,he.startInfo.linkedPointId,null);f&&r.clonePoint(l,f)}wt.setNewWallEndPosition(l)}else wt.setNewWall(g,l),wt.showNewWall();he.canAdd=he.canAddWallForEnd(l),he.canAdd?this.uiControl.selectUI==Jt?wt.setNewWallState("normal-out"):wt.setNewWallState("normal"):wt.setNewWallState("error");break;case Lt:n=n*i.defaultZoom/a.zoom,s=s*i.defaultZoom/a.zoom;var x=ve.moveWallPlane(p.vectorId,n,s);1==x?(this.lastX=e,this.lastY=o,d=!0):2==x||(3==x?(this.history.save(),Z.clearSelectItem(),Z.clearDraggingItem(),Z.clearEventName(),bt.clear(),d=!0):4==x?(this.lastX=e,this.lastY=o,this.startX=e,this.startY=o,d=!0):5==x&&(this.lastX=e,this.lastY=o)),ve.needUpdateRoom;break;case Ot:var m=c.getPoint(p.vectorId);bt.start(l,p.vectorId,m.parent),bt.modifyPoint&&(l={x:bt.modifyPoint.x,y:bt.modifyPoint.y}),wt.execute(null,l),ve.movePoint(p.vectorId,l,bt.modifyPoint)||wt.hideAll(),d=!0;break;case At:if(bt.start(l),bt.wallInfo.wallId)if(d=!0,null==p){var v=this.uiControl.getSymbolTypeForUI(),P=H.addSymbol(l,v,bt.wallInfo.wallId);if(P){Z.setSelectItem(P,v,O),Z.setDraggingItem(Z.selectItem);var I=c.getSymbol(P);I.len=r.getDistance(I.startPoint,I.endPoint)}}else ye.moveFullSymbol(l,p.vectorId,bt.wallInfo.wallId);else d=!1;break;case Rt:bt.start(l),d=!0,null!=p&&H.isSymbol(p.type)&&ye.moveFullSymbol(l,p.vectorId,bt.wallInfo.wallId);break;case Et:d=!0,null!=p&&H.isSymbol(p.type)&&ye.moveSymbolPoint(l,p.vectorId,p.selectIndex);break;case Nt:if(d=!0,null==p){var S=this.uiControl.getComponentTypeForUI(),b=z.createComponent(l,S);b.vectorId&&(Z.setSelectItem(b.vectorId,S,O),Z.setDraggingItem(Z.selectItem))}else{ge.moveFullComponent(l,p.vectorId)&&(this.lastX=e,this.lastY=o,this.startX=e,this.startY=o)}break;case Bt:if(d=!0,null!=p&&z.isComponent(p.type))ge.moveFullComponent(l,p.vectorId)&&(this.lastX=e,this.lastY=o,this.startX=e,this.startY=o);break;case Yt:if(d=!0,null==p){var k=ht.createTag(l);k.vectorId&&(Z.setSelectItem(k.vectorId,w,O),Z.setDraggingItem(Z.selectItem))}else xe.moveFullTag(l,p.vectorId);break;case jt:d=!0,null!=p&&xe.moveFullTag(l,p.vectorId)}d&&this.renderer.autoRedraw()}},e.prototype.onMouseUp=function(t){if(null!=a.defaultCenter){var e=t.offsetX||t.layerX,o=t.offsetY||t.layerY;this.app.core.get("CameraControls").onMouseUp(t);var n=Z.getEventName(),i=Z.getDraggingItem(),s=null;i&&i.vectorId&&(s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},Z.setFocusItem(s),this.uiControl.showAttributes()),a.getXYFromScreen({x:e,y:o});var l=null;switch(n){case null:return;case Tt:Z.clearFocusItem(),this.uiControl.currentUI=null;break;case Ot:wt.hideAll();var h=c.getPoint(i.vectorId);h&&(bt.start(h,i.vectorId,h.parent),bt.modifyPoint&&bt.modifyPoint.hasOwnProperty("linkedPointId")?L.moveTo(i.vectorId,bt.modifyPoint.linkedPointId):bt.modifyPoint&&(bt.modifyPoint.linkedPointIdX||bt.modifyPoint.linkedPointIdY)?(r.clonePoint(h,bt.modifyPoint),H.updateSymbolsPositionsForWallCorner(i.vectorId)):bt.modifyPoint&&bt.modifyPoint.hasOwnProperty("linkedWallId")?(h=L.createPoint(bt.modifyPoint.x,bt.modifyPoint.y),L.splitWall(bt.modifyPoint.linkedWallId,h.vectorId,"start"),L.moveTo(i.vectorId,h.vectorId)):null!=ve.splitWallId&&L.splitWall(ve.splitWallId,i.vectorId,"start"),ve.updateForAbsorbWallPoints(),this.history.save());break;case Mt:if(he.startInfo&&he.startInfo.linkedPointId){var d=c.getPoint(he.startInfo.linkedPointId);he.endInfo.position&&Object.keys(d.parent).length>1&&(Z.clearEventName(),he.clear(),wt.hideAll())}break;case Lt:if(null!=s&&s.type==y){var p=c.getWall(s.vectorId);p.import||p.out?this.uiControl.currentUI="OutWall":this.uiControl.currentUI=s.type,this.history.save()}else this.history.save();break;case At:if(null==i)return void this.setEventName("mouseUp");s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},Z.setFocusItem(s),this.uiControl.showAttributes(),this.uiControl.currentUI=s.type,this.history.save();break;case Rt:l=c.getSymbol(i.vectorId),null!=s&&H.isSymbol(s.type)?(this.uiControl.currentUI=s.type,this.history.save()):l&&(l.len=null,this.history.save());break;case Et:null!=s&&H.isSymbol(s.type)?(this.uiControl.currentUI=s.type,this.history.save()):this.history.save();break;case Nt:s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},Z.setFocusItem(s),this.uiControl.showAttributes(),this.uiControl.currentUI=s.type,this.history.save();break;case Bt:null!=s&&z.isComponent(s.type)?(this.uiControl.currentUI=s.type,this.history.save()):this.history.save();break;case jt:null!=s&&s.type==w?(this.uiControl.currentUI=s.type,this.history.save()):this.history.save();break;case Yt:c.getTag(i.vectorId).setAdding(!1),s={vectorId:i.vectorId,type:i.type,cursor:{x:this.lastX,y:this.lastY}},Z.setFocusItem(s),this.history.save(),this.uiControl.currentUI=s.type}this.setEventName("mouseUp"),Z.clearDraggingItem(),this.renderer.autoRedraw()}},e.prototype.onWheel=function(t){if(null!=a.defaultCenter){t.preventDefault();var e=t.type;if("DOMMouseScroll"==e||"mousewheel"==e){var o=t.wheelDelta?t.wheelDelta/120*2:-(t.detail||0)/3*2,n=a.zoom+o;if(n<14)return;a.updateZoom(n);var i=a.getScreenInfoForCAD();i.floorPlanAngle=c.getAngle(),this.app.core.get("CameraControls").emit("syncCadAnd3D",i),this.renderer.autoRedraw()}}},e.prototype.onKeydown=function(t){if(this.display)if(t.ctrlKey&&"KeyZ"==t.code){if(!this.$xui.toolbar.recall)return;this.revokeHistory(),console.log("ctrl+z")}else if(t.ctrlKey&&"KeyY"==t.code){if(!this.$xui.toolbar.recover)return;this.recoveryHistory(),console.log("ctrl+y")}else"Delete"==t.code?(this.deleteItem(),this.uiControl.currentUI=null,this.history.save(),this.renderer.autoRedraw(),console.log("Delete")):"Escape"==t.code&&(this.stopAddVector(),this.renderer.autoRedraw(),console.log("Esc"))},e.prototype.updateEventNameForSelectUI=function(){if(wt.hideAll(),Z.getEventName()==Yt){var t=Z.getDraggingItem();t&&t.type==w&&c.deleteTag(t.vectorId)}Z.clearItems(),this.uiControl.selectUI==_t||this.uiControl.selectUI==Jt?Z.setEventName(Dt):this.uiControl.selectUI==Xt||this.uiControl.selectUI==Ut||this.uiControl.selectUI==Ht||this.uiControl.selectUI==Vt||this.uiControl.selectUI==Gt||this.uiControl.selectUI==$t||this.uiControl.selectUI==Kt?Z.setEventName(At):this.uiControl.selectUI==zt||this.uiControl.selectUI==qt||this.uiControl.selectUI==Zt?Z.setEventName(Nt):this.uiControl.selectUI==Qt&&Z.setEventName(Yt)},e.prototype.setEventName=function(t){var e=Z.getEventName();if("mouseDown"==t)if(null==e){var o=Z.getSelectItem();if(null==o)Z.setEventName(Tt);else if(o.type==y)Z.setEventName(Lt);else if(o.type==p)Z.setEventName(Ot);else if(H.isSymbol(o.type))if(o.selectIndex==O||o.selectIndex==E){Z.setEventName(Rt);var n=c.getSymbol(o.vectorId);n.len=r.getDistance(n.startPoint,n.endPoint)}else o.selectIndex!=A&&o.selectIndex!=R||Z.setEventName(Et);else z.isComponent(o.type)?Z.setEventName(Bt):o.type==w&&Z.setEventName(jt)}else e==Dt&&Z.setEventName(Mt);else"mouseUp"==t&&(e==Yt||e!=Dt&&e!=Mt&&Z.clearEventName())},e.prototype.exit=function(){Z.clearItems(),Z.clearEventName(),this.uiControl.clearUI()},e.prototype.stopAddVector=function(){var t=Z.getEventName();if(t!=Mt){Z.clearEventName();var e=Z.getDraggingItem();t==At?e&&e.vectorId&&(H.deleteSymbol(e.vectorId),Z.clearDraggingItem()):t==Nt?e&&e.vectorId&&c.deleteComponent(e.vectorId):t==Yt&&e&&e.vectorId&&(ht.deleteTag(e.vectorId),this.uiControl.currentUI=null)}else Z.setEventName(Dt);this.uiControl.clearUI(),wt.hideAll()},e.prototype.setNewWallPoint=function(t,e){return"select"!=bt.symbolInfo.state&&(("start"==t||"end"==t)&&(bt.modifyPoint?he.setPointInfo(t,bt.modifyPoint):he.setPointInfo(t,a.getXYFromScreen(e)),!0))},e.prototype.reload=function(){var t=this;return Ft.clearHistoryRecord(),this.$xui.toolbar.recall=!1,this.$xui.toolbar.recover=!1,c.clear(),a.clear(),Z.clearItems(),Z.clearEventName(),this.load.loadFloorJson(!0).then((function(e){t.app.store.getValue("metadata").floorPlanAngle=e.angle,t.reRender()}))},e.prototype.update=function(){this.app.store.getValue("metadata").floorPlanUser=1,this.app.core.get("Player").model.floorplanCadImg.updatePlanes(),this.app.MinMap.reload(),this.renderer.autoRedraw(),this.div.style.visibility="visible"},e.prototype.exportImages=function(){this.div.style.visibility="hidden",this.stopAddVector();var t=c.getFloorData();return 0==Object.keys(t.points).length&&0==Object.keys(t.components).length&&0==Object.keys(t.tags).length?(this.div.style.visibility="visible",null):this.load.uploadCad()},e.prototype.exportJSON=function(t){return le.start(),this.app.store.getValue("flooruser").cadInfo=t,console.log(t,"----before"),{cadInfo:t,version:o.version,floors:o.floors,unit:et.unit,angle:c.getAngle(),currentId:c.getCurrentId(),compass:c.getCompass()}},e.prototype.exportHouseData=function(){return this.analyService.houseData},e.prototype.importJSON=function(){},n.isChanged.get=function(){return Ft.hasRecords()},n.isCurrentFloorEmpty.get=function(){var t=c.getFloorData();return 0==Object.keys(t.points).length&&0==Object.keys(t.components).length&&0==Object.keys(t.tags).length},e.prototype.revokeHistory=function(){this.history.goPreState(),this.renderer.autoRedraw(),Ft.getHistoryState().pre?this.$xui.toolbar.recall=!0:this.$xui.toolbar.recall=!1,this.$xui.toolbar.recover=!0},e.prototype.recoveryHistory=function(){this.history.goNextState(),this.renderer.autoRedraw(),Ft.getHistoryState().next?this.$xui.toolbar.recover=!0:this.$xui.toolbar.recover=!1,this.$xui.toolbar.recall=!0},e.prototype.deleteItem=function(){var t=Z.getFocusItem();t&&(t.type==y?c.deleteWall(t.vectorId):H.isSymbol(t.type)?H.deleteSymbol(t.vectorId):z.isComponent(t.type)?c.deleteComponent(t.vectorId):t.type==w?c.deleteTag(t.vectorId):t.type==p&&L.deleteWallCorner(t.vectorId),this.history.save(),this.renderer.autoRedraw())},Object.defineProperties(e.prototype,n),e}(KanKan.MITT.Emiter);return function(t){var e=KanKan.Deferred();return t.Scene.on("loaded",(function(){var o=new yo(t);o.$html="<div xui_edit_cad> <canvas></canvas> </div> <style> [xui_edit_cad] {\r\n        display: none;\r\n        position: absolute;\r\n        pointer-events: all;\r\n        width: 100%;\r\n        height: 100%;\r\n      \r\n\r\n    }\r\n    [xui_edit_cad] canvas {\r\n        position: absolute;\r\n        width: 100%;\r\n        height: 100%;\r\n        top: 0;\r\n        left: 0;\r\n    } </style> ",o.$name="EditCAD",o.$load=function(){t.CadManager.install(o)},e.resolve(o)})),e}}();
