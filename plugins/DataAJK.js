var DataAJK=function(){"use strict";var t=function(){this.version="v4.0",this.floors=[]};t.prototype.initFloor=function(t){this.floors[t]={},this.floors[t].points={},this.floors[t].walls={},this.floors[t].symbols={},this.floors[t].components={},this.floors[t].tags={},this.floors[t].boundingBox={},this.floors[t].rooms=[]};var o=new t;window.floorplanData=o;var r=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.rotate=0,this.initRes=null,this.initWidth=null,this.initHeight=null};r.prototype.init=function(t){var e=c.getBoundingBox();this.setCenter(e),this.updateForCanvas(t)},r.prototype.setInitInfo=function(t,e,o){null==this.initRes&&(this.initRes=t),null==this.initWidth&&(this.initWidth=e),null==this.initHeight&&(this.initHeight=o)},r.prototype.updateResForReSize=function(t,e,o){Math.abs(o)<.01||Math.abs(o-2*Math.PI)<.01?this.res=this.initRes*t/this.initWidth:this.res=this.initRes*e/this.initHeight},r.prototype.setCenter=function(t){this.cadBoundingbox=JSON.parse(JSON.stringify(t)),null!=this.cadBoundingbox&&(this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2},this.defaultCenter={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2})},r.prototype._setRes=function(t){this.res=t},r.prototype.setRes=function(t,e){this.res=this.width/Math.abs(e-t)},r.prototype.getScreenXY=function(t){if(null==this.width||null==this.height)return null;var e=t.x,o=t.y,n=this.width/2+(e-this.center.x)*this.res*this.zoom/100,i=this.height/2-(o-this.center.y)*this.res*this.zoom/100;return n=.5+n<<0,i=.5+i<<0,{x:Math.floor(n)*this.ratio,y:Math.floor(i)*this.ratio}},r.prototype.getXYFromScreen=function(t){var e={};return e.x=(t.x-this.width/2)/this.res*100/this.zoom+this.center.x,e.y=(this.height/2-t.y)/this.res*100/this.zoom+this.center.y,e},r.prototype.getPointForRotate=function(t){return 0==this.rotate||360==this.rotate?t:{x:(t.x-this.center.x)*Math.cos(this.rotate/180*Math.PI)-(t.y-this.center.y)*Math.sin(this.rotate/180*Math.PI)+this.center.x,y:(t.y-this.center.y)*Math.cos(this.rotate/180*Math.PI)+(t.x-this.center.x)*Math.sin(this.rotate/180*Math.PI)+this.center.y}},r.prototype.getPointForRevRotate=function(t,e){if(Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.defaultCenter.x)*Math.cos(e)-(t.y-this.defaultCenter.y)*Math.sin(e)+this.defaultCenter.x,n=(t.y-this.defaultCenter.y)*Math.cos(e)+(t.x-this.defaultCenter.x)*Math.sin(e)+this.defaultCenter.y;return t.x=o,t.y=n,t},r.prototype.getVectorForRotate=function(t,e){if(e=-e,Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.defaultCenter.x)*Math.cos(e)-(t.y-this.defaultCenter.y)*Math.sin(e)+this.defaultCenter.x,n=(t.y-this.defaultCenter.y)*Math.cos(e)+(t.x-this.defaultCenter.x)*Math.sin(e)+this.defaultCenter.y;return t.x=o,t.y=n,t},r.prototype.updateCenterForRotate=function(t){if(!(Math.abs(t)<.01||Math.abs(t-2*Math.PI)<.01)){var e=this.center.x*Math.cos(t)-this.center.y*Math.sin(t),o=this.center.y*Math.cos(t)+this.center.x*Math.sin(t);return this.center.x=e,this.center.y=o,this.center}},r.prototype.updateForCanvas=function(t){t&&(this.width=t.clientWidth,this.height=t.clientHeight,t.width=t.clientWidth,t.height=t.clientHeight)},r.prototype.updateZoom=function(t){this.zoom=t},r.prototype.moveTo=function(t,e){var o=this.getXYFromScreen(e);this.zoom=t;var n=(100*e.x/this.zoom-this.width/2)/this.res,i=(this.height/2-100*e.y/this.zoom)/this.res;this.center.x=o.x-n,this.center.y=o.y-i},r.prototype.getXYFromScreenForDefaultZoom=function(t){var e={};return e.x=(t.x-this.width/2)/this.res+this.center.x,e.y=(this.height/2-t.y)/this.res+this.center.y,e},r.prototype.getScreenInfoForCAD=function(){var t=this.getXYFromScreen({x:this.width,y:this.height}),e=this.getXYFromScreen({x:0,y:0}),o={x:this.center.x,y:this.center.y};return{width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y),center:{x:o.x,y:-1*o.y},defaultCenter:this.defaultCenter}},r.prototype.getPixelRatio=function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},r.prototype.reSet=function(){this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2},this.zoom=100},r.prototype.updateForRotate=function(t){void 0===t&&(t=Math.PI/2);for(var e=0;e<o.floors.length;++e){var n=o.floors[e].points;for(var i in n)n[i]=this.getVectorForRotate(n[i],t);var r=o.floors[e].symbols;for(var s in r)r[s].startPoint=this.getVectorForRotate(r[s].startPoint,t),r[s].endPoint=this.getVectorForRotate(r[s].endPoint,t),r[s].setPoints2d();var a=o.floors[e].components;for(var l in a){var h=a[l];h.center=this.getVectorForRotate(h.center,t),h.setPoints2d()}var c=o.floors[e].tags;for(var p in c)c[p].center=this.getVectorForRotate(c[p].center,t),c[p].setPoints2d()}},r.prototype.clear=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.rotate=0};var s=new r,a=.1,l=100,h=function(){this.currentId=0,this.currentFloor=0,this.angle=0};h.prototype.setCurrentId=function(t){this.currentId=t},h.prototype.getCurrentId=function(){return this.currentId},h.prototype.updateCurrentId=function(){++this.currentId},h.prototype.setCurrentFloor=function(t){1==o.floors.length?this.currentFloor=0:this.currentFloor=t},h.prototype.getCurrentFloor=function(){return this.currentFloor},h.prototype.getCompass=function(){return o.compass},h.prototype.setCompass=function(t){o.compass=t},h.prototype.getFloorNum=function(){return o.floors.length},h.prototype.initFloor=function(t){o.initFloor(t)},h.prototype.getFloors=function(){return o.floors},h.prototype.getPoint=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].points[t]},h.prototype.deletePoint=function(t,e,n){null!=n&&void 0!==n||(n=this.currentFloor);var i=this.getPoint(t);if(i)if(0==Object.keys(i.parent).length)i=null,delete o.floors[n].points[t];else if(1!=Object.keys(i.parent).length||e)if(1==Object.keys(i.parent).length&&i.parent[e])delete o.floors[n].points[t];else{if(1==Object.keys(i.parent).length&&!i.parent[e])return;delete i.parent[e]}else delete o.floors[n].points[t]},h.prototype.getWall=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].walls[t]},h.prototype.deleteWall=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor);for(var n=this.getWall(t,e),i=0;i<n.children.length;++i)this.deleteSymbol(n.children[i],e);this.deletePoint(n.start,t,e),this.deletePoint(n.end,t,e),delete o.floors[e].walls[t]},h.prototype.deleteWallNoSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor);var n=this.getWall(t,e);this.deletePoint(n.start,t,e),this.deletePoint(n.end,t,e),delete o.floors[e].walls[t]},h.prototype.getAngle=function(){return this.angle},h.prototype.setAngle=function(t){this.angle=t},h.prototype.setBoundingBox=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].boundingBox=JSON.parse(JSON.stringify(t))},h.prototype.getBoundingBox=function(t){if(null==t||void 0===t){for(var e=null,n=null,i=null,r=null,s=0;s<o.floors.length;++s)o.floors[s].boundingBox.hasOwnProperty("maxX")&&o.floors[s].boundingBox.hasOwnProperty("minX")&&o.floors[s].boundingBox.hasOwnProperty("maxY")&&o.floors[s].boundingBox.hasOwnProperty("minY")||this.updateBoundingBox(s),(null==e||e>o.floors[s].boundingBox.minX)&&(e=o.floors[s].boundingBox.minX),(null==n||n<o.floors[s].boundingBox.maxX)&&(n=o.floors[s].boundingBox.maxX),(null==i||i>o.floors[s].boundingBox.minY)&&(i=o.floors[s].boundingBox.minY),(null==r||r<o.floors[s].boundingBox.maxY)&&(r=o.floors[s].boundingBox.maxY);return{minX:e,maxX:n,minY:i,maxY:r}}return o.floors[t].boundingBox},h.prototype.updateBoundingBox=function(t){var e=this.getPoints(t),o=null,n=null,i=null,r=null;for(var s in e){var a=e[s];(null==o||o>a.x)&&(o=a.x),(null==n||n<a.x)&&(n=a.x),(null==i||i>a.y)&&(i=a.y),(null==r||r<a.y)&&(r=a.y)}this.setBoundingBox({minX:o,maxX:n,minY:i,maxY:r},t)},h.prototype.getFloorData=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t]},h.prototype.getWalls=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].walls},h.prototype.getPoints=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].points},h.prototype.getSymbol=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].symbols[t]},h.prototype.addWall=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].walls[t.vectorId]=t},h.prototype.addPoint=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].points[t.vectorId]=t},h.prototype.addSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].symbols[t.vectorId]=t},h.prototype.addComponent=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].components[t.vectorId]=t},h.prototype.deleteSymbol=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getSymbol(t,e),delete o.floors[e].symbols[t]},h.prototype.getComponent=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].components[t]},h.prototype.deleteComponent=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getComponent(t,e),delete o.floors[e].components[t]},h.prototype.addTag=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].tags[t.vectorId]=t},h.prototype.getTag=function(t,e){return null!=e&&void 0!==e||(e=this.currentFloor),o.floors[e].tags[t]},h.prototype.deleteTag=function(t,e){null!=e&&void 0!==e||(e=this.currentFloor),this.getTag(t,e),delete o.floors[e].tags[t]},h.prototype.getSymbols=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].symbols},h.prototype.getComponents=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].components},h.prototype.getTags=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].tags},h.prototype.getAllBoundingBox=function(){for(var t=[],e=0;e<o.floors.length;++e){var n=void 0,i=void 0,r=void 0,s=void 0,a={};for(var l in o.floors[e].points){var h=o.floors[e].points[l].x,c=o.floors[e].points[l].y;(void 0===n||n>h)&&(n=h),(void 0===r||r<h)&&(r=h),(void 0===i||i>c)&&(i=c),(void 0===s||s<c)&&(s=c)}a.left=n,a.top=s,a.right=r,a.bottom=i,t.push(a)}return t},h.prototype.getCadInfo=function(t){for(var e=[],o=this.getAllBoundingBox(),n=0;n<o.length;++n){var i={},r=s.getScreenXY({x:o[n].left,y:o[n].top}),a=s.getScreenXY({x:o[n].right,y:o[n].bottom}),l=r.x,h=r.y,c=t.width-a.x,p=t.height-a.y;i.left=l,i.top=h,i.right=c,i.bottom=p,i.bound=o[n],i.bound.top=-1*i.bound.top,i.bound.bottom=-1*i.bound.bottom,e.push(i)}return e},h.prototype.getRooms=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),o.floors[t].rooms},h.prototype.clear=function(){o.floors[this.currentFloor].points={},o.floors[this.currentFloor].walls={},o.floors[this.currentFloor].symbols={},o.floors[this.currentFloor].components={},o.floors[this.currentFloor].tags={},o.floors[this.currentFloor].boundingBox={},o.floors[this.currentFloor].rooms=[]};var c=new h,p=function(){};p.prototype.getFixed=function(t,e){return e||(e=5),parseFloat(t.toFixed(e))},p.prototype.getDistance=function(t,e){var o=t.x,n=t.y,i=e.x,r=e.y,s=Math.sqrt(Math.pow(o-i,2)+Math.pow(n-r,2));return this.getFixed(s)},p.prototype.createLine1=function(t,e){if(t.x==e.x&&t.y==e.y)return null;if(0==this.getFixed(Math.abs(t.x-e.x)))return{x:t.x};if(0==this.getFixed(Math.abs(t.y-e.y)))return{y:t.y};var o=(t.y-e.y)/(t.x-e.x),n=(t.x*e.y-e.x*t.y)/(t.x-e.x);return 0==this.getFixed(o)?{y:this.getFixed(n)}:{a:this.getFixed(o),b:this.getFixed(n)}},p.prototype.createLine2=function(t,e){if(e==Math.PI/2||e==1.5*Math.PI)return{x:t.x};var o=Math.tan(e),n=t.y-o*t.x;return 0!=o?{a:o,b:n}:{y:t.y}},p.prototype.createLine3=function(t,e){var o={};return void 0===t.a?void 0!==t.x?o.x=e.x:void 0!==t.y&&(o.y=e.y):(o.a=t.a,o.b=e.y-e.x*t.a),o},p.prototype.create2AngleLine=function(t,e,o){return{line1:this.createLine2(t,e-o/2),line2:this.createLine2(t,e+o/2)}},p.prototype.distanceForPoints=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},p.prototype.getParallelLineForDistance=function(t,e){var o={};o.a=t.a,o.b=t.b;var n={};if(n.a=t.a,n.b=t.b,void 0===t.a){if(t.hasOwnProperty("x")){var i=t.x;o.x=i+e,n.x=i-e}else if(t.hasOwnProperty("y")){var r=t.y;o.y=r+e,n.y=r-e}}else{var s=Math.atan(t.a),a=Math.abs(e/Math.cos(s)),l=t.b;o.b=l+a,n.b=l-a}return{line1:o,line2:n}},p.prototype.getEndpoint=function(t,e,o){var n=this.create2AngleLine(t,e,o),i=this.createLine2(t,e);i=this.getLineForPoint(i,t);var r=this.getParallelLineForDistance(i,15),s=this.getIntersectionPoint(n.line1,r.line1),a=this.getIntersectionPoint(n.line1,r.line2),l=this.getIntersectionPoint(n.line2,r.line1),h=this.getIntersectionPoint(n.line2,r.line2),c=this.Angle(t,s,{x:t.x+1,y:t.y}),p=this.Angle(t,a,{x:t.x+1,y:t.y}),u=this.Angle(t,l,{x:t.x+1,y:t.y}),y=this.Angle(t,h,{x:t.x+1,y:t.y});return e>Math.PI&&(e=2*Math.PI-e),Math.abs((c+u)/2-e)<Math.abs((p+y)/2-e)?{p1:s,p2:l}:{p1:a,p2:h}},p.prototype.isClockwise=function(t){for(var e=0,o=0;o<t.length;o++){var n=(o+1)%t.length;e+=t[o].x*t[n].y,e-=t[n].x*t[o].y}return e/2>0},p.prototype.reverse=function(t){for(var e=[],o=t.length-1;o>-1;--o)e.push(t[o]);return e},p.prototype.getIntersectionPoint=function(t,e){if(this.isParallel(t,e))return null;if(void 0===t.a&&void 0!==e.a){if(t.x)return{x:t.x,y:e.a*t.x+e.b};if(t.y)return{x:(t.y-e.b)/e.a,y:t.y}}else if(void 0===e.a&&void 0!==t.a){if(e.x)return{x:e.x,y:t.a*e.x+t.b};if(e.y)return{x:(e.y-t.b)/t.a,y:e.y}}else if(void 0===e.a&&void 0===t.a)return t.hasOwnProperty("x")&&e.hasOwnProperty("y")?{x:t.x,y:e.y}:t.hasOwnProperty("y")&&e.hasOwnProperty("x")?{x:e.x,y:t.y}:null;return t.a==e.a?null:{x:(e.b-t.b)/(t.a-e.a),y:(t.a*e.b-e.a*t.b)/(t.a-e.a)}},p.prototype.getIntersectionPoint2=function(t,e,o,n){var i=(e.y-t.y)*(n.x-o.x)-(t.x-e.x)*(o.y-n.y);return 0==i?null:{x:((e.x-t.x)*(n.x-o.x)*(o.y-t.y)+(e.y-t.y)*(n.x-o.x)*t.x-(n.y-o.y)*(e.x-t.x)*o.x)/i,y:-((e.y-t.y)*(n.y-o.y)*(o.x-t.x)+(e.x-t.x)*(n.y-o.y)*t.y-(n.x-o.x)*(e.y-t.y)*o.y)/i}},p.prototype.getIntersectionPoint3=function(t,e,o,n){var i=this.getIntersectionPoint2(t,e,o,n);if(i){var r=i.x,s=i.y;return(r-t.x)*(r-e.x)<=.001&&(s-t.y)*(s-e.y)<=.001&&(r-o.x)*(r-n.x)<=.001&&(s-o.y)*(s-n.y)<=.001?{x:r,y:s}:null}return null},p.prototype.getIntersectionPoint4=function(t,e,o){var n=this.createLine1(t,e),i=this.getIntersectionPoint(n,o);return null==i?null:this.PointInSegment(i,t,e)?i:null},p.prototype.isParallel=function(t,e){return void 0===t.a&&void 0===e.a?!(!t.hasOwnProperty("x")||!e.hasOwnProperty("x"))||!(!t.hasOwnProperty("y")||!e.hasOwnProperty("y")):void 0!==t.a&&void 0!==e.a&&this.getFixed(t.a)==this.getFixed(e.a)},p.prototype.Angle=function(t,e,o){var n,i,r=0,s=e.x-t.x,a=e.y-t.y,l=o.x-t.x,h=o.y-t.y;return r=s*l+a*h,i=(s*s+a*a)*(l*l+h*h),(r/=Math.sqrt(i))>=1?0:r<=-1?Math.PI:180*(n=Math.acos(r))/Math.PI<180?n:2*Math.PI-n},p.prototype.getLineForPoint=function(t,e){var o={};return 0==t.a||void 0===t.a?t.hasOwnProperty("x")?o.y=e.y:t.hasOwnProperty("y")&&(o.x=e.x):(o.a=-1/t.a,o.b=e.y-e.x*o.a),o},p.prototype.getJoinLinePoint=function(t,e){var o=this.getVerticalLine(e,t);return this.getIntersectionPoint(e,o)},p.prototype.getDisForPoinLine=function(t,e){var o=this.getJoinLinePoint(t,e);return this.getDistance(t,o)},p.prototype.getVerticalLine=function(t,e){if(void 0===t.a)return t.hasOwnProperty("x")?{y:e.y}:t.hasOwnProperty("y")?{x:e.x}:null;if(0==t.a)return{x:e.x};var o={};return o.a=-1/t.a,this.createLine3(o,e)},p.prototype.isContainForSegment=function(t,e,o,n){n||(n=a);var i=this.getDistance(e,t)+this.getDistance(o,t),r=this.getDistance(e,o);return Math.abs(i-r)<n},p.prototype.isPointInPoly=function(t,e){for(var o=t.x,n=t.y,i=!1,r=0,s=e.length-1;r<e.length;s=r++){var a=e[r],l=e[s],h=a.x,c=a.y,p=l.x,u=l.y;c>n!=u>n&&o<(p-h)*(n-c)/(u-c)+h&&(i=!i)}return i},p.prototype.getDisForPoinSegment=function(t,e,o,n){var i=this.createLine1(e,o),r=this.getJoinLinePoint(t,i),s=this.getDistance(e,o),a=this.getDistance(r,e),l=this.getDistance(r,o);return this.getDistance(r,e)>s||this.getDistance(r,o)>s?a<l&&a<n?{type:1,join:e}:l<a&&l<n?{type:2,join:o}:null:a<n?{type:1,join:e}:l<n?{type:2,join:o}:this.getDistance(t,r)<n?{type:0,join:r}:void 0},p.prototype.PointInSegment=function(t,e,o,n){if(this.getDistance(t,e)<a||this.getDistance(t,o)<a)return!0;n||(n=.1),n/=2;var i=(t.x-e.x)*(o.y-e.y)-(o.x-e.x)*(t.y-e.y),r=Math.min(e.x,o.x)-t.x,s=t.x-Math.max(e.x,o.x),l=Math.min(e.y,o.y)-t.y,h=t.y-Math.max(e.y,o.y);return Math.abs(i)<n&&(r<=0||Math.abs(r)<n)&&(s<=0||Math.abs(s)<n)&&(l<=0||Math.abs(l)<n)&&(h<=0||Math.abs(h)<n)},p.prototype.clonePoint=function(t,e){t.x=e.x,t.y=e.y},p.prototype.equalPoint=function(t,e){return t.x==e.x&&t.y==e.y},p.prototype.crossTwoLines=function(t,e,o,n,i){void 0===i&&(i=a);var r=this.getIntersectionPoint2(t,e,o,n);if(null!=r){if(this.getDistance(t,r)>i&&this.getDistance(e,r)>i&&this.getDistance(o,r)>i&&this.getDistance(n,r)>i)return this.getDistance(t,r)<this.getDistance(t,e)&&this.getDistance(e,r)<this.getDistance(t,e)&&this.getDistance(o,r)<this.getDistance(o,n)&&this.getDistance(n,r)<this.getDistance(o,n)}else if(this.PointInSegment(t,o,n)||this.PointInSegment(e,o,n))return!0;return!1},p.prototype.getDisPointsLine=function(t,e,o,n){var i={},r={},s={};if(t.hasOwnProperty("x"))i.x=t.x,i.y=e.y-o,r.x=t.x,r.y=e.y+n;else if(t.hasOwnProperty("y"))i.y=t.y,i.x=e.x-o,r.y=t.y,r.x=e.x+n;else{var a=Math.atan(t.a),l={a:-1/t.a},h=this.createLine3(l,e),c=this.getIntersectionPoint(t,h);i.x=c.x-o*Math.cos(a),i.y=c.y-o*Math.sin(a),r.x=c.x+n*Math.cos(a),r.y=c.y+n*Math.sin(a)}return s.newpoint1=i,s.newpoint2=r,s},p.prototype.getBoundingBox=function(t){for(var e=t[0].x,o=t[0].x,n=t[0].y,i=t[0].y,r=1;r<t.length;++r){var s=t[r];e>s.x&&(e=s.x),n>s.y&&(n=s.y),o<s.x&&(o=s.x),i<s.y&&(i=s.y)}var a={};return a.minX=e,a.minY=n,a.maxX=o,a.maxY=i,a},p.prototype.ComputePolygonArea=function(t){var e=t.length;if(e<3)return 0;for(var o=t[0].y*(t[e-1].x-t[1].x),n=1;n<e;++n)o+=t[n].y*(t[n-1].x-t[(n+1)%e].x);return Math.abs(o/2)},p.prototype.getPolygonCore=function(t){function e(t,e,o){return(t.x*e.y+e.x*o.y+o.x*t.y-e.x*t.y-o.x*e.y-t.x*o.y)/2}for(var o=0,n=0,i=0,r=t[1],s=2;s<t.length;s++){var a=t[s],l=e(t[0],r,a);i+=l,o+=(t[0].x+r.x+a.x)*l,n+=(t[0].y+r.y+a.y)*l,r=a}return{x:o/i/3,y:n/i/3}},p.prototype.isPolyInPoly=function(t,e,o){for(var n=0;n<t.length;++n){for(var i=!1,r=0;r<e.length;++r)if(this.equalPoint(t[n],e[r])){i=!0;break}if(i){var s=n==t.length-1?0:n+1,a={x:(t[n].x+t[s].x)/2,y:(t[n].y+t[s].y)/2};if(!this.isPointInPoly(a,e,o))return!1}else if(!this.isPointInPoly(t[n],e,o))return!1}return!0},p.prototype.dotPoints=function(t,e,o,n){var i={},r={};return i.start={},i.end={},i.start.x=0,i.start.y=0,i.end.x=e.x-t.x,i.end.y=e.y-t.y,r.start={},r.end={},r.start.x=0,r.start.y=0,r.end.x=n.x-o.x,r.end.y=n.y-o.y,i.end.x*r.end.x+i.end.y*r.end.y};var u=new p,y=function(){this.pad={top:60,bottom:60,left:265,right:265},this.region={},this.measureLines={top:[],bottom:[],left:[],right:[]},this.minDis=null,this.unit="m",this.defalutMeasurePad={bottom:60,right:265}};y.prototype.padding=function(t){void 0===t&&(t={}),Object.assign(this.pad,t),Object.assign(this.defalutMeasurePad,t)},y.prototype.updatePad=function(t){Object.assign(this.pad,t)},y.prototype.updateRegion=function(t){this.region.top=this.pad.top,this.region.bottom=s.height-this.pad.bottom,this.region.left=this.pad.left,this.region.right=s.width-this.pad.right},y.prototype.update=function(){null==this.minDis&&(this.minDis=100/s.res);var t=[],e=[],o=[],n=[],i=[],r=c.getPoints();for(var a in r){var l=r[a];i.push({x:l.x,y:l.y})}function h(t,e){return e.y-t.y}function p(t,e){return t.x-e.x}t=[].concat(i).sort(h.bind(this)),(e=[].concat(t)).reverse(),o=[].concat(i).sort(p.bind(this)),(n=[].concat(o)).reverse();var u=null,y=null;this.measureLines.top=[];for(var g=0;g<t.length;++g)if(0==g)u=t[0].x,y=t[0].x,this.measureLines.top.push({x:t[0].x,y:this.region.top});else{if(t[g].x>=u&&t[g].x<=y)continue;(u=Math.min(u,t[g].x))!=(y=Math.max(y,t[g].x))&&this.measureLines.top.push({x:t[g].x,y:this.region.top})}t=this.measureLines.top.sort(p.bind(this)),this.measureLines.top=[],this.measureLines.top.push(t[0]);for(var d=0;d<t.length-1;++d){u=t[d],y=null;for(var f=d+1;f<t.length&&(y=t[f],Math.abs(u.x-y.x)<this.minDis);++f)y=null,++d;if(null!=y)this.measureLines.top.push(y);else if(d==t.length-1){var x=this.measureLines.top.length;this.measureLines.top[x-1]=t[d];break}}this.measureLines.bottom=[];for(var m=0;m<e.length;++m)if(0==m)u=e[0].x,y=e[0].x,this.measureLines.bottom.push({x:e[0].x,y:this.region.bottom});else{if(e[m].x>=u&&e[m].x<=y)continue;(u=Math.min(u,e[m].x))!=(y=Math.max(y,e[m].x))&&this.measureLines.bottom.push({x:e[m].x,y:this.region.bottom})}e=this.measureLines.bottom.sort(p.bind(this)),this.measureLines.bottom=[],this.measureLines.bottom.push(e[0]);for(var v=0;v<e.length-1;++v){u=e[v],y=null;for(var P=v+1;P<e.length&&(y=e[P],Math.abs(u.x-y.x)<this.minDis);++P)y=null,++v;if(null!=y)this.measureLines.bottom.push(y);else if(v==e.length-1){var S=this.measureLines.bottom.length;this.measureLines.bottom[S-1]=e[v];break}}this.measureLines.left=[];for(var b=0;b<o.length;++b)if(0==b)u=o[0].y,y=o[0].y,this.measureLines.left.push({x:this.region.left,y:o[0].y});else{if(o[b].y>=u&&o[b].y<=y)continue;(u=Math.min(u,o[b].y))!=(y=Math.max(y,o[b].y))&&this.measureLines.left.push({x:this.region.left,y:o[b].y})}o=this.measureLines.left.sort(h.bind(this)),this.measureLines.left=[],this.measureLines.left.push(o[0]);for(var I=0;I<o.length-1;++I){u=o[I],y=null;for(var M=I+1;M<o.length&&(y=o[M],Math.abs(u.y-y.y)<this.minDis);++M)y=null,++I;if(null!=y)this.measureLines.left.push(y);else if(I==o.length-1){var T=this.measureLines.left.length;this.measureLines.left[T-1]=o[I];break}}this.measureLines.right=[];for(var w=0;w<n.length;++w)if(0==w)u=n[0].y,y=n[0].y,this.measureLines.right.push({x:this.region.right,y:n[0].y});else{if(n[w].y>=u&&n[w].y<=y)continue;(u=Math.min(u,n[w].y))!=(y=Math.max(y,n[w].y))&&this.measureLines.right.push({x:this.region.right,y:n[w].y})}n=this.measureLines.right.sort(h.bind(this)),this.measureLines.right=[],this.measureLines.right.push(n[0]);for(var B=0;B<n.length-1;++B){u=n[B],y=null;for(var k=B+1;k<n.length&&(y=n[k],Math.abs(u.y-y.y)<this.minDis);++k)y=null,++B;if(null!=y)this.measureLines.right.push(y);else if(B==n.length-1){var E=this.measureLines.right.length;this.measureLines.right[E-1]=n[B];break}}};var g=new y,d=function(t,e,o){this.name=o||"未命名",this.floor=e,this.roomId=t,this.center=null,this.area=null,this.wallIds=[],this.wallPointIDs=[],this.childrenRooms=[],this.childrenWalls=[],this.parent=null,this.tagName=null,this.backgroundImg_src="default",this.boundingBox={}};d.prototype.setInfo=function(t){this.wallIds=t.wallIds,this.wallPointIDs=t.wallPointIDs,this.area=t.area,this.center=t.center,this.boundingBox=t.boundingBox,this.parent=t.parent,this.childrenWalls=t.childrenWalls,this.childrenRooms=t.childrenRooms},d.prototype.containPoint=function(t){for(var e=[],o=0;o<this.wallPointIDs.length;++o){var n=c.getPoint(this.wallPointIDs[o],this.floor);e.push({x:n.x,y:n.y})}return u.isPointInPoly(t,e)};var f=function(t,e,o){this.pointIds=e,this.segmentIds=t,this.childrenPolygonIds=[],this.childrenSegmentIds=[],this.id=o,this.parent=null,this.center=null,this.boundingBox=null,this.area=0,this.floor=1,this.geoType="Polygon"},x=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[],this.pre="",this.currentId=1};x.prototype.init=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[]},x.prototype.start=function(t,e,o){this.pre=o||"",this.init(),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.createPolygon(null,this.segments,this.points),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.getIncludePolygonInfos(),this.updateChildrenSegmentIds(this.segments,this.points,this.polygons)},x.prototype.getStartPoint=function(t,e){var o=null,n=null;for(var i in t)if(i!==e){var r=t[i];(null===o||o.x>r.x||o.x===r.x&&o.y>r.y)&&(o={x:r.x,y:r.y},n=i)}return n},x.prototype.createPolygon=function(t,e,o){if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.matrix={};var n=[];this.preHandle(o,e);var i=Object.keys(e).length;if(0!==Object.keys(o).length&&0!==Object.keys(e).length){null!==t&&o[t]||(t=this.getStartPoint(o)),n.push(t);var r=this.getNextForMinAngleX(t,o,e);if(null!==r){n.push(r);var s=this.getMaxPolygon(n,o,e);this.checkPolygonSegmentIds(s,o,e);var a=this.splitPolygon(s);if(a){var l=this.getPolygonData(a,o,e),h=Object.keys(l.points),c=Object.keys(l.segments);if(l.segments=this.getChildSegments(l.points,l.segments,e),this.createPolygon(a[0],l.segments,l.points),this.updateMartix2(h,c,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.maxPolygons.push(s),this.updateMartix(s,o,e),o[t]||(t=this.getStartPoint(o),r=this.getNextForMinAngleX(t,o,e));var p=[];p.push(t),p.push(r);var u=this.getMinPolygon(p,o,e);if(this.checkPolygonSegmentIds(u,o,e),a=this.splitPolygon(u)){var y=this.getPolygonData(a,o,e),g=Object.keys(y.points),d=Object.keys(y.segments);if(this.createPolygon(a[0],y.segments,y.points),this.updateMartix2(g,d,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==s.length&&0!==u.length){if(this.addPolygon(u,o,e)){var f=u.slice(0);if(f.push(u[0]),this.updateMartix(f,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}if(i===Object.keys(e).length){this.addPolygon(s,o,e);var x=s.slice(0);if(x.push(s[0]),this.updateMartix(x,o,e),this.updateMartix(x,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}var m=this.getStartPoint(o,t);this.createPolygon(m,e,o)}else console.error("createPolygon——————————————————————————————————————————————————————————————出错！")}}}}},x.prototype.splitPolygon=function(t){for(var e=[],o=0;o<t.length-1;++o){if(-1!==e.indexOf(t[o])){var n=t.slice(0,o+1),i=t.indexOf(t[o]);return n=n.splice(i)}e.push(t[o])}return null},x.prototype.getPolygonData=function(t,e,o){for(var n={},i={},r=[],s=0;s<t.length;++s)n[t[s]]=e[t[s]],r.push(e[t[s]]);for(var a=this.checkPolygonSegmentIds(t,e,o),l=0;l<a.length;++l)i[a[l]]=o[a[l]];var h=[],c=[];for(var p in e)if(!(t.indexOf(p)>-1||h.indexOf(p)>-1)){var y=e[p];if(u.isPointInPoly(y,r)){h.push(p);var g=y.parent;for(var d in g)if(o[d]&&!i[d]&&-1===c.indexOf(d)){var f=null;o[d].start===p?f=o[d].end:o[d].end===p&&(f=o[d].start);var x=e[f];t.indexOf(f)>-1||h.indexOf(f)>-1?c.push(d):u.isPointInPoly(x,r)&&(c.push(d),h.push(f))}}}for(var m=0;m<h.length;++m)n[h[m]]||(n[h[m]]=e[h[m]]);for(var v=0;v<c.length;++v)i[c[v]]||(i[c[v]]=o[c[v]]);return{points:n,segments:i}},x.prototype.getChildSegments=function(t,e,o){var n=[];for(var i in t)n.push(i);for(var r=0;r<n.length-1;++r)for(var s=r+1;s<n.length;++s){var a=this.getSegmentId2(t[n[r]],t[n[s]]);null==a||e[a]||(e[a]=o[a])}return e},x.prototype.updateMartix2=function(t,e,o,n){for(var i=0;i<e.length;++i){var r=e[i];delete this.matrix[r],delete n[r],this.deleteSegment(r,n,o)}for(var s=0;s<t.length;++s){var a=t[s],l=o[a];l&&0!==Object.keys(l.parent).length||delete o[a]}},x.prototype.addPolygon=function(t,e,o){var n=[],i=[];n[0]=this.getPoint(t[0],e);for(var r=0;r<t.length-1;++r){var s=t[r],a=t[r+1],l=this.getSegmentId(s,a,e,o);i.push(l);var h=this.getPoint(a,e);n.push(h)}var c=this.getId();t.pop();var p=new f(i,t,c);return p.area=this.getArea(p),p.center=this.getCenter(p),p.boundingBox=u.getBoundingBox(n),this.polygons.push(p),!0},x.prototype.getMaxPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],r=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===r.min?(t.push(r.min),t):(t.push(r.min),this.getMaxPolygon(t,e,o))},x.prototype.getMinPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],r=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===r.max?(t.push(r.max),t):(t.push(r.max),this.getMinPolygon(t,e,o))},x.prototype.getNextForMinAngleX=function(t,e,o){for(var n=e[t],i=this.getAllLinkedPoint(t,e,o),r=null,s=null,a=0;a<i.length;++a){var l=e[i[a]];if(l){var h=u.Angle(n,{x:n.x+1,y:n.y},l);l.y-n.y<0&&(h*=-1),(null===r||r>h)&&(r=h,s=i[a])}}return s},x.prototype.getNextForMaxMinAngle=function(t,e,o,n){var i=o[t],r=o[e];i&&r||console.error("getNextForMaxMinAngle******************************************");for(var s=r.x-i.x,a=r.y-i.y,l={x:r.x+s,y:r.y+a},h=this.getAllLinkedPoint(e,o,n),c=null,p=null,y=null,g=null,d=0;d<h.length;++d)if(h[d]!==t){var f=o[h[d]];if(f){var x=u.Angle(r,l,f);s*(f.y-r.y)-(f.x-r.x)*a<0&&(x*=-1),(null===c||c<x)&&(c=x,p=h[d]),(null===y||y>x)&&(y=x,g=h[d])}}return{max:p,min:g}},x.prototype.updateMartix=function(t,e,o){for(var n=0;n<t.length-1;++n){var i=n===t.length-1?0:n+1,r=this.getSegmentId(t[n],t[i],e,o);this.matrix[r]?(delete this.matrix[r],this.deleteSegment(r,o,e)):this.matrix[r]=1}},x.prototype.getSegmentId=function(t,e,o,n){var i=o[t];if(!i)return null;var r=i.parent;for(var s in r){var a=n[s];if(a&&(a.start===e||a.end===e))return s}return null},x.prototype.getSegmentId2=function(t,e){var o=t.parent,n=e.parent;for(var i in o)if(n[i])return i;return null},x.prototype.getAllLinkedPoint=function(t,e,o){var n=[],i=e[t];i||console.error("getAllLinkedPoint");var r=i.parent;for(var s in r){var a=o[s];a&&(a.start===t?n.push(a.end):a.end===t&&n.push(a.start))}return n},x.prototype.deleteLinksSegment=function(t,e,o){var n=e[t];if(n&&0!==Object.keys(n.parent).length&&o[Object.keys(n.parent)[0]]){var i=this.getOtherPointId(Object.keys(n.parent)[0],t,o);this.deleteSegment(Object.keys(n.parent)[0],o,e);var r=e[i];r&&Object.keys(r.parent).length<2&&this.deleteLinksSegment(i,e,o)}},x.prototype.deleteSegment=function(t,e,o){if(t&&e[t]){var n=e[t];this.deletePoint(n.start,t,o),this.deletePoint(n.end,t,o),delete e[t]}},x.prototype.deletePoint=function(t,e,o){if(t&&o[t]){var n=this.getPoint(t,o);delete n.parent[e],0===Object.keys(n.parent).length&&delete o[t]}},x.prototype.getOtherPointId=function(t,e,o){var n=o[t];return n||console.error("getOtherPointId**********************************************************************"),n.start===e?n.end:n.end===e?n.start:void console.error("getOtherPointId**********************************************************************")},x.prototype.preHandle=function(t,e){var o=!1;for(var n in t){var i=t[n];if(Object.keys(i.parent).length<2)this.deleteLinksSegment(n,t,e),o=!0;else{var r=0;for(var s in i.parent)e[s]&&++r;if(r>1)continue;delete t[n]}}return o},x.prototype.getPoint=function(t,e){return e[t]},x.prototype.isClockwise=function(t,e){for(var o=[],n=0;n<t.length;++n){var i=e[t[n]];o.push({x:i.x,y:i.y})}return u.isClockwise(o)},x.prototype.getId=function(){var t=this.currentId;return++this.currentId,"Polygon"+t},x.prototype.getArea=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return u.ComputePolygonArea(e)},x.prototype.getCenter=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return u.getPolygonCore(e)},x.prototype.getIncludePolygonInfos=function(){this.polygons=this.polygons.sort((function(t,e){return t.area-e.area}));for(var t=0;t<this.polygons.length-1;++t){for(var e=null,o=t+1;o<this.polygons.length;++o)if(o!==t&&this.isContain(this.polygons[t],this.polygons[o])){e=this.polygons[o];break}null!=e&&(this.polygons[t].parent=e.id,e.childrenPolygonIds.push(this.polygons[t].id),e=null)}},x.prototype.updateChildrenSegmentIds=function(t,e,o){for(var n=[],i=0;i<o.length;++i){var r=o[i];n=n.concat(r.segmentIds)}for(var s in t)if(!(n.indexOf(s)>-1))for(var a=t[s],l=e[a.start],h=e[a.end],c=0;c<o.length;++c){var p=!1,u=!1,y=o[c];(y.pointIds.indexOf(a.start)>-1||this.containPoint(y,l))&&(p=!0),(y.pointIds.indexOf(a.end)>-1||this.containPoint(y,h))&&(u=!0),p&&u&&y.childrenSegmentIds.push(s)}},x.prototype.isContain=function(t,e){for(var o=[],n=[],i=0;i<t.pointIds.length;++i){var r=this.points[t.pointIds[i]];o.push(r)}for(var s=0;s<e.pointIds.length;++s){var a=this.points[e.pointIds[s]];n.push(a)}return u.isPolyInPoly(o,n,.01)},x.prototype.containPoint=function(t,e){for(var o=[],n=0;n<t.pointIds.length;++n){var i=this.points[t.pointIds[n]];o.push(i)}return u.isPointInPoly(e,o)},x.prototype.checkPolygonSegmentIds=function(t,e,o){for(var n=[],i=0;i<t.length;++i){var r=i===t.length-1?0:i+1;if(t[i]!==t[r]){if(!t[i]||!t[r])return;var s=this.getSegmentId(t[i],t[r],e,o);if(!s)return;n.push(s)}}return n},x.prototype.setCaves=function(){for(var t=0;t<this.polygons.length;++t){var e=this.polygons[t],o=e.childrenPolygonIds.slice(0);this.getChildMaxPolygons(e,o)}},x.prototype.getChildPolygonInfo=function(t){if(t.length<2)return null;for(var e=[],o=[],n=0;n<this.polygons.length;++n){var i=this.polygons[n];t.indexOf(i.id)>-1&&(e=e.concat(i.pointIds),o=o.concat(i.segmentIds))}for(var r={},s={},a=0;a<e.length;++a)r[e[a]]=this.points[e[a]];for(var l=0;l<o.length;++l)s[o[l]]=this.segments[o[l]];return{points:r,segments:s}},x.prototype.getChildMaxPolygons=function(t,e){var o=this.getChildPolygonInfo(e);if(null!=o){var n=this.getStartPoint(o.points),i=[];i.push(n);var r=this.getNextForMinAngleX(n,o.points,o.segments);i.push(r);var s=this.getMaxPolygon(i,o.points,o.segments);s.pop(),t.caves.push(s);for(var a=0;a<e.length;++a)for(var l=this.getPolygon(e[a]),h=0;h<l.pointIds.length;++h)if(s.indexOf(l.pointIds[h])>-1){e.splice(a,1),--a;break}this.getChildMaxPolygons(t,e)}else if(1===e.length){var c=this.getPolygon(e[0]);t.caves.push(c.pointIds)}},x.prototype.getPolygon=function(t){for(var e=0;e<this.polygons.length;++e){var o=this.polygons[e];if(o.id===t)return o}return console.error("找不到多边形！"),null};var m=new x,v="Tag",P="LEFT",S="RIGHT",b=function(){this.len=null};b.prototype.setId=function(t){null==t||void 0===t?(t=c.getCurrentId(),c.updateCurrentId(),this.vectorId=this.geoType+t):this.vectorId=t},b.prototype.setSymbolPosition=function(t,e){"start"==e?u.clonePoint(this.startPoint,t):"end"==e&&u.clonePoint(this.endPoint,t)},b.prototype.setSymbolParent=function(t){this.parent=t},b.prototype.setPointParent=function(t,e){null==this.parent&&(this.parent={}),this.parent[t]=e},b.prototype.setOpenSide=function(t){var e=[];e.push(this.startPoint),e.push(this.endPoint),e.push(t);var o=null;o=u.isClockwise(e)?P:S,this.openSide=o},b.prototype.rotatePoint=function(t,e,o){var n=e.x,i=e.y,r=t.x,s=t.y;return{x:n+(r-n)*Math.cos(o*Math.PI/180)-(s-i)*Math.sin(o*Math.PI/180),y:i+(r-n)*Math.sin(o*Math.PI/180)+(s-i)*Math.cos(o*Math.PI/180)}};var I=function(t){function e(e,o){t.call(this),this.center=e,this.points2d=[],this.title=KanKan.Config.i18n("cad.input"),this.des="",this.unit="m",this.name="标注",this.adding=!0,this.sideWidth=30,this.sideThickness=30,this.geoType=v,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),u.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/s.res*l/s.zoom/2,e=this.center.y-this.sideThickness/s.res*l/s.zoom/2,o=this.center.x+this.sideWidth/s.res*l/s.zoom/2,n=this.center.y+this.sideThickness/s.res*l/s.zoom/2,i={x:t,y:n},r={x:o,y:n},a={x:o,y:e},h={x:t,y:e};this.points2d.push(i),this.points2d.push(r),this.points2d.push(a),this.points2d.push(h);var c=(i.x-this.center.x)/2,p=(i.y-this.center.y)/2;this.points2d.push({x:i.x-c,y:i.y-p}),this.points2d.push({x:r.x+c,y:i.y-p}),this.points2d.push({x:this.center.x,y:i.y-p}),this.points2d.push({x:this.center.x,y:a.y+p})},e.prototype.setTitle=function(t){this.title=t},e.prototype.setDes=function(t){this.des=t},e.prototype.setUnit=function(t){this.unit=t},e.prototype.setAdding=function(t){this.adding=t},e}(b),M=function(){this.room_hallImg=null,this.room_defaultImg=null,this.room_otherImg=null};M.prototype.addRoom=function(t,e){o.floors[e].rooms.push(t)},M.prototype.getRoom=function(t,e){return o.floors[e].rooms[t]},M.prototype.getRooms=function(t){return o.floors[t].rooms},M.prototype.clearRooms=function(t){o.floors[t].rooms=[]},M.prototype.setHallImg=function(t){this.room_hallImg=t},M.prototype.getHallImg=function(){return this.room_hallImg},M.prototype.setDefaultImg=function(t){this.room_defaultImg=t},M.prototype.getDefaultImg=function(){return this.room_defaultImg},M.prototype.setOtherImg=function(t){this.room_otherImg=t},M.prototype.getOtherImg=function(){return this.room_otherImg};var T=new M,w=["","⅛","¼","⅜","½","⅝","¾","⅞"],B=function(t,e,o,n){this.name=t,this.symbol=e,this.base=o,this.factor=n};B.prototype.toBase=function(t){return t*this.factor},B.prototype.fromBase=function(t){return t/this.factor};var k={MILLIMETER:["Millimeter","mm"],CENTIMETER:["Centimeter","cm"],METER:["Meter","m"],KILOMETER:["Kilometer","km"],INCH:["Inch","in"],FOOT:["Foot","ft"],MILE:["Mile","mi"],SQUAREMETER:["SquareMeter","m²"],SQUAREFOOT:["SquareFoot","ft²"],CUBICMETER:["CubicMeter","m³"],CUBICFOOT:["CubicFoot","ft³"],BYTE:["Byte","B"],KILOBYTE:["Kilobyte","kB"],MEGABYTE:["Megabyte","MB"],GIGABYTE:["Gigabyte","GB"],TERABYTE:["Terabyte","TB"],PETABYTE:["Petabyte","PB"],init:function(){var t,e,o,n,i,r,s,a,l,h,c,p=new B(k.METER[0],k.METER[1],void 0,1),u=new B(k.SQUAREMETER[0],k.SQUAREMETER[1],void 0,1),y=new B(k.CUBICMETER[0],k.CUBICMETER[1],void 0,1),g=new B(k.BYTE[0],k.BYTE[1],void 0,1);k.DISTANCE=((t={}).metric=((e={})[k.MILLIMETER[0]]=new B(k.MILLIMETER[0],k.MILLIMETER[1],p,.001),e[k.CENTIMETER[0]]=new B(k.CENTIMETER[0],k.CENTIMETER[1],p,.01),e[k.METER[0]]=p,e[k.KILOMETER[0]]=new B(k.KILOMETER[0],k.KILOMETER[1],p,1e3),e),t.imperial=((o={})[k.INCH[0]]=new B(k.INCH[0],k.INCH[1],p,.0254),o[k.FOOT[0]]=new B(k.FOOT[0],k.FOOT[1],p,.3048),o[k.MILE[0]]=new B(k.MILE[0],k.MILE[1],p,1609.344),o),t),k.AREA=((n={}).metric=((i={})[k.SQUAREMETER[0]]=u,i),n.imperial=((r={})[k.SQUAREFOOT[0]]=new B(k.SQUAREFOOT[0],k.SQUAREFOOT[1],u,.092903),r),n),k.VOLUME=((s={}).metric=((a={})[k.CUBICMETER[0]]=y,a),s.imperial=((l={})[k.CUBICFOOT[0]]=new B(k.CUBICFOOT[0],k.CUBICFOOT[1],y,.0283168),l),s);var d=((h={})[k.BYTE[0]]=g,h[k.KILOBYTE[0]]=new B(k.KILOBYTE[0],k.KILOBYTE[1],g,1e3),h[k.MEGABYTE[0]]=new B(k.MEGABYTE[0],k.MEGABYTE[1],g,1e6),h[k.GIGABYTE[0]]=new B(k.GIGABYTE[0],k.GIGABYTE[1],g,1e9),h[k.TERABYTE[0]]=new B(k.TERABYTE[0],k.TERABYTE[1],g,1e12),h[k.PETABYTE[0]]=new B(k.PETABYTE[0],k.PETABYTE[1],g,1e15),h);k.DATA=((c={}).metric=d,c.imperial=d,c)},getUnitsOfMeasurementByDomain:function(t){return this[t.toUpperCase()]},getUnitsOfMeasurementByDomainAndSystem:function(t,e){var o=this.getUnitsOfMeasurementByDomain(t);if(o.hasOwnProperty(e.toLowerCase()))return o[e.toLowerCase()];console.error(n+" measurement system is not supported.")},getDefaultUnitByDomainAndSystem:function(t,e){switch(t.toUpperCase()){case"DISTANCE":switch(e.toLowerCase()){case"metric":return this.DISTANCE.metric[this.METER[0]];case"imperial":return this.DISTANCE.imperial[this.FOOT[0]];default:console.error(e+" measurement system is not supported.")}case"AREA":switch(e.toLowerCase()){case"metric":return this.AREA.metric[this.SQUAREMETER[0]];case"imperial":return this.AREA.imperial[this.SQUAREFOOT[0]];default:console.error(e+" measurement system is not supported.")}case"VOLUME":switch(e.toLowerCase()){case"metric":return this.VOLUME.metric[this.CUBICMETER[0]];case"imperial":return this.VOLUME.imperial[this.CUBICFOOT[0]];default:console.error(e+" measurement system is not supported.")}case"DATA":switch(e.toLowerCase()){case"metric":return this.DATA.metric[this.BYTE[0]];case"imperial":return this.DATA.imperial[this.BYTE[0]];default:console.error(e+" measurement system is not supported.")}default:console.error(t+" measurement domain is not supported.")}}},E=function(){this.LOCAL_STORAGE_KEY="iv_unit_key",k.init(),this.unitSystems=["metric","imperial"],this.defaultSystem="metric"},O=function(){this.UnitService=new E};O.prototype.scopedConvert=function(t,o,n,i,r){return void 0===n&&(n=2),e.convert(t,o,n,i,r)},O.prototype.convert=function(t,e,o,n,i,r){if(void 0===o&&(o=2),void 0===r&&(r=!1),!t)return"";var s=this.getMostRelevantMeasurement(e,n||this.UnitService.currentSystem,t,i);return this.getFormattedMeasurementString(s[0],s[1],o,r)},O.prototype.getFormattedMeasurementString=function(t,e,o,n){return n&&e.name===k.FOOT[0]?this.formatImperialDistance(12*t):n&&e.name===k.INCH[0]?this.formatImperialDistance(t):t.toLocaleString(void 0,{minimumFractionDigits:o,maximumFractionDigits:o})+" "+e.symbol},O.prototype.formatImperialDistance=function(t){var e=Math.round(8*t),o=Math.floor(e/8),n=Math.floor(o/12),i=o-12*n,r=w[e%8],s=0===i&&""!==r?"":i;return""!==s&&""!==r&&(r=" "+r),0!==n?n+"' "+s+r+'"':""+s+r+'"'},O.prototype.getMostRelevantMeasurement=function(t,e,o,n){void 0===n&&(n=0);var i=[],r=k.getUnitsOfMeasurementByDomainAndSystem(t,e);for(var s in r)i.push(r[s]);var a=i.filter((function(t){return t.factor>=n})).reduce((function(t,e){return e.fromBase(o)<t.fromBase(o)&&e.fromBase(o)>=1?e:t}));return a?[a.fromBase(o),a]:void 0},O.prototype.getMostRelevantMeasurement2=function(t,e,o,n){void 0===n&&(n=0);var i=[],r=k.getUnitsOfMeasurementByDomainAndSystem(t,e);for(var s in r)i.push(r[s]);var a=i.filter((function(t){return t.factor>=n})).reduce((function(t,e){return e.toBase(o)<t.toBase(o)&&e.toBase(o)>=1?e:t}));return a?[a.toBase(o),a]:void 0},O.prototype.convertBack=function(t,e,o,n,i){if(void 0===o&&(o=2),!t)return"";t=t.trim().replace(",","");var r=k.getDefaultUnitByDomainAndSystem(e,"metric"),s=this.getMostRelevantMeasurement2(e,n,t,i);return this.getFormattedMeasurementString(s[0],r,o)};var F=new O,C=function(){};C.prototype.createTag=function(t,e,o){var n=new I(t,e);return n.setPoints2d(),c.addTag(n,o),n},C.prototype.setTagInfo=function(t){var e=c.getTag(t.vectorId);e.vectorId=t.vectorId,e.center=JSON.parse(JSON.stringify(t.center)),e.points2d=JSON.parse(JSON.stringify(t.points2d)),e.title=t.title,e.des=t.des,e.unit=t.unit,e.adding=t.adding},C.prototype.deleteTag=function(t){c.deleteTag(t)},C.prototype.convertUnit=function(t){for(var e=0;e<o.floors.length;++e){var n=o.floors[e].tags;for(var i in n){var r=n[i];r.unit!=t&&(r.unit=t,"m"==t?(r.des=F.convertBack(r.des,"area",7,"imperial",.01,!1),r.des=parseFloat(r.des)):(r.des=F.convert(r.des,"area",7,"imperial",.01,!1),r.des=r.des.replace("ft²","")))}}},C.prototype.getTags=function(t){return o.floors[t].tags};var R=new C,L=function(){this.points={},this.segments={},this.polygons=[],this.tempRooms=[]};L.prototype.start=function(){var t=o.floors;console.log("从头开始分房间！");for(var e=0;e<t.length;++e){var n=t[e].walls,i=t[e].points;T.clearRooms(e),this.getRoomForSingleFloor(n,i,e)}this.updateRoomsTagName()},L.prototype.getRoomForSingleFloor=function(t,e,o){this.getRooms(t,e,o);for(var n=0;n<this.tempRooms.length;++n){var i=this.tempRooms[n];i.floor=o;var r=new d(i.roomId,i.floor);r.setInfo({wallIds:i.wallIds,wallPointIDs:i.wallPointIDs,area:i.area,center:i.center,boundingBox:i.boundingBox,parent:i.parent,childrenWalls:i.childrenWalls,childrenRooms:i.childrenRooms}),T.addRoom(r,o)}this.tempRooms=[]},L.prototype.getRooms=function(t,e,o){this.convertToSegments(t,o),this.convertToPoints(e,o),m.start(this.segments,this.points),this.convertToRoomForPolygon(o),this.points={},this.segments={},this.polygons=[]},L.prototype.convertToPoints=function(t,e){for(var o in t){var n=c.getPoint(o,e),i={pointId:n.vectorId,x:n.x,y:n.y,parent:JSON.parse(JSON.stringify(n.parent))};this.points[n.vectorId]=i}},L.prototype.convertToSegments=function(t,e){for(var o in t){var n=c.getWall(o,e),i={segmentId:n.vectorId,start:n.start,end:n.end};this.segments[n.vectorId]=i}},L.prototype.convertToRoomForPolygon=function(){for(var t=0;t<m.polygons.length;++t){var e=m.polygons[t],o={};o.roomId=e.id.replace("Polygon","Room"),console.log("房间："+o.roomId),o.wallIds=e.segmentIds,o.wallPointIDs=e.pointIds,o.area=e.area,o.center=e.center,o.boundingBox=e.boundingBox,null!=e.parent?o.parent=e.parent.replace("Polygon","Room"):o.parent=null,o.childrenRooms=[];for(var n=0;n<e.childrenPolygonIds.length;++n)o.childrenRooms.push(e.childrenPolygonIds[n].replace("Polygon","Room"));o.childrenWalls=[];for(var i=0;i<e.childrenSegmentIds.length;++i)o.childrenWalls.push(e.childrenSegmentIds[i]);this.tempRooms.push(o)}m.polygons=[]},L.prototype.updateRoomsName=function(){for(var t=0;t<o.floors.length;++t){var e=T.getRooms(t),n=R.getTags(t);n=JSON.parse(JSON.stringify(n));for(var i=0;i<e.length;++i)e[i]}},L.prototype.updateRoomsTagName=function(){function t(t,e){return t.area-e.area}for(var e=0;e<o.floors.length;++e){var n=T.getRooms(e),i=R.getTags(e);i=JSON.parse(JSON.stringify(i)),n=n.sort(t);for(var r=0;r<n.length;++r){for(var s=n[r],a=[],l=0;l<s.wallPointIDs.length;++l){var h=c.getPoint(s.wallPointIDs[l],e);a.push(h)}for(var p in i)if(u.isPointInPoly(i[p].center,a)){s.tagName=i[p].title,delete i[p];break}}}};var D=new L,W={export:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a",lineWidth:3,lineWidth_out:5},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},cover:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},default:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},Font:{font:"12px Microsoft YaHei",fillStyle:"rgba(0,0,0,1)",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#70707a"}},A=function(){this.context=null};A.prototype.initContext=function(t){this.context=t},A.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},A.prototype.drawWall=function(t,e){var o=c.getPoint(t.start),n=c.getPoint(t.end),i=[];i.push(o);for(var r=0;r<t.children.length;++r){var s=c.getSymbol(t.children[r]);i.push(s.startPoint),i.push(s.endPoint)}i.push(n),i=i.sort(function(t,e){return mathUtil.getDistance(o,t)-mathUtil.getDistance(o,e)}.bind(this)),this.context.save(),this.context.beginPath(),"export"==e?(t.out||t.important?this.context.lineWidth=W.export.Wall.lineWidth_out:this.context.lineWidth=W.export.Wall.lineWidth,this.context.strokeStyle=W.export.Wall.strokeStyle,this.context.fillStyle=W.export.Wall.fillStyle):"cover"==e?(t.out||t.important?this.context.lineWidth=W.cover.Wall.lineWidth_out:this.context.lineWidth=W.cover.Wall.lineWidth,this.context.strokeStyle=W.cover.Wall.strokeStyle,this.context.fillStyle=W.cover.Wall.fillStyle):"default"==e&&(t.out||t.important?this.context.lineWidth=W.default.Wall.lineWidth_out:this.context.lineWidth=W.default.Wall.lineWidth,this.context.strokeStyle=W.default.Wall.strokeStyle,this.context.fillStyle=W.default.Wall.fillStyle),this.context.lineCap="round";for(var a=0;a<i.length-1;a+=2){var l=coordinate.getScreenXY(i[a]),h=coordinate.getScreenXY(i[a+1]);this.context.moveTo(l.x,l.y),this.context.lineTo(h.x,h.y)}this.context.stroke(),this.context.restore();var p={x:(o.x+n.x)/2,y:(o.y+n.y)/2};this.drawText(p,t.vectorId)},A.prototype.drawText=function(t,e,o,n){this.context.save(),this.setCanvasStyle(W.Font),coordinate.ratio==Constant.ratio?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei";var i={x:t.x,y:t.y};o||(i=coordinate.getScreenXY({x:t.x,y:t.y})),n?(this.context.translate(i.x,i.y),this.context.rotate(n),this.context.strokeText(e,0,0),this.context.fillText(e,0,0)):(this.context.strokeText(e,i.x,i.y),this.context.fillText(e,i.x,i.y)),this.context.restore()},A.prototype.drawSingleDoor=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});var i=mathUtil.getDistance(o[0],o[1]);this.context.save(),this.context.lineCap="square",this.context.lineWidth=1,"export"==type?(this.context.strokeStyle=W.export.strokeStyle,this.context.fillStyle=W.export.fillStyle):"cover"==type?(this.context.strokeStyle=W.cover.strokeStyle,this.context.fillStyle=W.export.fillStyle):"default"==type&&(this.context.strokeStyle=W.default.strokeStyle,this.context.fillStyle=W.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.arcTo(o[2].x,o[2].y,o[3].x,o[3].y,i),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawImg(t)},A.prototype.drawDoubleDoor=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});var i=mathUtil.getDistance(o[0],o[1]);this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=W.export.strokeStyle,this.context.fillStyle=W.export.fillStyle):"cover"==type?(this.context.strokeStyle=W.cover.strokeStyle,this.context.fillStyle=W.export.fillStyle):"default"==type&&(this.context.strokeStyle=W.default.strokeStyle,this.context.fillStyle=W.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.arcTo(o[4].x,o[4].y,o[5].x,o[5].y,i),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[1].x,o[1].y),this.context.arcTo(o[4].x,o[4].y,o[3].x,o[3].y,i),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawImg(t)},A.prototype.drawSlideDoor=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=W.export.strokeStyle,this.context.fillStyle=W.export.fillStyle):"cover"==type?(this.context.strokeStyle=W.cover.strokeStyle,this.context.fillStyle=W.export.fillStyle):"default"==type&&(this.context.strokeStyle=W.default.strokeStyle,this.context.fillStyle=W.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.lineTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.lineTo(o[6].x,o[6].y),this.context.lineTo(o[7].x,o[7].y),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawImg(t)},A.prototype.drawSingleWindow=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=W.export.strokeStyle,this.context.fillStyle=W.export.fillStyle):"cover"==type?(this.context.strokeStyle=W.cover.strokeStyle,this.context.fillStyle=W.export.fillStyle):"default"==type&&(this.context.strokeStyle=W.default.strokeStyle,this.context.fillStyle=W.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.lineTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.closePath(),this.context.stroke(),this.context.restore()},A.prototype.drawBayWindow=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=W.export.strokeStyle,this.context.fillStyle=W.export.fillStyle):"cover"==type?(this.context.strokeStyle=W.cover.strokeStyle,this.context.fillStyle=W.export.fillStyle):"default"==type&&(this.context.strokeStyle=W.default.strokeStyle,this.context.fillStyle=W.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.lineTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.closePath(),this.context.stroke(),this.context.fill(),this.context.beginPath(),this.context.moveTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.lineTo(o[6].x,o[6].y),this.context.lineTo(o[7].x,o[7].y),this.context.closePath(),this.context.stroke(),this.context.restore()},A.prototype.drawFrenchWindow=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=W.export.strokeStyle,this.context.fillStyle=W.export.fillStyle):"cover"==type?(this.context.strokeStyle=W.cover.strokeStyle,this.context.fillStyle=W.export.fillStyle):"default"==type&&(this.context.strokeStyle=W.default.strokeStyle,this.context.fillStyle=W.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.moveTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[4].x,o[4].y),this.context.moveTo(o[3].x,o[3].y),this.context.lineTo(o[5].x,o[5].y),this.context.moveTo(o[6].x,o[6].y),this.context.lineTo(o[7].x,o[7].y),this.context.stroke(),this.context.restore()},A.prototype.drawMeasure=function(){};var Y=new A,N=function(){this.cadBoundingBox=null,this.padding={export:165,cover:35,default:102},this.type=null};N.prototype.init=function(){this.cadBoundingBox=c.getBoundingBox()},N.prototype.start=function(){this.setType("export"),this.test(),this.setType("cover"),this.test(),this.setType("default"),this.test(),this.recovery()},N.prototype.setType=function(t){this.type=t},N.prototype.autoDraw=function(){var t=c.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);var n=t.symbols;for(var i in n)this.drawGeometry(n[i])},N.prototype.getSize=function(){if("export"==this.type)s.width=900,s.height=900;else if("cover"==this.type){var t=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*1.42+2*this.padding.cover,e=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*1.42+2*this.padding.cover;W.cover.Wall.lineWidth_out=Math.ceil(.0055*Math.max(t,e)),W.cover.Wall.lineWidth=Math.ceil(.0055*Math.max(t,e)/1.5),t=Math.ceil(t+W.cover.Wall.lineWidth_out/2),e=Math.ceil(e+W.cover.Wall.lineWidth_out/2),s.width=t,s.height=e}else if("default"==this.type){var o=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*1.42+2*this.padding.default,n=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*1.42+2*this.padding.default;W.default.Wall.lineWidth_out=Math.ceil(.0055*Math.max(o,n)),W.cover.Wall.lineWidth=Math.ceil(.0055*Math.max(o,n)/1.5),o=Math.ceil(o+W.cover.Wall.lineWidth_out/2),n=Math.ceil(n+W.cover.Wall.lineWidth_out/2),s.width=o,s.height=n}},N.prototype.test=function(){this.layer.uiControl.menu_flex(),D.start(),g.updateRegion(!0),g.update();var t,e,o=this.layer.canvas;this.getSize(),("export"==this.type||"cover"==this.type||"default"==this.type)&&(t=(s.width-pad.left-pad.right)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(s.height-pad.top-pad.bottom)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),s.res=Math.min(t,e),o.width=s.width,o.height=s.height),this.autoDraw(),this.downloadCadImg(o,"floorPlan.png")},N.prototype.recovery=function(){var t=this.layer.app.core.get("CameraControls").activeControl.camera;s.updateForCanvas(canvas),s.setRes(t.left,t.right),this.layer.renderer.autoRedraw()},N.prototype.downloadCadImg=function(t,e){var o=t.toDataURL("png",3);o=o.replace(this._fixType("png"),"image/octet-stream"),this.saveFile(o,e)},N.prototype.saveFile=function(t,e){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=t,o.download=e;var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},N.prototype._fixType=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]},N.prototype.drawGeometry=function(t){if(null!=Y.context)switch(t.geoType){case VectorType.Wall:Y.drawWall(t,this.type);break;case VectorType.SingleDoor:Y.drawSingleDoor(t);break;case VectorType.DoubleDoor:Y.drawDoubleDoor(t);break;case VectorType.SlideDoor:Y.drawSlideDoor(t);break;case VectorType.SingleWindow:Y.drawSingleWindow(t);break;case VectorType.FrenchWindow:Y.drawFrenchWindow(t);break;case VectorType.BayWindow:Y.drawBayWindow(t);break;case VectorType.Beam:Y.drawBeam(t,this.type);break;case VectorType.Flue:Y.drawFlue(t,this.type);break;case VectorType.Corridor:Y.drawCorridor(t,this.type);break;case VectorType.Tag:Y.drawTag(t,this.type)}};var j=new N,J=function(t,e){this.app=t,this.ajkJson={},this.cameraJson={},this.floorPlanJson={},this.file1=null,this.file2=null,this.file3=null,this.cameraJson.sweepLocations=e.sweepLocations};return J.prototype.init=function(){},J.prototype.startSync=function(){var t=this;this.getFloorPlanJson().then((function(e){c.updateBoundingBox(),t.getAJKRooms(),t.getEntrance(),t.getSceneName(),t.getPictureRotate(),t.getImgInfo()})),j.layer=this.app.CadManager.cad(),j.layer.renderer.clear(),j.start()},J.prototype.getAJKRooms=function(){var t=[],e=c.getTags(),o=JSON.parse(JSON.stringify(c.getRooms()));for(var n in e){var r={},s=e[n],a={};r.area=s.des,r.name=s.title,r.tagId=s.vectorId,r.floor=i;var l=null;l=this.cameraJson.sweepLocations[0].puck;for(var h=1;h<this.cameraJson.sweepLocations.length;++h)mathUtil.getDistance(s.center,this.cameraJson.sweepLocations[h].puck)<mathUtil.getDistance(s.center,l)&&(l=this.cameraJson.sweepLocations[h]),this.cameraJson.sweepLocations.group=-1;a.x=l.x,a.y=l.y,a.z=0;for(var p=1;p<o.length;++p){if(o[p].containPoint(a)){r.group=o[p].replace("Room",""),o.splice(p,1),l.group=r.group;break}}r.labelPos=a,r.group&&t.push(r)}this.ajkJson.rooms=t},J.prototype.getCameraJson=function(){},J.prototype.getFloorPlanJson=function(){var t=this;return this.app.store.get("floor",(function(e){return t.floorPlanJson=e,e}))},J.prototype.getEntrance=function(t){var e=c.getSymbols(t),o=null;for(var n in e)if((o=e[n]).enter)break;if(null!=o&&o.enter){var i=this.layer.app.core.get("Player").model.floors[t].boundingBox.min.y+.1,r=new THREE.Vector3(o.start.x,i+.4*.2,-o.start.y),s=new THREE.Vector3(o.end.x,i+.4*.2,-o.end.y),a=r.clone().add(s).multiplyScalar(.5),l=new THREE.Vector3(o.points2d[3].x,i+.4*.2,o.points2d[3].y);l.z*=-1;var h=this.getFootPoint(l,r,s),p=l.clone().sub(h).normalize();a.clone().negate().angleTo(p)>Math.PI/2&&(a.add(p.clone().multiplyScalar(r.distanceTo(s))),p.multiplyScalar(-1)),a.add(p.clone().multiplyScalar(-.5));var u={Position:new THREE.Vector3(a.x,-a.z,a.y),Direction:new THREE.Vector3(p.x,-p.z,p.y)};this.ajkJson.Entrance=u}},J.prototype.getSceneName=function(){var t=this.app.store.getValue("metadata");this.ajkJson.scene_name=t.title},J.prototype.getPictureRotate=function(){var t=c.getAngle(),e=new THREE.Euler(0,t,0),o=new THREE.Vector3(0,0,-1);o.applyEuler(e),o=new THREE.Vector3(o.x,-o.z,o.y),this.ajkJson.picture_rotate=o},J.prototype.getFootPoint=function(t,e,o,n){var i=t.clone().sub(e),r=e.clone().sub(o),s=r.length(),a=i.dot(r)/s,l=e.clone().add(r.multiplyScalar(a/s));return n&&l.clone().sub(e).dot(l.clone().sub(o))>0&&(l=l.distanceTo(e)<l.distanceTo(o)?e.clone():o.clone()),l},J.prototype.getImgInfo=function(){var t=c.getCadInfo(this.layer.canvas),e={};e.bound=t.bound,e.margin=51,e.marginReal=e.margin/coordinate.res,e.width=Math.abs(t.bound.left-t.bound.right),e.center={x:(t.bound.left+t.bound.right)/2,y:(t.bound.top+t.bound.bottom)/2},this.ajkJson.img_info=e},function(t,e){void 0===e&&(e={});var o=KanKan.Deferred();return t.Scene.on("loaded",(function(){var n=new J(t,e);n.$name="DataAJK",n.$load=function(){t.DataSYNC.install(n)},o.resolve(n)})),o}}();
