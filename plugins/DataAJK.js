var DataAJK=function(){"use strict";var t=function(){this.version="v4.0",this.floors=[]};t.prototype.initFloor=function(t){this.floors[t]={},this.floors[t].points={},this.floors[t].walls={},this.floors[t].symbols={},this.floors[t].components={},this.floors[t].tags={},this.floors[t].boundingBox={},this.floors[t].rooms=[]};var e=new t;window.floorplanData=e;var o=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.rotate=0,this.initRes=null,this.initWidth=null,this.initHeight=null};o.prototype.init=function(t){var e=a.getBoundingBox();this.setCenter(e),this.updateForCanvas(t)},o.prototype.setInitInfo=function(t,e,o){null==this.initRes&&(this.initRes=t),null==this.initWidth&&(this.initWidth=e),null==this.initHeight&&(this.initHeight=o)},o.prototype.updateResForReSize=function(t,e,o){Math.abs(o)<.01||Math.abs(o-2*Math.PI)<.01?this.res=this.initRes*t/this.initWidth:this.res=this.initRes*e/this.initHeight},o.prototype.setCenter=function(t){this.cadBoundingbox=JSON.parse(JSON.stringify(t)),null!=this.cadBoundingbox&&(this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2},this.defaultCenter={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2})},o.prototype._setRes=function(t){this.res=t},o.prototype.setRes=function(t,e){this.res=this.width/Math.abs(e-t)},o.prototype.getScreenXY=function(t){if(null==this.width||null==this.height)return null;var e=t.x,o=t.y,n=this.width/2+(e-this.center.x)*this.res*this.zoom/100,i=this.height/2-(o-this.center.y)*this.res*this.zoom/100;return n=.5+n<<0,i=.5+i<<0,{x:Math.floor(n)*this.ratio,y:Math.floor(i)*this.ratio}},o.prototype.getXYFromScreen=function(t){var e={};return e.x=(t.x-this.width/2)/this.res*100/this.zoom+this.center.x,e.y=(this.height/2-t.y)/this.res*100/this.zoom+this.center.y,e},o.prototype.getPointForRotate=function(t){return 0==this.rotate||360==this.rotate?t:{x:(t.x-this.center.x)*Math.cos(this.rotate/180*Math.PI)-(t.y-this.center.y)*Math.sin(this.rotate/180*Math.PI)+this.center.x,y:(t.y-this.center.y)*Math.cos(this.rotate/180*Math.PI)+(t.x-this.center.x)*Math.sin(this.rotate/180*Math.PI)+this.center.y}},o.prototype.getPointForRevRotate=function(t,e){if(Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.defaultCenter.x)*Math.cos(e)-(t.y-this.defaultCenter.y)*Math.sin(e)+this.defaultCenter.x,n=(t.y-this.defaultCenter.y)*Math.cos(e)+(t.x-this.defaultCenter.x)*Math.sin(e)+this.defaultCenter.y;return t.x=o,t.y=n,t},o.prototype.getVectorForRotate=function(t,e){if(e=-e,Math.abs(e)<.01||Math.abs(e-2*Math.PI)<.01)return t;var o=(t.x-this.defaultCenter.x)*Math.cos(e)-(t.y-this.defaultCenter.y)*Math.sin(e)+this.defaultCenter.x,n=(t.y-this.defaultCenter.y)*Math.cos(e)+(t.x-this.defaultCenter.x)*Math.sin(e)+this.defaultCenter.y;return t.x=o,t.y=n,t},o.prototype.updateCenterForRotate=function(t){if(!(Math.abs(t)<.01||Math.abs(t-2*Math.PI)<.01)){var e=this.center.x*Math.cos(t)-this.center.y*Math.sin(t),o=this.center.y*Math.cos(t)+this.center.x*Math.sin(t);return this.center.x=e,this.center.y=o,this.center}},o.prototype.updateForCanvas=function(t){t&&(this.width=t.clientWidth,this.height=t.clientHeight,t.width=t.clientWidth,t.height=t.clientHeight)},o.prototype.updateZoom=function(t){this.zoom=t},o.prototype.moveTo=function(t,e){var o=this.getXYFromScreen(e);this.zoom=t;var n=(100*e.x/this.zoom-this.width/2)/this.res,i=(this.height/2-100*e.y/this.zoom)/this.res;this.center.x=o.x-n,this.center.y=o.y-i},o.prototype.getXYFromScreenForDefaultZoom=function(t){var e={};return e.x=(t.x-this.width/2)/this.res+this.center.x,e.y=(this.height/2-t.y)/this.res+this.center.y,e},o.prototype.getScreenInfoForCAD=function(){var t=this.getXYFromScreen({x:this.width,y:this.height}),e=this.getXYFromScreen({x:0,y:0}),o={x:this.center.x,y:this.center.y};return{width:Math.abs(t.x-e.x),height:Math.abs(t.y-e.y),center:{x:o.x,y:-1*o.y},defaultCenter:this.defaultCenter}},o.prototype.getPixelRatio=function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},o.prototype.reSet=function(){this.center={x:(this.cadBoundingbox.maxX+this.cadBoundingbox.minX)/2,y:(this.cadBoundingbox.maxY+this.cadBoundingbox.minY)/2},this.zoom=100},o.prototype.updateForRotate=function(t){void 0===t&&(t=Math.PI/2);for(var o=0;o<e.floors.length;++o){var n=e.floors[o].points;for(var i in n)n[i]=this.getVectorForRotate(n[i],t);var r=e.floors[o].symbols;for(var s in r)r[s].startPoint=this.getVectorForRotate(r[s].startPoint,t),r[s].endPoint=this.getVectorForRotate(r[s].endPoint,t),r[s].setPoints2d();var l=e.floors[o].components;for(var a in l){var h=l[a];h.center=this.getVectorForRotate(h.center,t),h.angle=h.angle+t/Math.PI*180,h.setPoints2d()}var c=e.floors[o].tags;for(var p in c)c[p].center=this.getVectorForRotate(c[p].center,t),c[p].setPoints2d()}},o.prototype.clear=function(){this.defaultCenter=null,this.center=null,this.zoom=100,this.res=80,this.ratio=1,this.rotate=0};var n=new o,r=.1,s=100,l=function(){this.currentId=0,this.currentFloor=0,this.angle=0};l.prototype.setCurrentId=function(t){this.currentId=t},l.prototype.getCurrentId=function(){return this.currentId},l.prototype.updateCurrentId=function(){++this.currentId},l.prototype.setCurrentFloor=function(t){this.currentFloor=t},l.prototype.getCurrentFloor=function(){return this.currentFloor},l.prototype.getCompass=function(){return e.compass},l.prototype.setCompass=function(t){e.compass=t},l.prototype.getFloorNum=function(){return e.floors.length},l.prototype.initFloor=function(t){e.initFloor(t)},l.prototype.getFloors=function(){return e.floors},l.prototype.getPoint=function(t,o){return null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].points[t]},l.prototype.deletePoint=function(t,o,n){null!=n&&void 0!==n||(n=this.currentFloor);var i=this.getPoint(t);if(i)if(0==Object.keys(i.parent).length)i=null,delete e.floors[n].points[t];else if(1!=Object.keys(i.parent).length||o)if(1==Object.keys(i.parent).length&&i.parent[o])delete e.floors[n].points[t];else{if(1==Object.keys(i.parent).length&&!i.parent[o])return;delete i.parent[o]}else delete e.floors[n].points[t]},l.prototype.getWall=function(t,o){return null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].walls[t]},l.prototype.deleteWall=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor);for(var n=this.getWall(t,o),i=0;i<n.children.length;++i)this.deleteSymbol(n.children[i],o);this.deletePoint(n.start,t,o),this.deletePoint(n.end,t,o),delete e.floors[o].walls[t]},l.prototype.deleteWallNoSymbol=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor);var n=this.getWall(t,o);this.deletePoint(n.start,t,o),this.deletePoint(n.end,t,o),delete e.floors[o].walls[t]},l.prototype.getAngle=function(){return this.angle},l.prototype.setAngle=function(t){this.angle=t},l.prototype.setBoundingBox=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].boundingBox=JSON.parse(JSON.stringify(t))},l.prototype.getBoundingBox=function(t){if(null==t||void 0===t){for(var o=null,n=null,i=null,r=null,s=0;s<e.floors.length;++s)e.floors[s].boundingBox.hasOwnProperty("maxX")&&e.floors[s].boundingBox.hasOwnProperty("minX")&&e.floors[s].boundingBox.hasOwnProperty("maxY")&&e.floors[s].boundingBox.hasOwnProperty("minY")||this.updateBoundingBox(s),(null==o||o>e.floors[s].boundingBox.minX)&&(o=e.floors[s].boundingBox.minX),(null==n||n<e.floors[s].boundingBox.maxX)&&(n=e.floors[s].boundingBox.maxX),(null==i||i>e.floors[s].boundingBox.minY)&&(i=e.floors[s].boundingBox.minY),(null==r||r<e.floors[s].boundingBox.maxY)&&(r=e.floors[s].boundingBox.maxY);return{minX:o,maxX:n,minY:i,maxY:r}}return e.floors[t].boundingBox},l.prototype.updateBoundingBox=function(t){var e=this.getPoints(t),o=null,n=null,i=null,r=null;for(var s in e){var l=e[s];(null==o||o>l.x)&&(o=l.x),(null==n||n<l.x)&&(n=l.x),(null==i||i>l.y)&&(i=l.y),(null==r||r<l.y)&&(r=l.y)}this.setBoundingBox({minX:o,maxX:n,minY:i,maxY:r},t)},l.prototype.getFloorData=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t]},l.prototype.getWalls=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t].walls},l.prototype.getPoints=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t].points},l.prototype.getSymbol=function(t,o){return null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].symbols[t]},l.prototype.addWall=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].walls[t.vectorId]=t},l.prototype.addPoint=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].points[t.vectorId]=t},l.prototype.addSymbol=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].symbols[t.vectorId]=t},l.prototype.addComponent=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].components[t.vectorId]=t},l.prototype.deleteSymbol=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),this.getSymbol(t,o),delete e.floors[o].symbols[t]},l.prototype.getComponent=function(t,o){return null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].components[t]},l.prototype.deleteComponent=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),this.getComponent(t,o),delete e.floors[o].components[t]},l.prototype.addTag=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].tags[t.vectorId]=t},l.prototype.getTag=function(t,o){return null!=o&&void 0!==o||(o=this.currentFloor),e.floors[o].tags[t]},l.prototype.deleteTag=function(t,o){null!=o&&void 0!==o||(o=this.currentFloor),this.getTag(t,o),delete e.floors[o].tags[t]},l.prototype.getSymbols=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t].symbols},l.prototype.getComponents=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t].components},l.prototype.getTags=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t].tags},l.prototype.getAllBoundingBox=function(){for(var t=[],o=0;o<e.floors.length;++o){var n=void 0,i=void 0,r=void 0,s=void 0,l={};for(var a in e.floors[o].points){var h=e.floors[o].points[a].x,c=e.floors[o].points[a].y;(void 0===n||n>h)&&(n=h),(void 0===r||r<h)&&(r=h),(void 0===i||i>c)&&(i=c),(void 0===s||s<c)&&(s=c)}l.left=n,l.top=s,l.right=r,l.bottom=i,t.push(l)}return t},l.prototype.getCadInfo=function(t){for(var e=[],o=this.getAllBoundingBox(),i=0;i<o.length;++i){var r={},s=n.getScreenXY({x:o[i].left,y:o[i].top}),l=n.getScreenXY({x:o[i].right,y:o[i].bottom}),a=s.x,h=s.y,c=t.width-l.x,p=t.height-l.y;r.left=a,r.top=h,r.right=c,r.bottom=p,r.bound=o[i],r.bound.top=-1*r.bound.top,r.bound.bottom=-1*r.bound.bottom,e.push(r)}return e},l.prototype.getRooms=function(t){return null!=t&&void 0!==t||(t=this.currentFloor),e.floors[t].rooms},l.prototype.clear=function(){e.floors[this.currentFloor].points={},e.floors[this.currentFloor].walls={},e.floors[this.currentFloor].symbols={},e.floors[this.currentFloor].components={},e.floors[this.currentFloor].tags={},e.floors[this.currentFloor].boundingBox={},e.floors[this.currentFloor].rooms=[]};var a=new l,h=function(){};h.prototype.getFixed=function(t,e){return e||(e=5),parseFloat(t.toFixed(e))},h.prototype.getDistance=function(t,e){var o=t.x,n=t.y,i=e.x,r=e.y,s=Math.sqrt(Math.pow(o-i,2)+Math.pow(n-r,2));return this.getFixed(s)},h.prototype.createLine1=function(t,e){if(t.x==e.x&&t.y==e.y)return null;if(0==this.getFixed(Math.abs(t.x-e.x)))return{x:t.x};if(0==this.getFixed(Math.abs(t.y-e.y)))return{y:t.y};var o=(t.y-e.y)/(t.x-e.x),n=(t.x*e.y-e.x*t.y)/(t.x-e.x);return 0==this.getFixed(o)?{y:this.getFixed(n)}:{a:this.getFixed(o),b:this.getFixed(n)}},h.prototype.createLine2=function(t,e){if(e==Math.PI/2||e==1.5*Math.PI)return{x:t.x};var o=Math.tan(e),n=t.y-o*t.x;return 0!=o?{a:o,b:n}:{y:t.y}},h.prototype.createLine3=function(t,e){var o={};return void 0===t.a?void 0!==t.x?o.x=e.x:void 0!==t.y&&(o.y=e.y):(o.a=t.a,o.b=e.y-e.x*t.a),o},h.prototype.create2AngleLine=function(t,e,o){return{line1:this.createLine2(t,e-o/2),line2:this.createLine2(t,e+o/2)}},h.prototype.distanceForPoints=function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},h.prototype.getParallelLineForDistance=function(t,e){var o={};o.a=t.a,o.b=t.b;var n={};if(n.a=t.a,n.b=t.b,void 0===t.a){if(t.hasOwnProperty("x")){var i=t.x;o.x=i+e,n.x=i-e}else if(t.hasOwnProperty("y")){var r=t.y;o.y=r+e,n.y=r-e}}else{var s=Math.atan(t.a),l=Math.abs(e/Math.cos(s)),a=t.b;o.b=a+l,n.b=a-l}return{line1:o,line2:n}},h.prototype.getEndpoint=function(t,e,o){var n=this.create2AngleLine(t,e,o),i=this.createLine2(t,e);i=this.getLineForPoint(i,t);var r=this.getParallelLineForDistance(i,15),s=this.getIntersectionPoint(n.line1,r.line1),l=this.getIntersectionPoint(n.line1,r.line2),a=this.getIntersectionPoint(n.line2,r.line1),h=this.getIntersectionPoint(n.line2,r.line2),c=this.Angle(t,s,{x:t.x+1,y:t.y}),p=this.Angle(t,l,{x:t.x+1,y:t.y}),y=this.Angle(t,a,{x:t.x+1,y:t.y}),u=this.Angle(t,h,{x:t.x+1,y:t.y});return e>Math.PI&&(e=2*Math.PI-e),Math.abs((c+y)/2-e)<Math.abs((p+u)/2-e)?{p1:s,p2:a}:{p1:l,p2:h}},h.prototype.isClockwise=function(t){for(var e=0,o=0;o<t.length;o++){var n=(o+1)%t.length;e+=t[o].x*t[n].y,e-=t[n].x*t[o].y}return e/2>0},h.prototype.reverse=function(t){for(var e=[],o=t.length-1;o>-1;--o)e.push(t[o]);return e},h.prototype.getIntersectionPoint=function(t,e){if(this.isParallel(t,e))return null;if(void 0===t.a&&void 0!==e.a){if(t.x)return{x:t.x,y:e.a*t.x+e.b};if(t.y)return{x:(t.y-e.b)/e.a,y:t.y}}else if(void 0===e.a&&void 0!==t.a){if(e.x)return{x:e.x,y:t.a*e.x+t.b};if(e.y)return{x:(e.y-t.b)/t.a,y:e.y}}else if(void 0===e.a&&void 0===t.a)return t.hasOwnProperty("x")&&e.hasOwnProperty("y")?{x:t.x,y:e.y}:t.hasOwnProperty("y")&&e.hasOwnProperty("x")?{x:e.x,y:t.y}:null;return t.a==e.a?null:{x:(e.b-t.b)/(t.a-e.a),y:(t.a*e.b-e.a*t.b)/(t.a-e.a)}},h.prototype.getIntersectionPoint2=function(t,e,o,n){var i=(e.y-t.y)*(n.x-o.x)-(t.x-e.x)*(o.y-n.y);return 0==i?null:{x:((e.x-t.x)*(n.x-o.x)*(o.y-t.y)+(e.y-t.y)*(n.x-o.x)*t.x-(n.y-o.y)*(e.x-t.x)*o.x)/i,y:-((e.y-t.y)*(n.y-o.y)*(o.x-t.x)+(e.x-t.x)*(n.y-o.y)*t.y-(n.x-o.x)*(e.y-t.y)*o.y)/i}},h.prototype.getIntersectionPoint3=function(t,e,o,n){var i=this.getIntersectionPoint2(t,e,o,n);if(i){var r=i.x,s=i.y;return(r-t.x)*(r-e.x)<=.001&&(s-t.y)*(s-e.y)<=.001&&(r-o.x)*(r-n.x)<=.001&&(s-o.y)*(s-n.y)<=.001?{x:r,y:s}:null}return null},h.prototype.getIntersectionPoint4=function(t,e,o){var n=this.createLine1(t,e),i=this.getIntersectionPoint(n,o);return null==i?null:this.PointInSegment(i,t,e)?i:null},h.prototype.isParallel=function(t,e){return void 0===t.a&&void 0===e.a?!(!t.hasOwnProperty("x")||!e.hasOwnProperty("x"))||!(!t.hasOwnProperty("y")||!e.hasOwnProperty("y")):void 0!==t.a&&void 0!==e.a&&this.getFixed(t.a)==this.getFixed(e.a)},h.prototype.Angle=function(t,e,o){var n,i,r=0,s=e.x-t.x,l=e.y-t.y,a=o.x-t.x,h=o.y-t.y;return r=s*a+l*h,i=(s*s+l*l)*(a*a+h*h),(r/=Math.sqrt(i))>=1?0:r<=-1?Math.PI:180*(n=Math.acos(r))/Math.PI<180?n:2*Math.PI-n},h.prototype.getLineForPoint=function(t,e){var o={};return 0==t.a||void 0===t.a?t.hasOwnProperty("x")?o.y=e.y:t.hasOwnProperty("y")&&(o.x=e.x):(o.a=-1/t.a,o.b=e.y-e.x*o.a),o},h.prototype.getJoinLinePoint=function(t,e){var o=this.getVerticalLine(e,t);return this.getIntersectionPoint(e,o)},h.prototype.getDisForPoinLine=function(t,e){var o=this.getJoinLinePoint(t,e);return this.getDistance(t,o)},h.prototype.getVerticalLine=function(t,e){if(void 0===t.a)return t.hasOwnProperty("x")?{y:e.y}:t.hasOwnProperty("y")?{x:e.x}:null;if(0==t.a)return{x:e.x};var o={};return o.a=-1/t.a,this.createLine3(o,e)},h.prototype.isContainForSegment=function(t,e,o,n){n||(n=r);var i=this.getDistance(e,t)+this.getDistance(o,t),s=this.getDistance(e,o);return Math.abs(i-s)<n},h.prototype.isPointInPoly=function(t,e){for(var o=t.x,n=t.y,i=!1,r=0,s=e.length-1;r<e.length;s=r++){var l=e[r],a=e[s],h=l.x,c=l.y,p=a.x,y=a.y;c>n!=y>n&&o<(p-h)*(n-c)/(y-c)+h&&(i=!i)}return i},h.prototype.getDisForPoinSegment=function(t,e,o,n){var i=this.createLine1(e,o),r=this.getJoinLinePoint(t,i),s=this.getDistance(e,o),l=this.getDistance(r,e),a=this.getDistance(r,o);return this.getDistance(r,e)>s||this.getDistance(r,o)>s?l<a&&l<n?{type:1,join:e}:a<l&&a<n?{type:2,join:o}:null:l<n?{type:1,join:e}:a<n?{type:2,join:o}:this.getDistance(t,r)<n?{type:0,join:r}:void 0},h.prototype.PointInSegment=function(t,e,o,n){if(this.getDistance(t,e)<r||this.getDistance(t,o)<r)return!0;n||(n=.1),n/=2;var i=(t.x-e.x)*(o.y-e.y)-(o.x-e.x)*(t.y-e.y),s=Math.min(e.x,o.x)-t.x,l=t.x-Math.max(e.x,o.x),a=Math.min(e.y,o.y)-t.y,h=t.y-Math.max(e.y,o.y);return Math.abs(i)<n&&(s<=0||Math.abs(s)<n)&&(l<=0||Math.abs(l)<n)&&(a<=0||Math.abs(a)<n)&&(h<=0||Math.abs(h)<n)},h.prototype.clonePoint=function(t,e){t.x=e.x,t.y=e.y},h.prototype.equalPoint=function(t,e){return t.x==e.x&&t.y==e.y},h.prototype.crossTwoLines=function(t,e,o,n,i){void 0===i&&(i=r);var s=this.getIntersectionPoint2(t,e,o,n);if(null!=s){if(this.getDistance(t,s)>i&&this.getDistance(e,s)>i&&this.getDistance(o,s)>i&&this.getDistance(n,s)>i)return this.getDistance(t,s)<this.getDistance(t,e)&&this.getDistance(e,s)<this.getDistance(t,e)&&this.getDistance(o,s)<this.getDistance(o,n)&&this.getDistance(n,s)<this.getDistance(o,n)}else if(this.PointInSegment(t,o,n)||this.PointInSegment(e,o,n))return!0;return!1},h.prototype.getDisPointsLine=function(t,e,o,n){var i={},r={},s={};if(t.hasOwnProperty("x"))i.x=t.x,i.y=e.y-o,r.x=t.x,r.y=e.y+n;else if(t.hasOwnProperty("y"))i.y=t.y,i.x=e.x-o,r.y=t.y,r.x=e.x+n;else{var l=Math.atan(t.a),a={a:-1/t.a},h=this.createLine3(a,e),c=this.getIntersectionPoint(t,h);i.x=c.x-o*Math.cos(l),i.y=c.y-o*Math.sin(l),r.x=c.x+n*Math.cos(l),r.y=c.y+n*Math.sin(l)}return s.newpoint1=i,s.newpoint2=r,s},h.prototype.getBoundingBox=function(t){for(var e=t[0].x,o=t[0].x,n=t[0].y,i=t[0].y,r=1;r<t.length;++r){var s=t[r];e>s.x&&(e=s.x),n>s.y&&(n=s.y),o<s.x&&(o=s.x),i<s.y&&(i=s.y)}var l={};return l.minX=e,l.minY=n,l.maxX=o,l.maxY=i,l},h.prototype.ComputePolygonArea=function(t){var e=t.length;if(e<3)return 0;for(var o=t[0].y*(t[e-1].x-t[1].x),n=1;n<e;++n)o+=t[n].y*(t[n-1].x-t[(n+1)%e].x);return Math.abs(o/2)},h.prototype.getPolygonCore=function(t){function e(t,e,o){return(t.x*e.y+e.x*o.y+o.x*t.y-e.x*t.y-o.x*e.y-t.x*o.y)/2}for(var o=0,n=0,i=0,r=t[1],s=2;s<t.length;s++){var l=t[s],a=e(t[0],r,l);i+=a,o+=(t[0].x+r.x+l.x)*a,n+=(t[0].y+r.y+l.y)*a,r=l}return{x:o/i/3,y:n/i/3}},h.prototype.isPolyInPoly=function(t,e,o){for(var n=0;n<t.length;++n){for(var i=!1,r=0;r<e.length;++r)if(this.equalPoint(t[n],e[r])){i=!0;break}if(i){var s=n==t.length-1?0:n+1,l={x:(t[n].x+t[s].x)/2,y:(t[n].y+t[s].y)/2};if(!this.isPointInPoly(l,e,o))return!1}else if(!this.isPointInPoly(t[n],e,o))return!1}return!0},h.prototype.dotPoints=function(t,e,o,n){var i={},r={};return i.start={},i.end={},i.start.x=0,i.start.y=0,i.end.x=e.x-t.x,i.end.y=e.y-t.y,r.start={},r.end={},r.start.x=0,r.start.y=0,r.end.x=n.x-o.x,r.end.y=n.y-o.y,i.end.x*r.end.x+i.end.y*r.end.y};var c=new h,p=function(){this.pad={top:60,bottom:60,left:265,right:265},this.region={},this.measureLines={top:[],bottom:[],left:[],right:[]},this.minDis=100/n.res,this.unit="m",this.defalutMeasurePad={bottom:60,right:265}};p.prototype.padding=function(t){void 0===t&&(t={}),Object.assign(this.pad,t),Object.assign(this.defalutMeasurePad,t)},p.prototype.updatePad=function(t){Object.assign(this.pad,t)},p.prototype.updateRegion=function(t){this.region.top=this.pad.top,this.region.bottom=n.height-this.pad.bottom,this.region.left=this.pad.left,this.region.right=n.width-this.pad.right},p.prototype.update=function(){var t=[],e=[],o=[],n=[],i=[],r=a.getPoints();for(var s in r){var l=r[s];i.push({x:l.x,y:l.y})}function h(t,e){return e.y-t.y}function c(t,e){return t.x-e.x}t=[].concat(i).sort(h.bind(this)),(e=[].concat(t)).reverse(),o=[].concat(i).sort(c.bind(this)),(n=[].concat(o)).reverse();var p=null,u=null;this.measureLines.top=[];for(var g=0;g<t.length;++g)if(0==g)p=t[0].x,u=t[0].x,this.measureLines.top.push({x:t[0].x,y:this.region.top});else{if(t[g].x>=p&&t[g].x<=u)continue;(p=Math.min(p,t[g].x))!=(u=Math.max(u,t[g].x))&&this.measureLines.top.push({x:t[g].x,y:this.region.top})}t=this.measureLines.top.sort(c.bind(this)),this.measureLines.top=[],this.measureLines.top.push(t[0]);for(var x=0;x<t.length-1;++x){p=t[x],u=null;for(var d=x+1;d<t.length&&(u=t[d],Math.abs(p.x-u.x)<y.minDis);++d)u=null,++x;if(null!=u)this.measureLines.top.push(u);else if(x==t.length-1){var f=this.measureLines.top.length;this.measureLines.top[f-1]=t[x];break}}this.measureLines.bottom=[];for(var v=0;v<e.length;++v)if(0==v)p=e[0].x,u=e[0].x,this.measureLines.bottom.push({x:e[0].x,y:this.region.bottom});else{if(e[v].x>=p&&e[v].x<=u)continue;(p=Math.min(p,e[v].x))!=(u=Math.max(u,e[v].x))&&this.measureLines.bottom.push({x:e[v].x,y:this.region.bottom})}e=this.measureLines.bottom.sort(c.bind(this)),this.measureLines.bottom=[],this.measureLines.bottom.push(e[0]);for(var m=0;m<e.length-1;++m){p=e[m],u=null;for(var P=m+1;P<e.length&&(u=e[P],Math.abs(p.x-u.x)<y.minDis);++P)u=null,++m;if(null!=u)this.measureLines.bottom.push(u);else if(m==e.length-1){var b=this.measureLines.bottom.length;this.measureLines.bottom[b-1]=e[m];break}}this.measureLines.left=[];for(var S=0;S<o.length;++S)if(0==S)p=o[0].y,u=o[0].y,this.measureLines.left.push({x:this.region.left,y:o[0].y});else{if(o[S].y>=p&&o[S].y<=u)continue;(p=Math.min(p,o[S].y))!=(u=Math.max(u,o[S].y))&&this.measureLines.left.push({x:this.region.left,y:o[S].y})}o=this.measureLines.left.sort(h.bind(this)),this.measureLines.left=[],this.measureLines.left.push(o[0]);for(var I=0;I<o.length-1;++I){p=o[I],u=null;for(var w=I+1;w<o.length&&(u=o[w],Math.abs(p.y-u.y)<y.minDis);++w)u=null,++I;if(null!=u)this.measureLines.left.push(u);else if(I==o.length-1){var M=this.measureLines.left.length;this.measureLines.left[M-1]=o[I];break}}this.measureLines.right=[];for(var k=0;k<n.length;++k)if(0==k)p=n[0].y,u=n[0].y,this.measureLines.right.push({x:this.region.right,y:n[0].y});else{if(n[k].y>=p&&n[k].y<=u)continue;(p=Math.min(p,n[k].y))!=(u=Math.max(u,n[k].y))&&this.measureLines.right.push({x:this.region.right,y:n[k].y})}n=this.measureLines.right.sort(h.bind(this)),this.measureLines.right=[],this.measureLines.right.push(n[0]);for(var T=0;T<n.length-1;++T){p=n[T],u=null;for(var F=T+1;F<n.length&&(u=n[F],Math.abs(p.y-u.y)<y.minDis);++F)u=null,++T;if(null!=u)this.measureLines.right.push(u);else if(T==n.length-1){var B=this.measureLines.right.length;this.measureLines.right[B-1]=n[T];break}}};var y=new p,u=function(t,e,o){this.name=o||"未命名",this.floor=e,this.roomId=t,this.center=null,this.area=null,this.wallIds=[],this.wallPointIDs=[],this.childrenRooms=[],this.childrenWalls=[],this.parent=null,this.tagName=null,this.backgroundImg_src="default",this.boundingBox={}};u.prototype.setInfo=function(t){this.wallIds=t.wallIds,this.wallPointIDs=t.wallPointIDs,this.area=t.area,this.center=t.center,this.boundingBox=t.boundingBox,this.parent=t.parent,this.childrenWalls=t.childrenWalls,this.childrenRooms=t.childrenRooms},u.prototype.containPoint=function(t){for(var e=[],o=0;o<this.wallPointIDs.length;++o){var n=a.getPoint(this.wallPointIDs[o],this.floor);e.push({x:n.x,y:n.y})}return c.isPointInPoly(t,e)};var g=function(t,e,o){this.pointIds=e,this.segmentIds=t,this.childrenPolygonIds=[],this.childrenSegmentIds=[],this.id=o,this.parent=null,this.center=null,this.boundingBox=null,this.area=0,this.floor=1,this.geoType="Polygon"},x=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[],this.pre="",this.currentId=1};x.prototype.init=function(){this.segments={},this.points={},this.polygons=[],this.matrix={},this.maxPolygons=[]},x.prototype.start=function(t,e,o){this.pre=o||"",this.init(),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.createPolygon(null,this.segments,this.points),this.segments=JSON.parse(JSON.stringify(t)),this.points=JSON.parse(JSON.stringify(e)),this.getIncludePolygonInfos(),this.updateChildrenSegmentIds(this.segments,this.points,this.polygons)},x.prototype.getStartPoint=function(t,e){var o=null,n=null;for(var i in t)if(i!==e){var r=t[i];(null===o||o.x>r.x||o.x===r.x&&o.y>r.y)&&(o={x:r.x,y:r.y},n=i)}return n},x.prototype.createPolygon=function(t,e,o){if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.matrix={};var n=[];this.preHandle(o,e);var i=Object.keys(e).length;if(0!==Object.keys(o).length&&0!==Object.keys(e).length){null!==t&&o[t]||(t=this.getStartPoint(o)),n.push(t);var r=this.getNextForMinAngleX(t,o,e);if(null!==r){n.push(r);var s=this.getMaxPolygon(n,o,e);this.checkPolygonSegmentIds(s,o,e);var l=this.splitPolygon(s);if(l){var a=this.getPolygonData(l,o,e),h=Object.keys(a.points),c=Object.keys(a.segments);if(a.segments=this.getChildSegments(a.points,a.segments,e),this.createPolygon(l[0],a.segments,a.points),this.updateMartix2(h,c,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==Object.keys(o).length&&0!==Object.keys(e).length){this.maxPolygons.push(s),this.updateMartix(s,o,e),o[t]||(t=this.getStartPoint(o),r=this.getNextForMinAngleX(t,o,e));var p=[];p.push(t),p.push(r);var y=this.getMinPolygon(p,o,e);if(this.checkPolygonSegmentIds(y,o,e),l=this.splitPolygon(y)){var u=this.getPolygonData(l,o,e),g=Object.keys(u.points),x=Object.keys(u.segments);if(this.createPolygon(l[0],u.segments,u.points),this.updateMartix2(g,x,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return;this.createPolygon(t,e,o)}else if(0!==s.length&&0!==y.length){if(this.addPolygon(y,o,e)){var d=y.slice(0);if(d.push(y[0]),this.updateMartix(d,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}if(i===Object.keys(e).length){this.addPolygon(s,o,e);var f=s.slice(0);if(f.push(s[0]),this.updateMartix(f,o,e),this.updateMartix(f,o,e),this.preHandle(o,e),0===Object.keys(o).length||0===Object.keys(e).length)return}var v=this.getStartPoint(o,t);this.createPolygon(v,e,o)}else console.error("createPolygon——————————————————————————————————————————————————————————————出错！")}}}}},x.prototype.splitPolygon=function(t){for(var e=[],o=0;o<t.length-1;++o){if(-1!==e.indexOf(t[o])){var n=t.slice(0,o+1),i=t.indexOf(t[o]);return n=n.splice(i)}e.push(t[o])}return null},x.prototype.getPolygonData=function(t,e,o){for(var n={},i={},r=[],s=0;s<t.length;++s)n[t[s]]=e[t[s]],r.push(e[t[s]]);for(var l=this.checkPolygonSegmentIds(t,e,o),a=0;a<l.length;++a)i[l[a]]=o[l[a]];var h=[],p=[];for(var y in e)if(!(t.indexOf(y)>-1||h.indexOf(y)>-1)){var u=e[y];if(c.isPointInPoly(u,r)){h.push(y);var g=u.parent;for(var x in g)if(o[x]&&!i[x]&&-1===p.indexOf(x)){var d=null;o[x].start===y?d=o[x].end:o[x].end===y&&(d=o[x].start);var f=e[d];t.indexOf(d)>-1||h.indexOf(d)>-1?p.push(x):c.isPointInPoly(f,r)&&(p.push(x),h.push(d))}}}for(var v=0;v<h.length;++v)n[h[v]]||(n[h[v]]=e[h[v]]);for(var m=0;m<p.length;++m)i[p[m]]||(i[p[m]]=o[p[m]]);return{points:n,segments:i}},x.prototype.getChildSegments=function(t,e,o){var n=[];for(var i in t)n.push(i);for(var r=0;r<n.length-1;++r)for(var s=r+1;s<n.length;++s){var l=this.getSegmentId2(t[n[r]],t[n[s]]);null==l||e[l]||(e[l]=o[l])}return e},x.prototype.updateMartix2=function(t,e,o,n){for(var i=0;i<e.length;++i){var r=e[i];delete this.matrix[r],delete n[r],this.deleteSegment(r,n,o)}for(var s=0;s<t.length;++s){var l=t[s],a=o[l];a&&0!==Object.keys(a.parent).length||delete o[l]}},x.prototype.addPolygon=function(t,e,o){var n=[],i=[];n[0]=this.getPoint(t[0],e);for(var r=0;r<t.length-1;++r){var s=t[r],l=t[r+1],a=this.getSegmentId(s,l,e,o);i.push(a);var h=this.getPoint(l,e);n.push(h)}var p=this.getId();t.pop();var y=new g(i,t,p);return y.area=this.getArea(y),y.center=this.getCenter(y),y.boundingBox=c.getBoundingBox(n),this.polygons.push(y),!0},x.prototype.getMaxPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],r=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===r.min?(t.push(r.min),t):(t.push(r.min),this.getMaxPolygon(t,e,o))},x.prototype.getMinPolygon=function(t,e,o){var n=t[t.length-2],i=t[t.length-1],r=this.getNextForMaxMinAngle(n,i,e,o);return t[0]===r.max?(t.push(r.max),t):(t.push(r.max),this.getMinPolygon(t,e,o))},x.prototype.getNextForMinAngleX=function(t,e,o){for(var n=e[t],i=this.getAllLinkedPoint(t,e,o),r=null,s=null,l=0;l<i.length;++l){var a=e[i[l]];if(a){var h=c.Angle(n,{x:n.x+1,y:n.y},a);a.y-n.y<0&&(h*=-1),(null===r||r>h)&&(r=h,s=i[l])}}return s},x.prototype.getNextForMaxMinAngle=function(t,e,o,n){var i=o[t],r=o[e];i&&r||console.error("getNextForMaxMinAngle******************************************");for(var s=r.x-i.x,l=r.y-i.y,a={x:r.x+s,y:r.y+l},h=this.getAllLinkedPoint(e,o,n),p=null,y=null,u=null,g=null,x=0;x<h.length;++x)if(h[x]!==t){var d=o[h[x]];if(d){var f=c.Angle(r,a,d);s*(d.y-r.y)-(d.x-r.x)*l<0&&(f*=-1),(null===p||p<f)&&(p=f,y=h[x]),(null===u||u>f)&&(u=f,g=h[x])}}return{max:y,min:g}},x.prototype.updateMartix=function(t,e,o){for(var n=0;n<t.length-1;++n){var i=n===t.length-1?0:n+1,r=this.getSegmentId(t[n],t[i],e,o);this.matrix[r]?(delete this.matrix[r],this.deleteSegment(r,o,e)):this.matrix[r]=1}},x.prototype.getSegmentId=function(t,e,o,n){var i=o[t];if(!i)return null;var r=i.parent;for(var s in r){var l=n[s];if(l&&(l.start===e||l.end===e))return s}return null},x.prototype.getSegmentId2=function(t,e){var o=t.parent,n=e.parent;for(var i in o)if(n[i])return i;return null},x.prototype.getAllLinkedPoint=function(t,e,o){var n=[],i=e[t];i||console.error("getAllLinkedPoint");var r=i.parent;for(var s in r){var l=o[s];l&&(l.start===t?n.push(l.end):l.end===t&&n.push(l.start))}return n},x.prototype.deleteLinksSegment=function(t,e,o){var n=e[t];if(n&&0!==Object.keys(n.parent).length&&o[Object.keys(n.parent)[0]]){var i=this.getOtherPointId(Object.keys(n.parent)[0],t,o);this.deleteSegment(Object.keys(n.parent)[0],o,e);var r=e[i];r&&Object.keys(r.parent).length<2&&this.deleteLinksSegment(i,e,o)}},x.prototype.deleteSegment=function(t,e,o){if(t&&e[t]){var n=e[t];this.deletePoint(n.start,t,o),this.deletePoint(n.end,t,o),delete e[t]}},x.prototype.deletePoint=function(t,e,o){if(t&&o[t]){var n=this.getPoint(t,o);delete n.parent[e],0===Object.keys(n.parent).length&&delete o[t]}},x.prototype.getOtherPointId=function(t,e,o){var n=o[t];return n||console.error("getOtherPointId**********************************************************************"),n.start===e?n.end:n.end===e?n.start:void console.error("getOtherPointId**********************************************************************")},x.prototype.preHandle=function(t,e){var o=!1;for(var n in t){var i=t[n];if(Object.keys(i.parent).length<2)this.deleteLinksSegment(n,t,e),o=!0;else{var r=0;for(var s in i.parent)e[s]&&++r;if(r>1)continue;delete t[n]}}return o},x.prototype.getPoint=function(t,e){return e[t]},x.prototype.isClockwise=function(t,e){for(var o=[],n=0;n<t.length;++n){var i=e[t[n]];o.push({x:i.x,y:i.y})}return c.isClockwise(o)},x.prototype.getId=function(){var t=this.currentId;return++this.currentId,"Polygon"+t},x.prototype.getArea=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return c.ComputePolygonArea(e)},x.prototype.getCenter=function(t){for(var e=[],o=0;o<t.pointIds.length;++o){var n=this.points[t.pointIds[o]];e.push(n)}return c.getPolygonCore(e)},x.prototype.getIncludePolygonInfos=function(){this.polygons=this.polygons.sort((function(t,e){return t.area-e.area}));for(var t=0;t<this.polygons.length-1;++t){for(var e=null,o=t+1;o<this.polygons.length;++o)if(o!==t&&this.isContain(this.polygons[t],this.polygons[o])){e=this.polygons[o];break}null!=e&&(this.polygons[t].parent=e.id,e.childrenPolygonIds.push(this.polygons[t].id),e=null)}},x.prototype.updateChildrenSegmentIds=function(t,e,o){for(var n=[],i=0;i<o.length;++i){var r=o[i];n=n.concat(r.segmentIds)}for(var s in t)if(!(n.indexOf(s)>-1))for(var l=t[s],a=e[l.start],h=e[l.end],c=0;c<o.length;++c){var p=!1,y=!1,u=o[c];(u.pointIds.indexOf(l.start)>-1||this.containPoint(u,a))&&(p=!0),(u.pointIds.indexOf(l.end)>-1||this.containPoint(u,h))&&(y=!0),p&&y&&u.childrenSegmentIds.push(s)}},x.prototype.isContain=function(t,e){for(var o=[],n=[],i=0;i<t.pointIds.length;++i){var r=this.points[t.pointIds[i]];o.push(r)}for(var s=0;s<e.pointIds.length;++s){var l=this.points[e.pointIds[s]];n.push(l)}return c.isPolyInPoly(o,n,.01)},x.prototype.containPoint=function(t,e){for(var o=[],n=0;n<t.pointIds.length;++n){var i=this.points[t.pointIds[n]];o.push(i)}return c.isPointInPoly(e,o)},x.prototype.checkPolygonSegmentIds=function(t,e,o){for(var n=[],i=0;i<t.length;++i){var r=i===t.length-1?0:i+1;if(t[i]!==t[r]){if(!t[i]||!t[r])return;var s=this.getSegmentId(t[i],t[r],e,o);if(!s)return;n.push(s)}}return n},x.prototype.setCaves=function(){for(var t=0;t<this.polygons.length;++t){var e=this.polygons[t],o=e.childrenPolygonIds.slice(0);this.getChildMaxPolygons(e,o)}},x.prototype.getChildPolygonInfo=function(t){if(t.length<2)return null;for(var e=[],o=[],n=0;n<this.polygons.length;++n){var i=this.polygons[n];t.indexOf(i.id)>-1&&(e=e.concat(i.pointIds),o=o.concat(i.segmentIds))}for(var r={},s={},l=0;l<e.length;++l)r[e[l]]=this.points[e[l]];for(var a=0;a<o.length;++a)s[o[a]]=this.segments[o[a]];return{points:r,segments:s}},x.prototype.getChildMaxPolygons=function(t,e){var o=this.getChildPolygonInfo(e);if(null!=o){var n=this.getStartPoint(o.points),i=[];i.push(n);var r=this.getNextForMinAngleX(n,o.points,o.segments);i.push(r);var s=this.getMaxPolygon(i,o.points,o.segments);s.pop(),t.caves.push(s);for(var l=0;l<e.length;++l)for(var a=this.getPolygon(e[l]),h=0;h<a.pointIds.length;++h)if(s.indexOf(a.pointIds[h])>-1){e.splice(l,1),--l;break}this.getChildMaxPolygons(t,e)}else if(1===e.length){var c=this.getPolygon(e[0]);t.caves.push(c.pointIds)}},x.prototype.getPolygon=function(t){for(var e=0;e<this.polygons.length;++e){var o=this.polygons[e];if(o.id===t)return o}return console.error("找不到多边形！"),null};var d=new x,f="Tag",v="LEFT",m="RIGHT",P=function(){this.len=null};P.prototype.setId=function(t){null==t||void 0===t?(t=a.getCurrentId(),a.updateCurrentId(),this.vectorId=this.geoType+t):this.vectorId=t},P.prototype.setSymbolPosition=function(t,e){"start"==e?c.clonePoint(this.startPoint,t):"end"==e&&c.clonePoint(this.endPoint,t)},P.prototype.setSymbolParent=function(t){this.parent=t},P.prototype.setPointParent=function(t,e){null==this.parent&&(this.parent={}),this.parent[t]=e},P.prototype.setOpenSide=function(t){var e=[];e.push(this.startPoint),e.push(this.endPoint),e.push(t);var o=null;o=c.isClockwise(e)?v:m,this.openSide=o},P.prototype.rotatePoint=function(t,e,o){var n=e.x,i=e.y,r=t.x,s=t.y;return{x:n+(r-n)*Math.cos(o*Math.PI/180)-(s-i)*Math.sin(o*Math.PI/180),y:i+(r-n)*Math.sin(o*Math.PI/180)+(s-i)*Math.cos(o*Math.PI/180)}};var b=function(t){function e(e,o){t.call(this),this.center=e,this.points2d=[],this.title="请输入名称",this.des=null,this.unit="m",this.name="标注",this.adding=!0,this.sideWidth=30,this.sideThickness=30,this.geoType=f,this.setId(o)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isContain=function(t){var e=[];return e.push(this.points2d[0]),e.push(this.points2d[1]),e.push(this.points2d[2]),e.push(this.points2d[3]),c.isPointInPoly(t,e)},e.prototype.setPoints2d=function(){this.points2d=[];var t=this.center.x-this.sideWidth/n.res*s/n.zoom/2,e=this.center.y-this.sideThickness/n.res*s/n.zoom/2,o=this.center.x+this.sideWidth/n.res*s/n.zoom/2,i=this.center.y+this.sideThickness/n.res*s/n.zoom/2,r={x:t,y:i},l={x:o,y:i},a={x:o,y:e},h={x:t,y:e};this.points2d.push(r),this.points2d.push(l),this.points2d.push(a),this.points2d.push(h);var c=(r.x-this.center.x)/2,p=(r.y-this.center.y)/2;this.points2d.push({x:r.x-c,y:r.y-p}),this.points2d.push({x:l.x+c,y:r.y-p}),this.points2d.push({x:this.center.x,y:r.y-p}),this.points2d.push({x:this.center.x,y:a.y+p})},e.prototype.setTitle=function(t){this.title=t},e.prototype.setDes=function(t){this.des=t},e.prototype.setUnit=function(t){this.unit=t},e.prototype.setAdding=function(t){this.adding=t},e}(P),S=function(){this.room_hallImg=null,this.room_defaultImg=null,this.room_otherImg=null};S.prototype.addRoom=function(t,o){e.floors[o].rooms.push(t)},S.prototype.getRoom=function(t,o){return e.floors[o].rooms[t]},S.prototype.getRooms=function(t){return e.floors[t].rooms},S.prototype.clearRooms=function(t){e.floors[t].rooms=[]},S.prototype.setHallImg=function(t){this.room_hallImg=t},S.prototype.getHallImg=function(){return this.room_hallImg},S.prototype.setDefaultImg=function(t){this.room_defaultImg=t},S.prototype.getDefaultImg=function(){return this.room_defaultImg},S.prototype.setOtherImg=function(t){this.room_otherImg=t},S.prototype.getOtherImg=function(){return this.room_otherImg};var I=new S,w=function(){};w.prototype.createTag=function(t,e,o){var n=new b(t,e);return n.setPoints2d(),a.addTag(n,o),n},w.prototype.setTagInfo=function(t){var e=a.getTag(t.vectorId);e.vectorId=t.vectorId,e.center=JSON.parse(JSON.stringify(t.center)),e.points2d=JSON.parse(JSON.stringify(t.points2d)),e.title=t.title,e.des=t.des,e.unit=t.unit,e.adding=t.adding},w.prototype.deleteTag=function(t){a.deleteTag(t)},w.prototype.convertUnit=function(t){for(var o=0;o<e.floors.length;++o){var n=e.floors[o].tags;for(var i in n){var r=n[i];r.unit!=t&&(r.unit=t)}}},w.prototype.getTags=function(t){return e.floors[t].tags};var M=new w,k=function(){this.points={},this.segments={},this.polygons=[],this.tempRooms=[]};k.prototype.start=function(){var t=e.floors;console.log("从头开始分房间！");for(var o=0;o<t.length;++o){var n=t[o].walls,i=t[o].points;I.clearRooms(o),this.getRoomForSingleFloor(n,i,o)}this.updateRoomsTagName()},k.prototype.getRoomForSingleFloor=function(t,e,o){this.getRooms(t,e,o);for(var n=0;n<this.tempRooms.length;++n){var i=this.tempRooms[n];i.floor=o;var r=new u(i.roomId,i.floor);r.setInfo({wallIds:i.wallIds,wallPointIDs:i.wallPointIDs,area:i.area,center:i.center,boundingBox:i.boundingBox,parent:i.parent,childrenWalls:i.childrenWalls,childrenRooms:i.childrenRooms}),I.addRoom(r,o)}this.tempRooms=[]},k.prototype.getRooms=function(t,e,o){this.convertToSegments(t,o),this.convertToPoints(e,o),d.start(this.segments,this.points),this.convertToRoomForPolygon(o),this.points={},this.segments={},this.polygons=[]},k.prototype.convertToPoints=function(t,e){for(var o in t){var n=a.getPoint(o,e),i={pointId:n.vectorId,x:n.x,y:n.y,parent:JSON.parse(JSON.stringify(n.parent))};this.points[n.vectorId]=i}},k.prototype.convertToSegments=function(t,e){for(var o in t){var n=a.getWall(o,e),i={segmentId:n.vectorId,start:n.start,end:n.end};this.segments[n.vectorId]=i}},k.prototype.convertToRoomForPolygon=function(){for(var t=0;t<d.polygons.length;++t){var e=d.polygons[t],o={};o.roomId=e.id.replace("Polygon","Room"),console.log("房间："+o.roomId),o.wallIds=e.segmentIds,o.wallPointIDs=e.pointIds,o.area=e.area,o.center=e.center,o.boundingBox=e.boundingBox,null!=e.parent?o.parent=e.parent.replace("Polygon","Room"):o.parent=null,o.childrenRooms=[];for(var n=0;n<e.childrenPolygonIds.length;++n)o.childrenRooms.push(e.childrenPolygonIds[n].replace("Polygon","Room"));o.childrenWalls=[];for(var i=0;i<e.childrenSegmentIds.length;++i)o.childrenWalls.push(e.childrenSegmentIds[i]);this.tempRooms.push(o)}d.polygons=[]},k.prototype.updateRoomsName=function(){for(var t=0;t<e.floors.length;++t){var o=I.getRooms(t),n=M.getTags(t);n=JSON.parse(JSON.stringify(n));for(var i=0;i<o.length;++i)o[i]}},k.prototype.updateRoomsTagName=function(){function t(t,e){return t.area-e.area}for(var o=0;o<e.floors.length;++o){var n=I.getRooms(o),i=M.getTags(o);i=JSON.parse(JSON.stringify(i)),n=n.sort(t);for(var r=0;r<n.length;++r){for(var s=n[r],l=[],h=0;h<s.wallPointIDs.length;++h){var p=a.getPoint(s.wallPointIDs[h],o);l.push(p)}for(var y in i)if(c.isPointInPoly(i[y].center,l)){s.tagName=i[y].title,delete i[y];break}}}};var T=new k,F={export:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a",lineWidth:3,lineWidth_out:5},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},cover:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},default:{Wall:{strokeStyle:"#70707a",fillStyle:"#70707a"},Symbol:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1},Component:{strokeStyle:"rgba(37,40,40,0.5)",fillStyle:"rgba(0,0,0,0.1)",lineWidth:1}},Font:{font:"12px Microsoft YaHei",fillStyle:"rgba(0,0,0,1)",textAlign:"center",textBaseline:"middle",miterLimit:10,direction:"ltr"},Measure:{strokeStyle:"#70707a"}},B=function(){this.context=null};B.prototype.initContext=function(t){this.context=t},B.prototype.clear=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},B.prototype.drawWall=function(t,e){var o=a.getPoint(t.start),n=a.getPoint(t.end),i=[];i.push(o);for(var r=0;r<t.children.length;++r){var s=a.getSymbol(t.children[r]);i.push(s.startPoint),i.push(s.endPoint)}i.push(n),i=i.sort(function(t,e){return mathUtil.getDistance(o,t)-mathUtil.getDistance(o,e)}.bind(this)),this.context.save(),this.context.beginPath(),"export"==e?(t.out||t.important?this.context.lineWidth=F.export.Wall.lineWidth_out:this.context.lineWidth=F.export.Wall.lineWidth,this.context.strokeStyle=F.export.Wall.strokeStyle,this.context.fillStyle=F.export.Wall.fillStyle):"cover"==e?(t.out||t.important?this.context.lineWidth=F.cover.Wall.lineWidth_out:this.context.lineWidth=F.cover.Wall.lineWidth,this.context.strokeStyle=F.cover.Wall.strokeStyle,this.context.fillStyle=F.cover.Wall.fillStyle):"default"==e&&(t.out||t.important?this.context.lineWidth=F.default.Wall.lineWidth_out:this.context.lineWidth=F.default.Wall.lineWidth,this.context.strokeStyle=F.default.Wall.strokeStyle,this.context.fillStyle=F.default.Wall.fillStyle),this.context.lineCap="round";for(var l=0;l<i.length-1;l+=2){var h=coordinate.getScreenXY(i[l]),c=coordinate.getScreenXY(i[l+1]);this.context.moveTo(h.x,h.y),this.context.lineTo(c.x,c.y)}this.context.stroke(),this.context.restore();var p={x:(o.x+n.x)/2,y:(o.y+n.y)/2};this.drawText(p,t.vectorId)},B.prototype.drawText=function(t,e,o,n){this.context.save(),this.setCanvasStyle(F.Font),coordinate.ratio==Constant.ratio?this.context.font="36px Microsoft YaHei":this.context.font="12px Microsoft YaHei";var i={x:t.x,y:t.y};o||(i=coordinate.getScreenXY({x:t.x,y:t.y})),n?(this.context.translate(i.x,i.y),this.context.rotate(n),this.context.strokeText(e,0,0),this.context.fillText(e,0,0)):(this.context.strokeText(e,i.x,i.y),this.context.fillText(e,i.x,i.y)),this.context.restore()},B.prototype.drawSingleDoor=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});var i=mathUtil.getDistance(o[0],o[1]);this.context.save(),this.context.lineCap="square",this.context.lineWidth=1,"export"==type?(this.context.strokeStyle=F.export.strokeStyle,this.context.fillStyle=F.export.fillStyle):"cover"==type?(this.context.strokeStyle=F.cover.strokeStyle,this.context.fillStyle=F.export.fillStyle):"default"==type&&(this.context.strokeStyle=F.default.strokeStyle,this.context.fillStyle=F.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.arcTo(o[2].x,o[2].y,o[3].x,o[3].y,i),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawImg(t)},B.prototype.drawDoubleDoor=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});var i=mathUtil.getDistance(o[0],o[1]);this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=F.export.strokeStyle,this.context.fillStyle=F.export.fillStyle):"cover"==type?(this.context.strokeStyle=F.cover.strokeStyle,this.context.fillStyle=F.export.fillStyle):"default"==type&&(this.context.strokeStyle=F.default.strokeStyle,this.context.fillStyle=F.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.arcTo(o[4].x,o[4].y,o[5].x,o[5].y,i),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[1].x,o[1].y),this.context.arcTo(o[4].x,o[4].y,o[3].x,o[3].y,i),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawImg(t)},B.prototype.drawSlideDoor=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=F.export.strokeStyle,this.context.fillStyle=F.export.fillStyle):"cover"==type?(this.context.strokeStyle=F.cover.strokeStyle,this.context.fillStyle=F.export.fillStyle):"default"==type&&(this.context.strokeStyle=F.default.strokeStyle,this.context.fillStyle=F.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.lineTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.closePath(),this.context.stroke(),this.context.beginPath(),this.context.moveTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.lineTo(o[6].x,o[6].y),this.context.lineTo(o[7].x,o[7].y),this.context.closePath(),this.context.stroke(),this.context.restore(),null!=t.enter&&this.drawImg(t)},B.prototype.drawSingleWindow=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=F.export.strokeStyle,this.context.fillStyle=F.export.fillStyle):"cover"==type?(this.context.strokeStyle=F.cover.strokeStyle,this.context.fillStyle=F.export.fillStyle):"default"==type&&(this.context.strokeStyle=F.default.strokeStyle,this.context.fillStyle=F.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.stroke(),this.context.beginPath(),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.lineTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.closePath(),this.context.stroke(),this.context.restore()},B.prototype.drawBayWindow=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=F.export.strokeStyle,this.context.fillStyle=F.export.fillStyle):"cover"==type?(this.context.strokeStyle=F.cover.strokeStyle,this.context.fillStyle=F.export.fillStyle):"default"==type&&(this.context.strokeStyle=F.default.strokeStyle,this.context.fillStyle=F.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.lineTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.closePath(),this.context.stroke(),this.context.fill(),this.context.beginPath(),this.context.moveTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.lineTo(o[6].x,o[6].y),this.context.lineTo(o[7].x,o[7].y),this.context.closePath(),this.context.stroke(),this.context.restore()},B.prototype.drawFrenchWindow=function(t){for(var e=t.points2d,o=[],n=0;n<e.length;++n)o[n]=coordinate.getScreenXY({x:e[n].x,y:e[n].y});this.context.save(),this.context.lineWidth=1,this.context.lineCap="square","export"==type?(this.context.strokeStyle=F.export.strokeStyle,this.context.fillStyle=F.export.fillStyle):"cover"==type?(this.context.strokeStyle=F.cover.strokeStyle,this.context.fillStyle=F.export.fillStyle):"default"==type&&(this.context.strokeStyle=F.default.strokeStyle,this.context.fillStyle=F.export.fillStyle),this.context.beginPath(),this.context.moveTo(o[0].x,o[0].y),this.context.lineTo(o[1].x,o[1].y),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[3].x,o[3].y),this.context.moveTo(o[4].x,o[4].y),this.context.lineTo(o[5].x,o[5].y),this.context.moveTo(o[2].x,o[2].y),this.context.lineTo(o[4].x,o[4].y),this.context.moveTo(o[3].x,o[3].y),this.context.lineTo(o[5].x,o[5].y),this.context.moveTo(o[6].x,o[6].y),this.context.lineTo(o[7].x,o[7].y),this.context.stroke(),this.context.restore()},B.prototype.drawMeasure=function(){};var O=new B,W=function(){this.cadBoundingBox=null,this.padding={export:165,cover:35,default:102},this.type=null};W.prototype.init=function(){this.cadBoundingBox=a.getBoundingBox()},W.prototype.start=function(){this.setType("export"),this.test(),this.setType("cover"),this.test(),this.setType("default"),this.test(),this.recovery()},W.prototype.setType=function(t){this.type=t},W.prototype.autoDraw=function(){var t=a.getFloorData(),e=t.walls;for(var o in e)this.drawGeometry(e[o]);var n=t.symbols;for(var i in n)this.drawGeometry(n[i])},W.prototype.getSize=function(){if("export"==this.type)n.width=900,n.height=900;else if("cover"==this.type){var t=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*1.42+2*this.padding.cover,e=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*1.42+2*this.padding.cover;F.cover.Wall.lineWidth_out=Math.ceil(.0055*Math.max(t,e)),F.cover.Wall.lineWidth=Math.ceil(.0055*Math.max(t,e)/1.5),t=Math.ceil(t+F.cover.Wall.lineWidth_out/2),e=Math.ceil(e+F.cover.Wall.lineWidth_out/2),n.width=t,n.height=e}else if("default"==this.type){var o=50*Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX)*1.42+2*this.padding.default,i=50*Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY)*1.42+2*this.padding.default;F.default.Wall.lineWidth_out=Math.ceil(.0055*Math.max(o,i)),F.cover.Wall.lineWidth=Math.ceil(.0055*Math.max(o,i)/1.5),o=Math.ceil(o+F.cover.Wall.lineWidth_out/2),i=Math.ceil(i+F.cover.Wall.lineWidth_out/2),n.width=o,n.height=i}},W.prototype.test=function(){this.layer.uiControl.menu_flex(),T.start(),y.updateRegion(!0),y.update();var t,e,o=this.layer.canvas;this.getSize(),("export"==this.type||"cover"==this.type||"default"==this.type)&&(t=(n.width-pad.left-pad.right)/Math.abs(this.cadBoundingBox.maxX-this.cadBoundingBox.minX),e=(n.height-pad.top-pad.bottom)/Math.abs(this.cadBoundingBox.maxY-this.cadBoundingBox.minY),n.res=Math.min(t,e),o.width=n.width,o.height=n.height),this.autoDraw(),this.downloadCadImg(o,"floorPlan.png")},W.prototype.recovery=function(){var t=this.layer.app.core.get("CameraControls").activeControl.camera;n.updateForCanvas(canvas),n.setRes(t.left,t.right),this.layer.renderer.autoRedraw()},W.prototype.downloadCadImg=function(t,e){var o=t.toDataURL("png",3);o=o.replace(this._fixType("png"),"image/octet-stream"),this.saveFile(o,e)},W.prototype.saveFile=function(t,e){var o=document.createElementNS("http://www.w3.org/1999/xhtml","a");o.href=t,o.download=e;var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(n)},W.prototype._fixType=function(t){return"image/"+(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|bmp|gif/)[0]},W.prototype.drawGeometry=function(t){if(null!=O.context)switch(t.geoType){case VectorType.Wall:O.drawWall(t,this.type);break;case VectorType.SingleDoor:O.drawSingleDoor(t);break;case VectorType.DoubleDoor:O.drawDoubleDoor(t);break;case VectorType.SlideDoor:O.drawSlideDoor(t);break;case VectorType.SingleWindow:O.drawSingleWindow(t);break;case VectorType.FrenchWindow:O.drawFrenchWindow(t);break;case VectorType.BayWindow:O.drawBayWindow(t);break;case VectorType.Beam:O.drawBeam(t,this.type);break;case VectorType.Flue:O.drawFlue(t,this.type);break;case VectorType.Corridor:O.drawCorridor(t,this.type);break;case VectorType.Tag:O.drawTag(t,this.type)}};var C=new W,R=function(t,e){this.app=t,this.ajkJson={},this.cameraJson={},this.floorPlanJson={},this.file1=null,this.file2=null,this.file3=null,this.cameraJson.sweepLocations=e.sweepLocations};return R.prototype.init=function(){},R.prototype.startSync=function(){var t=this;this.getFloorPlanJson().then((function(e){a.updateBoundingBox(),t.getAJKRooms(),t.getEntrance(),t.getSceneName(),t.getPictureRotate(),t.getImgInfo()})),C.layer=this.app.CadManager.cad(),C.layer.renderer.clear(),C.start()},R.prototype.getAJKRooms=function(){var t=[],e=a.getTags(),o=JSON.parse(JSON.stringify(a.getRooms()));for(var n in e){var r={},s=e[n],l={};r.area=s.des,r.name=s.title,r.tagId=s.vectorId,r.floor=i;var h=null;h=this.cameraJson.sweepLocations[0].puck;for(var c=1;c<this.cameraJson.sweepLocations.length;++c)mathUtil.getDistance(s.center,this.cameraJson.sweepLocations[c].puck)<mathUtil.getDistance(s.center,h)&&(h=this.cameraJson.sweepLocations[c]),this.cameraJson.sweepLocations.group=-1;l.x=h.x,l.y=h.y,l.z=0;for(var p=1;p<o.length;++p){if(o[p].containPoint(l)){r.group=o[p].replace("Room",""),o.splice(p,1),h.group=r.group;break}}r.labelPos=l,r.group&&t.push(r)}this.ajkJson.rooms=t},R.prototype.getCameraJson=function(){},R.prototype.getFloorPlanJson=function(){var t=this;return this.app.store.get("floor",(function(e){return t.floorPlanJson=e,e}))},R.prototype.getEntrance=function(t){var e=a.getSymbols(t),o=null;for(var n in e)if((o=e[n]).enter)break;if(null!=o&&o.enter){var i=this.layer.app.core.get("Player").model.floors[t].boundingBox.min.y+.1,r=new THREE.Vector3(o.start.x,i+.4*.2,-o.start.y),s=new THREE.Vector3(o.end.x,i+.4*.2,-o.end.y),l=r.clone().add(s).multiplyScalar(.5),h=new THREE.Vector3(o.points2d[3].x,i+.4*.2,o.points2d[3].y);h.z*=-1;var c=this.getFootPoint(h,r,s),p=h.clone().sub(c).normalize();l.clone().negate().angleTo(p)>Math.PI/2&&(l.add(p.clone().multiplyScalar(r.distanceTo(s))),p.multiplyScalar(-1)),l.add(p.clone().multiplyScalar(-.5));var y={Position:new THREE.Vector3(l.x,-l.z,l.y),Direction:new THREE.Vector3(p.x,-p.z,p.y)};this.ajkJson.Entrance=y}},R.prototype.getSceneName=function(){var t=this.app.store.getValue("metadata");this.ajkJson.scene_name=t.title},R.prototype.getPictureRotate=function(){var t=a.getAngle(),e=new THREE.Euler(0,t,0),o=new THREE.Vector3(0,0,-1);o.applyEuler(e),o=new THREE.Vector3(o.x,-o.z,o.y),this.ajkJson.picture_rotate=o},R.prototype.getFootPoint=function(t,e,o,n){var i=t.clone().sub(e),r=e.clone().sub(o),s=r.length(),l=i.dot(r)/s,a=e.clone().add(r.multiplyScalar(l/s));return n&&a.clone().sub(e).dot(a.clone().sub(o))>0&&(a=a.distanceTo(e)<a.distanceTo(o)?e.clone():o.clone()),a},R.prototype.getImgInfo=function(){var t=a.getCadInfo(this.layer.canvas),e={};e.bound=t.bound,e.margin=51,e.marginReal=e.margin/coordinate.res,e.width=Math.abs(t.bound.left-t.bound.right),e.center={x:(t.bound.left+t.bound.right)/2,y:(t.bound.top+t.bound.bottom)/2},this.ajkJson.img_info=e},function(t,e){void 0===e&&(e={});var o=KanKan.Deferred();return t.Scene.on("loaded",(function(){var n=new R(t,e);n.$name="DataAJK",n.$load=function(){t.DataSYNC.install(n)},o.resolve(n)})),o}}();
