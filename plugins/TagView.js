var TagView=function(){"use strict";var t=KanKan.Viewmode,n=function(n){function i(i,r){var a=this;n.call(this),this.app=i,this.options=r||{},this.sid=null,this.$tag=null,this.tags=null,this.tags_dom={},this.isLoad=!1,this.isPositioning=!1,this.player=null,this.app.TagManager.on("update",(function(n){a.tags&&a.tags.length&&(a.player||(a.player=a.app.core.get("Player")),a.tags.forEach((function(n){if(a.tags_dom[n.sid]){if(a.player.mode!=t.PANORAMA||!n.visiblePanos.includes(a.player.currentPano))return a.tags_dom[n.sid].style.display="none";var i=a.app.TagManager.convertPositionTo2D(n.position);return n.x=i.pos.x,n.y=i.pos.y,a.tags_dom[n.sid].style.transform="translate("+i.pos.x+"px,"+i.pos.y+"px)",i.trueSide&&i.inSight?a.player.mode!=t.PANORAMA&&a.app.TagManager.ifShelter(n.position,i)?a.tags_dom[n.sid].style.display="none":void(a.tags_dom[n.sid].style.display="block"):a.tags_dom[n.sid].style.display="none"}})),n.hasChanged.cameraChanged3?a.waitToAimAtTag(!1):a.waitToAimAtTag(!0))}))}return n&&(i.__proto__=n),i.prototype=Object.create(n&&n.prototype),i.prototype.constructor=i,i.prototype.load=function(t){this.isLoad=!0,this.tags=(t||{}).tags||[],this._insertHTML()},i.prototype.focus=function(t){var n=this;return new Promise((function(i){var r=n.tags.find((function(n){return n.sid==t}));if(!r)return i();var a=n.player,e=a.model.panos.closestPanoTowardPoint({point:r.position,getAll:!0}).map((function(t){return t.pano})).filter((function(t){return r.visiblePanos.indexOf(t)>-1&&t.position.clone().setY(r.position.y).sub(r.position).length()>1.5})),o=e[0],s=e.filter((function(t){return t.floorIndex==a.model.currentFloor.floorIndex}));s.length>0&&(o=s[0]),o||(console.warn("该热点无可视点位"),o=a.currentPano),a.flyToPano({pano:o,lookAtPoint:r.position},(function(){n.isPositioning=!1,i()}))}))},i.prototype._insertHTML=function(){var t=this,n=[],i=this.options.render||function(){};this.tags_dom={},this.tags.forEach((function(r){r.visiblePanos=t.app.TagManager.getVisiblePano(r.position),n.push('\n                <div data-tag-id="'+r.sid+'" data-tag-type="'+r.type+'">\n                    '+(i(r)||'<span class="tag-icon animate" style="background-image:url({{icon}})"></span>').replace(/\{\{(\w+)\}\}/g,(function(n,i){return"icon"===i?r[i]?t.app.resource.getUserResourceURL(r[i]):t.app.resource.base("images/tag_icon_default.svg"):r[i]}))+"\n                </div>\n            ")})),document.querySelector("[xui_tags_view]").innerHTML=n.join(""),document.querySelectorAll("[data-tag-id]").forEach((function(n){var i=n.getAttribute("data-tag-id");i&&(t.tags_dom[i]=n),n.addEventListener("mouseenter",(function(n){t.emit("mouseenter",n)})),n.addEventListener("mouseleave",(function(n){t.emit("mouseleave",n)})),n.addEventListener("click",(function(n){n.preventDefault(),n.stopPropagation(),n.data=t.tags.find((function(t){return t.sid==i})),t.emit("click",n)}))}))},i.prototype.aimAtTag=function(){var t=this.player.getDirection(),n=1/0,i=null;for(var r in this.tags){var a=this.tags[r],e=a.position.clone().sub(this.player.position).angleTo(t);e<n&&(n=e,i=a)}if(i){if(this.activeTag&&this.activeTag==i)return;this.activeTag=i,this.$tag=this.tags_dom[this.activeTag.sid],this.emit("focus",{data:this.activeTag,target:this.$tag})}},i.prototype.waitToAimAtTag=function(t){var n=this;t?this.aimAtTagTimer||(this.aimAtTagTimer=setTimeout((function(){n.aimAtTag()}),200)):this.aimAtTagTimer&&(clearTimeout(this.aimAtTagTimer),this.aimAtTagTimer=null)},i}(KanKan.MITT.Emiter);return function(t,i){var r=KanKan.Deferred();return t.Scene.on("loaded",(function(){var a=new n(t,i);a.$name="TagView",a.$html="<div xui_tags_view></div> <style> [xui_tags_view] {\r\n        position: absolute;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n    [xui_tags_view] > div {\r\n        pointer-events: all;\r\n        display: none;\r\n        position: absolute;\r\n        width: 48px;\r\n        height: 48px;\r\n        margin-left: -24px;\r\n        margin-top: -24px;\r\n    }\r\n\r\n    [xui_tags_view] .tag-icon {\r\n        display: block;\r\n        width: 48px;\r\n        height: 48px;\r\n        background-size: cover;\r\n        cursor: pointer;\r\n    }\r\n\r\n    [xui_tags_view] .tag-icon.animate {\r\n        animation: tag-animate-zoom 3s -1s linear infinite;\r\n    }\r\n\r\n    /* [xui_tags_view] > div.open,\r\n    [xui_tags_view] > div.hover{\r\n        z-index: 999;\r\n    }\r\n\r\n    [xui_tags_view] > div.open .tag-billboard,\r\n    [xui_tags_view] > div.hover .tag-billboard {\r\n        transform: translateY(-50%) scale(1);\r\n       \r\n    }\r\n    [xui_tags_view] .tag-body .tag-billboard {\r\n        padding: 0 40px 0 0;\r\n        position: absolute;\r\n        right: 35px;\r\n        top: 50%;\r\n        min-width: 420px;\r\n        min-height: 60px;\r\n        z-index: 1000;\r\n        transform: translateY(-50%) scale(0);\r\n        transform-origin: center right;\r\n        transition: all 0.3s cubic-bezier(0.35, 0.32, 0.65, 0.63);\r\n        pointer-events: none;\r\n    }\r\n    [xui_tags_view] .tag-body .tag-billboard::before {\r\n        pointer-events: all;\r\n        content: '';\r\n        position: absolute;\r\n        top: 50%;\r\n        right: 1px;\r\n        width: 0;\r\n        height: 0;\r\n        border-top: 15px solid transparent;\r\n        border-bottom: 15px solid transparent;\r\n        border-left: 40px solid rgba(27, 27, 28, 0.8);\r\n        transform: translateY(-50%);\r\n    }\r\n    [xui_tags_view] .tag-body .tag-billboard-content {\r\n        pointer-events: auto;\r\n        background: rgba(27, 27, 28, 0.8);\r\n        border-radius: 4px;\r\n        min-width: 400px;\r\n        padding: 30px 20px;\r\n        color: #fff;\r\n    } */\r\n\r\n    @keyframes tag-animate-zoom {\r\n        0% {\r\n            transform: scale(1);\r\n        }\r\n        50% {\r\n            transform: scale(0.7);\r\n        }\r\n        100% {\r\n            transform: scale(1);\r\n        }\r\n    } </style> ",a.$load=function(){t.TagManager.install("view",a)},r.resolve(a)})),r}}();
