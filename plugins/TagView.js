var TagView=function(t){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=n(t),r=i.default.Viewmode,a=function(t){function n(n,i){var a=this;t.call(this),this.app=n,this.options=i||{},this.sid=null,this.$tag=null,this.tags=null,this.tags_dom={},this.isLoad=!1,this.isPositioning=!1,this.player=null,this.app.TagManager.on("update",(function(t){a.tags&&a.tags.length&&(a.player||(a.player=a.app.core.get("Player")),a.tags.forEach((function(t){if(a.tags_dom[t.sid]){if(a.player.mode!=r.PANORAMA||!t.visiblePanos.includes(a.player.currentPano))return a.tags_dom[t.sid].style.display="none";var n=a.app.TagManager.convertPositionTo2D(t.position);return t.x=n.pos.x,t.y=n.pos.y,a.tags_dom[t.sid].style.transform="translate("+n.pos.x+"px,"+n.pos.y+"px)",n.trueSide&&n.inSight?a.player.mode!=r.PANORAMA&&a.app.TagManager.ifShelter(t.position,n)?a.tags_dom[t.sid].style.display="none":void(a.tags_dom[t.sid].style.display="block"):a.tags_dom[t.sid].style.display="none"}})),t.hasChanged.cameraChanged3?a.waitToAimAtTag(!1):a.waitToAimAtTag(!0))}))}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n.prototype.load=function(t){this.isLoad=!0,this.tags=(t||{}).tags||[],this._insertHTML()},n.prototype.focus=function(t){var n=this,i=this.tags.find((function(n){return n.sid==t}));if(i){var r=this.player,a=r.model.panos.closestPanoTowardPoint({point:i.position,getAll:!0}).map((function(t){return t.pano})).filter((function(t){return i.visiblePanos.indexOf(t)>-1&&t.position.clone().setY(i.position.y).sub(i.position).length()>1.5})),e=a[0],o=a.filter((function(t){return t.floorIndex==r.model.currentFloor.floorIndex}));o.length>0&&(e=o[0]),e||(console.warn("该热点无可视点位"),e=r.currentPano),r.flyToPano({pano:e,lookAtPoint:i.position},(function(){n.isPositioning=!1}))}},n.prototype._insertHTML=function(){var t=this,n=[],i=this.options.render||function(){};this.tags_dom={},this.tags.forEach((function(r){r.visiblePanos=t.app.TagManager.getVisiblePano(r.position),n.push('\n                <div data-tag-id="'+r.sid+'" data-tag-type="'+r.type+'">\n                    '+(i(r)||'<span class="tag-icon animate" style="background-image:url({{icon}})"></span>').replace(/\{\{(\w+)\}\}/g,(function(n,i){return"icon"===i?r[i]?t.app.resource.getUserResourceURL(r[i]):t.app.resource.base("images/tag_icon_default.svg"):r[i]}))+"\n                </div>\n            ")})),document.querySelector("[xui_tags_view]").innerHTML=n.join(""),document.querySelectorAll("[data-tag-id]").forEach((function(n){var i=n.getAttribute("data-tag-id");i&&(t.tags_dom[i]=n),n.addEventListener("mouseenter",(function(n){t.emit("mouseenter",n)})),n.addEventListener("mouseleave",(function(n){t.emit("mouseleave",n)})),n.addEventListener("click",(function(n){n.preventDefault(),n.stopPropagation(),n.data=t.tags.find((function(t){return t.sid==i})),t.emit("click",n)}))}))},n.prototype.aimAtTag=function(){var t=this.player.getDirection(),n=1/0,i=null;for(var r in this.tags){var a=this.tags[r],e=a.position.clone().sub(this.player.position).angleTo(t);e<n&&(n=e,i=a)}if(i){if(this.activeTag&&this.activeTag==i)return;this.activeTag=i,this.$tag=this.tags_dom[this.activeTag.sid],this.emit("focus",{data:this.activeTag,target:this.$tag})}},n.prototype.waitToAimAtTag=function(t){var n=this;t?this.aimAtTagTimer||(this.aimAtTagTimer=setTimeout((function(){n.aimAtTag()}),200)):this.aimAtTagTimer&&(clearTimeout(this.aimAtTagTimer),this.aimAtTagTimer=null)},n}(i.default.MITT.Emiter);return function(t,n){var r=i.default.Deferred();return t.Scene.on("loaded",(function(){var i=new a(t,n);i.$name="TagView",i.$html="<div xui_tags_view></div> <style> [xui_tags_view] {\r\n        position: absolute;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n    [xui_tags_view] > div {\r\n        pointer-events: all;\r\n        display: none;\r\n        position: absolute;\r\n        width: 48px;\r\n        height: 48px;\r\n        margin-left: -24px;\r\n        margin-top: -24px;\r\n    }\r\n\r\n    [xui_tags_view] .tag-icon {\r\n        display: block;\r\n        width: 48px;\r\n        height: 48px;\r\n        background-size: cover;\r\n        cursor: pointer;\r\n    }\r\n\r\n    [xui_tags_view] .tag-icon.animate {\r\n        animation: tag-animate-zoom 3s -1s linear infinite;\r\n    }\r\n\r\n    /* [xui_tags_view] > div.open,\r\n    [xui_tags_view] > div.hover{\r\n        z-index: 999;\r\n    }\r\n\r\n    [xui_tags_view] > div.open .tag-billboard,\r\n    [xui_tags_view] > div.hover .tag-billboard {\r\n        transform: translateY(-50%) scale(1);\r\n       \r\n    }\r\n    [xui_tags_view] .tag-body .tag-billboard {\r\n        padding: 0 40px 0 0;\r\n        position: absolute;\r\n        right: 35px;\r\n        top: 50%;\r\n        min-width: 420px;\r\n        min-height: 60px;\r\n        z-index: 1000;\r\n        transform: translateY(-50%) scale(0);\r\n        transform-origin: center right;\r\n        transition: all 0.3s cubic-bezier(0.35, 0.32, 0.65, 0.63);\r\n        pointer-events: none;\r\n    }\r\n    [xui_tags_view] .tag-body .tag-billboard::before {\r\n        pointer-events: all;\r\n        content: '';\r\n        position: absolute;\r\n        top: 50%;\r\n        right: 1px;\r\n        width: 0;\r\n        height: 0;\r\n        border-top: 15px solid transparent;\r\n        border-bottom: 15px solid transparent;\r\n        border-left: 40px solid rgba(27, 27, 28, 0.8);\r\n        transform: translateY(-50%);\r\n    }\r\n    [xui_tags_view] .tag-body .tag-billboard-content {\r\n        pointer-events: auto;\r\n        background: rgba(27, 27, 28, 0.8);\r\n        border-radius: 4px;\r\n        min-width: 400px;\r\n        padding: 30px 20px;\r\n        color: #fff;\r\n    } */\r\n\r\n    @keyframes tag-animate-zoom {\r\n        0% {\r\n            transform: scale(1);\r\n        }\r\n        50% {\r\n            transform: scale(0.7);\r\n        }\r\n        100% {\r\n            transform: scale(1);\r\n        }\r\n    } </style> ",i.$load=function(){t.TagManager.install("view",i)},r.resolve(i)})),r}}(KanKan);
