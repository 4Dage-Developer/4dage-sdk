var TourRecorder=function(){"use strict";var e=KanKan.Animate.transitions,t="floorplan",r={flydown:{movementEasing:"easeInOutQuad",movementDelay:.001,rotationEasing:"easeInOutQuad",rotationDelay:.5,modelTextureDelay:.75,skyboxDelay:.75}};r.freeze=Object.freeze({FlyToPano:e.getUniqueId(),FlyToNewMode:e.getUniqueId(),FlyToSameMode:e.getUniqueId(),FlyToViewFloor:e.getUniqueId(),LookTransition:e.getUniqueId(),ZoomTransition:e.getUniqueId(),LookRotationForPlay:e.getUniqueId(),wallLineShine:e.getUniqueId(),spotShine:e.getUniqueId(),rulerShine:e.getUniqueId(),outsideFocus:e.getUniqueId(),shopCircle:e.getUniqueId()});var a=function(a){function o(e,t){var r=this;a.call(this),this.app=e,this.player=e.core.get("Player"),this.tours=e.TourManager.tours,this.partId=0,this.frameId=0,this._change=function(){r.emit("change",r.tours)},this._checkLastFrame=function(){if(r.tours.length)if(1==r.tours.length){var e=r.tours[0].list;if(e&&e.length){var t=null;e.forEach((function(e){delete e._end,delete e._notrans,null==t||"panorama"==t.enter.mode&&"panorama"==e.enter.mode&&t.enter.panoId!=e.enter.panoId||(t._notrans=!0),t=e})),e.length>0&&(e[e.length-1]._end=!0)}}else for(var a=!1,o=(t=null,r.tours.length-1);o>=0;o--)r.tours[o].list.forEach((function(e,r){delete e._end,delete e._notrans,null==t||"panorama"==t.enter.mode&&"panorama"==e.enter.mode&&t.enter.panoId!=e.enter.panoId||(t._notrans=!0),t=e})),r.tours[o].list.length>0&&(a||(a=!0,r.tours[o].list[r.tours[o].list.length-1]._end=!0))}}return a&&(o.__proto__=a),o.prototype=Object.create(a&&a.prototype),o.prototype.constructor=o,o.prototype.getPart=function(){return this.tours[this.partId]},o.prototype.addPart=function(e){var t={sid:this.app.TourManager.uuid(),name:e||"片段",list:[],music:"",musicName:""};0===this.tours.length||this.tours.length-1==this.partId?this.tours.push(t):this.tours.splice(this.partId+1,0,t),this._checkLastFrame(),this._change()},o.prototype.setPart=function(e,t){void 0===t&&(t={});var r=this.tours[e];if(r)for(var a in t)r.hasOwnProperty(a)&&(r[a]=t[a],"music"==a&&this.app.TourManager.audioPlayer.add(r));this._change()},o.prototype.selectPart=function(e){var t=this;if(!isNaN(e)){var r=this.tours[e];return r?(this.partId=e,this.frameId=0,this.app.TourManager.player.then((function(e){e.selectPart(t.partId)})),r):void 0}},o.prototype.deletePart=function(e){!isNaN(e)&&this.tours[e]&&(this.tours[e+1]||(this.partId=0),this.tours.splice(e,1),this._checkLastFrame(),this._change())},o.prototype.setPartCover=function(e){if(!isNaN(e)){var t=this.tours[this.partId];-1==e&&delete t.frameId,t&&t.list[e]&&(t.frameId=e),this._change()}},o.prototype.getFrame=function(){var e=this.tours[this.partId];if(e)return e.list[this.frameId]},o.prototype.addFrame=function(){var e=this;this.app.Camera.screenshot([{width:360,height:240,name:"200"}],!1).then((function(t){e.player.getSize();var r={sid:e.app.TourManager.uuid(),enter:{mode:e.player.mode,panoId:(e.player.currentPano||{id:null}).id,qua:e.parseJSONForQua(e.player.quaternion),pos:JSON.parse(JSON.stringify(e.player.position)),target:{x:e.player.cameraControls.activeControl.target.x,y:e.player.cameraControls.activeControl.target.y,z:e.player.cameraControls.activeControl.target.z},currentScale:"panorama"!=e.player.mode?e.player.cameraControls.activeControl.currentScale:null,cover:t[0].data,floor:null==e.player.model.currentFloorId?e.player.model.currentFloor.floorIndex:e.player.model.currentFloorId},exit:{},time:3e3,rotateRange:35,rotateType:"L",transitType:"normal"};if(e.tours.length){var a=e.tours[e.partId].list;a.length-1==e.frameId?a.push(r):a.splice(e.frameId+1,0,r)}else e.tours.push({sid:e.app.TourManager.uuid(),name:"片段",list:[r],music:"",musicName:""}),e.partId=0,e.frameId=0;e._checkLastFrame(),e._change()}))},o.prototype.setFrame=function(e,t){var r=this.tours[this.partId].list[e];r&&Object.assign(r,t),this._change()},o.prototype.setFrames=function(e){this.tours.forEach((function(t){t.list.forEach((function(t){Object.assign(t,e)}))})),this._change()},o.prototype.setEnter=function(e){var t=this;null!=e&&(this.frameId=e);var r=this.tours[this.partId].list[this.frameId];return r?r.enter.mode!=this.player.mode?Promise.reject({errType:2,errMsg:"模式不一致"}):r.enter.panoId&&r.enter.panoId!=this.player.currentPano.id?Promise.reject({errType:2,errMsg:"点位不一致"}):this.app.Camera.screenshot([{width:360,height:240,name:"200"}],!1).then((function(e){return t.player.getSize(),r.enter={mode:t.player.mode,panoId:(t.player.currentPano||{id:null}).id,qua:JSON.parse(JSON.stringify(t.player.quaternion)),pos:JSON.parse(JSON.stringify(t.player.position)),currentScale:"panorama"!=t.player.mode?t.player.cameraControls.activeControl.currentScale:null,cover:e[0].data},t._change(),r})):Promise.reject({errType:1,errMsg:"数据不存在"})},o.prototype.setExit=function(e){var t=this;null!=e&&(this.frameId=e);var r=this.tours[this.partId].list[this.frameId];return r?r.enter.mode!=this.player.mode?Promise.reject({errType:2,errMsg:"模式不一致"}):r.enter.panoId&&r.enter.panoId!=this.player.currentPano.id?Promise.reject({errType:2,errMsg:"点位不一致"}):this.app.Camera.screenshot([{width:360,height:240,name:"200"}],!1).then((function(e){return t.player.getSize(),r.exit={mode:t.player.mode,panoId:(t.player.currentPano||{id:null}).id,qua:t.parseJSONForQua(t.player.quaternion),pos:JSON.parse(JSON.stringify(t.player.position)),currentScale:"panorama"!=t.player.mode?t.player.cameraControls.activeControl.currentScale:null,cover:e[0].data},t._change(),r})):Promise.reject({errType:1,errMsg:"数据不存在"})},o.prototype.selectFrame=function(e){var t=this;return new Promise((function(r){if(isNaN(e))return r(null);t.tours[t.partId].list[e]?(t.frameId=e,t.app.TourManager.player.then((function(e){e.selectFrame(t.frameId).then((function(){return r()}))}))):r()}))},o.prototype.playForRotateForDollAndFloor=function(a,o,n,i,s,l,u){var p=this.app.core.get("Player");e.start(KanKan.Animate.lerp.vector(p.cameraControls.activeControl.target,new THREE.Vector3(o.x,o.y,o.z),s),u,null,0,KanKan.Animate.easing[r.flydown.rotationEasing],null,r.freeze.LookRotationForPlay),e.start(KanKan.Animate.lerp.vector(p.cameraControls.activeControl.camera.position,a),u,l,0,KanKan.Animate.easing[r.flydown.rotationEasing],null,r.freeze.LookRotationForPlay),i==t&&p.cameraControls.activeControl.absoluteScale!=n&&e.start(KanKan.Animate.lerp.property(p.cameraControls.activeControl,"absoluteScale",n,function(e){p.cameraControls.activeControl&&(p.cameraControls.activeControl.currentScale=e,"PerspectiveCamera"!=p.cameraControls.activeControl.camera.type&&p.cameraControls.activeControl.updateZoom())}.bind(this)),u,null,0,KanKan.Animate.easing[r.flydown.rotationEasing],null,r.freeze.LookRotationForPlay)},o.prototype.deleteFrame=function(e){if(!isNaN(e)){var t=this.tours[this.partId],r=t.list;r&&r.length&&r[e]&&(r.splice(e,1),t.frameId==e&&delete t.frameId,r.length||(this.frameId=0,this.deletePart(this.partId)),this._checkLastFrame(),this._change())}},o.prototype.exportFiles=function(){var e=[];return this.tours.forEach((function(t,r){t.music&&0===t.music.indexOf("blob:")&&!t._uploaded&&e.push({name:t.musicName.replace(/(.+)\.(.+)/,"tour-audio-"+t.sid+".$2"),type:"file"}),t.list.forEach((function(t,r){t.enter&&t.enter.cover&&0===t.enter.cover.indexOf("data:image")&&!t.enter._uploaded&&e.push({name:"tour-enter-"+t.sid+".jpg",file:t.enter.cover,type:"base64"}),t.exit&&t.exit.cover&&0===t.exit.cover.indexOf("data:image")&&!t.exit._uploaded&&e.push({name:"tour-exit-"+t.sid+".jpg",file:t.exit.cover,type:"base64"})}))})),e},o.prototype.exportData=function(){for(var e=JSON.parse(JSON.stringify(this.tours,(function(e,t){return"audio"===e?null:t}))),t=e.length-1;t>=0;t--){var r=e[t];r.list&&r.list.length?(delete r.audio,delete r._uploaded,r.music&&0===r.music.indexOf("blob:")&&(r.music=r.musicName.replace(/(.+)\.(.+)/,"tour-audio-"+r.sid+".$2")),r.list.forEach((function(e,t){delete e._notrans,delete e.enter._uploaded,delete e.exit._uploaded,e.enter&&e.enter.cover&&0===e.enter.cover.indexOf("data:image")&&(e.enter.cover="tour-enter-"+e.sid+".jpg"),e.exit&&e.exit.cover&&0===e.exit.cover.indexOf("data:image")&&(e.exit.cover="tour-exit-"+e.sid+".jpg")}))):e.splice(t,1)}return e},o.prototype.restoreFiles=function(){this.tours.forEach((function(e){delete e._uploaded,e.list.forEach((function(e){delete e.enter._uploaded,delete e.exit._uploaded}))}))},o.prototype.parseJSONForQua=function(e){return e.hasOwnProperty("x")?{x:e.x,y:e.y,z:e.z,w:e.w}:e.hasOwnProperty("_x")?{x:e._x,y:e._y,z:e._z,w:e._w}:{}},o.prototype.parseVector4=function(e){return new THREE.Quaternion(e.x,e.y,e.z,e.w)},o.prototype.parseVector3=function(e){return new THREE.Vector3(e.x,e.y,e.z)},o}(KanKan.MITT.Emiter);return function(e,t){void 0===t&&(t={});var r=KanKan.Deferred();return e.Scene.on("loaded",(function(){var o=new a(e,t);o.$name="TourRecorder",o.$load=function(){e.TourManager.install("recorder",o)},r.resolve(o)})),r}}();
